import{j as n,r as m}from"./index-DYssDsyq.js";import{l as re}from"./unitStructure-QC5qYuxv.js";import{w as le,c as me,l as ue,e as xe,u as D,f as be}from"./db-Bgk2PrOD.js";import{R as K}from"./RequestTable-PlJoemsZ.js";import{U as pe}from"./units-CaNgy_2U.js";import{a as Z}from"./DocumentListItem-BjCdHPFW.js";const ve=({r:t,docsFor:$,expandedDocs:u,setExpandedDocs:p,setOpenDocsId:A,docsRef:N,comments:y,setComments:I,attach:v,setAttach:O,addFilesToRequest:f,selectedCommandSection:S,setSelectedCommandSection:b,commandSections:h,sendToCommandSection:M,commanderDecision:C,expandedLogs:j,setExpandedLogs:R})=>{const U=S[t.id]&&S[t.id]!=="NONE",_=()=>{const r=!!u[t.id];p(x=>({...x,[t.id]:!r})),A(r?null:t.id)};return n.jsxs("div",{id:`details-cmd-${t.id}`,children:[n.jsx("div",{className:"mt-3",children:n.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!u[t.id],"aria-controls":`docs-cmd-${t.id}`,onClick:_,onKeyDown:r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),_())},children:[n.jsx("span",{children:"Show Documents"}),n.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${u[t.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:n.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),n.jsx("div",{id:`docs-cmd-${t.id}`,ref:u[t.id]?N:void 0,className:`${u[t.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:n.jsx(Z,{documents:$(t.id)})}),n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),n.jsx("textarea",{rows:2,value:y[t.id]||"",onChange:r=>I(x=>({...x,[t.id]:r.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),n.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[n.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[n.jsx("input",{type:"file",multiple:!0,onChange:r=>O(x=>({...x,[t.id]:r.target.files?Array.from(r.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),n.jsx("span",{className:"text-xs text-[var(--muted)]",children:(v[t.id]||[]).length?`${(v[t.id]||[]).length} file(s) selected`:"No files selected"}),n.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>f(t),disabled:!v[t.id]||!(v[t.id]||[]).length,children:"Save Files"})]}),n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Route to Command Section for Review"}),n.jsxs("select",{value:S[t.id]||"NONE",onChange:r=>b(x=>({...x,[t.id]:r.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[n.jsx("option",{value:"NONE",children:"None - Make final decision below"}),h.map(r=>n.jsx("option",{value:r,children:r},r))]}),U?n.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:['Click "Send to ',S[t.id],'" to route for their review']}):n.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"Select a command section to get their input first, or make your final decision below"})]}),U&&n.jsx("div",{className:"mt-3 flex items-center justify-end",children:n.jsxs("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>M(t),children:["Send to ",S[t.id]]})}),n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Final Decision"}),n.jsxs("div",{className:"flex items-center justify-end gap-2",children:[n.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>C(t,"Approved"),children:"Approved"}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>C(t,"Endorsed"),children:"Endorsed"}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>C(t,"Rejected"),children:"Rejected"})]})]}),n.jsxs("div",{className:"mt-3",children:[n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>R(r=>({...r,[t.id]:!r[t.id]})),"aria-expanded":!!j[t.id],"aria-controls":`logs-cmd-${t.id}`,children:[j[t.id]?"Hide":"Show"," Activity Log"]}),n.jsx("div",{id:`logs-cmd-${t.id}`,className:j[t.id]?"mt-2 space-y-2":"hidden",children:t.activity&&t.activity.length?t.activity.map((r,x)=>n.jsxs("div",{className:"text-xs text-gray-700",children:[n.jsxs("div",{className:"font-medium",children:[r.actor," • ",new Date(r.timestamp).toLocaleString()," • ",r.action]}),r.comment&&n.jsx("div",{className:"text-gray-600",children:r.comment})]},x)):n.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})},he=({r:t,comments:$,setComments:u,approveToCommander:p,commandSectionReturn:A})=>n.jsxs("div",{id:`details-csec-${t.id}`,className:"p-4 bg-gray-50 space-y-3",children:[n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),n.jsx("textarea",{rows:2,value:$[t.id]||"",onChange:N=>u(y=>({...y,[t.id]:N.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),n.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[n.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2",onClick:()=>p(t),children:"Approve to Commander"}),n.jsx("button",{className:"px-4 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>A(t),children:"Return to Battalion"})]})]});function Ce(){const[t,$]=m.useState(null),[u,p]=m.useState([]),[A,N]=m.useState([]),[y,I]=m.useState({}),[v,O]=m.useState({}),[f,S]=m.useState([]),[b,h]=m.useState({}),[M,C]=m.useState({}),[j,R]=m.useState({}),[U,_]=m.useState({}),[r,x]=m.useState(null),q=m.useRef(null),[L,J]=m.useState({}),[G,T]=m.useState({}),[ge,Q]=m.useState(null);m.useEffect(()=>{const e=i=>{r&&q.current&&!q.current.contains(i.target)&&(R(a=>({...a,[r]:!1})),x(null))},o=i=>{i.key==="Escape"&&r&&(R(a=>({...a,[r]:!1})),x(null))};return document.addEventListener("mousedown",e),document.addEventListener("keydown",o),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",o)}},[r]);const[F,V]=m.useState({});m.useEffect(()=>{try{const e=localStorage.getItem("currentUser");if(e){const o=JSON.parse(e);$(o)}}catch{}},[]),m.useEffect(()=>{t!=null&&t.installationId&&le().then(e=>{const o=e.find(i=>i.id===t.installationId);Q(o||null)}).catch(()=>Q(null))},[t]),m.useEffect(()=>{me().then(e=>{p(e)}).catch(()=>p([]))},[]),m.useEffect(()=>{ue().then(e=>{N(e)}).catch(()=>N([]))},[]),m.useEffect(()=>{xe().then(e=>{const o={};for(const i of e)i!=null&&i.id&&(o[i.id]=i);I(o)}).catch(()=>I({}))},[]);const k=()=>{if(t!=null&&t.unitUic)return t.unitUic;if(t!=null&&t.unit){const e=pe.find(o=>o.unitName===t.unit);if(e)return e.uic}return""};m.useEffect(()=>{try{const e=localStorage.getItem("unit_structure"),o=k();if(!o)return;const i=[],a={};if(e){const s=JSON.parse(e),c=s==null?void 0:s[o];c&&Array.isArray(c._commandSections)&&i.push(...c._commandSections);for(const l of Object.keys(s||{})){const d=s[l];d&&d._platoonSectionMap&&typeof d._platoonSectionMap=="object"&&(a[l]=d._platoonSectionMap)}S(i),J(a)}else(async()=>{try{const s=await re(),c=[],l={},d=s==null?void 0:s[o];d&&Array.isArray(d._commandSections)&&c.push(...d._commandSections);for(const g of Object.keys(s||{})){const w=s[g];w&&w._platoonSectionMap&&typeof w._platoonSectionMap=="object"&&(l[g]=w._platoonSectionMap)}S(c),J(l)}catch{}})()}catch{}},[t]);const B=e=>A.filter(o=>o.requestId===e),X=e=>y[e.uploadedById]||null,Y=e=>{var c,l;if(e.routeSection)return e.routeSection;const o=e.unitUic||"",i=X(e),a=i!=null&&i.company&&i.company!=="N/A"?i.company:"",s=i!=null&&i.unit&&i.unit!=="N/A"?i.unit:"";return((l=(c=L[o])==null?void 0:c[a])==null?void 0:l[s])||""},W=m.useMemo(()=>{const e=k();return u.filter(o=>{const i=o.currentStage||"",a=o.unitUic||"";return i==="COMMANDER_REVIEW"&&(!o.routeSection||o.routeSection==="")&&(e?a===e:!0)})},[u,t,k]);m.useMemo(()=>{const e=(t==null?void 0:t.installationId)||"";return u.filter(o=>(o.currentStage||"")==="INSTALLATION_REVIEW"&&(!o.routeSection||o.routeSection==="")&&(e?o.installationId===e:!0))},[u,t]);const E=m.useMemo(()=>{const e=k(),o={},i=s=>String(s||"").trim().toUpperCase(),a=f.map(s=>i(s));for(const s of f)o[s]=[];for(const s of u){const c=s.currentStage||"",l=s.unitUic||"",d=s.routeSection||"",g=i(d);if(c==="COMMANDER_REVIEW"&&d&&(!e||l===e)){const w=a.indexOf(g),z=w>=0?f[w]:d;o[z]||(o[z]=[]),o[z].push(s)}}return o},[u,f,t,k]),ee=e=>`"${String(e??"").replace(/"/g,'""')}"`,H=e=>{const i=[["Request ID","Subject","Stage","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const a of e){const s=X(a),c=s?`${s.rank} ${s.lastName}, ${s.firstName}${s.mi?` ${s.mi}`:""}`:"",l=B(a.id).map(d=>d.name).join(" | ");i.push([a.id,a.subject,a.currentStage||"",a.routeSection||"",c,a.unitUic||"",new Date(a.createdAt).toLocaleString(),l])}return i.map(a=>a.map(ee).join(",")).join(`\r
`)},P=(e,o)=>{const i=new Blob([o],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(i),s=document.createElement("a");s.href=a,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)},te=()=>P("commander.csv",H(W)),ne=e=>P(`${e}.csv`,H(E[e]||[])),ae=()=>P("command_all.csv",H([...W,...f.flatMap(e=>E[e]||[])])),se=async e=>{const i={actor:t?`${t.rank} ${t.lastName}, ${t.firstName}${t.mi?` ${t.mi}`:""}`:"Reviewer",timestamp:new Date().toISOString(),action:"Approved and routed to COMMANDER",comment:(b[e.id]||"").trim()},a={...e,currentStage:"COMMANDER_REVIEW",routeSection:"",activity:Array.isArray(e.activity)?[...e.activity,i]:[i]};try{await D(a),p(s=>s.map(c=>c.id===a.id?a:c)),h(s=>({...s,[e.id]:""}))}catch(s){console.error("Failed to approve request to commander:",s)}},oe=async e=>{const o=G[e.id]||"";if(!o||o==="NONE")return;const i=t?`${t.rank} ${t.lastName}, ${t.firstName}${t.mi?` ${t.mi}`:""}`:"Commander",a=`Sent to ${o} for review by Commander`,s={...e,currentStage:"COMMANDER_REVIEW",routeSection:o,activity:Array.isArray(e.activity)?[...e.activity,{actor:i,timestamp:new Date().toISOString(),action:a,comment:(b[e.id]||"").trim()}]:[{actor:i,timestamp:new Date().toISOString(),action:a,comment:(b[e.id]||"").trim()}]};try{await D(s),p(c=>c.map(l=>l.id===s.id?s:l)),h(c=>({...c,[e.id]:""})),T(c=>({...c,[e.id]:""}))}catch(c){console.error("Failed to send to command section:",c)}},ie=async(e,o)=>{const i=t?`${t.rank} ${t.lastName}, ${t.firstName}${t.mi?` ${t.mi}`:""}`:"Commander",a=Y(e),s=o==="Approved"?"Approved by Commander":o==="Endorsed"?"Endorsed by Commander":"Rejected by Commander — requires action",c={...e,currentStage:"BATTALION_REVIEW",routeSection:a||e.routeSection||"",commanderApprovalDate:o==="Approved"?new Date().toISOString():e.commanderApprovalDate,activity:Array.isArray(e.activity)?[...e.activity,{actor:i,timestamp:new Date().toISOString(),action:s,comment:(b[e.id]||"").trim()}]:[{actor:i,timestamp:new Date().toISOString(),action:s,comment:(b[e.id]||"").trim()}]};try{await D(c),p(l=>l.map(d=>d.id===c.id?c:d)),h(l=>({...l,[e.id]:""})),T(l=>({...l,[e.id]:""}))}catch{}},ce=async e=>{const o=t?`${t.rank} ${t.lastName}, ${t.firstName}${t.mi?` ${t.mi}`:""}`:"Command Section",i=Y(e),a=`Returned to ${i||"Battalion"} by ${e.routeSection||"Command Section"}`,s={...e,currentStage:"BATTALION_REVIEW",routeSection:i||e.routeSection||"",activity:Array.isArray(e.activity)?[...e.activity,{actor:o,timestamp:new Date().toISOString(),action:a,comment:(b[e.id]||"").trim()}]:[{actor:o,timestamp:new Date().toISOString(),action:a,comment:(b[e.id]||"").trim()}]};try{await D(s),p(c=>c.map(l=>l.id===s.id?s:l)),h(c=>({...c,[e.id]:""}))}catch{}},de=async e=>{const o=M[e.id]||[];if(!o.length||!(t!=null&&t.id))return;const i=Date.now(),a=o.map((d,g)=>({id:`${i}-${g}`,name:d.name,type:d.type,size:d.size,uploadedAt:new Date().toISOString(),subject:e.subject,requestId:e.id,fileUrl:URL.createObjectURL(d)})),c={actor:t?`${t.rank} ${t.lastName}, ${t.firstName}${t.mi?` ${t.mi}`:""}`:"Reviewer",timestamp:new Date().toISOString(),action:`Reviewer added ${a.length} document(s)`,comment:(b[e.id]||"").trim()},l={...e,documentIds:[...e.documentIds||[],...a.map(d=>d.id)],activity:Array.isArray(e.activity)?[...e.activity,c]:[c]};try{await be(a),await D(l),N(d=>[...d,...a]),p(d=>d.map(g=>g.id===l.id?l:g)),C(d=>({...d,[e.id]:[]})),h(d=>({...d,[e.id]:""}))}catch(d){console.error("Failed to add files to request:",d)}};return n.jsx("div",{className:"max-w-7xl mx-auto p-6",children:n.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Command Sections Dashboard"}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:(t==null?void 0:t.unitUic)||""}),n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ae,children:"Export All"})]})]}),n.jsxs("div",{className:"space-y-8",children:[n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Commander"}),n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:te,children:"Export Commander"})]}),n.jsx("div",{className:"mt-4",children:n.jsx(K,{title:"Pending",requests:W.filter(e=>e.currentStage!=="ARCHIVED"),users:y,onRowClick:e=>V(o=>({...o,[e.id]:!o[e.id]})),expandedRows:F,platoonSectionMap:L,children:e=>n.jsx(ve,{r:e,docsFor:B,expandedDocs:j,setExpandedDocs:R,setOpenDocsId:x,docsRef:q,comments:b,setComments:h,attach:M,setAttach:C,addFilesToRequest:de,selectedCommandSection:G,setSelectedCommandSection:T,commandSections:f,sendToCommandSection:oe,commanderDecision:ie,expandedLogs:v,setExpandedLogs:O})})})]}),Object.keys(E).filter(e=>(E[e]||[]).length>0).map(e=>{const o=(E[e]||[]).filter(a=>a.currentStage!=="ARCHIVED"),i=(E[e]||[]).filter(a=>a.currentStage==="ARCHIVED");return n.jsxs("div",{children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:e}),n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:()=>ne(e),children:["Export ",e]})]}),o.length>0&&n.jsx("div",{className:"mt-4",children:n.jsx(K,{title:"Pending",requests:o,users:y,onRowClick:a=>V(s=>({...s,[a.id]:!s[a.id]})),expandedRows:F,platoonSectionMap:L,children:a=>n.jsx(he,{r:a,comments:b,setComments:h,approveToCommander:se,commandSectionReturn:ce})})}),i.length>0&&n.jsx("div",{className:"mt-4",children:n.jsx(K,{title:"Archived",requests:i,users:y,onRowClick:a=>V(s=>({...s,[a.id]:!s[a.id]})),expandedRows:F,platoonSectionMap:L,children:a=>n.jsxs("div",{id:`details-csec-archived-${a.id}`,className:"p-4 bg-gray-50 space-y-3",children:[n.jsxs("div",{children:[n.jsxs("h4",{className:"font-medium text-gray-800",children:["Final Status: ",a.finalStatus||"Archived"]}),n.jsx("p",{className:"text-sm text-gray-600",children:"This request is archived and cannot be modified."})]}),n.jsxs("div",{children:[n.jsx("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[a.id],"aria-controls":`docs-csec-archived-${a.id}`,onClick:()=>{R(s=>({...s,[a.id]:!s[a.id]})),x(s=>j[a.id]?null:a.id)},children:"Show Documents"}),n.jsx("div",{id:`docs-csec-archived-${a.id}`,className:`${j[a.id]?"mt-2 space-y-2":"hidden"}`,children:n.jsx(Z,{documents:B(a.id).map(s=>({...s,fileUrl:s.fileUrl}))})})]}),n.jsxs("div",{children:[n.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!v[a.id],"aria-controls":`logs-csec-archived-${a.id}`,onClick:()=>O(s=>({...s,[a.id]:!s[a.id]})),children:[v[a.id]?"Hide":"Show"," Full Activity Log"]}),n.jsx("div",{id:`logs-csec-archived-${a.id}`,className:v[a.id]?"mt-2 space-y-2":"hidden",children:a.activity&&a.activity.length?a.activity.map((s,c)=>n.jsxs("div",{className:"text-xs text-gray-700",children:[n.jsxs("div",{className:"font-medium",children:[s.actor," • ",new Date(s.timestamp).toLocaleString()," • ",s.action]}),s.comment&&n.jsx("div",{className:"text-gray-600 pl-4 border-l-2 border-gray-300 ml-2",children:s.comment})]},c)):n.jsx("div",{className:"text-xs text-gray-500",children:"No activity to display."})})]})]})})})]},e)})]})]})})}export{Ce as default};
