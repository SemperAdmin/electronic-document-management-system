import{r as l,j as t,u as $e}from"./index-CMZYgw6J.js";import{l as Re}from"./unitStructure-QC5qYuxv.js";import{z as Ee,f as Ae,l as Ie,h as Le,u as _,i as Me}from"./db-DCELMWXs.js";import{R as ee}from"./RequestTable-C2mcQIxJ.js";import{U as Oe}from"./units-CaNgy_2U.js";import{a as te,D as ue}from"./DocumentListItem-Dbq_tbjd.js";const Fe=({r:n,docsFor:Y,expandedDocs:h,setExpandedDocs:N,setOpenDocsId:E,docsRef:A,comments:R,setComments:U,attach:C,setAttach:I,addFilesToRequest:g,selectedCommandSection:k,setSelectedCommandSection:S,commandSections:f,sendToCommandSection:L,commanderDecision:w,expandedLogs:D,setExpandedLogs:j})=>{const[$,M]=l.useState(null),u=k[n.id]&&k[n.id]!=="NONE",b=Y(n.id),T=()=>{const m=!!h[n.id];N(v=>({...v,[n.id]:!m})),E(m?null:n.id)};return t.jsxs("div",{id:`details-cmd-${n.id}`,children:[t.jsx("div",{className:"mt-3",children:t.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!h[n.id],"aria-controls":`docs-cmd-${n.id}`,onClick:T,onKeyDown:m=>{(m.key==="Enter"||m.key===" ")&&(m.preventDefault(),T())},children:[t.jsx("span",{children:"Show Documents"}),t.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${h[n.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:t.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),t.jsx("div",{id:`docs-cmd-${n.id}`,ref:h[n.id]?A:void 0,className:`${h[n.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:t.jsx(te,{documents:b.map(m=>({...m,fileUrl:m.fileUrl})),showIcons:!0,onPreview:m=>M(b.find(v=>v.id===m.id)||null)})}),t.jsxs("div",{className:"mt-3",children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),t.jsx("textarea",{rows:2,value:R[n.id]||"",onChange:m=>U(v=>({...v,[n.id]:m.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),t.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[t.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[t.jsx("input",{type:"file",multiple:!0,onChange:m=>I(v=>({...v,[n.id]:m.target.files?Array.from(m.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),t.jsx("span",{className:"text-xs text-[var(--muted)]",children:(C[n.id]||[]).length?`${(C[n.id]||[]).length} file(s) selected`:"No files selected"}),t.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>g(n),disabled:!C[n.id]||!(C[n.id]||[]).length,children:"Save Files"})]}),t.jsxs("div",{className:"mt-3",children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Route to Command Section for Review"}),t.jsxs("select",{value:k[n.id]||"NONE",onChange:m=>S(v=>({...v,[n.id]:m.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[t.jsx("option",{value:"NONE",children:"None - Make final decision below"}),f.map(m=>t.jsx("option",{value:m,children:m},m))]}),u?t.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:['Click "Send to ',k[n.id],'" to route for their review']}):t.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"Select a command section to get their input first, or make your final decision below"})]}),u&&t.jsx("div",{className:"mt-3 flex items-center justify-end",children:t.jsxs("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>L(n),children:["Send to ",k[n.id]]})}),t.jsxs("div",{className:"mt-3",children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Final Decision"}),t.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>w(n,"Approved"),children:"Approved"}),t.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>w(n,"Endorsed"),children:"Endorsed"}),t.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>w(n,"Rejected"),children:"Rejected"})]})]}),t.jsxs("div",{className:"mt-3",children:[t.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>j(m=>({...m,[n.id]:!m[n.id]})),"aria-expanded":!!D[n.id],"aria-controls":`logs-cmd-${n.id}`,children:[D[n.id]?"Hide":"Show"," Activity Log"]}),t.jsx("div",{id:`logs-cmd-${n.id}`,className:D[n.id]?"mt-2 space-y-2":"hidden",children:n.activity&&n.activity.length?n.activity.map((m,v)=>t.jsxs("div",{className:"text-xs text-gray-700",children:[t.jsxs("div",{className:"font-medium",children:[m.actor," • ",new Date(m.timestamp).toLocaleString()," • ",m.action]}),m.comment&&t.jsx("div",{className:"text-gray-600",children:m.comment})]},v)):t.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),$&&t.jsx(ue,{fileName:$.name,url:$.fileUrl||"",mimeType:$.type||"",fileSize:$.size||0,isOpen:!!$,onClose:()=>M(null)})]})},Ue=({r:n,docsFor:Y,comments:h,setComments:N,attach:E,setAttach:A,addFilesToRequest:R,approveToCommander:U,commandSectionReturn:C,commandSections:I,selectedCommandSection:g,setSelectedCommandSection:k,routeToCommandSection:S})=>{const[f,L]=l.useState(!1),[w,D]=l.useState(!1),[j,$]=l.useState(null),M=Y(n.id);return t.jsxs("div",{id:`details-csec-${n.id}`,className:"p-4 bg-gray-50 space-y-3",children:[t.jsxs("div",{children:[t.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":f,"aria-controls":`docs-csec-${n.id}`,onClick:()=>L(!f),children:[t.jsxs("span",{children:[f?"Hide":"Show"," Documents (",M.length,")"]}),t.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${f?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:t.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]}),t.jsx("div",{id:`docs-csec-${n.id}`,className:`${f?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:t.jsx(te,{documents:M.map(u=>({...u,fileUrl:u.fileUrl})),showIcons:!0,onPreview:u=>$(M.find(b=>b.id===u.id)||null)})})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),t.jsx("textarea",{rows:2,value:h[n.id]||"",onChange:u=>N(b=>({...b,[n.id]:u.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 text-sm rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[t.jsx("input",{type:"file",multiple:!0,onChange:u=>A(b=>({...b,[n.id]:u.target.files?Array.from(u.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),t.jsx("span",{className:"text-xs text-[var(--muted)]",children:(E[n.id]||[]).length?`${(E[n.id]||[]).length} file(s) selected`:"No files selected"}),(E[n.id]||[]).length>0&&t.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>R(n),children:"Save Files"})]}),t.jsxs("div",{children:[t.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>D(!w),"aria-expanded":w,"aria-controls":`logs-csec-${n.id}`,children:[w?"Hide":"Show"," Activity Log"]}),t.jsx("div",{id:`logs-csec-${n.id}`,className:w?"mt-2 space-y-2":"hidden",children:n.activity&&n.activity.length?n.activity.map((u,b)=>t.jsxs("div",{className:"text-xs text-gray-700",children:[t.jsxs("div",{className:"font-medium",children:[u.actor," • ",new Date(u.timestamp).toLocaleString()," • ",u.action]}),u.comment&&t.jsx("div",{className:"text-gray-600 pl-4 border-l-2 border-gray-300 ml-2",children:u.comment})]},b)):t.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),I.length>1&&t.jsxs("div",{className:"pt-2 border-t border-brand-navy/10",children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Route to Another Section"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("select",{value:g[n.id]||"",onChange:u=>k(b=>({...b,[n.id]:u.target.value})),className:"flex-1 px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold text-sm",children:[t.jsx("option",{value:"",children:"Select section..."}),I.filter(u=>u!==n.routeSection).map(u=>t.jsx("option",{value:u,children:u},u))]}),t.jsx("button",{className:"px-4 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>S(n,g[n.id]||""),disabled:!g[n.id],children:"Route"})]})]}),t.jsxs("div",{className:"pt-2 border-t border-brand-navy/10 flex items-center justify-end gap-2",children:[t.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>U(n),children:"Approve to Commander"}),t.jsx("button",{className:"px-4 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>C(n),children:"Return to Battalion"})]}),j&&t.jsx(ue,{fileName:j.name,url:j.fileUrl||"",mimeType:j.type||"",fileSize:j.size||0,isOpen:!!j,onClose:()=>$(null)})]})};function ze(){const[n,Y]=l.useState(null),[h,N]=l.useState([]),[E,A]=l.useState([]),[R,U]=l.useState({}),[C,I]=l.useState({}),[g,k]=l.useState([]),[S,f]=l.useState({}),[L,w]=l.useState({}),[D,j]=l.useState({}),[$,M]=l.useState({}),[u,b]=l.useState(null),T=l.useRef(null),[m,v]=l.useState({}),[q,B]=l.useState({}),[Te,ne]=l.useState(null),O=$e(),[W,se]=l.useState("Pending"),[P,oe]=l.useState(""),[xe,pe]=l.useState({}),[be,he]=l.useState({});l.useEffect(()=>{const e=i=>{u&&T.current&&!T.current.contains(i.target)&&(j(s=>({...s,[u]:!1})),b(null))},a=i=>{i.key==="Escape"&&u&&(j(s=>({...s,[u]:!1})),b(null))};return document.addEventListener("mousedown",e),document.addEventListener("keydown",a),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",a)}},[u]);const[K,J]=l.useState({});l.useEffect(()=>{try{const e=localStorage.getItem("currentUser");if(e){const a=JSON.parse(e);Y(a)}}catch{}},[]),l.useEffect(()=>{n!=null&&n.installationId&&Ee().then(e=>{const a=e.find(i=>i.id===n.installationId);ne(a||null)}).catch(()=>ne(null))},[n]),l.useEffect(()=>{Ae().then(e=>{N(e)}).catch(()=>N([]))},[]),l.useEffect(()=>{Ie().then(e=>{A(e)}).catch(()=>A([]))},[]),l.useEffect(()=>{Le().then(e=>{const a={};for(const i of e)i!=null&&i.id&&(a[i.id]=i);U(a)}).catch(()=>U({}))},[]);const F=()=>{if(n!=null&&n.unitUic)return n.unitUic;if(n!=null&&n.unit){const e=Oe.find(a=>a.unitName===n.unit);if(e)return e.uic}return""};l.useEffect(()=>{try{const e=localStorage.getItem("unit_structure"),a=F();if(!a)return;const i=[],s={};if(e){const o=JSON.parse(e),d=o==null?void 0:o[a];d&&Array.isArray(d._commandSections)&&i.push(...d._commandSections);for(const c of Object.keys(o||{})){const r=o[c];r&&r._platoonSectionMap&&typeof r._platoonSectionMap=="object"&&(s[c]=r._platoonSectionMap)}k(i),v(s)}else(async()=>{try{const o=await Re(),d=[],c={},r=o==null?void 0:o[a];r&&Array.isArray(r._commandSections)&&d.push(...r._commandSections);for(const x of Object.keys(o||{})){const y=o[x];y&&y._platoonSectionMap&&typeof y._platoonSectionMap=="object"&&(c[x]=y._platoonSectionMap)}k(d),v(c)}catch{}})()}catch{}},[n]);const z=e=>E.filter(a=>a.requestId===e),ae=e=>R[e.uploadedById]||null,ie=e=>{var c,r;const a=g.map(x=>String(x||"").trim().toUpperCase());if(e.activity&&e.activity.length)for(let x=e.activity.length-1;x>=0;x--){const y=e.activity[x],p=String(y.fromSection||"").trim(),le=p.toUpperCase();if(p&&!a.includes(le)&&le!=="COMMANDER")return p;const Z=String(y.toSection||"").trim(),me=Z.toUpperCase();if(Z&&!a.includes(me)&&me!=="COMMANDER"&&/battalion|section/i.test(String(y.action||"")))return Z}if(e.routeSection){const x=String(e.routeSection||"").trim().toUpperCase();if(!a.includes(x))return e.routeSection}const i=e.unitUic||"",s=ae(e),o=s!=null&&s.company&&s.company!=="N/A"?s.company:"",d=s!=null&&s.unit&&s.unit!=="N/A"?s.unit:"";return((r=(c=m[i])==null?void 0:c[o])==null?void 0:r[d])||""},Q=l.useMemo(()=>{const e=F();return h.filter(a=>{const i=a.currentStage||"",s=a.unitUic||"";return i==="COMMANDER_REVIEW"&&(!a.routeSection||a.routeSection==="")&&(e?s===e:!0)})},[h,n,F]);l.useMemo(()=>{const e=(n==null?void 0:n.installationId)||"";return h.filter(a=>(a.currentStage||"")==="INSTALLATION_REVIEW"&&(!a.routeSection||a.routeSection==="")&&(e?a.installationId===e:!0))},[h,n]);const H=l.useMemo(()=>{const e=F(),a={},i=o=>String(o||"").trim().toUpperCase(),s=g.map(o=>i(o));for(const o of g)a[o]=[];for(const o of h){const d=o.currentStage||"",c=o.unitUic||"",r=o.routeSection||"",x=i(r);if(d==="COMMANDER_REVIEW"&&r&&(!e||c===e)){const y=s.indexOf(x),p=y>=0?g[y]:r;a[p]||(a[p]=[]),a[p].push(o)}}return a},[h,g,n,F]),re=l.useCallback(e=>{if(e.isPermanent)return"Permanent";if(!e.retentionValue||!e.cutoffTrigger||!e.filedAt)return"Unknown";const a=new Date(e.filedAt);let i;switch(e.cutoffTrigger){case"CALENDAR_YEAR":i=new Date(a.getFullYear(),11,31);break;case"FISCAL_YEAR":i=a.getMonth()>=9?new Date(a.getFullYear()+1,8,30):new Date(a.getFullYear(),8,30);break;default:i=a}const s=new Date(i),o=(e.retentionUnit||"").toLowerCase();return o==="years"?s.setFullYear(s.getFullYear()+e.retentionValue):o==="months"?s.setMonth(s.getMonth()+e.retentionValue):o==="days"&&s.setDate(s.getDate()+e.retentionValue),s.getFullYear().toString()},[]),fe=l.useCallback(e=>{if(!e.retentionValue||!e.cutoffTrigger||!e.filedAt)return"N/A";if(e.isPermanent)return"Permanent";const a=new Date(e.filedAt);let i;switch(e.cutoffTrigger){case"CALENDAR_YEAR":i=new Date(a.getFullYear(),11,31);break;case"FISCAL_YEAR":i=a.getMonth()>=9?new Date(a.getFullYear()+1,8,30):new Date(a.getFullYear(),8,30);break;default:i=a}const s=new Date(i),o=(e.retentionUnit||"").toLowerCase();return o==="years"?s.setFullYear(s.getFullYear()+e.retentionValue):o==="months"?s.setMonth(s.getMonth()+e.retentionValue):o==="days"&&s.setDate(s.getDate()+e.retentionValue),s.toLocaleDateString()},[]),V=l.useMemo(()=>{const e=F();let a=h.filter(s=>!(!s.filedAt||e&&s.unitUic!==e));if(P.trim()){const s=P.toLowerCase().trim();a=a.filter(o=>{var d,c,r,x;return((d=o.subject)==null?void 0:d.toLowerCase().includes(s))||((c=o.ssic)==null?void 0:c.toLowerCase().includes(s))||((r=o.ssicNomenclature)==null?void 0:r.toLowerCase().includes(s))||((x=o.ssicBucketTitle)==null?void 0:x.toLowerCase().includes(s))})}const i={};for(const s of a){const o=re(s),d=s.ssicBucketTitle||s.ssicBucket||"Uncategorized";i[o]||(i[o]={}),i[o][d]||(i[o][d]=[]),i[o][d].push(s)}for(const s of Object.keys(i))for(const o of Object.keys(i[s]))i[s][o].sort((d,c)=>new Date(c.createdAt).getTime()-new Date(d.createdAt).getTime());return i},[h,n,P,re,F]),ce=l.useMemo(()=>Object.keys(V).sort((e,a)=>e==="Permanent"?1:a==="Permanent"?-1:e==="Unknown"?1:a==="Unknown"?-1:parseInt(e)-parseInt(a)),[V]),ge=l.useMemo(()=>Object.values(V).reduce((e,a)=>e+Object.values(a).reduce((i,s)=>i+s.length,0),0),[V]),ve=e=>`"${String(e??"").replace(/"/g,'""')}"`,G=e=>{const i=[["Request ID","Subject","Stage","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const s of e){const o=ae(s),d=o?`${o.rank} ${o.lastName}, ${o.firstName}${o.mi?` ${o.mi}`:""}`:"",c=z(s.id).map(r=>r.name).join(" | ");i.push([s.id,s.subject,s.currentStage||"",s.routeSection||"",d,s.unitUic||"",new Date(s.createdAt).toLocaleString(),c])}return i.map(s=>s.map(ve).join(",")).join(`\r
`)},X=(e,a)=>{const i=new Blob([a],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(i),o=document.createElement("a");o.href=s,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)},ye=()=>X("commander.csv",G(Q)),je=e=>X(`${e}.csv`,G(H[e]||[])),Ne=()=>X("command_all.csv",G([...Q,...g.flatMap(e=>H[e]||[])])),Se=async e=>{const a=n?`${n.rank} ${n.lastName}, ${n.firstName}${n.mi?` ${n.mi}`:""}`:"Reviewer",i=e.routeSection||"",s={actor:a,timestamp:new Date().toISOString(),action:"Approved and routed to COMMANDER",comment:(S[e.id]||"").trim(),fromSection:i||void 0,toSection:"Commander"},o={...e,currentStage:"COMMANDER_REVIEW",routeSection:"",activity:[...e.activity||[],s]};try{await _(o),N(d=>d.map(c=>c.id===o.id?o:c)),f(d=>({...d,[e.id]:""}))}catch(d){console.error("Failed to approve request to commander:",d),O.error("Failed to approve request to commander")}},we=async e=>{const a=q[e.id]||"";if(!a||a==="NONE")return;const i=n?`${n.rank} ${n.lastName}, ${n.firstName}${n.mi?` ${n.mi}`:""}`:"Commander",s=`Sent to ${a} for review by Commander`,o={...e,currentStage:"COMMANDER_REVIEW",routeSection:a,activity:[...e.activity||[],{actor:i,timestamp:new Date().toISOString(),action:s,comment:(S[e.id]||"").trim(),fromSection:"Commander",toSection:a}]};try{await _(o),N(d=>d.map(c=>c.id===o.id?o:c)),f(d=>({...d,[e.id]:""})),B(d=>({...d,[e.id]:""}))}catch(d){console.error("Failed to send to command section:",d),O.error("Failed to send to command section")}},Ce=async(e,a)=>{const i=n?`${n.rank} ${n.lastName}, ${n.firstName}${n.mi?` ${n.mi}`:""}`:"Commander",s=ie(e),o=a==="Approved"?"Approved by Commander":a==="Endorsed"?"Endorsed by Commander":"Rejected by Commander — requires action",d={...e,currentStage:"BATTALION_REVIEW",routeSection:s||e.routeSection||"",commanderApprovalDate:a==="Approved"?new Date().toISOString():e.commanderApprovalDate,activity:[...e.activity||[],{actor:i,timestamp:new Date().toISOString(),action:o,comment:(S[e.id]||"").trim(),fromSection:"Commander",toSection:s||e.routeSection||void 0}]};try{await _(d),N(c=>c.map(r=>r.id===d.id?d:r)),f(c=>({...c,[e.id]:""})),B(c=>({...c,[e.id]:""}))}catch(c){console.error("Failed to make commander decision:",c),O.error("Failed to record commander decision")}},ke=async e=>{const a=n?`${n.rank} ${n.lastName}, ${n.firstName}${n.mi?` ${n.mi}`:""}`:"Command Section",i=ie(e),s=e.routeSection||"",o=`Returned to ${i||"Battalion"} by ${s||"Command Section"}`,d={actor:a,timestamp:new Date().toISOString(),action:o,comment:(S[e.id]||"").trim(),fromSection:s||void 0,toSection:i||void 0},c={...e,currentStage:"BATTALION_REVIEW",routeSection:i||e.routeSection||"",activity:[...e.activity||[],d]};try{await _(c),N(r=>r.map(x=>x.id===c.id?c:x)),f(r=>({...r,[e.id]:""}))}catch(r){console.error("Failed to return from command section:",r),O.error("Failed to return from command section")}},De=async(e,a)=>{if(!a)return;const i=n?`${n.rank} ${n.lastName}, ${n.firstName}${n.mi?` ${n.mi}`:""}`:"Command Section",s=e.routeSection||"",o=`Routed to ${a} by ${s||"Command Section"}`,d={actor:i,timestamp:new Date().toISOString(),action:o,comment:(S[e.id]||"").trim(),fromSection:s||void 0,toSection:a},c={...e,currentStage:"COMMANDER_REVIEW",routeSection:a,activity:[...e.activity||[],d]};try{await _(c),N(r=>r.map(x=>x.id===c.id?c:x)),f(r=>({...r,[e.id]:""})),B(r=>({...r,[e.id]:""})),O.success(`Routed to ${a}`)}catch(r){console.error("Failed to route to command section:",r),O.error("Failed to route to command section")}},de=async e=>{const a=L[e.id]||[];if(!a.length||!(n!=null&&n.id))return;const i=Date.now(),s=a.map((r,x)=>({id:`${i}-${x}`,name:r.name,type:r.type,size:r.size,uploadedAt:new Date().toISOString(),subject:e.subject,requestId:e.id,fileUrl:URL.createObjectURL(r)})),d={actor:n?`${n.rank} ${n.lastName}, ${n.firstName}${n.mi?` ${n.mi}`:""}`:"Reviewer",timestamp:new Date().toISOString(),action:`Reviewer added ${s.length} document(s)`,comment:(S[e.id]||"").trim()},c={...e,documentIds:[...e.documentIds||[],...s.map(r=>r.id)],activity:[...e.activity||[],d]};try{await Me(s),await _(c),A(r=>[...r,...s]),N(r=>r.map(x=>x.id===c.id?c:x)),w(r=>({...r,[e.id]:[]})),f(r=>({...r,[e.id]:""}))}catch(r){console.error("Failed to add files to request:",r),O.error("Failed to add files to request")}};return t.jsx("div",{className:"max-w-7xl mx-auto p-6",children:t.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Unit Command Dashboard"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:(n==null?void 0:n.unitUic)||""}),t.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ne,children:"Export All"})]})]}),t.jsx("div",{className:"border-b border-gray-200 mb-4",children:t.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[t.jsx("button",{onClick:()=>se("Pending"),className:`${W==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),t.jsxs("button",{onClick:()=>se("Files"),className:`${W==="Files"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:["Files (",ge,")"]})]})}),W==="Pending"&&t.jsxs("div",{className:"space-y-8",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Commander"}),t.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ye,children:"Export Commander"})]}),t.jsx("div",{className:"mt-4",children:t.jsx(ee,{title:"Pending",requests:Q.filter(e=>e.currentStage!=="ARCHIVED"),users:R,onRowClick:e=>J(a=>({...a,[e.id]:!a[e.id]})),expandedRows:K,platoonSectionMap:m,children:e=>t.jsx(Fe,{r:e,docsFor:z,expandedDocs:D,setExpandedDocs:j,setOpenDocsId:b,docsRef:T,comments:S,setComments:f,attach:L,setAttach:w,addFilesToRequest:de,selectedCommandSection:q,setSelectedCommandSection:B,commandSections:g,sendToCommandSection:we,commanderDecision:Ce,expandedLogs:C,setExpandedLogs:I})})})]}),g.map(e=>{const a=(H[e]||[]).filter(s=>s.currentStage!=="ARCHIVED"),i=(H[e]||[]).filter(s=>s.currentStage==="ARCHIVED");return t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:e}),t.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:()=>je(e),children:["Export ",e]})]}),t.jsx("div",{className:"mt-4",children:t.jsx(ee,{title:"Pending",requests:a,users:R,onRowClick:s=>J(o=>({...o,[s.id]:!o[s.id]})),expandedRows:K,platoonSectionMap:m,children:s=>t.jsx(Ue,{r:s,docsFor:z,comments:S,setComments:f,attach:L,setAttach:w,addFilesToRequest:de,approveToCommander:Se,commandSectionReturn:ke,commandSections:g,selectedCommandSection:q,setSelectedCommandSection:B,routeToCommandSection:De})})}),i.length>0&&t.jsx("div",{className:"mt-4",children:t.jsx(ee,{title:"Archived",requests:i,users:R,onRowClick:s=>J(o=>({...o,[s.id]:!o[s.id]})),expandedRows:K,platoonSectionMap:m,children:s=>t.jsxs("div",{id:`details-csec-archived-${s.id}`,className:"p-4 bg-gray-50 space-y-3",children:[t.jsxs("div",{children:[t.jsxs("h4",{className:"font-medium text-gray-800",children:["Final Status: ",s.finalStatus||"Archived"]}),t.jsx("p",{className:"text-sm text-gray-600",children:"This request is archived and cannot be modified."})]}),t.jsxs("div",{children:[t.jsx("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!D[s.id],"aria-controls":`docs-csec-archived-${s.id}`,onClick:()=>{j(o=>({...o,[s.id]:!o[s.id]})),b(o=>D[s.id]?null:s.id)},children:"Show Documents"}),t.jsx("div",{id:`docs-csec-archived-${s.id}`,className:`${D[s.id]?"mt-2 space-y-2":"hidden"}`,children:t.jsx(te,{documents:z(s.id).map(o=>({...o,fileUrl:o.fileUrl}))})})]}),t.jsxs("div",{children:[t.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!C[s.id],"aria-controls":`logs-csec-archived-${s.id}`,onClick:()=>I(o=>({...o,[s.id]:!o[s.id]})),children:[C[s.id]?"Hide":"Show"," Full Activity Log"]}),t.jsx("div",{id:`logs-csec-archived-${s.id}`,className:C[s.id]?"mt-2 space-y-2":"hidden",children:s.activity&&s.activity.length?s.activity.map((o,d)=>t.jsxs("div",{className:"text-xs text-gray-700",children:[t.jsxs("div",{className:"font-medium",children:[o.actor," • ",new Date(o.timestamp).toLocaleString()," • ",o.action]}),o.comment&&t.jsx("div",{className:"text-gray-600 pl-4 border-l-2 border-gray-300 ml-2",children:o.comment})]},d)):t.jsx("div",{className:"text-xs text-gray-500",children:"No activity to display."})})]})]})})})]},e)})]}),W==="Files"&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"relative",children:[t.jsx("input",{type:"text",placeholder:"Search files by subject, SSIC, category...",value:P,onChange:e=>oe(e.target.value),className:"w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold focus:border-transparent"}),t.jsx("svg",{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),P&&t.jsx("button",{onClick:()=>oe(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),ce.length===0?t.jsx("div",{className:"text-center py-8 text-gray-500",children:P?"No records match your search.":"No filed records."}):t.jsx("div",{className:"space-y-2",children:ce.map(e=>{const a=V[e],i=Object.keys(a).sort(),s=e==="Permanent",o=Object.values(a).reduce((c,r)=>c+r.length,0),d=xe[e]||!1;return t.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[t.jsxs("button",{onClick:()=>pe(c=>({...c,[e]:!c[e]})),className:`w-full ${s?"bg-blue-800 hover:bg-blue-700":"bg-brand-navy hover:bg-brand-navy/90"} text-brand-cream px-4 py-3 font-medium flex items-center justify-between transition-colors`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("svg",{className:`w-4 h-4 transition-transform flex-shrink-0 ${d?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),t.jsx("span",{className:"truncate",children:s?"Permanent Records":`Disposal Year: ${e}`})]}),t.jsxs("span",{className:"text-xs bg-white/20 px-2 py-0.5 rounded flex-shrink-0 ml-2",children:[o," record",o!==1?"s":""]})]}),d&&t.jsx("div",{className:"bg-gray-50 p-2 space-y-2",children:i.map(c=>{const r=a[c],x=`${e}-${c}`,y=be[x]||!1;return t.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden bg-white",children:[t.jsxs("button",{onClick:()=>he(p=>({...p,[x]:!p[x]})),className:"w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 font-medium text-sm flex items-center justify-between transition-colors",children:[t.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.jsx("svg",{className:`w-3 h-3 transition-transform flex-shrink-0 ${y?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),t.jsx("span",{className:"truncate",children:c})]}),t.jsxs("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:[r.length," item",r.length!==1?"s":""]})]}),y&&t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"Name"}),t.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"SSIC"}),t.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"Retention"}),t.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm hidden sm:table-cell",children:"Disposal Date"})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:r.map(p=>t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsx("td",{className:"px-2 sm:px-3 py-2 font-medium text-brand-navy text-xs sm:text-sm max-w-[120px] sm:max-w-none truncate",children:p.subject}),t.jsx("td",{className:"px-2 sm:px-3 py-2 text-xs sm:text-sm",children:p.ssic}),t.jsx("td",{className:"px-2 sm:px-3 py-2",children:p.isPermanent?t.jsx("span",{className:"inline-flex px-1.5 sm:px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded whitespace-nowrap",children:"Perm"}):t.jsxs("span",{className:"inline-flex px-1.5 sm:px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded whitespace-nowrap",children:[p.retentionValue," ",(p.retentionUnit||"").replace("S","")]})}),t.jsx("td",{className:"px-2 sm:px-3 py-2 text-xs sm:text-sm hidden sm:table-cell",children:fe(p)})]},p.id))})]})})]},x)})})]},e)})})]})]})})}export{ze as default};
