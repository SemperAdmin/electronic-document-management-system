const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-SwzNKlTP.js","./index-DU6JzcRA.js","./index-D9SBkJLS.css"])))=>i.map(i=>d[i]);
import{r as a,j as e,c as ds,f as ms,a as us,s as Xt,S as qt,v as xs,l as kt,M as Ft,b as ps,u as hs,R as gs,d as bs,_ as fs}from"./index-DU6JzcRA.js";import{s as Re,d as ys,a as vs,b as Ns,l as Ot,c as gt,e as nt,u as _e,f as Rt,g as bt,h as Qe,i as js,j as Ss,k as Zt,m as es,n as _t,o as ws,p as ts,q as It,r as Cs,t as ss,v as as,w as Mt,x as ns,y as Bt}from"./db-SwzNKlTP.js";import{P as Dt,I as As}from"./InstallationAdmin-BMZENmbi.js";import{f as rs,R as ze,S as Ue,o as Vt,c as ks,a as Es}from"./RequestTable-CTFjy3_o.js";import{c as Rs,F as Is,D as is,a as et}from"./DocumentListItem-CC-nO5z2.js";import{l as ft}from"./unitStructure-QC5qYuxv.js";import Ms from"./SectionDashboard-c0c5fWaH.js";import Ds from"./CommandDashboard-weN-4iky.js";import Ps from"./InstallationSectionDashboard-5IjxjDpK.js";import $s from"./InstallationCommandDashboard-CN6d2XFx.js";import{U as Be}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-CtwhIWzu.js";import"./utils-CLmukD0c.js";const Os={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},_s=({filters:s,onFiltersChange:n,statusOptions:o=[],originatorOptions:v=[],searchPlaceholder:u="Search requests...",showAdvanced:E=!0,className:R=""})=>{var H;const[C,$]=a.useState(!1),L=a.useRef(null),B=a.useMemo(()=>Array.isArray(s.status)?s.status:[],[s.status]),X=a.useMemo(()=>{let b=0;return B.length>0&&b++,s.dateFrom&&b++,s.dateTo&&b++,s.originatorId&&b++,b},[B,s.dateFrom,s.dateTo,s.originatorId]),S=a.useCallback(b=>{n({...s,search:b.target.value})},[s,n]),G=a.useCallback(b=>{const V=B.includes(b)?B.filter(h=>h!==b):[...B,b];n({...s,status:V})},[s,B,n]),z=a.useCallback(b=>{n({...s,dateFrom:b.target.value})},[s,n]),F=a.useCallback(b=>{n({...s,dateTo:b.target.value})},[s,n]),d=a.useCallback(b=>{n({...s,originatorId:b.target.value})},[s,n]),ee=a.useCallback(()=>{var b;n(Os),(b=L.current)==null||b.focus()},[n]),_=a.useCallback(()=>{var b;n({...s,search:""}),(b=L.current)==null||b.focus()},[s,n]);a.useEffect(()=>{const b=V=>{var h;(V.metaKey||V.ctrlKey)&&V.key==="k"&&(V.preventDefault(),(h=L.current)==null||h.focus())};return document.addEventListener("keydown",b),()=>document.removeEventListener("keydown",b)},[]);const O=s.search||X>0;return e.jsxs("div",{className:`space-y-3 ${R}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{ref:L,type:"text",value:s.search,onChange:S,placeholder:u,className:"block w-full pl-10 pr-10 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold bg-[var(--surface)] text-[var(--text)]","aria-label":"Search"}),s.search&&e.jsx("button",{onClick:_,className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600","aria-label":"Clear search",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute inset-y-0 right-8 flex items-center pointer-events-none text-xs text-gray-400",children:e.jsx("kbd",{className:"hidden sm:inline-block px-1.5 py-0.5 bg-gray-100 rounded border border-gray-200 font-mono",children:"âŒ˜K"})})]}),E&&e.jsxs("button",{onClick:()=>$(!C),className:`
              flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors
              ${C||X>0?"bg-brand-gold/10 border-brand-gold text-brand-navy":"border-brand-navy/30 text-[var(--text)] hover:bg-brand-cream/50"}
            `,"aria-expanded":C,"aria-controls":"filter-panel",children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"})}),e.jsx("span",{className:"hidden sm:inline",children:"Filters"}),X>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-brand-navy rounded-full",children:X})]}),O&&e.jsxs("button",{onClick:ee,className:"flex items-center gap-1 px-3 py-2 text-sm text-brand-red hover:text-brand-red-2 hover:bg-red-50 rounded-lg transition-colors","aria-label":"Clear all filters",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),E&&C&&e.jsxs("div",{id:"filter-panel",className:"p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[o.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Status"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:o.map(b=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-white/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:B.includes(b.value),onChange:()=>G(b.value),className:"h-4 w-4 text-brand-navy border-gray-300 rounded focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-[var(--text)]",children:b.label})]},b.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Date Range"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"From date"}),e.jsx("input",{type:"date",value:s.dateFrom,onChange:z,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"From date"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"To date"}),e.jsx("input",{type:"date",value:s.dateTo,onChange:F,min:s.dateFrom,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"To date"})]})]})]}),v.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Originator"}),e.jsxs("select",{value:s.originatorId,onChange:d,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"Filter by originator",children:[e.jsx("option",{value:"",children:"All originators"}),v.map(b=>e.jsx("option",{value:b.value,children:b.label},b.value))]})]})]}),X>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 pt-2 border-t border-brand-navy/10",children:[e.jsx("span",{className:"text-sm text-[var(--muted)]",children:"Active filters:"}),B.map(b=>{const V=o.find(h=>h.value===b);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[(V==null?void 0:V.label)||b,e.jsx("button",{onClick:()=>G(b),className:"hover:text-brand-red","aria-label":`Remove ${(V==null?void 0:V.label)||b} filter`,children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},b)}),s.dateFrom&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["From: ",s.dateFrom,e.jsx("button",{onClick:()=>n({...s,dateFrom:""}),className:"hover:text-brand-red","aria-label":"Remove from date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),s.dateTo&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["To: ",s.dateTo,e.jsx("button",{onClick:()=>n({...s,dateTo:""}),className:"hover:text-brand-red","aria-label":"Remove to date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),s.originatorId&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[((H=v.find(b=>b.value===s.originatorId))==null?void 0:H.label)||"Originator",e.jsx("button",{onClick:()=>n({...s,originatorId:""}),className:"hover:text-brand-red","aria-label":"Remove originator filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]})]})};function Ls(s,n){return a.useMemo(()=>{let o=Array.isArray(n.items)?n.items:[];const v=Array.isArray(s.status)?s.status:[];if(s.search){const u=s.search.toLowerCase();o=o.filter(E=>n.getSearchText(E).toLowerCase().includes(u))}return v.length>0&&n.getStatus&&(o=o.filter(u=>v.includes(n.getStatus(u)))),(s.dateFrom||s.dateTo)&&n.getDate&&(o=o.filter(u=>{const E=n.getDate(u);if(!E)return!1;const R=new Date(E);if(isNaN(R.getTime()))return!1;if(s.dateFrom){const C=new Date(s.dateFrom);if(R<C)return!1}if(s.dateTo){const C=new Date(s.dateTo);if(C.setHours(23,59,59,999),R>C)return!1}return!0})),s.originatorId&&n.getOriginatorId&&(o=o.filter(u=>n.getOriginatorId(u)===s.originatorId)),o},[s,n])}function Wt(s){if(s==null)return"";const n=String(s);return n.includes('"')||n.includes(",")||n.includes(`
`)||n.includes("\r")?`"${n.replace(/"/g,'""')}"`:n}function Ts(s,n){const v=n.map(E=>Wt(E.header)).join(","),u=s.map(E=>n.map(R=>{const C=R.getValue(E),$=R.format?R.format(C):C;return Wt($)}).join(","));return[v,...u].join(`\r
`)}function qs(s,n){const o=s.map(v=>{const u={};return n.forEach(E=>{const R=E.getValue(v);u[E.header]=E.format?E.format(R):R}),u});return JSON.stringify(o,null,2)}function Ht(s,n,o){const v=new Blob([s],{type:`${o};charset=utf-8;`}),u=URL.createObjectURL(v),E=document.createElement("a");E.href=u,E.download=n,document.body.appendChild(E),E.click(),document.body.removeChild(E),URL.revokeObjectURL(u)}function Fs({items:s,columns:n,filename:o="export",label:v="Export",variant:u="secondary",className:E="",disabled:R=!1,showCount:C=!0,formats:$=["csv"]}){const[L,B]=a.useState(!1),[X,S]=a.useState(!1),G=a.useRef(null),z=a.useCallback(ee=>{S(!0),B(!1),setTimeout(()=>{try{const _=new Date().toISOString().slice(0,10),O=`${o}_${_}`;if(ee==="csv"){const H=Ts(s,n);Ht(H,`${O}.csv`,"text/csv")}else{const H=qs(s,n);Ht(H,`${O}.json`,"application/json")}}catch(_){console.error("Export failed:",_)}finally{S(!1)}},100)},[s,n,o]);a.useEffect(()=>{const ee=_=>{G.current&&!G.current.contains(_.target)&&B(!1)};return L&&document.addEventListener("mousedown",ee),()=>{document.removeEventListener("mousedown",ee)}},[L]),a.useEffect(()=>{const ee=_=>{_.key==="Escape"&&B(!1)};return L&&document.addEventListener("keydown",ee),()=>{document.removeEventListener("keydown",ee)}},[L]);const F={primary:"bg-brand-navy text-brand-cream hover:bg-brand-navy/90",secondary:"bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold/10",text:"text-brand-navy hover:bg-brand-cream/50"},d=R||s.length===0||X;return $.length===1?e.jsxs("button",{onClick:()=>z($[0]),disabled:d,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${F[u]}
          ${E}
        `,children:[X?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:v}),C&&s.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",s.length,")"]})]}):e.jsxs("div",{className:"relative",ref:G,children:[e.jsxs("button",{onClick:()=>B(!L),disabled:d,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${F[u]}
          ${E}
        `,"aria-expanded":L,"aria-haspopup":"menu",children:[X?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:v}),C&&s.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",s.length,")"]}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${L?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),L&&e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-[var(--surface)] border border-brand-navy/20 rounded-lg shadow-lg z-50",role:"menu",children:[$.includes("csv")&&e.jsxs("button",{onClick:()=>z("csv"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 first:rounded-t-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export as CSV"]}),$.includes("json")&&e.jsxs("button",{onClick:()=>z("json"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 last:rounded-b-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})}),"Export as JSON"]})]})]})}const Ut=s=>{if(!s)return"";const n=new Date(s);return isNaN(n.getTime())?"":n.toLocaleDateString()},Bs=({request:s})=>{if(!s.ssic)return e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg text-center",children:[e.jsx("div",{className:"text-[var(--muted)] text-sm",children:"No retention schedule assigned"}),e.jsx("div",{className:"text-xs text-[var(--muted)] mt-1",children:"SSIC classification was not set when this request was created"})]});const n=new Date(s.createdAt),o={ssic:s.ssic,nomenclature:s.ssicNomenclature||"",bucket:s.ssicBucket||"",bucketTitle:s.ssicBucketTitle||"",dau:s.dau||"",isPermanent:s.isPermanent||!1,cutoffTrigger:s.cutoffTrigger||"CALENDAR_YEAR",cutoffDescription:s.cutoffDescription||"",retentionValue:s.retentionValue??null,retentionUnit:s.retentionUnit||"YEARS",disposalAction:s.disposalAction||"DESTROY"},v=ds(o,n),u=s.isPermanent||!1;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:`p-4 rounded-lg ${u?"bg-blue-50 border border-blue-200":"bg-amber-50 border border-amber-200"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`text-2xl ${u?"text-blue-600":"text-amber-600"}`,children:u?"ðŸ“":"â±ï¸"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-semibold text-[var(--text)]",children:[s.ssic," - ",s.ssicNomenclature]}),s.ssicBucketTitle&&e.jsx("div",{className:"text-sm text-[var(--muted)] mt-1",children:s.ssicBucketTitle}),e.jsx("div",{className:`text-xs font-medium uppercase tracking-wide mt-2 ${u?"text-blue-600":"text-amber-600"}`,children:u?"Permanent Record":"Temporary Record"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Retention Period"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:ms(o)})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Cutoff Trigger"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:us(o.cutoffTrigger)}),s.cutoffDescription&&e.jsx("div",{className:"text-xs text-[var(--muted)] mt-1",children:s.cutoffDescription})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Disposal Action"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:u?"Transfer to National Archives":"Destroy"})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Record Created"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:n.toLocaleDateString()})]})]}),!u&&e.jsxs("div",{className:"p-4 bg-[var(--surface)] rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-2",children:"Estimated Disposal Eligibility"}),v?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-2xl font-bold text-brand-navy",children:v.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}),e.jsx("div",{className:"text-sm text-[var(--muted)]",children:v>new Date?e.jsxs(e.Fragment,{children:["(",Math.ceil((v.getTime()-Date.now())/(1e3*60*60*24))," days remaining)"]}):e.jsx("span",{className:"text-green-600 font-medium",children:"Eligible for disposal"})})]}):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"Unable to calculate - may require event date (case closure, separation, etc.)"})]}),s.dau&&e.jsxs("div",{className:"text-xs text-[var(--muted)] border-t border-brand-navy/10 pt-3",children:[e.jsx("span",{className:"font-medium",children:"Disposition Authority:"})," ",s.dau]})]})};function Pt(s,n={}){const{pageSize:o=25,initialPage:v=1}=n,[u,E]=a.useState(v),[R,C]=a.useState(o),$=s.length,L=Math.ceil($/R),B=(u-1)*R,X=Math.min(B+R,$);return{currentData:a.useMemo(()=>s.slice(B,X),[s,B,X]),currentPage:u,pageSize:R,totalPages:L,totalItems:$,goToPage:O=>{const H=Math.max(1,Math.min(O,L));E(H)},nextPage:()=>{u<L&&E(u+1)},previousPage:()=>{u>1&&E(u-1)},goToFirstPage:()=>{E(1)},goToLastPage:()=>{E(L)},setPageSize:O=>{C(O),E(1)},canGoNext:u<L,canGoPrevious:u>1,startIndex:B+1,endIndex:X}}const ct="edms-docs";function Vs(){return{uploadFile:async(E,R)=>{if(!Re)return{url:"",error:"Supabase not configured"};try{const{error:C}=await Re.storage.from(ct).upload(R,E,{upsert:!0});if(C)return{url:"",error:C.message};const{data:$}=Re.storage.from(ct).getPublicUrl(R);return{url:($==null?void 0:$.publicUrl)||""}}catch(C){return{url:"",error:C instanceof Error?C.message:"Upload failed"}}},deleteFile:async E=>{if(!Re||!E)return!1;try{return await Re.storage.from(ct).remove([E]),!0}catch{return!1}},deleteFolder:async E=>{if(!Re)return!1;try{const{data:R}=await Re.storage.from(ct).list(E.replace(/\/$/,""));if(R&&R.length>0){const C=R.map($=>`${E.replace(/\/$/,"")}/${$.name}`);await Re.storage.from(ct).remove(C)}return!0}catch{return!1}},extractStoragePath:E=>{if(!E)return null;try{const R=E.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(R!=null&&R[1])return decodeURIComponent(R[1])}catch{}return null},buildStoragePath:(E,R,C,$)=>{const L=Date.now();return`${E||"N-A"}/${R}/${L}-${$}-${Xt(C)}`}}}const qe=s=>{const n=String(s||"").trim();return n&&n!=="N/A"?n:""},Ze=(s,n,o)=>s.some(v=>String(v.role||"")!==n||qe(v.roleCompany||v.company)!==o.company||n==="PLATOON_REVIEWER"&&qe(v.rolePlatoon||v.platoon)!==(o.platoon||"")?!1:String(v.unitUic||"")===String(o.uic||""));function os(s){if(s===0)return"0 Bytes";const n=1024,o=["Bytes","KB","MB","GB"],v=Math.floor(Math.log(s)/Math.log(n));return parseFloat((s/Math.pow(n,v)).toFixed(2))+" "+o[v]}const Qt=a.memo(function({doc:n,onView:o,onDelete:v}){const[u,E]=a.useState(!1),R=n.fileUrl&&Rs(n.type,n.name);return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:"flex items-center justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors","aria-label":`Document: ${n.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Is,{type:n.type,fileName:n.name,size:"md"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-[var(--text)]",children:n.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)]",children:[n.name," â€¢ ",os(n.size)," â€¢ ",new Date(n.uploadedAt).toLocaleDateString()]}),n.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(n.dueDate).toLocaleDateString()]}),n.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Notes: ",n.notes]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",role:"group","aria-label":"Document actions",children:[n.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:rs({currentStage:n.currentStage})}),R&&e.jsx("button",{type:"button",onClick:C=>{C.stopPropagation(),E(!0)},className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Preview document ${n.name}`,children:"Preview"}),n.fileUrl&&e.jsx("a",{href:n.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${n.name} in new tab`,children:"Open"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:C=>{C.stopPropagation(),o(n)},"aria-label":`View or edit document ${n.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:C=>{C.stopPropagation(),v(n)},"aria-label":`Delete document ${n.subject}`,children:"Delete"})]})]}),n.fileUrl&&e.jsx(is,{url:n.fileUrl,fileName:n.name,mimeType:n.type,fileSize:n.size,isOpen:u,onClose:()=>E(!1)})]})}),Xe="edms-docs",Ws=({selectedUnit:s,currentUser:n})=>{const[o,v]=a.useState([]),[u,E]=a.useState(!1),[R,C]=a.useState(""),[$,L]=a.useState(""),[B,X]=a.useState(""),[S,G]=a.useState([]),[z,F]=a.useState(null),[d,ee]=a.useState(null),[_,O]=a.useState([]),[H,b]=a.useState(!1),[V,h]=a.useState(null),[I,T]=a.useState(""),[k,Y]=a.useState(""),[w,f]=a.useState(""),[U,W]=a.useState([]),[K,re]=a.useState([]),[P,ue]=a.useState(null),[fe,ye]=a.useState(""),[pe,Ne]=a.useState(""),[he,y]=a.useState(""),[M,se]=a.useState([]),[oe,ie]=a.useState(!1),[Ae,je]=a.useState({}),[ge,De]=a.useState(""),[Se,x]=a.useState("Pending"),[j,Z]=a.useState({}),[ne,le]=a.useState(""),[p,A]=a.useState(null),[i,m]=a.useState("documents"),[q,te]=a.useState(!1),[ce,me]=a.useState(null),ke=Vs(),Ce=c=>{const t=c.target.files?Array.from(c.target.files):[];if(t.length===0)return;if(S.length+t.length>Ft){F({type:"error",message:`Cannot add ${t.length} file(s). Maximum ${Ft} files allowed per request.`});try{c.target.value=""}catch{}return}const r=[],l=[];for(const N of t){const Q=ps(N);Q.valid?r.push(N):l.push(...Q.errors)}r.length>0&&G(N=>[...N,...r]),l.length>0&&F({type:"error",message:l.slice(0,3).join(" ")+(l.length>3?` (+${l.length-3} more errors)`:"")});try{c.target.value=""}catch{}},xe=async()=>{if(!P||!(d!=null&&d.id)||P.uploadedById!==d.id)return;const c={actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,timestamp:new Date().toISOString(),action:"Archived by Originator",comment:(he||"").trim()},t={...P,currentStage:Ue.ARCHIVED,finalStatus:"Archived",activity:Array.isArray(P.activity)?[...P.activity,c]:[c]};try{const r=await _e(t);if(!r.ok)throw new Error(ae(r,"request_upsert_failed"));re(l=>l.map(N=>N.id===t.id?t:N)),ue(t),F({type:"success",message:"Request archived."})}catch(r){F({type:"error",message:`Failed to archive: ${String((r==null?void 0:r.message)||r)}`})}},Ie=async()=>{if(!P||!(d!=null&&d.id))return;if(!P.ssic){F({type:"error",message:"Request must have SSIC/retention classification before filing."});return}const c=new Date().toISOString(),t={actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,timestamp:c,action:"Filed for Records Management",comment:(he||"").trim()},r={...P,filedAt:c,activity:Array.isArray(P.activity)?[...P.activity,t]:[t]};try{const l=await _e(r);if(!l.ok)throw new Error(ae(l,"request_upsert_failed"));re(N=>N.map(Q=>Q.id===r.id?r:Q)),ue(r),F({type:"success",message:"Request filed for records management."})}catch(l){F({type:"error",message:`Failed to file request: ${String((l==null?void 0:l.message)||l)}`})}},Te=async()=>{if(!P||!(d!=null&&d.id)||P.uploadedById!==d.id)return;const c=_.find(de=>de.id===P.uploadedById),t=P.unitUic||(c==null?void 0:c.unitUic)||"",r=qe(c==null?void 0:c.company),l=qe(c==null?void 0:c.platoon),N=Ze(_,"PLATOON_REVIEWER",{company:r,platoon:l,uic:t}),Q=Ze(_,"COMPANY_REVIEWER",{company:r,uic:t}),J=N?Ue.PLATOON_REVIEW:Q?Ue.COMPANY_REVIEW:Ue.BATTALION_REVIEW,D={actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,actorRole:"Member",timestamp:new Date().toISOString(),action:"Resubmitted request",comment:(he||"").trim()},Ee={...P,currentStage:J,routeSection:"",activity:[...P.activity||[],D]};try{const de=await _e(Ee);if(!de.ok)throw new Error(ae(de,"request_upsert_failed"));re($e=>$e.map(Oe=>Oe.id===Ee.id?Ee:Oe)),ue(Ee),y(""),F({type:"success",message:"Request resubmitted for review."})}catch(de){F({type:"error",message:`Failed to resubmit: ${String((de==null?void 0:de.message)||de)}`})}},Ye=async c=>{c.preventDefault(),F(null);const t=R.trim();if(!t){F({type:"error",message:"Subject is required."});return}if(t.length>500){F({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(B.length>5e3){F({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(d!=null&&d.id)){F({type:"error",message:"Create a profile before submitting."});return}if(S.length>0){const de=xs(S);if(!de.valid){F({type:"error",message:de.errors[0]});return}}E(!0);const r=Date.now(),l=ge||d.id,N=_.find(de=>de.id===l),Q=s?s.uic:(N==null?void 0:N.unitUic)||"N/A",J=`req-${r}`;let D=[];async function Ee(de,$e){if(!Re)throw new Error("Supabase not configured");const{error:Oe}=await Re.storage.from(Xe).upload($e,de,{upsert:!0});if(Oe)throw new Error(Oe.message);const{data:We}=Re.storage.from(Xe).getPublicUrl($e);return(We==null?void 0:We.publicUrl)||""}if(S&&S.length>0){const de=[];for(let $e=0;$e<S.length;$e++){const Oe=S[$e],We=`${Q}/${J}/${r}-${$e}-${Xt(Oe.name)}`;try{const He=await Ee(Oe,We);de.push(He)}catch(He){E(!1),F({type:"error",message:`Failed to upload ${Oe.name}: ${String((He==null?void 0:He.message)||He)}`});return}}D=S.map(($e,Oe)=>({id:`${r}-${Oe}`,name:$e.name,type:$e.type,size:$e.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:Q,subject:R.trim(),dueDate:$||void 0,notes:B.trim()||void 0,uploadedById:l,currentStage:"PLATOON_REVIEW",fileUrl:de[Oe]}))}D=D.map(de=>({...de,requestId:J})),v(de=>[...de,...D]),G([]),C(""),L(""),X("");try{const de=d?`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`:"Unknown",$e="Member",Oe=Q,We=qe(N==null?void 0:N.company),He=qe(N==null?void 0:N.platoon),Lt=Ze(_,"PLATOON_REVIEWER",{company:We,platoon:He,uic:Oe}),Tt=Ze(_,"COMPANY_REVIEWER",{company:We,uic:Oe}),ls=!Lt&&!Tt,ot={id:J,subject:R.trim(),dueDate:$||void 0,notes:B.trim()||void 0,unitUic:Q,uploadedById:l,submitForUserId:l,documentIds:D.map(Pe=>Pe.id),createdAt:new Date().toISOString(),currentStage:Lt?Ue.PLATOON_REVIEW:Tt?Ue.COMPANY_REVIEW:Ue.BATTALION_REVIEW,routeSection:ls&&ne?ne:void 0,ssic:p==null?void 0:p.ssic,ssicNomenclature:p==null?void 0:p.nomenclature,ssicBucket:p==null?void 0:p.bucket,ssicBucketTitle:p==null?void 0:p.bucketTitle,isPermanent:p==null?void 0:p.isPermanent,retentionValue:p==null?void 0:p.retentionValue,retentionUnit:p==null?void 0:p.retentionUnit,cutoffTrigger:p==null?void 0:p.cutoffTrigger,cutoffDescription:p==null?void 0:p.cutoffDescription,disposalAction:p==null?void 0:p.disposalAction,dau:p==null?void 0:p.dau,activity:[{actor:de,actorRole:$e,timestamp:new Date().toISOString(),action:"Submitted request",comment:(B||"").trim()}]};try{const Pe=await _e(ot);if(!Pe.ok)throw new Error(ae(Pe,"request_upsert_failed"));const At=await Rt(D);if(!At.ok)throw new Error(ae(At,"document_upsert_failed"))}catch(Pe){E(!1);try{kt("request_persist_failed",{requestId:J,error:String((Pe==null?void 0:Pe.message)||Pe)},"error")}catch{}F({type:"error",message:`Failed to persist submission: ${String((Pe==null?void 0:Pe.message)||Pe)}`});return}re(Pe=>Pe.some(pt=>pt.id===ot.id)?Pe.map(pt=>pt.id===ot.id?ot:pt):[...Pe,ot]),E(!1),F({type:"success",message:"Submission successful."}),b(!1),le(""),A(null)}catch{E(!1);try{kt("request_persist_failed",{requestId:J},"error")}catch{}F({type:"error",message:"Failed to persist submission."})}},g=a.useCallback(c=>{h(c),T(c.subject||""),Y(c.dueDate||""),f(c.notes||"");try{const t=localStorage.getItem(`fs/requests/${c.requestId}.json`);if(t){const r=JSON.parse(t);W(Array.isArray(r.activity)?r.activity:[])}else{const N=Object.values(Object.assign({})).map(Q=>(Q==null?void 0:Q.default)??Q).find(Q=>Q&&Q.id===c.requestId);W(N&&Array.isArray(N.activity)?N.activity:[])}}catch{W([])}},[]),ae=(c,t)=>{var r;return String(((r=c.error)==null?void 0:r.message)||c.error||t)},be=async()=>{if(!V)return;const c=o.map(t=>t.id===V.id?{...t,subject:I.trim()||t.subject,dueDate:k||void 0,notes:w.trim()||void 0}:t);v(c);try{const l={actor:d?`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`:"Unknown",actorRole:"Member",timestamp:new Date().toISOString(),action:"Updated document",comment:(w||"").trim()},N=V.requestId?K.find(Q=>Q.id===V.requestId):null;if(N){const Q={...N,activity:Array.isArray(N.activity)?[...N.activity,l]:[l]};try{const J=await _e(Q);if(!J.ok)throw new Error(ae(J,"request_upsert_failed"))}catch(J){console.error("Failed to save document edits:",J),F({type:"error",message:`Failed to save document edits: ${J.message}`});return}W(J=>[...J,l])}}catch{}f(""),h(null)};o.filter(c=>!(!(d!=null&&d.id)||d.role==="MEMBER"&&c.uploadedById!==d.id||c.type==="request"));const Me=c=>c.currentStage==="ORIGINATOR_REVIEW",Ge=()=>String((d==null?void 0:d.role)||"").includes("REVIEW"),Je=()=>{if(!Ge())return[];const c=String((d==null?void 0:d.role)||"");return _.filter(t=>{if(t.id===(d==null?void 0:d.id))return!1;if(c.includes("PLATOON")){const r=t.company&&t.company!=="N/A"?t.company:"",l=t.unit&&t.unit!=="N/A"?t.unit:"",N=d!=null&&d.company&&d.company!=="N/A"?d.company:"",Q=d!=null&&d.unit&&d.unit!=="N/A"?d.unit:"";return r===N&&l===Q}if(c.includes("COMPANY")){const r=t.company&&t.company!=="N/A"?t.company:"",l=d!=null&&d.company&&d.company!=="N/A"?d.company:"";return r===l}return c.includes("COMMANDER")?(t.unitUic||"")===((d==null?void 0:d.unitUic)||""):!1})},ve=a.useCallback(async c=>{const t=ke.extractStoragePath(c.fileUrl);try{t&&Re&&await Re.storage.from(Xe).remove([t])}catch{}try{await ys(c.id),v(r=>r.filter(l=>l.id!==c.id)),c.requestId&&re(r=>r.map(l=>l.id===c.requestId?{...l,documentIds:(l.documentIds||[]).filter(N=>N!==c.id)}:l)),F({type:"success",message:"Document deleted."})}catch(r){F({type:"error",message:`Failed to delete: ${String((r==null?void 0:r.message)||r)}`})}},[]),Ve=a.useCallback(async c=>{const t=`${c.unitUic||"N-A"}/${c.id}/`;try{if(Re){const{data:r}=await Re.storage.from(Xe).list(t.slice(0,-1));if(r&&r.length>0){const l=r.map(N=>`${t.slice(0,-1)}/${N.name}`);await Re.storage.from(Xe).remove(l)}}}catch{}try{await vs(c.id),await Ns(c.id),v(r=>r.filter(l=>l.requestId!==c.id)),re(r=>r.filter(l=>l.id!==c.id)),ue(null),F({type:"success",message:"Request and files deleted."})}catch(r){F({type:"error",message:`Failed to delete request: ${String((r==null?void 0:r.message)||r)}`})}},[]),Ke=async()=>{if(!P||!(d!=null&&d.id)||P.uploadedById!==d.id){F({type:"error",message:"Only the requester can edit this."});return}const c=Date.now(),t=J=>J.replace(/[^A-Za-z0-9._-]/g,"-");async function r(J,D){if(!Re)throw new Error("Supabase not configured");const{error:Ee}=await Re.storage.from(Xe).upload(D,J,{upsert:!0});if(Ee)throw new Error(Ee.message);const{data:de}=Re.storage.from(Xe).getPublicUrl(D);return(de==null?void 0:de.publicUrl)||""}const l=[];for(let J=0;J<M.length;J++){const D=M[J],Ee=`${P.unitUic||"N-A"}/${P.id}/${c}-${J}-${t(D.name)}`;try{const de=await r(D,Ee);l.push(de)}catch(de){F({type:"error",message:`Failed to upload ${D.name}: ${String((de==null?void 0:de.message)||de)}`});return}}const N=M.map((J,D)=>({id:`${c}-${D}`,name:J.name,type:J.type,size:J.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:P.unitUic||"N/A",subject:fe.trim()||P.subject,dueDate:pe||void 0,notes:he.trim()||void 0,uploadedById:d.id,currentStage:P.currentStage||"PLATOON_REVIEW",requestId:P.id,fileUrl:l[D]})),Q={...P,subject:fe.trim()||P.subject,dueDate:pe||void 0,notes:he.trim()||void 0,documentIds:[...P.documentIds||[],...N.map(J=>J.id)],activity:[...P.activity||[],{actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,timestamp:new Date().toISOString(),action:N.length?`Updated request and added ${N.length} document(s)`:"Updated request",comment:(he||"").trim()}]};try{if(!(d&&Es(P,String(d.id||"")))){F({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const D=await Rt(N);if(!D.ok)throw new Error(ae(D,"document_upsert_failed"));const Ee=await _e(Q);if(!Ee.ok)throw new Error(ae(Ee,"request_upsert_failed"))}catch(D){try{kt("request_update_failed",{requestId:Q.id,error:String((D==null?void 0:D.message)||D)},"error")}catch{}F({type:"error",message:`Failed to persist documents: ${String((D==null?void 0:D.message)||D)}`});return}v(D=>[...D,...N]),re(D=>D.map(Ee=>Ee.id===Q.id?Q:Ee)),ue(Q),se([]),y(""),F({type:"success",message:N.length?"Files added and request updated.":"Request updated."})}catch{F({type:"error",message:"Failed to update request."})}},dt=async()=>{if(!P||!d||!ce)return;const c=`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,t=d.role||"Reviewer",r={actor:c,actorRole:t,timestamp:new Date().toISOString(),action:"Updated retention classification",comment:`Changed SSIC to ${ce.ssic} - ${ce.nomenclature}`},l={...P,ssic:ce.ssic,ssicNomenclature:ce.nomenclature,ssicBucket:ce.bucket,ssicBucketTitle:ce.bucketTitle,isPermanent:ce.isPermanent,retentionValue:ce.retentionValue,retentionUnit:ce.retentionUnit,cutoffTrigger:ce.cutoffTrigger,cutoffDescription:ce.cutoffDescription,disposalAction:ce.disposalAction,dau:ce.dau,activity:[...P.activity||[],r]};try{const N=await _e(l);if(!N.ok)throw new Error(ae(N,"request_upsert_failed"));re(Q=>Q.map(J=>J.id===l.id?l:J)),ue(l),te(!1),me(null),F({type:"success",message:"Retention classification updated."})}catch(N){F({type:"error",message:`Failed to update retention: ${String((N==null?void 0:N.message)||N)}`})}},[rt,tt]=a.useState(!0),[st,yt]=a.useState(!0);a.useEffect(()=>{Ot().then(c=>{v(c)}).catch(()=>v([])).finally(()=>tt(!1))},[]),a.useEffect(()=>{P&&(ye(P.subject||""),Ne(P.dueDate||""),y(P.notes||""),se([]),te(!1),me(null))},[P]),a.useEffect(()=>{},[o]),a.useEffect(()=>{gt().then(c=>{re(c)}).catch(()=>re([])).finally(()=>yt(!1))},[]),a.useEffect(()=>{ee(n||null)},[n]),a.useEffect(()=>{nt().then(c=>{O(c)}).catch(()=>O([]))},[]),a.useEffect(()=>{try{const c=localStorage.getItem("unit_structure"),t={};if(c){const r=JSON.parse(c);for(const l of Object.keys(r||{})){const N=r[l];N&&Array.isArray(N._sections)&&(t[l]=N._sections)}Z(t)}else(async()=>{try{const r=await ft();for(const l of Object.keys(r||{})){const N=r[l];N&&Array.isArray(N._sections)&&(t[l]=N._sections)}Z(t)}catch{}})()}catch{}},[]);const vt=a.useMemo(()=>d!=null&&d.id?K.filter(t=>t.uploadedById===d.id).filter(t=>t.currentStage!=="ARCHIVED"):[],[K,d]),mt=a.useCallback(c=>{if(c.isPermanent)return"Permanent";if(!c.retentionValue||!c.cutoffTrigger)return"Unknown";const t=new Date(c.createdAt);let r;switch(c.cutoffTrigger){case"CALENDAR_YEAR":r=new Date(t.getFullYear(),11,31);break;case"FISCAL_YEAR":r=t.getMonth()>=9?new Date(t.getFullYear()+1,8,30):new Date(t.getFullYear(),8,30);break;default:r=t}const l=new Date(r);return c.retentionUnit==="years"?l.setFullYear(l.getFullYear()+c.retentionValue):c.retentionUnit==="months"?l.setMonth(l.getMonth()+c.retentionValue):c.retentionUnit==="days"&&l.setDate(l.getDate()+c.retentionValue),l.getFullYear().toString()},[]),it=a.useMemo(()=>{if(!(d!=null&&d.id))return{};const c=K.filter(r=>r.uploadedById===d.id&&r.ssic&&r.filedAt),t={};for(const r of c){const l=mt(r),N=r.ssicBucketTitle||r.ssicBucket||"Uncategorized";t[l]||(t[l]={}),t[l][N]||(t[l][N]=[]),t[l][N].push(r)}for(const r of Object.keys(t))for(const l of Object.keys(t[r]))t[r][l].sort((N,Q)=>new Date(Q.createdAt).getTime()-new Date(N.createdAt).getTime());return t},[K,d,mt]),ut=a.useMemo(()=>Object.keys(it).sort((t,r)=>t==="Permanent"?-1:r==="Permanent"||t==="Unknown"?1:r==="Unknown"?-1:parseInt(t)-parseInt(r)),[it]),Nt=a.useCallback(c=>{if(!c.retentionValue||!c.cutoffTrigger)return"N/A";if(c.isPermanent)return"Permanent";const t=new Date(c.createdAt);let r;switch(c.cutoffTrigger){case"CALENDAR_YEAR":r=new Date(t.getFullYear(),11,31);break;case"FISCAL_YEAR":r=t.getMonth()>=9?new Date(t.getFullYear()+1,8,30):new Date(t.getFullYear(),8,30);break;default:r=t}const l=new Date(r);return c.retentionUnit==="years"?l.setFullYear(l.getFullYear()+c.retentionValue):c.retentionUnit==="months"?l.setMonth(l.getMonth()+c.retentionValue):c.retentionUnit==="days"&&l.setDate(l.getDate()+c.retentionValue),l.toLocaleDateString()},[]),jt=a.useCallback(c=>{var r;const t=_.find(l=>l.id===c.uploadedById);return t?`${t.lastName}, ${((r=t.firstName)==null?void 0:r.charAt(0))||""}`:"Unknown"},[_]),we=Pt(vt,{pageSize:10}),St=a.useMemo(()=>_.reduce((c,t)=>({...c,[t.id]:t}),{}),[_]),wt=a.useMemo(()=>{const c=ge||(d==null?void 0:d.id),t=_.find(D=>D.id===c),r=s?s.uic:(t==null?void 0:t.unitUic)||"",l=qe(t==null?void 0:t.company),N=qe(t==null?void 0:t.platoon);if(!r)return!1;const Q=Ze(_,"PLATOON_REVIEWER",{company:l,platoon:N,uic:r}),J=Ze(_,"COMPANY_REVIEWER",{company:l,uic:r});return!Q&&!J},[_,d,ge,s]),xt=a.useMemo(()=>{const c=ge||(d==null?void 0:d.id),t=_.find(l=>l.id===c),r=s?s.uic:(t==null?void 0:t.unitUic)||"";return j[r]||[]},[j,_,d,ge,s]),Ct=a.useCallback(c=>{const t=qe(c.currentStage||"PLATOON_REVIEW"),r=_.find(l=>l.id===c.uploadedById);switch(t){case"ORIGINATOR_REVIEW":return{level:"Member",scope:""};case"PLATOON_REVIEW":{const l=r!=null&&r.company&&r.company!=="N/A"?r.company:"",N=r!=null&&r.platoon&&r.platoon!=="N/A"?r.platoon:"";return l&&N?{level:"Platoon",scope:`(${l}-${N})`}:l?{level:"Platoon",scope:`(${l})`}:{level:"Platoon",scope:""}}case"COMPANY_REVIEW":{const l=r!=null&&r.company&&r.company!=="N/A"?r.company:"";return{level:"Company",scope:l?`(${l})`:""}}case"BATTALION_REVIEW":return{level:"Battalion",scope:c.routeSection?`(${c.routeSection})`:""};case"COMMANDER_REVIEW":return{level:"Commander",scope:c.routeSection?`(${c.routeSection})`:""};case"ARCHIVED":return{level:"Archived",scope:""};default:return{level:rs(c),scope:""}}},[_]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>b(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),H&&e.jsxs("form",{onSubmit:Ye,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:R,onChange:c=>C(c.target.value),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${R.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:$,onChange:c=>L(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),e.jsx("div",{children:e.jsx(qt,{value:p,onChange:A,required:!0})}),String((d==null?void 0:d.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:ge,onChange:c=>De(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),Je().map(c=>e.jsxs("option",{value:c.id,children:[c.rank," ",c.lastName,", ",c.firstName,c.mi?` ${c.mi}`:""]},c.id))]})]})}),wt&&xt.length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Battalion Section"}),e.jsxs("select",{value:ne,onChange:c=>le(c.target.value),className:`w-full px-3 py-2 border ${ne?"border-brand-navy/30":"border-brand-gold"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`,children:[e.jsx("option",{value:"",children:"Select section"}),xt.map(c=>e.jsx("option",{value:c,children:c},c))]}),e.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"No platoon/company reviewer available. Select a section for routing."})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:B,onChange:c=>X(c.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:Ce,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:S.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:S.map((c,t)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:c.name,children:c.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>G(r=>r.filter((l,N)=>N!==t)),children:"Delete"})]},t))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{b(!1),G([]),C(""),L(""),X(""),le(""),A(null),F(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!R.trim()||!p,children:"Submit"})]})]}),z&&e.jsx("div",{className:`p-3 rounded-lg border ${z.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:z.message})]})]}),e.jsxs("div",{className:"p-6",children:[d&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>x("Pending"),className:`${Se==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>x("Files"),className:`${Se==="Files"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Files"})]})}),Se==="Pending"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:we.totalItems>0?`${we.startIndex}â€“${we.endIndex} of ${we.totalItems}`:""}),st&&e.jsx("div",{className:"animate-pulse",children:"Loading requestsâ€¦"})]}),e.jsx(ze,{title:"Your Requests",requests:st?Array.from({length:5}).map((c,t)=>({id:`s-${t}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:Ue.PLATOON_REVIEW})):we.currentData,users:St,onRowClick:c=>ue(c),expandedRows:Ae,children:c=>e.jsxs("div",{id:`req-docs-${c.id}`,children:[rt?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):o.filter(t=>t.requestId===c.id&&t.type!=="request").map(t=>e.jsx(Qt,{doc:t,onView:g,onDelete:ve},t.id)),!rt&&o.filter(t=>t.requestId===c.id&&t.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),we.totalItems>0&&e.jsx(Dt,{currentPage:we.currentPage,totalPages:we.totalPages,totalItems:we.totalItems,pageSize:we.pageSize,startIndex:we.startIndex,endIndex:we.endIndex,onPageChange:we.goToPage,onPageSizeChange:we.setPageSize,onNext:we.nextPage,onPrevious:we.previousPage,onFirst:we.goToFirstPage,onLast:we.goToLastPage,canGoNext:we.canGoNext,canGoPrevious:we.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),Se==="Files"&&e.jsx("div",{className:"py-4 space-y-6",children:st?e.jsx("div",{className:"animate-pulse",children:"Loading recordsâ€¦"}):ut.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("p",{children:"No filed records yet."}),e.jsx("p",{className:"text-sm mt-1",children:'Archive a request and click "File" to add it to records management.'})]}):e.jsx(e.Fragment,{children:ut.map(c=>{const t=it[c],r=Object.keys(t).sort(),l=c==="Permanent",N=Object.values(t).reduce((Q,J)=>Q+J.length,0);return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`${l?"bg-blue-800":"bg-brand-navy"} text-brand-cream px-4 py-2 rounded-lg font-medium flex items-center justify-between`,children:[e.jsx("span",{children:l?"Permanent Records":`Disposal Year: ${c}`}),e.jsxs("span",{className:"text-xs bg-white/20 px-2 py-0.5 rounded",children:[N," record",N!==1?"s":""]})]}),r.map(Q=>{const J=t[Q];return e.jsxs("div",{className:"ml-4",children:[e.jsxs("div",{className:"bg-gray-100 text-gray-700 px-3 py-1.5 rounded-t-lg font-medium text-sm border border-b-0 border-gray-200 flex items-center justify-between",children:[e.jsx("span",{children:Q}),e.jsxs("span",{className:"text-xs text-gray-500",children:[J.length," item",J.length!==1?"s":""]})]}),e.jsx("div",{className:"border border-gray-200 rounded-b-lg overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Name"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"SSIC"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Retention"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Disposal Date"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Date Finalized"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Originator"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Disposal Action"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:J.map(D=>e.jsxs("tr",{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>ue(D),children:[e.jsx("td",{className:"px-3 py-2 font-medium text-brand-navy",children:D.subject}),e.jsx("td",{className:"px-3 py-2",children:D.ssic}),e.jsx("td",{className:"px-3 py-2",children:D.isPermanent?e.jsx("span",{className:"inline-flex px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded",children:"Permanent"}):e.jsxs("span",{className:"inline-flex px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded",children:[D.retentionValue," ",D.retentionUnit]})}),e.jsx("td",{className:"px-3 py-2",children:Nt(D)}),e.jsx("td",{className:"px-3 py-2",children:D.filedAt?new Date(D.filedAt).toLocaleDateString():"N/A"}),e.jsx("td",{className:"px-3 py-2",children:jt(D)}),e.jsx("td",{className:"px-3 py-2",children:D.disposalAction||(D.isPermanent?"TRANSFER":"DESTROY")})]},D.id))})]})})]},`${c}-${Q}`)})]},c)})})})]}),u&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),V&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>h(null),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:I,onChange:c=>T(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:k,onChange:c=>Y(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:V.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:w,onChange:c=>f(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[V.name," â€¢ ",os(V.size)," â€¢ ",new Date(V.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:U.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):U.map((c,t)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[c.actor,c.actorRole?` â€¢ ${c.actorRole}`:""," â€¢ ",new Date(c.timestamp).toLocaleString()," â€¢ ",c.action]}),c.comment&&e.jsx("div",{className:"text-gray-600",children:c.comment})]},t))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>h(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:be,children:"Save"})]})]})}),P&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>ue(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>ue(null),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:fe,onChange:c=>ye(c.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(P.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:pe,onChange:c=>Ne(c.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),P.currentStage&&(()=>{const{level:c,scope:t}=Ct(P);return e.jsxs("span",{className:"inline-flex flex-col items-center px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-lg border border-brand-navy/30 leading-tight",children:[e.jsx("span",{children:c}),t&&e.jsx("span",{className:"text-[10px]",children:t})]})})(),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:3,value:he,onChange:c=>y(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-4","aria-label":"Request details tabs",children:[e.jsx("button",{onClick:()=>m("documents"),className:`${i==="documents"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Documents"}),e.jsx("button",{onClick:()=>m("retention"),className:`${i==="retention"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Retention"}),e.jsx("button",{onClick:()=>m("activity"),className:`${i==="activity"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Activity"})]})}),e.jsxs("div",{className:"mt-3",children:[i==="documents"&&e.jsxs("div",{className:"space-y-3",children:[o.filter(c=>c.requestId===P.id&&c.type!=="request").length>0?o.filter(c=>c.requestId===P.id&&c.type!=="request").map(c=>e.jsx(Qt,{doc:c,onView:g,onDelete:ve},c.id)):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents attached"}),!Vt(P,String((d==null?void 0:d.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:c=>{const t=c.target.files?Array.from(c.target.files):[];se(r=>[...r,...t]);try{c.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2 mt-2",children:M.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):M.map((c,t)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:c.name,children:c.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>se(r=>r.filter((l,N)=>N!==t)),children:"Delete"})]},t))})]})]}),i==="retention"&&e.jsx("div",{children:q?e.jsxs("div",{className:"space-y-4",children:[e.jsx(qt,{value:ce,onChange:me,required:!0}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{te(!1),me(null)},className:"px-3 py-1 rounded border border-brand-navy/30 text-brand-navy hover:bg-brand-cream text-sm",children:"Cancel"}),e.jsx("button",{type:"button",onClick:dt,disabled:!ce,className:"px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 text-sm disabled:opacity-50",children:"Save Retention"})]})]}):e.jsxs("div",{children:[P.ssic?e.jsx(Bs,{request:P}):e.jsx("div",{className:"text-sm text-[var(--muted)] p-4 bg-gray-50 rounded-lg",children:"No retention information available for this request."}),d&&P.currentStage!=="ARCHIVED"&&e.jsx("button",{type:"button",onClick:()=>te(!0),className:"mt-3 px-3 py-1 rounded border border-brand-navy/30 text-brand-navy hover:bg-brand-cream text-sm",children:P.ssic?"Change Retention":"Add Retention Info"})]})}),i==="activity"&&e.jsx("div",{className:"space-y-2",children:P.activity&&P.activity.length?P.activity.map((c,t)=>e.jsxs("div",{className:"text-xs text-gray-700 p-2 bg-gray-50 rounded",children:[e.jsxs("div",{className:"font-medium",children:[c.actor,c.actorRole?` â€¢ ${c.actorRole}`:""," â€¢ ",new Date(c.timestamp).toLocaleString()," â€¢ ",c.action]}),c.comment&&e.jsx("div",{className:"text-gray-600 mt-1",children:c.comment})]},t)):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No activity recorded"})})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>ue(null),children:"Close"}),Vt(P,String((d==null?void 0:d.id)||""))?e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-gold text-brand-charcoal hover:brightness-110",onClick:xe,children:"Archive"}):e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:Ke,disabled:!d||d.id!==((P==null?void 0:P.uploadedById)||""),children:"Save Changes"}),d&&Me(P)&&d.id===P.uploadedById&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700",onClick:Te,children:"Resubmit"}),d&&P.currentStage==="ARCHIVED"&&P.ssic&&!P.filedAt&&d.id===P.uploadedById&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700",onClick:Ie,children:"File"}),d&&ks(P,String((d==null?void 0:d.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>Ve(P),children:"Delete Request"})]})]})})]})},Hs=({currentUser:s,onClose:n})=>{const[o,v]=a.useState([]),[u,E]=a.useState(""),[R,C]=a.useState(!1),[$,L]=a.useState(""),[B,X]=a.useState(!1),[S,G]=a.useState("");a.useEffect(()=>{bt().then(O=>{v(O.data||[])}).catch(()=>v([]))},[]);const z=a.useMemo(()=>String(s.role||"")!=="MEMBER",[s]),F=a.useMemo(()=>{const O=H=>{const b=s.unitUic||"",V=String(s.role||"");if(V.includes("PLATOON")){const h=H.company&&H.company!=="N/A"?H.company:"",I=H.platoon&&H.platoon!=="N/A"?H.platoon:"",T=s.company&&s.company!=="N/A"?s.company:"",k=s.platoon&&s.platoon!=="N/A"?s.platoon:"";return h===T&&I===k}if(V.includes("COMPANY")){const h=H.company&&H.company!=="N/A"?H.company:"",I=s.company&&s.company!=="N/A"?s.company:"";return h===I}return V.includes("COMMANDER")?(H.unitUic||"")===b:!1};return o.filter(H=>H.id!==s.id&&O(H))},[o,s]),d=a.useMemo(()=>{const O=String(s.role||""),H=b=>{const V=s.unitUic||"";if(O.includes("PLATOON")){const h=b.company&&b.company!=="N/A"?b.company:"",I=b.platoon&&b.platoon!=="N/A"?b.platoon:"",T=s.company&&s.company!=="N/A"?s.company:"",k=s.platoon&&s.platoon!=="N/A"?s.platoon:"";return h===T&&I===k}if(O.includes("COMPANY")){const h=b.company&&b.company!=="N/A"?b.company:"",I=s.company&&s.company!=="N/A"?s.company:"";return h===I}return O.includes("COMMANDER")?(b.unitUic||"")===V:!1};return o.filter(b=>b.id!==s.id&&H(b)&&String(b.role||"")===O)},[o,s]),ee=async()=>{try{C(!0),L("");const O=o.find(h=>h.id===u);if(!z||!O){C(!1);return}const H=String(s.role||""),b={...O};if(b.role=H,H.includes("PLATOON")){b.roleCompany=s.company&&s.company!=="N/A"?s.company:"N/A";const h=s.platoon&&s.platoon!=="N/A"?s.platoon:"N/A";b.rolePlatoon=h}else H.includes("COMPANY")?(b.roleCompany=s.company&&s.company!=="N/A"?s.company:"N/A",b.rolePlatoon="N/A"):H.includes("COMMANDER")&&(b.roleCompany="N/A",b.rolePlatoon="N/A");try{if(!(await Qe({id:b.id,email:b.email,rank:b.rank,firstName:b.firstName,lastName:b.lastName,mi:b.mi,service:b.service,role:b.role,unitUic:b.unitUic,unit:b.unit,company:b.company,isUnitAdmin:!!b.isUnitAdmin,isCommandStaff:!!b.isCommandStaff,edipi:b.edipi,passwordHash:b.passwordHash,roleCompany:b.roleCompany,rolePlatoon:b.rolePlatoon})).ok)throw new Error("persist_failed")}catch{L("Failed to persist user changes")}const V={actorId:s.id,actorRole:s.role,targetId:b.id,grantedRole:b.role,timestamp:new Date().toISOString(),scope:{unitUic:s.unitUic||"",company:s.company,unit:s.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(V)})}catch{}v(h=>h.map(I=>I.id===b.id?b:I)),E(""),X(!1),C(!1)}catch{C(!1),L("Operation failed")}},_=async O=>{try{C(!0),L("");const H=o.find(T=>T.id===O);if(!H){C(!1);return}const b=String(s.role||"");if(!d.some(T=>T.id===O)){C(!1),L("Target not in scope");return}const h={...H};h.role="MEMBER",h.company="N/A",h.unit="N/A",h.isCommandStaff=!1,h.roleCompany="N/A",h.rolePlatoon="N/A";try{if(!(await Qe({id:h.id,email:h.email,rank:h.rank,firstName:h.firstName,lastName:h.lastName,mi:h.mi,service:h.service,role:h.role,unitUic:h.unitUic,unit:h.unit,company:h.company,isUnitAdmin:!!h.isUnitAdmin,isCommandStaff:!!h.isCommandStaff,edipi:h.edipi,passwordHash:h.passwordHash,roleCompany:h.roleCompany,rolePlatoon:h.rolePlatoon})).ok)throw new Error("persist_failed")}catch{L("Failed to persist user changes")}const I={actorId:s.id,actorRole:s.role,targetId:h.id,action:"Revoked",previousRole:b,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(I)})}catch{}v(T=>T.map(k=>k.id===h.id?h:k)),G(""),C(!1)}catch{C(!1),L("Operation failed")}};return z?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:n,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:O=>O.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:n,children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:u,onChange:O=>E(O.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),F.map(O=>e.jsxs("option",{value:O.id,children:[O.rank," ",O.lastName,", ",O.firstName,O.mi?` ${O.mi}`:""," â€¢ ",O.email]},O.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[d.map(O=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[O.rank," ",O.lastName,", ",O.firstName,O.mi?` ${O.mi}`:""," â€¢ ",O.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>G(O.id),children:"Remove Access"})]},O.id)),d.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),$&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:$})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!u||R,onClick:()=>X(!0),children:"Grant Equivalent Permission"})}),B&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>X(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:R,onClick:ee,children:"Confirm"})]})]}),S&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>G(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:R,onClick:()=>_(S),children:"Remove"})]})]})]})}):null},zt="ORIGINATOR_REVIEW",Fe=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Us=[{value:"PLATOON_REVIEW",label:"Platoon Review"},{value:"COMPANY_REVIEW",label:"Company Review"},{value:"BATTALION_REVIEW",label:"Battalion Review"},{value:"COMMANDER_REVIEW",label:"Commander Review"},{value:"ARCHIVED",label:"Archived"}],Qs={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},zs=s=>{const n=Fe.indexOf(s||Fe[0]);return n>=0&&n<Fe.length-1?Fe[n+1]:Fe[n]||Fe[0]},Yt=s=>{const n=Fe.indexOf(s||Fe[0]);return n>0?Fe[n-1]:Fe[0]},ht=(s,n)=>{var o;return((o=s.activity)==null?void 0:o.some(v=>n.test(String(v.action||""))))||!1},Ys=s=>ht(s,/(approved by commander|commander.*approved)/i)&&!ht(s,/installation commander/i),Gs=s=>ht(s,/(endorsed by commander|commander.*endorsed)/i)&&!ht(s,/installation commander/i),Et=s=>{if(!s)return"MEMBER";const n=String(s.role||"MEMBER"),o=(s.roleCompany||s.company||"").trim(),v=(s.rolePlatoon||s.platoon||"").trim();switch(n){case"PLATOON_REVIEWER":if(o&&v)return`Platoon (${o}-${v})`;break;case"COMPANY_REVIEWER":if(o)return`Company (${o})`;break;case"BATTALION_REVIEWER":return"Battalion";case"COMMANDER_REVIEWER":return"Commander"}return n};function Js(){const s=hs(),[n,o]=a.useState(()=>{try{const i=localStorage.getItem("currentUser");return i?JSON.parse(i):null}catch(i){return console.error("Failed to parse user from localStorage:",i),null}}),[v,u]=a.useState([]),[E,R]=a.useState([]),[C,$]=a.useState({}),[L,B]=a.useState({}),[X,S]=a.useState({}),[G,z]=a.useState({}),[F,d]=a.useState({}),[ee,_]=a.useState({}),[O,H]=a.useState({}),[b,V]=a.useState(!1),[h,I]=a.useState({}),[T,k]=a.useState({}),[Y,w]=a.useState(!1),[f,U]=a.useState({}),[W,K]=a.useState(null),re=a.useRef(null),[P,ue]=a.useState("Pending"),[fe,ye]=a.useState(Qs),[pe,Ne]=a.useState(null);a.useEffect(()=>{const i=q=>{W&&re.current&&!re.current.contains(q.target)&&(U(te=>({...te,[W]:!1})),K(null))},m=q=>{q.key==="Escape"&&W&&(U(te=>({...te,[W]:!1})),K(null))};return document.addEventListener("mousedown",i),document.addEventListener("keydown",m),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("keydown",m)}},[W]),a.useEffect(()=>{js().then(i=>{u(i.data||[])}).catch(()=>u([]))},[]),a.useEffect(()=>{Ss().then(i=>{R(i.data||[])}).catch(()=>R([]))},[]),a.useEffect(()=>{bt().then(i=>{const m={},q=i.data||[];for(const te of q)te!=null&&te.id&&(m[te.id]=te);B(m)}).catch(()=>B({}))},[]),a.useEffect(()=>{try{const i=localStorage.getItem("unit_structure"),m={},q={};if(i){const te=JSON.parse(i);for(const ce of Object.keys(te||{})){const me=te[ce];me&&Array.isArray(me._sections)&&(m[ce]=me._sections),me&&me._platoonSectionMap&&typeof me._platoonSectionMap=="object"&&(q[ce]=me._platoonSectionMap)}}else(async()=>{try{const te=await ft();for(const ce of Object.keys(te||{})){const me=te[ce];me&&Array.isArray(me._sections)&&(m[ce]=me._sections),me&&me._platoonSectionMap&&typeof me._platoonSectionMap=="object"&&(q[ce]=me._platoonSectionMap)}}catch{}})();_(m),H(q)}catch{}},[]);const he=a.useMemo(()=>{const i=String((n==null?void 0:n.role)||"");return i.includes("PLATOON")?"PLATOON_REVIEW":i.includes("COMPANY")?"COMPANY_REVIEW":i.includes("BATTALION")?"BATTALION_REVIEW":i.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[n]),y=a.useMemo(()=>Object.values(L),[L]),M=i=>{const m=L[i.uploadedById];if(!m)return!1;const q=qe(m.company),te=i.unitUic||m.unitUic||"";return Ze(y,"COMPANY_REVIEWER",{company:q,uic:te})},se=i=>String((n==null?void 0:n.role)||"").includes("PLATOON")?!M(i):!1,oe=i=>L[i.uploadedById]||null,ie=i=>i&&i!=="N/A"?i.trim():"",Ae=i=>{var ke,Ce;const m=oe(i),q=i.unitUic||(m==null?void 0:m.unitUic)||"",te=String((n==null?void 0:n.role)||""),ce=(n==null?void 0:n.unitUic)||"",me=(ie(n==null?void 0:n.roleCompany)||ie(n==null?void 0:n.company)).toUpperCase();if(te.includes("PLATOON")){if(!ce||q!==ce)return!1;const xe=m?ie(m.company).toUpperCase():"",Ie=m?ie(m.platoon).toUpperCase():"",Te=(ie(n==null?void 0:n.rolePlatoon)||ie(n==null?void 0:n.platoon)).toUpperCase();return!me||!Te||!xe||!Ie?!1:xe===me&&Ie===Te}if(te.includes("COMPANY")){if(!ce||q!==ce)return!1;const xe=m?ie(m.company).toUpperCase():"";return!me||!xe?!1:xe===me}if(te.includes("BATTALION")){if(!ce||q!==ce)return!1;const xe=ie(n==null?void 0:n.company),Ie=ie(n==null?void 0:n.platoon),Te=((Ce=(ke=O[ce])==null?void 0:ke[xe])==null?void 0:Ce[Ie])||"";return i.routeSection&&Te?i.routeSection===Te:!0}return te.includes("COMMANDER")?!!ce&&q===ce:!0},je=a.useMemo(()=>(Array.isArray(v)?v:[]).filter(Ae),[v,n,L,O]),ge=a.useMemo(()=>{const i=new Map;for(const m of je){const q=oe(m);if(q&&q.id&&!i.has(q.id)){const te=`${q.rank||""} ${q.lastName||""}, ${q.firstName||""}`.trim();i.set(q.id,{value:q.id,label:te||q.id})}}return Array.from(i.values()).sort((m,q)=>m.label.localeCompare(q.label))},[je,L]),De=Ls(fe,{items:je,getSearchText:i=>`${i.subject||""} ${i.id||""} ${i.routeSection||""}`,getStatus:i=>i.currentStage||"PLATOON_REVIEW",getDate:i=>i.createdAt,getOriginatorId:i=>i.uploadedById}),Se=a.useMemo(()=>De.filter(i=>(i.currentStage||"PLATOON_REVIEW")===he),[De,he]),x=a.useMemo(()=>De.filter(i=>(i.currentStage||"PLATOON_REVIEW")!==he),[De,he]),j=Pt(Se,{pageSize:25}),Z=Pt(x,{pageSize:25}),ne=i=>E.filter(m=>m.requestId===i),le=a.useMemo(()=>[{header:"Request ID",getValue:i=>i.id},{header:"Subject",getValue:i=>i.subject},{header:"Stage",getValue:i=>i.currentStage||""},{header:"Route Section",getValue:i=>i.routeSection||""},{header:"Originator",getValue:i=>{const m=oe(i);return m?`${m.rank||""} ${m.lastName||""}, ${m.firstName||""}${m.mi?` ${m.mi}`:""}`.trim():""}},{header:"Unit UIC",getValue:i=>i.unitUic||""},{header:"Created At",getValue:i=>i.createdAt,format:Ut},{header:"Due Date",getValue:i=>i.dueDate||"",format:Ut},{header:"Documents",getValue:i=>ne(i.id).map(m=>m.name).join(" | ")}],[L,E]),p=async(i,m,q)=>{const te=n?`${n.rank} ${n.lastName}, ${n.firstName}${n.mi?` ${n.mi}`:""}`:"Reviewer",ce=Et(n),me={actor:te,actorRole:ce,timestamp:new Date().toISOString(),action:q,comment:(C[i.id]||"").trim()},ke={...i,currentStage:m,routeSection:m==="BATTALION_REVIEW"&&F[i.id]?F[i.id]:i.routeSection,activity:Array.isArray(i.activity)?[...i.activity,me]:[me]};try{await _e(ke),q.toLowerCase().includes("approved")?s.success("Request approved",{message:`"${i.subject}" advanced to next stage`}):q.toLowerCase().includes("return")?s.warning("Request returned",{message:`"${i.subject}" sent back for revision`}):q.toLowerCase().includes("archive")?s.info("Request archived",{message:`"${i.subject}" has been archived`}):s.success(q,{message:`Request "${i.subject}" updated`}),u(Ce=>Ce.map(xe=>xe.id===ke.id?ke:xe)),$(Ce=>({...Ce,[i.id]:""}))}catch(Ce){s.error("Failed to update request",{message:String(Ce)})}},A=async i=>{const m=G[i.id]||[];if(!m.length||!(n!=null&&n.id))return;const q=Date.now(),te=m.map((xe,Ie)=>({id:`${q}-${Ie}`,name:xe.name,type:xe.type,size:xe.size,uploadedAt:new Date().toISOString(),subject:i.subject,requestId:i.id,fileUrl:URL.createObjectURL(xe)})),ce=n?`${n.rank} ${n.lastName}, ${n.firstName}${n.mi?` ${n.mi}`:""}`:"Reviewer",me=Et(n),ke={actor:ce,actorRole:me,timestamp:new Date().toISOString(),action:`Reviewer added ${te.length} document(s)`,comment:(C[i.id]||"").trim()},Ce={...i,documentIds:[...i.documentIds||[],...te.map(xe=>xe.id)],activity:Array.isArray(i.activity)?[...i.activity,ke]:[ke]};try{await Rt(te),await _e(Ce),s.success(`${te.length} file${te.length!==1?"s":""} added`,{message:`Documents added to "${i.subject}"`})}catch(xe){s.error("Failed to add files",{message:String(xe)})}R(xe=>[...xe,...te]),u(xe=>xe.map(Ie=>Ie.id===Ce.id?Ce:Ie)),z(xe=>({...xe,[i.id]:[]})),$(xe=>({...xe,[i.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Unit Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Et(n)}),e.jsx(Fs,{items:[...Se,...x],columns:le,filename:"review_requests",label:"Export",className:"hidden md:inline-flex"})]})]}),n&&String(n.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>V(!0),children:"Manage Permissions"})})]}),e.jsx(_s,{filters:fe,onFiltersChange:ye,statusOptions:Us,originatorOptions:ge,searchPlaceholder:"Search requests by subject, ID, or section...",className:"mb-4"}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>ue("Pending"),className:`${P==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>ue("In Scope"),className:`${P==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[P==="Pending"&&e.jsx(ze,{title:"Pending",requests:j.currentData,users:L,onRowClick:i=>I(m=>({...m,[i.id]:!m[i.id]})),expandedRows:h,platoonSectionMap:O,children:i=>e.jsxs("div",{id:`details-rev-${i.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!f[i.id],"aria-controls":`docs-rev-${i.id}`,onClick:()=>{U(m=>({...m,[i.id]:!m[i.id]})),K(m=>f[i.id]?null:i.id)},onKeyDown:m=>{(m.key==="Enter"||m.key===" ")&&(m.preventDefault(),U(q=>({...q,[i.id]:!q[i.id]})),K(q=>f[i.id]?null:i.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${f[i.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${i.id}`,ref:f[i.id]?re:void 0,className:`${f[i.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(et,{documents:ne(i.id).map(m=>({...m,fileUrl:m.fileUrl})),showIcons:!0,onPreview:m=>Ne(ne(i.id).find(q=>q.id===m.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>S(m=>({...m,[i.id]:!m[i.id]})),"aria-expanded":!!X[i.id],"aria-controls":`logs-${i.id}`,children:[X[i.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${i.id}`,className:X[i.id]?"mt-2 space-y-2":"hidden",children:i.activity&&i.activity.length?i.activity.map((m,q)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[m.actor,m.actorRole?` â€¢ ${m.actorRole}`:""," â€¢ ",new Date(m.timestamp).toLocaleString()," â€¢ ",m.action]}),m.comment&&e.jsx("div",{className:"text-gray-600",children:m.comment})]},q)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:C[i.id]||"",onChange:m=>$(q=>({...q,[i.id]:m.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:m=>z(q=>({...q,[i.id]:m.target.files?Array.from(m.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(G[i.id]||[]).length?`${(G[i.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>A(i),disabled:!G[i.id]||!(G[i.id]||[]).length,children:"Save Files"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[(String((n==null?void 0:n.role)||"").includes("COMPANY")||se(i))&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:F[i.id]||"",onChange:m=>d(q=>({...q,[i.id]:m.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(ee[(n==null?void 0:n.unitUic)||""]||[]).map(m=>e.jsx("option",{value:m,children:m},m))]}),se(i)&&e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No company reviewer"})]}),(()=>{const m=Ys(i),q=Gs(i),te=String((n==null?void 0:n.role)||"").includes("COMPANY")||se(i);return m||q?e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>p(i,i.currentStage==="PLATOON_REVIEW"?zt:Yt(i.currentStage),"Returned to previous stage"),children:"Return to Previous"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(te){if(!F[i.id])return;p(i,"BATTALION_REVIEW",`Approved and routed to ${F[i.id]}`)}else p(i,zs(i.currentStage),"Approved")},disabled:te&&!F[i.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>p(i,i.currentStage==="PLATOON_REVIEW"?zt:Yt(i.currentStage),i.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),P==="In Scope"&&e.jsx(ze,{title:"In Scope",requests:Z.currentData,users:L,onRowClick:i=>I(m=>({...m,[i.id]:!m[i.id]})),expandedRows:h,platoonSectionMap:O,children:i=>e.jsxs("div",{id:`details-rev-${i.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!f[i.id],"aria-controls":`docs-rev-${i.id}`,onClick:()=>{U(m=>({...m,[i.id]:!m[i.id]})),K(m=>f[i.id]?null:i.id)},onKeyDown:m=>{(m.key==="Enter"||m.key===" ")&&(m.preventDefault(),U(q=>({...q,[i.id]:!q[i.id]})),K(q=>f[i.id]?null:i.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${f[i.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${i.id}`,ref:f[i.id]?re:void 0,className:`${f[i.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(et,{documents:ne(i.id).map(m=>({...m,fileUrl:m.fileUrl})),showIcons:!0,onPreview:m=>Ne(ne(i.id).find(q=>q.id===m.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>S(m=>({...m,[i.id]:!m[i.id]})),"aria-expanded":!!X[i.id],"aria-controls":`logs-${i.id}`,children:[X[i.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${i.id}`,className:X[i.id]?"mt-2 space-y-2":"hidden",children:i.activity&&i.activity.length?i.activity.map((m,q)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[m.actor,m.actorRole?` â€¢ ${m.actorRole}`:""," â€¢ ",new Date(m.timestamp).toLocaleString()," â€¢ ",m.action]}),m.comment&&e.jsx("div",{className:"text-gray-600",children:m.comment})]},q)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),b&&n&&e.jsx(Hs,{currentUser:n,onClose:()=>V(!1)}),pe&&pe.fileUrl&&e.jsx(is,{url:pe.fileUrl,fileName:pe.name,mimeType:pe.type,fileSize:pe.size,isOpen:!!pe,onClose:()=>Ne(null)})]})}function Ks(){var T;const[s,n]=a.useState(null),[o,v]=a.useState([]),[u,E]=a.useState([]),[R,C]=a.useState(""),[$,L]=a.useState(""),[B,X]=a.useState([]),[S,G]=a.useState(null),[z,F]=a.useState("structure"),[d,ee]=a.useState({}),[_,O]=a.useState({}),[H,b]=a.useState({});a.useEffect(()=>{try{const k=localStorage.getItem("currentUser");k&&n(JSON.parse(k))}catch{}Zt().then(k=>{try{v(k.map(Y=>({code:String(Y.code||""),name:String(Y.name||"")})))}catch{v([])}}),es().then(k=>{E(k)}).catch(()=>E([])),nt().then(k=>X(k)).catch(()=>X([])),_t().then(k=>{const Y={};for(const w of k){const f=`${w.division_code}::${w.branch}`;Y[f]={reviewers:w.reviewers||[],approvers:w.approvers||[]}}ee(Y)})},[]);const V=(s==null?void 0:s.hqmcDivision)||((T=o[0])==null?void 0:T.code)||"",h=a.useMemo(()=>o.find(k=>k.code===V),[o,V]),I=a.useMemo(()=>(Array.isArray(u)?u:[]).filter(k=>String(k.division_code||"")===V),[u,V]);return a.useMemo(()=>(Array.isArray(B)?B:[]).filter(k=>!!k.isHqmcAdmin&&String(k.hqmcDivision||"")===V),[B,V]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(s!=null&&s.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(s==null?void 0:s.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",h?`${h.code} â€” ${h.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>F("structure"),className:`${z==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>F("permissions"),className:`${z==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),z==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[I.map(k=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:k.branch}),e.jsx("td",{className:"py-2 px-3",children:k.description||""}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700",onClick:async()=>{if(!confirm(`Delete branch "${k.branch}"?`))return;const Y=await ws(V,k.branch);Y.ok?(E(w=>w.filter(f=>!(f.division_code===V&&f.branch===k.branch))),G({type:"success",message:`Deleted branch "${k.branch}"`})):G({type:"error",message:`Failed to delete: ${Y.error}`})},children:"Delete"})})]},k.branch)),I.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(s==null?void 0:s.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:R,onChange:k=>C(k.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:$,onChange:k=>L(k.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!R.trim(),onClick:async()=>{var k;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:V,division_name:((k=o.find(w=>w.code===V))==null?void 0:k.name)||"",branch:R.trim(),description:$.trim()})});const Y=await fetch("/api/hqmc-structure").then(w=>w.json());E(Y),C(""),L("")}catch{}},children:"Add"})]})]})]}),z==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const k of I){const Y=`${V}::${k.branch}`,w=d[Y]||{reviewers:[],approvers:[]};await ts({division_code:V,branch:k.branch,reviewers:w.reviewers,approvers:w.approvers})}G({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:I.map(k=>{const Y=`${V}::${k.branch}`,w=d[Y]||{reviewers:[],approvers:[]},f=U=>`${U.rank||""} ${U.lastName||""}, ${U.firstName||""}${U.mi?" "+U.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:k.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:_[Y]||"",onChange:U=>O(W=>({...W,[Y]:U.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!_[Y],onClick:async()=>{const U=(_[Y]||"").trim();if(!U)return;const{user:W,error:K}=await It(U);if(K){G({type:"error",message:`Database error: ${K}`});return}if(!(W!=null&&W.id)){G({type:"error",message:`No user found for EDIPI ${U}`});return}ee(re=>({...re,[Y]:{...w,reviewers:Array.from(new Set([...w.reviewers||[],W.id]))}})),O(re=>({...re,[Y]:""})),G({type:"success",message:`Added reviewer ${W.lastName||""}, ${W.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(w.reviewers||[]).map(U=>{const W=B.find(K=>K.id===U);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:W?f(W):U}),e.jsx("button",{className:"text-red-600",onClick:()=>ee(K=>({...K,[Y]:{...w,reviewers:(w.reviewers||[]).filter(re=>re!==U)}})),children:"âœ•"})]},U)}),(w.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:H[Y]||"",onChange:U=>b(W=>({...W,[Y]:U.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!H[Y],onClick:async()=>{const U=(H[Y]||"").trim();if(!U)return;const{user:W,error:K}=await It(U);if(K){G({type:"error",message:`Database error: ${K}`});return}if(!(W!=null&&W.id)){G({type:"error",message:`No user found for EDIPI ${U}`});return}ee(re=>({...re,[Y]:{...w,approvers:Array.from(new Set([...w.approvers||[],W.id]))}})),b(re=>({...re,[Y]:""})),G({type:"success",message:`Added approver ${W.lastName||""}, ${W.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(w.approvers||[]).map(U=>{const W=B.find(K=>K.id===U);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:W?f(W):U}),e.jsx("button",{className:"text-red-600",onClick:()=>ee(K=>({...K,[Y]:{...w,approvers:(w.approvers||[]).filter(re=>re!==U)}})),children:"âœ•"})]},U)}),(w.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},Y)})})]})})]}),S&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${S.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:S.message})]})}const lt=(s,n)=>`${s}::${n}`;function Xs({currentUser:s,divisionCode:n,branches:o,assignments:v,onClose:u}){const[E,R]=a.useState([]),[C,$]=a.useState(""),[L,B]=a.useState(""),[X,S]=a.useState("reviewer"),[G,z]=a.useState(!1);a.useEffect(()=>{bt().then(h=>R(h)).catch(()=>R([]))},[]);const F=a.useMemo(()=>{const h={};for(const I of v)h[lt(I.division_code,I.branch)]={reviewers:I.reviewers||[],approvers:I.approvers||[]};return h},[v]),d=String(s.id||""),ee=a.useMemo(()=>{if(!C)return!1;const h=F[lt(n,C)]||{reviewers:[],approvers:[]};return(h.reviewers||[]).includes(d)||(h.approvers||[]).includes(d)||!!s.isHqmcAdmin},[C,F,d,s]),_=a.useMemo(()=>E.filter(h=>String(h.hqmcDivision||"")===String(n||"")&&String(h.id||"")!==d),[E,n,d]),O=a.useMemo(()=>{if(!C)return[];const h=F[lt(n,C)]||{reviewers:[],approvers:[]};return Array.from(new Set([...h.reviewers||[],...h.approvers||[]])).map(T=>_.find(k=>k.id===T)).filter(Boolean)},[C,F,_,n]),H=async h=>{z(!0);try{await ts({division_code:n,branch:C,reviewers:h.reviewers,approvers:h.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:s.id,scope:{hqmcDivision:n,branch:C},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{z(!1)}},b=async()=>{if(!ee||!C||!L)return;const h=F[lt(n,C)]||{reviewers:[],approvers:[]},I={reviewers:Array.from(new Set(h.reviewers||[])),approvers:Array.from(new Set(h.approvers||[]))};X==="reviewer"?I.reviewers=Array.from(new Set([...I.reviewers,L])):I.approvers=Array.from(new Set([...I.approvers,L])),await H(I),B("")},V=async h=>{if(!ee||!C)return;const I=F[lt(n,C)]||{reviewers:[],approvers:[]},T={reviewers:(I.reviewers||[]).filter(k=>k!==h),approvers:(I.approvers||[]).filter(k=>k!==h)};await H(T)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:u,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:h=>h.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:u,children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:C,onChange:h=>$(h.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),o.map(h=>e.jsx("option",{value:h,children:h},h))]})]}),C&&!ee&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),C&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:L,onChange:h=>B(h.target.value),disabled:!ee,children:[e.jsx("option",{value:"",children:"Choose user"}),_.map(h=>e.jsxs("option",{value:h.id,children:[h.rank," ",h.lastName,", ",h.firstName,h.mi?` ${h.mi}`:""," â€¢ ",h.email]},h.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:X,onChange:h=>S(h.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!ee||!L||G,onClick:b,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[O.map(h=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[h.rank," ",h.lastName,", ",h.firstName,h.mi?` ${h.mi}`:""," â€¢ ",h.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!ee||G,onClick:()=>V(h.id),children:"Remove"})]},h.id)),O.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}function Zs(){const[s,n]=a.useState(()=>{try{const x=localStorage.getItem("currentUser");return x?JSON.parse(x):null}catch{return null}}),[o,v]=a.useState([]),[u,E]=a.useState([]),[R,C]=a.useState({}),[$,L]=a.useState({}),[B,X]=a.useState({}),[S,G]=a.useState({}),[z,F]=a.useState({}),[d,ee]=a.useState(null),_=a.useRef(null),[O,H]=a.useState([]),[b,V]=a.useState("Pending"),[h,I]=a.useState([]),[T,k]=a.useState({}),[Y,w]=a.useState(!1);a.useEffect(()=>{const x=Z=>{d&&_.current&&!_.current.contains(Z.target)&&(G(ne=>({...ne,[d]:!1})),ee(null))},j=Z=>{Z.key==="Escape"&&d&&(G(ne=>({...ne,[d]:!1})),ee(null))};return document.addEventListener("mousedown",x),document.addEventListener("keydown",j),()=>{document.removeEventListener("mousedown",x),document.removeEventListener("keydown",j)}},[d]),a.useEffect(()=>{gt().then(x=>v(x)).catch(()=>v([]))},[]),a.useEffect(()=>{Ot().then(x=>E(x)).catch(()=>E([]))},[]),a.useEffect(()=>{nt().then(x=>{const j={};for(const Z of x)Z!=null&&Z.id&&(j[Z.id]=Z);L(j)}).catch(()=>L({}))},[]),a.useEffect(()=>{_t().then(H).catch(()=>H([]))},[]),a.useEffect(()=>{es().then(I).catch(()=>I([]))},[]);const f=(s==null?void 0:s.id)||"",U=String((s==null?void 0:s.hqmcDivision)||""),W=a.useMemo(()=>O.filter(x=>x.division_code===U&&((x.reviewers||[]).includes(f)||(x.approvers||[]).includes(f))).map(x=>x.branch),[O,U,f]),K=x=>$[x.uploadedById]||null,re=x=>{if(!U||!f)return!1;const j=String(x.routeSection||"");return W.includes(j)},P=x=>(x.activity||[]).some(j=>/HQMC Approver Approved/i.test(String(j.action||""))),ue=a.useMemo(()=>(Array.isArray(o)?o:[]).filter(re),[o,W]),fe=a.useMemo(()=>ue.filter(x=>(x.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&!P(x)),[ue]),ye=a.useMemo(()=>ue.filter(x=>(x.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&P(x)),[ue]),pe=a.useMemo(()=>ue.filter(x=>(x.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[ue]),Ne=x=>u.filter(j=>j.requestId===x),he=x=>`"${String(x??"").replace(/"/g,'""')}"`,y=x=>{const Z=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const ne of x){const le=K(ne),p=le?`${le.rank} ${le.lastName}, ${le.firstName}${le.mi?` ${le.mi}`:""}`:"",A=Ne(ne.id).map(i=>i.name).join(" | ");Z.push([ne.id,ne.subject,ne.currentStage||"",ne.routeSection||"",p,ne.unitUic||"",new Date(ne.createdAt).toLocaleString(),A])}return Z.map(ne=>ne.map(he).join(",")).join(`\r
`)},M=(x,j)=>{const Z=new Blob([j],{type:"text/csv;charset=utf-8;"}),ne=URL.createObjectURL(Z),le=document.createElement("a");le.href=ne,le.download=x,document.body.appendChild(le),le.click(),document.body.removeChild(le),URL.revokeObjectURL(ne)},se=()=>M("hqmc_pending.csv",y(fe)),oe=()=>M("hqmc_approved.csv",y(ye)),ie=()=>M("hqmc_archived.csv",y(pe)),Ae=()=>M("hqmc_all.csv",y([...fe,...ye,...pe])),je=async x=>{const j=s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Reviewer",Z=String(T[x.id]||"").trim();if(!Z){alert("Select an HQMC section to route to approver");return}const ne={actor:j,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${Z}`,comment:(R[x.id]||"").trim()},le={...x,routeSection:Z,activity:Array.isArray(x.activity)?[...x.activity,ne]:[ne]};try{await _e(le)}catch{}v(p=>p.map(A=>A.id===le.id?le:A)),C(p=>({...p,[x.id]:""}))},ge=async x=>{const Z={actor:s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC to Installation",comment:(R[x.id]||"").trim()},ne={...x,currentStage:"INSTALLATION_REVIEW",activity:Array.isArray(x.activity)?[...x.activity,Z]:[Z]};try{await _e(ne)}catch{}v(le=>le.map(p=>p.id===ne.id?ne:p)),C(le=>({...le,[x.id]:""}))},De=async x=>{const Z={actor:s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Section",timestamp:new Date().toISOString(),action:"Archived by HQMC Section",comment:(R[x.id]||"").trim()},ne={...x,currentStage:"ARCHIVED",activity:Array.isArray(x.activity)?[...x.activity,Z]:[Z]};try{await _e(ne)}catch{}v(le=>le.map(p=>p.id===ne.id?ne:p)),C(le=>({...le,[x.id]:""}))},Se=async x=>{const j=s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Section",Z=String(T[x.id]||"").trim();if(!Z){alert("Select an HQMC section to reassign to");return}const ne={actor:j,timestamp:new Date().toISOString(),action:`Reassigned to HQMC section: ${Z}`,comment:(R[x.id]||"").trim()},le={...x,routeSection:Z,activity:Array.isArray(x.activity)?[...x.activity,ne]:[ne]};try{await _e(le)}catch{}v(p=>p.map(A=>A.id===le.id?le:A)),C(p=>({...p,[x.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:U||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ae,children:"Export All"}),W.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>w(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>V("Pending"),className:`${b==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>V("Approved"),className:`${b==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"}),e.jsx("button",{onClick:()=>V("Archived"),className:`${b==="Archived"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Archived"})]})}),e.jsxs("div",{className:"mt-4",children:[b==="Pending"&&e.jsx(ze,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:se,children:"Export Pending"}),requests:fe,users:$,onRowClick:x=>X(j=>({...j,[x.id]:!j[x.id]})),expandedRows:B,children:x=>e.jsxs("div",{id:`details-hq-${x.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!S[x.id],"aria-controls":`docs-hq-${x.id}`,onClick:()=>{G(j=>({...j,[x.id]:!j[x.id]})),ee(j=>S[x.id]?null:x.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${S[x.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${x.id}`,ref:S[x.id]?_:void 0,className:`${S[x.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(et,{documents:Ne(x.id).map(j=>({...j,fileUrl:j.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[x.id],"aria-controls":`logs-hq-${x.id}`,onClick:()=>F(j=>({...j,[x.id]:!j[x.id]})),children:[z[x.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hq-${x.id}`,className:z[x.id]?"mt-2 space-y-2":"hidden",children:x.activity&&x.activity.length?x.activity.map((j,Z)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[j.actor," â€¢ ",new Date(j.timestamp).toLocaleString()," â€¢ ",j.action]}),j.comment&&e.jsx("div",{className:"text-gray-600",children:j.comment})]},Z)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:R[x.id]||"",onChange:j=>C(Z=>({...Z,[x.id]:j.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:T[x.id]||"",onChange:j=>k(Z=>({...Z,[x.id]:j.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),h.filter(j=>String(j.division_code||"")===U).map(j=>e.jsx("option",{value:j.branch,children:j.branch},j.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>je(x),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>ge(x),children:"Return"})]})]})]})}),b==="Approved"&&e.jsx(ze,{title:"Approved by HQMC Approver",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:oe,children:"Export Approved"}),requests:ye,users:$,onRowClick:x=>X(j=>({...j,[x.id]:!j[x.id]})),expandedRows:B,children:x=>e.jsxs("div",{id:`details-hqa-${x.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!S[x.id],"aria-controls":`docs-hqa-${x.id}`,onClick:()=>{G(j=>({...j,[x.id]:!j[x.id]})),ee(j=>S[x.id]?null:x.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${S[x.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${x.id}`,ref:S[x.id]?_:void 0,className:`${S[x.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(et,{documents:Ne(x.id).map(j=>({...j,fileUrl:j.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[x.id],"aria-controls":`logs-hqa-${x.id}`,onClick:()=>F(j=>({...j,[x.id]:!j[x.id]})),children:[z[x.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqa-${x.id}`,className:z[x.id]?"mt-2 space-y-2":"hidden",children:x.activity&&x.activity.length?x.activity.map((j,Z)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[j.actor," â€¢ ",new Date(j.timestamp).toLocaleString()," â€¢ ",j.action]}),j.comment&&e.jsx("div",{className:"text-gray-600",children:j.comment})]},Z)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:R[x.id]||"",onChange:j=>C(Z=>({...Z,[x.id]:j.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Reassign to Section"}),e.jsxs("select",{value:T[x.id]||"",onChange:j=>k(Z=>({...Z,[x.id]:j.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),h.filter(j=>String(j.division_code||"")===U).map(j=>e.jsx("option",{value:j.branch,children:j.branch},j.branch))]}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Se(x),children:"Reassign"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700",onClick:()=>De(x),children:"Archive"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>ge(x),children:"Return to Installation"})]})]})]})}),b==="Archived"&&e.jsx(ze,{title:"Archived",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ie,children:"Export Archived"}),requests:pe,users:$,onRowClick:x=>X(j=>({...j,[x.id]:!j[x.id]})),expandedRows:B,children:x=>e.jsxs("div",{id:`details-hqarc-${x.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!S[x.id],"aria-controls":`docs-hqarc-${x.id}`,onClick:()=>{G(j=>({...j,[x.id]:!j[x.id]})),ee(j=>S[x.id]?null:x.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${S[x.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqarc-${x.id}`,ref:S[x.id]?_:void 0,className:`${S[x.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(et,{documents:Ne(x.id).map(j=>({...j,fileUrl:j.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[x.id],"aria-controls":`logs-hqarc-${x.id}`,onClick:()=>F(j=>({...j,[x.id]:!j[x.id]})),children:[z[x.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqarc-${x.id}`,className:z[x.id]?"mt-2 space-y-2":"hidden",children:x.activity&&x.activity.length?x.activity.map((j,Z)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[j.actor," â€¢ ",new Date(j.timestamp).toLocaleString()," â€¢ ",j.action]}),j.comment&&e.jsx("div",{className:"text-gray-600",children:j.comment})]},Z)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),Y&&s&&e.jsx(Xs,{currentUser:s,divisionCode:U,branches:h.filter(x=>String(x.division_code||"")===U).map(x=>x.branch),assignments:O,onClose:()=>w(!1)})]})}function ea(){const[s,n]=a.useState(()=>{try{const y=localStorage.getItem("currentUser");return y?JSON.parse(y):null}catch{return null}}),[o,v]=a.useState([]),[u,E]=a.useState([]),[R,C]=a.useState({}),[$,L]=a.useState({}),[B,X]=a.useState({}),[S,G]=a.useState({}),[z,F]=a.useState({}),[d,ee]=a.useState(null),_=a.useRef(null),[O,H]=a.useState([]),[b,V]=a.useState("Pending");a.useEffect(()=>{const y=se=>{d&&_.current&&!_.current.contains(se.target)&&(G(oe=>({...oe,[d]:!1})),ee(null))},M=se=>{se.key==="Escape"&&d&&(G(oe=>({...oe,[d]:!1})),ee(null))};return document.addEventListener("mousedown",y),document.addEventListener("keydown",M),()=>{document.removeEventListener("mousedown",y),document.removeEventListener("keydown",M)}},[d]),a.useEffect(()=>{gt().then(y=>v(y)).catch(()=>v([]))},[]),a.useEffect(()=>{Ot().then(y=>E(y)).catch(()=>E([]))},[]),a.useEffect(()=>{nt().then(y=>{const M={};for(const se of y)se!=null&&se.id&&(M[se.id]=se);L(M)}).catch(()=>L({}))},[]),a.useEffect(()=>{_t().then(H).catch(()=>H([]))},[]);const h=(s==null?void 0:s.id)||"",I=String((s==null?void 0:s.hqmcDivision)||""),T=a.useMemo(()=>O.filter(y=>y.division_code===I&&(y.approvers||[]).includes(h)).map(y=>y.branch),[O,I,h]),k=y=>$[y.uploadedById]||null,Y=y=>{if(!I||!h)return!1;const M=String(y.routeSection||"");return T.includes(M)},w=y=>(y.activity||[]).some(M=>/HQMC Approver Approved/i.test(String(M.action||""))),f=a.useMemo(()=>(Array.isArray(o)?o:[]).filter(Y),[o,T]),U=a.useMemo(()=>f.filter(y=>(y.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&!w(y)),[f]),W=a.useMemo(()=>f.filter(y=>w(y)),[f]),K=y=>u.filter(M=>M.requestId===y),re=y=>`"${String(y??"").replace(/"/g,'""')}"`,P=y=>{const se=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const oe of y){const ie=k(oe),Ae=ie?`${ie.rank} ${ie.lastName}, ${ie.firstName}${ie.mi?` ${ie.mi}`:""}`:"",je=K(oe.id).map(ge=>ge.name).join(" | ");se.push([oe.id,oe.subject,oe.currentStage||"",oe.routeSection||"",Ae,oe.unitUic||"",new Date(oe.createdAt).toLocaleString(),je])}return se.map(oe=>oe.map(re).join(",")).join(`\r
`)},ue=(y,M)=>{const se=new Blob([M],{type:"text/csv;charset=utf-8;"}),oe=URL.createObjectURL(se),ie=document.createElement("a");ie.href=oe,ie.download=y,document.body.appendChild(ie),ie.click(),document.body.removeChild(ie),URL.revokeObjectURL(oe)},fe=()=>ue("hqmc_approver_pending.csv",P(U)),ye=()=>ue("hqmc_approver_approved.csv",P(W)),pe=()=>ue("hqmc_approver_all.csv",P([...U,...W])),Ne=async y=>{const se={actor:s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved - Pending HQMC Section Action",comment:(R[y.id]||"").trim()},oe={...y,currentStage:"HQMC_REVIEW",activity:Array.isArray(y.activity)?[...y.activity,se]:[se]};try{await _e(oe)}catch{}v(ie=>ie.map(Ae=>Ae.id===oe.id?oe:Ae)),C(ie=>({...ie,[y.id]:""}))},he=async y=>{const se={actor:s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver to Installation",comment:(R[y.id]||"").trim()},oe={...y,currentStage:"INSTALLATION_REVIEW",activity:Array.isArray(y.activity)?[...y.activity,se]:[se]};try{await _e(oe)}catch{}v(ie=>ie.map(Ae=>Ae.id===oe.id?oe:Ae)),C(ie=>({...ie,[y.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((s==null?void 0:s.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:pe,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>V("Pending"),className:`${b==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>V("Approved"),className:`${b==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"})]})}),e.jsxs("div",{className:"mt-4",children:[b==="Pending"&&e.jsx(ze,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:fe,children:"Export Pending"}),requests:U,users:$,onRowClick:y=>X(M=>({...M,[y.id]:!M[y.id]})),expandedRows:B,children:y=>e.jsxs("div",{id:`details-hqa-${y.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!S[y.id],"aria-controls":`docs-hqa-${y.id}`,onClick:()=>{G(M=>({...M,[y.id]:!M[y.id]})),ee(M=>S[y.id]?null:y.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${S[y.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${y.id}`,ref:S[y.id]?_:void 0,className:`${S[y.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(et,{documents:K(y.id).map(M=>({...M,fileUrl:M.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[y.id],"aria-controls":`logs-hqa-${y.id}`,onClick:()=>F(M=>({...M,[y.id]:!M[y.id]})),children:[z[y.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqa-${y.id}`,className:z[y.id]?"mt-2 space-y-2":"hidden",children:y.activity&&y.activity.length?y.activity.map((M,se)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[M.actor," â€¢ ",new Date(M.timestamp).toLocaleString()," â€¢ ",M.action]}),M.comment&&e.jsx("div",{className:"text-gray-600",children:M.comment})]},se)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:R[y.id]||"",onChange:M=>C(se=>({...se,[y.id]:M.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Ne(y),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>he(y),children:"Return"})]})]})}),b==="Approved"&&e.jsx(ze,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ye,children:"Export Approved"}),requests:W,users:$,onRowClick:y=>X(M=>({...M,[y.id]:!M[y.id]})),expandedRows:B,children:y=>e.jsxs("div",{id:`details-hqa-${y.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!S[y.id],"aria-controls":`docs-hqa-${y.id}`,onClick:()=>{G(M=>({...M,[y.id]:!M[y.id]})),ee(M=>S[y.id]?null:y.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${S[y.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${y.id}`,ref:S[y.id]?_:void 0,className:`${S[y.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(et,{documents:K(y.id).map(M=>({...M,fileUrl:M.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[y.id],"aria-controls":`logs-hqaa-${y.id}`,onClick:()=>F(M=>({...M,[y.id]:!M[y.id]})),children:[z[y.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqaa-${y.id}`,className:z[y.id]?"mt-2 space-y-2":"hidden",children:y.activity&&y.activity.length?y.activity.map((M,se)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[M.actor," â€¢ ",new Date(M.timestamp).toLocaleString()," â€¢ ",M.action]}),M.comment&&e.jsx("div",{className:"text-gray-600",children:M.comment})]},se)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]})})}const ta=({onUnitSelect:s,selectedUnit:n})=>{const[o,v]=a.useState(""),[u,E]=a.useState(!1),R=Be.filter($=>$.unitName.toLowerCase().startsWith(o.toLowerCase())||$.uic.toLowerCase().startsWith(o.toLowerCase())||$.ruc.toLowerCase().startsWith(o.toLowerCase())),C=$=>{s($),E(!1),v("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>E(!u),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[n?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:n.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",n.uic," | RUC: ",n.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),u&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:o,onChange:$=>v($.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:R.map($=>e.jsxs("button",{type:"button",onClick:()=>C($),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:$.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",$.uic," | RUC: ",$.ruc," | MCC: ",$.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[$.streetAddress,", ",$.cityState," ",$.zip]})]},$.uic))})]})]})]})},$t=async s=>{const o=new TextEncoder().encode(s),v=await crypto.subtle.digest("SHA-256",o);return Array.from(new Uint8Array(v)).map(u=>u.toString(16).padStart(2,"0")).join("")};async function sa(s,n){const o=Cs();return o!=null&&o.auth?await o.auth.signUp({email:s,password:n}):{data:null,error:new Error("supabase_not_initialized")}}const Gt={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},aa=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],cs=({onSaved:s,initial:n={},mode:o="create",readOnly:v=!1,canEditRole:u=!1,canEditAdmin:E=!1})=>{const[R,C]=a.useState(""),[$,L]=a.useState(""),[B,X]=a.useState(""),[S,G]=a.useState(n.email||""),[z,F]=a.useState(n.edipi||""),[d,ee]=a.useState(n.service||""),[_,O]=a.useState(n.rank||""),[H,b]=a.useState(n.role||"MEMBER"),[V,h]=a.useState(!!n.isUnitAdmin),[I,T]=a.useState(n.company||""),[k,Y]=a.useState(n.platoon||""),[w,f]=a.useState(void 0),[U,W]=a.useState(null),[K,re]=a.useState({}),[P,ue]=a.useState(""),[fe,ye]=a.useState(""),[pe,Ne]=a.useState([]),[he,y]=a.useState(!1),[M,se]=a.useState(n.roleCompany||""),[oe,ie]=a.useState(n.rolePlatoon||""),[Ae,je]=a.useState(!1),[ge,De]=a.useState([]),[Se,x]=a.useState([]),[j,Z]=a.useState([]),[ne,le]=a.useState([]);a.useEffect(()=>{if(n.firstName&&C(String(n.firstName)),n.lastName&&L(String(n.lastName)),n.mi&&X(String(n.mi)),n.company&&T(String(n.company)),n.platoon&&Y(String(n.platoon)),n.roleCompany&&se(String(n.roleCompany)),n.rolePlatoon&&ie(String(n.rolePlatoon)),n.unitUic){const g=Be.find(ae=>ae.uic===n.unitUic);g&&f(g)}},[n]);const p=a.useMemo(()=>Gt[d]||[],[d]),A=a.useMemo(()=>{if(!w)return[];const g=ge;if(g&&g.length)return g;const ae=K[w.uic]||{};return Object.keys(ae).filter(be=>!be.startsWith("_")&&Array.isArray(ae[be]))},[w,K,ge]),i=a.useMemo(()=>{var g;return w&&I?((g=K[w.uic])==null?void 0:g[I])||[]:[]},[w,I,K]),m=a.useMemo(()=>{if(!w||!I)return[];const g=Se;return g&&g.length?g:i},[w,I,Se,i]),q=a.useMemo(()=>{if(!w)return[];const g=j;if(g&&g.length)return g;const ae=K[w.uic]||{};return Object.keys(ae).filter(be=>!be.startsWith("_")&&Array.isArray(ae[be]))},[w,K,j]),te=a.useMemo(()=>{var g;return w&&M?((g=K[w.uic])==null?void 0:g[M])||[]:[]},[w,M,K]),ce=a.useMemo(()=>{if(!w||!M)return[];const g=ne;return g&&g.length?g:te},[w,M,ne,te]),me=a.useMemo(()=>{const g=A.slice(),ae=I||n.company||n.user_company||"";return ae&&!g.includes(ae)?[ae,...g]:g},[A,I,n]),ke=a.useMemo(()=>{const g=m.slice(),ae=k||n.platoon||n.user_platoon||"";return ae&&!g.includes(ae)?[ae,...g]:g},[m,k,n]),Ce=a.useMemo(()=>{const g=q.slice(),ae=M||n.roleCompany||"",be=ae&&!g.includes(ae)?[ae,...g]:g;return Array.from(new Set(be))},[q,M,n]),xe=a.useMemo(()=>{const g=ce.slice(),ae=oe||n.rolePlatoon||"";return ae&&!g.includes(ae)?[ae,...g]:g},[ce,oe,n]);a.useEffect(()=>{(async()=>{try{if(o==="edit"&&n.id){const g=await ss(String(n.id));g&&(g.company&&!I&&T(String(g.company)),g.platoon&&!k&&Y(String(g.platoon)),g.roleCompany&&!M&&se(String(g.roleCompany)),g.rolePlatoon&&!oe&&ie(String(g.rolePlatoon)))}}catch{}})()},[o,n.id]),a.useEffect(()=>{p.includes(_)||O("")},[p]),a.useEffect(()=>{Y("")},[I]),a.useEffect(()=>{ie("")},[M]),a.useEffect(()=>{try{const g=localStorage.getItem("unit_structure");g&&re(JSON.parse(g))}catch{}},[w]),a.useEffect(()=>{const g=(w==null?void 0:w.uic)||"";if(!g){De([]),Z([]);return}as(g).then(ae=>{De(ae||[]),Z(ae||[])}).catch(()=>{De([]),Z([])})},[w]),a.useEffect(()=>{const g=(w==null?void 0:w.uic)||"",ae=I||"";if(!g||!ae){x([]);return}Mt(g,ae).then(be=>x(be||[])).catch(()=>x([]))},[w,I]),a.useEffect(()=>{const g=(w==null?void 0:w.uic)||"",ae=M||"";if(!g||!ae){le([]);return}Mt(g,ae).then(be=>le(be||[])).catch(()=>le([]))},[w,M]),a.useEffect(()=>{nt().then(g=>{Ne(g)}).catch(()=>Ne([]))},[]),a.useEffect(()=>{const g=(w==null?void 0:w.uic)||"";if(!g){y(!1);return}const ae=pe.some(be=>!!be.isUnitAdmin&&(be.unitUic||"")===g);y(ae)},[w,pe]),a.useEffect(()=>{if(w){!I&&n.company&&me.includes(n.company)&&T(String(n.company));const g=n.platoon;!k&&g&&ke.includes(g)&&Y(String(g))}},[w,me,ke,I,k,n]);const Ie=g=>/^[0-9]{10}$/.test(g),Te=(g,ae)=>{try{return pe.some(be=>String(be.edipi)===String(g)&&String(be.id)!==String(ae||""))}catch{return!1}},Ye=async g=>{var Ge,Je;if(g.preventDefault(),W(null),v)return;if(!R.trim())return W({type:"error",message:"First name is required."});if(!$.trim())return W({type:"error",message:"Last name is required."});if(B&&!/^[A-Za-z]$/.test(B))return W({type:"error",message:"MI must be a single letter."});if(!S.trim())return W({type:"error",message:"Email is required."});if(!Ie(String(z)))return W({type:"error",message:"EDIPI must be 10 digits."});if(!d)return W({type:"error",message:"Service is required."});if(!_)return W({type:"error",message:"Rank is required."});if(Te(String(z),n.id?String(n.id):void 0))return W({type:"error",message:"EDIPI already exists."});if(H==="COMPANY_REVIEWER"&&!M)return W({type:"error",message:"Role Company is required for Company Reviewer."});if(H==="PLATOON_REVIEWER"&&(!M||!oe))return W({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${R.trim()}`,B&&""+B.trim().toUpperCase(),`${$.trim()}`;let ae=n.id?String(n.id):`usr-${Date.now()}`,be=n.passwordHash||"";if(o==="create"){if(!P||P.length<8)return W({type:"error",message:"Password must be at least 8 characters."});if(P!==fe)return W({type:"error",message:"Passwords do not match."});try{const{data:ve,error:Ve}=await sa(S.trim(),P);if(Ve){W({type:"error",message:`Failed to create auth user: ${String(Ve.message||Ve)}`});return}const Ke=(Ge=ve==null?void 0:ve.user)!=null&&Ge.id?String(ve.user.id):"";if(!Ke){W({type:"error",message:"Auth user ID missing after sign up."});return}ae=Ke}catch(ve){W({type:"error",message:`Failed to create auth user: ${String((ve==null?void 0:ve.message)||ve)}`});return}be=await $t(P)}else if(o==="edit"&&P){if(P.length<8)return W({type:"error",message:"Password must be at least 8 characters."});if(P!==fe)return W({type:"error",message:"Passwords do not match."});be=await $t(P)}const Me={id:ae,firstName:R.trim(),lastName:$.trim(),mi:B?B.trim().toUpperCase():void 0,email:S.trim(),edipi:z,service:d,rank:_,role:H,company:I||"N/A",unit:(w==null?void 0:w.unitName)||"N/A",unitUic:w==null?void 0:w.uic,passwordHash:be,isUnitAdmin:o==="create"&&w&&!he?!0:V,roleCompany:M||void 0,rolePlatoon:oe||void 0,platoon:k||"N/A"};try{const ve=await Qe({id:Me.id,email:Me.email,rank:Me.rank,firstName:Me.firstName,lastName:Me.lastName,mi:Me.mi,service:Me.service,role:Me.role,unitUic:Me.unitUic,unit:(w==null?void 0:w.unitName)||"N/A",company:Me.company,isUnitAdmin:!!Me.isUnitAdmin,edipi:String(Me.edipi),passwordHash:be,platoon:k||"N/A",roleCompany:M||void 0,rolePlatoon:oe||void 0});if(!ve.ok){W({type:"error",message:`Failed to save profile: ${String(((Je=ve==null?void 0:ve.error)==null?void 0:Je.message)||(ve==null?void 0:ve.error)||"unknown")}`});return}W({type:"success",message:n.id?"Profile updated.":w&&!he?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),s==null||s(Me)}catch{W({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:o==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:Ye,className:"space-y-6",children:[o==="create"&&w&&!he&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:w.unitName})," (UIC ",w.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:$,onChange:g=>L(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:R,onChange:g=>C(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:B,maxLength:1,onChange:g=>X(g.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:S,onChange:g=>G(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:z,onChange:g=>F(g.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:d,onChange:g=>ee(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(Gt).map(g=>e.jsx("option",{value:g,children:g},g))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:_,onChange:g=>O(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),p.map(g=>e.jsx("option",{value:g,children:g},g))]})]}),o==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:P,onChange:g=>ue(g.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:fe,onChange:g=>ye(g.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v})]})]}):e.jsx(e.Fragment,{})]})]}),Ae&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:P,onChange:g=>ue(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:fe,onChange:g=>ye(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>je(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>je(!1),children:"Save"})]})]})}),o==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:H,onChange:g=>b(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:aa.map(g=>e.jsx("option",{value:g,children:g},g))})}),e.jsx("div",{children:e.jsxs("select",{value:M||String(n.roleCompany||""),onChange:g=>se(g.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Ce.length?"Select company":"No companies configured"}),Ce.map(g=>e.jsx("option",{value:g,children:g},g))]})}),e.jsx("div",{children:e.jsxs("select",{value:oe||String(n.rolePlatoon||""),onChange:g=>ie(g.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:xe.length?"Select platoon":"No platoons configured"}),xe.map(g=>e.jsx("option",{value:g,children:g},g))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:V,onChange:g=>h(g.target.checked),disabled:v||!E}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(n==null?void 0:n.isCommandStaff)||H==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(ta,{onUnitSelect:g=>f(g),selectedUnit:w})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:I||String(n.company||""),onChange:g=>T(g.target.value),disabled:v||!w||me.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:me.length?"Select company":"No companies configured"}),me.map(g=>e.jsx("option",{value:g,children:g},g))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:k||String(n.platoon||""),onChange:g=>Y(g.target.value),disabled:v||!w||!I||ke.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:ke.length?"Select platoon":"No platoons configured"}),ke.map(g=>e.jsx("option",{value:g,children:g},g))]})]})]})})]}),U&&e.jsx("div",{className:`p-3 rounded-lg border ${U.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:U.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[o==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>je(!0),disabled:v,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:v,children:o==="edit"?"Save":"Create Profile"})]})]})]})},na=a.memo(function({user:n,onClose:o}){const v=()=>{const u=Be.find(R=>R.uic===n.unitUic),E=u?u.unitName:n.unit;if(n.isUnitAdmin||n.role==="COMMANDER")return E||"â€”";if(n.role==="COMPANY_REVIEWER")return n.company&&n.company!=="N/A"?n.company:"â€”";if(n.role==="PLATOON_REVIEWER"){const R=n.company&&n.company!=="N/A"?n.company:"",C=n.platoon&&n.platoon!=="N/A"?n.platoon:"",$=[R,C].filter(Boolean);return $.length?$.join(" / "):"â€”"}return"â€”"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:o,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:u=>u.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:o,children:"âœ•"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[n.rank," ",n.lastName,", ",n.firstName,n.mi?` ${n.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:n.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:n.edipi||"â€”"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:n.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:n.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:v()})]}),n.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),n.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:o,children:"Close"})})]})})}),ra=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],ia=()=>{const[s,n]=a.useState(null),[o,v]=a.useState(void 0),[u,E]=a.useState({}),[R,C]=a.useState({}),[$,L]=a.useState({}),[B,X]=a.useState({}),[S,G]=a.useState(""),[z,F]=a.useState(""),[d,ee]=a.useState(""),[_,O]=a.useState(""),[H,b]=a.useState(""),[V,h]=a.useState([]),[I,T]=a.useState(null),[k,Y]=a.useState(""),w=a.useRef(null),[f,U]=a.useState(null),[W,K]=a.useState(null),[re,P]=a.useState(""),[ue,fe]=a.useState(void 0),[ye,pe]=a.useState(void 0),[Ne,he]=a.useState(void 0),[y,M]=a.useState(void 0),[se,oe]=a.useState(void 0),[ie,Ae]=a.useState(void 0),[je,ge]=a.useState([]),[De,Se]=a.useState([]),[x,j]=a.useState(""),[Z,ne]=a.useState("unit"),[le,p]=a.useState([]),[A,i]=a.useState(!1),[m,q]=a.useState(!1),[te,ce]=a.useState(!1),[me,ke]=a.useState("admin"),[Ce,xe]=a.useState(!0),[Ie,Te]=a.useState(null),[Ye,g]=a.useState(0),ae=a.useRef(!1);a.useEffect(()=>{f&&me==="admin"&&!ae.current&&(!ue&&f.company&&f.company!=="N/A"&&(fe(f.company),he(f.company)),!ye&&f.platoon&&f.platoon!=="N/A"&&(pe(f.platoon),M(f.platoon)),!se&&f.roleCompany&&f.roleCompany!=="N/A"&&oe(f.roleCompany),!ie&&f.rolePlatoon&&f.rolePlatoon!=="N/A"&&Ae(f.rolePlatoon),ae.current=!0)},[f,me]),a.useEffect(()=>{try{const t=localStorage.getItem("unit_structure");t&&E(JSON.parse(t))}catch{}try{const t=localStorage.getItem("unit_structure"),r={},l={},N={};if(t){const Q=JSON.parse(t);for(const J of Object.keys(Q||{})){const D=Q[J];D&&Array.isArray(D._sections)&&(r[J]=D._sections),D&&Array.isArray(D._commandSections)&&(l[J]=D._commandSections),D&&D._platoonSectionMap&&typeof D._platoonSectionMap=="object"&&(N[J]=D._platoonSectionMap)}}else(async()=>{try{const Q=await ft();for(const J of Object.keys(Q||{})){const D=Q[J];D&&Array.isArray(D._sections)&&(r[J]=D._sections),D&&Array.isArray(D._commandSections)&&(l[J]=D._commandSections),D&&D._platoonSectionMap&&typeof D._platoonSectionMap=="object"&&(N[J]=D._platoonSectionMap)}E(Q)}catch{}})();C(r),L(l),X(N)}catch{}(async()=>{xe(!0),Te(null);try{const t=await bt();if(t.error)throw new Error(t.error);h(t.data),g(t.data.length)}catch(t){const r=(t==null?void 0:t.message)||"Unknown error fetching users";console.error("[AdminPanel] Failed to fetch users:",r),Te(r),h([]),g(0)}finally{xe(!1)}})();try{const t=localStorage.getItem("currentUser");if(t){const r=JSON.parse(t);if(n(r),r.unitUic){const l=Be.find(N=>N.uic===r.unitUic);l&&v(l)}}}catch{}},[]),a.useEffect(()=>{try{if(!o){const t=Object.keys(u||{});if(t.length){const r=t[0],l=u[r]||{},Q=Be.find(J=>J.uic===r)||{ruc:String(l._ruc||""),mcc:String(l._mcc||""),uic:r,unitName:String(l._unitName||r),streetAddress:String(l._streetAddress||"")};v(Q)}}}catch{}},[u]),a.useEffect(()=>{const t=(f==null?void 0:f.unitUic)||"";if(!t){ge([]);return}as(t).then(r=>ge(r||[])).catch(()=>ge([]))},[f]),a.useEffect(()=>{const t=(f==null?void 0:f.unitUic)||"",r=se||"";if(!t||!r){Se([]);return}Mt(t,r).then(l=>Se(l||[])).catch(()=>Se([]))},[f,se]);const be=a.useMemo(()=>{const t=(o==null?void 0:o.uic)||"";if(!t)return[];const r=u[t]||{};return Object.keys(r).filter(l=>!l.startsWith("_")&&Array.isArray(r[l]))},[o,u]),Me=a.useMemo(()=>{var l;const t=(o==null?void 0:o.uic)||"";if(!t||!S)return[];const r=(l=u[t])==null?void 0:l[S];return Array.isArray(r)?r:[]},[o,S,u]),Ge=a.useMemo(()=>{const t=(o==null?void 0:o.uic)||"";return t?R[t]||[]:[]},[o,R]),Je=a.useMemo(()=>{const t=(o==null?void 0:o.uic)||"";return t?$[t]||[]:[]},[o,$]),ve=a.useMemo(()=>{const t=(f==null?void 0:f.unitUic)||"";if(!t)return[];const r=je;if(r&&r.length)return r;const l=u[t]||{};return Object.keys(l).filter(N=>!N.startsWith("_")&&Array.isArray(l[N]))},[f,u,je]),Ve=a.useMemo(()=>{var N;const t=(f==null?void 0:f.unitUic)||"",r=Ne||"";if(!t||!r)return[];const l=(N=u[t])==null?void 0:N[r];return Array.isArray(l)?l:[]},[f,Ne,u]),Ke=a.useMemo(()=>{var Q,J;const t=(f==null?void 0:f.unitUic)||"",r=se||"";if(!r)return[];const l=De;if(l&&l.length>0)return l;if(t){const D=(Q=u[t])==null?void 0:Q[r];if(Array.isArray(D)&&D.length>0)return D}const N=(o==null?void 0:o.uic)||"";if(N&&N!==t){const D=(J=u[N])==null?void 0:J[r];if(Array.isArray(D))return D}return[]},[f,se,u,De,o]),dt=a.useMemo(()=>{const t=ve.slice(),r=ue||(f&&f.company!=="N/A"?f.company:"");return r&&!t.includes(r)?[r,...t]:t},[ve,ue,f]);a.useMemo(()=>{const t=Ve.slice(),r=y||(f&&f.platoon&&f.platoon!=="N/A"?f.platoon:"");return r&&!t.includes(r)?[r,...t]:t},[Ve,y,f]);const rt=a.useMemo(()=>{const t=Ke.slice(),r=ie||(f&&f.rolePlatoon&&f.rolePlatoon!=="N/A"?f.rolePlatoon:"");return r&&!t.includes(r)?[r,...t]:t},[Ke,ie,f]),tt=a.useMemo(()=>o?V.filter(t=>{const r=String(t.unitUic||"").trim().toUpperCase(),l=String(o.uic||"").trim().toUpperCase(),N=String(t.unit||"").trim().toLowerCase(),Q=String(o.unitName||"").trim().toLowerCase();return r&&r===l||N&&N===Q}):V,[V,o]),st=a.useMemo(()=>{if(!k)return tt;const t=k.toLowerCase();return tt.filter(r=>(r.email??"").toLowerCase().includes(t)||(r.lastName??"").toLowerCase().includes(t))},[tt,k]),yt=()=>{try{if(o){const t=o.uic,r={...u};r[t]=r[t]||{},r[t]._mcc=o.mcc||r[t]._mcc||"",r[t]._unitName=o.unitName||r[t]._unitName||"",E(r),localStorage.setItem("unit_structure",JSON.stringify(r)),(async()=>{try{if(navigator.sendBeacon){const N=new Blob([JSON.stringify(r)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",N),T({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist unit structure."})}})()}else{const t=JSON.stringify(u);localStorage.setItem("unit_structure",t),(async()=>{try{if(navigator.sendBeacon){const l=new Blob([t],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",l),T({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:t,keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist unit structure."})}})()}}catch{T({type:"error",message:"Failed to save unit structure."})}},vt=()=>{try{if(!o)return;const t=o.uic,r={...u};r[t]=r[t]||{},r[t]._sections=R[t]||[],r[t]._mcc=o.mcc||r[t]._mcc||"",r[t]._unitName=o.unitName||r[t]._unitName||"",E(r),localStorage.setItem("unit_structure",JSON.stringify(r)),(async()=>{try{if(navigator.sendBeacon){const N=new Blob([JSON.stringify(r)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",N),T({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist unit sections."})}})()}catch{T({type:"error",message:"Failed to save unit sections."})}},mt=()=>{try{if(!o)return;const t=o.uic,r={...u};r[t]=r[t]||{},r[t]._commandSections=$[t]||[],r[t]._mcc=o.mcc||r[t]._mcc||"",r[t]._unitName=o.unitName||r[t]._unitName||"",E(r),localStorage.setItem("unit_structure",JSON.stringify(r)),(async()=>{try{if(navigator.sendBeacon){const N=new Blob([JSON.stringify(r)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",N),T({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist command sections."})}})()}catch{T({type:"error",message:"Failed to save command sections."})}},it=()=>{try{if(!o)return;const t=o.uic,r={...u};r[t]=r[t]||{},r[t]._platoonSectionMap=B[t]||{},r[t]._mcc=o.mcc||r[t]._mcc||"",r[t]._unitName=o.unitName||r[t]._unitName||"",E(r),localStorage.setItem("unit_structure",JSON.stringify(r)),(async()=>{try{if(navigator.sendBeacon){const N=new Blob([JSON.stringify(r)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",N),T({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist links."})}})()}catch{T({type:"error",message:"Failed to save links."})}},ut=()=>{if(!o||!z.trim())return;const t=o.uic,r={...u};r[t]=r[t]||{},r[t][z.trim()]||(r[t][z.trim()]=[],E(r),G(z.trim()),F(""))},Nt=t=>{if(!o)return;const r=o.uic,l={...u};l[r]&&(delete l[r][t],E(l),S===t&&G(""))},jt=()=>{if(!o||!S||!d.trim())return;const t=o.uic,r={...u};r[t]=r[t]||{},r[t][S]=r[t][S]||[],r[t][S].includes(d.trim())||(r[t][S]=[...r[t][S],d.trim()],E(r),ee(""))},we=t=>{if(!o||!S)return;const r=o.uic,l={...u};l[r][S]=(l[r][S]||[]).filter(N=>N!==t),E(l)},St=()=>{if(!o||!_.trim())return;const t=o.uic,r={...R};r[t]=r[t]||[],r[t].includes(_.trim())||(r[t]=[...r[t],_.trim()],C(r),O(""))},wt=t=>{if(!o)return;const r=o.uic,l={...R};l[r]=(l[r]||[]).filter(N=>N!==t),C(l)},xt=()=>{if(!o||!H.trim())return;const t=o.uic,r={...$};r[t]=r[t]||[],r[t].includes(H.trim())||(r[t]=[...r[t],H.trim()],L(r),b(""))},Ct=t=>{if(!o)return;const r=o.uic,l={...$};l[r]=(l[r]||[]).filter(N=>N!==t),L(l)},c=()=>{const t=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],r=V.map(D=>[D.firstName,D.mi||"",D.lastName,D.email,D.edipi,D.service,D.rank,D.role,D.company,D.unit,D.unitUic||""].map(Ee=>{const de=String(Ee??"");return de.includes(",")||de.includes('"')||de.includes(`
`)?'"'+de.replace(/"/g,'""')+'"':de}).join(",")),l="\uFEFF"+[t.join(","),...r].join(`
`),N=new Blob([l],{type:"text/csv;charset=utf-8"}),Q=URL.createObjectURL(N),J=document.createElement("a");J.href=Q,J.download="users-export.csv",J.click(),URL.revokeObjectURL(Q)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${Z==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>ne("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${Z==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>ne("users"),children:"User Administration"})]})})}),Z==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:o?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:o.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",o.uic," | RUC: ",o.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:yt,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:z,onChange:t=>F(t.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:ut,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[be.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>G(t),children:t}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Nt(t),children:"Remove"})]},t)),be.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",S?`â€¢ ${S}`:""]}),o&&S&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:it,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:d,onChange:t=>ee(t.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!S}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:jt,disabled:!S,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Me.map(t=>{var r,l;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:t})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:((l=(r=B[(o==null?void 0:o.uic)||""])==null?void 0:r[S])==null?void 0:l[t])||"",onChange:N=>{const Q=(o==null?void 0:o.uic)||"";X(J=>{const D={...J};return D[Q]=D[Q]||{},D[Q][S]=D[Q][S]||{},D[Q][S][t]=N.target.value,D})},children:[e.jsx("option",{value:"",children:"Link to section"}),(R[(o==null?void 0:o.uic)||""]||[]).map(N=>e.jsx("option",{value:N,children:N},N))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>we(t),children:"Remove"})]})]},t)}),Me.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:vt,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:_,onChange:t=>O(t.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:St,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Ge.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:t}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>wt(t),children:"Remove"})]},t)),Ge.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:mt,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:H,onChange:t=>b(t.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:xt,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Je.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:t}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Ct(t),children:"Remove"})]},t)),Je.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),Z==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),Ie&&e.jsxs("div",{className:"mb-4 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:[e.jsx("strong",{children:"Error loading users:"})," ",Ie]}),Ce&&e.jsx("div",{className:"mb-4 p-3 border border-blue-200 bg-blue-50 text-blue-800 rounded",children:"Loading users..."}),!Ce&&!Ie&&Ye>0&&tt.length===0&&e.jsxs("div",{className:"mb-4 p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:[e.jsx("strong",{children:"Note:"})," ",Ye," user(s) found in database, but none match your unit (",(o==null?void 0:o.unitName)||"No unit selected",", UIC: ",(o==null?void 0:o.uic)||"N/A",").",e.jsx("br",{}),e.jsx("span",{className:"text-sm",children:"Users may be assigned to different units."})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[st.map(t=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[t.lastName,", ",t.firstName,t.mi?` ${t.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:t.email}),e.jsx("td",{className:"py-2 px-3",children:t.edipi}),e.jsx("td",{className:"py-2 px-3",children:t.service}),e.jsx("td",{className:"py-2 px-3",children:t.rank}),e.jsx("td",{className:"py-2 px-3",children:t.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const r=Be.find(N=>N.uic===t.unitUic),l=r?r.unitName:t.unit;if(t.isUnitAdmin||t.role==="COMMANDER")return l||"â€”";if(t.role==="COMPANY_REVIEWER")return t.company&&t.company!=="N/A"?t.company:"â€”";if(t.role==="PLATOON_REVIEWER"){const N=t.company&&t.company!=="N/A"?t.company:"",Q=t.platoon&&t.platoon!=="N/A"?t.platoon:"",J=[N,Q].filter(Boolean);return J.length?J.join(" / "):"â€”"}return"â€”"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>K(t),children:"View"}),((s==null?void 0:s.isUnitAdmin)||(s==null?void 0:s.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{ke("admin"),U(t),P(t.role??"MEMBER"),fe(t.company!=="N/A"?t.company:void 0),he(t.company!=="N/A"?t.company:void 0),pe(t.platoon&&t.platoon!=="N/A"?t.platoon:void 0),M(t.platoon&&t.platoon!=="N/A"?t.platoon:void 0),j(typeof t.commandOrder=="number"?String(t.commandOrder):""),q(!!t.isUnitAdmin),ce(!!t.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{h(r=>r.filter(l=>l.id!==t.id));try{localStorage.removeItem(`fs/users/${t.id}.json`)}catch(r){console.error("Failed to remove user from localStorage",r)}},children:"Delete"})]})})]},t.id)),st.length===0&&!Ce&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:Ie?"Failed to load users - check console for details":Ye===0?"No users found in database":k?"No users match your search":"No users in this unit"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:w,type:"text",placeholder:"Filter users...",value:k,onChange:t=>Y(t.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var t;return(t=w.current)==null?void 0:t.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:c,children:"Export All"})]})]}),W&&e.jsx(na,{user:W,onClose:()=>K(null)}),f&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>U(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>U(null),children:"âœ•"})]}),me==="profile"&&s&&f&&s.edipi===f.edipi&&e.jsx(cs,{mode:"edit",initial:f,readOnly:!1,onSaved:t=>{h(r=>r.map(l=>l.edipi===t.edipi?t:l)),U(null),T({type:"success",message:"Profile updated."})}}),me==="admin"&&((s==null?void 0:s.isUnitAdmin)||(s==null?void 0:s.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:re,onChange:t=>{const r=t.target.value;P(r),r==="COMMANDER"&&(fe(void 0),pe(void 0))},className:"w-full px-3 py-2 border rounded",children:ra.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:se||"",onChange:t=>oe(t.target.value||void 0),disabled:!re.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:dt.length?"Select company":"No companies configured"}),dt.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:ie||"",onChange:t=>Ae(t.target.value||void 0),disabled:!re.includes("REVIEW")||!se,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:rt.length?"Select platoon":"No platoons configured"}),rt.map(t=>e.jsx("option",{value:t,children:t},t))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:m,onChange:t=>q(t.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:te,disabled:re==="COMMANDER",onChange:async t=>{const r=t.target.checked;ce(r);try{if(f&&!(await Qe({id:f.id,email:f.email,rank:f.rank,firstName:f.firstName,lastName:f.lastName,mi:f.mi,service:f.service,role:f.role,unitUic:f.unitUic,unit:f.unit,company:f.company,isUnitAdmin:!!f.isUnitAdmin,isCommandStaff:r,edipi:f.edipi,passwordHash:f.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})]}),le.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:le.map((t,r)=>e.jsx("div",{className:"text-sm",children:t},r))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{U(null),ae.current=!1,p([]),i(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${A?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":A,disabled:A,onClick:async()=>{var N;if(!f)return;const t=[];if(re==="COMPANY_REVIEWER"&&!ue&&t.push("Company is required for Company Reviewer."),re==="PLATOON_REVIEWER"&&(!ue||!ye)&&t.push("Company and Platoon are required for Platoon Reviewer."),p(t),t.length)return;i(!0);const r=((N=Be.find(Q=>Q.uic===f.unitUic))==null?void 0:N.unitName)||"N/A",l={...f,role:re,isUnitAdmin:m,isCommandStaff:re==="COMMANDER"?!1:te,company:Ne||"N/A",unit:r,platoon:y||"N/A",roleCompany:re.includes("REVIEW")?se||"N/A":void 0,rolePlatoon:re.includes("REVIEW")?ie||"N/A":void 0};try{localStorage.setItem(`fs/users/${l.edipi}.json`,JSON.stringify(l))}catch{}try{if(!(await Qe({id:l.id,email:l.email,rank:l.rank,firstName:l.firstName,lastName:l.lastName,mi:l.mi,service:l.service,role:l.role,unitUic:l.unitUic,unit:l.unit,company:l.company,isUnitAdmin:!!l.isUnitAdmin,isCommandStaff:!!l.isCommandStaff,edipi:l.edipi,passwordHash:l.passwordHash,roleCompany:l.roleCompany,rolePlatoon:l.rolePlatoon,platoon:l.platoon})).ok)throw new Error("persist_failed")}catch{i(!1),T({type:"error",message:"Failed to save administrative changes."});return}h(Q=>Q.map(J=>J.edipi===l.edipi?l:J));try{s&&s.edipi===l.edipi&&(localStorage.setItem("currentUser",JSON.stringify(l)),n(l))}catch{}U(null),ae.current=!1,i(!1),T({type:"success",message:"Administrative changes saved."})},children:[A&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),I&&e.jsx("div",{className:`p-3 rounded-lg border ${I.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:I.message})]})};function oa(){const[s,n]=a.useState([]),[o,v]=a.useState(null),[u,E]=a.useState({}),[R,C]=a.useState({}),[$,L]=a.useState([]),[B,X]=a.useState("unit"),[S,G]=a.useState("assigned"),[z,F]=a.useState([]),[d,ee]=a.useState(""),[_,O]=a.useState([]),[H,b]=a.useState(""),V=()=>{nt().then(p=>n(p)).catch(()=>n([]))},h=()=>{gt().then(p=>L(p)).catch(()=>L([]))},I=()=>{v(null),V(),h()};a.useEffect(()=>{I(),ns().then(p=>F(p)),Zt().then(p=>O(p))},[B,S]);const T=a.useMemo(()=>{const p={};for(const A of s)A.isUnitAdmin&&A.unitUic&&(p[A.unitUic]=A);return p},[s]),k=a.useMemo(()=>{const p=new Set;return Be.filter(A=>p.has(A.uic)?!1:(p.add(A.uic),!0))},[]),Y=a.useMemo(()=>{const p={};for(const A of s)if(A.isInstallationAdmin&&A.installationId){const i=A.installationId;p[i]=p[i]||[],p[i].push(A)}return p},[s]),w=p=>s.filter(A=>A.unitUic===p.uic||!A.unitUic&&A.unit===p.unitName),f=async p=>{const A=u[p.uic];if(!A)return;const i=s.find(q=>q.id===A);if(!i)return;const m={...i,isUnitAdmin:!0,unitUic:p.uic,unit:p.unitName,company:"N/A"};try{if(!(await Qe({id:m.id,email:m.email,rank:m.rank,firstName:m.firstName,lastName:m.lastName,mi:m.mi,service:m.service,role:m.role,unitUic:m.unitUic,unit:m.unit,company:m.company,isUnitAdmin:!!m.isUnitAdmin,isInstallationAdmin:!!m.isInstallationAdmin,isCommandStaff:!!m.isCommandStaff,edipi:m.edipi})).ok){v({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}n(q=>q.map(te=>te.id===m.id?m:te)),v({type:"success",message:`Assigned ${m.rank} ${m.lastName} as admin for ${p.unitName}.`})},U=a.useMemo(()=>k.filter(p=>!!T[p.uic]),[k,T]);a.useMemo(()=>(Array.isArray(s)?s:[]).filter(p=>!!p.isHqmcAdmin),[s]);const W=a.useMemo(()=>k.filter(p=>!T[p.uic]),[k,T]),K=a.useMemo(()=>(Array.isArray(z)?z:[]).filter(p=>{var A;return(A=Y[p.id])==null?void 0:A.length}),[z,Y]),re=a.useMemo(()=>(Array.isArray(z)?z:[]).filter(p=>{var A;return!((A=Y[p.id])!=null&&A.length)}),[z,Y]),P=a.useMemo(()=>{const p={};for(const A of Array.isArray(s)?s:[])if(A.isHqmcAdmin&&A.hqmcDivision){const i=A.hqmcDivision;p[i]=p[i]||[],p[i].push(A)}return p},[s]),ue=a.useMemo(()=>(Array.isArray(_)?_:[]).filter(p=>{var A;return(A=P[p.code])==null?void 0:A.length}),[_,P]);a.useMemo(()=>{const p=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return(Array.isArray($)?$:[]).filter(A=>p.includes(String(A.currentStage||"")))},[$]);const[fe,ye]=a.useState(1),[pe,Ne]=a.useState(10),he=U.length,y=Math.max(1,Math.ceil(he/(pe||1))),M=Math.min(fe,y),se=he===0?0:(M-1)*pe+1,oe=he===0?0:Math.min(se+pe-1,he),ie=U.slice((M-1)*pe,(M-1)*pe+pe),[Ae,je]=a.useState(1),[ge,De]=a.useState(10),Se=W.length,x=Math.max(1,Math.ceil(Se/(ge||1))),j=Math.min(Ae,x),Z=Se===0?0:(j-1)*ge+1,ne=Se===0?0:Math.min(Z+ge-1,Se),le=W.slice((j-1)*ge,(j-1)*ge+ge);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${B==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{X("unit"),G("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${B==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{X("installation"),G("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${B==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{X("hqmc"),G("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${S==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>G("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${S==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>G("missing"),children:"Missing"})]}),B==="installation"&&S==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[K.map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.name}),e.jsx("td",{className:"py-2 px-3",children:(Y[p.id]||[]).map(A=>`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`).join(" â€¢ ")})]},p.id)),K.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),B==="installation"&&S==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[re.map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:R[p.id]||"",onChange:A=>C(i=>({...i,[p.id]:A.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),s.map(A=>e.jsx("option",{value:A.id,children:`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`},A.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!R[p.id],onClick:async()=>{const A=R[p.id],i=s.find(q=>q.id===A);if(!i)return;const m={...i,isInstallationAdmin:!0,installationId:p.id};try{if(!(await Qe({id:m.id,email:m.email,rank:m.rank,firstName:m.firstName,lastName:m.lastName,mi:m.mi,service:m.service,role:m.role,unitUic:m.unitUic,unit:m.unit,company:m.company,isUnitAdmin:!!m.isUnitAdmin,isInstallationAdmin:!!m.isInstallationAdmin,isCommandStaff:!!m.isCommandStaff,edipi:m.edipi,installationId:m.installationId})).ok){v({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}n(q=>q.map(te=>te.id===m.id?m:te)),v({type:"success",message:`Assigned ${m.rank} ${m.lastName} as installation admin.`})},children:"Assign"})})]},p.id)),re.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),B==="unit"&&S==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[ie.map(p=>{const A=T[p.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.unitName}),e.jsx("td",{className:"py-2 px-3",children:p.uic}),e.jsx("td",{className:"py-2 px-3",children:`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`})]},p.uic)}),U.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(Dt,{currentPage:M,totalPages:y,totalItems:he,pageSize:pe,startIndex:se,endIndex:oe,onPageChange:p=>ye(p),onPageSizeChange:p=>{Ne(p),ye(1)},onNext:()=>ye(Math.min(M+1,y)),onPrevious:()=>ye(Math.max(M-1,1)),onFirst:()=>ye(1),onLast:()=>ye(y),canGoNext:M<y,canGoPrevious:M>1,pageSizeOptions:[5,10,25,50]})})]}),B==="unit"&&S==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[le.map(p=>{const A=w(p);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.unitName}),e.jsx("td",{className:"py-2 px-3",children:p.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:u[p.uic]||"",onChange:i=>E(m=>({...m,[p.uic]:i.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:A.length?"Select user":"No eligible users"}),A.map(i=>e.jsx("option",{value:i.id,children:`${i.rank} ${i.lastName}, ${i.firstName}${i.mi?` ${i.mi}`:""}`},i.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!u[p.uic],onClick:()=>f(p),children:"Assign"})})]},p.uic)}),W.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(Dt,{currentPage:j,totalPages:x,totalItems:Se,pageSize:ge,startIndex:Z,endIndex:ne,onPageChange:p=>je(p),onPageSizeChange:p=>{De(p),je(1)},onNext:()=>je(Math.min(j+1,x)),onPrevious:()=>je(Math.max(j-1,1)),onFirst:()=>je(1),onLast:()=>je(x),canGoNext:j<x,canGoPrevious:j>1,pageSizeOptions:[5,10,25,50]})})]}),B==="hqmc"&&S==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[ue.map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[p.code," â€” ",p.name]}),e.jsx("td",{className:"py-2 px-3",children:(P[p.code]||[]).map(A=>`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`).join(" â€¢ ")})]},p.code)),ue.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),B==="hqmc"&&S==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[_.filter(p=>{var A;return!((A=P[p.code])!=null&&A.length)}).map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[p.code," â€” ",p.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:R[`hqmc_${p.code}`]||"",onChange:A=>C(i=>({...i,[`hqmc_${p.code}`]:A.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),s.map(A=>e.jsx("option",{value:A.id,children:`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`},A.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!R[`hqmc_${p.code}`],onClick:async()=>{const A=R[`hqmc_${p.code}`],i=s.find(q=>q.id===A);if(!i)return;const m={...i,isHqmcAdmin:!0,hqmcDivision:p.code};try{if(!(await Qe({id:m.id,email:m.email,rank:m.rank,firstName:m.firstName,lastName:m.lastName,mi:m.mi,service:m.service,role:m.role,unitUic:m.unitUic,unit:m.unit,company:m.company,isUnitAdmin:!!m.isUnitAdmin,isInstallationAdmin:!!m.isInstallationAdmin,isCommandStaff:!!m.isCommandStaff,isHqmcAdmin:!!m.isHqmcAdmin,hqmcDivision:m.hqmcDivision,edipi:m.edipi})).ok){v({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}n(q=>q.map(te=>te.id===m.id?m:te)),v({type:"success",message:`Assigned ${m.rank} ${m.lastName} as HQMC admin for ${p.code}.`})},children:"Assign"})})]},p.code)),_.filter(p=>{var A;return!((A=P[p.code])!=null&&A.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),o&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${o.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:o.message})]})})}const Jt=!0,ca=({onLoggedIn:s,onCreateAccount:n})=>{const[o,v]=a.useState(""),[u,E]=a.useState(""),[R,C]=a.useState(null),[$,L]=a.useState(!0),[B,X]=a.useState(!0);gs.useEffect(()=>{},[]);const S=async G=>{G.preventDefault(),C(null);try{const z=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,F=/^[0-9]{10}$/.test(o),d=Jt?z.test(o.trim().toLowerCase())||F:z.test(o.trim().toLowerCase()),ee=u.length>=6;if(L(d),X(ee),!d){C({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!ee){C({type:"error",message:"Password must be at least 6 characters."});return}let _=null,O=null,H=o.trim().toLowerCase();if(Jt&&F){const{user:Y,error:w}=await It(String(o));_=Y,O=w,H=String((_==null?void 0:_.email)||"")}else if(z.test(H)){const{user:Y,error:w}=await Bt(H);_=Y,O=w}else{C({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(O){C({type:"error",message:`Database Error: ${O}`});return}if(!_||!H){C({type:"error",message:"Account not found."});return}const b=String(_.passwordHash||_.password_hash||"").trim();if(!b){C({type:"error",message:"No password set for this user."});return}const V=await $t(u);if(!(/^[0-9a-f]{64}$/i.test(b)?b.toLowerCase()===V.toLowerCase():b===u)){C({type:"error",message:"Invalid credentials."});return}const{user:T,error:k}=await Bt(H);if(k){C({type:"error",message:`Profile Error: ${k}`});return}if(!T){console.error("[Login] User profile not found after successful password verification",{emailForLogin:H}),C({type:"error",message:"User profile not found."});return}C({type:"success",message:"Logged in."}),s(T)}catch(z){console.error("[Login] Login failed:",z),C({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:S,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:o,onChange:G=>v(G.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${$?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!$}),!$&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:u,onChange:G=>E(G.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${B?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!B}),!B&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),R&&e.jsx("div",{className:`p-3 rounded-lg border ${R.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:R.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:n,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!$||!B,children:"Login"})]})]})]})},Kt=""+new URL("logo-DLcHofKE.png",import.meta.url).href,la=({currentUser:s,hasSectionDashboard:n,hasCommandDashboard:o,hasInstallationSectionDashboard:v=!1,hasInstallationCommandDashboard:u=!1,hasHQMCSectionDashboard:E=!1,hasHQMCApproverDashboard:R=!1,onManageProfile:C,onLogout:$,onNavigate:L,isLogin:B=!1})=>{const[X,S]=a.useState(!1),[G,z]=a.useState(!1),F=a.useRef(null);return a.useEffect(()=>{const d=_=>{if(!X)return;const O=F.current;O&&_.target&&!O.contains(_.target)&&S(!1)},ee=_=>{_.key==="Escape"&&S(!1)};return document.addEventListener("mousedown",d),document.addEventListener("touchstart",d,{passive:!0}),document.addEventListener("keydown",ee),()=>{document.removeEventListener("mousedown",d),document.removeEventListener("touchstart",d),document.removeEventListener("keydown",ee)}},[X]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:B?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:Kt,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:Kt,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:s?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[s.rank," ",s.lastName,s.lastName?",":""," ",s.firstName,s.mi?` ${s.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[s.service," â€¢ ",s.role,(()=>{const d={PLATOON_REVIEWER:s.role_platoon,COMPANY_REVIEWER:s.role_company}[s.role];return d?` - ${d}`:null})()]}),(()=>{var H;const d=((H=Be.find(b=>b.uic===((s==null?void 0:s.unitUic)||"")))==null?void 0:H.unitName)||(s==null?void 0:s.unit)||"",ee=s!=null&&s.company&&s.company!=="N/A"?s.company:s!=null&&s.user_company&&s.user_company!=="N/A"?s.user_company:null,_=s!=null&&s.platoon&&s.platoon!=="N/A"?s.platoon:s!=null&&s.user_platoon&&s.user_platoon!=="N/A"?s.user_platoon:null,O=[d||null,ee,_].filter(Boolean);return O.length?e.jsx("div",{className:"text-xs text-white/70",children:O.join(" â€¢ ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(s.lastName||"").charAt(0)}${(s.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:C,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:$,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),s&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>z(!G),children:`${(s.lastName||"").charAt(0)}${(s.firstName||"").charAt(0)}`.toUpperCase()}),G&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{C(),z(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{$(),z(!1)},children:"Logout"})]})]}),!s&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>L("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:F,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":X,onClick:()=>S(d=>!d),children:"Dashboards"}),e.jsxs("div",{className:`${X?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:s&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("dashboard"),S(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(s==null?void 0:s.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("admin"),S(!1)},children:"Unit Admin"}),s&&!!s.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("appadmin"),S(!1)},children:"App Admin"}),s&&!!s.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("hqmc-admin"),S(!1)},children:"HQMC Admin"}),s&&!!s.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("installation"),S(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[s&&n&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("section"),S(!1)},children:"Unit Section Dashboard"}),o&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("command"),S(!1)},children:"Unit Command Dashboard"}),String((s==null?void 0:s.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("review"),S(!1)},children:"Unit Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[s&&v&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("installation-section"),S(!1)},children:"Installation Section Dashboard"}),s&&u&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("installation-command"),S(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[s&&(E||!!s.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("hqmc-section"),S(!1)},children:"HQMC Section Dashboard"}),s&&R&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("hqmc-approver"),S(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})},Le={SECTION:"perm_section",COMMAND:"perm_command",INST_SECTION:"perm_inst_section",INST_COMMAND:"perm_inst_command",HQMC_SECTION:"perm_hqmc_section",HQMC_APPROVER:"perm_hqmc_approver"},at=s=>{try{return localStorage.getItem(s)==="true"}catch(n){return console.error(`Failed to read from localStorage for key "${s}":`,n),!1}};function da(){const[s,n]=a.useState(null),[o,v]=a.useState("login"),[u,E]=a.useState(()=>{try{const h=localStorage.getItem("currentUser");return h?JSON.parse(h):null}catch(h){return console.error("Failed to parse user from localStorage:",h),null}}),[R,C]=a.useState("create"),[$,L]=a.useState(!1),[B,X]=a.useState(()=>at(Le.SECTION)),[S,G]=a.useState(()=>at(Le.COMMAND)),[z,F]=a.useState(()=>at(Le.INST_SECTION)),[d,ee]=a.useState(()=>at(Le.INST_COMMAND)),[_,O]=a.useState(()=>at(Le.HQMC_SECTION)),[H,b]=a.useState(()=>at(Le.HQMC_APPROVER)),V=bs();return a.useEffect(()=>{try{const I=new URLSearchParams(window.location.search).get("view");if(I==="admin"||I==="profile"||I==="dashboard"||I==="login"||I==="appadmin"||I==="hqmc-admin"||I==="hqmc-section"||I==="hqmc-approver"||I==="review"||I==="section"||I==="command"||I==="installation"||I==="installation-section"||I==="installation-command"||I==="documents"||I==="document-viewer"||I==="upload")v(I);else{const T=localStorage.getItem("currentView"),k=localStorage.getItem("currentUser");v(T&&k?T:"login")}}catch{v("login")}},[]),a.useEffect(()=>{u?localStorage.setItem("currentUser",JSON.stringify(u)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"),Object.values(Le).forEach(h=>{try{localStorage.removeItem(h)}catch(I){console.error(`Failed to remove item from localStorage for key "${h}":`,I)}}))},[u]),a.useEffect(()=>{if(!u)return;const h={[Le.SECTION]:B,[Le.COMMAND]:S,[Le.INST_SECTION]:z,[Le.INST_COMMAND]:d,[Le.HQMC_SECTION]:_,[Le.HQMC_APPROVER]:H};for(const[I,T]of Object.entries(h))try{localStorage.setItem(I,String(T))}catch(k){console.error(`Failed to set item in localStorage for key "${I}":`,k)}},[u,B,S,z,d,_,H]),a.useEffect(()=>{let h=!1;return(async()=>{try{const I=(u==null?void 0:u.id)||"";if(!I)return;const T=await ss(I);if(T&&!h){const k=(f,U)=>f===!0||f===!1?f:U||!1,Y=(f,U)=>f!=null?f||void 0:U,w={...T,isAppAdmin:k(T.isAppAdmin,u==null?void 0:u.isAppAdmin),isUnitAdmin:k(T.isUnitAdmin,u==null?void 0:u.isUnitAdmin),isInstallationAdmin:k(T.isInstallationAdmin,u==null?void 0:u.isInstallationAdmin),isHqmcAdmin:k(T.isHqmcAdmin,u==null?void 0:u.isHqmcAdmin),isCommandStaff:k(T.isCommandStaff,u==null?void 0:u.isCommandStaff),installationId:Y(T.installationId,u==null?void 0:u.installationId),hqmcDivision:Y(T.hqmcDivision,u==null?void 0:u.hqmcDivision)};E(w),localStorage.setItem("currentUser",JSON.stringify(w))}}catch{}})(),()=>{h=!0}},[]),a.useEffect(()=>{o!=="login"&&u&&localStorage.setItem("currentView",o)},[o,u]),a.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const I=await ft();localStorage.setItem("unit_structure",JSON.stringify(I))}catch(h){console.error("Failed to load unit structure:",h)}})()},[]),a.useEffect(()=>{var h,I,T;if(u){try{const k=localStorage.getItem("unit_structure");if(k){const Y=JSON.parse(k),w=(u==null?void 0:u.unitUic)||"",f=u!=null&&u.company&&u.company!=="N/A"?u.company:"",U=u!=null&&u.platoon&&u.platoon!=="N/A"?u.platoon:"",W=((T=(I=(h=Y==null?void 0:Y[w])==null?void 0:h._platoonSectionMap)==null?void 0:I[f])==null?void 0:T[U])||"";X(!!W)}}catch(k){console.error("Failed to parse unit structure for section dashboard check",k)}G(!!(u!=null&&u.isCommandStaff)),(async()=>{try{const k=(u==null?void 0:u.installationId)||"";if(!k){F(!1),ee(!1);return}const Y=await ns();try{localStorage.setItem("installations_cache",JSON.stringify(Y))}catch{}const w=Y==null?void 0:Y.find(K=>K.id===k),f=(u==null?void 0:u.id)||"",U=!!(w&&w.sectionAssignments&&Object.values(w.sectionAssignments).some(K=>Array.isArray(K)&&K.includes(f))),W=!!(w&&(w.commandSectionAssignments&&Object.values(w.commandSectionAssignments).some(K=>Array.isArray(K)&&K.includes(f))||w.commanderUserId&&String(w.commanderUserId)===f));F(U),ee(W)}catch{}})(),(async()=>{try{const k=String((u==null?void 0:u.hqmcDivision)||""),Y=String((u==null?void 0:u.id)||"");if(!k||!Y){O(!!(u!=null&&u.isHqmcAdmin)),b(!1);return}const{listHQMCSectionAssignmentsLegacy:w}=await fs(async()=>{const{listHQMCSectionAssignmentsLegacy:K}=await import("./db-SwzNKlTP.js").then(re=>re.A);return{listHQMCSectionAssignmentsLegacy:K}},__vite__mapDeps([0,1,2]),import.meta.url),f=await w(),U=f.some(K=>K.division_code===k&&((K.reviewers||[]).includes(Y)||(K.approvers||[]).includes(Y))),W=f.some(K=>K.division_code===k&&(K.approvers||[]).includes(Y));O(U||!!(u!=null&&u.isHqmcAdmin)),b(W)}catch{u!=null&&u.isHqmcAdmin&&O(!0)}})()}},[u]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(la,{currentUser:u,hasSectionDashboard:B,hasCommandDashboard:S,hasInstallationSectionDashboard:z,hasInstallationCommandDashboard:d,hasHQMCSectionDashboard:_,hasHQMCApproverDashboard:H,onManageProfile:()=>{C("edit"),v("profile"),V("/?view=profile")},onLogout:()=>{E(null),v("login"),V("/?view=login")},onNavigate:h=>{v(h),V(`/?view=${h}`)},isLogin:o==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:o==="profile"?e.jsx(cs,{mode:R,initial:R==="edit"?u||{}:{},onSaved:h=>{E(h),v("dashboard"),V("/?view=dashboard")}}):o==="admin"?e.jsx(ia,{}):o==="appadmin"?e.jsx(oa,{}):o==="login"?e.jsx(ca,{onLoggedIn:h=>{E(h),v("dashboard"),V("/?view=dashboard")},onCreateAccount:()=>{C("create"),v("profile"),V("/?view=profile")}}):o==="review"?e.jsx(Js,{}):o==="section"?e.jsx(Ms,{}):o==="command"?e.jsx(Ds,{}):o==="installation"?e.jsx(As,{}):o==="hqmc-admin"?e.jsx(Ks,{}):o==="installation-section"?e.jsx(Ps,{}):o==="installation-command"?e.jsx($s,{}):o==="hqmc-section"?e.jsx(Zs,{}):o==="hqmc-approver"?e.jsx(ea,{}):e.jsx(Ws,{selectedUnit:s,currentUser:u})})]})}function wa(){return e.jsx(da,{})}export{wa as default};
