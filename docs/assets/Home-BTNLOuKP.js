const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-Y4g5ldnd.js","./index-UUCbtA12.js","./index-D3haHBa6.css"])))=>i.map(i=>d[i]);
import{j as e,r as s,a as Gt,s as Pt,v as Ut,l as it,M as jt,b as Qt,u as Jt,R as Yt,c as Kt,_ as Zt}from"./index-UUCbtA12.js";import{s as ke,d as Xt,a as es,b as ts,l as gt,c as nt,e as Ue,u as _e,f as ct,g as bt,h as Ve,i as ss,j as as,k as Dt,m as ft,n as Ot,o as dt,p as ns,q as rs,r as $t,t as Lt,v as mt,w as _t,x as Nt}from"./db-Y4g5ldnd.js";import{P as ut,I as is}from"./InstallationAdmin-Dmu4DZKf.js";import{f as os,R as Ge,S as Ke,o as wt,c as ls}from"./RequestTable-0q-w1zkb.js";import{l as vt}from"./unitStructure-QC5qYuxv.js";import cs from"./SectionDashboard-Dl4ZL0wM.js";import ds from"./CommandDashboard-BoWFYTps.js";import ms from"./InstallationSectionDashboard-D8KE9Q0s.js";import us from"./InstallationCommandDashboard-eAHfWlWf.js";import{U as qe}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-Bk7PhxZh.js";const xs={pdf:"bg-red-100 text-red-700 border-red-200",doc:"bg-blue-100 text-blue-700 border-blue-200",xls:"bg-green-100 text-green-700 border-green-200",img:"bg-purple-100 text-purple-700 border-purple-200",txt:"bg-gray-100 text-gray-700 border-gray-200",file:"bg-gray-100 text-gray-700 border-gray-200"},ps={pdf:"PDF",doc:"DOC",xls:"XLS",img:"IMG",txt:"TXT",file:"FILE"};function yt(t,a){const r=t.toLowerCase(),p=(a||"").toLowerCase();return r.includes("pdf")||p.endsWith(".pdf")?"pdf":r.includes("word")||r.includes("document")||p.endsWith(".doc")||p.endsWith(".docx")?"doc":r.includes("excel")||r.includes("spreadsheet")||p.endsWith(".xls")||p.endsWith(".xlsx")?"xls":r.includes("image")||/\.(jpg|jpeg|png|gif|webp|svg|bmp)$/i.test(p)?"img":r.includes("text")||p.endsWith(".txt")?"txt":"file"}function qt(t,a){const r=yt(t,a);return r==="pdf"||r==="img"}const xt=({type:t,fileName:a,size:r="md",className:p=""})=>{const d=yt(t,a),S=xs[d],C=ps[d],w={sm:"w-8 h-8 text-xs",md:"w-10 h-10 text-xs",lg:"w-12 h-12 text-sm"};return e.jsx("div",{className:`
        ${w[r]}
        ${S}
        rounded border flex items-center justify-center font-bold
        ${p}
      `,role:"img","aria-label":`${C} file`,children:C})},hs=({url:t,fileName:a,mimeType:r,fileSize:p,isOpen:d,onClose:S,onDownload:C})=>{const[w,R]=s.useState(!0),[O,_]=s.useState(null),[J,f]=s.useState(100),V=yt(r,a),z=qt(r,a);s.useEffect(()=>{R(!0),_(null),f(100)},[t]);const $=s.useCallback(()=>{R(!1)},[]),m=s.useCallback(()=>{R(!1),_("Failed to load document preview")},[]),K=s.useCallback(N=>{N.key==="Escape"?S():N.key==="+"||N.key==="="?f(b=>Math.min(b+25,200)):N.key==="-"?f(b=>Math.max(b-25,50)):N.key==="0"&&f(100)},[S]);s.useEffect(()=>(d&&(document.addEventListener("keydown",K),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",K),document.body.style.overflow=""}),[d,K]);const W=N=>N?N<1024?`${N} B`:N<1024*1024?`${(N/1024).toFixed(1)} KB`:`${(N/(1024*1024)).toFixed(1)} MB`:"";return!d||typeof window>"u"?null:Gt.createPortal(e.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-[9999]",onClick:S,role:"dialog","aria-modal":"true","aria-labelledby":"preview-title",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow-2xl w-full max-w-5xl max-h-[90vh] mx-4 flex flex-col overflow-hidden",onClick:N=>N.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx(xt,{type:r,fileName:a,size:"md"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{id:"preview-title",className:"font-medium text-[var(--text)] truncate",children:a}),p&&e.jsx("p",{className:"text-sm text-[var(--muted)]",children:W(p)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[V==="img"&&e.jsxs("div",{className:"flex items-center gap-1 mr-2",children:[e.jsx("button",{onClick:()=>f(N=>Math.max(N-25,50)),className:"p-1.5 rounded hover:bg-gray-200 text-gray-600","aria-label":"Zoom out",disabled:J<=50,children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),e.jsxs("span",{className:"text-sm text-gray-600 w-12 text-center",children:[J,"%"]}),e.jsx("button",{onClick:()=>f(N=>Math.min(N+25,200)),className:"p-1.5 rounded hover:bg-gray-200 text-gray-600","aria-label":"Zoom in",disabled:J>=200,children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})}),e.jsx("button",{onClick:()=>f(100),className:"p-1.5 rounded hover:bg-gray-200 text-gray-600 text-xs","aria-label":"Reset zoom",children:"Reset"})]}),C?e.jsxs("button",{onClick:C,className:"flex items-center gap-1.5 px-3 py-1.5 bg-brand-navy text-brand-cream rounded-lg hover:bg-brand-navy/90 text-sm",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Download"]}):e.jsxs("a",{href:t,download:a,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-1.5 px-3 py-1.5 bg-brand-navy text-brand-cream rounded-lg hover:bg-brand-navy/90 text-sm",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Download"]}),e.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"p-1.5 rounded hover:bg-gray-200 text-gray-600","aria-label":"Open in new tab",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})})}),e.jsx("button",{onClick:S,className:"p-1.5 rounded hover:bg-gray-200 text-gray-600","aria-label":"Close preview",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),e.jsxs("div",{className:"flex-1 overflow-auto bg-gray-100 relative min-h-[400px]",children:[w&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 border-4 border-brand-navy/20 border-t-brand-navy rounded-full animate-spin"}),e.jsx("p",{className:"text-sm text-[var(--muted)]",children:"Loading preview..."})]})}),O&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-8 h-8 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsx("p",{className:"text-[var(--text)] font-medium mb-1",children:O}),e.jsx("p",{className:"text-sm text-[var(--muted)]",children:"Try downloading the file instead"})]})}),z?V==="pdf"?e.jsx("iframe",{src:`${t}#toolbar=1&navpanes=0`,className:"w-full h-full min-h-[500px]",title:`Preview of ${a}`,onLoad:$,onError:m}):V==="img"?e.jsx("div",{className:"flex items-center justify-center p-4 min-h-[400px]",children:e.jsx("img",{src:t,alt:a,className:"max-w-full max-h-full object-contain transition-transform duration-200",style:{transform:`scale(${J/100})`},onLoad:$,onError:m})}):null:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx(xt,{type:r,fileName:a,size:"lg",className:"mx-auto mb-4"}),e.jsx("p",{className:"text-[var(--text)] font-medium mb-1",children:"Preview not available"}),e.jsx("p",{className:"text-sm text-[var(--muted)] mb-4",children:"This file type cannot be previewed in the browser"}),e.jsxs("a",{href:t,download:a,className:"inline-flex items-center gap-2 px-4 py-2 bg-brand-navy text-brand-cream rounded-lg hover:bg-brand-navy/90",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Download File"]})]})})]}),e.jsxs("div",{className:"px-4 py-2 border-t border-gray-200 bg-gray-50 text-xs text-[var(--muted)] flex items-center justify-between",children:[e.jsx("span",{children:"Press ESC to close"}),V==="img"&&e.jsx("span",{children:"+/- to zoom, 0 to reset"})]})]})}),document.body)},gs={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},bs=({filters:t,onFiltersChange:a,statusOptions:r=[],originatorOptions:p=[],searchPlaceholder:d="Search requests...",showAdvanced:S=!0,className:C=""})=>{var N;const[w,R]=s.useState(!1),O=s.useRef(null),_=s.useMemo(()=>{let b=0;return t.status.length>0&&b++,t.dateFrom&&b++,t.dateTo&&b++,t.originatorId&&b++,b},[t]),J=s.useCallback(b=>{a({...t,search:b.target.value})},[t,a]),f=s.useCallback(b=>{const I=t.status.includes(b)?t.status.filter(H=>H!==b):[...t.status,b];a({...t,status:I})},[t,a]),V=s.useCallback(b=>{a({...t,dateFrom:b.target.value})},[t,a]),z=s.useCallback(b=>{a({...t,dateTo:b.target.value})},[t,a]),$=s.useCallback(b=>{a({...t,originatorId:b.target.value})},[t,a]),m=s.useCallback(()=>{var b;a(gs),(b=O.current)==null||b.focus()},[a]),K=s.useCallback(()=>{var b;a({...t,search:""}),(b=O.current)==null||b.focus()},[t,a]);s.useEffect(()=>{const b=I=>{var H;(I.metaKey||I.ctrlKey)&&I.key==="k"&&(I.preventDefault(),(H=O.current)==null||H.focus())};return document.addEventListener("keydown",b),()=>document.removeEventListener("keydown",b)},[]);const W=t.search||_>0;return e.jsxs("div",{className:`space-y-3 ${C}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{ref:O,type:"text",value:t.search,onChange:J,placeholder:d,className:"block w-full pl-10 pr-10 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold bg-[var(--surface)] text-[var(--text)]","aria-label":"Search"}),t.search&&e.jsx("button",{onClick:K,className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600","aria-label":"Clear search",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute inset-y-0 right-8 flex items-center pointer-events-none text-xs text-gray-400",children:e.jsx("kbd",{className:"hidden sm:inline-block px-1.5 py-0.5 bg-gray-100 rounded border border-gray-200 font-mono",children:"⌘K"})})]}),S&&e.jsxs("button",{onClick:()=>R(!w),className:`
              flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors
              ${w||_>0?"bg-brand-gold/10 border-brand-gold text-brand-navy":"border-brand-navy/30 text-[var(--text)] hover:bg-brand-cream/50"}
            `,"aria-expanded":w,"aria-controls":"filter-panel",children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"})}),e.jsx("span",{className:"hidden sm:inline",children:"Filters"}),_>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-brand-navy rounded-full",children:_})]}),W&&e.jsxs("button",{onClick:m,className:"flex items-center gap-1 px-3 py-2 text-sm text-brand-red hover:text-brand-red-2 hover:bg-red-50 rounded-lg transition-colors","aria-label":"Clear all filters",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),S&&w&&e.jsxs("div",{id:"filter-panel",className:"p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[r.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Status"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:r.map(b=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-white/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.status.includes(b.value),onChange:()=>f(b.value),className:"h-4 w-4 text-brand-navy border-gray-300 rounded focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-[var(--text)]",children:b.label})]},b.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Date Range"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"From date"}),e.jsx("input",{type:"date",value:t.dateFrom,onChange:V,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"From date"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"To date"}),e.jsx("input",{type:"date",value:t.dateTo,onChange:z,min:t.dateFrom,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"To date"})]})]})]}),p.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Originator"}),e.jsxs("select",{value:t.originatorId,onChange:$,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"Filter by originator",children:[e.jsx("option",{value:"",children:"All originators"}),p.map(b=>e.jsx("option",{value:b.value,children:b.label},b.value))]})]})]}),_>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 pt-2 border-t border-brand-navy/10",children:[e.jsx("span",{className:"text-sm text-[var(--muted)]",children:"Active filters:"}),t.status.map(b=>{const I=r.find(H=>H.value===b);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[(I==null?void 0:I.label)||b,e.jsx("button",{onClick:()=>f(b),className:"hover:text-brand-red","aria-label":`Remove ${(I==null?void 0:I.label)||b} filter`,children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},b)}),t.dateFrom&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["From: ",t.dateFrom,e.jsx("button",{onClick:()=>a({...t,dateFrom:""}),className:"hover:text-brand-red","aria-label":"Remove from date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.dateTo&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["To: ",t.dateTo,e.jsx("button",{onClick:()=>a({...t,dateTo:""}),className:"hover:text-brand-red","aria-label":"Remove to date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.originatorId&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[((N=p.find(b=>b.value===t.originatorId))==null?void 0:N.label)||"Originator",e.jsx("button",{onClick:()=>a({...t,originatorId:""}),className:"hover:text-brand-red","aria-label":"Remove originator filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]})]})};function fs(t,a){return s.useMemo(()=>{let r=a.items;if(t.search){const p=t.search.toLowerCase();r=r.filter(d=>a.getSearchText(d).toLowerCase().includes(p))}return t.status.length>0&&a.getStatus&&(r=r.filter(p=>t.status.includes(a.getStatus(p)))),(t.dateFrom||t.dateTo)&&a.getDate&&(r=r.filter(p=>{const d=a.getDate(p);if(!d)return!1;const S=new Date(d);if(isNaN(S.getTime()))return!1;if(t.dateFrom){const C=new Date(t.dateFrom);if(S<C)return!1}if(t.dateTo){const C=new Date(t.dateTo);if(C.setHours(23,59,59,999),S>C)return!1}return!0})),t.originatorId&&a.getOriginatorId&&(r=r.filter(p=>a.getOriginatorId(p)===t.originatorId)),r},[t,a])}function St(t){if(t==null)return"";const a=String(t);return a.includes('"')||a.includes(",")||a.includes(`
`)||a.includes("\r")?`"${a.replace(/"/g,'""')}"`:a}function vs(t,a){const p=a.map(S=>St(S.header)).join(","),d=t.map(S=>a.map(C=>{const w=C.getValue(S),R=C.format?C.format(w):w;return St(R)}).join(","));return[p,...d].join(`\r
`)}function ys(t,a){const r=t.map(p=>{const d={};return a.forEach(S=>{const C=S.getValue(p);d[S.header]=S.format?S.format(C):C}),d});return JSON.stringify(r,null,2)}function Ct(t,a,r){const p=new Blob([t],{type:`${r};charset=utf-8;`}),d=URL.createObjectURL(p),S=document.createElement("a");S.href=d,S.download=a,document.body.appendChild(S),S.click(),document.body.removeChild(S),URL.revokeObjectURL(d)}function js({items:t,columns:a,filename:r="export",label:p="Export",variant:d="secondary",className:S="",disabled:C=!1,showCount:w=!0,formats:R=["csv"]}){const[O,_]=s.useState(!1),[J,f]=s.useState(!1),V=s.useRef(null),z=s.useCallback(K=>{f(!0),_(!1),setTimeout(()=>{try{const W=new Date().toISOString().slice(0,10),N=`${r}_${W}`;if(K==="csv"){const b=vs(t,a);Ct(b,`${N}.csv`,"text/csv")}else{const b=ys(t,a);Ct(b,`${N}.json`,"application/json")}}catch(W){console.error("Export failed:",W)}finally{f(!1)}},100)},[t,a,r]);s.useEffect(()=>{const K=W=>{V.current&&!V.current.contains(W.target)&&_(!1)};return O&&document.addEventListener("mousedown",K),()=>{document.removeEventListener("mousedown",K)}},[O]),s.useEffect(()=>{const K=W=>{W.key==="Escape"&&_(!1)};return O&&document.addEventListener("keydown",K),()=>{document.removeEventListener("keydown",K)}},[O]);const $={primary:"bg-brand-navy text-brand-cream hover:bg-brand-navy/90",secondary:"bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold/10",text:"text-brand-navy hover:bg-brand-cream/50"},m=C||t.length===0||J;return R.length===1?e.jsxs("button",{onClick:()=>z(R[0]),disabled:m,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${$[d]}
          ${S}
        `,children:[J?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:p}),w&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]})]}):e.jsxs("div",{className:"relative",ref:V,children:[e.jsxs("button",{onClick:()=>_(!O),disabled:m,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${$[d]}
          ${S}
        `,"aria-expanded":O,"aria-haspopup":"menu",children:[J?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:p}),w&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${O?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),O&&e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-[var(--surface)] border border-brand-navy/20 rounded-lg shadow-lg z-50",role:"menu",children:[R.includes("csv")&&e.jsxs("button",{onClick:()=>z("csv"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 first:rounded-t-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export as CSV"]}),R.includes("json")&&e.jsxs("button",{onClick:()=>z("json"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 last:rounded-b-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})}),"Export as JSON"]})]})]})}const At=t=>{if(!t)return"";const a=new Date(t);return isNaN(a.getTime())?"":a.toLocaleDateString()};function pt(t,a={}){const{pageSize:r=25,initialPage:p=1}=a,[d,S]=s.useState(p),[C,w]=s.useState(r),R=t.length,O=Math.ceil(R/C),_=(d-1)*C,J=Math.min(_+C,R);return{currentData:s.useMemo(()=>t.slice(_,J),[t,_,J]),currentPage:d,pageSize:C,totalPages:O,totalItems:R,goToPage:N=>{const b=Math.max(1,Math.min(N,O));S(b)},nextPage:()=>{d<O&&S(d+1)},previousPage:()=>{d>1&&S(d-1)},goToFirstPage:()=>{S(1)},goToLastPage:()=>{S(O)},setPageSize:N=>{w(N),S(1)},canGoNext:d<O,canGoPrevious:d>1,startIndex:_+1,endIndex:J}}const Ze="edms-docs";function Ns(){return{uploadFile:async(S,C)=>{if(!ke)return{url:"",error:"Supabase not configured"};try{const{error:w}=await ke.storage.from(Ze).upload(C,S,{upsert:!0});if(w)return{url:"",error:w.message};const{data:R}=ke.storage.from(Ze).getPublicUrl(C);return{url:(R==null?void 0:R.publicUrl)||""}}catch(w){return{url:"",error:w instanceof Error?w.message:"Upload failed"}}},deleteFile:async S=>{if(!ke||!S)return!1;try{return await ke.storage.from(Ze).remove([S]),!0}catch{return!1}},deleteFolder:async S=>{if(!ke)return!1;try{const{data:C}=await ke.storage.from(Ze).list(S.replace(/\/$/,""));if(C&&C.length>0){const w=C.map(R=>`${S.replace(/\/$/,"")}/${R.name}`);await ke.storage.from(Ze).remove(w)}return!0}catch{return!1}},extractStoragePath:S=>{if(!S)return null;try{const C=S.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(C!=null&&C[1])return decodeURIComponent(C[1])}catch{}return null},buildStoragePath:(S,C,w,R)=>{const O=Date.now();return`${S||"N-A"}/${C}/${O}-${R}-${Pt(w)}`}}}const st=t=>{const a=String(t||"").trim();return a&&a!=="N/A"?a:""},kt=(t,a,r)=>t.some(p=>String(p.role||"")!==a||st(p.roleCompany||p.company)!==r.company||a==="PLATOON_REVIEWER"&&st(p.rolePlatoon||p.platoon)!==(r.platoon||"")?!1:String(p.unitUic||"")===String(r.uic||""));function Tt(t){if(t===0)return"0 Bytes";const a=1024,r=["Bytes","KB","MB","GB"],p=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,p)).toFixed(2))+" "+r[p]}const Et=s.memo(function({doc:a,onView:r,onDelete:p}){const[d,S]=s.useState(!1),C=a.fileUrl&&qt(a.type,a.name);return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:"flex items-center justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors","aria-label":`Document: ${a.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(xt,{type:a.type,fileName:a.name,size:"md"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-[var(--text)]",children:a.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)]",children:[a.name," • ",Tt(a.size)," • ",new Date(a.uploadedAt).toLocaleDateString()]}),a.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(a.dueDate).toLocaleDateString()]}),a.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Notes: ",a.notes]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",role:"group","aria-label":"Document actions",children:[a.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:os({currentStage:a.currentStage})}),C&&e.jsx("button",{type:"button",onClick:w=>{w.stopPropagation(),S(!0)},className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Preview document ${a.name}`,children:"Preview"}),a.fileUrl&&e.jsx("a",{href:a.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${a.name} in new tab`,children:"Open"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:w=>{w.stopPropagation(),r(a)},"aria-label":`View or edit document ${a.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:w=>{w.stopPropagation(),p(a)},"aria-label":`Delete document ${a.subject}`,children:"Delete"})]})]}),a.fileUrl&&e.jsx(hs,{url:a.fileUrl,fileName:a.name,mimeType:a.type,fileSize:a.size,isOpen:d,onClose:()=>S(!1)})]})}),ze="edms-docs",ws=({selectedUnit:t,currentUser:a})=>{const[r,p]=s.useState([]),[d,S]=s.useState(!1),[C,w]=s.useState(""),[R,O]=s.useState(""),[_,J]=s.useState(""),[f,V]=s.useState([]),[z,$]=s.useState(null),[m,K]=s.useState(null),[W,N]=s.useState([]),[b,I]=s.useState(!1),[H,x]=s.useState(null),[M,T]=s.useState(""),[D,G]=s.useState(""),[v,h]=s.useState(""),[U,q]=s.useState([]),[X,Z]=s.useState([]),[F,he]=s.useState(null),[ye,Se]=s.useState(""),[A,Q]=s.useState(""),[te,ae]=s.useState(""),[ee,pe]=s.useState([]),[y,B]=s.useState(!1),[le,ce]=s.useState({}),[xe,ge]=s.useState(""),[Ce,je]=s.useState("Pending"),De=Ns(),i=o=>{const k=o.target.files?Array.from(o.target.files):[];if(k.length===0)return;if(f.length+k.length>jt){$({type:"error",message:`Cannot add ${k.length} file(s). Maximum ${jt} files allowed per request.`});try{o.target.value=""}catch{}return}const L=[],ie=[];for(const ne of k){const se=Qt(ne);se.valid?L.push(ne):ie.push(...se.errors)}L.length>0&&V(ne=>[...ne,...L]),ie.length>0&&$({type:"error",message:ie.slice(0,3).join(" ")+(ie.length>3?` (+${ie.length-3} more errors)`:"")});try{o.target.value=""}catch{}},j=async()=>{if(!F||!(m!=null&&m.id)||F.uploadedById!==m.id)return;const o={actor:`${m.rank} ${m.lastName}, ${m.firstName}${m.mi?` ${m.mi}`:""}`,timestamp:new Date().toISOString(),action:"Archived by Originator",comment:(te||"").trim()},k={...F,currentStage:Ke.ARCHIVED,finalStatus:"Archived",activity:Array.isArray(F.activity)?[...F.activity,o]:[o]};try{const L=await _e(k);if(!L.ok)throw new Error(Y(L,"request_upsert_failed"));Z(ie=>ie.map(ne=>ne.id===k.id?k:ne)),he(k),$({type:"success",message:"Request archived."})}catch(L){$({type:"error",message:`Failed to archive: ${String((L==null?void 0:L.message)||L)}`})}},c=async o=>{o.preventDefault(),$(null);const k=C.trim();if(!k){$({type:"error",message:"Subject is required."});return}if(k.length>500){$({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(_.length>5e3){$({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(m!=null&&m.id)){$({type:"error",message:"Create a profile before submitting."});return}if(f.length>0){const be=Ut(f);if(!be.valid){$({type:"error",message:be.errors[0]});return}}S(!0);const L=Date.now(),ie=xe||m.id,ne=W.find(be=>be.id===ie),se=t?t.uic:(ne==null?void 0:ne.unitUic)||"N/A",ve=`req-${L}`;let ue=[];async function Me(be,Ie){if(!ke)throw new Error("Supabase not configured");const{error:Re}=await ke.storage.from(ze).upload(Ie,be,{upsert:!0});if(Re)throw new Error(Re.message);const{data:Fe}=ke.storage.from(ze).getPublicUrl(Ie);return(Fe==null?void 0:Fe.publicUrl)||""}if(f&&f.length>0){const be=[];for(let Ie=0;Ie<f.length;Ie++){const Re=f[Ie],Fe=`${se}/${ve}/${L}-${Ie}-${Pt(Re.name)}`;try{const $e=await Me(Re,Fe);be.push($e)}catch($e){S(!1),$({type:"error",message:`Failed to upload ${Re.name}: ${String(($e==null?void 0:$e.message)||$e)}`});return}}ue=f.map((Ie,Re)=>({id:`${L}-${Re}`,name:Ie.name,type:Ie.type,size:Ie.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:se,subject:C.trim(),dueDate:R||void 0,notes:_.trim()||void 0,uploadedById:ie,currentStage:"PLATOON_REVIEW",fileUrl:be[Re]}))}ue=ue.map(be=>({...be,requestId:ve})),p(be=>[...be,...ue]),V([]),w(""),O(""),J("");try{const be=m?`${m.rank} ${m.lastName}, ${m.firstName}${m.mi?` ${m.mi}`:""}`:"Unknown",Ie=se,Re=st(ne==null?void 0:ne.company),Fe=st(ne==null?void 0:ne.platoon),$e=kt(W,"PLATOON_REVIEWER",{company:Re,platoon:Fe,uic:Ie}),rt=kt(W,"COMPANY_REVIEWER",{company:Re,uic:Ie}),He={id:ve,subject:C.trim(),dueDate:R||void 0,notes:_.trim()||void 0,unitUic:se,uploadedById:ie,submitForUserId:ie,documentIds:ue.map(Ae=>Ae.id),createdAt:new Date().toISOString(),currentStage:$e?Ke.PLATOON_REVIEW:rt?Ke.COMPANY_REVIEW:Ke.BATTALION_REVIEW,activity:[{actor:be,timestamp:new Date().toISOString(),action:"Submitted request",comment:(_||"").trim()}]};try{const Ae=await _e(He);if(!Ae.ok)throw new Error(Y(Ae,"request_upsert_failed"));const n=await ct(ue);if(!n.ok)throw new Error(Y(n,"document_upsert_failed"))}catch(Ae){S(!1);try{it("request_persist_failed",{requestId:ve,error:String((Ae==null?void 0:Ae.message)||Ae)},"error")}catch{}$({type:"error",message:`Failed to persist submission: ${String((Ae==null?void 0:Ae.message)||Ae)}`});return}Z(Ae=>Ae.some(l=>l.id===He.id)?Ae.map(l=>l.id===He.id?He:l):[...Ae,He]),S(!1),$({type:"success",message:"Submission successful."}),I(!1)}catch{S(!1);try{it("request_persist_failed",{requestId:ve},"error")}catch{}$({type:"error",message:"Failed to persist submission."})}},g=s.useCallback(o=>{x(o),T(o.subject||""),G(o.dueDate||""),h(o.notes||"");try{const k=localStorage.getItem(`fs/requests/${o.requestId}.json`);if(k){const L=JSON.parse(k);q(Array.isArray(L.activity)?L.activity:[])}else{const ne=Object.values(Object.assign({})).map(se=>(se==null?void 0:se.default)??se).find(se=>se&&se.id===o.requestId);q(ne&&Array.isArray(ne.activity)?ne.activity:[])}}catch{q([])}},[]),Y=(o,k)=>{var L;return String(((L=o.error)==null?void 0:L.message)||o.error||k)},E=async()=>{if(!H)return;const o=r.map(k=>k.id===H.id?{...k,subject:M.trim()||k.subject,dueDate:D||void 0,notes:v.trim()||void 0}:k);p(o);try{const L={actor:m?`${m.rank} ${m.lastName}, ${m.firstName}${m.mi?` ${m.mi}`:""}`:"Unknown",timestamp:new Date().toISOString(),action:"Updated document",comment:(v||"").trim()},ie=H.requestId?X.find(ne=>ne.id===H.requestId):null;if(ie){const ne={...ie,activity:Array.isArray(ie.activity)?[...ie.activity,L]:[L]};try{const se=await _e(ne);if(!se.ok)throw new Error(Y(se,"request_upsert_failed"))}catch(se){console.error("Failed to save document edits:",se),$({type:"error",message:`Failed to save document edits: ${se.message}`});return}q(se=>[...se,L])}}catch{}h(""),x(null)};r.filter(o=>!(!(m!=null&&m.id)||m.role==="MEMBER"&&o.uploadedById!==m.id||o.type==="request"));const me=()=>String((m==null?void 0:m.role)||"").includes("REVIEW"),de=()=>{if(!me())return[];const o=String((m==null?void 0:m.role)||"");return W.filter(k=>{if(k.id===(m==null?void 0:m.id))return!1;if(o.includes("PLATOON")){const L=k.company&&k.company!=="N/A"?k.company:"",ie=k.unit&&k.unit!=="N/A"?k.unit:"",ne=m!=null&&m.company&&m.company!=="N/A"?m.company:"",se=m!=null&&m.unit&&m.unit!=="N/A"?m.unit:"";return L===ne&&ie===se}if(o.includes("COMPANY")){const L=k.company&&k.company!=="N/A"?k.company:"",ie=m!=null&&m.company&&m.company!=="N/A"?m.company:"";return L===ie}return o.includes("COMMANDER")?(k.unitUic||"")===((m==null?void 0:m.unitUic)||""):!1})},Ee=s.useCallback(async o=>{const k=De.extractStoragePath(o.fileUrl);try{k&&ke&&await ke.storage.from(ze).remove([k])}catch{}try{await Xt(o.id),p(L=>L.filter(ie=>ie.id!==o.id)),o.requestId&&Z(L=>L.map(ie=>ie.id===o.requestId?{...ie,documentIds:(ie.documentIds||[]).filter(ne=>ne!==o.id)}:ie)),$({type:"success",message:"Document deleted."})}catch(L){$({type:"error",message:`Failed to delete: ${String((L==null?void 0:L.message)||L)}`})}},[]),Te=s.useCallback(async o=>{const k=`${o.unitUic||"N-A"}/${o.id}/`;try{if(ke){const{data:L}=await ke.storage.from(ze).list(k.slice(0,-1));if(L&&L.length>0){const ie=L.map(ne=>`${k.slice(0,-1)}/${ne.name}`);await ke.storage.from(ze).remove(ie)}}}catch{}try{await es(o.id),await ts(o.id),p(L=>L.filter(ie=>ie.requestId!==o.id)),Z(L=>L.filter(ie=>ie.id!==o.id)),he(null),$({type:"success",message:"Request and files deleted."})}catch(L){$({type:"error",message:`Failed to delete request: ${String((L==null?void 0:L.message)||L)}`})}},[]),Pe=async()=>{if(!F||!(m!=null&&m.id)||F.uploadedById!==m.id){$({type:"error",message:"Only the requester can edit this."});return}const o=Date.now(),k=ve=>ve.replace(/[^A-Za-z0-9._-]/g,"-");async function L(ve,ue){if(!ke)throw new Error("Supabase not configured");const{error:Me}=await ke.storage.from(ze).upload(ue,ve,{upsert:!0});if(Me)throw new Error(Me.message);const{data:be}=ke.storage.from(ze).getPublicUrl(ue);return(be==null?void 0:be.publicUrl)||""}const ie=[];for(let ve=0;ve<ee.length;ve++){const ue=ee[ve],Me=`${F.unitUic||"N-A"}/${F.id}/${o}-${ve}-${k(ue.name)}`;try{const be=await L(ue,Me);ie.push(be)}catch(be){$({type:"error",message:`Failed to upload ${ue.name}: ${String((be==null?void 0:be.message)||be)}`});return}}const ne=ee.map((ve,ue)=>({id:`${o}-${ue}`,name:ve.name,type:ve.type,size:ve.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:F.unitUic||"N/A",subject:ye.trim()||F.subject,dueDate:A||void 0,notes:te.trim()||void 0,uploadedById:m.id,currentStage:F.currentStage||"PLATOON_REVIEW",requestId:F.id,fileUrl:ie[ue]})),se={...F,subject:ye.trim()||F.subject,dueDate:A||void 0,notes:te.trim()||void 0,documentIds:[...F.documentIds||[],...ne.map(ve=>ve.id)],activity:[...F.activity||[],{actor:`${m.rank} ${m.lastName}, ${m.firstName}${m.mi?` ${m.mi}`:""}`,timestamp:new Date().toISOString(),action:ne.length?`Updated request and added ${ne.length} document(s)`:"Updated request",comment:(te||"").trim()}]};try{if(!(m&&ls(F,String(m.id||"")))){$({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const ue=await ct(ne);if(!ue.ok)throw new Error(Y(ue,"document_upsert_failed"));const Me=await _e(se);if(!Me.ok)throw new Error(Y(Me,"request_upsert_failed"))}catch(ue){try{it("request_update_failed",{requestId:se.id,error:String((ue==null?void 0:ue.message)||ue)},"error")}catch{}$({type:"error",message:`Failed to persist documents: ${String((ue==null?void 0:ue.message)||ue)}`});return}p(ue=>[...ue,...ne]),Z(ue=>ue.map(Me=>Me.id===se.id?se:Me)),he(se),pe([]),ae(""),$({type:"success",message:ne.length?"Files added and request updated.":"Request updated."})}catch{$({type:"error",message:"Failed to update request."})}},[Oe,Be]=s.useState(!0),[We,Qe]=s.useState(!0);s.useEffect(()=>{gt().then(o=>{p(o)}).catch(()=>p([])).finally(()=>Be(!1))},[]),s.useEffect(()=>{F&&(Se(F.subject||""),Q(F.dueDate||""),ae(F.notes||""),pe([]))},[F]),s.useEffect(()=>{},[r]),s.useEffect(()=>{nt().then(o=>{Z(o)}).catch(()=>Z([])).finally(()=>Qe(!1))},[]),s.useEffect(()=>{K(a||null)},[a]),s.useEffect(()=>{Ue().then(o=>{N(o)}).catch(()=>N([]))},[]);const Je=s.useMemo(()=>{if(!(m!=null&&m.id))return[];const o=X.filter(k=>k.uploadedById===m.id);return Ce==="Pending"?o.filter(k=>k.currentStage!=="ARCHIVED"):o.filter(k=>k.currentStage==="ARCHIVED")},[X,m,Ce]),we=pt(Je,{pageSize:10}),u=s.useMemo(()=>W.reduce((o,k)=>({...o,[k.id]:k}),{}),[W]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>I(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),b&&e.jsxs("form",{onSubmit:c,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:C,onChange:o=>w(o.target.value),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${C.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:R,onChange:o=>O(o.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),String((m==null?void 0:m.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:xe,onChange:o=>ge(o.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),de().map(o=>e.jsxs("option",{value:o.id,children:[o.rank," ",o.lastName,", ",o.firstName,o.mi?` ${o.mi}`:""]},o.id))]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:_,onChange:o=>J(o.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:i,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:f.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:f.map((o,k)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:o.name,children:o.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>V(L=>L.filter((ie,ne)=>ne!==k)),children:"Delete"})]},k))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{I(!1),V([]),w(""),O(""),J(""),$(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!C.trim(),children:"Submit"})]})]}),z&&e.jsx("div",{className:`p-3 rounded-lg border ${z.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:z.message})]})]}),e.jsxs("div",{className:"p-6",children:[m&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>je("Pending"),className:`${Ce==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>je("Archived"),className:`${Ce==="Archived"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Archived"})]})}),e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:we.totalItems>0?`${we.startIndex}–${we.endIndex} of ${we.totalItems}`:""}),We&&e.jsx("div",{className:"animate-pulse",children:"Loading requests…"})]}),e.jsx(Ge,{title:"Your Requests",requests:We?Array.from({length:5}).map((o,k)=>({id:`s-${k}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:Ke.PLATOON_REVIEW})):we.currentData,users:u,onRowClick:o=>he(o),expandedRows:le,children:o=>e.jsxs("div",{id:`req-docs-${o.id}`,children:[Oe?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):r.filter(k=>k.requestId===o.id&&k.type!=="request").map(k=>e.jsx(Et,{doc:k,onView:g,onDelete:Ee},k.id)),!Oe&&r.filter(k=>k.requestId===o.id&&k.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),we.totalItems>0&&e.jsx(ut,{currentPage:we.currentPage,totalPages:we.totalPages,totalItems:we.totalItems,pageSize:we.pageSize,startIndex:we.startIndex,endIndex:we.endIndex,onPageChange:we.goToPage,onPageSizeChange:we.setPageSize,onNext:we.nextPage,onPrevious:we.previousPage,onFirst:we.goToFirstPage,onLast:we.goToLastPage,canGoNext:we.canGoNext,canGoPrevious:we.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),d&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),H&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>x(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:M,onChange:o=>T(o.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:D,onChange:o=>G(o.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:H.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:v,onChange:o=>h(o.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[H.name," • ",Tt(H.size)," • ",new Date(H.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:U.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):U.map((o,k)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[o.actor," • ",new Date(o.timestamp).toLocaleString()," • ",o.action]}),o.comment&&e.jsx("div",{className:"text-gray-600",children:o.comment})]},k))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>x(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:E,children:"Save"})]})]})}),F&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>he(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>he(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:ye,onChange:o=>Se(o.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(F.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:A,onChange:o=>Q(o.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),F.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:F.currentStage}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:3,value:te,onChange:o=>ae(o.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:F.activity&&F.activity.length?F.activity.map((o,k)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[o.actor," • ",new Date(o.timestamp).toLocaleString()," • ",o.action]}),o.comment&&e.jsx("div",{className:"text-gray-600",children:o.comment})]},k)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Documents"}),e.jsxs("button",{className:"mt-2 px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-expanded":y,"aria-controls":"docs-panel",onClick:()=>B(o=>!o),children:[y?"Hide":"Show"," Documents"]}),e.jsx("div",{id:"docs-panel",className:y?"mt-3 space-y-2":"hidden",children:r.filter(o=>o.requestId===F.id&&o.type!=="request").map(o=>e.jsx(Et,{doc:o,onView:g,onDelete:Ee},o.id))}),!wt(F,String((m==null?void 0:m.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:o=>{const k=o.target.files?Array.from(o.target.files):[];pe(L=>[...L,...k]);try{o.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:ee.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):ee.map((o,k)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:o.name,children:o.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>pe(L=>L.filter((ie,ne)=>ne!==k)),children:"Delete"})]},k))})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>he(null),children:"Close"}),wt(F,String((m==null?void 0:m.id)||""))?e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-gold text-brand-charcoal hover:brightness-110",onClick:j,children:"Archive"}):e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:Pe,disabled:!m||m.id!==((F==null?void 0:F.uploadedById)||""),children:"Save Changes"}),m&&m.id===((F==null?void 0:F.uploadedById)||"")&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>Te(F),children:"Delete Request"})]})]})})]})},Ss=({currentUser:t,onClose:a})=>{const[r,p]=s.useState([]),[d,S]=s.useState(""),[C,w]=s.useState(!1),[R,O]=s.useState(""),[_,J]=s.useState(!1),[f,V]=s.useState("");s.useEffect(()=>{bt().then(N=>{p(N)}).catch(()=>p([]))},[]);const z=s.useMemo(()=>String(t.role||"")!=="MEMBER",[t]),$=s.useMemo(()=>{const N=b=>{const I=t.unitUic||"",H=String(t.role||"");if(H.includes("PLATOON")){const x=b.company&&b.company!=="N/A"?b.company:"",M=b.platoon&&b.platoon!=="N/A"?b.platoon:"",T=t.company&&t.company!=="N/A"?t.company:"",D=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return x===T&&M===D}if(H.includes("COMPANY")){const x=b.company&&b.company!=="N/A"?b.company:"",M=t.company&&t.company!=="N/A"?t.company:"";return x===M}return H.includes("COMMANDER")?(b.unitUic||"")===I:!1};return r.filter(b=>b.id!==t.id&&N(b))},[r,t]),m=s.useMemo(()=>{const N=String(t.role||""),b=I=>{const H=t.unitUic||"";if(N.includes("PLATOON")){const x=I.company&&I.company!=="N/A"?I.company:"",M=I.platoon&&I.platoon!=="N/A"?I.platoon:"",T=t.company&&t.company!=="N/A"?t.company:"",D=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return x===T&&M===D}if(N.includes("COMPANY")){const x=I.company&&I.company!=="N/A"?I.company:"",M=t.company&&t.company!=="N/A"?t.company:"";return x===M}return N.includes("COMMANDER")?(I.unitUic||"")===H:!1};return r.filter(I=>I.id!==t.id&&b(I)&&String(I.role||"")===N)},[r,t]),K=async()=>{try{w(!0),O("");const N=r.find(x=>x.id===d);if(!z||!N){w(!1);return}const b=String(t.role||""),I={...N};if(I.role=b,b.includes("PLATOON")){I.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A";const x=t.platoon&&t.platoon!=="N/A"?t.platoon:"N/A";I.rolePlatoon=x}else b.includes("COMPANY")?(I.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A",I.rolePlatoon="N/A"):b.includes("COMMANDER")&&(I.roleCompany="N/A",I.rolePlatoon="N/A");try{if(!(await Ve({id:I.id,email:I.email,rank:I.rank,firstName:I.firstName,lastName:I.lastName,mi:I.mi,service:I.service,role:I.role,unitUic:I.unitUic,unit:I.unit,company:I.company,isUnitAdmin:!!I.isUnitAdmin,isCommandStaff:!!I.isCommandStaff,edipi:I.edipi,passwordHash:I.passwordHash,roleCompany:I.roleCompany,rolePlatoon:I.rolePlatoon})).ok)throw new Error("persist_failed")}catch{O("Failed to persist user changes")}const H={actorId:t.id,actorRole:t.role,targetId:I.id,grantedRole:I.role,timestamp:new Date().toISOString(),scope:{unitUic:t.unitUic||"",company:t.company,unit:t.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(H)})}catch{}p(x=>x.map(M=>M.id===I.id?I:M)),S(""),J(!1),w(!1)}catch{w(!1),O("Operation failed")}},W=async N=>{try{w(!0),O("");const b=r.find(T=>T.id===N);if(!b){w(!1);return}const I=String(t.role||"");if(!m.some(T=>T.id===N)){w(!1),O("Target not in scope");return}const x={...b};x.role="MEMBER",x.company="N/A",x.unit="N/A",x.isCommandStaff=!1,x.roleCompany="N/A",x.rolePlatoon="N/A";try{if(!(await Ve({id:x.id,email:x.email,rank:x.rank,firstName:x.firstName,lastName:x.lastName,mi:x.mi,service:x.service,role:x.role,unitUic:x.unitUic,unit:x.unit,company:x.company,isUnitAdmin:!!x.isUnitAdmin,isCommandStaff:!!x.isCommandStaff,edipi:x.edipi,passwordHash:x.passwordHash,roleCompany:x.roleCompany,rolePlatoon:x.rolePlatoon})).ok)throw new Error("persist_failed")}catch{O("Failed to persist user changes")}const M={actorId:t.id,actorRole:t.role,targetId:x.id,action:"Revoked",previousRole:I,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(M)})}catch{}p(T=>T.map(D=>D.id===x.id?x:D)),V(""),w(!1)}catch{w(!1),O("Operation failed")}};return z?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:a,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:N=>N.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:a,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:d,onChange:N=>S(N.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),$.map(N=>e.jsxs("option",{value:N.id,children:[N.rank," ",N.lastName,", ",N.firstName,N.mi?` ${N.mi}`:""," • ",N.email]},N.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[m.map(N=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[N.rank," ",N.lastName,", ",N.firstName,N.mi?` ${N.mi}`:""," • ",N.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>V(N.id),children:"Remove Access"})]},N.id)),m.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),R&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:R})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!d||C,onClick:()=>J(!0),children:"Grant Equivalent Permission"})}),_&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>J(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:C,onClick:K,children:"Confirm"})]})]}),f&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>V(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:C,onClick:()=>W(f),children:"Remove"})]})]})]})}):null},ot="ORIGINATOR_REVIEW",Le=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Cs=[{value:"PLATOON_REVIEW",label:"Platoon Review"},{value:"COMPANY_REVIEW",label:"Company Review"},{value:"BATTALION_REVIEW",label:"Battalion Review"},{value:"COMMANDER_REVIEW",label:"Commander Review"},{value:"ARCHIVED",label:"Archived"}],As={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},ks=t=>{const a=Le.indexOf(t||Le[0]);return a>=0&&a<Le.length-1?Le[a+1]:Le[a]||Le[0]},lt=t=>{const a=Le.indexOf(t||Le[0]);return a>0?Le[a-1]:Le[0]},Es=t=>{const a=t.activity&&t.activity.length?t.activity[t.activity.length-1]:null;return!!a&&/returned/i.test(String(a.action||""))},at=(t,a)=>{var r;return((r=t.activity)==null?void 0:r.some(p=>a.test(String(p.action||""))))||!1},Is=t=>at(t,/(approved by commander|commander.*approved)/i)&&!at(t,/installation commander/i),Ms=t=>at(t,/(endorsed by commander|commander.*endorsed)/i)&&!at(t,/installation commander/i);function Rs(){const t=Jt(),[a,r]=s.useState(()=>{try{const i=localStorage.getItem("currentUser");return i?JSON.parse(i):null}catch(i){return console.error("Failed to parse user from localStorage:",i),null}}),[p,d]=s.useState([]),[S,C]=s.useState([]),[w,R]=s.useState({}),[O,_]=s.useState({}),[J,f]=s.useState({}),[V,z]=s.useState({}),[$,m]=s.useState({}),[K,W]=s.useState({}),[N,b]=s.useState({}),[I,H]=s.useState(!1),[x,M]=s.useState({}),[T,D]=s.useState({}),[G,v]=s.useState(!1),[h,U]=s.useState({}),[q,X]=s.useState(null),Z=s.useRef(null),[F,he]=s.useState("Pending"),[ye,Se]=s.useState(As);s.useEffect(()=>{const i=c=>{q&&Z.current&&!Z.current.contains(c.target)&&(U(g=>({...g,[q]:!1})),X(null))},j=c=>{c.key==="Escape"&&q&&(U(g=>({...g,[q]:!1})),X(null))};return document.addEventListener("mousedown",i),document.addEventListener("keydown",j),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("keydown",j)}},[q]),s.useEffect(()=>{ss().then(i=>{d(i)}).catch(()=>d([]))},[]),s.useEffect(()=>{as().then(i=>{C(i)}).catch(()=>C([]))},[]),s.useEffect(()=>{bt().then(i=>{const j={};for(const c of i)c!=null&&c.id&&(j[c.id]=c);_(j)}).catch(()=>_({}))},[]),s.useEffect(()=>{try{const i=localStorage.getItem("unit_structure"),j={},c={};if(i){const g=JSON.parse(i);for(const Y of Object.keys(g||{})){const E=g[Y];E&&Array.isArray(E._sections)&&(j[Y]=E._sections),E&&E._platoonSectionMap&&typeof E._platoonSectionMap=="object"&&(c[Y]=E._platoonSectionMap)}}else(async()=>{try{const g=await vt();for(const Y of Object.keys(g||{})){const E=g[Y];E&&Array.isArray(E._sections)&&(j[Y]=E._sections),E&&E._platoonSectionMap&&typeof E._platoonSectionMap=="object"&&(c[Y]=E._platoonSectionMap)}}catch{}})();W(j),b(c)}catch{}},[]);const A=s.useMemo(()=>{const i=String((a==null?void 0:a.role)||"");return i.includes("PLATOON")?"PLATOON_REVIEW":i.includes("COMPANY")?"COMPANY_REVIEW":i.includes("BATTALION")?"BATTALION_REVIEW":i.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[a]),Q=i=>O[i.uploadedById]||null,te=i=>i&&i!=="N/A"?i:"",ae=i=>{var Y,E;const j=Q(i);if(!j)return!1;const c=String((a==null?void 0:a.role)||""),g=(a==null?void 0:a.unitUic)||"";if(c.includes("PLATOON")){const me=te(j.company),de=te(j.platoon),Ee=te(a==null?void 0:a.roleCompany),Te=te(a==null?void 0:a.rolePlatoon);return me===Ee&&de===Te&&(!g||j.unitUic===g)}if(c.includes("COMPANY")){const me=te(j.company),de=te(a==null?void 0:a.roleCompany);return me===de&&(!g||j.unitUic===g)}if(c.includes("BATTALION")){const me=te(a==null?void 0:a.company),de=te(a==null?void 0:a.platoon),Ee=((E=(Y=N[g])==null?void 0:Y[me])==null?void 0:E[de])||"";return i.routeSection?Ee?i.routeSection===Ee:!0:g?j.unitUic===g:!0}return c.includes("COMMANDER")&&g?j.unitUic===g:!0},ee=s.useMemo(()=>p.filter(ae),[p,a,O,N]),pe=s.useMemo(()=>{const i=new Map;for(const j of ee){const c=Q(j);if(c&&c.id&&!i.has(c.id)){const g=`${c.rank||""} ${c.lastName||""}, ${c.firstName||""}`.trim();i.set(c.id,{value:c.id,label:g||c.id})}}return Array.from(i.values()).sort((j,c)=>j.label.localeCompare(c.label))},[ee,O]),y=fs(ye,{items:ee,getSearchText:i=>`${i.subject||""} ${i.id||""} ${i.routeSection||""}`,getStatus:i=>i.currentStage||"PLATOON_REVIEW",getDate:i=>i.createdAt,getOriginatorId:i=>i.uploadedById}),B=s.useMemo(()=>y.filter(i=>(i.currentStage||"PLATOON_REVIEW")===A),[y,A]),le=s.useMemo(()=>y.filter(i=>(i.currentStage||"PLATOON_REVIEW")!==A),[y,A]),ce=pt(B,{pageSize:25}),xe=pt(le,{pageSize:25}),ge=i=>S.filter(j=>j.requestId===i),Ce=s.useMemo(()=>[{header:"Request ID",getValue:i=>i.id},{header:"Subject",getValue:i=>i.subject},{header:"Stage",getValue:i=>i.currentStage||""},{header:"Route Section",getValue:i=>i.routeSection||""},{header:"Originator",getValue:i=>{const j=Q(i);return j?`${j.rank||""} ${j.lastName||""}, ${j.firstName||""}${j.mi?` ${j.mi}`:""}`.trim():""}},{header:"Unit UIC",getValue:i=>i.unitUic||""},{header:"Created At",getValue:i=>i.createdAt,format:At},{header:"Due Date",getValue:i=>i.dueDate||"",format:At},{header:"Documents",getValue:i=>ge(i.id).map(j=>j.name).join(" | ")}],[O,S]),je=async(i,j,c)=>{const Y={actor:a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",timestamp:new Date().toISOString(),action:c,comment:(w[i.id]||"").trim()},E={...i,currentStage:j,routeSection:j==="BATTALION_REVIEW"&&$[i.id]?$[i.id]:i.routeSection,activity:Array.isArray(i.activity)?[...i.activity,Y]:[Y]};try{await _e(E),c.toLowerCase().includes("approved")?t.success("Request approved",{message:`"${i.subject}" advanced to next stage`}):c.toLowerCase().includes("return")?t.warning("Request returned",{message:`"${i.subject}" sent back for revision`}):c.toLowerCase().includes("archive")?t.info("Request archived",{message:`"${i.subject}" has been archived`}):t.success(c,{message:`Request "${i.subject}" updated`})}catch(me){t.error("Failed to update request",{message:String(me)})}d(me=>me.map(de=>de.id===E.id?E:de)),R(me=>({...me,[i.id]:""}))},De=async i=>{const j=V[i.id]||[];if(!j.length||!(a!=null&&a.id))return;const c=Date.now(),g=j.map((de,Ee)=>({id:`${c}-${Ee}`,name:de.name,type:de.type,size:de.size,uploadedAt:new Date().toISOString(),subject:i.subject,requestId:i.id,fileUrl:URL.createObjectURL(de)})),E={actor:a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",timestamp:new Date().toISOString(),action:`Reviewer added ${g.length} document(s)`,comment:(w[i.id]||"").trim()},me={...i,documentIds:[...i.documentIds||[],...g.map(de=>de.id)],activity:Array.isArray(i.activity)?[...i.activity,E]:[E]};try{await ct(g),await _e(me),t.success(`${g.length} file${g.length!==1?"s":""} added`,{message:`Documents added to "${i.subject}"`})}catch(de){t.error("Failed to add files",{message:String(de)})}C(de=>[...de,...g]),d(de=>de.map(Ee=>Ee.id===me.id?me:Ee)),z(de=>({...de,[i.id]:[]})),R(de=>({...de,[i.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((a==null?void 0:a.role)||"MEMBER")}),e.jsx(js,{items:[...B,...le],columns:Ce,filename:"review_requests",label:"Export",className:"hidden md:inline-flex"})]})]}),a&&String(a.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>H(!0),children:"Manage Permissions"})})]}),e.jsx(bs,{filters:ye,onFiltersChange:Se,statusOptions:Cs,originatorOptions:pe,searchPlaceholder:"Search requests by subject, ID, or section...",className:"mb-4"}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>he("Pending"),className:`${F==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>he("In Scope"),className:`${F==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[F==="Pending"&&e.jsx(Ge,{title:"Pending",requests:ce.currentData,users:O,onRowClick:i=>M(j=>({...j,[i.id]:!j[i.id]})),expandedRows:x,platoonSectionMap:N,children:i=>e.jsxs("div",{id:`details-rev-${i.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!h[i.id],"aria-controls":`docs-rev-${i.id}`,onClick:()=>{U(j=>({...j,[i.id]:!j[i.id]})),X(j=>h[i.id]?null:i.id)},onKeyDown:j=>{(j.key==="Enter"||j.key===" ")&&(j.preventDefault(),U(c=>({...c,[i.id]:!c[i.id]})),X(c=>h[i.id]?null:i.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${h[i.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-rev-${i.id}`,ref:h[i.id]?Z:void 0,className:`${h[i.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[ge(i.id).map(j=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:j.name}),e.jsx("div",{children:new Date(j.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:j.fileUrl?e.jsx("a",{href:j.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},j.id)),ge(i.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>f(j=>({...j,[i.id]:!j[i.id]})),"aria-expanded":!!J[i.id],"aria-controls":`logs-${i.id}`,children:[J[i.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${i.id}`,className:J[i.id]?"mt-2 space-y-2":"hidden",children:i.activity&&i.activity.length?i.activity.map((j,c)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[j.actor," • ",new Date(j.timestamp).toLocaleString()," • ",j.action]}),j.comment&&e.jsx("div",{className:"text-gray-600",children:j.comment})]},c)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:w[i.id]||"",onChange:j=>R(c=>({...c,[i.id]:j.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:j=>z(c=>({...c,[i.id]:j.target.files?Array.from(j.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(V[i.id]||[]).length?`${(V[i.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>De(i),disabled:!V[i.id]||!(V[i.id]||[]).length,children:"Save Files"}),Es(i)&&e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>je(i,i.currentStage==="PLATOON_REVIEW"?ot:lt(i.currentStage),"Returned to previous stage"),children:"Return to Previous"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>je(i,"ARCHIVED","Archived by Reviewer"),children:"Archive"})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[String((a==null?void 0:a.role)||"").includes("COMPANY")&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:$[i.id]||"",onChange:j=>m(c=>({...c,[i.id]:j.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(K[(a==null?void 0:a.unitUic)||""]||[]).map(j=>e.jsx("option",{value:j,children:j},j))]})]}),(()=>{const j=Is(i),c=Ms(i);return j||c?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>je(i,i.currentStage==="PLATOON_REVIEW"?ot:lt(i.currentStage),"Returned to previous stage"),children:"Return to Previous"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>je(i,"ARCHIVED","Archived by Reviewer"),children:"Archive"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(String((a==null?void 0:a.role)||"").includes("COMPANY")){if(!$[i.id])return;je(i,"BATTALION_REVIEW",`Approved and routed to ${$[i.id]}`)}else je(i,ks(i.currentStage),"Approved")},disabled:String((a==null?void 0:a.role)||"").includes("COMPANY")&&!$[i.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>je(i,i.currentStage==="PLATOON_REVIEW"?ot:lt(i.currentStage),i.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),F==="In Scope"&&e.jsx(Ge,{title:"In Scope",requests:xe.currentData,users:O,onRowClick:i=>M(j=>({...j,[i.id]:!j[i.id]})),expandedRows:x,platoonSectionMap:N,children:i=>e.jsxs("div",{id:`details-rev-${i.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!h[i.id],"aria-controls":`docs-rev-${i.id}`,onClick:()=>{U(j=>({...j,[i.id]:!j[i.id]})),X(j=>h[i.id]?null:i.id)},onKeyDown:j=>{(j.key==="Enter"||j.key===" ")&&(j.preventDefault(),U(c=>({...c,[i.id]:!c[i.id]})),X(c=>h[i.id]?null:i.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${h[i.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-rev-${i.id}`,ref:h[i.id]?Z:void 0,className:`${h[i.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[ge(i.id).map(j=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:j.name}),e.jsx("div",{children:new Date(j.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:j.fileUrl?e.jsx("a",{href:j.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},j.id)),ge(i.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>f(j=>({...j,[i.id]:!j[i.id]})),"aria-expanded":!!J[i.id],"aria-controls":`logs-${i.id}`,children:[J[i.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${i.id}`,className:J[i.id]?"mt-2 space-y-2":"hidden",children:i.activity&&i.activity.length?i.activity.map((j,c)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[j.actor," • ",new Date(j.timestamp).toLocaleString()," • ",j.action]}),j.comment&&e.jsx("div",{className:"text-gray-600",children:j.comment})]},c)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),I&&a&&e.jsx(Ss,{currentUser:a,onClose:()=>H(!1)})]})}const Bt="MM",Ft="Manpower Management",Wt="MMEA",Vt="Enlisted Personnel Assignments (General oversight)",Ps={division_code:Bt,division_name:Ft,branch:Wt,description:Vt},Ds=Object.freeze(Object.defineProperty({__proto__:null,branch:Wt,default:Ps,description:Vt,division_code:Bt,division_name:Ft},Symbol.toStringTag,{value:"Module"}));async function Os(){try{const t=Object.assign({"../hqmc-structure/MM__manpower-management__mmea.json":Ds}),a=[];for(const r of Object.values(t)){const p=(r==null?void 0:r.default)??r;if(p&&typeof p=="object"){const d=String(p.division_code||""),S=String(p.division_name||""),C=String(p.branch||""),w=p.description?String(p.description):void 0;d&&C&&a.push({division_code:d,division_name:S,branch:C,description:w})}}return a}catch{return[]}}function $s(){var T;const[t,a]=s.useState(null),[r,p]=s.useState([]),[d,S]=s.useState([]),[C,w]=s.useState(""),[R,O]=s.useState(""),[_,J]=s.useState([]),[f,V]=s.useState(null),[z,$]=s.useState("structure"),[m,K]=s.useState({}),[W,N]=s.useState({}),[b,I]=s.useState({});s.useEffect(()=>{try{const D=localStorage.getItem("currentUser");D&&a(JSON.parse(D))}catch{}Dt().then(D=>{try{p(D.map(G=>({code:String(G.code||""),name:String(G.name||"")})))}catch{p([])}}),Os().then(D=>{S(D)}),Ue().then(D=>J(D)).catch(()=>J([])),ft().then(D=>{const G={};for(const v of D){const h=`${v.division_code}::${v.branch}`;G[h]={reviewers:v.reviewers||[],approvers:v.approvers||[]}}K(G)})},[]);const H=(t==null?void 0:t.hqmcDivision)||((T=r[0])==null?void 0:T.code)||"",x=s.useMemo(()=>r.find(D=>D.code===H),[r,H]),M=s.useMemo(()=>d.filter(D=>String(D.division_code||"")===H),[d,H]);return s.useMemo(()=>_.filter(D=>!!D.isHqmcAdmin&&String(D.hqmcDivision||"")===H),[_,H]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(t!=null&&t.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",x?`${x.code} — ${x.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>$("structure"),className:`${z==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>$("permissions"),className:`${z==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),z==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"})]})}),e.jsxs("tbody",{children:[M.map(D=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:D.branch}),e.jsx("td",{className:"py-2 px-3",children:D.description||""})]},D.branch)),M.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:C,onChange:D=>w(D.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:R,onChange:D=>O(D.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!C.trim(),onClick:async()=>{var D;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:H,division_name:((D=r.find(v=>v.code===H))==null?void 0:D.name)||"",branch:C.trim(),description:R.trim()})});const G=await fetch("/api/hqmc-structure").then(v=>v.json());S(G),w(""),O("")}catch{}},children:"Add"})]})]})]}),z==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const D of M){const G=`${H}::${D.branch}`,v=m[G]||{reviewers:[],approvers:[]};await Ot({division_code:H,branch:D.branch,reviewers:v.reviewers,approvers:v.approvers})}V({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:M.map(D=>{const G=`${H}::${D.branch}`,v=m[G]||{reviewers:[],approvers:[]},h=U=>`${U.rank||""} ${U.lastName||""}, ${U.firstName||""}${U.mi?" "+U.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:D.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:W[G]||"",onChange:U=>N(q=>({...q,[G]:U.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!W[G],onClick:async()=>{const U=(W[G]||"").trim();if(!U)return;const{user:q}=await dt(U);if(!(q!=null&&q.id)){V({type:"error",message:`No user found for EDIPI ${U}`});return}K(X=>({...X,[G]:{...v,reviewers:Array.from(new Set([...v.reviewers||[],q.id]))}})),N(X=>({...X,[G]:""})),V({type:"success",message:`Added reviewer ${q.lastName||""}, ${q.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(v.reviewers||[]).map(U=>{const q=_.find(X=>X.id===U);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:q?h(q):U}),e.jsx("button",{className:"text-red-600",onClick:()=>K(X=>({...X,[G]:{...v,reviewers:(v.reviewers||[]).filter(Z=>Z!==U)}})),children:"✕"})]},U)}),(v.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:b[G]||"",onChange:U=>I(q=>({...q,[G]:U.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!b[G],onClick:async()=>{const U=(b[G]||"").trim();if(!U)return;const{user:q}=await dt(U);if(!(q!=null&&q.id)){V({type:"error",message:`No user found for EDIPI ${U}`});return}K(X=>({...X,[G]:{...v,approvers:Array.from(new Set([...v.approvers||[],q.id]))}})),I(X=>({...X,[G]:""})),V({type:"success",message:`Added approver ${q.lastName||""}, ${q.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(v.approvers||[]).map(U=>{const q=_.find(X=>X.id===U);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:q?h(q):U}),e.jsx("button",{className:"text-red-600",onClick:()=>K(X=>({...X,[G]:{...v,approvers:(v.approvers||[]).filter(Z=>Z!==U)}})),children:"✕"})]},U)}),(v.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},G)})})]})})]}),f&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${f.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:f.message})]})}const Xe=(t,a)=>`${t}::${a}`;function Ls({currentUser:t,divisionCode:a,branches:r,assignments:p,onClose:d}){const[S,C]=s.useState([]),[w,R]=s.useState(""),[O,_]=s.useState(""),[J,f]=s.useState("reviewer"),[V,z]=s.useState(!1);s.useEffect(()=>{bt().then(x=>C(x)).catch(()=>C([]))},[]);const $=s.useMemo(()=>{const x={};for(const M of p)x[Xe(M.division_code,M.branch)]={reviewers:M.reviewers||[],approvers:M.approvers||[]};return x},[p]),m=String(t.id||""),K=s.useMemo(()=>{if(!w)return!1;const x=$[Xe(a,w)]||{reviewers:[],approvers:[]};return(x.reviewers||[]).includes(m)||(x.approvers||[]).includes(m)||!!t.isHqmcAdmin},[w,$,m,t]),W=s.useMemo(()=>S.filter(x=>String(x.hqmcDivision||"")===String(a||"")&&String(x.id||"")!==m),[S,a,m]),N=s.useMemo(()=>{if(!w)return[];const x=$[Xe(a,w)]||{reviewers:[],approvers:[]};return Array.from(new Set([...x.reviewers||[],...x.approvers||[]])).map(T=>W.find(D=>D.id===T)).filter(Boolean)},[w,$,W,a]),b=async x=>{z(!0);try{await Ot({division_code:a,branch:w,reviewers:x.reviewers,approvers:x.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:t.id,scope:{hqmcDivision:a,branch:w},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{z(!1)}},I=async()=>{if(!K||!w||!O)return;const x=$[Xe(a,w)]||{reviewers:[],approvers:[]},M={reviewers:Array.from(new Set(x.reviewers||[])),approvers:Array.from(new Set(x.approvers||[]))};J==="reviewer"?M.reviewers=Array.from(new Set([...M.reviewers,O])):M.approvers=Array.from(new Set([...M.approvers,O])),await b(M),_("")},H=async x=>{if(!K||!w)return;const M=$[Xe(a,w)]||{reviewers:[],approvers:[]},T={reviewers:(M.reviewers||[]).filter(D=>D!==x),approvers:(M.approvers||[]).filter(D=>D!==x)};await b(T)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:d,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:x=>x.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:d,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:w,onChange:x=>R(x.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),r.map(x=>e.jsx("option",{value:x,children:x},x))]})]}),w&&!K&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),w&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:O,onChange:x=>_(x.target.value),disabled:!K,children:[e.jsx("option",{value:"",children:"Choose user"}),W.map(x=>e.jsxs("option",{value:x.id,children:[x.rank," ",x.lastName,", ",x.firstName,x.mi?` ${x.mi}`:""," • ",x.email]},x.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:J,onChange:x=>f(x.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!K||!O||V,onClick:I,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[N.map(x=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[x.rank," ",x.lastName,", ",x.firstName,x.mi?` ${x.mi}`:""," • ",x.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!K||V,onClick:()=>H(x.id),children:"Remove"})]},x.id)),N.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}const et=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],_s=t=>{const a=et.indexOf(t||et[0]);return a>0?et[a-1]:et[0]};function qs(){const[t,a]=s.useState(()=>{try{const y=localStorage.getItem("currentUser");return y?JSON.parse(y):null}catch{return null}}),[r,p]=s.useState([]),[d,S]=s.useState([]),[C,w]=s.useState({}),[R,O]=s.useState({}),[_,J]=s.useState({}),[f,V]=s.useState({}),[z,$]=s.useState(null),m=s.useRef(null),[K,W]=s.useState([]),[N,b]=s.useState("Pending"),[I,H]=s.useState([]),[x,M]=s.useState({}),[T,D]=s.useState(!1);s.useEffect(()=>{const y=le=>{z&&m.current&&!m.current.contains(le.target)&&(V(ce=>({...ce,[z]:!1})),$(null))},B=le=>{le.key==="Escape"&&z&&(V(ce=>({...ce,[z]:!1})),$(null))};return document.addEventListener("mousedown",y),document.addEventListener("keydown",B),()=>{document.removeEventListener("mousedown",y),document.removeEventListener("keydown",B)}},[z]),s.useEffect(()=>{nt().then(y=>p(y)).catch(()=>p([]))},[]),s.useEffect(()=>{gt().then(y=>S(y)).catch(()=>S([]))},[]),s.useEffect(()=>{Ue().then(y=>{const B={};for(const le of y)le!=null&&le.id&&(B[le.id]=le);O(B)}).catch(()=>O({}))},[]),s.useEffect(()=>{ft().then(W).catch(()=>W([]))},[]),s.useEffect(()=>{ns().then(H).catch(()=>H([]))},[]);const G=(t==null?void 0:t.id)||"",v=String((t==null?void 0:t.hqmcDivision)||""),h=s.useMemo(()=>K.filter(y=>y.division_code===v&&((y.reviewers||[]).includes(G)||(y.approvers||[]).includes(G))).map(y=>y.branch),[K,v,G]),U=y=>R[y.uploadedById]||null,q=y=>{if(!v||!G)return!1;const B=String(y.routeSection||"");return h.includes(B)},X=s.useMemo(()=>r.filter(q),[r,h]),Z=s.useMemo(()=>X.filter(y=>(y.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[X]),F=s.useMemo(()=>X.filter(y=>(y.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[X]),he=y=>d.filter(B=>B.requestId===y),ye=y=>`"${String(y??"").replace(/"/g,'""')}"`,Se=y=>{const le=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const ce of y){const xe=U(ce),ge=xe?`${xe.rank} ${xe.lastName}, ${xe.firstName}${xe.mi?` ${xe.mi}`:""}`:"",Ce=he(ce.id).map(je=>je.name).join(" | ");le.push([ce.id,ce.subject,ce.currentStage||"",ce.routeSection||"",ge,ce.unitUic||"",new Date(ce.createdAt).toLocaleString(),Ce])}return le.map(ce=>ce.map(ye).join(",")).join(`\r
`)},A=(y,B)=>{const le=new Blob([B],{type:"text/csv;charset=utf-8;"}),ce=URL.createObjectURL(le),xe=document.createElement("a");xe.href=ce,xe.download=y,document.body.appendChild(xe),xe.click(),document.body.removeChild(xe),URL.revokeObjectURL(ce)},Q=()=>A("hqmc_pending.csv",Se(Z)),te=()=>A("hqmc_in_scope.csv",Se(F)),ae=()=>A("hqmc_all.csv",Se([...Z,...F])),ee=async y=>{const B=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",le=String(x[y.id]||"").trim();if(!le){alert("Select an HQMC section to route to approver");return}const ce={actor:B,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${le}`,comment:(C[y.id]||"").trim()},xe={...y,routeSection:le,activity:Array.isArray(y.activity)?[...y.activity,ce]:[ce]};try{await _e(xe)}catch{}p(ge=>ge.map(Ce=>Ce.id===xe.id?xe:Ce)),w(ge=>({...ge,[y.id]:""}))},pe=async y=>{const le={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC",comment:(C[y.id]||"").trim()},ce={...y,currentStage:_s(y.currentStage),activity:Array.isArray(y.activity)?[...y.activity,le]:[le]};try{await _e(ce)}catch{}p(xe=>xe.map(ge=>ge.id===ce.id?ce:ge)),w(xe=>({...xe,[y.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:v||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ae,children:"Export All"}),h.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>D(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>b("Pending"),className:`${N==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>b("In Scope"),className:`${N==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[N==="Pending"&&e.jsx(Ge,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Q,children:"Export Pending"}),requests:Z,users:R,onRowClick:y=>J(B=>({...B,[y.id]:!B[y.id]})),expandedRows:_,children:y=>e.jsxs("div",{id:`details-hq-${y.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!f[y.id],"aria-controls":`docs-hq-${y.id}`,onClick:()=>{V(B=>({...B,[y.id]:!B[y.id]})),$(B=>f[y.id]?null:y.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${f[y.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-hq-${y.id}`,ref:f[y.id]?m:void 0,className:`${f[y.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[he(y.id).map(B=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:B.name}),e.jsx("div",{children:new Date(B.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:B.fileUrl?e.jsx("a",{href:B.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},B.id)),he(y.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:C[y.id]||"",onChange:B=>w(le=>({...le,[y.id]:B.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:x[y.id]||"",onChange:B=>M(le=>({...le,[y.id]:B.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),I.filter(B=>String(B.division_code||"")===v).map(B=>e.jsx("option",{value:B.branch,children:B.branch},B.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>ee(y),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>pe(y),children:"Return"})]})]})]})}),N==="In Scope"&&e.jsx(Ge,{title:"In Scope",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:te,children:"Export In Scope"}),requests:F,users:R,onRowClick:y=>J(B=>({...B,[y.id]:!B[y.id]})),expandedRows:_,children:y=>e.jsxs("div",{id:`details-hq-${y.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!f[y.id],"aria-controls":`docs-hq-${y.id}`,onClick:()=>{V(B=>({...B,[y.id]:!B[y.id]})),$(B=>f[y.id]?null:y.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${f[y.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-hq-${y.id}`,ref:f[y.id]?m:void 0,className:`${f[y.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[he(y.id).map(B=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:B.name}),e.jsx("div",{children:new Date(B.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:B.fileUrl?e.jsx("a",{href:B.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},B.id)),he(y.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})]})})]})]}),T&&t&&e.jsx(Ls,{currentUser:t,divisionCode:v,branches:I.filter(y=>String(y.division_code||"")===v).map(y=>y.branch),assignments:K,onClose:()=>D(!1)})]})}const tt=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Ts=t=>{const a=tt.indexOf(t||tt[0]);return a>0?tt[a-1]:tt[0]};function Bs(){const[t,a]=s.useState(()=>{try{const A=localStorage.getItem("currentUser");return A?JSON.parse(A):null}catch{return null}}),[r,p]=s.useState([]),[d,S]=s.useState([]),[C,w]=s.useState({}),[R,O]=s.useState({}),[_,J]=s.useState({}),[f,V]=s.useState({}),[z,$]=s.useState(null),m=s.useRef(null),[K,W]=s.useState([]),[N,b]=s.useState("Pending");s.useEffect(()=>{const A=te=>{z&&m.current&&!m.current.contains(te.target)&&(V(ae=>({...ae,[z]:!1})),$(null))},Q=te=>{te.key==="Escape"&&z&&(V(ae=>({...ae,[z]:!1})),$(null))};return document.addEventListener("mousedown",A),document.addEventListener("keydown",Q),()=>{document.removeEventListener("mousedown",A),document.removeEventListener("keydown",Q)}},[z]),s.useEffect(()=>{nt().then(A=>p(A)).catch(()=>p([]))},[]),s.useEffect(()=>{gt().then(A=>S(A)).catch(()=>S([]))},[]),s.useEffect(()=>{Ue().then(A=>{const Q={};for(const te of A)te!=null&&te.id&&(Q[te.id]=te);O(Q)}).catch(()=>O({}))},[]),s.useEffect(()=>{ft().then(W).catch(()=>W([]))},[]);const I=(t==null?void 0:t.id)||"",H=String((t==null?void 0:t.hqmcDivision)||""),x=s.useMemo(()=>K.filter(A=>A.division_code===H&&(A.approvers||[]).includes(I)).map(A=>A.branch),[K,H,I]),M=A=>R[A.uploadedById]||null,T=A=>{if(!H||!I)return!1;const Q=String(A.routeSection||"");return x.includes(Q)},D=s.useMemo(()=>r.filter(T),[r,x]),G=s.useMemo(()=>D.filter(A=>(A.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[D]),v=s.useMemo(()=>D.filter(A=>(A.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[D]),h=A=>d.filter(Q=>Q.requestId===A),U=A=>`"${String(A??"").replace(/"/g,'""')}"`,q=A=>{const te=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const ae of A){const ee=M(ae),pe=ee?`${ee.rank} ${ee.lastName}, ${ee.firstName}${ee.mi?` ${ee.mi}`:""}`:"",y=h(ae.id).map(B=>B.name).join(" | ");te.push([ae.id,ae.subject,ae.currentStage||"",ae.routeSection||"",pe,ae.unitUic||"",new Date(ae.createdAt).toLocaleString(),y])}return te.map(ae=>ae.map(U).join(",")).join(`\r
`)},X=(A,Q)=>{const te=new Blob([Q],{type:"text/csv;charset=utf-8;"}),ae=URL.createObjectURL(te),ee=document.createElement("a");ee.href=ae,ee.download=A,document.body.appendChild(ee),ee.click(),document.body.removeChild(ee),URL.revokeObjectURL(ae)},Z=()=>X("hqmc_approver_pending.csv",q(G)),F=()=>X("hqmc_approver_approved.csv",q(v)),he=()=>X("hqmc_approver_all.csv",q([...G,...v])),ye=async A=>{const te={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved",comment:(C[A.id]||"").trim()},ae={...A,currentStage:"ARCHIVED",activity:Array.isArray(A.activity)?[...A.activity,te]:[te]};try{await _e(ae)}catch{}p(ee=>ee.map(pe=>pe.id===ae.id?ae:pe)),w(ee=>({...ee,[A.id]:""}))},Se=async A=>{const te={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver",comment:(C[A.id]||"").trim()},ae={...A,currentStage:Ts(A.currentStage),activity:Array.isArray(A.activity)?[...A.activity,te]:[te]};try{await _e(ae)}catch{}p(ee=>ee.map(pe=>pe.id===ae.id?ae:pe)),w(ee=>({...ee,[A.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((t==null?void 0:t.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:he,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>b("Pending"),className:`${N==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>b("Approved"),className:`${N==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"})]})}),e.jsxs("div",{className:"mt-4",children:[N==="Pending"&&e.jsx(Ge,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Z,children:"Export Pending"}),requests:G,users:R,onRowClick:A=>J(Q=>({...Q,[A.id]:!Q[A.id]})),expandedRows:_,children:A=>e.jsxs("div",{id:`details-hqa-${A.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!f[A.id],"aria-controls":`docs-hqa-${A.id}`,onClick:()=>{V(Q=>({...Q,[A.id]:!Q[A.id]})),$(Q=>f[A.id]?null:A.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${f[A.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-hqa-${A.id}`,ref:f[A.id]?m:void 0,className:`${f[A.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[h(A.id).map(Q=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:Q.name}),e.jsx("div",{children:new Date(Q.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:Q.fileUrl?e.jsx("a",{href:Q.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},Q.id)),h(A.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:C[A.id]||"",onChange:Q=>w(te=>({...te,[A.id]:Q.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>ye(A),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>Se(A),children:"Return"})]})]})}),N==="Approved"&&e.jsx(Ge,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:F,children:"Export Approved"}),requests:v,users:R,onRowClick:A=>J(Q=>({...Q,[A.id]:!Q[A.id]})),expandedRows:_,children:A=>e.jsxs("div",{id:`details-hqa-${A.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!f[A.id],"aria-controls":`docs-hqa-${A.id}`,onClick:()=>{V(Q=>({...Q,[A.id]:!Q[A.id]})),$(Q=>f[A.id]?null:A.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${f[A.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-hqa-${A.id}`,ref:f[A.id]?m:void 0,className:`${f[A.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[h(A.id).map(Q=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:Q.name}),e.jsx("div",{children:new Date(Q.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:Q.fileUrl?e.jsx("a",{href:Q.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},Q.id)),h(A.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})]})})]})]})})}const Fs=({onUnitSelect:t,selectedUnit:a})=>{const[r,p]=s.useState(""),[d,S]=s.useState(!1),C=qe.filter(R=>R.unitName.toLowerCase().startsWith(r.toLowerCase())||R.uic.toLowerCase().startsWith(r.toLowerCase())||R.ruc.toLowerCase().startsWith(r.toLowerCase())),w=R=>{t(R),S(!1),p("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>S(!d),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[a?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",a.uic," | RUC: ",a.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),d&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:r,onChange:R=>p(R.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:C.map(R=>e.jsxs("button",{type:"button",onClick:()=>w(R),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:R.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",R.uic," | RUC: ",R.ruc," | MCC: ",R.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[R.streetAddress,", ",R.cityState," ",R.zip]})]},R.uic))})]})]})]})},ht=async t=>{const r=new TextEncoder().encode(t),p=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(p)).map(d=>d.toString(16).padStart(2,"0")).join("")};async function Ws(t,a){const r=rs();return r!=null&&r.auth?await r.auth.signUp({email:t,password:a}):{data:null,error:new Error("supabase_not_initialized")}}const It={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},Vs=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Ht=({onSaved:t,initial:a={},mode:r="create",readOnly:p=!1,canEditRole:d=!1,canEditAdmin:S=!1})=>{const[C,w]=s.useState(""),[R,O]=s.useState(""),[_,J]=s.useState(""),[f,V]=s.useState(a.email||""),[z,$]=s.useState(a.edipi||""),[m,K]=s.useState(a.service||""),[W,N]=s.useState(a.rank||""),[b,I]=s.useState(a.role||"MEMBER"),[H,x]=s.useState(!!a.isUnitAdmin),[M,T]=s.useState(a.company||""),[D,G]=s.useState(a.platoon||""),[v,h]=s.useState(void 0),[U,q]=s.useState(null),[X,Z]=s.useState({}),[F,he]=s.useState(""),[ye,Se]=s.useState(""),[A,Q]=s.useState([]),[te,ae]=s.useState(!1),[ee,pe]=s.useState(a.roleCompany||""),[y,B]=s.useState(a.rolePlatoon||""),[le,ce]=s.useState(!1),[xe,ge]=s.useState([]),[Ce,je]=s.useState([]),[De,i]=s.useState([]),[j,c]=s.useState([]);s.useEffect(()=>{if(a.firstName&&w(String(a.firstName)),a.lastName&&O(String(a.lastName)),a.mi&&J(String(a.mi)),a.company&&T(String(a.company)),a.platoon&&G(String(a.platoon)),a.roleCompany&&pe(String(a.roleCompany)),a.rolePlatoon&&B(String(a.rolePlatoon)),a.unitUic){const u=qe.find(o=>o.uic===a.unitUic);u&&h(u)}},[a]);const g=s.useMemo(()=>It[m]||[],[m]),Y=s.useMemo(()=>{if(!v)return[];const u=xe;if(u&&u.length)return u;const o=X[v.uic]||{};return Object.keys(o).filter(k=>!k.startsWith("_")&&Array.isArray(o[k]))},[v,X,xe]),E=s.useMemo(()=>{var u;return v&&M?((u=X[v.uic])==null?void 0:u[M])||[]:[]},[v,M,X]),me=s.useMemo(()=>{if(!v||!M)return[];const u=Ce;return u&&u.length?u:E},[v,M,Ce,E]),de=s.useMemo(()=>{if(!v)return[];const u=De;if(u&&u.length)return u;const o=X[v.uic]||{};return Object.keys(o).filter(k=>!k.startsWith("_")&&Array.isArray(o[k]))},[v,X,De]),Ee=s.useMemo(()=>{var u;return v&&ee?((u=X[v.uic])==null?void 0:u[ee])||[]:[]},[v,ee,X]),Te=s.useMemo(()=>{if(!v||!ee)return[];const u=j;return u&&u.length?u:Ee},[v,ee,j,Ee]),Pe=s.useMemo(()=>{const u=Y.slice(),o=M||a.company||a.user_company||"";return o&&!u.includes(o)?[o,...u]:u},[Y,M,a]),Oe=s.useMemo(()=>{const u=me.slice(),o=D||a.platoon||a.user_platoon||"";return o&&!u.includes(o)?[o,...u]:u},[me,D,a]),Be=s.useMemo(()=>{const u=de.slice(),o=ee||a.roleCompany||"",k=o&&!u.includes(o)?[o,...u]:u;return Array.from(new Set(k))},[de,ee,a]),We=s.useMemo(()=>{const u=Te.slice(),o=y||a.rolePlatoon||"";return o&&!u.includes(o)?[o,...u]:u},[Te,y,a]);s.useEffect(()=>{(async()=>{try{if(r==="edit"&&a.id){const u=await $t(String(a.id));u&&(u.company&&!M&&T(String(u.company)),u.platoon&&!D&&G(String(u.platoon)),u.roleCompany&&!ee&&pe(String(u.roleCompany)),u.rolePlatoon&&!y&&B(String(u.rolePlatoon)))}}catch{}})()},[r,a.id]),s.useEffect(()=>{g.includes(W)||N("")},[g]),s.useEffect(()=>{G("")},[M]),s.useEffect(()=>{B("")},[ee]),s.useEffect(()=>{try{const u=localStorage.getItem("unit_structure");u&&Z(JSON.parse(u))}catch{}},[v]),s.useEffect(()=>{const u=(v==null?void 0:v.uic)||"";if(!u){ge([]),i([]);return}Lt(u).then(o=>{ge(o||[]),i(o||[])}).catch(()=>{ge([]),i([])})},[v]),s.useEffect(()=>{const u=(v==null?void 0:v.uic)||"",o=M||"";if(!u||!o){je([]);return}mt(u,o).then(k=>je(k||[])).catch(()=>je([]))},[v,M]),s.useEffect(()=>{const u=(v==null?void 0:v.uic)||"",o=ee||"";if(!u||!o){c([]);return}mt(u,o).then(k=>c(k||[])).catch(()=>c([]))},[v,ee]),s.useEffect(()=>{Ue().then(u=>{Q(u)}).catch(()=>Q([]))},[]),s.useEffect(()=>{const u=(v==null?void 0:v.uic)||"";if(!u){ae(!1);return}const o=A.some(k=>!!k.isUnitAdmin&&(k.unitUic||"")===u);ae(o)},[v,A]),s.useEffect(()=>{if(v){!M&&a.company&&Pe.includes(a.company)&&T(String(a.company));const u=a.platoon;!D&&u&&Oe.includes(u)&&G(String(u))}},[v,Pe,Oe,M,D,a]);const Qe=u=>/^[0-9]{10}$/.test(u),Je=(u,o)=>{try{return A.some(k=>String(k.edipi)===String(u)&&String(k.id)!==String(o||""))}catch{return!1}},we=async u=>{var ie,ne;if(u.preventDefault(),q(null),p)return;if(!C.trim())return q({type:"error",message:"First name is required."});if(!R.trim())return q({type:"error",message:"Last name is required."});if(_&&!/^[A-Za-z]$/.test(_))return q({type:"error",message:"MI must be a single letter."});if(!f.trim())return q({type:"error",message:"Email is required."});if(!Qe(String(z)))return q({type:"error",message:"EDIPI must be 10 digits."});if(!m)return q({type:"error",message:"Service is required."});if(!W)return q({type:"error",message:"Rank is required."});if(Je(String(z),a.id?String(a.id):void 0))return q({type:"error",message:"EDIPI already exists."});if(b==="COMPANY_REVIEWER"&&!ee)return q({type:"error",message:"Role Company is required for Company Reviewer."});if(b==="PLATOON_REVIEWER"&&(!ee||!y))return q({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${C.trim()}`,_&&""+_.trim().toUpperCase(),`${R.trim()}`;let o=a.id?String(a.id):`usr-${Date.now()}`,k=a.passwordHash||"";if(r==="create"){if(!F||F.length<8)return q({type:"error",message:"Password must be at least 8 characters."});if(F!==ye)return q({type:"error",message:"Passwords do not match."});try{const{data:se,error:ve}=await Ws(f.trim(),F);if(ve){q({type:"error",message:`Failed to create auth user: ${String(ve.message||ve)}`});return}const ue=(ie=se==null?void 0:se.user)!=null&&ie.id?String(se.user.id):"";if(!ue){q({type:"error",message:"Auth user ID missing after sign up."});return}o=ue}catch(se){q({type:"error",message:`Failed to create auth user: ${String((se==null?void 0:se.message)||se)}`});return}k=await ht(F)}else if(r==="edit"&&F){if(F.length<8)return q({type:"error",message:"Password must be at least 8 characters."});if(F!==ye)return q({type:"error",message:"Passwords do not match."});k=await ht(F)}const L={id:o,firstName:C.trim(),lastName:R.trim(),mi:_?_.trim().toUpperCase():void 0,email:f.trim(),edipi:z,service:m,rank:W,role:b,company:M||"N/A",unit:(v==null?void 0:v.unitName)||"N/A",unitUic:v==null?void 0:v.uic,passwordHash:k,isUnitAdmin:r==="create"&&v&&!te?!0:H,roleCompany:ee||void 0,rolePlatoon:y||void 0,platoon:D||"N/A"};try{const se=await Ve({id:L.id,email:L.email,rank:L.rank,firstName:L.firstName,lastName:L.lastName,mi:L.mi,service:L.service,role:L.role,unitUic:L.unitUic,unit:(v==null?void 0:v.unitName)||"N/A",company:L.company,isUnitAdmin:!!L.isUnitAdmin,edipi:String(L.edipi),passwordHash:k,platoon:D||"N/A",roleCompany:ee||void 0,rolePlatoon:y||void 0});if(!se.ok){q({type:"error",message:`Failed to save profile: ${String(((ne=se==null?void 0:se.error)==null?void 0:ne.message)||(se==null?void 0:se.error)||"unknown")}`});return}q({type:"success",message:a.id?"Profile updated.":v&&!te?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),t==null||t(L)}catch{q({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:r==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:we,className:"space-y-6",children:[r==="create"&&v&&!te&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:v.unitName})," (UIC ",v.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:R,onChange:u=>O(u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:C,onChange:u=>w(u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:_,maxLength:1,onChange:u=>J(u.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:f,onChange:u=>V(u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:z,onChange:u=>$(u.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:m,onChange:u=>K(u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(It).map(u=>e.jsx("option",{value:u,children:u},u))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:W,onChange:u=>N(u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),g.map(u=>e.jsx("option",{value:u,children:u},u))]})]}),r==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:F,onChange:u=>he(u.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:ye,onChange:u=>Se(u.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p})]})]}):e.jsx(e.Fragment,{})]})]}),le&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:F,onChange:u=>he(u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:ye,onChange:u=>Se(u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>ce(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>ce(!1),children:"Save"})]})]})}),r==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:b,onChange:u=>I(u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:Vs.map(u=>e.jsx("option",{value:u,children:u},u))})}),e.jsx("div",{children:e.jsxs("select",{value:ee||String(a.roleCompany||""),onChange:u=>pe(u.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Be.length?"Select company":"No companies configured"}),Be.map(u=>e.jsx("option",{value:u,children:u},u))]})}),e.jsx("div",{children:e.jsxs("select",{value:y||String(a.rolePlatoon||""),onChange:u=>B(u.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:We.length?"Select platoon":"No platoons configured"}),We.map(u=>e.jsx("option",{value:u,children:u},u))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:H,onChange:u=>x(u.target.checked),disabled:p||!S}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(a==null?void 0:a.isCommandStaff)||b==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Command Sections Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(Fs,{onUnitSelect:u=>h(u),selectedUnit:v})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:M||String(a.company||""),onChange:u=>T(u.target.value),disabled:p||!v||Pe.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Pe.length?"Select company":"No companies configured"}),Pe.map(u=>e.jsx("option",{value:u,children:u},u))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:D||String(a.platoon||""),onChange:u=>G(u.target.value),disabled:p||!v||!M||Oe.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Oe.length?"Select platoon":"No platoons configured"}),Oe.map(u=>e.jsx("option",{value:u,children:u},u))]})]})]})})]}),U&&e.jsx("div",{className:`p-3 rounded-lg border ${U.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:U.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[r==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>ce(!0),disabled:p,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:p,children:r==="edit"?"Save":"Create Profile"})]})]})]})},Hs=s.memo(function({user:a,onClose:r}){const p=()=>{const d=qe.find(C=>C.uic===a.unitUic),S=d?d.unitName:a.unit;if(a.isUnitAdmin||a.role==="COMMANDER")return S||"—";if(a.role==="COMPANY_REVIEWER")return a.company&&a.company!=="N/A"?a.company:"—";if(a.role==="PLATOON_REVIEWER"){const C=a.company&&a.company!=="N/A"?a.company:"",w=a.platoon&&a.platoon!=="N/A"?a.platoon:"",R=[C,w].filter(Boolean);return R.length?R.join(" / "):"—"}return"—"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:r,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:r,children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:a.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:a.edipi||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:a.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:a.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:p()})]}),a.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),a.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:r,children:"Close"})})]})})}),zs=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Gs=()=>{const[t,a]=s.useState(null),[r,p]=s.useState(void 0),[d,S]=s.useState({}),[C,w]=s.useState({}),[R,O]=s.useState({}),[_,J]=s.useState({}),[f,V]=s.useState(""),[z,$]=s.useState(""),[m,K]=s.useState(""),[W,N]=s.useState(""),[b,I]=s.useState(""),[H,x]=s.useState([]),[M,T]=s.useState(null),[D,G]=s.useState(""),v=s.useRef(null),[h,U]=s.useState(null),[q,X]=s.useState(null),[Z,F]=s.useState(""),[he,ye]=s.useState(void 0),[Se,A]=s.useState(void 0),[Q,te]=s.useState(void 0),[ae,ee]=s.useState(void 0),[pe,y]=s.useState(void 0),[B,le]=s.useState(void 0),[ce,xe]=s.useState([]),[ge,Ce]=s.useState([]),[je,De]=s.useState(""),[i,j]=s.useState("unit"),[c,g]=s.useState([]),[Y,E]=s.useState(!1),[me,de]=s.useState(!1),[Ee,Te]=s.useState(!1),[Pe,Oe]=s.useState("admin"),Be=s.useRef(!1);s.useEffect(()=>{h&&Pe==="admin"&&!Be.current&&(!he&&h.company&&h.company!=="N/A"&&(ye(h.company),te(h.company)),!Se&&h.platoon&&h.platoon!=="N/A"&&(A(h.platoon),ee(h.platoon)),!pe&&h.roleCompany&&h.roleCompany!=="N/A"&&y(h.roleCompany),!B&&h.rolePlatoon&&h.rolePlatoon!=="N/A"&&le(h.rolePlatoon),Be.current=!0)},[h,Pe]),s.useEffect(()=>{try{const n=localStorage.getItem("unit_structure");n&&S(JSON.parse(n))}catch{}try{const n=localStorage.getItem("unit_structure"),l={},P={},oe={};if(n){const fe=JSON.parse(n);for(const Ne of Object.keys(fe||{})){const re=fe[Ne];re&&Array.isArray(re._sections)&&(l[Ne]=re._sections),re&&Array.isArray(re._commandSections)&&(P[Ne]=re._commandSections),re&&re._platoonSectionMap&&typeof re._platoonSectionMap=="object"&&(oe[Ne]=re._platoonSectionMap)}}else(async()=>{try{const fe=await vt();for(const Ne of Object.keys(fe||{})){const re=fe[Ne];re&&Array.isArray(re._sections)&&(l[Ne]=re._sections),re&&Array.isArray(re._commandSections)&&(P[Ne]=re._commandSections),re&&re._platoonSectionMap&&typeof re._platoonSectionMap=="object"&&(oe[Ne]=re._platoonSectionMap)}S(fe)}catch{}})();w(l),O(P),J(oe)}catch{}Ue().then(n=>{x(n)}).catch(()=>x([]));try{const n=localStorage.getItem("currentUser");if(n){const l=JSON.parse(n);if(a(l),l.unitUic){const P=qe.find(oe=>oe.uic===l.unitUic);P&&p(P)}}}catch{}},[]),s.useEffect(()=>{try{if(!r){const n=Object.keys(d||{});if(n.length){const l=n[0],P=d[l]||{},fe=qe.find(Ne=>Ne.uic===l)||{ruc:String(P._ruc||""),mcc:String(P._mcc||""),uic:l,unitName:String(P._unitName||l),streetAddress:String(P._streetAddress||"")};p(fe)}}}catch{}},[d]),s.useEffect(()=>{const n=(h==null?void 0:h.unitUic)||"";if(!n){xe([]);return}Lt(n).then(l=>xe(l||[])).catch(()=>xe([]))},[h]),s.useEffect(()=>{const n=(h==null?void 0:h.unitUic)||"",l=pe||"";if(!n||!l){Ce([]);return}mt(n,l).then(P=>Ce(P||[])).catch(()=>Ce([]))},[h,pe]);const We=s.useMemo(()=>{const n=(r==null?void 0:r.uic)||"";if(!n)return[];const l=d[n]||{};return Object.keys(l).filter(P=>!P.startsWith("_")&&Array.isArray(l[P]))},[r,d]),Qe=s.useMemo(()=>{var P;const n=(r==null?void 0:r.uic)||"";if(!n||!f)return[];const l=(P=d[n])==null?void 0:P[f];return Array.isArray(l)?l:[]},[r,f,d]),Je=s.useMemo(()=>{const n=(r==null?void 0:r.uic)||"";return n?C[n]||[]:[]},[r,C]),we=s.useMemo(()=>{const n=(r==null?void 0:r.uic)||"";return n?R[n]||[]:[]},[r,R]),u=s.useMemo(()=>{const n=(h==null?void 0:h.unitUic)||"";if(!n)return[];const l=ce;if(l&&l.length)return l;const P=d[n]||{};return Object.keys(P).filter(oe=>!oe.startsWith("_")&&Array.isArray(P[oe]))},[h,d,ce]),o=s.useMemo(()=>{var oe;const n=(h==null?void 0:h.unitUic)||"",l=Q||"";if(!n||!l)return[];const P=(oe=d[n])==null?void 0:oe[l];return Array.isArray(P)?P:[]},[h,Q,d]),k=s.useMemo(()=>{var fe,Ne;const n=(h==null?void 0:h.unitUic)||"",l=pe||"";if(!l)return[];const P=ge;if(P&&P.length>0)return P;if(n){const re=(fe=d[n])==null?void 0:fe[l];if(Array.isArray(re)&&re.length>0)return re}const oe=(r==null?void 0:r.uic)||"";if(oe&&oe!==n){const re=(Ne=d[oe])==null?void 0:Ne[l];if(Array.isArray(re))return re}return[]},[h,pe,d,ge,r]),L=s.useMemo(()=>{const n=u.slice(),l=he||(h&&h.company!=="N/A"?h.company:"");return l&&!n.includes(l)?[l,...n]:n},[u,he,h]);s.useMemo(()=>{const n=o.slice(),l=ae||(h&&h.platoon&&h.platoon!=="N/A"?h.platoon:"");return l&&!n.includes(l)?[l,...n]:n},[o,ae,h]);const ie=s.useMemo(()=>{const n=k.slice(),l=B||(h&&h.rolePlatoon&&h.rolePlatoon!=="N/A"?h.rolePlatoon:"");return l&&!n.includes(l)?[l,...n]:n},[k,B,h]),ne=()=>{try{if(r){const n=r.uic,l={...d};l[n]=l[n]||{},l[n]._mcc=r.mcc||l[n]._mcc||"",l[n]._unitName=r.unitName||l[n]._unitName||"",S(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const oe=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",oe),T({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist unit structure."})}})()}else{const n=JSON.stringify(d);localStorage.setItem("unit_structure",n),(async()=>{try{if(navigator.sendBeacon){const P=new Blob([n],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",P),T({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:n,keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist unit structure."})}})()}}catch{T({type:"error",message:"Failed to save unit structure."})}},se=()=>{try{if(!r)return;const n=r.uic,l={...d};l[n]=l[n]||{},l[n]._sections=C[n]||[],l[n]._mcc=r.mcc||l[n]._mcc||"",l[n]._unitName=r.unitName||l[n]._unitName||"",S(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const oe=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",oe),T({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist unit sections."})}})()}catch{T({type:"error",message:"Failed to save unit sections."})}},ve=()=>{try{if(!r)return;const n=r.uic,l={...d};l[n]=l[n]||{},l[n]._commandSections=R[n]||[],l[n]._mcc=r.mcc||l[n]._mcc||"",l[n]._unitName=r.unitName||l[n]._unitName||"",S(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const oe=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",oe),T({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist command sections."})}})()}catch{T({type:"error",message:"Failed to save command sections."})}},ue=()=>{try{if(!r)return;const n=r.uic,l={...d};l[n]=l[n]||{},l[n]._platoonSectionMap=_[n]||{},l[n]._mcc=r.mcc||l[n]._mcc||"",l[n]._unitName=r.unitName||l[n]._unitName||"",S(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const oe=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",oe),T({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist links."})}})()}catch{T({type:"error",message:"Failed to save links."})}},Me=()=>{if(!r||!z.trim())return;const n=r.uic,l={...d};l[n]=l[n]||{},l[n][z.trim()]||(l[n][z.trim()]=[],S(l),V(z.trim()),$(""))},be=n=>{if(!r)return;const l=r.uic,P={...d};P[l]&&(delete P[l][n],S(P),f===n&&V(""))},Ie=()=>{if(!r||!f||!m.trim())return;const n=r.uic,l={...d};l[n]=l[n]||{},l[n][f]=l[n][f]||[],l[n][f].includes(m.trim())||(l[n][f]=[...l[n][f],m.trim()],S(l),K(""))},Re=n=>{if(!r||!f)return;const l=r.uic,P={...d};P[l][f]=(P[l][f]||[]).filter(oe=>oe!==n),S(P)},Fe=()=>{if(!r||!W.trim())return;const n=r.uic,l={...C};l[n]=l[n]||[],l[n].includes(W.trim())||(l[n]=[...l[n],W.trim()],w(l),N(""))},$e=n=>{if(!r)return;const l=r.uic,P={...C};P[l]=(P[l]||[]).filter(oe=>oe!==n),w(P)},rt=()=>{if(!r||!b.trim())return;const n=r.uic,l={...R};l[n]=l[n]||[],l[n].includes(b.trim())||(l[n]=[...l[n],b.trim()],O(l),I(""))},He=n=>{if(!r)return;const l=r.uic,P={...R};P[l]=(P[l]||[]).filter(oe=>oe!==n),O(P)},Ae=()=>{const n=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],l=H.map(re=>[re.firstName,re.mi||"",re.lastName,re.email,re.edipi,re.service,re.rank,re.role,re.company,re.unit,re.unitUic||""].map(zt=>{const Ye=String(zt??"");return Ye.includes(",")||Ye.includes('"')||Ye.includes(`
`)?'"'+Ye.replace(/"/g,'""')+'"':Ye}).join(",")),P="\uFEFF"+[n.join(","),...l].join(`
`),oe=new Blob([P],{type:"text/csv;charset=utf-8"}),fe=URL.createObjectURL(oe),Ne=document.createElement("a");Ne.href=fe,Ne.download="users-export.csv",Ne.click(),URL.revokeObjectURL(fe)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${i==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>j("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${i==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>j("users"),children:"User Administration"})]})})}),i==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:r?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:r.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",r.uic," | RUC: ",r.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ne,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:z,onChange:n=>$(n.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Me,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[We.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>V(n),children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>be(n),children:"Remove"})]},n)),We.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",f?`• ${f}`:""]}),r&&f&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ue,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:m,onChange:n=>K(n.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!f}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:Ie,disabled:!f,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Qe.map(n=>{var l,P;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:n})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:((P=(l=_[(r==null?void 0:r.uic)||""])==null?void 0:l[f])==null?void 0:P[n])||"",onChange:oe=>{const fe=(r==null?void 0:r.uic)||"";J(Ne=>{const re={...Ne};return re[fe]=re[fe]||{},re[fe][f]=re[fe][f]||{},re[fe][f][n]=oe.target.value,re})},children:[e.jsx("option",{value:"",children:"Link to section"}),(C[(r==null?void 0:r.uic)||""]||[]).map(oe=>e.jsx("option",{value:oe,children:oe},oe))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Re(n),children:"Remove"})]})]},n)}),Qe.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:se,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:W,onChange:n=>N(n.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Fe,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Je.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>$e(n),children:"Remove"})]},n)),Je.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ve,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:b,onChange:n=>I(n.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:rt,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[we.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>He(n),children:"Remove"})]},n)),we.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),i==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[H.filter(n=>{const l=!D||(n.email??"").toLowerCase().includes(D.toLowerCase())||(n.lastName??"").toLowerCase().includes(D.toLowerCase()),P=r?n.unitUic===r.uic||n.unit&&n.unit===r.unitName:!0;return l&&P}).map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[n.lastName,", ",n.firstName,n.mi?` ${n.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:n.email}),e.jsx("td",{className:"py-2 px-3",children:n.edipi}),e.jsx("td",{className:"py-2 px-3",children:n.service}),e.jsx("td",{className:"py-2 px-3",children:n.rank}),e.jsx("td",{className:"py-2 px-3",children:n.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const l=qe.find(oe=>oe.uic===n.unitUic),P=l?l.unitName:n.unit;if(n.isUnitAdmin||n.role==="COMMANDER")return P||"—";if(n.role==="COMPANY_REVIEWER")return n.company&&n.company!=="N/A"?n.company:"—";if(n.role==="PLATOON_REVIEWER"){const oe=n.company&&n.company!=="N/A"?n.company:"",fe=n.platoon&&n.platoon!=="N/A"?n.platoon:"",Ne=[oe,fe].filter(Boolean);return Ne.length?Ne.join(" / "):"—"}return"—"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>X(n),children:"View"}),((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{Oe("admin"),U(n),F(n.role??"MEMBER"),ye(n.company!=="N/A"?n.company:void 0),te(n.company!=="N/A"?n.company:void 0),A(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),ee(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),De(typeof n.commandOrder=="number"?String(n.commandOrder):""),de(!!n.isUnitAdmin),Te(!!n.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{x(l=>l.filter(P=>P.id!==n.id));try{localStorage.removeItem(`fs/users/${n.id}.json`)}catch(l){console.error("Failed to remove user from localStorage",l)}},children:"Delete"})]})})]},n.id)),H.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:"No users"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:v,type:"text",placeholder:"Filter users...",value:D,onChange:n=>G(n.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var n;return(n=v.current)==null?void 0:n.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:Ae,children:"Export All"})]})]}),q&&e.jsx(Hs,{user:q,onClose:()=>X(null)}),h&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>U(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>U(null),children:"✕"})]}),Pe==="profile"&&t&&h&&t.edipi===h.edipi&&e.jsx(Ht,{mode:"edit",initial:h,readOnly:!1,onSaved:n=>{x(l=>l.map(P=>P.edipi===n.edipi?n:P)),U(null),T({type:"success",message:"Profile updated."})}}),Pe==="admin"&&((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:Z,onChange:n=>{const l=n.target.value;F(l),l==="COMMANDER"&&(ye(void 0),A(void 0))},className:"w-full px-3 py-2 border rounded",children:zs.map(n=>e.jsx("option",{value:n,children:n},n))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:pe||"",onChange:n=>y(n.target.value||void 0),disabled:!Z.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:L.length?"Select company":"No companies configured"}),L.map(n=>e.jsx("option",{value:n,children:n},n))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:B||"",onChange:n=>le(n.target.value||void 0),disabled:!Z.includes("REVIEW")||!pe,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:ie.length?"Select platoon":"No platoons configured"}),ie.map(n=>e.jsx("option",{value:n,children:n},n))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:me,onChange:n=>de(n.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:Ee,disabled:Z==="COMMANDER",onChange:async n=>{const l=n.target.checked;Te(l);try{if(h&&!(await Ve({id:h.id,email:h.email,rank:h.rank,firstName:h.firstName,lastName:h.lastName,mi:h.mi,service:h.service,role:h.role,unitUic:h.unitUic,unit:h.unit,company:h.company,isUnitAdmin:!!h.isUnitAdmin,isCommandStaff:l,edipi:h.edipi,passwordHash:h.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Command Sections Dashboard"})]})]}),c.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:c.map((n,l)=>e.jsx("div",{className:"text-sm",children:n},l))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{U(null),Be.current=!1,g([]),E(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${Y?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":Y,disabled:Y,onClick:async()=>{var oe;if(!h)return;const n=[];if(Z==="COMPANY_REVIEWER"&&!he&&n.push("Company is required for Company Reviewer."),Z==="PLATOON_REVIEWER"&&(!he||!Se)&&n.push("Company and Platoon are required for Platoon Reviewer."),g(n),n.length)return;E(!0);const l=((oe=qe.find(fe=>fe.uic===h.unitUic))==null?void 0:oe.unitName)||"N/A",P={...h,role:Z,isUnitAdmin:me,isCommandStaff:Z==="COMMANDER"?!1:Ee,company:Q||"N/A",unit:l,platoon:ae||"N/A",roleCompany:Z.includes("REVIEW")?pe||"N/A":void 0,rolePlatoon:Z.includes("REVIEW")?B||"N/A":void 0};try{localStorage.setItem(`fs/users/${P.edipi}.json`,JSON.stringify(P))}catch{}try{if(!(await Ve({id:P.id,email:P.email,rank:P.rank,firstName:P.firstName,lastName:P.lastName,mi:P.mi,service:P.service,role:P.role,unitUic:P.unitUic,unit:P.unit,company:P.company,isUnitAdmin:!!P.isUnitAdmin,isCommandStaff:!!P.isCommandStaff,edipi:P.edipi,passwordHash:P.passwordHash,roleCompany:P.roleCompany,rolePlatoon:P.rolePlatoon,platoon:P.platoon})).ok)throw new Error("persist_failed")}catch{E(!1),T({type:"error",message:"Failed to save administrative changes."});return}x(fe=>fe.map(Ne=>Ne.edipi===P.edipi?P:Ne));try{t&&t.edipi===P.edipi&&(localStorage.setItem("currentUser",JSON.stringify(P)),a(P))}catch{}U(null),Be.current=!1,E(!1),T({type:"success",message:"Administrative changes saved."})},children:[Y&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),M&&e.jsx("div",{className:`p-3 rounded-lg border ${M.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:M.message})]})};function Us(){const[t,a]=s.useState([]),[r,p]=s.useState(null),[d,S]=s.useState({}),[C,w]=s.useState({}),[R,O]=s.useState([]),[_,J]=s.useState("unit"),[f,V]=s.useState("assigned"),[z,$]=s.useState([]),[m,K]=s.useState(""),[W,N]=s.useState([]),[b,I]=s.useState(""),H=()=>{Ue().then(c=>a(c)).catch(()=>a([]))},x=()=>{nt().then(c=>O(c)).catch(()=>O([]))},M=()=>{p(null),H(),x()};s.useEffect(()=>{M(),_t().then(c=>$(c)),Dt().then(c=>N(c))},[_,f]);const T=s.useMemo(()=>{const c={};for(const g of t)g.isUnitAdmin&&g.unitUic&&(c[g.unitUic]=g);return c},[t]),D=s.useMemo(()=>{const c={};for(const g of t)if(g.isInstallationAdmin&&g.installationId){const Y=g.installationId;c[Y]=c[Y]||[],c[Y].push(g)}return c},[t]),G=c=>t.filter(g=>g.unitUic===c.uic||!g.unitUic&&g.unit===c.unitName),v=async c=>{const g=d[c.uic];if(!g)return;const Y=t.find(me=>me.id===g);if(!Y)return;const E={...Y,isUnitAdmin:!0,unitUic:c.uic,unit:c.unitName,company:"N/A"};try{if(!(await Ve({id:E.id,email:E.email,rank:E.rank,firstName:E.firstName,lastName:E.lastName,mi:E.mi,service:E.service,role:E.role,unitUic:E.unitUic,unit:E.unit,company:E.company,isUnitAdmin:!!E.isUnitAdmin,isInstallationAdmin:!!E.isInstallationAdmin,isCommandStaff:!!E.isCommandStaff,edipi:E.edipi})).ok){p({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}a(me=>me.map(de=>de.id===E.id?E:de)),p({type:"success",message:`Assigned ${E.rank} ${E.lastName} as admin for ${c.unitName}.`})},h=s.useMemo(()=>qe.filter(c=>!!T[c.uic]),[T]);s.useMemo(()=>t.filter(c=>!!c.isHqmcAdmin),[t]);const U=s.useMemo(()=>qe.filter(c=>!T[c.uic]),[T]),q=s.useMemo(()=>z.filter(c=>{var g;return(g=D[c.id])==null?void 0:g.length}),[z,D]),X=s.useMemo(()=>z.filter(c=>{var g;return!((g=D[c.id])!=null&&g.length)}),[z,D]),Z=s.useMemo(()=>{const c={};for(const g of t)if(g.isHqmcAdmin&&g.hqmcDivision){const Y=g.hqmcDivision;c[Y]=c[Y]||[],c[Y].push(g)}return c},[t]),F=s.useMemo(()=>W.filter(c=>{var g;return(g=Z[c.code])==null?void 0:g.length}),[W,Z]);s.useMemo(()=>{const c=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return R.filter(g=>c.includes(String(g.currentStage||"")))},[R]);const[he,ye]=s.useState(1),[Se,A]=s.useState(10),Q=h.length,te=Math.max(1,Math.ceil(Q/(Se||1))),ae=Math.min(he,te),ee=Q===0?0:(ae-1)*Se+1,pe=Q===0?0:Math.min(ee+Se-1,Q),y=h.slice((ae-1)*Se,(ae-1)*Se+Se),[B,le]=s.useState(1),[ce,xe]=s.useState(10),ge=U.length,Ce=Math.max(1,Math.ceil(ge/(ce||1))),je=Math.min(B,Ce),De=ge===0?0:(je-1)*ce+1,i=ge===0?0:Math.min(De+ce-1,ge),j=U.slice((je-1)*ce,(je-1)*ce+ce);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${_==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{J("unit"),V("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${_==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{J("installation"),V("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${_==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{J("hqmc"),V("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${f==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>V("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${f==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>V("missing"),children:"Missing"})]}),_==="installation"&&f==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[q.map(c=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:c.name}),e.jsx("td",{className:"py-2 px-3",children:(D[c.id]||[]).map(g=>`${g.rank} ${g.lastName}, ${g.firstName}${g.mi?` ${g.mi}`:""}`).join(" • ")})]},c.id)),q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),_==="installation"&&f==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[X.map(c=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:c.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:C[c.id]||"",onChange:g=>w(Y=>({...Y,[c.id]:g.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(g=>e.jsx("option",{value:g.id,children:`${g.rank} ${g.lastName}, ${g.firstName}${g.mi?` ${g.mi}`:""}`},g.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!C[c.id],onClick:async()=>{const g=C[c.id],Y=t.find(me=>me.id===g);if(!Y)return;const E={...Y,isInstallationAdmin:!0,installationId:c.id};try{if(!(await Ve({id:E.id,email:E.email,rank:E.rank,firstName:E.firstName,lastName:E.lastName,mi:E.mi,service:E.service,role:E.role,unitUic:E.unitUic,unit:E.unit,company:E.company,isUnitAdmin:!!E.isUnitAdmin,isInstallationAdmin:!!E.isInstallationAdmin,isCommandStaff:!!E.isCommandStaff,edipi:E.edipi,installationId:E.installationId})).ok){p({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}a(me=>me.map(de=>de.id===E.id?E:de)),p({type:"success",message:`Assigned ${E.rank} ${E.lastName} as installation admin.`})},children:"Assign"})})]},c.id)),X.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),_==="unit"&&f==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[y.map(c=>{const g=T[c.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:c.unitName}),e.jsx("td",{className:"py-2 px-3",children:c.uic}),e.jsx("td",{className:"py-2 px-3",children:`${g.rank} ${g.lastName}, ${g.firstName}${g.mi?` ${g.mi}`:""}`})]},c.uic)}),h.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(ut,{currentPage:ae,totalPages:te,totalItems:Q,pageSize:Se,startIndex:ee,endIndex:pe,onPageChange:c=>ye(c),onPageSizeChange:c=>{A(c),ye(1)},onNext:()=>ye(Math.min(ae+1,te)),onPrevious:()=>ye(Math.max(ae-1,1)),onFirst:()=>ye(1),onLast:()=>ye(te),canGoNext:ae<te,canGoPrevious:ae>1,pageSizeOptions:[5,10,25,50]})})]}),_==="unit"&&f==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[j.map(c=>{const g=G(c);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:c.unitName}),e.jsx("td",{className:"py-2 px-3",children:c.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:d[c.uic]||"",onChange:Y=>S(E=>({...E,[c.uic]:Y.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:g.length?"Select user":"No eligible users"}),g.map(Y=>e.jsx("option",{value:Y.id,children:`${Y.rank} ${Y.lastName}, ${Y.firstName}${Y.mi?` ${Y.mi}`:""}`},Y.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!d[c.uic],onClick:()=>v(c),children:"Assign"})})]},c.uic)}),U.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(ut,{currentPage:je,totalPages:Ce,totalItems:ge,pageSize:ce,startIndex:De,endIndex:i,onPageChange:c=>le(c),onPageSizeChange:c=>{xe(c),le(1)},onNext:()=>le(Math.min(je+1,Ce)),onPrevious:()=>le(Math.max(je-1,1)),onFirst:()=>le(1),onLast:()=>le(Ce),canGoNext:je<Ce,canGoPrevious:je>1,pageSizeOptions:[5,10,25,50]})})]}),_==="hqmc"&&f==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[F.map(c=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[c.code," — ",c.name]}),e.jsx("td",{className:"py-2 px-3",children:(Z[c.code]||[]).map(g=>`${g.rank} ${g.lastName}, ${g.firstName}${g.mi?` ${g.mi}`:""}`).join(" • ")})]},c.code)),F.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),_==="hqmc"&&f==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[W.filter(c=>{var g;return!((g=Z[c.code])!=null&&g.length)}).map(c=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[c.code," — ",c.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:C[`hqmc_${c.code}`]||"",onChange:g=>w(Y=>({...Y,[`hqmc_${c.code}`]:g.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(g=>e.jsx("option",{value:g.id,children:`${g.rank} ${g.lastName}, ${g.firstName}${g.mi?` ${g.mi}`:""}`},g.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!C[`hqmc_${c.code}`],onClick:async()=>{const g=C[`hqmc_${c.code}`],Y=t.find(me=>me.id===g);if(!Y)return;const E={...Y,isHqmcAdmin:!0,hqmcDivision:c.code};try{if(!(await Ve({id:E.id,email:E.email,rank:E.rank,firstName:E.firstName,lastName:E.lastName,mi:E.mi,service:E.service,role:E.role,unitUic:E.unitUic,unit:E.unit,company:E.company,isUnitAdmin:!!E.isUnitAdmin,isInstallationAdmin:!!E.isInstallationAdmin,isCommandStaff:!!E.isCommandStaff,isHqmcAdmin:!!E.isHqmcAdmin,hqmcDivision:E.hqmcDivision,edipi:E.edipi})).ok){p({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}a(me=>me.map(de=>de.id===E.id?E:de)),p({type:"success",message:`Assigned ${E.rank} ${E.lastName} as HQMC admin for ${c.code}.`})},children:"Assign"})})]},c.code)),W.filter(c=>{var g;return!((g=Z[c.code])!=null&&g.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),r&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${r.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:r.message})]})})}const Mt=!0,Qs=({onLoggedIn:t,onCreateAccount:a})=>{const[r,p]=s.useState(""),[d,S]=s.useState(""),[C,w]=s.useState(null),[R,O]=s.useState(!0),[_,J]=s.useState(!0);Yt.useEffect(()=>{},[]);const f=async V=>{V.preventDefault(),w(null);try{const z=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,$=/^[0-9]{10}$/.test(r),m=Mt?z.test(r.trim().toLowerCase())||$:z.test(r.trim().toLowerCase()),K=d.length>=6;if(O(m),J(K),!m){w({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!K){w({type:"error",message:"Password must be at least 6 characters."});return}let W=null,N=null,b=r.trim().toLowerCase();if(Mt&&$){const{user:G,error:v}=await dt(String(r));W=G,N=v,b=String((W==null?void 0:W.email)||"")}else if(z.test(b)){const{user:G,error:v}=await Nt(b);W=G,N=v}else{w({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(N){w({type:"error",message:`Database Error: ${N}`});return}if(!W||!b){w({type:"error",message:"Account not found."});return}const I=String(W.passwordHash||W.password_hash||"").trim();if(!I){w({type:"error",message:"No password set for this user."});return}const H=await ht(d);if(!(/^[0-9a-f]{64}$/i.test(I)?I.toLowerCase()===H.toLowerCase():I===d)){w({type:"error",message:"Invalid credentials."});return}const{user:T,error:D}=await Nt(b);if(D){w({type:"error",message:`Profile Error: ${D}`});return}if(!T){console.error("[Login] User profile not found after successful password verification",{emailForLogin:b}),w({type:"error",message:"User profile not found."});return}w({type:"success",message:"Logged in."}),t(T)}catch(z){console.error("[Login] Login failed:",z),w({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:f,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:r,onChange:V=>p(V.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${R?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!R}),!R&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:d,onChange:V=>S(V.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${_?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!_}),!_&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),C&&e.jsx("div",{className:`p-3 rounded-lg border ${C.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:C.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:a,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!R||!_,children:"Login"})]})]})]})},Rt=""+new URL("logo-DLcHofKE.png",import.meta.url).href,Js=({currentUser:t,hasSectionDashboard:a,hasCommandDashboard:r,hasInstallationSectionDashboard:p=!1,hasInstallationCommandDashboard:d=!1,hasHQMCSectionDashboard:S=!1,hasHQMCApproverDashboard:C=!1,onManageProfile:w,onLogout:R,onNavigate:O,isLogin:_=!1})=>{const[J,f]=s.useState(!1),[V,z]=s.useState(!1),$=s.useRef(null);return s.useEffect(()=>{const m=W=>{if(!J)return;const N=$.current;N&&W.target&&!N.contains(W.target)&&f(!1)},K=W=>{W.key==="Escape"&&f(!1)};return document.addEventListener("mousedown",m),document.addEventListener("touchstart",m,{passive:!0}),document.addEventListener("keydown",K),()=>{document.removeEventListener("mousedown",m),document.removeEventListener("touchstart",m),document.removeEventListener("keydown",K)}},[J]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:_?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:Rt,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:Rt,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:t?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[t.rank," ",t.lastName,t.lastName?",":""," ",t.firstName,t.mi?` ${t.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[t.service," • ",t.role,(()=>{const m={PLATOON_REVIEWER:t.role_platoon,COMPANY_REVIEWER:t.role_company}[t.role];return m?` - ${m}`:null})()]}),(()=>{var b;const m=((b=qe.find(I=>I.uic===((t==null?void 0:t.unitUic)||"")))==null?void 0:b.unitName)||(t==null?void 0:t.unit)||"",K=t!=null&&t.company&&t.company!=="N/A"?t.company:t!=null&&t.user_company&&t.user_company!=="N/A"?t.user_company:null,W=t!=null&&t.platoon&&t.platoon!=="N/A"?t.platoon:t!=null&&t.user_platoon&&t.user_platoon!=="N/A"?t.user_platoon:null,N=[m||null,K,W].filter(Boolean);return N.length?e.jsx("div",{className:"text-xs text-white/70",children:N.join(" • ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:w,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:R,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),t&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>z(!V),children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),V&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{w(),z(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{R(),z(!1)},children:"Logout"})]})]}),!t&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>O("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:$,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":J,onClick:()=>f(m=>!m),children:"Dashboards"}),e.jsxs("div",{className:`${J?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:t&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("dashboard"),f(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(t==null?void 0:t.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("admin"),f(!1)},children:"Admin"}),t&&!!t.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("appadmin"),f(!1)},children:"App Admin"}),t&&!!t.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("hqmc-admin"),f(!1)},children:"HQMC Admin"}),t&&!!t.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("installation"),f(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[t&&a&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("section"),f(!1)},children:"Battalion Section Dashboard"}),r&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("command"),f(!1)},children:"Command Sections Dashboard"}),String((t==null?void 0:t.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("review"),f(!1)},children:"Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[t&&p&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("installation-section"),f(!1)},children:"Installation Section Dashboard"}),t&&d&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("installation-command"),f(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[t&&(S||!!t.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("hqmc-section"),f(!1)},children:"HQMC Section Dashboard"}),t&&C&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("hqmc-approver"),f(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})};function Ys(){const[t,a]=s.useState(null),[r,p]=s.useState("login"),[d,S]=s.useState(()=>{try{const x=localStorage.getItem("currentUser");return x?JSON.parse(x):null}catch(x){return console.error("Failed to parse user from localStorage:",x),null}}),[C,w]=s.useState("create"),[R,O]=s.useState(!1),[_,J]=s.useState(!1),[f,V]=s.useState(!1),[z,$]=s.useState(!1),[m,K]=s.useState(!1),[W,N]=s.useState(!1),[b,I]=s.useState(!1),H=Kt();return s.useEffect(()=>{try{const M=new URLSearchParams(window.location.search).get("view");if(M==="admin"||M==="profile"||M==="dashboard"||M==="login"||M==="appadmin"||M==="hqmc-admin"||M==="hqmc-section"||M==="hqmc-approver"||M==="review"||M==="section"||M==="command"||M==="installation"||M==="installation-section"||M==="installation-command"||M==="documents"||M==="document-viewer"||M==="upload")p(M);else{const T=localStorage.getItem("currentView"),D=localStorage.getItem("currentUser");p(T&&D?T:"login")}}catch{p("login")}},[]),s.useEffect(()=>{d?localStorage.setItem("currentUser",JSON.stringify(d)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"))},[d]),s.useEffect(()=>{let x=!1;return(async()=>{try{const M=(d==null?void 0:d.id)||"";if(!M)return;const T=await $t(M);T&&!x&&(S(T),localStorage.setItem("currentUser",JSON.stringify(T)))}catch{}})(),()=>{x=!0}},[]),s.useEffect(()=>{r!=="login"&&d&&localStorage.setItem("currentView",r)},[r,d]),s.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const M=await vt();localStorage.setItem("unit_structure",JSON.stringify(M))}catch(x){console.error("Failed to load unit structure:",x)}})()},[]),s.useEffect(()=>{var M,T,D;try{const G=localStorage.getItem("unit_structure");if(!d||!G){J(!1);return}const v=JSON.parse(G),h=(d==null?void 0:d.unitUic)||"",U=d!=null&&d.company&&d.company!=="N/A"?d.company:"",q=d!=null&&d.platoon&&d.platoon!=="N/A"?d.platoon:"",X=((D=(T=(M=v==null?void 0:v[h])==null?void 0:M._platoonSectionMap)==null?void 0:T[U])==null?void 0:D[q])||"";J(!!X)}catch(G){console.error("Failed to parse unit structure for section dashboard check",G),J(!1)}const x=d==null?void 0:d.isCommandStaff;V(!!x),(async()=>{try{const G=(d==null?void 0:d.installationId)||"";if(!G){$(!1),K(!1);return}const v=await _t();try{localStorage.setItem("installations_cache",JSON.stringify(v))}catch{}const h=v==null?void 0:v.find(Z=>Z.id===G),U=(d==null?void 0:d.id)||"",q=!!(h&&h.sectionAssignments&&Object.values(h.sectionAssignments).some(Z=>Array.isArray(Z)&&Z.includes(U))),X=!!(h&&(h.commandSectionAssignments&&Object.values(h.commandSectionAssignments).some(Z=>Array.isArray(Z)&&Z.includes(U))||h.commanderUserId&&String(h.commanderUserId)===U));$(q),K(X)}catch{$(!1),K(!1)}})(),(async()=>{try{const G=String((d==null?void 0:d.hqmcDivision)||""),v=String((d==null?void 0:d.id)||"");if(!G||!v){N(!!(d!=null&&d.isHqmcAdmin));return}const{listHQMCSectionAssignmentsLegacy:h}=await Zt(async()=>{const{listHQMCSectionAssignmentsLegacy:Z}=await import("./db-Y4g5ldnd.js").then(F=>F.z);return{listHQMCSectionAssignmentsLegacy:Z}},__vite__mapDeps([0,1,2]),import.meta.url),U=await h(),q=U.some(Z=>Z.division_code===G&&((Z.reviewers||[]).includes(v)||(Z.approvers||[]).includes(v)));N(q||!!(d!=null&&d.isHqmcAdmin));const X=U.some(Z=>Z.division_code===G&&(Z.approvers||[]).includes(v));I(X)}catch{N(!!(d!=null&&d.isHqmcAdmin))}})()},[d]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(Js,{currentUser:d,hasSectionDashboard:_,hasCommandDashboard:f,hasInstallationSectionDashboard:z,hasInstallationCommandDashboard:m,hasHQMCSectionDashboard:W,hasHQMCApproverDashboard:b,onManageProfile:()=>{w("edit"),p("profile"),H("/?view=profile")},onLogout:()=>{S(null),p("login"),H("/?view=login")},onNavigate:x=>{p(x),H(`/?view=${x}`)},isLogin:r==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:r==="profile"?e.jsx(Ht,{mode:C,initial:C==="edit"?d||{}:{},onSaved:x=>{S(x),p("dashboard"),H("/?view=dashboard")}}):r==="admin"?e.jsx(Gs,{}):r==="appadmin"?e.jsx(Us,{}):r==="login"?e.jsx(Qs,{onLoggedIn:x=>{S(x),p("dashboard"),H("/?view=dashboard")},onCreateAccount:()=>{w("create"),p("profile"),H("/?view=profile")}}):r==="review"?e.jsx(Rs,{}):r==="section"?e.jsx(cs,{}):r==="command"?e.jsx(ds,{}):r==="installation"?e.jsx(is,{}):r==="hqmc-admin"?e.jsx($s,{}):r==="installation-section"?e.jsx(ms,{}):r==="installation-command"?e.jsx(us,{}):r==="hqmc-section"?e.jsx(qs,{}):r==="hqmc-approver"?e.jsx(Bs,{}):e.jsx(ws,{selectedUnit:t,currentUser:d})})]})}function la(){return e.jsx(Ys,{})}export{la as default};
