const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-BtncR-UB.js","./index-l_G8gL6a.js","./index-DOJlyb3T.css"])))=>i.map(i=>d[i]);
import{r as s,j as e,s as Vt,v as es,l as vt,M as Rt,a as ts,u as ss,R as as,b as ns,_ as rs}from"./index-l_G8gL6a.js";import{s as Oe,d as is,a as os,b as cs,l as kt,c as bt,e as ot,u as He,f as jt,g as ft,h as Ze,i as ls,j as ds,k as Wt,m as Ht,n as It,o as ms,p as zt,q as St,r as us,t as Ut,v as Qt,w as wt,x as Gt,y as Mt}from"./db-BtncR-UB.js";import{P as Ct,I as ps}from"./InstallationAdmin-CxeoG_vC.js";import{f as Jt,R as nt,S as Xe,o as Pt,c as xs,a as hs}from"./RequestTable-1bVWKNCH.js";import{c as gs,F as bs,D as Yt,a as it}from"./DocumentListItem-CqPEtXbE.js";import{l as yt}from"./unitStructure-QC5qYuxv.js";import fs from"./SectionDashboard-CGwLxBGe.js";import ys from"./CommandDashboard-BZ2PKn_7.js";import vs from"./InstallationSectionDashboard-mGzFx8p2.js";import Ns from"./InstallationCommandDashboard-C1PN8gcX.js";import{U as Je}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-CijCOflx.js";import"./utils-CLmukD0c.js";const js={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},Ss=({filters:t,onFiltersChange:a,statusOptions:i=[],originatorOptions:b=[],searchPlaceholder:c="Search requests...",showAdvanced:A=!0,className:E=""})=>{var V;const[N,P]=s.useState(!1),O=s.useRef(null),q=s.useMemo(()=>Array.isArray(t.status)?t.status:[],[t.status]),K=s.useMemo(()=>{let h=0;return q.length>0&&h++,t.dateFrom&&h++,t.dateTo&&h++,t.originatorId&&h++,h},[q,t.dateFrom,t.dateTo,t.originatorId]),j=s.useCallback(h=>{a({...t,search:h.target.value})},[t,a]),z=s.useCallback(h=>{const B=q.includes(h)?q.filter(u=>u!==h):[...q,h];a({...t,status:B})},[t,q,a]),U=s.useCallback(h=>{a({...t,dateFrom:h.target.value})},[t,a]),L=s.useCallback(h=>{a({...t,dateTo:h.target.value})},[t,a]),d=s.useCallback(h=>{a({...t,originatorId:h.target.value})},[t,a]),te=s.useCallback(()=>{var h;a(js),(h=O.current)==null||h.focus()},[a]),$=s.useCallback(()=>{var h;a({...t,search:""}),(h=O.current)==null||h.focus()},[t,a]);s.useEffect(()=>{const h=B=>{var u;(B.metaKey||B.ctrlKey)&&B.key==="k"&&(B.preventDefault(),(u=O.current)==null||u.focus())};return document.addEventListener("keydown",h),()=>document.removeEventListener("keydown",h)},[]);const R=t.search||K>0;return e.jsxs("div",{className:`space-y-3 ${E}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{ref:O,type:"text",value:t.search,onChange:j,placeholder:c,className:"block w-full pl-10 pr-10 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold bg-[var(--surface)] text-[var(--text)]","aria-label":"Search"}),t.search&&e.jsx("button",{onClick:$,className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600","aria-label":"Clear search",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute inset-y-0 right-8 flex items-center pointer-events-none text-xs text-gray-400",children:e.jsx("kbd",{className:"hidden sm:inline-block px-1.5 py-0.5 bg-gray-100 rounded border border-gray-200 font-mono",children:"⌘K"})})]}),A&&e.jsxs("button",{onClick:()=>P(!N),className:`
              flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors
              ${N||K>0?"bg-brand-gold/10 border-brand-gold text-brand-navy":"border-brand-navy/30 text-[var(--text)] hover:bg-brand-cream/50"}
            `,"aria-expanded":N,"aria-controls":"filter-panel",children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"})}),e.jsx("span",{className:"hidden sm:inline",children:"Filters"}),K>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-brand-navy rounded-full",children:K})]}),R&&e.jsxs("button",{onClick:te,className:"flex items-center gap-1 px-3 py-2 text-sm text-brand-red hover:text-brand-red-2 hover:bg-red-50 rounded-lg transition-colors","aria-label":"Clear all filters",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),A&&N&&e.jsxs("div",{id:"filter-panel",className:"p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[i.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Status"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:i.map(h=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-white/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:q.includes(h.value),onChange:()=>z(h.value),className:"h-4 w-4 text-brand-navy border-gray-300 rounded focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-[var(--text)]",children:h.label})]},h.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Date Range"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"From date"}),e.jsx("input",{type:"date",value:t.dateFrom,onChange:U,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"From date"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"To date"}),e.jsx("input",{type:"date",value:t.dateTo,onChange:L,min:t.dateFrom,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"To date"})]})]})]}),b.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Originator"}),e.jsxs("select",{value:t.originatorId,onChange:d,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"Filter by originator",children:[e.jsx("option",{value:"",children:"All originators"}),b.map(h=>e.jsx("option",{value:h.value,children:h.label},h.value))]})]})]}),K>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 pt-2 border-t border-brand-navy/10",children:[e.jsx("span",{className:"text-sm text-[var(--muted)]",children:"Active filters:"}),q.map(h=>{const B=i.find(u=>u.value===h);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[(B==null?void 0:B.label)||h,e.jsx("button",{onClick:()=>z(h),className:"hover:text-brand-red","aria-label":`Remove ${(B==null?void 0:B.label)||h} filter`,children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},h)}),t.dateFrom&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["From: ",t.dateFrom,e.jsx("button",{onClick:()=>a({...t,dateFrom:""}),className:"hover:text-brand-red","aria-label":"Remove from date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.dateTo&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["To: ",t.dateTo,e.jsx("button",{onClick:()=>a({...t,dateTo:""}),className:"hover:text-brand-red","aria-label":"Remove to date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.originatorId&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[((V=b.find(h=>h.value===t.originatorId))==null?void 0:V.label)||"Originator",e.jsx("button",{onClick:()=>a({...t,originatorId:""}),className:"hover:text-brand-red","aria-label":"Remove originator filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]})]})};function ws(t,a){return s.useMemo(()=>{let i=Array.isArray(a.items)?a.items:[];const b=Array.isArray(t.status)?t.status:[];if(t.search){const c=t.search.toLowerCase();i=i.filter(A=>a.getSearchText(A).toLowerCase().includes(c))}return b.length>0&&a.getStatus&&(i=i.filter(c=>b.includes(a.getStatus(c)))),(t.dateFrom||t.dateTo)&&a.getDate&&(i=i.filter(c=>{const A=a.getDate(c);if(!A)return!1;const E=new Date(A);if(isNaN(E.getTime()))return!1;if(t.dateFrom){const N=new Date(t.dateFrom);if(E<N)return!1}if(t.dateTo){const N=new Date(t.dateTo);if(N.setHours(23,59,59,999),E>N)return!1}return!0})),t.originatorId&&a.getOriginatorId&&(i=i.filter(c=>a.getOriginatorId(c)===t.originatorId)),i},[t,a])}function Ot(t){if(t==null)return"";const a=String(t);return a.includes('"')||a.includes(",")||a.includes(`
`)||a.includes("\r")?`"${a.replace(/"/g,'""')}"`:a}function Cs(t,a){const b=a.map(A=>Ot(A.header)).join(","),c=t.map(A=>a.map(E=>{const N=E.getValue(A),P=E.format?E.format(N):N;return Ot(P)}).join(","));return[b,...c].join(`\r
`)}function As(t,a){const i=t.map(b=>{const c={};return a.forEach(A=>{const E=A.getValue(b);c[A.header]=A.format?A.format(E):E}),c});return JSON.stringify(i,null,2)}function Dt(t,a,i){const b=new Blob([t],{type:`${i};charset=utf-8;`}),c=URL.createObjectURL(b),A=document.createElement("a");A.href=c,A.download=a,document.body.appendChild(A),A.click(),document.body.removeChild(A),URL.revokeObjectURL(c)}function Es({items:t,columns:a,filename:i="export",label:b="Export",variant:c="secondary",className:A="",disabled:E=!1,showCount:N=!0,formats:P=["csv"]}){const[O,q]=s.useState(!1),[K,j]=s.useState(!1),z=s.useRef(null),U=s.useCallback(te=>{j(!0),q(!1),setTimeout(()=>{try{const $=new Date().toISOString().slice(0,10),R=`${i}_${$}`;if(te==="csv"){const V=Cs(t,a);Dt(V,`${R}.csv`,"text/csv")}else{const V=As(t,a);Dt(V,`${R}.json`,"application/json")}}catch($){console.error("Export failed:",$)}finally{j(!1)}},100)},[t,a,i]);s.useEffect(()=>{const te=$=>{z.current&&!z.current.contains($.target)&&q(!1)};return O&&document.addEventListener("mousedown",te),()=>{document.removeEventListener("mousedown",te)}},[O]),s.useEffect(()=>{const te=$=>{$.key==="Escape"&&q(!1)};return O&&document.addEventListener("keydown",te),()=>{document.removeEventListener("keydown",te)}},[O]);const L={primary:"bg-brand-navy text-brand-cream hover:bg-brand-navy/90",secondary:"bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold/10",text:"text-brand-navy hover:bg-brand-cream/50"},d=E||t.length===0||K;return P.length===1?e.jsxs("button",{onClick:()=>U(P[0]),disabled:d,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${L[c]}
          ${A}
        `,children:[K?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:b}),N&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]})]}):e.jsxs("div",{className:"relative",ref:z,children:[e.jsxs("button",{onClick:()=>q(!O),disabled:d,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${L[c]}
          ${A}
        `,"aria-expanded":O,"aria-haspopup":"menu",children:[K?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:b}),N&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${O?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),O&&e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-[var(--surface)] border border-brand-navy/20 rounded-lg shadow-lg z-50",role:"menu",children:[P.includes("csv")&&e.jsxs("button",{onClick:()=>U("csv"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 first:rounded-t-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export as CSV"]}),P.includes("json")&&e.jsxs("button",{onClick:()=>U("json"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 last:rounded-b-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})}),"Export as JSON"]})]})]})}const $t=t=>{if(!t)return"";const a=new Date(t);return isNaN(a.getTime())?"":a.toLocaleDateString()};function At(t,a={}){const{pageSize:i=25,initialPage:b=1}=a,[c,A]=s.useState(b),[E,N]=s.useState(i),P=t.length,O=Math.ceil(P/E),q=(c-1)*E,K=Math.min(q+E,P);return{currentData:s.useMemo(()=>t.slice(q,K),[t,q,K]),currentPage:c,pageSize:E,totalPages:O,totalItems:P,goToPage:R=>{const V=Math.max(1,Math.min(R,O));A(V)},nextPage:()=>{c<O&&A(c+1)},previousPage:()=>{c>1&&A(c-1)},goToFirstPage:()=>{A(1)},goToLastPage:()=>{A(O)},setPageSize:R=>{N(R),A(1)},canGoNext:c<O,canGoPrevious:c>1,startIndex:q+1,endIndex:K}}const lt="edms-docs";function ks(){return{uploadFile:async(A,E)=>{if(!Oe)return{url:"",error:"Supabase not configured"};try{const{error:N}=await Oe.storage.from(lt).upload(E,A,{upsert:!0});if(N)return{url:"",error:N.message};const{data:P}=Oe.storage.from(lt).getPublicUrl(E);return{url:(P==null?void 0:P.publicUrl)||""}}catch(N){return{url:"",error:N instanceof Error?N.message:"Upload failed"}}},deleteFile:async A=>{if(!Oe||!A)return!1;try{return await Oe.storage.from(lt).remove([A]),!0}catch{return!1}},deleteFolder:async A=>{if(!Oe)return!1;try{const{data:E}=await Oe.storage.from(lt).list(A.replace(/\/$/,""));if(E&&E.length>0){const N=E.map(P=>`${A.replace(/\/$/,"")}/${P.name}`);await Oe.storage.from(lt).remove(N)}return!0}catch{return!1}},extractStoragePath:A=>{if(!A)return null;try{const E=A.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(E!=null&&E[1])return decodeURIComponent(E[1])}catch{}return null},buildStoragePath:(A,E,N,P)=>{const O=Date.now();return`${A||"N-A"}/${E}/${O}-${P}-${Vt(N)}`}}}const Qe=t=>{const a=String(t||"").trim();return a&&a!=="N/A"?a:""},at=(t,a,i)=>t.some(b=>String(b.role||"")!==a||Qe(b.roleCompany||b.company)!==i.company||a==="PLATOON_REVIEWER"&&Qe(b.rolePlatoon||b.platoon)!==(i.platoon||"")?!1:String(b.unitUic||"")===String(i.uic||""));function Kt(t){if(t===0)return"0 Bytes";const a=1024,i=["Bytes","KB","MB","GB"],b=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,b)).toFixed(2))+" "+i[b]}const _t=s.memo(function({doc:a,onView:i,onDelete:b}){const[c,A]=s.useState(!1),E=a.fileUrl&&gs(a.type,a.name);return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:"flex items-center justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors","aria-label":`Document: ${a.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(bs,{type:a.type,fileName:a.name,size:"md"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-[var(--text)]",children:a.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)]",children:[a.name," • ",Kt(a.size)," • ",new Date(a.uploadedAt).toLocaleDateString()]}),a.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(a.dueDate).toLocaleDateString()]}),a.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Notes: ",a.notes]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",role:"group","aria-label":"Document actions",children:[a.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Jt({currentStage:a.currentStage})}),E&&e.jsx("button",{type:"button",onClick:N=>{N.stopPropagation(),A(!0)},className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Preview document ${a.name}`,children:"Preview"}),a.fileUrl&&e.jsx("a",{href:a.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${a.name} in new tab`,children:"Open"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:N=>{N.stopPropagation(),i(a)},"aria-label":`View or edit document ${a.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:N=>{N.stopPropagation(),b(a)},"aria-label":`Delete document ${a.subject}`,children:"Delete"})]})]}),a.fileUrl&&e.jsx(Yt,{url:a.fileUrl,fileName:a.name,mimeType:a.type,fileSize:a.size,isOpen:c,onClose:()=>A(!1)})]})}),st="edms-docs",Is=({selectedUnit:t,currentUser:a})=>{const[i,b]=s.useState([]),[c,A]=s.useState(!1),[E,N]=s.useState(""),[P,O]=s.useState(""),[q,K]=s.useState(""),[j,z]=s.useState([]),[U,L]=s.useState(null),[d,te]=s.useState(null),[$,R]=s.useState([]),[V,h]=s.useState(!1),[B,u]=s.useState(null),[k,_]=s.useState(""),[w,F]=s.useState(""),[g,x]=s.useState(""),[Q,W]=s.useState([]),[G,ne]=s.useState([]),[T,ve]=s.useState(null),[ke,Ae]=s.useState(""),[f,Z]=s.useState(""),[ae,re]=s.useState(""),[X,fe]=s.useState([]),[y,H]=s.useState(!1),[pe,le]=s.useState({}),[ce,Ce]=s.useState(""),[we,De]=s.useState("Pending"),[$e,Be]=s.useState({}),[_e,Fe]=s.useState(""),v=ks(),I=m=>{const C=m.target.files?Array.from(m.target.files):[];if(C.length===0)return;if(j.length+C.length>Rt){L({type:"error",message:`Cannot add ${C.length} file(s). Maximum ${Rt} files allowed per request.`});try{m.target.value=""}catch{}return}const M=[],J=[];for(const Y of C){const ye=ts(Y);ye.valid?M.push(Y):J.push(...ye.errors)}M.length>0&&z(Y=>[...Y,...M]),J.length>0&&L({type:"error",message:J.slice(0,3).join(" ")+(J.length>3?` (+${J.length-3} more errors)`:"")});try{m.target.value=""}catch{}},r=async()=>{if(!T||!(d!=null&&d.id)||T.uploadedById!==d.id)return;const m={actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,timestamp:new Date().toISOString(),action:"Archived by Originator",comment:(ae||"").trim()},C={...T,currentStage:Xe.ARCHIVED,finalStatus:"Archived",activity:Array.isArray(T.activity)?[...T.activity,m]:[m]};try{const M=await He(C);if(!M.ok)throw new Error(xe(M,"request_upsert_failed"));ne(J=>J.map(Y=>Y.id===C.id?C:Y)),ve(C),L({type:"success",message:"Request archived."})}catch(M){L({type:"error",message:`Failed to archive: ${String((M==null?void 0:M.message)||M)}`})}},o=async()=>{if(!T||!(d!=null&&d.id)||T.uploadedById!==d.id)return;const m=$.find(ue=>ue.id===T.uploadedById),C=T.unitUic||(m==null?void 0:m.unitUic)||"",M=Qe(m==null?void 0:m.company),J=Qe(m==null?void 0:m.platoon),Y=at($,"PLATOON_REVIEWER",{company:M,platoon:J,uic:C}),ye=at($,"COMPANY_REVIEWER",{company:M,uic:C}),ge=Y?Xe.PLATOON_REVIEW:ye?Xe.COMPANY_REVIEW:Xe.BATTALION_REVIEW,me={actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,actorRole:"Member",timestamp:new Date().toISOString(),action:"Resubmitted request",comment:(ae||"").trim()},Pe={...T,currentStage:ge,routeSection:"",activity:[...T.activity||[],me]};try{const ue=await He(Pe);if(!ue.ok)throw new Error(xe(ue,"request_upsert_failed"));ne(qe=>qe.map(Te=>Te.id===Pe.id?Pe:Te)),ve(Pe),re(""),L({type:"success",message:"Request resubmitted for review."})}catch(ue){L({type:"error",message:`Failed to resubmit: ${String((ue==null?void 0:ue.message)||ue)}`})}},D=async m=>{m.preventDefault(),L(null);const C=E.trim();if(!C){L({type:"error",message:"Subject is required."});return}if(C.length>500){L({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(q.length>5e3){L({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(d!=null&&d.id)){L({type:"error",message:"Create a profile before submitting."});return}if(j.length>0){const ue=es(j);if(!ue.valid){L({type:"error",message:ue.errors[0]});return}}A(!0);const M=Date.now(),J=ce||d.id,Y=$.find(ue=>ue.id===J),ye=t?t.uic:(Y==null?void 0:Y.unitUic)||"N/A",ge=`req-${M}`;let me=[];async function Pe(ue,qe){if(!Oe)throw new Error("Supabase not configured");const{error:Te}=await Oe.storage.from(st).upload(qe,ue,{upsert:!0});if(Te)throw new Error(Te.message);const{data:ze}=Oe.storage.from(st).getPublicUrl(qe);return(ze==null?void 0:ze.publicUrl)||""}if(j&&j.length>0){const ue=[];for(let qe=0;qe<j.length;qe++){const Te=j[qe],ze=`${ye}/${ge}/${M}-${qe}-${Vt(Te.name)}`;try{const Ue=await Pe(Te,ze);ue.push(Ue)}catch(Ue){A(!1),L({type:"error",message:`Failed to upload ${Te.name}: ${String((Ue==null?void 0:Ue.message)||Ue)}`});return}}me=j.map((qe,Te)=>({id:`${M}-${Te}`,name:qe.name,type:qe.type,size:qe.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:ye,subject:E.trim(),dueDate:P||void 0,notes:q.trim()||void 0,uploadedById:J,currentStage:"PLATOON_REVIEW",fileUrl:ue[Te]}))}me=me.map(ue=>({...ue,requestId:ge})),b(ue=>[...ue,...me]),z([]),N(""),O(""),K("");try{const ue=d?`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`:"Unknown",qe="Member",Te=ye,ze=Qe(Y==null?void 0:Y.company),Ue=Qe(Y==null?void 0:Y.platoon),ut=at($,"PLATOON_REVIEWER",{company:ze,platoon:Ue,uic:Te}),pt=at($,"COMPANY_REVIEWER",{company:ze,uic:Te}),n=!ut&&!pt,l={id:ge,subject:E.trim(),dueDate:P||void 0,notes:q.trim()||void 0,unitUic:ye,uploadedById:J,submitForUserId:J,documentIds:me.map(S=>S.id),createdAt:new Date().toISOString(),currentStage:ut?Xe.PLATOON_REVIEW:pt?Xe.COMPANY_REVIEW:Xe.BATTALION_REVIEW,routeSection:n&&_e?_e:void 0,activity:[{actor:ue,actorRole:qe,timestamp:new Date().toISOString(),action:"Submitted request",comment:(q||"").trim()}]};try{const S=await He(l);if(!S.ok)throw new Error(xe(S,"request_upsert_failed"));const se=await jt(me);if(!se.ok)throw new Error(xe(se,"document_upsert_failed"))}catch(S){A(!1);try{vt("request_persist_failed",{requestId:ge,error:String((S==null?void 0:S.message)||S)},"error")}catch{}L({type:"error",message:`Failed to persist submission: ${String((S==null?void 0:S.message)||S)}`});return}ne(S=>S.some(be=>be.id===l.id)?S.map(be=>be.id===l.id?l:be):[...S,l]),A(!1),L({type:"success",message:"Submission successful."}),h(!1),Fe("")}catch{A(!1);try{vt("request_persist_failed",{requestId:ge},"error")}catch{}L({type:"error",message:"Failed to persist submission."})}},ee=s.useCallback(m=>{u(m),_(m.subject||""),F(m.dueDate||""),x(m.notes||"");try{const C=localStorage.getItem(`fs/requests/${m.requestId}.json`);if(C){const M=JSON.parse(C);W(Array.isArray(M.activity)?M.activity:[])}else{const Y=Object.values(Object.assign({})).map(ye=>(ye==null?void 0:ye.default)??ye).find(ye=>ye&&ye.id===m.requestId);W(Y&&Array.isArray(Y.activity)?Y.activity:[])}}catch{W([])}},[]),xe=(m,C)=>{var M;return String(((M=m.error)==null?void 0:M.message)||m.error||C)},de=async()=>{if(!B)return;const m=i.map(C=>C.id===B.id?{...C,subject:k.trim()||C.subject,dueDate:w||void 0,notes:g.trim()||void 0}:C);b(m);try{const J={actor:d?`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`:"Unknown",actorRole:"Member",timestamp:new Date().toISOString(),action:"Updated document",comment:(g||"").trim()},Y=B.requestId?G.find(ye=>ye.id===B.requestId):null;if(Y){const ye={...Y,activity:Array.isArray(Y.activity)?[...Y.activity,J]:[J]};try{const ge=await He(ye);if(!ge.ok)throw new Error(xe(ge,"request_upsert_failed"))}catch(ge){console.error("Failed to save document edits:",ge),L({type:"error",message:`Failed to save document edits: ${ge.message}`});return}W(ge=>[...ge,J])}}catch{}x(""),u(null)};i.filter(m=>!(!(d!=null&&d.id)||d.role==="MEMBER"&&m.uploadedById!==d.id||m.type==="request"));const Re=m=>m.currentStage==="ORIGINATOR_REVIEW",Ie=()=>String((d==null?void 0:d.role)||"").includes("REVIEW"),he=()=>{if(!Ie())return[];const m=String((d==null?void 0:d.role)||"");return $.filter(C=>{if(C.id===(d==null?void 0:d.id))return!1;if(m.includes("PLATOON")){const M=C.company&&C.company!=="N/A"?C.company:"",J=C.unit&&C.unit!=="N/A"?C.unit:"",Y=d!=null&&d.company&&d.company!=="N/A"?d.company:"",ye=d!=null&&d.unit&&d.unit!=="N/A"?d.unit:"";return M===Y&&J===ye}if(m.includes("COMPANY")){const M=C.company&&C.company!=="N/A"?C.company:"",J=d!=null&&d.company&&d.company!=="N/A"?d.company:"";return M===J}return m.includes("COMMANDER")?(C.unitUic||"")===((d==null?void 0:d.unitUic)||""):!1})},Me=s.useCallback(async m=>{const C=v.extractStoragePath(m.fileUrl);try{C&&Oe&&await Oe.storage.from(st).remove([C])}catch{}try{await is(m.id),b(M=>M.filter(J=>J.id!==m.id)),m.requestId&&ne(M=>M.map(J=>J.id===m.requestId?{...J,documentIds:(J.documentIds||[]).filter(Y=>Y!==m.id)}:J)),L({type:"success",message:"Document deleted."})}catch(M){L({type:"error",message:`Failed to delete: ${String((M==null?void 0:M.message)||M)}`})}},[]),We=s.useCallback(async m=>{const C=`${m.unitUic||"N-A"}/${m.id}/`;try{if(Oe){const{data:M}=await Oe.storage.from(st).list(C.slice(0,-1));if(M&&M.length>0){const J=M.map(Y=>`${C.slice(0,-1)}/${Y.name}`);await Oe.storage.from(st).remove(J)}}}catch{}try{await os(m.id),await cs(m.id),b(M=>M.filter(J=>J.requestId!==m.id)),ne(M=>M.filter(J=>J.id!==m.id)),ve(null),L({type:"success",message:"Request and files deleted."})}catch(M){L({type:"error",message:`Failed to delete request: ${String((M==null?void 0:M.message)||M)}`})}},[]),et=async()=>{if(!T||!(d!=null&&d.id)||T.uploadedById!==d.id){L({type:"error",message:"Only the requester can edit this."});return}const m=Date.now(),C=ge=>ge.replace(/[^A-Za-z0-9._-]/g,"-");async function M(ge,me){if(!Oe)throw new Error("Supabase not configured");const{error:Pe}=await Oe.storage.from(st).upload(me,ge,{upsert:!0});if(Pe)throw new Error(Pe.message);const{data:ue}=Oe.storage.from(st).getPublicUrl(me);return(ue==null?void 0:ue.publicUrl)||""}const J=[];for(let ge=0;ge<X.length;ge++){const me=X[ge],Pe=`${T.unitUic||"N-A"}/${T.id}/${m}-${ge}-${C(me.name)}`;try{const ue=await M(me,Pe);J.push(ue)}catch(ue){L({type:"error",message:`Failed to upload ${me.name}: ${String((ue==null?void 0:ue.message)||ue)}`});return}}const Y=X.map((ge,me)=>({id:`${m}-${me}`,name:ge.name,type:ge.type,size:ge.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:T.unitUic||"N/A",subject:ke.trim()||T.subject,dueDate:f||void 0,notes:ae.trim()||void 0,uploadedById:d.id,currentStage:T.currentStage||"PLATOON_REVIEW",requestId:T.id,fileUrl:J[me]})),ye={...T,subject:ke.trim()||T.subject,dueDate:f||void 0,notes:ae.trim()||void 0,documentIds:[...T.documentIds||[],...Y.map(ge=>ge.id)],activity:[...T.activity||[],{actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,timestamp:new Date().toISOString(),action:Y.length?`Updated request and added ${Y.length} document(s)`:"Updated request",comment:(ae||"").trim()}]};try{if(!(d&&hs(T,String(d.id||"")))){L({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const me=await jt(Y);if(!me.ok)throw new Error(xe(me,"document_upsert_failed"));const Pe=await He(ye);if(!Pe.ok)throw new Error(xe(Pe,"request_upsert_failed"))}catch(me){try{vt("request_update_failed",{requestId:ye.id,error:String((me==null?void 0:me.message)||me)},"error")}catch{}L({type:"error",message:`Failed to persist documents: ${String((me==null?void 0:me.message)||me)}`});return}b(me=>[...me,...Y]),ne(me=>me.map(Pe=>Pe.id===ye.id?ye:Pe)),ve(ye),fe([]),re(""),L({type:"success",message:Y.length?"Files added and request updated.":"Request updated."})}catch{L({type:"error",message:"Failed to update request."})}},[p,oe]=s.useState(!0),[Ne,Le]=s.useState(!0);s.useEffect(()=>{kt().then(m=>{b(m)}).catch(()=>b([])).finally(()=>oe(!1))},[]),s.useEffect(()=>{T&&(Ae(T.subject||""),Z(T.dueDate||""),re(T.notes||""),fe([]))},[T]),s.useEffect(()=>{},[i]),s.useEffect(()=>{bt().then(m=>{ne(m)}).catch(()=>ne([])).finally(()=>Le(!1))},[]),s.useEffect(()=>{te(a||null)},[a]),s.useEffect(()=>{ot().then(m=>{R(m)}).catch(()=>R([]))},[]),s.useEffect(()=>{try{const m=localStorage.getItem("unit_structure"),C={};if(m){const M=JSON.parse(m);for(const J of Object.keys(M||{})){const Y=M[J];Y&&Array.isArray(Y._sections)&&(C[J]=Y._sections)}Be(C)}else(async()=>{try{const M=await yt();for(const J of Object.keys(M||{})){const Y=M[J];Y&&Array.isArray(Y._sections)&&(C[J]=Y._sections)}Be(C)}catch{}})()}catch{}},[]);const tt=s.useMemo(()=>{if(!(d!=null&&d.id))return[];const m=G.filter(C=>C.uploadedById===d.id);return we==="Pending"?m.filter(C=>C.currentStage!=="ARCHIVED"):m.filter(C=>C.currentStage==="ARCHIVED")},[G,d,we]),je=At(tt,{pageSize:10}),Ee=s.useMemo(()=>$.reduce((m,C)=>({...m,[C.id]:C}),{}),[$]),Ye=s.useMemo(()=>{const m=ce||(d==null?void 0:d.id),C=$.find(me=>me.id===m),M=t?t.uic:(C==null?void 0:C.unitUic)||"",J=Qe(C==null?void 0:C.company),Y=Qe(C==null?void 0:C.platoon);if(!M)return!1;const ye=at($,"PLATOON_REVIEWER",{company:J,platoon:Y,uic:M}),ge=at($,"COMPANY_REVIEWER",{company:J,uic:M});return!ye&&!ge},[$,d,ce,t]),Ke=s.useMemo(()=>{const m=ce||(d==null?void 0:d.id),C=$.find(J=>J.id===m),M=t?t.uic:(C==null?void 0:C.unitUic)||"";return $e[M]||[]},[$e,$,d,ce,t]),mt=s.useCallback(m=>{const C=Qe(m.currentStage||"PLATOON_REVIEW"),M=$.find(J=>J.id===m.uploadedById);switch(C){case"ORIGINATOR_REVIEW":return{level:"Member",scope:""};case"PLATOON_REVIEW":{const J=M!=null&&M.company&&M.company!=="N/A"?M.company:"",Y=M!=null&&M.platoon&&M.platoon!=="N/A"?M.platoon:"";return J&&Y?{level:"Platoon",scope:`(${J}-${Y})`}:J?{level:"Platoon",scope:`(${J})`}:{level:"Platoon",scope:""}}case"COMPANY_REVIEW":{const J=M!=null&&M.company&&M.company!=="N/A"?M.company:"";return{level:"Company",scope:J?`(${J})`:""}}case"BATTALION_REVIEW":return{level:"Battalion",scope:m.routeSection?`(${m.routeSection})`:""};case"COMMANDER_REVIEW":return{level:"Commander",scope:m.routeSection?`(${m.routeSection})`:""};case"ARCHIVED":return{level:"Archived",scope:""};default:return{level:Jt(m),scope:""}}},[$]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>h(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),V&&e.jsxs("form",{onSubmit:D,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:E,onChange:m=>N(m.target.value),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${E.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:P,onChange:m=>O(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),String((d==null?void 0:d.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:ce,onChange:m=>Ce(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),he().map(m=>e.jsxs("option",{value:m.id,children:[m.rank," ",m.lastName,", ",m.firstName,m.mi?` ${m.mi}`:""]},m.id))]})]})}),Ye&&Ke.length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Battalion Section"}),e.jsxs("select",{value:_e,onChange:m=>Fe(m.target.value),className:`w-full px-3 py-2 border ${_e?"border-brand-navy/30":"border-brand-gold"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`,children:[e.jsx("option",{value:"",children:"Select section"}),Ke.map(m=>e.jsx("option",{value:m,children:m},m))]}),e.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"No platoon/company reviewer available. Select a section for routing."})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:q,onChange:m=>K(m.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:I,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:j.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:j.map((m,C)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:m.name,children:m.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>z(M=>M.filter((J,Y)=>Y!==C)),children:"Delete"})]},C))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{h(!1),z([]),N(""),O(""),K(""),Fe(""),L(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!E.trim(),children:"Submit"})]})]}),U&&e.jsx("div",{className:`p-3 rounded-lg border ${U.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:U.message})]})]}),e.jsxs("div",{className:"p-6",children:[d&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>De("Pending"),className:`${we==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>De("Archived"),className:`${we==="Archived"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Archived"})]})}),e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:je.totalItems>0?`${je.startIndex}–${je.endIndex} of ${je.totalItems}`:""}),Ne&&e.jsx("div",{className:"animate-pulse",children:"Loading requests…"})]}),e.jsx(nt,{title:"Your Requests",requests:Ne?Array.from({length:5}).map((m,C)=>({id:`s-${C}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:Xe.PLATOON_REVIEW})):je.currentData,users:Ee,onRowClick:m=>ve(m),expandedRows:pe,children:m=>e.jsxs("div",{id:`req-docs-${m.id}`,children:[p?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):i.filter(C=>C.requestId===m.id&&C.type!=="request").map(C=>e.jsx(_t,{doc:C,onView:ee,onDelete:Me},C.id)),!p&&i.filter(C=>C.requestId===m.id&&C.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),je.totalItems>0&&e.jsx(Ct,{currentPage:je.currentPage,totalPages:je.totalPages,totalItems:je.totalItems,pageSize:je.pageSize,startIndex:je.startIndex,endIndex:je.endIndex,onPageChange:je.goToPage,onPageSizeChange:je.setPageSize,onNext:je.nextPage,onPrevious:je.previousPage,onFirst:je.goToFirstPage,onLast:je.goToLastPage,canGoNext:je.canGoNext,canGoPrevious:je.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),c&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),B&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>u(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:k,onChange:m=>_(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:w,onChange:m=>F(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:B.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:g,onChange:m=>x(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[B.name," • ",Kt(B.size)," • ",new Date(B.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:Q.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):Q.map((m,C)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[m.actor,m.actorRole?` • ${m.actorRole}`:""," • ",new Date(m.timestamp).toLocaleString()," • ",m.action]}),m.comment&&e.jsx("div",{className:"text-gray-600",children:m.comment})]},C))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>u(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:de,children:"Save"})]})]})}),T&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>ve(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>ve(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:ke,onChange:m=>Ae(m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(T.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:f,onChange:m=>Z(m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),T.currentStage&&(()=>{const{level:m,scope:C}=mt(T);return e.jsxs("span",{className:"inline-flex flex-col items-center px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-lg border border-brand-navy/30 leading-tight",children:[e.jsx("span",{children:m}),C&&e.jsx("span",{className:"text-[10px]",children:C})]})})(),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:3,value:ae,onChange:m=>re(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:T.activity&&T.activity.length?T.activity.map((m,C)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[m.actor,m.actorRole?` • ${m.actorRole}`:""," • ",new Date(m.timestamp).toLocaleString()," • ",m.action]}),m.comment&&e.jsx("div",{className:"text-gray-600",children:m.comment})]},C)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Documents"}),e.jsxs("button",{className:"mt-2 px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-expanded":y,"aria-controls":"docs-panel",onClick:()=>H(m=>!m),children:[y?"Hide":"Show"," Documents"]}),e.jsx("div",{id:"docs-panel",className:y?"mt-3 space-y-2":"hidden",children:i.filter(m=>m.requestId===T.id&&m.type!=="request").map(m=>e.jsx(_t,{doc:m,onView:ee,onDelete:Me},m.id))}),!Pt(T,String((d==null?void 0:d.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:m=>{const C=m.target.files?Array.from(m.target.files):[];fe(M=>[...M,...C]);try{m.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:X.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):X.map((m,C)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:m.name,children:m.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>fe(M=>M.filter((J,Y)=>Y!==C)),children:"Delete"})]},C))})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>ve(null),children:"Close"}),Pt(T,String((d==null?void 0:d.id)||""))?e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-gold text-brand-charcoal hover:brightness-110",onClick:r,children:"Archive"}):e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:et,disabled:!d||d.id!==((T==null?void 0:T.uploadedById)||""),children:"Save Changes"}),d&&Re(T)&&d.id===T.uploadedById&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700",onClick:o,children:"Resubmit"}),d&&xs(T,String((d==null?void 0:d.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>We(T),children:"Delete Request"})]})]})})]})},Rs=({currentUser:t,onClose:a})=>{const[i,b]=s.useState([]),[c,A]=s.useState(""),[E,N]=s.useState(!1),[P,O]=s.useState(""),[q,K]=s.useState(!1),[j,z]=s.useState("");s.useEffect(()=>{ft().then(R=>{b(R.data||[])}).catch(()=>b([]))},[]);const U=s.useMemo(()=>String(t.role||"")!=="MEMBER",[t]),L=s.useMemo(()=>{const R=V=>{const h=t.unitUic||"",B=String(t.role||"");if(B.includes("PLATOON")){const u=V.company&&V.company!=="N/A"?V.company:"",k=V.platoon&&V.platoon!=="N/A"?V.platoon:"",_=t.company&&t.company!=="N/A"?t.company:"",w=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return u===_&&k===w}if(B.includes("COMPANY")){const u=V.company&&V.company!=="N/A"?V.company:"",k=t.company&&t.company!=="N/A"?t.company:"";return u===k}return B.includes("COMMANDER")?(V.unitUic||"")===h:!1};return i.filter(V=>V.id!==t.id&&R(V))},[i,t]),d=s.useMemo(()=>{const R=String(t.role||""),V=h=>{const B=t.unitUic||"";if(R.includes("PLATOON")){const u=h.company&&h.company!=="N/A"?h.company:"",k=h.platoon&&h.platoon!=="N/A"?h.platoon:"",_=t.company&&t.company!=="N/A"?t.company:"",w=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return u===_&&k===w}if(R.includes("COMPANY")){const u=h.company&&h.company!=="N/A"?h.company:"",k=t.company&&t.company!=="N/A"?t.company:"";return u===k}return R.includes("COMMANDER")?(h.unitUic||"")===B:!1};return i.filter(h=>h.id!==t.id&&V(h)&&String(h.role||"")===R)},[i,t]),te=async()=>{try{N(!0),O("");const R=i.find(u=>u.id===c);if(!U||!R){N(!1);return}const V=String(t.role||""),h={...R};if(h.role=V,V.includes("PLATOON")){h.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A";const u=t.platoon&&t.platoon!=="N/A"?t.platoon:"N/A";h.rolePlatoon=u}else V.includes("COMPANY")?(h.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A",h.rolePlatoon="N/A"):V.includes("COMMANDER")&&(h.roleCompany="N/A",h.rolePlatoon="N/A");try{if(!(await Ze({id:h.id,email:h.email,rank:h.rank,firstName:h.firstName,lastName:h.lastName,mi:h.mi,service:h.service,role:h.role,unitUic:h.unitUic,unit:h.unit,company:h.company,isUnitAdmin:!!h.isUnitAdmin,isCommandStaff:!!h.isCommandStaff,edipi:h.edipi,passwordHash:h.passwordHash,roleCompany:h.roleCompany,rolePlatoon:h.rolePlatoon})).ok)throw new Error("persist_failed")}catch{O("Failed to persist user changes")}const B={actorId:t.id,actorRole:t.role,targetId:h.id,grantedRole:h.role,timestamp:new Date().toISOString(),scope:{unitUic:t.unitUic||"",company:t.company,unit:t.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(B)})}catch{}b(u=>u.map(k=>k.id===h.id?h:k)),A(""),K(!1),N(!1)}catch{N(!1),O("Operation failed")}},$=async R=>{try{N(!0),O("");const V=i.find(_=>_.id===R);if(!V){N(!1);return}const h=String(t.role||"");if(!d.some(_=>_.id===R)){N(!1),O("Target not in scope");return}const u={...V};u.role="MEMBER",u.company="N/A",u.unit="N/A",u.isCommandStaff=!1,u.roleCompany="N/A",u.rolePlatoon="N/A";try{if(!(await Ze({id:u.id,email:u.email,rank:u.rank,firstName:u.firstName,lastName:u.lastName,mi:u.mi,service:u.service,role:u.role,unitUic:u.unitUic,unit:u.unit,company:u.company,isUnitAdmin:!!u.isUnitAdmin,isCommandStaff:!!u.isCommandStaff,edipi:u.edipi,passwordHash:u.passwordHash,roleCompany:u.roleCompany,rolePlatoon:u.rolePlatoon})).ok)throw new Error("persist_failed")}catch{O("Failed to persist user changes")}const k={actorId:t.id,actorRole:t.role,targetId:u.id,action:"Revoked",previousRole:h,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)})}catch{}b(_=>_.map(w=>w.id===u.id?u:w)),z(""),N(!1)}catch{N(!1),O("Operation failed")}};return U?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:a,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:R=>R.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:a,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:c,onChange:R=>A(R.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),L.map(R=>e.jsxs("option",{value:R.id,children:[R.rank," ",R.lastName,", ",R.firstName,R.mi?` ${R.mi}`:""," • ",R.email]},R.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[d.map(R=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[R.rank," ",R.lastName,", ",R.firstName,R.mi?` ${R.mi}`:""," • ",R.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>z(R.id),children:"Remove Access"})]},R.id)),d.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),P&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:P})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!c||E,onClick:()=>K(!0),children:"Grant Equivalent Permission"})}),q&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>K(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:E,onClick:te,children:"Confirm"})]})]}),j&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>z(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:E,onClick:()=>$(j),children:"Remove"})]})]})]})}):null},Lt="ORIGINATOR_REVIEW",Ge=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Ms=[{value:"PLATOON_REVIEW",label:"Platoon Review"},{value:"COMPANY_REVIEW",label:"Company Review"},{value:"BATTALION_REVIEW",label:"Battalion Review"},{value:"COMMANDER_REVIEW",label:"Commander Review"},{value:"ARCHIVED",label:"Archived"}],Ps={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},Os=t=>{const a=Ge.indexOf(t||Ge[0]);return a>=0&&a<Ge.length-1?Ge[a+1]:Ge[a]||Ge[0]},qt=t=>{const a=Ge.indexOf(t||Ge[0]);return a>0?Ge[a-1]:Ge[0]},gt=(t,a)=>{var i;return((i=t.activity)==null?void 0:i.some(b=>a.test(String(b.action||""))))||!1},Ds=t=>gt(t,/(approved by commander|commander.*approved)/i)&&!gt(t,/installation commander/i),$s=t=>gt(t,/(endorsed by commander|commander.*endorsed)/i)&&!gt(t,/installation commander/i),Nt=t=>{if(!t)return"MEMBER";const a=String(t.role||"MEMBER"),i=(t.roleCompany||t.company||"").trim(),b=(t.rolePlatoon||t.platoon||"").trim();switch(a){case"PLATOON_REVIEWER":if(i&&b)return`Platoon (${i}-${b})`;break;case"COMPANY_REVIEWER":if(i)return`Company (${i})`;break;case"BATTALION_REVIEWER":return"Battalion";case"COMMANDER_REVIEWER":return"Commander"}return a};function _s(){const t=ss(),[a,i]=s.useState(()=>{try{const r=localStorage.getItem("currentUser");return r?JSON.parse(r):null}catch(r){return console.error("Failed to parse user from localStorage:",r),null}}),[b,c]=s.useState([]),[A,E]=s.useState([]),[N,P]=s.useState({}),[O,q]=s.useState({}),[K,j]=s.useState({}),[z,U]=s.useState({}),[L,d]=s.useState({}),[te,$]=s.useState({}),[R,V]=s.useState({}),[h,B]=s.useState(!1),[u,k]=s.useState({}),[_,w]=s.useState({}),[F,g]=s.useState(!1),[x,Q]=s.useState({}),[W,G]=s.useState(null),ne=s.useRef(null),[T,ve]=s.useState("Pending"),[ke,Ae]=s.useState(Ps),[f,Z]=s.useState(null);s.useEffect(()=>{const r=D=>{W&&ne.current&&!ne.current.contains(D.target)&&(Q(ee=>({...ee,[W]:!1})),G(null))},o=D=>{D.key==="Escape"&&W&&(Q(ee=>({...ee,[W]:!1})),G(null))};return document.addEventListener("mousedown",r),document.addEventListener("keydown",o),()=>{document.removeEventListener("mousedown",r),document.removeEventListener("keydown",o)}},[W]),s.useEffect(()=>{ls().then(r=>{c(r.data||[])}).catch(()=>c([]))},[]),s.useEffect(()=>{ds().then(r=>{E(r.data||[])}).catch(()=>E([]))},[]),s.useEffect(()=>{ft().then(r=>{const o={},D=r.data||[];for(const ee of D)ee!=null&&ee.id&&(o[ee.id]=ee);q(o)}).catch(()=>q({}))},[]),s.useEffect(()=>{try{const r=localStorage.getItem("unit_structure"),o={},D={};if(r){const ee=JSON.parse(r);for(const xe of Object.keys(ee||{})){const de=ee[xe];de&&Array.isArray(de._sections)&&(o[xe]=de._sections),de&&de._platoonSectionMap&&typeof de._platoonSectionMap=="object"&&(D[xe]=de._platoonSectionMap)}}else(async()=>{try{const ee=await yt();for(const xe of Object.keys(ee||{})){const de=ee[xe];de&&Array.isArray(de._sections)&&(o[xe]=de._sections),de&&de._platoonSectionMap&&typeof de._platoonSectionMap=="object"&&(D[xe]=de._platoonSectionMap)}}catch{}})();$(o),V(D)}catch{}},[]);const ae=s.useMemo(()=>{const r=String((a==null?void 0:a.role)||"");return r.includes("PLATOON")?"PLATOON_REVIEW":r.includes("COMPANY")?"COMPANY_REVIEW":r.includes("BATTALION")?"BATTALION_REVIEW":r.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[a]),re=s.useMemo(()=>Object.values(O),[O]),X=r=>{const o=O[r.uploadedById];if(!o)return!1;const D=Qe(o.company),ee=r.unitUic||o.unitUic||"";return at(re,"COMPANY_REVIEWER",{company:D,uic:ee})},fe=r=>String((a==null?void 0:a.role)||"").includes("PLATOON")?!X(r):!1,y=r=>O[r.uploadedById]||null,H=r=>r&&r!=="N/A"?r.trim():"",pe=r=>{var Re,Ie;const o=y(r),D=r.unitUic||(o==null?void 0:o.unitUic)||"",ee=String((a==null?void 0:a.role)||""),xe=(a==null?void 0:a.unitUic)||"",de=(H(a==null?void 0:a.roleCompany)||H(a==null?void 0:a.company)).toUpperCase();if(ee.includes("PLATOON")){if(!xe||D!==xe)return!1;const he=o?H(o.company).toUpperCase():"",Me=o?H(o.platoon).toUpperCase():"",We=(H(a==null?void 0:a.rolePlatoon)||H(a==null?void 0:a.platoon)).toUpperCase();return!de||!We||!he||!Me?!1:he===de&&Me===We}if(ee.includes("COMPANY")){if(!xe||D!==xe)return!1;const he=o?H(o.company).toUpperCase():"";return!de||!he?!1:he===de}if(ee.includes("BATTALION")){if(!xe||D!==xe)return!1;const he=H(a==null?void 0:a.company),Me=H(a==null?void 0:a.platoon),We=((Ie=(Re=R[xe])==null?void 0:Re[he])==null?void 0:Ie[Me])||"";return r.routeSection&&We?r.routeSection===We:!0}return ee.includes("COMMANDER")?!!xe&&D===xe:!0},le=s.useMemo(()=>(Array.isArray(b)?b:[]).filter(pe),[b,a,O,R]),ce=s.useMemo(()=>{const r=new Map;for(const o of le){const D=y(o);if(D&&D.id&&!r.has(D.id)){const ee=`${D.rank||""} ${D.lastName||""}, ${D.firstName||""}`.trim();r.set(D.id,{value:D.id,label:ee||D.id})}}return Array.from(r.values()).sort((o,D)=>o.label.localeCompare(D.label))},[le,O]),Ce=ws(ke,{items:le,getSearchText:r=>`${r.subject||""} ${r.id||""} ${r.routeSection||""}`,getStatus:r=>r.currentStage||"PLATOON_REVIEW",getDate:r=>r.createdAt,getOriginatorId:r=>r.uploadedById}),we=s.useMemo(()=>Ce.filter(r=>(r.currentStage||"PLATOON_REVIEW")===ae),[Ce,ae]),De=s.useMemo(()=>Ce.filter(r=>(r.currentStage||"PLATOON_REVIEW")!==ae),[Ce,ae]),$e=At(we,{pageSize:25}),Be=At(De,{pageSize:25}),_e=r=>A.filter(o=>o.requestId===r),Fe=s.useMemo(()=>[{header:"Request ID",getValue:r=>r.id},{header:"Subject",getValue:r=>r.subject},{header:"Stage",getValue:r=>r.currentStage||""},{header:"Route Section",getValue:r=>r.routeSection||""},{header:"Originator",getValue:r=>{const o=y(r);return o?`${o.rank||""} ${o.lastName||""}, ${o.firstName||""}${o.mi?` ${o.mi}`:""}`.trim():""}},{header:"Unit UIC",getValue:r=>r.unitUic||""},{header:"Created At",getValue:r=>r.createdAt,format:$t},{header:"Due Date",getValue:r=>r.dueDate||"",format:$t},{header:"Documents",getValue:r=>_e(r.id).map(o=>o.name).join(" | ")}],[O,A]),v=async(r,o,D)=>{const ee=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",xe=Nt(a),de={actor:ee,actorRole:xe,timestamp:new Date().toISOString(),action:D,comment:(N[r.id]||"").trim()},Re={...r,currentStage:o,routeSection:o==="BATTALION_REVIEW"&&L[r.id]?L[r.id]:r.routeSection,activity:Array.isArray(r.activity)?[...r.activity,de]:[de]};try{await He(Re),D.toLowerCase().includes("approved")?t.success("Request approved",{message:`"${r.subject}" advanced to next stage`}):D.toLowerCase().includes("return")?t.warning("Request returned",{message:`"${r.subject}" sent back for revision`}):D.toLowerCase().includes("archive")?t.info("Request archived",{message:`"${r.subject}" has been archived`}):t.success(D,{message:`Request "${r.subject}" updated`}),c(Ie=>Ie.map(he=>he.id===Re.id?Re:he)),P(Ie=>({...Ie,[r.id]:""}))}catch(Ie){t.error("Failed to update request",{message:String(Ie)})}},I=async r=>{const o=z[r.id]||[];if(!o.length||!(a!=null&&a.id))return;const D=Date.now(),ee=o.map((he,Me)=>({id:`${D}-${Me}`,name:he.name,type:he.type,size:he.size,uploadedAt:new Date().toISOString(),subject:r.subject,requestId:r.id,fileUrl:URL.createObjectURL(he)})),xe=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",de=Nt(a),Re={actor:xe,actorRole:de,timestamp:new Date().toISOString(),action:`Reviewer added ${ee.length} document(s)`,comment:(N[r.id]||"").trim()},Ie={...r,documentIds:[...r.documentIds||[],...ee.map(he=>he.id)],activity:Array.isArray(r.activity)?[...r.activity,Re]:[Re]};try{await jt(ee),await He(Ie),t.success(`${ee.length} file${ee.length!==1?"s":""} added`,{message:`Documents added to "${r.subject}"`})}catch(he){t.error("Failed to add files",{message:String(he)})}E(he=>[...he,...ee]),c(he=>he.map(Me=>Me.id===Ie.id?Ie:Me)),U(he=>({...he,[r.id]:[]})),P(he=>({...he,[r.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Unit Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Nt(a)}),e.jsx(Es,{items:[...we,...De],columns:Fe,filename:"review_requests",label:"Export",className:"hidden md:inline-flex"})]})]}),a&&String(a.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>B(!0),children:"Manage Permissions"})})]}),e.jsx(Ss,{filters:ke,onFiltersChange:Ae,statusOptions:Ms,originatorOptions:ce,searchPlaceholder:"Search requests by subject, ID, or section...",className:"mb-4"}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>ve("Pending"),className:`${T==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>ve("In Scope"),className:`${T==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[T==="Pending"&&e.jsx(nt,{title:"Pending",requests:$e.currentData,users:O,onRowClick:r=>k(o=>({...o,[r.id]:!o[r.id]})),expandedRows:u,platoonSectionMap:R,children:r=>e.jsxs("div",{id:`details-rev-${r.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!x[r.id],"aria-controls":`docs-rev-${r.id}`,onClick:()=>{Q(o=>({...o,[r.id]:!o[r.id]})),G(o=>x[r.id]?null:r.id)},onKeyDown:o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),Q(D=>({...D,[r.id]:!D[r.id]})),G(D=>x[r.id]?null:r.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${x[r.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${r.id}`,ref:x[r.id]?ne:void 0,className:`${x[r.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(it,{documents:_e(r.id).map(o=>({...o,fileUrl:o.fileUrl})),showIcons:!0,onPreview:o=>Z(_e(r.id).find(D=>D.id===o.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>j(o=>({...o,[r.id]:!o[r.id]})),"aria-expanded":!!K[r.id],"aria-controls":`logs-${r.id}`,children:[K[r.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${r.id}`,className:K[r.id]?"mt-2 space-y-2":"hidden",children:r.activity&&r.activity.length?r.activity.map((o,D)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[o.actor,o.actorRole?` • ${o.actorRole}`:""," • ",new Date(o.timestamp).toLocaleString()," • ",o.action]}),o.comment&&e.jsx("div",{className:"text-gray-600",children:o.comment})]},D)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:N[r.id]||"",onChange:o=>P(D=>({...D,[r.id]:o.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:o=>U(D=>({...D,[r.id]:o.target.files?Array.from(o.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(z[r.id]||[]).length?`${(z[r.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>I(r),disabled:!z[r.id]||!(z[r.id]||[]).length,children:"Save Files"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[(String((a==null?void 0:a.role)||"").includes("COMPANY")||fe(r))&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:L[r.id]||"",onChange:o=>d(D=>({...D,[r.id]:o.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(te[(a==null?void 0:a.unitUic)||""]||[]).map(o=>e.jsx("option",{value:o,children:o},o))]}),fe(r)&&e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No company reviewer"})]}),(()=>{const o=Ds(r),D=$s(r),ee=String((a==null?void 0:a.role)||"").includes("COMPANY")||fe(r);return o||D?e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>v(r,r.currentStage==="PLATOON_REVIEW"?Lt:qt(r.currentStage),"Returned to previous stage"),children:"Return to Previous"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(ee){if(!L[r.id])return;v(r,"BATTALION_REVIEW",`Approved and routed to ${L[r.id]}`)}else v(r,Os(r.currentStage),"Approved")},disabled:ee&&!L[r.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>v(r,r.currentStage==="PLATOON_REVIEW"?Lt:qt(r.currentStage),r.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),T==="In Scope"&&e.jsx(nt,{title:"In Scope",requests:Be.currentData,users:O,onRowClick:r=>k(o=>({...o,[r.id]:!o[r.id]})),expandedRows:u,platoonSectionMap:R,children:r=>e.jsxs("div",{id:`details-rev-${r.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!x[r.id],"aria-controls":`docs-rev-${r.id}`,onClick:()=>{Q(o=>({...o,[r.id]:!o[r.id]})),G(o=>x[r.id]?null:r.id)},onKeyDown:o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),Q(D=>({...D,[r.id]:!D[r.id]})),G(D=>x[r.id]?null:r.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${x[r.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${r.id}`,ref:x[r.id]?ne:void 0,className:`${x[r.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(it,{documents:_e(r.id).map(o=>({...o,fileUrl:o.fileUrl})),showIcons:!0,onPreview:o=>Z(_e(r.id).find(D=>D.id===o.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>j(o=>({...o,[r.id]:!o[r.id]})),"aria-expanded":!!K[r.id],"aria-controls":`logs-${r.id}`,children:[K[r.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${r.id}`,className:K[r.id]?"mt-2 space-y-2":"hidden",children:r.activity&&r.activity.length?r.activity.map((o,D)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[o.actor,o.actorRole?` • ${o.actorRole}`:""," • ",new Date(o.timestamp).toLocaleString()," • ",o.action]}),o.comment&&e.jsx("div",{className:"text-gray-600",children:o.comment})]},D)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),h&&a&&e.jsx(Rs,{currentUser:a,onClose:()=>B(!1)}),f&&f.fileUrl&&e.jsx(Yt,{url:f.fileUrl,fileName:f.name,mimeType:f.type,fileSize:f.size,isOpen:!!f,onClose:()=>Z(null)})]})}function Ls(){var _;const[t,a]=s.useState(null),[i,b]=s.useState([]),[c,A]=s.useState([]),[E,N]=s.useState(""),[P,O]=s.useState(""),[q,K]=s.useState([]),[j,z]=s.useState(null),[U,L]=s.useState("structure"),[d,te]=s.useState({}),[$,R]=s.useState({}),[V,h]=s.useState({});s.useEffect(()=>{try{const w=localStorage.getItem("currentUser");w&&a(JSON.parse(w))}catch{}Wt().then(w=>{try{b(w.map(F=>({code:String(F.code||""),name:String(F.name||"")})))}catch{b([])}}),Ht().then(w=>{A(w)}).catch(()=>A([])),ot().then(w=>K(w)).catch(()=>K([])),It().then(w=>{const F={};for(const g of w){const x=`${g.division_code}::${g.branch}`;F[x]={reviewers:g.reviewers||[],approvers:g.approvers||[]}}te(F)})},[]);const B=(t==null?void 0:t.hqmcDivision)||((_=i[0])==null?void 0:_.code)||"",u=s.useMemo(()=>i.find(w=>w.code===B),[i,B]),k=s.useMemo(()=>(Array.isArray(c)?c:[]).filter(w=>String(w.division_code||"")===B),[c,B]);return s.useMemo(()=>(Array.isArray(q)?q:[]).filter(w=>!!w.isHqmcAdmin&&String(w.hqmcDivision||"")===B),[q,B]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(t!=null&&t.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",u?`${u.code} — ${u.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>L("structure"),className:`${U==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>L("permissions"),className:`${U==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),U==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[k.map(w=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:w.branch}),e.jsx("td",{className:"py-2 px-3",children:w.description||""}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700",onClick:async()=>{if(!confirm(`Delete branch "${w.branch}"?`))return;const F=await ms(B,w.branch);F.ok?(A(g=>g.filter(x=>!(x.division_code===B&&x.branch===w.branch))),z({type:"success",message:`Deleted branch "${w.branch}"`})):z({type:"error",message:`Failed to delete: ${F.error}`})},children:"Delete"})})]},w.branch)),k.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:E,onChange:w=>N(w.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:P,onChange:w=>O(w.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!E.trim(),onClick:async()=>{var w;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:B,division_name:((w=i.find(g=>g.code===B))==null?void 0:w.name)||"",branch:E.trim(),description:P.trim()})});const F=await fetch("/api/hqmc-structure").then(g=>g.json());A(F),N(""),O("")}catch{}},children:"Add"})]})]})]}),U==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const w of k){const F=`${B}::${w.branch}`,g=d[F]||{reviewers:[],approvers:[]};await zt({division_code:B,branch:w.branch,reviewers:g.reviewers,approvers:g.approvers})}z({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:k.map(w=>{const F=`${B}::${w.branch}`,g=d[F]||{reviewers:[],approvers:[]},x=Q=>`${Q.rank||""} ${Q.lastName||""}, ${Q.firstName||""}${Q.mi?" "+Q.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:w.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:$[F]||"",onChange:Q=>R(W=>({...W,[F]:Q.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!$[F],onClick:async()=>{const Q=($[F]||"").trim();if(!Q)return;const{user:W,error:G}=await St(Q);if(G){z({type:"error",message:`Database error: ${G}`});return}if(!(W!=null&&W.id)){z({type:"error",message:`No user found for EDIPI ${Q}`});return}te(ne=>({...ne,[F]:{...g,reviewers:Array.from(new Set([...g.reviewers||[],W.id]))}})),R(ne=>({...ne,[F]:""})),z({type:"success",message:`Added reviewer ${W.lastName||""}, ${W.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(g.reviewers||[]).map(Q=>{const W=q.find(G=>G.id===Q);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:W?x(W):Q}),e.jsx("button",{className:"text-red-600",onClick:()=>te(G=>({...G,[F]:{...g,reviewers:(g.reviewers||[]).filter(ne=>ne!==Q)}})),children:"✕"})]},Q)}),(g.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:V[F]||"",onChange:Q=>h(W=>({...W,[F]:Q.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!V[F],onClick:async()=>{const Q=(V[F]||"").trim();if(!Q)return;const{user:W,error:G}=await St(Q);if(G){z({type:"error",message:`Database error: ${G}`});return}if(!(W!=null&&W.id)){z({type:"error",message:`No user found for EDIPI ${Q}`});return}te(ne=>({...ne,[F]:{...g,approvers:Array.from(new Set([...g.approvers||[],W.id]))}})),h(ne=>({...ne,[F]:""})),z({type:"success",message:`Added approver ${W.lastName||""}, ${W.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(g.approvers||[]).map(Q=>{const W=q.find(G=>G.id===Q);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:W?x(W):Q}),e.jsx("button",{className:"text-red-600",onClick:()=>te(G=>({...G,[F]:{...g,approvers:(g.approvers||[]).filter(ne=>ne!==Q)}})),children:"✕"})]},Q)}),(g.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},F)})})]})})]}),j&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${j.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:j.message})]})}const dt=(t,a)=>`${t}::${a}`;function qs({currentUser:t,divisionCode:a,branches:i,assignments:b,onClose:c}){const[A,E]=s.useState([]),[N,P]=s.useState(""),[O,q]=s.useState(""),[K,j]=s.useState("reviewer"),[z,U]=s.useState(!1);s.useEffect(()=>{ft().then(u=>E(u)).catch(()=>E([]))},[]);const L=s.useMemo(()=>{const u={};for(const k of b)u[dt(k.division_code,k.branch)]={reviewers:k.reviewers||[],approvers:k.approvers||[]};return u},[b]),d=String(t.id||""),te=s.useMemo(()=>{if(!N)return!1;const u=L[dt(a,N)]||{reviewers:[],approvers:[]};return(u.reviewers||[]).includes(d)||(u.approvers||[]).includes(d)||!!t.isHqmcAdmin},[N,L,d,t]),$=s.useMemo(()=>A.filter(u=>String(u.hqmcDivision||"")===String(a||"")&&String(u.id||"")!==d),[A,a,d]),R=s.useMemo(()=>{if(!N)return[];const u=L[dt(a,N)]||{reviewers:[],approvers:[]};return Array.from(new Set([...u.reviewers||[],...u.approvers||[]])).map(_=>$.find(w=>w.id===_)).filter(Boolean)},[N,L,$,a]),V=async u=>{U(!0);try{await zt({division_code:a,branch:N,reviewers:u.reviewers,approvers:u.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:t.id,scope:{hqmcDivision:a,branch:N},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{U(!1)}},h=async()=>{if(!te||!N||!O)return;const u=L[dt(a,N)]||{reviewers:[],approvers:[]},k={reviewers:Array.from(new Set(u.reviewers||[])),approvers:Array.from(new Set(u.approvers||[]))};K==="reviewer"?k.reviewers=Array.from(new Set([...k.reviewers,O])):k.approvers=Array.from(new Set([...k.approvers,O])),await V(k),q("")},B=async u=>{if(!te||!N)return;const k=L[dt(a,N)]||{reviewers:[],approvers:[]},_={reviewers:(k.reviewers||[]).filter(w=>w!==u),approvers:(k.approvers||[]).filter(w=>w!==u)};await V(_)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:c,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:u=>u.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:c,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:N,onChange:u=>P(u.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),i.map(u=>e.jsx("option",{value:u,children:u},u))]})]}),N&&!te&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),N&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:O,onChange:u=>q(u.target.value),disabled:!te,children:[e.jsx("option",{value:"",children:"Choose user"}),$.map(u=>e.jsxs("option",{value:u.id,children:[u.rank," ",u.lastName,", ",u.firstName,u.mi?` ${u.mi}`:""," • ",u.email]},u.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:K,onChange:u=>j(u.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!te||!O||z,onClick:h,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[R.map(u=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[u.rank," ",u.lastName,", ",u.firstName,u.mi?` ${u.mi}`:""," • ",u.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!te||z,onClick:()=>B(u.id),children:"Remove"})]},u.id)),R.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}const xt=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Ts=t=>{const a=xt.indexOf(t||xt[0]);return a>0?xt[a-1]:xt[0]};function Bs(){const[t,a]=s.useState(()=>{try{const y=localStorage.getItem("currentUser");return y?JSON.parse(y):null}catch{return null}}),[i,b]=s.useState([]),[c,A]=s.useState([]),[E,N]=s.useState({}),[P,O]=s.useState({}),[q,K]=s.useState({}),[j,z]=s.useState({}),[U,L]=s.useState(null),d=s.useRef(null),[te,$]=s.useState([]),[R,V]=s.useState("Pending"),[h,B]=s.useState([]),[u,k]=s.useState({}),[_,w]=s.useState(!1);s.useEffect(()=>{const y=pe=>{U&&d.current&&!d.current.contains(pe.target)&&(z(le=>({...le,[U]:!1})),L(null))},H=pe=>{pe.key==="Escape"&&U&&(z(le=>({...le,[U]:!1})),L(null))};return document.addEventListener("mousedown",y),document.addEventListener("keydown",H),()=>{document.removeEventListener("mousedown",y),document.removeEventListener("keydown",H)}},[U]),s.useEffect(()=>{bt().then(y=>b(y)).catch(()=>b([]))},[]),s.useEffect(()=>{kt().then(y=>A(y)).catch(()=>A([]))},[]),s.useEffect(()=>{ot().then(y=>{const H={};for(const pe of y)pe!=null&&pe.id&&(H[pe.id]=pe);O(H)}).catch(()=>O({}))},[]),s.useEffect(()=>{It().then($).catch(()=>$([]))},[]),s.useEffect(()=>{Ht().then(B).catch(()=>B([]))},[]);const F=(t==null?void 0:t.id)||"",g=String((t==null?void 0:t.hqmcDivision)||""),x=s.useMemo(()=>te.filter(y=>y.division_code===g&&((y.reviewers||[]).includes(F)||(y.approvers||[]).includes(F))).map(y=>y.branch),[te,g,F]),Q=y=>P[y.uploadedById]||null,W=y=>{if(!g||!F)return!1;const H=String(y.routeSection||"");return x.includes(H)},G=s.useMemo(()=>(Array.isArray(i)?i:[]).filter(W),[i,x]),ne=s.useMemo(()=>G.filter(y=>(y.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[G]),T=s.useMemo(()=>G.filter(y=>(y.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[G]),ve=y=>c.filter(H=>H.requestId===y),ke=y=>`"${String(y??"").replace(/"/g,'""')}"`,Ae=y=>{const pe=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const le of y){const ce=Q(le),Ce=ce?`${ce.rank} ${ce.lastName}, ${ce.firstName}${ce.mi?` ${ce.mi}`:""}`:"",we=ve(le.id).map(De=>De.name).join(" | ");pe.push([le.id,le.subject,le.currentStage||"",le.routeSection||"",Ce,le.unitUic||"",new Date(le.createdAt).toLocaleString(),we])}return pe.map(le=>le.map(ke).join(",")).join(`\r
`)},f=(y,H)=>{const pe=new Blob([H],{type:"text/csv;charset=utf-8;"}),le=URL.createObjectURL(pe),ce=document.createElement("a");ce.href=le,ce.download=y,document.body.appendChild(ce),ce.click(),document.body.removeChild(ce),URL.revokeObjectURL(le)},Z=()=>f("hqmc_pending.csv",Ae(ne)),ae=()=>f("hqmc_in_scope.csv",Ae(T)),re=()=>f("hqmc_all.csv",Ae([...ne,...T])),X=async y=>{const H=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",pe=String(u[y.id]||"").trim();if(!pe){alert("Select an HQMC section to route to approver");return}const le={actor:H,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${pe}`,comment:(E[y.id]||"").trim()},ce={...y,routeSection:pe,activity:Array.isArray(y.activity)?[...y.activity,le]:[le]};try{await He(ce)}catch{}b(Ce=>Ce.map(we=>we.id===ce.id?ce:we)),N(Ce=>({...Ce,[y.id]:""}))},fe=async y=>{const pe={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC",comment:(E[y.id]||"").trim()},le={...y,currentStage:Ts(y.currentStage),activity:Array.isArray(y.activity)?[...y.activity,pe]:[pe]};try{await He(le)}catch{}b(ce=>ce.map(Ce=>Ce.id===le.id?le:Ce)),N(ce=>({...ce,[y.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:g||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:re,children:"Export All"}),x.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>w(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>V("Pending"),className:`${R==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>V("In Scope"),className:`${R==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[R==="Pending"&&e.jsx(nt,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Z,children:"Export Pending"}),requests:ne,users:P,onRowClick:y=>K(H=>({...H,[y.id]:!H[y.id]})),expandedRows:q,children:y=>e.jsxs("div",{id:`details-hq-${y.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[y.id],"aria-controls":`docs-hq-${y.id}`,onClick:()=>{z(H=>({...H,[y.id]:!H[y.id]})),L(H=>j[y.id]?null:y.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[y.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${y.id}`,ref:j[y.id]?d:void 0,className:`${j[y.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(it,{documents:ve(y.id).map(H=>({...H,fileUrl:H.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:E[y.id]||"",onChange:H=>N(pe=>({...pe,[y.id]:H.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:u[y.id]||"",onChange:H=>k(pe=>({...pe,[y.id]:H.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),h.filter(H=>String(H.division_code||"")===g).map(H=>e.jsx("option",{value:H.branch,children:H.branch},H.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>X(y),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>fe(y),children:"Return"})]})]})]})}),R==="In Scope"&&e.jsx(nt,{title:"In Scope",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ae,children:"Export In Scope"}),requests:T,users:P,onRowClick:y=>K(H=>({...H,[y.id]:!H[y.id]})),expandedRows:q,children:y=>e.jsxs("div",{id:`details-hq-${y.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[y.id],"aria-controls":`docs-hq-${y.id}`,onClick:()=>{z(H=>({...H,[y.id]:!H[y.id]})),L(H=>j[y.id]?null:y.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[y.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${y.id}`,ref:j[y.id]?d:void 0,className:`${j[y.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(it,{documents:ve(y.id).map(H=>({...H,fileUrl:H.fileUrl}))})})]})})]})]}),_&&t&&e.jsx(qs,{currentUser:t,divisionCode:g,branches:h.filter(y=>String(y.division_code||"")===g).map(y=>y.branch),assignments:te,onClose:()=>w(!1)})]})}const ht=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Fs=t=>{const a=ht.indexOf(t||ht[0]);return a>0?ht[a-1]:ht[0]};function Vs(){const[t,a]=s.useState(()=>{try{const f=localStorage.getItem("currentUser");return f?JSON.parse(f):null}catch{return null}}),[i,b]=s.useState([]),[c,A]=s.useState([]),[E,N]=s.useState({}),[P,O]=s.useState({}),[q,K]=s.useState({}),[j,z]=s.useState({}),[U,L]=s.useState(null),d=s.useRef(null),[te,$]=s.useState([]),[R,V]=s.useState("Pending");s.useEffect(()=>{const f=ae=>{U&&d.current&&!d.current.contains(ae.target)&&(z(re=>({...re,[U]:!1})),L(null))},Z=ae=>{ae.key==="Escape"&&U&&(z(re=>({...re,[U]:!1})),L(null))};return document.addEventListener("mousedown",f),document.addEventListener("keydown",Z),()=>{document.removeEventListener("mousedown",f),document.removeEventListener("keydown",Z)}},[U]),s.useEffect(()=>{bt().then(f=>b(f)).catch(()=>b([]))},[]),s.useEffect(()=>{kt().then(f=>A(f)).catch(()=>A([]))},[]),s.useEffect(()=>{ot().then(f=>{const Z={};for(const ae of f)ae!=null&&ae.id&&(Z[ae.id]=ae);O(Z)}).catch(()=>O({}))},[]),s.useEffect(()=>{It().then($).catch(()=>$([]))},[]);const h=(t==null?void 0:t.id)||"",B=String((t==null?void 0:t.hqmcDivision)||""),u=s.useMemo(()=>te.filter(f=>f.division_code===B&&(f.approvers||[]).includes(h)).map(f=>f.branch),[te,B,h]),k=f=>P[f.uploadedById]||null,_=f=>{if(!B||!h)return!1;const Z=String(f.routeSection||"");return u.includes(Z)},w=s.useMemo(()=>(Array.isArray(i)?i:[]).filter(_),[i,u]),F=s.useMemo(()=>w.filter(f=>(f.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[w]),g=s.useMemo(()=>w.filter(f=>(f.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[w]),x=f=>c.filter(Z=>Z.requestId===f),Q=f=>`"${String(f??"").replace(/"/g,'""')}"`,W=f=>{const ae=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const re of f){const X=k(re),fe=X?`${X.rank} ${X.lastName}, ${X.firstName}${X.mi?` ${X.mi}`:""}`:"",y=x(re.id).map(H=>H.name).join(" | ");ae.push([re.id,re.subject,re.currentStage||"",re.routeSection||"",fe,re.unitUic||"",new Date(re.createdAt).toLocaleString(),y])}return ae.map(re=>re.map(Q).join(",")).join(`\r
`)},G=(f,Z)=>{const ae=new Blob([Z],{type:"text/csv;charset=utf-8;"}),re=URL.createObjectURL(ae),X=document.createElement("a");X.href=re,X.download=f,document.body.appendChild(X),X.click(),document.body.removeChild(X),URL.revokeObjectURL(re)},ne=()=>G("hqmc_approver_pending.csv",W(F)),T=()=>G("hqmc_approver_approved.csv",W(g)),ve=()=>G("hqmc_approver_all.csv",W([...F,...g])),ke=async f=>{const ae={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved",comment:(E[f.id]||"").trim()},re={...f,currentStage:"ARCHIVED",activity:Array.isArray(f.activity)?[...f.activity,ae]:[ae]};try{await He(re)}catch{}b(X=>X.map(fe=>fe.id===re.id?re:fe)),N(X=>({...X,[f.id]:""}))},Ae=async f=>{const ae={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver",comment:(E[f.id]||"").trim()},re={...f,currentStage:Fs(f.currentStage),activity:Array.isArray(f.activity)?[...f.activity,ae]:[ae]};try{await He(re)}catch{}b(X=>X.map(fe=>fe.id===re.id?re:fe)),N(X=>({...X,[f.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((t==null?void 0:t.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ve,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>V("Pending"),className:`${R==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>V("Approved"),className:`${R==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"})]})}),e.jsxs("div",{className:"mt-4",children:[R==="Pending"&&e.jsx(nt,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ne,children:"Export Pending"}),requests:F,users:P,onRowClick:f=>K(Z=>({...Z,[f.id]:!Z[f.id]})),expandedRows:q,children:f=>e.jsxs("div",{id:`details-hqa-${f.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[f.id],"aria-controls":`docs-hqa-${f.id}`,onClick:()=>{z(Z=>({...Z,[f.id]:!Z[f.id]})),L(Z=>j[f.id]?null:f.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[f.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${f.id}`,ref:j[f.id]?d:void 0,className:`${j[f.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(it,{documents:x(f.id).map(Z=>({...Z,fileUrl:Z.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:E[f.id]||"",onChange:Z=>N(ae=>({...ae,[f.id]:Z.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>ke(f),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>Ae(f),children:"Return"})]})]})}),R==="Approved"&&e.jsx(nt,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:T,children:"Export Approved"}),requests:g,users:P,onRowClick:f=>K(Z=>({...Z,[f.id]:!Z[f.id]})),expandedRows:q,children:f=>e.jsxs("div",{id:`details-hqa-${f.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[f.id],"aria-controls":`docs-hqa-${f.id}`,onClick:()=>{z(Z=>({...Z,[f.id]:!Z[f.id]})),L(Z=>j[f.id]?null:f.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[f.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${f.id}`,ref:j[f.id]?d:void 0,className:`${j[f.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(it,{documents:x(f.id).map(Z=>({...Z,fileUrl:Z.fileUrl}))})})]})})]})]})})}const Ws=({onUnitSelect:t,selectedUnit:a})=>{const[i,b]=s.useState(""),[c,A]=s.useState(!1),E=Je.filter(P=>P.unitName.toLowerCase().startsWith(i.toLowerCase())||P.uic.toLowerCase().startsWith(i.toLowerCase())||P.ruc.toLowerCase().startsWith(i.toLowerCase())),N=P=>{t(P),A(!1),b("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>A(!c),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[a?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",a.uic," | RUC: ",a.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),c&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:i,onChange:P=>b(P.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:E.map(P=>e.jsxs("button",{type:"button",onClick:()=>N(P),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:P.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",P.uic," | RUC: ",P.ruc," | MCC: ",P.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[P.streetAddress,", ",P.cityState," ",P.zip]})]},P.uic))})]})]})]})},Et=async t=>{const i=new TextEncoder().encode(t),b=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(b)).map(c=>c.toString(16).padStart(2,"0")).join("")};async function Hs(t,a){const i=us();return i!=null&&i.auth?await i.auth.signUp({email:t,password:a}):{data:null,error:new Error("supabase_not_initialized")}}const Tt={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},zs=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Xt=({onSaved:t,initial:a={},mode:i="create",readOnly:b=!1,canEditRole:c=!1,canEditAdmin:A=!1})=>{const[E,N]=s.useState(""),[P,O]=s.useState(""),[q,K]=s.useState(""),[j,z]=s.useState(a.email||""),[U,L]=s.useState(a.edipi||""),[d,te]=s.useState(a.service||""),[$,R]=s.useState(a.rank||""),[V,h]=s.useState(a.role||"MEMBER"),[B,u]=s.useState(!!a.isUnitAdmin),[k,_]=s.useState(a.company||""),[w,F]=s.useState(a.platoon||""),[g,x]=s.useState(void 0),[Q,W]=s.useState(null),[G,ne]=s.useState({}),[T,ve]=s.useState(""),[ke,Ae]=s.useState(""),[f,Z]=s.useState([]),[ae,re]=s.useState(!1),[X,fe]=s.useState(a.roleCompany||""),[y,H]=s.useState(a.rolePlatoon||""),[pe,le]=s.useState(!1),[ce,Ce]=s.useState([]),[we,De]=s.useState([]),[$e,Be]=s.useState([]),[_e,Fe]=s.useState([]);s.useEffect(()=>{if(a.firstName&&N(String(a.firstName)),a.lastName&&O(String(a.lastName)),a.mi&&K(String(a.mi)),a.company&&_(String(a.company)),a.platoon&&F(String(a.platoon)),a.roleCompany&&fe(String(a.roleCompany)),a.rolePlatoon&&H(String(a.rolePlatoon)),a.unitUic){const p=Je.find(oe=>oe.uic===a.unitUic);p&&x(p)}},[a]);const v=s.useMemo(()=>Tt[d]||[],[d]),I=s.useMemo(()=>{if(!g)return[];const p=ce;if(p&&p.length)return p;const oe=G[g.uic]||{};return Object.keys(oe).filter(Ne=>!Ne.startsWith("_")&&Array.isArray(oe[Ne]))},[g,G,ce]),r=s.useMemo(()=>{var p;return g&&k?((p=G[g.uic])==null?void 0:p[k])||[]:[]},[g,k,G]),o=s.useMemo(()=>{if(!g||!k)return[];const p=we;return p&&p.length?p:r},[g,k,we,r]),D=s.useMemo(()=>{if(!g)return[];const p=$e;if(p&&p.length)return p;const oe=G[g.uic]||{};return Object.keys(oe).filter(Ne=>!Ne.startsWith("_")&&Array.isArray(oe[Ne]))},[g,G,$e]),ee=s.useMemo(()=>{var p;return g&&X?((p=G[g.uic])==null?void 0:p[X])||[]:[]},[g,X,G]),xe=s.useMemo(()=>{if(!g||!X)return[];const p=_e;return p&&p.length?p:ee},[g,X,_e,ee]),de=s.useMemo(()=>{const p=I.slice(),oe=k||a.company||a.user_company||"";return oe&&!p.includes(oe)?[oe,...p]:p},[I,k,a]),Re=s.useMemo(()=>{const p=o.slice(),oe=w||a.platoon||a.user_platoon||"";return oe&&!p.includes(oe)?[oe,...p]:p},[o,w,a]),Ie=s.useMemo(()=>{const p=D.slice(),oe=X||a.roleCompany||"",Ne=oe&&!p.includes(oe)?[oe,...p]:p;return Array.from(new Set(Ne))},[D,X,a]),he=s.useMemo(()=>{const p=xe.slice(),oe=y||a.rolePlatoon||"";return oe&&!p.includes(oe)?[oe,...p]:p},[xe,y,a]);s.useEffect(()=>{(async()=>{try{if(i==="edit"&&a.id){const p=await Ut(String(a.id));p&&(p.company&&!k&&_(String(p.company)),p.platoon&&!w&&F(String(p.platoon)),p.roleCompany&&!X&&fe(String(p.roleCompany)),p.rolePlatoon&&!y&&H(String(p.rolePlatoon)))}}catch{}})()},[i,a.id]),s.useEffect(()=>{v.includes($)||R("")},[v]),s.useEffect(()=>{F("")},[k]),s.useEffect(()=>{H("")},[X]),s.useEffect(()=>{try{const p=localStorage.getItem("unit_structure");p&&ne(JSON.parse(p))}catch{}},[g]),s.useEffect(()=>{const p=(g==null?void 0:g.uic)||"";if(!p){Ce([]),Be([]);return}Qt(p).then(oe=>{Ce(oe||[]),Be(oe||[])}).catch(()=>{Ce([]),Be([])})},[g]),s.useEffect(()=>{const p=(g==null?void 0:g.uic)||"",oe=k||"";if(!p||!oe){De([]);return}wt(p,oe).then(Ne=>De(Ne||[])).catch(()=>De([]))},[g,k]),s.useEffect(()=>{const p=(g==null?void 0:g.uic)||"",oe=X||"";if(!p||!oe){Fe([]);return}wt(p,oe).then(Ne=>Fe(Ne||[])).catch(()=>Fe([]))},[g,X]),s.useEffect(()=>{ot().then(p=>{Z(p)}).catch(()=>Z([]))},[]),s.useEffect(()=>{const p=(g==null?void 0:g.uic)||"";if(!p){re(!1);return}const oe=f.some(Ne=>!!Ne.isUnitAdmin&&(Ne.unitUic||"")===p);re(oe)},[g,f]),s.useEffect(()=>{if(g){!k&&a.company&&de.includes(a.company)&&_(String(a.company));const p=a.platoon;!w&&p&&Re.includes(p)&&F(String(p))}},[g,de,Re,k,w,a]);const Me=p=>/^[0-9]{10}$/.test(p),We=(p,oe)=>{try{return f.some(Ne=>String(Ne.edipi)===String(p)&&String(Ne.id)!==String(oe||""))}catch{return!1}},et=async p=>{var tt,je;if(p.preventDefault(),W(null),b)return;if(!E.trim())return W({type:"error",message:"First name is required."});if(!P.trim())return W({type:"error",message:"Last name is required."});if(q&&!/^[A-Za-z]$/.test(q))return W({type:"error",message:"MI must be a single letter."});if(!j.trim())return W({type:"error",message:"Email is required."});if(!Me(String(U)))return W({type:"error",message:"EDIPI must be 10 digits."});if(!d)return W({type:"error",message:"Service is required."});if(!$)return W({type:"error",message:"Rank is required."});if(We(String(U),a.id?String(a.id):void 0))return W({type:"error",message:"EDIPI already exists."});if(V==="COMPANY_REVIEWER"&&!X)return W({type:"error",message:"Role Company is required for Company Reviewer."});if(V==="PLATOON_REVIEWER"&&(!X||!y))return W({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${E.trim()}`,q&&""+q.trim().toUpperCase(),`${P.trim()}`;let oe=a.id?String(a.id):`usr-${Date.now()}`,Ne=a.passwordHash||"";if(i==="create"){if(!T||T.length<8)return W({type:"error",message:"Password must be at least 8 characters."});if(T!==ke)return W({type:"error",message:"Passwords do not match."});try{const{data:Ee,error:Ye}=await Hs(j.trim(),T);if(Ye){W({type:"error",message:`Failed to create auth user: ${String(Ye.message||Ye)}`});return}const Ke=(tt=Ee==null?void 0:Ee.user)!=null&&tt.id?String(Ee.user.id):"";if(!Ke){W({type:"error",message:"Auth user ID missing after sign up."});return}oe=Ke}catch(Ee){W({type:"error",message:`Failed to create auth user: ${String((Ee==null?void 0:Ee.message)||Ee)}`});return}Ne=await Et(T)}else if(i==="edit"&&T){if(T.length<8)return W({type:"error",message:"Password must be at least 8 characters."});if(T!==ke)return W({type:"error",message:"Passwords do not match."});Ne=await Et(T)}const Le={id:oe,firstName:E.trim(),lastName:P.trim(),mi:q?q.trim().toUpperCase():void 0,email:j.trim(),edipi:U,service:d,rank:$,role:V,company:k||"N/A",unit:(g==null?void 0:g.unitName)||"N/A",unitUic:g==null?void 0:g.uic,passwordHash:Ne,isUnitAdmin:i==="create"&&g&&!ae?!0:B,roleCompany:X||void 0,rolePlatoon:y||void 0,platoon:w||"N/A"};try{const Ee=await Ze({id:Le.id,email:Le.email,rank:Le.rank,firstName:Le.firstName,lastName:Le.lastName,mi:Le.mi,service:Le.service,role:Le.role,unitUic:Le.unitUic,unit:(g==null?void 0:g.unitName)||"N/A",company:Le.company,isUnitAdmin:!!Le.isUnitAdmin,edipi:String(Le.edipi),passwordHash:Ne,platoon:w||"N/A",roleCompany:X||void 0,rolePlatoon:y||void 0});if(!Ee.ok){W({type:"error",message:`Failed to save profile: ${String(((je=Ee==null?void 0:Ee.error)==null?void 0:je.message)||(Ee==null?void 0:Ee.error)||"unknown")}`});return}W({type:"success",message:a.id?"Profile updated.":g&&!ae?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),t==null||t(Le)}catch{W({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:i==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:et,className:"space-y-6",children:[i==="create"&&g&&!ae&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:g.unitName})," (UIC ",g.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:P,onChange:p=>O(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:b})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:E,onChange:p=>N(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:b})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:q,maxLength:1,onChange:p=>K(p.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:b})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:j,onChange:p=>z(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:b})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:U,onChange:p=>L(p.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:b}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:d,onChange:p=>te(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:b,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(Tt).map(p=>e.jsx("option",{value:p,children:p},p))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:$,onChange:p=>R(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:b,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),v.map(p=>e.jsx("option",{value:p,children:p},p))]})]}),i==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:T,onChange:p=>ve(p.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:b}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:ke,onChange:p=>Ae(p.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:b})]})]}):e.jsx(e.Fragment,{})]})]}),pe&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:T,onChange:p=>ve(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:b}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:ke,onChange:p=>Ae(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:b})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>le(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>le(!1),children:"Save"})]})]})}),i==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:V,onChange:p=>h(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:zs.map(p=>e.jsx("option",{value:p,children:p},p))})}),e.jsx("div",{children:e.jsxs("select",{value:X||String(a.roleCompany||""),onChange:p=>fe(p.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Ie.length?"Select company":"No companies configured"}),Ie.map(p=>e.jsx("option",{value:p,children:p},p))]})}),e.jsx("div",{children:e.jsxs("select",{value:y||String(a.rolePlatoon||""),onChange:p=>H(p.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:he.length?"Select platoon":"No platoons configured"}),he.map(p=>e.jsx("option",{value:p,children:p},p))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:B,onChange:p=>u(p.target.checked),disabled:b||!A}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(a==null?void 0:a.isCommandStaff)||V==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(Ws,{onUnitSelect:p=>x(p),selectedUnit:g})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:k||String(a.company||""),onChange:p=>_(p.target.value),disabled:b||!g||de.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:de.length?"Select company":"No companies configured"}),de.map(p=>e.jsx("option",{value:p,children:p},p))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:w||String(a.platoon||""),onChange:p=>F(p.target.value),disabled:b||!g||!k||Re.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Re.length?"Select platoon":"No platoons configured"}),Re.map(p=>e.jsx("option",{value:p,children:p},p))]})]})]})})]}),Q&&e.jsx("div",{className:`p-3 rounded-lg border ${Q.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:Q.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[i==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>le(!0),disabled:b,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:b,children:i==="edit"?"Save":"Create Profile"})]})]})]})},Us=s.memo(function({user:a,onClose:i}){const b=()=>{const c=Je.find(E=>E.uic===a.unitUic),A=c?c.unitName:a.unit;if(a.isUnitAdmin||a.role==="COMMANDER")return A||"—";if(a.role==="COMPANY_REVIEWER")return a.company&&a.company!=="N/A"?a.company:"—";if(a.role==="PLATOON_REVIEWER"){const E=a.company&&a.company!=="N/A"?a.company:"",N=a.platoon&&a.platoon!=="N/A"?a.platoon:"",P=[E,N].filter(Boolean);return P.length?P.join(" / "):"—"}return"—"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:i,children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:a.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:a.edipi||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:a.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:a.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:b()})]}),a.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),a.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:i,children:"Close"})})]})})}),Qs=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Gs=()=>{const[t,a]=s.useState(null),[i,b]=s.useState(void 0),[c,A]=s.useState({}),[E,N]=s.useState({}),[P,O]=s.useState({}),[q,K]=s.useState({}),[j,z]=s.useState(""),[U,L]=s.useState(""),[d,te]=s.useState(""),[$,R]=s.useState(""),[V,h]=s.useState(""),[B,u]=s.useState([]),[k,_]=s.useState(null),[w,F]=s.useState(""),g=s.useRef(null),[x,Q]=s.useState(null),[W,G]=s.useState(null),[ne,T]=s.useState(""),[ve,ke]=s.useState(void 0),[Ae,f]=s.useState(void 0),[Z,ae]=s.useState(void 0),[re,X]=s.useState(void 0),[fe,y]=s.useState(void 0),[H,pe]=s.useState(void 0),[le,ce]=s.useState([]),[Ce,we]=s.useState([]),[De,$e]=s.useState(""),[Be,_e]=s.useState("unit"),[Fe,v]=s.useState([]),[I,r]=s.useState(!1),[o,D]=s.useState(!1),[ee,xe]=s.useState(!1),[de,Re]=s.useState("admin"),[Ie,he]=s.useState(!0),[Me,We]=s.useState(null),[et,p]=s.useState(0),oe=s.useRef(!1);s.useEffect(()=>{x&&de==="admin"&&!oe.current&&(!ve&&x.company&&x.company!=="N/A"&&(ke(x.company),ae(x.company)),!Ae&&x.platoon&&x.platoon!=="N/A"&&(f(x.platoon),X(x.platoon)),!fe&&x.roleCompany&&x.roleCompany!=="N/A"&&y(x.roleCompany),!H&&x.rolePlatoon&&x.rolePlatoon!=="N/A"&&pe(x.rolePlatoon),oe.current=!0)},[x,de]),s.useEffect(()=>{try{const n=localStorage.getItem("unit_structure");n&&A(JSON.parse(n))}catch{}try{const n=localStorage.getItem("unit_structure"),l={},S={},se={};if(n){const be=JSON.parse(n);for(const Se of Object.keys(be||{})){const ie=be[Se];ie&&Array.isArray(ie._sections)&&(l[Se]=ie._sections),ie&&Array.isArray(ie._commandSections)&&(S[Se]=ie._commandSections),ie&&ie._platoonSectionMap&&typeof ie._platoonSectionMap=="object"&&(se[Se]=ie._platoonSectionMap)}}else(async()=>{try{const be=await yt();for(const Se of Object.keys(be||{})){const ie=be[Se];ie&&Array.isArray(ie._sections)&&(l[Se]=ie._sections),ie&&Array.isArray(ie._commandSections)&&(S[Se]=ie._commandSections),ie&&ie._platoonSectionMap&&typeof ie._platoonSectionMap=="object"&&(se[Se]=ie._platoonSectionMap)}A(be)}catch{}})();N(l),O(S),K(se)}catch{}(async()=>{he(!0),We(null);try{const n=await ft();if(n.error)throw new Error(n.error);u(n.data),p(n.data.length)}catch(n){const l=(n==null?void 0:n.message)||"Unknown error fetching users";console.error("[AdminPanel] Failed to fetch users:",l),We(l),u([]),p(0)}finally{he(!1)}})();try{const n=localStorage.getItem("currentUser");if(n){const l=JSON.parse(n);if(a(l),l.unitUic){const S=Je.find(se=>se.uic===l.unitUic);S&&b(S)}}}catch{}},[]),s.useEffect(()=>{try{if(!i){const n=Object.keys(c||{});if(n.length){const l=n[0],S=c[l]||{},be=Je.find(Se=>Se.uic===l)||{ruc:String(S._ruc||""),mcc:String(S._mcc||""),uic:l,unitName:String(S._unitName||l),streetAddress:String(S._streetAddress||"")};b(be)}}}catch{}},[c]),s.useEffect(()=>{const n=(x==null?void 0:x.unitUic)||"";if(!n){ce([]);return}Qt(n).then(l=>ce(l||[])).catch(()=>ce([]))},[x]),s.useEffect(()=>{const n=(x==null?void 0:x.unitUic)||"",l=fe||"";if(!n||!l){we([]);return}wt(n,l).then(S=>we(S||[])).catch(()=>we([]))},[x,fe]);const Ne=s.useMemo(()=>{const n=(i==null?void 0:i.uic)||"";if(!n)return[];const l=c[n]||{};return Object.keys(l).filter(S=>!S.startsWith("_")&&Array.isArray(l[S]))},[i,c]),Le=s.useMemo(()=>{var S;const n=(i==null?void 0:i.uic)||"";if(!n||!j)return[];const l=(S=c[n])==null?void 0:S[j];return Array.isArray(l)?l:[]},[i,j,c]),tt=s.useMemo(()=>{const n=(i==null?void 0:i.uic)||"";return n?E[n]||[]:[]},[i,E]),je=s.useMemo(()=>{const n=(i==null?void 0:i.uic)||"";return n?P[n]||[]:[]},[i,P]),Ee=s.useMemo(()=>{const n=(x==null?void 0:x.unitUic)||"";if(!n)return[];const l=le;if(l&&l.length)return l;const S=c[n]||{};return Object.keys(S).filter(se=>!se.startsWith("_")&&Array.isArray(S[se]))},[x,c,le]),Ye=s.useMemo(()=>{var se;const n=(x==null?void 0:x.unitUic)||"",l=Z||"";if(!n||!l)return[];const S=(se=c[n])==null?void 0:se[l];return Array.isArray(S)?S:[]},[x,Z,c]),Ke=s.useMemo(()=>{var be,Se;const n=(x==null?void 0:x.unitUic)||"",l=fe||"";if(!l)return[];const S=Ce;if(S&&S.length>0)return S;if(n){const ie=(be=c[n])==null?void 0:be[l];if(Array.isArray(ie)&&ie.length>0)return ie}const se=(i==null?void 0:i.uic)||"";if(se&&se!==n){const ie=(Se=c[se])==null?void 0:Se[l];if(Array.isArray(ie))return ie}return[]},[x,fe,c,Ce,i]),mt=s.useMemo(()=>{const n=Ee.slice(),l=ve||(x&&x.company!=="N/A"?x.company:"");return l&&!n.includes(l)?[l,...n]:n},[Ee,ve,x]);s.useMemo(()=>{const n=Ye.slice(),l=re||(x&&x.platoon&&x.platoon!=="N/A"?x.platoon:"");return l&&!n.includes(l)?[l,...n]:n},[Ye,re,x]);const m=s.useMemo(()=>{const n=Ke.slice(),l=H||(x&&x.rolePlatoon&&x.rolePlatoon!=="N/A"?x.rolePlatoon:"");return l&&!n.includes(l)?[l,...n]:n},[Ke,H,x]),C=s.useMemo(()=>i?B.filter(n=>{const l=String(n.unitUic||"").trim().toUpperCase(),S=String(i.uic||"").trim().toUpperCase(),se=String(n.unit||"").trim().toLowerCase(),be=String(i.unitName||"").trim().toLowerCase();return l&&l===S||se&&se===be}):B,[B,i]),M=s.useMemo(()=>{if(!w)return C;const n=w.toLowerCase();return C.filter(l=>(l.email??"").toLowerCase().includes(n)||(l.lastName??"").toLowerCase().includes(n))},[C,w]),J=()=>{try{if(i){const n=i.uic,l={...c};l[n]=l[n]||{},l[n]._mcc=i.mcc||l[n]._mcc||"",l[n]._unitName=i.unitName||l[n]._unitName||"",A(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const se=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",se),_({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");_({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{_({type:"error",message:"Failed to persist unit structure."})}})()}else{const n=JSON.stringify(c);localStorage.setItem("unit_structure",n),(async()=>{try{if(navigator.sendBeacon){const S=new Blob([n],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",S),_({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:n,keepalive:!0})).ok)throw new Error("persist_failed");_({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{_({type:"error",message:"Failed to persist unit structure."})}})()}}catch{_({type:"error",message:"Failed to save unit structure."})}},Y=()=>{try{if(!i)return;const n=i.uic,l={...c};l[n]=l[n]||{},l[n]._sections=E[n]||[],l[n]._mcc=i.mcc||l[n]._mcc||"",l[n]._unitName=i.unitName||l[n]._unitName||"",A(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const se=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",se),_({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");_({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{_({type:"error",message:"Failed to persist unit sections."})}})()}catch{_({type:"error",message:"Failed to save unit sections."})}},ye=()=>{try{if(!i)return;const n=i.uic,l={...c};l[n]=l[n]||{},l[n]._commandSections=P[n]||[],l[n]._mcc=i.mcc||l[n]._mcc||"",l[n]._unitName=i.unitName||l[n]._unitName||"",A(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const se=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",se),_({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");_({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{_({type:"error",message:"Failed to persist command sections."})}})()}catch{_({type:"error",message:"Failed to save command sections."})}},ge=()=>{try{if(!i)return;const n=i.uic,l={...c};l[n]=l[n]||{},l[n]._platoonSectionMap=q[n]||{},l[n]._mcc=i.mcc||l[n]._mcc||"",l[n]._unitName=i.unitName||l[n]._unitName||"",A(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const se=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",se),_({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");_({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{_({type:"error",message:"Failed to persist links."})}})()}catch{_({type:"error",message:"Failed to save links."})}},me=()=>{if(!i||!U.trim())return;const n=i.uic,l={...c};l[n]=l[n]||{},l[n][U.trim()]||(l[n][U.trim()]=[],A(l),z(U.trim()),L(""))},Pe=n=>{if(!i)return;const l=i.uic,S={...c};S[l]&&(delete S[l][n],A(S),j===n&&z(""))},ue=()=>{if(!i||!j||!d.trim())return;const n=i.uic,l={...c};l[n]=l[n]||{},l[n][j]=l[n][j]||[],l[n][j].includes(d.trim())||(l[n][j]=[...l[n][j],d.trim()],A(l),te(""))},qe=n=>{if(!i||!j)return;const l=i.uic,S={...c};S[l][j]=(S[l][j]||[]).filter(se=>se!==n),A(S)},Te=()=>{if(!i||!$.trim())return;const n=i.uic,l={...E};l[n]=l[n]||[],l[n].includes($.trim())||(l[n]=[...l[n],$.trim()],N(l),R(""))},ze=n=>{if(!i)return;const l=i.uic,S={...E};S[l]=(S[l]||[]).filter(se=>se!==n),N(S)},Ue=()=>{if(!i||!V.trim())return;const n=i.uic,l={...P};l[n]=l[n]||[],l[n].includes(V.trim())||(l[n]=[...l[n],V.trim()],O(l),h(""))},ut=n=>{if(!i)return;const l=i.uic,S={...P};S[l]=(S[l]||[]).filter(se=>se!==n),O(S)},pt=()=>{const n=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],l=B.map(ie=>[ie.firstName,ie.mi||"",ie.lastName,ie.email,ie.edipi,ie.service,ie.rank,ie.role,ie.company,ie.unit,ie.unitUic||""].map(Zt=>{const ct=String(Zt??"");return ct.includes(",")||ct.includes('"')||ct.includes(`
`)?'"'+ct.replace(/"/g,'""')+'"':ct}).join(",")),S="\uFEFF"+[n.join(","),...l].join(`
`),se=new Blob([S],{type:"text/csv;charset=utf-8"}),be=URL.createObjectURL(se),Se=document.createElement("a");Se.href=be,Se.download="users-export.csv",Se.click(),URL.revokeObjectURL(be)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${Be==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>_e("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${Be==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>_e("users"),children:"User Administration"})]})})}),Be==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:i?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",i.uic," | RUC: ",i.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:J,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:U,onChange:n=>L(n.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:me,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Ne.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>z(n),children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Pe(n),children:"Remove"})]},n)),Ne.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",j?`• ${j}`:""]}),i&&j&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ge,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:d,onChange:n=>te(n.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!j}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:ue,disabled:!j,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Le.map(n=>{var l,S;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:n})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:((S=(l=q[(i==null?void 0:i.uic)||""])==null?void 0:l[j])==null?void 0:S[n])||"",onChange:se=>{const be=(i==null?void 0:i.uic)||"";K(Se=>{const ie={...Se};return ie[be]=ie[be]||{},ie[be][j]=ie[be][j]||{},ie[be][j][n]=se.target.value,ie})},children:[e.jsx("option",{value:"",children:"Link to section"}),(E[(i==null?void 0:i.uic)||""]||[]).map(se=>e.jsx("option",{value:se,children:se},se))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>qe(n),children:"Remove"})]})]},n)}),Le.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:Y,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:$,onChange:n=>R(n.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Te,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[tt.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>ze(n),children:"Remove"})]},n)),tt.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ye,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:V,onChange:n=>h(n.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Ue,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[je.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>ut(n),children:"Remove"})]},n)),je.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),Be==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),Me&&e.jsxs("div",{className:"mb-4 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:[e.jsx("strong",{children:"Error loading users:"})," ",Me]}),Ie&&e.jsx("div",{className:"mb-4 p-3 border border-blue-200 bg-blue-50 text-blue-800 rounded",children:"Loading users..."}),!Ie&&!Me&&et>0&&C.length===0&&e.jsxs("div",{className:"mb-4 p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:[e.jsx("strong",{children:"Note:"})," ",et," user(s) found in database, but none match your unit (",(i==null?void 0:i.unitName)||"No unit selected",", UIC: ",(i==null?void 0:i.uic)||"N/A",").",e.jsx("br",{}),e.jsx("span",{className:"text-sm",children:"Users may be assigned to different units."})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[M.map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[n.lastName,", ",n.firstName,n.mi?` ${n.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:n.email}),e.jsx("td",{className:"py-2 px-3",children:n.edipi}),e.jsx("td",{className:"py-2 px-3",children:n.service}),e.jsx("td",{className:"py-2 px-3",children:n.rank}),e.jsx("td",{className:"py-2 px-3",children:n.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const l=Je.find(se=>se.uic===n.unitUic),S=l?l.unitName:n.unit;if(n.isUnitAdmin||n.role==="COMMANDER")return S||"—";if(n.role==="COMPANY_REVIEWER")return n.company&&n.company!=="N/A"?n.company:"—";if(n.role==="PLATOON_REVIEWER"){const se=n.company&&n.company!=="N/A"?n.company:"",be=n.platoon&&n.platoon!=="N/A"?n.platoon:"",Se=[se,be].filter(Boolean);return Se.length?Se.join(" / "):"—"}return"—"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>G(n),children:"View"}),((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{Re("admin"),Q(n),T(n.role??"MEMBER"),ke(n.company!=="N/A"?n.company:void 0),ae(n.company!=="N/A"?n.company:void 0),f(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),X(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),$e(typeof n.commandOrder=="number"?String(n.commandOrder):""),D(!!n.isUnitAdmin),xe(!!n.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{u(l=>l.filter(S=>S.id!==n.id));try{localStorage.removeItem(`fs/users/${n.id}.json`)}catch(l){console.error("Failed to remove user from localStorage",l)}},children:"Delete"})]})})]},n.id)),M.length===0&&!Ie&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:Me?"Failed to load users - check console for details":et===0?"No users found in database":w?"No users match your search":"No users in this unit"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:g,type:"text",placeholder:"Filter users...",value:w,onChange:n=>F(n.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var n;return(n=g.current)==null?void 0:n.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:pt,children:"Export All"})]})]}),W&&e.jsx(Us,{user:W,onClose:()=>G(null)}),x&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>Q(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>Q(null),children:"✕"})]}),de==="profile"&&t&&x&&t.edipi===x.edipi&&e.jsx(Xt,{mode:"edit",initial:x,readOnly:!1,onSaved:n=>{u(l=>l.map(S=>S.edipi===n.edipi?n:S)),Q(null),_({type:"success",message:"Profile updated."})}}),de==="admin"&&((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:ne,onChange:n=>{const l=n.target.value;T(l),l==="COMMANDER"&&(ke(void 0),f(void 0))},className:"w-full px-3 py-2 border rounded",children:Qs.map(n=>e.jsx("option",{value:n,children:n},n))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:fe||"",onChange:n=>y(n.target.value||void 0),disabled:!ne.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:mt.length?"Select company":"No companies configured"}),mt.map(n=>e.jsx("option",{value:n,children:n},n))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:H||"",onChange:n=>pe(n.target.value||void 0),disabled:!ne.includes("REVIEW")||!fe,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:m.length?"Select platoon":"No platoons configured"}),m.map(n=>e.jsx("option",{value:n,children:n},n))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:o,onChange:n=>D(n.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:ee,disabled:ne==="COMMANDER",onChange:async n=>{const l=n.target.checked;xe(l);try{if(x&&!(await Ze({id:x.id,email:x.email,rank:x.rank,firstName:x.firstName,lastName:x.lastName,mi:x.mi,service:x.service,role:x.role,unitUic:x.unitUic,unit:x.unit,company:x.company,isUnitAdmin:!!x.isUnitAdmin,isCommandStaff:l,edipi:x.edipi,passwordHash:x.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})]}),Fe.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:Fe.map((n,l)=>e.jsx("div",{className:"text-sm",children:n},l))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{Q(null),oe.current=!1,v([]),r(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${I?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":I,disabled:I,onClick:async()=>{var se;if(!x)return;const n=[];if(ne==="COMPANY_REVIEWER"&&!ve&&n.push("Company is required for Company Reviewer."),ne==="PLATOON_REVIEWER"&&(!ve||!Ae)&&n.push("Company and Platoon are required for Platoon Reviewer."),v(n),n.length)return;r(!0);const l=((se=Je.find(be=>be.uic===x.unitUic))==null?void 0:se.unitName)||"N/A",S={...x,role:ne,isUnitAdmin:o,isCommandStaff:ne==="COMMANDER"?!1:ee,company:Z||"N/A",unit:l,platoon:re||"N/A",roleCompany:ne.includes("REVIEW")?fe||"N/A":void 0,rolePlatoon:ne.includes("REVIEW")?H||"N/A":void 0};try{localStorage.setItem(`fs/users/${S.edipi}.json`,JSON.stringify(S))}catch{}try{if(!(await Ze({id:S.id,email:S.email,rank:S.rank,firstName:S.firstName,lastName:S.lastName,mi:S.mi,service:S.service,role:S.role,unitUic:S.unitUic,unit:S.unit,company:S.company,isUnitAdmin:!!S.isUnitAdmin,isCommandStaff:!!S.isCommandStaff,edipi:S.edipi,passwordHash:S.passwordHash,roleCompany:S.roleCompany,rolePlatoon:S.rolePlatoon,platoon:S.platoon})).ok)throw new Error("persist_failed")}catch{r(!1),_({type:"error",message:"Failed to save administrative changes."});return}u(be=>be.map(Se=>Se.edipi===S.edipi?S:Se));try{t&&t.edipi===S.edipi&&(localStorage.setItem("currentUser",JSON.stringify(S)),a(S))}catch{}Q(null),oe.current=!1,r(!1),_({type:"success",message:"Administrative changes saved."})},children:[I&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),k&&e.jsx("div",{className:`p-3 rounded-lg border ${k.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:k.message})]})};function Js(){const[t,a]=s.useState([]),[i,b]=s.useState(null),[c,A]=s.useState({}),[E,N]=s.useState({}),[P,O]=s.useState([]),[q,K]=s.useState("unit"),[j,z]=s.useState("assigned"),[U,L]=s.useState([]),[d,te]=s.useState(""),[$,R]=s.useState([]),[V,h]=s.useState(""),B=()=>{ot().then(v=>a(v)).catch(()=>a([]))},u=()=>{bt().then(v=>O(v)).catch(()=>O([]))},k=()=>{b(null),B(),u()};s.useEffect(()=>{k(),Gt().then(v=>L(v)),Wt().then(v=>R(v))},[q,j]);const _=s.useMemo(()=>{const v={};for(const I of t)I.isUnitAdmin&&I.unitUic&&(v[I.unitUic]=I);return v},[t]),w=s.useMemo(()=>{const v=new Set;return Je.filter(I=>v.has(I.uic)?!1:(v.add(I.uic),!0))},[]),F=s.useMemo(()=>{const v={};for(const I of t)if(I.isInstallationAdmin&&I.installationId){const r=I.installationId;v[r]=v[r]||[],v[r].push(I)}return v},[t]),g=v=>t.filter(I=>I.unitUic===v.uic||!I.unitUic&&I.unit===v.unitName),x=async v=>{const I=c[v.uic];if(!I)return;const r=t.find(D=>D.id===I);if(!r)return;const o={...r,isUnitAdmin:!0,unitUic:v.uic,unit:v.unitName,company:"N/A"};try{if(!(await Ze({id:o.id,email:o.email,rank:o.rank,firstName:o.firstName,lastName:o.lastName,mi:o.mi,service:o.service,role:o.role,unitUic:o.unitUic,unit:o.unit,company:o.company,isUnitAdmin:!!o.isUnitAdmin,isInstallationAdmin:!!o.isInstallationAdmin,isCommandStaff:!!o.isCommandStaff,edipi:o.edipi})).ok){b({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}a(D=>D.map(ee=>ee.id===o.id?o:ee)),b({type:"success",message:`Assigned ${o.rank} ${o.lastName} as admin for ${v.unitName}.`})},Q=s.useMemo(()=>w.filter(v=>!!_[v.uic]),[w,_]);s.useMemo(()=>(Array.isArray(t)?t:[]).filter(v=>!!v.isHqmcAdmin),[t]);const W=s.useMemo(()=>w.filter(v=>!_[v.uic]),[w,_]),G=s.useMemo(()=>(Array.isArray(U)?U:[]).filter(v=>{var I;return(I=F[v.id])==null?void 0:I.length}),[U,F]),ne=s.useMemo(()=>(Array.isArray(U)?U:[]).filter(v=>{var I;return!((I=F[v.id])!=null&&I.length)}),[U,F]),T=s.useMemo(()=>{const v={};for(const I of Array.isArray(t)?t:[])if(I.isHqmcAdmin&&I.hqmcDivision){const r=I.hqmcDivision;v[r]=v[r]||[],v[r].push(I)}return v},[t]),ve=s.useMemo(()=>(Array.isArray($)?$:[]).filter(v=>{var I;return(I=T[v.code])==null?void 0:I.length}),[$,T]);s.useMemo(()=>{const v=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return(Array.isArray(P)?P:[]).filter(I=>v.includes(String(I.currentStage||"")))},[P]);const[ke,Ae]=s.useState(1),[f,Z]=s.useState(10),ae=Q.length,re=Math.max(1,Math.ceil(ae/(f||1))),X=Math.min(ke,re),fe=ae===0?0:(X-1)*f+1,y=ae===0?0:Math.min(fe+f-1,ae),H=Q.slice((X-1)*f,(X-1)*f+f),[pe,le]=s.useState(1),[ce,Ce]=s.useState(10),we=W.length,De=Math.max(1,Math.ceil(we/(ce||1))),$e=Math.min(pe,De),Be=we===0?0:($e-1)*ce+1,_e=we===0?0:Math.min(Be+ce-1,we),Fe=W.slice(($e-1)*ce,($e-1)*ce+ce);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${q==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{K("unit"),z("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${q==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{K("installation"),z("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${q==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{K("hqmc"),z("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${j==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>z("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${j==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>z("missing"),children:"Missing"})]}),q==="installation"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[G.map(v=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:v.name}),e.jsx("td",{className:"py-2 px-3",children:(F[v.id]||[]).map(I=>`${I.rank} ${I.lastName}, ${I.firstName}${I.mi?` ${I.mi}`:""}`).join(" • ")})]},v.id)),G.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),q==="installation"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[ne.map(v=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:v.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:E[v.id]||"",onChange:I=>N(r=>({...r,[v.id]:I.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(I=>e.jsx("option",{value:I.id,children:`${I.rank} ${I.lastName}, ${I.firstName}${I.mi?` ${I.mi}`:""}`},I.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!E[v.id],onClick:async()=>{const I=E[v.id],r=t.find(D=>D.id===I);if(!r)return;const o={...r,isInstallationAdmin:!0,installationId:v.id};try{if(!(await Ze({id:o.id,email:o.email,rank:o.rank,firstName:o.firstName,lastName:o.lastName,mi:o.mi,service:o.service,role:o.role,unitUic:o.unitUic,unit:o.unit,company:o.company,isUnitAdmin:!!o.isUnitAdmin,isInstallationAdmin:!!o.isInstallationAdmin,isCommandStaff:!!o.isCommandStaff,edipi:o.edipi,installationId:o.installationId})).ok){b({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}a(D=>D.map(ee=>ee.id===o.id?o:ee)),b({type:"success",message:`Assigned ${o.rank} ${o.lastName} as installation admin.`})},children:"Assign"})})]},v.id)),ne.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),q==="unit"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[H.map(v=>{const I=_[v.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:v.unitName}),e.jsx("td",{className:"py-2 px-3",children:v.uic}),e.jsx("td",{className:"py-2 px-3",children:`${I.rank} ${I.lastName}, ${I.firstName}${I.mi?` ${I.mi}`:""}`})]},v.uic)}),Q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(Ct,{currentPage:X,totalPages:re,totalItems:ae,pageSize:f,startIndex:fe,endIndex:y,onPageChange:v=>Ae(v),onPageSizeChange:v=>{Z(v),Ae(1)},onNext:()=>Ae(Math.min(X+1,re)),onPrevious:()=>Ae(Math.max(X-1,1)),onFirst:()=>Ae(1),onLast:()=>Ae(re),canGoNext:X<re,canGoPrevious:X>1,pageSizeOptions:[5,10,25,50]})})]}),q==="unit"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[Fe.map(v=>{const I=g(v);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:v.unitName}),e.jsx("td",{className:"py-2 px-3",children:v.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:c[v.uic]||"",onChange:r=>A(o=>({...o,[v.uic]:r.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:I.length?"Select user":"No eligible users"}),I.map(r=>e.jsx("option",{value:r.id,children:`${r.rank} ${r.lastName}, ${r.firstName}${r.mi?` ${r.mi}`:""}`},r.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!c[v.uic],onClick:()=>x(v),children:"Assign"})})]},v.uic)}),W.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(Ct,{currentPage:$e,totalPages:De,totalItems:we,pageSize:ce,startIndex:Be,endIndex:_e,onPageChange:v=>le(v),onPageSizeChange:v=>{Ce(v),le(1)},onNext:()=>le(Math.min($e+1,De)),onPrevious:()=>le(Math.max($e-1,1)),onFirst:()=>le(1),onLast:()=>le(De),canGoNext:$e<De,canGoPrevious:$e>1,pageSizeOptions:[5,10,25,50]})})]}),q==="hqmc"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[ve.map(v=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[v.code," — ",v.name]}),e.jsx("td",{className:"py-2 px-3",children:(T[v.code]||[]).map(I=>`${I.rank} ${I.lastName}, ${I.firstName}${I.mi?` ${I.mi}`:""}`).join(" • ")})]},v.code)),ve.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),q==="hqmc"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[$.filter(v=>{var I;return!((I=T[v.code])!=null&&I.length)}).map(v=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[v.code," — ",v.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:E[`hqmc_${v.code}`]||"",onChange:I=>N(r=>({...r,[`hqmc_${v.code}`]:I.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(I=>e.jsx("option",{value:I.id,children:`${I.rank} ${I.lastName}, ${I.firstName}${I.mi?` ${I.mi}`:""}`},I.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!E[`hqmc_${v.code}`],onClick:async()=>{const I=E[`hqmc_${v.code}`],r=t.find(D=>D.id===I);if(!r)return;const o={...r,isHqmcAdmin:!0,hqmcDivision:v.code};try{if(!(await Ze({id:o.id,email:o.email,rank:o.rank,firstName:o.firstName,lastName:o.lastName,mi:o.mi,service:o.service,role:o.role,unitUic:o.unitUic,unit:o.unit,company:o.company,isUnitAdmin:!!o.isUnitAdmin,isInstallationAdmin:!!o.isInstallationAdmin,isCommandStaff:!!o.isCommandStaff,isHqmcAdmin:!!o.isHqmcAdmin,hqmcDivision:o.hqmcDivision,edipi:o.edipi})).ok){b({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}a(D=>D.map(ee=>ee.id===o.id?o:ee)),b({type:"success",message:`Assigned ${o.rank} ${o.lastName} as HQMC admin for ${v.code}.`})},children:"Assign"})})]},v.code)),$.filter(v=>{var I;return!((I=T[v.code])!=null&&I.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),i&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${i.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:i.message})]})})}const Bt=!0,Ys=({onLoggedIn:t,onCreateAccount:a})=>{const[i,b]=s.useState(""),[c,A]=s.useState(""),[E,N]=s.useState(null),[P,O]=s.useState(!0),[q,K]=s.useState(!0);as.useEffect(()=>{},[]);const j=async z=>{z.preventDefault(),N(null);try{const U=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,L=/^[0-9]{10}$/.test(i),d=Bt?U.test(i.trim().toLowerCase())||L:U.test(i.trim().toLowerCase()),te=c.length>=6;if(O(d),K(te),!d){N({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!te){N({type:"error",message:"Password must be at least 6 characters."});return}let $=null,R=null,V=i.trim().toLowerCase();if(Bt&&L){const{user:F,error:g}=await St(String(i));$=F,R=g,V=String(($==null?void 0:$.email)||"")}else if(U.test(V)){const{user:F,error:g}=await Mt(V);$=F,R=g}else{N({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(R){N({type:"error",message:`Database Error: ${R}`});return}if(!$||!V){N({type:"error",message:"Account not found."});return}const h=String($.passwordHash||$.password_hash||"").trim();if(!h){N({type:"error",message:"No password set for this user."});return}const B=await Et(c);if(!(/^[0-9a-f]{64}$/i.test(h)?h.toLowerCase()===B.toLowerCase():h===c)){N({type:"error",message:"Invalid credentials."});return}const{user:_,error:w}=await Mt(V);if(w){N({type:"error",message:`Profile Error: ${w}`});return}if(!_){console.error("[Login] User profile not found after successful password verification",{emailForLogin:V}),N({type:"error",message:"User profile not found."});return}N({type:"success",message:"Logged in."}),t(_)}catch(U){console.error("[Login] Login failed:",U),N({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:j,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:i,onChange:z=>b(z.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${P?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!P}),!P&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:c,onChange:z=>A(z.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${q?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!q}),!q&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),E&&e.jsx("div",{className:`p-3 rounded-lg border ${E.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:E.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:a,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!P||!q,children:"Login"})]})]})]})},Ft=""+new URL("logo-DLcHofKE.png",import.meta.url).href,Ks=({currentUser:t,hasSectionDashboard:a,hasCommandDashboard:i,hasInstallationSectionDashboard:b=!1,hasInstallationCommandDashboard:c=!1,hasHQMCSectionDashboard:A=!1,hasHQMCApproverDashboard:E=!1,onManageProfile:N,onLogout:P,onNavigate:O,isLogin:q=!1})=>{const[K,j]=s.useState(!1),[z,U]=s.useState(!1),L=s.useRef(null);return s.useEffect(()=>{const d=$=>{if(!K)return;const R=L.current;R&&$.target&&!R.contains($.target)&&j(!1)},te=$=>{$.key==="Escape"&&j(!1)};return document.addEventListener("mousedown",d),document.addEventListener("touchstart",d,{passive:!0}),document.addEventListener("keydown",te),()=>{document.removeEventListener("mousedown",d),document.removeEventListener("touchstart",d),document.removeEventListener("keydown",te)}},[K]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:q?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:Ft,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:Ft,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:t?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[t.rank," ",t.lastName,t.lastName?",":""," ",t.firstName,t.mi?` ${t.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[t.service," • ",t.role,(()=>{const d={PLATOON_REVIEWER:t.role_platoon,COMPANY_REVIEWER:t.role_company}[t.role];return d?` - ${d}`:null})()]}),(()=>{var V;const d=((V=Je.find(h=>h.uic===((t==null?void 0:t.unitUic)||"")))==null?void 0:V.unitName)||(t==null?void 0:t.unit)||"",te=t!=null&&t.company&&t.company!=="N/A"?t.company:t!=null&&t.user_company&&t.user_company!=="N/A"?t.user_company:null,$=t!=null&&t.platoon&&t.platoon!=="N/A"?t.platoon:t!=null&&t.user_platoon&&t.user_platoon!=="N/A"?t.user_platoon:null,R=[d||null,te,$].filter(Boolean);return R.length?e.jsx("div",{className:"text-xs text-white/70",children:R.join(" • ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:N,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:P,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),t&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>U(!z),children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),z&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{N(),U(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{P(),U(!1)},children:"Logout"})]})]}),!t&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>O("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:L,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":K,onClick:()=>j(d=>!d),children:"Dashboards"}),e.jsxs("div",{className:`${K?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:t&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("dashboard"),j(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(t==null?void 0:t.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("admin"),j(!1)},children:"Unit Admin"}),t&&!!t.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("appadmin"),j(!1)},children:"App Admin"}),t&&!!t.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("hqmc-admin"),j(!1)},children:"HQMC Admin"}),t&&!!t.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("installation"),j(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[t&&a&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("section"),j(!1)},children:"Unit Section Dashboard"}),i&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("command"),j(!1)},children:"Unit Command Dashboard"}),String((t==null?void 0:t.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("review"),j(!1)},children:"Unit Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[t&&b&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("installation-section"),j(!1)},children:"Installation Section Dashboard"}),t&&c&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("installation-command"),j(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[t&&(A||!!t.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("hqmc-section"),j(!1)},children:"HQMC Section Dashboard"}),t&&E&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("hqmc-approver"),j(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})},Ve={SECTION:"perm_section",COMMAND:"perm_command",INST_SECTION:"perm_inst_section",INST_COMMAND:"perm_inst_command",HQMC_SECTION:"perm_hqmc_section",HQMC_APPROVER:"perm_hqmc_approver"},rt=t=>{try{return localStorage.getItem(t)==="true"}catch(a){return console.error(`Failed to read from localStorage for key "${t}":`,a),!1}};function Xs(){const[t,a]=s.useState(null),[i,b]=s.useState("login"),[c,A]=s.useState(()=>{try{const u=localStorage.getItem("currentUser");return u?JSON.parse(u):null}catch(u){return console.error("Failed to parse user from localStorage:",u),null}}),[E,N]=s.useState("create"),[P,O]=s.useState(!1),[q,K]=s.useState(()=>rt(Ve.SECTION)),[j,z]=s.useState(()=>rt(Ve.COMMAND)),[U,L]=s.useState(()=>rt(Ve.INST_SECTION)),[d,te]=s.useState(()=>rt(Ve.INST_COMMAND)),[$,R]=s.useState(()=>rt(Ve.HQMC_SECTION)),[V,h]=s.useState(()=>rt(Ve.HQMC_APPROVER)),B=ns();return s.useEffect(()=>{try{const k=new URLSearchParams(window.location.search).get("view");if(k==="admin"||k==="profile"||k==="dashboard"||k==="login"||k==="appadmin"||k==="hqmc-admin"||k==="hqmc-section"||k==="hqmc-approver"||k==="review"||k==="section"||k==="command"||k==="installation"||k==="installation-section"||k==="installation-command"||k==="documents"||k==="document-viewer"||k==="upload")b(k);else{const _=localStorage.getItem("currentView"),w=localStorage.getItem("currentUser");b(_&&w?_:"login")}}catch{b("login")}},[]),s.useEffect(()=>{c?localStorage.setItem("currentUser",JSON.stringify(c)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"),Object.values(Ve).forEach(u=>{try{localStorage.removeItem(u)}catch(k){console.error(`Failed to remove item from localStorage for key "${u}":`,k)}}))},[c]),s.useEffect(()=>{if(!c)return;const u={[Ve.SECTION]:q,[Ve.COMMAND]:j,[Ve.INST_SECTION]:U,[Ve.INST_COMMAND]:d,[Ve.HQMC_SECTION]:$,[Ve.HQMC_APPROVER]:V};for(const[k,_]of Object.entries(u))try{localStorage.setItem(k,String(_))}catch(w){console.error(`Failed to set item in localStorage for key "${k}":`,w)}},[c,q,j,U,d,$,V]),s.useEffect(()=>{let u=!1;return(async()=>{try{const k=(c==null?void 0:c.id)||"";if(!k)return;const _=await Ut(k);if(_&&!u){const w=(x,Q)=>x===!0||x===!1?x:Q||!1,F=(x,Q)=>x!=null?x||void 0:Q,g={..._,isAppAdmin:w(_.isAppAdmin,c==null?void 0:c.isAppAdmin),isUnitAdmin:w(_.isUnitAdmin,c==null?void 0:c.isUnitAdmin),isInstallationAdmin:w(_.isInstallationAdmin,c==null?void 0:c.isInstallationAdmin),isHqmcAdmin:w(_.isHqmcAdmin,c==null?void 0:c.isHqmcAdmin),isCommandStaff:w(_.isCommandStaff,c==null?void 0:c.isCommandStaff),installationId:F(_.installationId,c==null?void 0:c.installationId),hqmcDivision:F(_.hqmcDivision,c==null?void 0:c.hqmcDivision)};A(g),localStorage.setItem("currentUser",JSON.stringify(g))}}catch{}})(),()=>{u=!0}},[]),s.useEffect(()=>{i!=="login"&&c&&localStorage.setItem("currentView",i)},[i,c]),s.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const k=await yt();localStorage.setItem("unit_structure",JSON.stringify(k))}catch(u){console.error("Failed to load unit structure:",u)}})()},[]),s.useEffect(()=>{var u,k,_;if(c){try{const w=localStorage.getItem("unit_structure");if(w){const F=JSON.parse(w),g=(c==null?void 0:c.unitUic)||"",x=c!=null&&c.company&&c.company!=="N/A"?c.company:"",Q=c!=null&&c.platoon&&c.platoon!=="N/A"?c.platoon:"",W=((_=(k=(u=F==null?void 0:F[g])==null?void 0:u._platoonSectionMap)==null?void 0:k[x])==null?void 0:_[Q])||"";K(!!W)}}catch(w){console.error("Failed to parse unit structure for section dashboard check",w)}z(!!(c!=null&&c.isCommandStaff)),(async()=>{try{const w=(c==null?void 0:c.installationId)||"";if(!w){L(!1),te(!1);return}const F=await Gt();try{localStorage.setItem("installations_cache",JSON.stringify(F))}catch{}const g=F==null?void 0:F.find(G=>G.id===w),x=(c==null?void 0:c.id)||"",Q=!!(g&&g.sectionAssignments&&Object.values(g.sectionAssignments).some(G=>Array.isArray(G)&&G.includes(x))),W=!!(g&&(g.commandSectionAssignments&&Object.values(g.commandSectionAssignments).some(G=>Array.isArray(G)&&G.includes(x))||g.commanderUserId&&String(g.commanderUserId)===x));L(Q),te(W)}catch{}})(),(async()=>{try{const w=String((c==null?void 0:c.hqmcDivision)||""),F=String((c==null?void 0:c.id)||"");if(!w||!F){R(!!(c!=null&&c.isHqmcAdmin)),h(!1);return}const{listHQMCSectionAssignmentsLegacy:g}=await rs(async()=>{const{listHQMCSectionAssignmentsLegacy:G}=await import("./db-BtncR-UB.js").then(ne=>ne.A);return{listHQMCSectionAssignmentsLegacy:G}},__vite__mapDeps([0,1,2]),import.meta.url),x=await g(),Q=x.some(G=>G.division_code===w&&((G.reviewers||[]).includes(F)||(G.approvers||[]).includes(F))),W=x.some(G=>G.division_code===w&&(G.approvers||[]).includes(F));R(Q||!!(c!=null&&c.isHqmcAdmin)),h(W)}catch{c!=null&&c.isHqmcAdmin&&R(!0)}})()}},[c]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(Ks,{currentUser:c,hasSectionDashboard:q,hasCommandDashboard:j,hasInstallationSectionDashboard:U,hasInstallationCommandDashboard:d,hasHQMCSectionDashboard:$,hasHQMCApproverDashboard:V,onManageProfile:()=>{N("edit"),b("profile"),B("/?view=profile")},onLogout:()=>{A(null),b("login"),B("/?view=login")},onNavigate:u=>{b(u),B(`/?view=${u}`)},isLogin:i==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:i==="profile"?e.jsx(Xt,{mode:E,initial:E==="edit"?c||{}:{},onSaved:u=>{A(u),b("dashboard"),B("/?view=dashboard")}}):i==="admin"?e.jsx(Gs,{}):i==="appadmin"?e.jsx(Js,{}):i==="login"?e.jsx(Ys,{onLoggedIn:u=>{A(u),b("dashboard"),B("/?view=dashboard")},onCreateAccount:()=>{N("create"),b("profile"),B("/?view=profile")}}):i==="review"?e.jsx(_s,{}):i==="section"?e.jsx(fs,{}):i==="command"?e.jsx(ys,{}):i==="installation"?e.jsx(ps,{}):i==="hqmc-admin"?e.jsx(Ls,{}):i==="installation-section"?e.jsx(vs,{}):i==="installation-command"?e.jsx(Ns,{}):i==="hqmc-section"?e.jsx(Bs,{}):i==="hqmc-approver"?e.jsx(Vs,{}):e.jsx(Is,{selectedUnit:t,currentUser:c})})]})}function ua(){return e.jsx(Xs,{})}export{ua as default};
