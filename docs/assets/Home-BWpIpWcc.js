const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-DT7oWH3m.js","./index-DS4fb1BX.js","./index-w44NKcau.css"])))=>i.map(i=>d[i]);
import{r as t,s as Et,j as e,v as Ft,l as rt,M as yt,a as Bt,u as Ht,R as Wt,b as Vt,_ as zt}from"./index-DS4fb1BX.js";import{s as ke,d as Gt,a as Qt,b as Ut,l as ht,c as nt,e as Qe,u as Le,f as dt,g as gt,h as He,i as Jt,j as Yt,k as kt,m as bt,n as It,o as lt,p as Kt,q as Xt,r as Rt,t as Mt,v as mt,w as Pt,x as vt}from"./db-DT7oWH3m.js";import{P as ut,I as Zt}from"./InstallationAdmin-Kwls58Q4.js";import{f as es,R as Ge,S as Ke,o as Nt,c as ts}from"./RequestTable-DjhVkTum.js";import{l as ft}from"./unitStructure-QC5qYuxv.js";import ss from"./SectionDashboard-CRXV6omn.js";import as from"./CommandDashboard-KD4mNkI0.js";import ns from"./InstallationSectionDashboard-g3fC0XX_.js";import is from"./InstallationCommandDashboard-CjpAZPiM.js";import{U as qe}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-Cd_ZPQ_w.js";function pt(s,n={}){const{pageSize:i=25,initialPage:v=1}=n,[p,O]=t.useState(v),[I,A]=t.useState(i),M=s.length,F=Math.ceil(M/I),G=(p-1)*I,ee=Math.min(G+I,M);return{currentData:t.useMemo(()=>s.slice(G,ee),[s,G,ee]),currentPage:p,pageSize:I,totalPages:F,totalItems:M,goToPage:E=>{const B=Math.max(1,Math.min(E,F));O(B)},nextPage:()=>{p<F&&O(p+1)},previousPage:()=>{p>1&&O(p-1)},goToFirstPage:()=>{O(1)},goToLastPage:()=>{O(F)},setPageSize:E=>{A(E),O(1)},canGoNext:p<F,canGoPrevious:p>1,startIndex:G+1,endIndex:ee}}const Xe="edms-docs";function rs(){return{uploadFile:async(O,I)=>{if(!ke)return{url:"",error:"Supabase not configured"};try{const{error:A}=await ke.storage.from(Xe).upload(I,O,{upsert:!0});if(A)return{url:"",error:A.message};const{data:M}=ke.storage.from(Xe).getPublicUrl(I);return{url:(M==null?void 0:M.publicUrl)||""}}catch(A){return{url:"",error:A instanceof Error?A.message:"Upload failed"}}},deleteFile:async O=>{if(!ke||!O)return!1;try{return await ke.storage.from(Xe).remove([O]),!0}catch{return!1}},deleteFolder:async O=>{if(!ke)return!1;try{const{data:I}=await ke.storage.from(Xe).list(O.replace(/\/$/,""));if(I&&I.length>0){const A=I.map(M=>`${O.replace(/\/$/,"")}/${M.name}`);await ke.storage.from(Xe).remove(A)}return!0}catch{return!1}},extractStoragePath:O=>{if(!O)return null;try{const I=O.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(I!=null&&I[1])return decodeURIComponent(I[1])}catch{}return null},buildStoragePath:(O,I,A,M)=>{const F=Date.now();return`${O||"N-A"}/${I}/${F}-${M}-${Et(A)}`}}}const st=s=>{const n=String(s||"").trim();return n&&n!=="N/A"?n:""},jt=(s,n,i)=>s.some(v=>String(v.role||"")!==n||st(v.roleCompany||v.company)!==i.company||n==="PLATOON_REVIEWER"&&st(v.rolePlatoon||v.platoon)!==(i.platoon||"")?!1:String(v.unitUic||"")===String(i.uic||""));function Dt(s){if(s===0)return"0 Bytes";const n=1024,i=["Bytes","KB","MB","GB"],v=Math.floor(Math.log(s)/Math.log(n));return parseFloat((s/Math.pow(n,v)).toFixed(2))+" "+i[v]}const St=t.memo(function({doc:n,onView:i,onDelete:v}){return e.jsxs("article",{className:"flex items-center justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors","aria-label":`Document: ${n.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-brand-cream rounded-lg flex items-center justify-center","aria-hidden":"true",children:e.jsx("svg",{className:"w-5 h-5 text-brand-navy",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-[var(--text)]",children:n.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)]",children:[n.name," • ",Dt(n.size)," • ",new Date(n.uploadedAt).toLocaleDateString()]}),n.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(n.dueDate).toLocaleDateString()]}),n.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Notes: ",n.notes]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",role:"group","aria-label":"Document actions",children:[n.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:es({currentStage:n.currentStage})}),n.fileUrl&&e.jsx("a",{href:n.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${n.name} in new tab`,children:"Open"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:p=>{p.stopPropagation(),i(n)},"aria-label":`View or edit document ${n.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:p=>{p.stopPropagation(),v(n)},"aria-label":`Delete document ${n.subject}`,children:"Delete"})]})]})}),ze="edms-docs",os=({selectedUnit:s,currentUser:n})=>{const[i,v]=t.useState([]),[p,O]=t.useState(!1),[I,A]=t.useState(""),[M,F]=t.useState(""),[G,ee]=t.useState(""),[N,K]=t.useState([]),[U,_]=t.useState(null),[u,de]=t.useState(null),[J,E]=t.useState([]),[B,R]=t.useState(!1),[Q,m]=t.useState(null),[S,L]=t.useState(""),[k,H]=t.useState(""),[g,h]=t.useState(""),[W,$]=t.useState([]),[X,Y]=t.useState([]),[T,ge]=t.useState(null),[be,Se]=t.useState(""),[f,V]=t.useState(""),[ne,se]=t.useState(""),[Z,xe]=t.useState([]),[b,D]=t.useState(!1),[le,me]=t.useState({}),[pe,we]=t.useState(""),[he,Ae]=t.useState("Pending"),r=rs(),y=o=>{const j=o.target.files?Array.from(o.target.files):[];if(j.length===0)return;if(N.length+j.length>yt){_({type:"error",message:`Cannot add ${j.length} file(s). Maximum ${yt} files allowed per request.`});try{o.target.value=""}catch{}return}const P=[],oe=[];for(const ie of j){const te=Bt(ie);te.valid?P.push(ie):oe.push(...te.errors)}P.length>0&&K(ie=>[...ie,...P]),oe.length>0&&_({type:"error",message:oe.slice(0,3).join(" ")+(oe.length>3?` (+${oe.length-3} more errors)`:"")});try{o.target.value=""}catch{}},z=async()=>{if(!T||!(u!=null&&u.id)||T.uploadedById!==u.id)return;const o={actor:`${u.rank} ${u.lastName}, ${u.firstName}${u.mi?` ${u.mi}`:""}`,timestamp:new Date().toISOString(),action:"Archived by Originator",comment:(ne||"").trim()},j={...T,currentStage:Ke.ARCHIVED,finalStatus:"Archived",activity:Array.isArray(T.activity)?[...T.activity,o]:[o]};try{const P=await Le(j);if(!P.ok)throw new Error(q(P,"request_upsert_failed"));Y(oe=>oe.map(ie=>ie.id===j.id?j:ie)),ge(j),_({type:"success",message:"Request archived."})}catch(P){_({type:"error",message:`Failed to archive: ${String((P==null?void 0:P.message)||P)}`})}},d=async o=>{o.preventDefault(),_(null);const j=I.trim();if(!j){_({type:"error",message:"Subject is required."});return}if(j.length>500){_({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(G.length>5e3){_({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(u!=null&&u.id)){_({type:"error",message:"Create a profile before submitting."});return}if(N.length>0){const fe=Ft(N);if(!fe.valid){_({type:"error",message:fe.errors[0]});return}}O(!0);const P=Date.now(),oe=pe||u.id,ie=J.find(fe=>fe.id===oe),te=s?s.uic:(ie==null?void 0:ie.unitUic)||"N/A",ve=`req-${P}`;let ue=[];async function Re(fe,Ie){if(!ke)throw new Error("Supabase not configured");const{error:Me}=await ke.storage.from(ze).upload(Ie,fe,{upsert:!0});if(Me)throw new Error(Me.message);const{data:Fe}=ke.storage.from(ze).getPublicUrl(Ie);return(Fe==null?void 0:Fe.publicUrl)||""}if(N&&N.length>0){const fe=[];for(let Ie=0;Ie<N.length;Ie++){const Me=N[Ie],Fe=`${te}/${ve}/${P}-${Ie}-${Et(Me.name)}`;try{const $e=await Re(Me,Fe);fe.push($e)}catch($e){O(!1),_({type:"error",message:`Failed to upload ${Me.name}: ${String(($e==null?void 0:$e.message)||$e)}`});return}}ue=N.map((Ie,Me)=>({id:`${P}-${Me}`,name:Ie.name,type:Ie.type,size:Ie.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:te,subject:I.trim(),dueDate:M||void 0,notes:G.trim()||void 0,uploadedById:oe,currentStage:"PLATOON_REVIEW",fileUrl:fe[Me]}))}ue=ue.map(fe=>({...fe,requestId:ve})),v(fe=>[...fe,...ue]),K([]),A(""),F(""),ee("");try{const fe=u?`${u.rank} ${u.lastName}, ${u.firstName}${u.mi?` ${u.mi}`:""}`:"Unknown",Ie=te,Me=st(ie==null?void 0:ie.company),Fe=st(ie==null?void 0:ie.platoon),$e=jt(J,"PLATOON_REVIEWER",{company:Me,platoon:Fe,uic:Ie}),it=jt(J,"COMPANY_REVIEWER",{company:Me,uic:Ie}),Ve={id:ve,subject:I.trim(),dueDate:M||void 0,notes:G.trim()||void 0,unitUic:te,uploadedById:oe,submitForUserId:oe,documentIds:ue.map(Ee=>Ee.id),createdAt:new Date().toISOString(),currentStage:$e?Ke.PLATOON_REVIEW:it?Ke.COMPANY_REVIEW:Ke.BATTALION_REVIEW,activity:[{actor:fe,timestamp:new Date().toISOString(),action:"Submitted request",comment:(G||"").trim()}]};try{const Ee=await Le(Ve);if(!Ee.ok)throw new Error(q(Ee,"request_upsert_failed"));const a=await dt(ue);if(!a.ok)throw new Error(q(a,"document_upsert_failed"))}catch(Ee){O(!1);try{rt("request_persist_failed",{requestId:ve,error:String((Ee==null?void 0:Ee.message)||Ee)},"error")}catch{}_({type:"error",message:`Failed to persist submission: ${String((Ee==null?void 0:Ee.message)||Ee)}`});return}Y(Ee=>Ee.some(c=>c.id===Ve.id)?Ee.map(c=>c.id===Ve.id?Ve:c):[...Ee,Ve]),O(!1),_({type:"success",message:"Submission successful."}),R(!1)}catch{O(!1);try{rt("request_persist_failed",{requestId:ve},"error")}catch{}_({type:"error",message:"Failed to persist submission."})}},x=t.useCallback(o=>{m(o),L(o.subject||""),H(o.dueDate||""),h(o.notes||"");try{const j=localStorage.getItem(`fs/requests/${o.requestId}.json`);if(j){const P=JSON.parse(j);$(Array.isArray(P.activity)?P.activity:[])}else{const ie=Object.values(Object.assign({})).map(te=>(te==null?void 0:te.default)??te).find(te=>te&&te.id===o.requestId);$(ie&&Array.isArray(ie.activity)?ie.activity:[])}}catch{$([])}},[]),q=(o,j)=>{var P;return String(((P=o.error)==null?void 0:P.message)||o.error||j)},w=async()=>{if(!Q)return;const o=i.map(j=>j.id===Q.id?{...j,subject:S.trim()||j.subject,dueDate:k||void 0,notes:g.trim()||void 0}:j);v(o);try{const P={actor:u?`${u.rank} ${u.lastName}, ${u.firstName}${u.mi?` ${u.mi}`:""}`:"Unknown",timestamp:new Date().toISOString(),action:"Updated document",comment:(g||"").trim()},oe=Q.requestId?X.find(ie=>ie.id===Q.requestId):null;if(oe){const ie={...oe,activity:Array.isArray(oe.activity)?[...oe.activity,P]:[P]};try{const te=await Le(ie);if(!te.ok)throw new Error(q(te,"request_upsert_failed"))}catch(te){console.error("Failed to save document edits:",te),_({type:"error",message:`Failed to save document edits: ${te.message}`});return}$(te=>[...te,P])}}catch{}h(""),m(null)};i.filter(o=>!(!(u!=null&&u.id)||u.role==="MEMBER"&&o.uploadedById!==u.id||o.type==="request"));const ae=()=>String((u==null?void 0:u.role)||"").includes("REVIEW"),Ne=()=>{if(!ae())return[];const o=String((u==null?void 0:u.role)||"");return J.filter(j=>{if(j.id===(u==null?void 0:u.id))return!1;if(o.includes("PLATOON")){const P=j.company&&j.company!=="N/A"?j.company:"",oe=j.unit&&j.unit!=="N/A"?j.unit:"",ie=u!=null&&u.company&&u.company!=="N/A"?u.company:"",te=u!=null&&u.unit&&u.unit!=="N/A"?u.unit:"";return P===ie&&oe===te}if(o.includes("COMPANY")){const P=j.company&&j.company!=="N/A"?j.company:"",oe=u!=null&&u.company&&u.company!=="N/A"?u.company:"";return P===oe}return o.includes("COMMANDER")?(j.unitUic||"")===((u==null?void 0:u.unitUic)||""):!1})},De=t.useCallback(async o=>{const j=r.extractStoragePath(o.fileUrl);try{j&&ke&&await ke.storage.from(ze).remove([j])}catch{}try{await Gt(o.id),v(P=>P.filter(oe=>oe.id!==o.id)),o.requestId&&Y(P=>P.map(oe=>oe.id===o.requestId?{...oe,documentIds:(oe.documentIds||[]).filter(ie=>ie!==o.id)}:oe)),_({type:"success",message:"Document deleted."})}catch(P){_({type:"error",message:`Failed to delete: ${String((P==null?void 0:P.message)||P)}`})}},[]),We=t.useCallback(async o=>{const j=`${o.unitUic||"N-A"}/${o.id}/`;try{if(ke){const{data:P}=await ke.storage.from(ze).list(j.slice(0,-1));if(P&&P.length>0){const oe=P.map(ie=>`${j.slice(0,-1)}/${ie.name}`);await ke.storage.from(ze).remove(oe)}}}catch{}try{await Qt(o.id),await Ut(o.id),v(P=>P.filter(oe=>oe.requestId!==o.id)),Y(P=>P.filter(oe=>oe.id!==o.id)),ge(null),_({type:"success",message:"Request and files deleted."})}catch(P){_({type:"error",message:`Failed to delete request: ${String((P==null?void 0:P.message)||P)}`})}},[]),Pe=async()=>{if(!T||!(u!=null&&u.id)||T.uploadedById!==u.id){_({type:"error",message:"Only the requester can edit this."});return}const o=Date.now(),j=ve=>ve.replace(/[^A-Za-z0-9._-]/g,"-");async function P(ve,ue){if(!ke)throw new Error("Supabase not configured");const{error:Re}=await ke.storage.from(ze).upload(ue,ve,{upsert:!0});if(Re)throw new Error(Re.message);const{data:fe}=ke.storage.from(ze).getPublicUrl(ue);return(fe==null?void 0:fe.publicUrl)||""}const oe=[];for(let ve=0;ve<Z.length;ve++){const ue=Z[ve],Re=`${T.unitUic||"N-A"}/${T.id}/${o}-${ve}-${j(ue.name)}`;try{const fe=await P(ue,Re);oe.push(fe)}catch(fe){_({type:"error",message:`Failed to upload ${ue.name}: ${String((fe==null?void 0:fe.message)||fe)}`});return}}const ie=Z.map((ve,ue)=>({id:`${o}-${ue}`,name:ve.name,type:ve.type,size:ve.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:T.unitUic||"N/A",subject:be.trim()||T.subject,dueDate:f||void 0,notes:ne.trim()||void 0,uploadedById:u.id,currentStage:T.currentStage||"PLATOON_REVIEW",requestId:T.id,fileUrl:oe[ue]})),te={...T,subject:be.trim()||T.subject,dueDate:f||void 0,notes:ne.trim()||void 0,documentIds:[...T.documentIds||[],...ie.map(ve=>ve.id)],activity:[...T.activity||[],{actor:`${u.rank} ${u.lastName}, ${u.firstName}${u.mi?` ${u.mi}`:""}`,timestamp:new Date().toISOString(),action:ie.length?`Updated request and added ${ie.length} document(s)`:"Updated request",comment:(ne||"").trim()}]};try{if(!(u&&ts(T,String(u.id||"")))){_({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const ue=await dt(ie);if(!ue.ok)throw new Error(q(ue,"document_upsert_failed"));const Re=await Le(te);if(!Re.ok)throw new Error(q(Re,"request_upsert_failed"))}catch(ue){try{rt("request_update_failed",{requestId:te.id,error:String((ue==null?void 0:ue.message)||ue)},"error")}catch{}_({type:"error",message:`Failed to persist documents: ${String((ue==null?void 0:ue.message)||ue)}`});return}v(ue=>[...ue,...ie]),Y(ue=>ue.map(Re=>Re.id===te.id?te:Re)),ge(te),xe([]),se(""),_({type:"success",message:ie.length?"Files added and request updated.":"Request updated."})}catch{_({type:"error",message:"Failed to update request."})}},[Oe,Te]=t.useState(!0),[Be,Ue]=t.useState(!0);t.useEffect(()=>{ht().then(o=>{v(o)}).catch(()=>v([])).finally(()=>Te(!1))},[]),t.useEffect(()=>{T&&(Se(T.subject||""),V(T.dueDate||""),se(T.notes||""),xe([]))},[T]),t.useEffect(()=>{},[i]),t.useEffect(()=>{nt().then(o=>{Y(o)}).catch(()=>Y([])).finally(()=>Ue(!1))},[]),t.useEffect(()=>{de(n||null)},[n]),t.useEffect(()=>{Qe().then(o=>{E(o)}).catch(()=>E([]))},[]);const Je=t.useMemo(()=>{if(!(u!=null&&u.id))return[];const o=X.filter(j=>j.uploadedById===u.id);return he==="Pending"?o.filter(j=>j.currentStage!=="ARCHIVED"):o.filter(j=>j.currentStage==="ARCHIVED")},[X,u,he]),Ce=pt(Je,{pageSize:10}),l=t.useMemo(()=>J.reduce((o,j)=>({...o,[j.id]:j}),{}),[J]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>R(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),B&&e.jsxs("form",{onSubmit:d,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:I,onChange:o=>A(o.target.value),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${I.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:M,onChange:o=>F(o.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),String((u==null?void 0:u.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:pe,onChange:o=>we(o.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),Ne().map(o=>e.jsxs("option",{value:o.id,children:[o.rank," ",o.lastName,", ",o.firstName,o.mi?` ${o.mi}`:""]},o.id))]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:G,onChange:o=>ee(o.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:y,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:N.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:N.map((o,j)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:o.name,children:o.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>K(P=>P.filter((oe,ie)=>ie!==j)),children:"Delete"})]},j))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{R(!1),K([]),A(""),F(""),ee(""),_(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!I.trim(),children:"Submit"})]})]}),U&&e.jsx("div",{className:`p-3 rounded-lg border ${U.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:U.message})]})]}),e.jsxs("div",{className:"p-6",children:[u&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>Ae("Pending"),className:`${he==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>Ae("Archived"),className:`${he==="Archived"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Archived"})]})}),e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:Ce.totalItems>0?`${Ce.startIndex}–${Ce.endIndex} of ${Ce.totalItems}`:""}),Be&&e.jsx("div",{className:"animate-pulse",children:"Loading requests…"})]}),e.jsx(Ge,{title:"Your Requests",requests:Be?Array.from({length:5}).map((o,j)=>({id:`s-${j}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:Ke.PLATOON_REVIEW})):Ce.currentData,users:l,onRowClick:o=>ge(o),expandedRows:le,children:o=>e.jsxs("div",{id:`req-docs-${o.id}`,children:[Oe?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):i.filter(j=>j.requestId===o.id&&j.type!=="request").map(j=>e.jsx(St,{doc:j,onView:x,onDelete:De},j.id)),!Oe&&i.filter(j=>j.requestId===o.id&&j.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),Ce.totalItems>0&&e.jsx(ut,{currentPage:Ce.currentPage,totalPages:Ce.totalPages,totalItems:Ce.totalItems,pageSize:Ce.pageSize,startIndex:Ce.startIndex,endIndex:Ce.endIndex,onPageChange:Ce.goToPage,onPageSizeChange:Ce.setPageSize,onNext:Ce.nextPage,onPrevious:Ce.previousPage,onFirst:Ce.goToFirstPage,onLast:Ce.goToLastPage,canGoNext:Ce.canGoNext,canGoPrevious:Ce.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),p&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),Q&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>m(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:S,onChange:o=>L(o.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:k,onChange:o=>H(o.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:Q.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:g,onChange:o=>h(o.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[Q.name," • ",Dt(Q.size)," • ",new Date(Q.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:W.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):W.map((o,j)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[o.actor," • ",new Date(o.timestamp).toLocaleString()," • ",o.action]}),o.comment&&e.jsx("div",{className:"text-gray-600",children:o.comment})]},j))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>m(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:w,children:"Save"})]})]})}),T&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>ge(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>ge(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:be,onChange:o=>Se(o.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(T.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:f,onChange:o=>V(o.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),T.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:T.currentStage}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:3,value:ne,onChange:o=>se(o.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:T.activity&&T.activity.length?T.activity.map((o,j)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[o.actor," • ",new Date(o.timestamp).toLocaleString()," • ",o.action]}),o.comment&&e.jsx("div",{className:"text-gray-600",children:o.comment})]},j)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Documents"}),e.jsxs("button",{className:"mt-2 px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-expanded":b,"aria-controls":"docs-panel",onClick:()=>D(o=>!o),children:[b?"Hide":"Show"," Documents"]}),e.jsx("div",{id:"docs-panel",className:b?"mt-3 space-y-2":"hidden",children:i.filter(o=>o.requestId===T.id&&o.type!=="request").map(o=>e.jsx(St,{doc:o,onView:x,onDelete:De},o.id))}),!Nt(T,String((u==null?void 0:u.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:o=>{const j=o.target.files?Array.from(o.target.files):[];xe(P=>[...P,...j]);try{o.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:Z.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):Z.map((o,j)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:o.name,children:o.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>xe(P=>P.filter((oe,ie)=>ie!==j)),children:"Delete"})]},j))})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>ge(null),children:"Close"}),Nt(T,String((u==null?void 0:u.id)||""))?e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-gold text-brand-charcoal hover:brightness-110",onClick:z,children:"Archive"}):e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:Pe,disabled:!u||u.id!==((T==null?void 0:T.uploadedById)||""),children:"Save Changes"}),u&&u.id===((T==null?void 0:T.uploadedById)||"")&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>We(T),children:"Delete Request"})]})]})})]})},cs=({currentUser:s,onClose:n})=>{const[i,v]=t.useState([]),[p,O]=t.useState(""),[I,A]=t.useState(!1),[M,F]=t.useState(""),[G,ee]=t.useState(!1),[N,K]=t.useState("");t.useEffect(()=>{gt().then(E=>{v(E)}).catch(()=>v([]))},[]);const U=t.useMemo(()=>String(s.role||"")!=="MEMBER",[s]),_=t.useMemo(()=>{const E=B=>{const R=s.unitUic||"",Q=String(s.role||"");if(Q.includes("PLATOON")){const m=B.company&&B.company!=="N/A"?B.company:"",S=B.platoon&&B.platoon!=="N/A"?B.platoon:"",L=s.company&&s.company!=="N/A"?s.company:"",k=s.platoon&&s.platoon!=="N/A"?s.platoon:"";return m===L&&S===k}if(Q.includes("COMPANY")){const m=B.company&&B.company!=="N/A"?B.company:"",S=s.company&&s.company!=="N/A"?s.company:"";return m===S}return Q.includes("COMMANDER")?(B.unitUic||"")===R:!1};return i.filter(B=>B.id!==s.id&&E(B))},[i,s]),u=t.useMemo(()=>{const E=String(s.role||""),B=R=>{const Q=s.unitUic||"";if(E.includes("PLATOON")){const m=R.company&&R.company!=="N/A"?R.company:"",S=R.platoon&&R.platoon!=="N/A"?R.platoon:"",L=s.company&&s.company!=="N/A"?s.company:"",k=s.platoon&&s.platoon!=="N/A"?s.platoon:"";return m===L&&S===k}if(E.includes("COMPANY")){const m=R.company&&R.company!=="N/A"?R.company:"",S=s.company&&s.company!=="N/A"?s.company:"";return m===S}return E.includes("COMMANDER")?(R.unitUic||"")===Q:!1};return i.filter(R=>R.id!==s.id&&B(R)&&String(R.role||"")===E)},[i,s]),de=async()=>{try{A(!0),F("");const E=i.find(m=>m.id===p);if(!U||!E){A(!1);return}const B=String(s.role||""),R={...E};if(R.role=B,B.includes("PLATOON")){R.roleCompany=s.company&&s.company!=="N/A"?s.company:"N/A";const m=s.platoon&&s.platoon!=="N/A"?s.platoon:"N/A";R.rolePlatoon=m}else B.includes("COMPANY")?(R.roleCompany=s.company&&s.company!=="N/A"?s.company:"N/A",R.rolePlatoon="N/A"):B.includes("COMMANDER")&&(R.roleCompany="N/A",R.rolePlatoon="N/A");try{if(!(await He({id:R.id,email:R.email,rank:R.rank,firstName:R.firstName,lastName:R.lastName,mi:R.mi,service:R.service,role:R.role,unitUic:R.unitUic,unit:R.unit,company:R.company,isUnitAdmin:!!R.isUnitAdmin,isCommandStaff:!!R.isCommandStaff,edipi:R.edipi,passwordHash:R.passwordHash,roleCompany:R.roleCompany,rolePlatoon:R.rolePlatoon})).ok)throw new Error("persist_failed")}catch{F("Failed to persist user changes")}const Q={actorId:s.id,actorRole:s.role,targetId:R.id,grantedRole:R.role,timestamp:new Date().toISOString(),scope:{unitUic:s.unitUic||"",company:s.company,unit:s.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Q)})}catch{}v(m=>m.map(S=>S.id===R.id?R:S)),O(""),ee(!1),A(!1)}catch{A(!1),F("Operation failed")}},J=async E=>{try{A(!0),F("");const B=i.find(L=>L.id===E);if(!B){A(!1);return}const R=String(s.role||"");if(!u.some(L=>L.id===E)){A(!1),F("Target not in scope");return}const m={...B};m.role="MEMBER",m.company="N/A",m.unit="N/A",m.isCommandStaff=!1,m.roleCompany="N/A",m.rolePlatoon="N/A";try{if(!(await He({id:m.id,email:m.email,rank:m.rank,firstName:m.firstName,lastName:m.lastName,mi:m.mi,service:m.service,role:m.role,unitUic:m.unitUic,unit:m.unit,company:m.company,isUnitAdmin:!!m.isUnitAdmin,isCommandStaff:!!m.isCommandStaff,edipi:m.edipi,passwordHash:m.passwordHash,roleCompany:m.roleCompany,rolePlatoon:m.rolePlatoon})).ok)throw new Error("persist_failed")}catch{F("Failed to persist user changes")}const S={actorId:s.id,actorRole:s.role,targetId:m.id,action:"Revoked",previousRole:R,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(S)})}catch{}v(L=>L.map(k=>k.id===m.id?m:k)),K(""),A(!1)}catch{A(!1),F("Operation failed")}};return U?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:n,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:E=>E.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:n,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:p,onChange:E=>O(E.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),_.map(E=>e.jsxs("option",{value:E.id,children:[E.rank," ",E.lastName,", ",E.firstName,E.mi?` ${E.mi}`:""," • ",E.email]},E.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[u.map(E=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[E.rank," ",E.lastName,", ",E.firstName,E.mi?` ${E.mi}`:""," • ",E.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>K(E.id),children:"Remove Access"})]},E.id)),u.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),M&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:M})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!p||I,onClick:()=>ee(!0),children:"Grant Equivalent Permission"})}),G&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>ee(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:I,onClick:de,children:"Confirm"})]})]}),N&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>K(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:I,onClick:()=>J(N),children:"Remove"})]})]})]})}):null},ot="ORIGINATOR_REVIEW",_e=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],ds=s=>{const n=_e.indexOf(s||_e[0]);return n>=0&&n<_e.length-1?_e[n+1]:_e[n]||_e[0]},ct=s=>{const n=_e.indexOf(s||_e[0]);return n>0?_e[n-1]:_e[0]},ls=s=>{const n=s.activity&&s.activity.length?s.activity[s.activity.length-1]:null;return!!n&&/returned/i.test(String(n.action||""))},at=(s,n)=>{var i;return((i=s.activity)==null?void 0:i.some(v=>n.test(String(v.action||""))))||!1},ms=s=>at(s,/(approved by commander|commander.*approved)/i)&&!at(s,/installation commander/i),us=s=>at(s,/(endorsed by commander|commander.*endorsed)/i)&&!at(s,/installation commander/i);function ps(){const s=Ht(),[n,i]=t.useState(()=>{try{const r=localStorage.getItem("currentUser");return r?JSON.parse(r):null}catch(r){return console.error("Failed to parse user from localStorage:",r),null}}),[v,p]=t.useState([]),[O,I]=t.useState([]),[A,M]=t.useState({}),[F,G]=t.useState({}),[ee,N]=t.useState({}),[K,U]=t.useState({}),[_,u]=t.useState({}),[de,J]=t.useState({}),[E,B]=t.useState({}),[R,Q]=t.useState(!1),[m,S]=t.useState({}),[L,k]=t.useState({}),[H,g]=t.useState(!1),[h,W]=t.useState({}),[$,X]=t.useState(null),Y=t.useRef(null),[T,ge]=t.useState("Pending");t.useEffect(()=>{const r=z=>{$&&Y.current&&!Y.current.contains(z.target)&&(W(d=>({...d,[$]:!1})),X(null))},y=z=>{z.key==="Escape"&&$&&(W(d=>({...d,[$]:!1})),X(null))};return document.addEventListener("mousedown",r),document.addEventListener("keydown",y),()=>{document.removeEventListener("mousedown",r),document.removeEventListener("keydown",y)}},[$]),t.useEffect(()=>{Jt().then(r=>{p(r)}).catch(()=>p([]))},[]),t.useEffect(()=>{Yt().then(r=>{I(r)}).catch(()=>I([]))},[]),t.useEffect(()=>{gt().then(r=>{const y={};for(const z of r)z!=null&&z.id&&(y[z.id]=z);G(y)}).catch(()=>G({}))},[]),t.useEffect(()=>{try{const r=localStorage.getItem("unit_structure"),y={},z={};if(r){const d=JSON.parse(r);for(const x of Object.keys(d||{})){const q=d[x];q&&Array.isArray(q._sections)&&(y[x]=q._sections),q&&q._platoonSectionMap&&typeof q._platoonSectionMap=="object"&&(z[x]=q._platoonSectionMap)}}else(async()=>{try{const d=await ft();for(const x of Object.keys(d||{})){const q=d[x];q&&Array.isArray(q._sections)&&(y[x]=q._sections),q&&q._platoonSectionMap&&typeof q._platoonSectionMap=="object"&&(z[x]=q._platoonSectionMap)}}catch{}})();J(y),B(z)}catch{}},[]);const be=t.useMemo(()=>{const r=String((n==null?void 0:n.role)||"");return r.includes("PLATOON")?"PLATOON_REVIEW":r.includes("COMPANY")?"COMPANY_REVIEW":r.includes("BATTALION")?"BATTALION_REVIEW":r.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[n]),Se=r=>F[r.uploadedById]||null,f=r=>r&&r!=="N/A"?r:"",V=r=>{var x,q;const y=Se(r);if(!y)return!1;const z=String((n==null?void 0:n.role)||""),d=(n==null?void 0:n.unitUic)||"";if(z.includes("PLATOON")){const w=f(y.company),ae=f(y.platoon),Ne=f(n==null?void 0:n.roleCompany),De=f(n==null?void 0:n.rolePlatoon);return w===Ne&&ae===De&&(!d||y.unitUic===d)}if(z.includes("COMPANY")){const w=f(y.company),ae=f(n==null?void 0:n.roleCompany);return w===ae&&(!d||y.unitUic===d)}if(z.includes("BATTALION")){const w=f(n==null?void 0:n.company),ae=f(n==null?void 0:n.platoon),Ne=((q=(x=E[d])==null?void 0:x[w])==null?void 0:q[ae])||"";return r.routeSection?Ne?r.routeSection===Ne:!0:d?y.unitUic===d:!0}return z.includes("COMMANDER")&&d?y.unitUic===d:!0},ne=t.useMemo(()=>v.filter(V),[v,n,F,E]),se=t.useMemo(()=>ne.filter(r=>(r.currentStage||"PLATOON_REVIEW")===be),[ne,be]),Z=t.useMemo(()=>ne.filter(r=>(r.currentStage||"PLATOON_REVIEW")!==be),[ne,be]),xe=pt(se,{pageSize:25}),b=pt(Z,{pageSize:25}),D=r=>O.filter(y=>y.requestId===r),le=r=>`"${String(r??"").replace(/"/g,'""')}"`,me=r=>{const z=[["Request ID","Subject","Stage","Route Section","Originator","Unit UIC","Company","Unit","Created At","Due Date","Documents"]];for(const d of r){const x=Se(d),q=x?`${x.rank} ${x.lastName}, ${x.firstName}${x.mi?` ${x.mi}`:""}`:"",w=D(d.id).map(ae=>ae.name).join(" | ");z.push([d.id,d.subject,d.currentStage||"",d.routeSection||"",q,d.unitUic||"",(x==null?void 0:x.company)||"",(x==null?void 0:x.unit)||"",new Date(d.createdAt).toLocaleString(),d.dueDate?new Date(d.dueDate).toLocaleDateString():"",w])}return z.map(d=>d.map(le).join(",")).join(`\r
`)},pe=(r,y)=>{const z=new Blob([y],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(z),x=document.createElement("a");x.href=d,x.download=r,document.body.appendChild(x),x.click(),document.body.removeChild(x),URL.revokeObjectURL(d)},we=()=>pe("review_all.csv",me([...se,...Z])),he=async(r,y,z)=>{const x={actor:n?`${n.rank} ${n.lastName}, ${n.firstName}${n.mi?` ${n.mi}`:""}`:"Reviewer",timestamp:new Date().toISOString(),action:z,comment:(A[r.id]||"").trim()},q={...r,currentStage:y,routeSection:y==="BATTALION_REVIEW"&&_[r.id]?_[r.id]:r.routeSection,activity:Array.isArray(r.activity)?[...r.activity,x]:[x]};try{await Le(q),z.toLowerCase().includes("approved")?s.success("Request approved",{message:`"${r.subject}" advanced to next stage`}):z.toLowerCase().includes("return")?s.warning("Request returned",{message:`"${r.subject}" sent back for revision`}):z.toLowerCase().includes("archive")?s.info("Request archived",{message:`"${r.subject}" has been archived`}):s.success(z,{message:`Request "${r.subject}" updated`})}catch(w){s.error("Failed to update request",{message:String(w)})}p(w=>w.map(ae=>ae.id===q.id?q:ae)),M(w=>({...w,[r.id]:""}))},Ae=async r=>{const y=K[r.id]||[];if(!y.length||!(n!=null&&n.id))return;const z=Date.now(),d=y.map((ae,Ne)=>({id:`${z}-${Ne}`,name:ae.name,type:ae.type,size:ae.size,uploadedAt:new Date().toISOString(),subject:r.subject,requestId:r.id,fileUrl:URL.createObjectURL(ae)})),q={actor:n?`${n.rank} ${n.lastName}, ${n.firstName}${n.mi?` ${n.mi}`:""}`:"Reviewer",timestamp:new Date().toISOString(),action:`Reviewer added ${d.length} document(s)`,comment:(A[r.id]||"").trim()},w={...r,documentIds:[...r.documentIds||[],...d.map(ae=>ae.id)],activity:Array.isArray(r.activity)?[...r.activity,q]:[q]};try{await dt(d),await Le(w),s.success(`${d.length} file${d.length!==1?"s":""} added`,{message:`Documents added to "${r.subject}"`})}catch(ae){s.error("Failed to add files",{message:String(ae)})}I(ae=>[...ae,...d]),p(ae=>ae.map(Ne=>Ne.id===w.id?w:Ne)),U(ae=>({...ae,[r.id]:[]})),M(ae=>({...ae,[r.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((n==null?void 0:n.role)||"MEMBER")}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:we,children:"Export All"})]})]}),n&&String(n.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>Q(!0),children:"Manage Permissions"})})]}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>ge("Pending"),className:`${T==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>ge("In Scope"),className:`${T==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[T==="Pending"&&e.jsx(Ge,{title:"Pending",requests:xe.currentData,users:F,onRowClick:r=>S(y=>({...y,[r.id]:!y[r.id]})),expandedRows:m,platoonSectionMap:E,children:r=>e.jsxs("div",{id:`details-rev-${r.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!h[r.id],"aria-controls":`docs-rev-${r.id}`,onClick:()=>{W(y=>({...y,[r.id]:!y[r.id]})),X(y=>h[r.id]?null:r.id)},onKeyDown:y=>{(y.key==="Enter"||y.key===" ")&&(y.preventDefault(),W(z=>({...z,[r.id]:!z[r.id]})),X(z=>h[r.id]?null:r.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${h[r.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-rev-${r.id}`,ref:h[r.id]?Y:void 0,className:`${h[r.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[D(r.id).map(y=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:y.name}),e.jsx("div",{children:new Date(y.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:y.fileUrl?e.jsx("a",{href:y.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},y.id)),D(r.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>N(y=>({...y,[r.id]:!y[r.id]})),"aria-expanded":!!ee[r.id],"aria-controls":`logs-${r.id}`,children:[ee[r.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${r.id}`,className:ee[r.id]?"mt-2 space-y-2":"hidden",children:r.activity&&r.activity.length?r.activity.map((y,z)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[y.actor," • ",new Date(y.timestamp).toLocaleString()," • ",y.action]}),y.comment&&e.jsx("div",{className:"text-gray-600",children:y.comment})]},z)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:A[r.id]||"",onChange:y=>M(z=>({...z,[r.id]:y.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:y=>U(z=>({...z,[r.id]:y.target.files?Array.from(y.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(K[r.id]||[]).length?`${(K[r.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>Ae(r),disabled:!K[r.id]||!(K[r.id]||[]).length,children:"Save Files"}),ls(r)&&e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>he(r,r.currentStage==="PLATOON_REVIEW"?ot:ct(r.currentStage),"Returned to previous stage"),children:"Return to Previous"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>he(r,"ARCHIVED","Archived by Reviewer"),children:"Archive"})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[String((n==null?void 0:n.role)||"").includes("COMPANY")&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:_[r.id]||"",onChange:y=>u(z=>({...z,[r.id]:y.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(de[(n==null?void 0:n.unitUic)||""]||[]).map(y=>e.jsx("option",{value:y,children:y},y))]})]}),(()=>{const y=ms(r),z=us(r);return y||z?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>he(r,r.currentStage==="PLATOON_REVIEW"?ot:ct(r.currentStage),"Returned to previous stage"),children:"Return to Previous"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>he(r,"ARCHIVED","Archived by Reviewer"),children:"Archive"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(String((n==null?void 0:n.role)||"").includes("COMPANY")){if(!_[r.id])return;he(r,"BATTALION_REVIEW",`Approved and routed to ${_[r.id]}`)}else he(r,ds(r.currentStage),"Approved")},disabled:String((n==null?void 0:n.role)||"").includes("COMPANY")&&!_[r.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>he(r,r.currentStage==="PLATOON_REVIEW"?ot:ct(r.currentStage),r.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),T==="In Scope"&&e.jsx(Ge,{title:"In Scope",requests:b.currentData,users:F,onRowClick:r=>S(y=>({...y,[r.id]:!y[r.id]})),expandedRows:m,platoonSectionMap:E,children:r=>e.jsxs("div",{id:`details-rev-${r.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!h[r.id],"aria-controls":`docs-rev-${r.id}`,onClick:()=>{W(y=>({...y,[r.id]:!y[r.id]})),X(y=>h[r.id]?null:r.id)},onKeyDown:y=>{(y.key==="Enter"||y.key===" ")&&(y.preventDefault(),W(z=>({...z,[r.id]:!z[r.id]})),X(z=>h[r.id]?null:r.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${h[r.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-rev-${r.id}`,ref:h[r.id]?Y:void 0,className:`${h[r.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[D(r.id).map(y=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:y.name}),e.jsx("div",{children:new Date(y.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:y.fileUrl?e.jsx("a",{href:y.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},y.id)),D(r.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>N(y=>({...y,[r.id]:!y[r.id]})),"aria-expanded":!!ee[r.id],"aria-controls":`logs-${r.id}`,children:[ee[r.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${r.id}`,className:ee[r.id]?"mt-2 space-y-2":"hidden",children:r.activity&&r.activity.length?r.activity.map((y,z)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[y.actor," • ",new Date(y.timestamp).toLocaleString()," • ",y.action]}),y.comment&&e.jsx("div",{className:"text-gray-600",children:y.comment})]},z)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),R&&n&&e.jsx(cs,{currentUser:n,onClose:()=>Q(!1)})]})}const Ot="MM",$t="Manpower Management",_t="MMEA",Lt="Enlisted Personnel Assignments (General oversight)",xs={division_code:Ot,division_name:$t,branch:_t,description:Lt},hs=Object.freeze(Object.defineProperty({__proto__:null,branch:_t,default:xs,description:Lt,division_code:Ot,division_name:$t},Symbol.toStringTag,{value:"Module"}));async function gs(){try{const s=Object.assign({"../hqmc-structure/MM__manpower-management__mmea.json":hs}),n=[];for(const i of Object.values(s)){const v=(i==null?void 0:i.default)??i;if(v&&typeof v=="object"){const p=String(v.division_code||""),O=String(v.division_name||""),I=String(v.branch||""),A=v.description?String(v.description):void 0;p&&I&&n.push({division_code:p,division_name:O,branch:I,description:A})}}return n}catch{return[]}}function bs(){var L;const[s,n]=t.useState(null),[i,v]=t.useState([]),[p,O]=t.useState([]),[I,A]=t.useState(""),[M,F]=t.useState(""),[G,ee]=t.useState([]),[N,K]=t.useState(null),[U,_]=t.useState("structure"),[u,de]=t.useState({}),[J,E]=t.useState({}),[B,R]=t.useState({});t.useEffect(()=>{try{const k=localStorage.getItem("currentUser");k&&n(JSON.parse(k))}catch{}kt().then(k=>{try{v(k.map(H=>({code:String(H.code||""),name:String(H.name||"")})))}catch{v([])}}),gs().then(k=>{O(k)}),Qe().then(k=>ee(k)).catch(()=>ee([])),bt().then(k=>{const H={};for(const g of k){const h=`${g.division_code}::${g.branch}`;H[h]={reviewers:g.reviewers||[],approvers:g.approvers||[]}}de(H)})},[]);const Q=(s==null?void 0:s.hqmcDivision)||((L=i[0])==null?void 0:L.code)||"",m=t.useMemo(()=>i.find(k=>k.code===Q),[i,Q]),S=t.useMemo(()=>p.filter(k=>String(k.division_code||"")===Q),[p,Q]);return t.useMemo(()=>G.filter(k=>!!k.isHqmcAdmin&&String(k.hqmcDivision||"")===Q),[G,Q]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(s!=null&&s.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(s==null?void 0:s.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",m?`${m.code} — ${m.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>_("structure"),className:`${U==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>_("permissions"),className:`${U==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),U==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"})]})}),e.jsxs("tbody",{children:[S.map(k=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:k.branch}),e.jsx("td",{className:"py-2 px-3",children:k.description||""})]},k.branch)),S.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(s==null?void 0:s.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:I,onChange:k=>A(k.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:M,onChange:k=>F(k.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!I.trim(),onClick:async()=>{var k;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:Q,division_name:((k=i.find(g=>g.code===Q))==null?void 0:k.name)||"",branch:I.trim(),description:M.trim()})});const H=await fetch("/api/hqmc-structure").then(g=>g.json());O(H),A(""),F("")}catch{}},children:"Add"})]})]})]}),U==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const k of S){const H=`${Q}::${k.branch}`,g=u[H]||{reviewers:[],approvers:[]};await It({division_code:Q,branch:k.branch,reviewers:g.reviewers,approvers:g.approvers})}K({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:S.map(k=>{const H=`${Q}::${k.branch}`,g=u[H]||{reviewers:[],approvers:[]},h=W=>`${W.rank||""} ${W.lastName||""}, ${W.firstName||""}${W.mi?" "+W.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:k.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:J[H]||"",onChange:W=>E($=>({...$,[H]:W.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!J[H],onClick:async()=>{const W=(J[H]||"").trim();if(!W)return;const{user:$}=await lt(W);if(!($!=null&&$.id)){K({type:"error",message:`No user found for EDIPI ${W}`});return}de(X=>({...X,[H]:{...g,reviewers:Array.from(new Set([...g.reviewers||[],$.id]))}})),E(X=>({...X,[H]:""})),K({type:"success",message:`Added reviewer ${$.lastName||""}, ${$.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(g.reviewers||[]).map(W=>{const $=G.find(X=>X.id===W);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:$?h($):W}),e.jsx("button",{className:"text-red-600",onClick:()=>de(X=>({...X,[H]:{...g,reviewers:(g.reviewers||[]).filter(Y=>Y!==W)}})),children:"✕"})]},W)}),(g.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:B[H]||"",onChange:W=>R($=>({...$,[H]:W.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!B[H],onClick:async()=>{const W=(B[H]||"").trim();if(!W)return;const{user:$}=await lt(W);if(!($!=null&&$.id)){K({type:"error",message:`No user found for EDIPI ${W}`});return}de(X=>({...X,[H]:{...g,approvers:Array.from(new Set([...g.approvers||[],$.id]))}})),R(X=>({...X,[H]:""})),K({type:"success",message:`Added approver ${$.lastName||""}, ${$.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(g.approvers||[]).map(W=>{const $=G.find(X=>X.id===W);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:$?h($):W}),e.jsx("button",{className:"text-red-600",onClick:()=>de(X=>({...X,[H]:{...g,approvers:(g.approvers||[]).filter(Y=>Y!==W)}})),children:"✕"})]},W)}),(g.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},H)})})]})})]}),N&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${N.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:N.message})]})}const Ze=(s,n)=>`${s}::${n}`;function fs({currentUser:s,divisionCode:n,branches:i,assignments:v,onClose:p}){const[O,I]=t.useState([]),[A,M]=t.useState(""),[F,G]=t.useState(""),[ee,N]=t.useState("reviewer"),[K,U]=t.useState(!1);t.useEffect(()=>{gt().then(m=>I(m)).catch(()=>I([]))},[]);const _=t.useMemo(()=>{const m={};for(const S of v)m[Ze(S.division_code,S.branch)]={reviewers:S.reviewers||[],approvers:S.approvers||[]};return m},[v]),u=String(s.id||""),de=t.useMemo(()=>{if(!A)return!1;const m=_[Ze(n,A)]||{reviewers:[],approvers:[]};return(m.reviewers||[]).includes(u)||(m.approvers||[]).includes(u)||!!s.isHqmcAdmin},[A,_,u,s]),J=t.useMemo(()=>O.filter(m=>String(m.hqmcDivision||"")===String(n||"")&&String(m.id||"")!==u),[O,n,u]),E=t.useMemo(()=>{if(!A)return[];const m=_[Ze(n,A)]||{reviewers:[],approvers:[]};return Array.from(new Set([...m.reviewers||[],...m.approvers||[]])).map(L=>J.find(k=>k.id===L)).filter(Boolean)},[A,_,J,n]),B=async m=>{U(!0);try{await It({division_code:n,branch:A,reviewers:m.reviewers,approvers:m.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:s.id,scope:{hqmcDivision:n,branch:A},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{U(!1)}},R=async()=>{if(!de||!A||!F)return;const m=_[Ze(n,A)]||{reviewers:[],approvers:[]},S={reviewers:Array.from(new Set(m.reviewers||[])),approvers:Array.from(new Set(m.approvers||[]))};ee==="reviewer"?S.reviewers=Array.from(new Set([...S.reviewers,F])):S.approvers=Array.from(new Set([...S.approvers,F])),await B(S),G("")},Q=async m=>{if(!de||!A)return;const S=_[Ze(n,A)]||{reviewers:[],approvers:[]},L={reviewers:(S.reviewers||[]).filter(k=>k!==m),approvers:(S.approvers||[]).filter(k=>k!==m)};await B(L)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:p,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:p,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:A,onChange:m=>M(m.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),i.map(m=>e.jsx("option",{value:m,children:m},m))]})]}),A&&!de&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),A&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:F,onChange:m=>G(m.target.value),disabled:!de,children:[e.jsx("option",{value:"",children:"Choose user"}),J.map(m=>e.jsxs("option",{value:m.id,children:[m.rank," ",m.lastName,", ",m.firstName,m.mi?` ${m.mi}`:""," • ",m.email]},m.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:ee,onChange:m=>N(m.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!de||!F||K,onClick:R,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[E.map(m=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[m.rank," ",m.lastName,", ",m.firstName,m.mi?` ${m.mi}`:""," • ",m.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!de||K,onClick:()=>Q(m.id),children:"Remove"})]},m.id)),E.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}const et=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],ys=s=>{const n=et.indexOf(s||et[0]);return n>0?et[n-1]:et[0]};function vs(){const[s,n]=t.useState(()=>{try{const b=localStorage.getItem("currentUser");return b?JSON.parse(b):null}catch{return null}}),[i,v]=t.useState([]),[p,O]=t.useState([]),[I,A]=t.useState({}),[M,F]=t.useState({}),[G,ee]=t.useState({}),[N,K]=t.useState({}),[U,_]=t.useState(null),u=t.useRef(null),[de,J]=t.useState([]),[E,B]=t.useState("Pending"),[R,Q]=t.useState([]),[m,S]=t.useState({}),[L,k]=t.useState(!1);t.useEffect(()=>{const b=le=>{U&&u.current&&!u.current.contains(le.target)&&(K(me=>({...me,[U]:!1})),_(null))},D=le=>{le.key==="Escape"&&U&&(K(me=>({...me,[U]:!1})),_(null))};return document.addEventListener("mousedown",b),document.addEventListener("keydown",D),()=>{document.removeEventListener("mousedown",b),document.removeEventListener("keydown",D)}},[U]),t.useEffect(()=>{nt().then(b=>v(b)).catch(()=>v([]))},[]),t.useEffect(()=>{ht().then(b=>O(b)).catch(()=>O([]))},[]),t.useEffect(()=>{Qe().then(b=>{const D={};for(const le of b)le!=null&&le.id&&(D[le.id]=le);F(D)}).catch(()=>F({}))},[]),t.useEffect(()=>{bt().then(J).catch(()=>J([]))},[]),t.useEffect(()=>{Kt().then(Q).catch(()=>Q([]))},[]);const H=(s==null?void 0:s.id)||"",g=String((s==null?void 0:s.hqmcDivision)||""),h=t.useMemo(()=>de.filter(b=>b.division_code===g&&((b.reviewers||[]).includes(H)||(b.approvers||[]).includes(H))).map(b=>b.branch),[de,g,H]),W=b=>M[b.uploadedById]||null,$=b=>{if(!g||!H)return!1;const D=String(b.routeSection||"");return h.includes(D)},X=t.useMemo(()=>i.filter($),[i,h]),Y=t.useMemo(()=>X.filter(b=>(b.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[X]),T=t.useMemo(()=>X.filter(b=>(b.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[X]),ge=b=>p.filter(D=>D.requestId===b),be=b=>`"${String(b??"").replace(/"/g,'""')}"`,Se=b=>{const le=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const me of b){const pe=W(me),we=pe?`${pe.rank} ${pe.lastName}, ${pe.firstName}${pe.mi?` ${pe.mi}`:""}`:"",he=ge(me.id).map(Ae=>Ae.name).join(" | ");le.push([me.id,me.subject,me.currentStage||"",me.routeSection||"",we,me.unitUic||"",new Date(me.createdAt).toLocaleString(),he])}return le.map(me=>me.map(be).join(",")).join(`\r
`)},f=(b,D)=>{const le=new Blob([D],{type:"text/csv;charset=utf-8;"}),me=URL.createObjectURL(le),pe=document.createElement("a");pe.href=me,pe.download=b,document.body.appendChild(pe),pe.click(),document.body.removeChild(pe),URL.revokeObjectURL(me)},V=()=>f("hqmc_pending.csv",Se(Y)),ne=()=>f("hqmc_in_scope.csv",Se(T)),se=()=>f("hqmc_all.csv",Se([...Y,...T])),Z=async b=>{const D=s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Reviewer",le=String(m[b.id]||"").trim();if(!le){alert("Select an HQMC section to route to approver");return}const me={actor:D,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${le}`,comment:(I[b.id]||"").trim()},pe={...b,routeSection:le,activity:Array.isArray(b.activity)?[...b.activity,me]:[me]};try{await Le(pe)}catch{}v(we=>we.map(he=>he.id===pe.id?pe:he)),A(we=>({...we,[b.id]:""}))},xe=async b=>{const le={actor:s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC",comment:(I[b.id]||"").trim()},me={...b,currentStage:ys(b.currentStage),activity:Array.isArray(b.activity)?[...b.activity,le]:[le]};try{await Le(me)}catch{}v(pe=>pe.map(we=>we.id===me.id?me:we)),A(pe=>({...pe,[b.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:g||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:se,children:"Export All"}),h.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>k(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>B("Pending"),className:`${E==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>B("In Scope"),className:`${E==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[E==="Pending"&&e.jsx(Ge,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:V,children:"Export Pending"}),requests:Y,users:M,onRowClick:b=>ee(D=>({...D,[b.id]:!D[b.id]})),expandedRows:G,children:b=>e.jsxs("div",{id:`details-hq-${b.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!N[b.id],"aria-controls":`docs-hq-${b.id}`,onClick:()=>{K(D=>({...D,[b.id]:!D[b.id]})),_(D=>N[b.id]?null:b.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${N[b.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-hq-${b.id}`,ref:N[b.id]?u:void 0,className:`${N[b.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[ge(b.id).map(D=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:D.name}),e.jsx("div",{children:new Date(D.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:D.fileUrl?e.jsx("a",{href:D.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},D.id)),ge(b.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:I[b.id]||"",onChange:D=>A(le=>({...le,[b.id]:D.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:m[b.id]||"",onChange:D=>S(le=>({...le,[b.id]:D.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),R.filter(D=>String(D.division_code||"")===g).map(D=>e.jsx("option",{value:D.branch,children:D.branch},D.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Z(b),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>xe(b),children:"Return"})]})]})]})}),E==="In Scope"&&e.jsx(Ge,{title:"In Scope",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ne,children:"Export In Scope"}),requests:T,users:M,onRowClick:b=>ee(D=>({...D,[b.id]:!D[b.id]})),expandedRows:G,children:b=>e.jsxs("div",{id:`details-hq-${b.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!N[b.id],"aria-controls":`docs-hq-${b.id}`,onClick:()=>{K(D=>({...D,[b.id]:!D[b.id]})),_(D=>N[b.id]?null:b.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${N[b.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-hq-${b.id}`,ref:N[b.id]?u:void 0,className:`${N[b.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[ge(b.id).map(D=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:D.name}),e.jsx("div",{children:new Date(D.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:D.fileUrl?e.jsx("a",{href:D.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},D.id)),ge(b.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})]})})]})]}),L&&s&&e.jsx(fs,{currentUser:s,divisionCode:g,branches:R.filter(b=>String(b.division_code||"")===g).map(b=>b.branch),assignments:de,onClose:()=>k(!1)})]})}const tt=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Ns=s=>{const n=tt.indexOf(s||tt[0]);return n>0?tt[n-1]:tt[0]};function js(){const[s,n]=t.useState(()=>{try{const f=localStorage.getItem("currentUser");return f?JSON.parse(f):null}catch{return null}}),[i,v]=t.useState([]),[p,O]=t.useState([]),[I,A]=t.useState({}),[M,F]=t.useState({}),[G,ee]=t.useState({}),[N,K]=t.useState({}),[U,_]=t.useState(null),u=t.useRef(null),[de,J]=t.useState([]),[E,B]=t.useState("Pending");t.useEffect(()=>{const f=ne=>{U&&u.current&&!u.current.contains(ne.target)&&(K(se=>({...se,[U]:!1})),_(null))},V=ne=>{ne.key==="Escape"&&U&&(K(se=>({...se,[U]:!1})),_(null))};return document.addEventListener("mousedown",f),document.addEventListener("keydown",V),()=>{document.removeEventListener("mousedown",f),document.removeEventListener("keydown",V)}},[U]),t.useEffect(()=>{nt().then(f=>v(f)).catch(()=>v([]))},[]),t.useEffect(()=>{ht().then(f=>O(f)).catch(()=>O([]))},[]),t.useEffect(()=>{Qe().then(f=>{const V={};for(const ne of f)ne!=null&&ne.id&&(V[ne.id]=ne);F(V)}).catch(()=>F({}))},[]),t.useEffect(()=>{bt().then(J).catch(()=>J([]))},[]);const R=(s==null?void 0:s.id)||"",Q=String((s==null?void 0:s.hqmcDivision)||""),m=t.useMemo(()=>de.filter(f=>f.division_code===Q&&(f.approvers||[]).includes(R)).map(f=>f.branch),[de,Q,R]),S=f=>M[f.uploadedById]||null,L=f=>{if(!Q||!R)return!1;const V=String(f.routeSection||"");return m.includes(V)},k=t.useMemo(()=>i.filter(L),[i,m]),H=t.useMemo(()=>k.filter(f=>(f.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[k]),g=t.useMemo(()=>k.filter(f=>(f.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[k]),h=f=>p.filter(V=>V.requestId===f),W=f=>`"${String(f??"").replace(/"/g,'""')}"`,$=f=>{const ne=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const se of f){const Z=S(se),xe=Z?`${Z.rank} ${Z.lastName}, ${Z.firstName}${Z.mi?` ${Z.mi}`:""}`:"",b=h(se.id).map(D=>D.name).join(" | ");ne.push([se.id,se.subject,se.currentStage||"",se.routeSection||"",xe,se.unitUic||"",new Date(se.createdAt).toLocaleString(),b])}return ne.map(se=>se.map(W).join(",")).join(`\r
`)},X=(f,V)=>{const ne=new Blob([V],{type:"text/csv;charset=utf-8;"}),se=URL.createObjectURL(ne),Z=document.createElement("a");Z.href=se,Z.download=f,document.body.appendChild(Z),Z.click(),document.body.removeChild(Z),URL.revokeObjectURL(se)},Y=()=>X("hqmc_approver_pending.csv",$(H)),T=()=>X("hqmc_approver_approved.csv",$(g)),ge=()=>X("hqmc_approver_all.csv",$([...H,...g])),be=async f=>{const ne={actor:s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved",comment:(I[f.id]||"").trim()},se={...f,currentStage:"ARCHIVED",activity:Array.isArray(f.activity)?[...f.activity,ne]:[ne]};try{await Le(se)}catch{}v(Z=>Z.map(xe=>xe.id===se.id?se:xe)),A(Z=>({...Z,[f.id]:""}))},Se=async f=>{const ne={actor:s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver",comment:(I[f.id]||"").trim()},se={...f,currentStage:Ns(f.currentStage),activity:Array.isArray(f.activity)?[...f.activity,ne]:[ne]};try{await Le(se)}catch{}v(Z=>Z.map(xe=>xe.id===se.id?se:xe)),A(Z=>({...Z,[f.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((s==null?void 0:s.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ge,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>B("Pending"),className:`${E==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>B("Approved"),className:`${E==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"})]})}),e.jsxs("div",{className:"mt-4",children:[E==="Pending"&&e.jsx(Ge,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Y,children:"Export Pending"}),requests:H,users:M,onRowClick:f=>ee(V=>({...V,[f.id]:!V[f.id]})),expandedRows:G,children:f=>e.jsxs("div",{id:`details-hqa-${f.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!N[f.id],"aria-controls":`docs-hqa-${f.id}`,onClick:()=>{K(V=>({...V,[f.id]:!V[f.id]})),_(V=>N[f.id]?null:f.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${N[f.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-hqa-${f.id}`,ref:N[f.id]?u:void 0,className:`${N[f.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[h(f.id).map(V=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:V.name}),e.jsx("div",{children:new Date(V.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:V.fileUrl?e.jsx("a",{href:V.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},V.id)),h(f.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:I[f.id]||"",onChange:V=>A(ne=>({...ne,[f.id]:V.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>be(f),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>Se(f),children:"Return"})]})]})}),E==="Approved"&&e.jsx(Ge,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:T,children:"Export Approved"}),requests:g,users:M,onRowClick:f=>ee(V=>({...V,[f.id]:!V[f.id]})),expandedRows:G,children:f=>e.jsxs("div",{id:`details-hqa-${f.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!N[f.id],"aria-controls":`docs-hqa-${f.id}`,onClick:()=>{K(V=>({...V,[f.id]:!V[f.id]})),_(V=>N[f.id]?null:f.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${N[f.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-hqa-${f.id}`,ref:N[f.id]?u:void 0,className:`${N[f.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[h(f.id).map(V=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:V.name}),e.jsx("div",{children:new Date(V.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:V.fileUrl?e.jsx("a",{href:V.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},V.id)),h(f.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})]})})]})]})})}const Ss=({onUnitSelect:s,selectedUnit:n})=>{const[i,v]=t.useState(""),[p,O]=t.useState(!1),I=qe.filter(M=>M.unitName.toLowerCase().startsWith(i.toLowerCase())||M.uic.toLowerCase().startsWith(i.toLowerCase())||M.ruc.toLowerCase().startsWith(i.toLowerCase())),A=M=>{s(M),O(!1),v("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>O(!p),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[n?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:n.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",n.uic," | RUC: ",n.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),p&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:i,onChange:M=>v(M.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:I.map(M=>e.jsxs("button",{type:"button",onClick:()=>A(M),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:M.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",M.uic," | RUC: ",M.ruc," | MCC: ",M.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[M.streetAddress,", ",M.cityState," ",M.zip]})]},M.uic))})]})]})]})},xt=async s=>{const i=new TextEncoder().encode(s),v=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(v)).map(p=>p.toString(16).padStart(2,"0")).join("")};async function ws(s,n){const i=Xt();return i!=null&&i.auth?await i.auth.signUp({email:s,password:n}):{data:null,error:new Error("supabase_not_initialized")}}const wt={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},Cs=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],qt=({onSaved:s,initial:n={},mode:i="create",readOnly:v=!1,canEditRole:p=!1,canEditAdmin:O=!1})=>{const[I,A]=t.useState(""),[M,F]=t.useState(""),[G,ee]=t.useState(""),[N,K]=t.useState(n.email||""),[U,_]=t.useState(n.edipi||""),[u,de]=t.useState(n.service||""),[J,E]=t.useState(n.rank||""),[B,R]=t.useState(n.role||"MEMBER"),[Q,m]=t.useState(!!n.isUnitAdmin),[S,L]=t.useState(n.company||""),[k,H]=t.useState(n.platoon||""),[g,h]=t.useState(void 0),[W,$]=t.useState(null),[X,Y]=t.useState({}),[T,ge]=t.useState(""),[be,Se]=t.useState(""),[f,V]=t.useState([]),[ne,se]=t.useState(!1),[Z,xe]=t.useState(n.roleCompany||""),[b,D]=t.useState(n.rolePlatoon||""),[le,me]=t.useState(!1),[pe,we]=t.useState([]),[he,Ae]=t.useState([]),[r,y]=t.useState([]),[z,d]=t.useState([]);t.useEffect(()=>{if(n.firstName&&A(String(n.firstName)),n.lastName&&F(String(n.lastName)),n.mi&&ee(String(n.mi)),n.company&&L(String(n.company)),n.platoon&&H(String(n.platoon)),n.roleCompany&&xe(String(n.roleCompany)),n.rolePlatoon&&D(String(n.rolePlatoon)),n.unitUic){const l=qe.find(o=>o.uic===n.unitUic);l&&h(l)}},[n]);const x=t.useMemo(()=>wt[u]||[],[u]),q=t.useMemo(()=>{if(!g)return[];const l=pe;if(l&&l.length)return l;const o=X[g.uic]||{};return Object.keys(o).filter(j=>!j.startsWith("_")&&Array.isArray(o[j]))},[g,X,pe]),w=t.useMemo(()=>{var l;return g&&S?((l=X[g.uic])==null?void 0:l[S])||[]:[]},[g,S,X]),ae=t.useMemo(()=>{if(!g||!S)return[];const l=he;return l&&l.length?l:w},[g,S,he,w]),Ne=t.useMemo(()=>{if(!g)return[];const l=r;if(l&&l.length)return l;const o=X[g.uic]||{};return Object.keys(o).filter(j=>!j.startsWith("_")&&Array.isArray(o[j]))},[g,X,r]),De=t.useMemo(()=>{var l;return g&&Z?((l=X[g.uic])==null?void 0:l[Z])||[]:[]},[g,Z,X]),We=t.useMemo(()=>{if(!g||!Z)return[];const l=z;return l&&l.length?l:De},[g,Z,z,De]),Pe=t.useMemo(()=>{const l=q.slice(),o=S||n.company||n.user_company||"";return o&&!l.includes(o)?[o,...l]:l},[q,S,n]),Oe=t.useMemo(()=>{const l=ae.slice(),o=k||n.platoon||n.user_platoon||"";return o&&!l.includes(o)?[o,...l]:l},[ae,k,n]),Te=t.useMemo(()=>{const l=Ne.slice(),o=Z||n.roleCompany||"",j=o&&!l.includes(o)?[o,...l]:l;return Array.from(new Set(j))},[Ne,Z,n]),Be=t.useMemo(()=>{const l=We.slice(),o=b||n.rolePlatoon||"";return o&&!l.includes(o)?[o,...l]:l},[We,b,n]);t.useEffect(()=>{(async()=>{try{if(i==="edit"&&n.id){const l=await Rt(String(n.id));l&&(l.company&&!S&&L(String(l.company)),l.platoon&&!k&&H(String(l.platoon)),l.roleCompany&&!Z&&xe(String(l.roleCompany)),l.rolePlatoon&&!b&&D(String(l.rolePlatoon)))}}catch{}})()},[i,n.id]),t.useEffect(()=>{x.includes(J)||E("")},[x]),t.useEffect(()=>{H("")},[S]),t.useEffect(()=>{D("")},[Z]),t.useEffect(()=>{try{const l=localStorage.getItem("unit_structure");l&&Y(JSON.parse(l))}catch{}},[g]),t.useEffect(()=>{const l=(g==null?void 0:g.uic)||"";if(!l){we([]),y([]);return}Mt(l).then(o=>{we(o||[]),y(o||[])}).catch(()=>{we([]),y([])})},[g]),t.useEffect(()=>{const l=(g==null?void 0:g.uic)||"",o=S||"";if(!l||!o){Ae([]);return}mt(l,o).then(j=>Ae(j||[])).catch(()=>Ae([]))},[g,S]),t.useEffect(()=>{const l=(g==null?void 0:g.uic)||"",o=Z||"";if(!l||!o){d([]);return}mt(l,o).then(j=>d(j||[])).catch(()=>d([]))},[g,Z]),t.useEffect(()=>{Qe().then(l=>{V(l)}).catch(()=>V([]))},[]),t.useEffect(()=>{const l=(g==null?void 0:g.uic)||"";if(!l){se(!1);return}const o=f.some(j=>!!j.isUnitAdmin&&(j.unitUic||"")===l);se(o)},[g,f]),t.useEffect(()=>{if(g){!S&&n.company&&Pe.includes(n.company)&&L(String(n.company));const l=n.platoon;!k&&l&&Oe.includes(l)&&H(String(l))}},[g,Pe,Oe,S,k,n]);const Ue=l=>/^[0-9]{10}$/.test(l),Je=(l,o)=>{try{return f.some(j=>String(j.edipi)===String(l)&&String(j.id)!==String(o||""))}catch{return!1}},Ce=async l=>{var oe,ie;if(l.preventDefault(),$(null),v)return;if(!I.trim())return $({type:"error",message:"First name is required."});if(!M.trim())return $({type:"error",message:"Last name is required."});if(G&&!/^[A-Za-z]$/.test(G))return $({type:"error",message:"MI must be a single letter."});if(!N.trim())return $({type:"error",message:"Email is required."});if(!Ue(String(U)))return $({type:"error",message:"EDIPI must be 10 digits."});if(!u)return $({type:"error",message:"Service is required."});if(!J)return $({type:"error",message:"Rank is required."});if(Je(String(U),n.id?String(n.id):void 0))return $({type:"error",message:"EDIPI already exists."});if(B==="COMPANY_REVIEWER"&&!Z)return $({type:"error",message:"Role Company is required for Company Reviewer."});if(B==="PLATOON_REVIEWER"&&(!Z||!b))return $({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${I.trim()}`,G&&""+G.trim().toUpperCase(),`${M.trim()}`;let o=n.id?String(n.id):`usr-${Date.now()}`,j=n.passwordHash||"";if(i==="create"){if(!T||T.length<8)return $({type:"error",message:"Password must be at least 8 characters."});if(T!==be)return $({type:"error",message:"Passwords do not match."});try{const{data:te,error:ve}=await ws(N.trim(),T);if(ve){$({type:"error",message:`Failed to create auth user: ${String(ve.message||ve)}`});return}const ue=(oe=te==null?void 0:te.user)!=null&&oe.id?String(te.user.id):"";if(!ue){$({type:"error",message:"Auth user ID missing after sign up."});return}o=ue}catch(te){$({type:"error",message:`Failed to create auth user: ${String((te==null?void 0:te.message)||te)}`});return}j=await xt(T)}else if(i==="edit"&&T){if(T.length<8)return $({type:"error",message:"Password must be at least 8 characters."});if(T!==be)return $({type:"error",message:"Passwords do not match."});j=await xt(T)}const P={id:o,firstName:I.trim(),lastName:M.trim(),mi:G?G.trim().toUpperCase():void 0,email:N.trim(),edipi:U,service:u,rank:J,role:B,company:S||"N/A",unit:(g==null?void 0:g.unitName)||"N/A",unitUic:g==null?void 0:g.uic,passwordHash:j,isUnitAdmin:i==="create"&&g&&!ne?!0:Q,roleCompany:Z||void 0,rolePlatoon:b||void 0,platoon:k||"N/A"};try{const te=await He({id:P.id,email:P.email,rank:P.rank,firstName:P.firstName,lastName:P.lastName,mi:P.mi,service:P.service,role:P.role,unitUic:P.unitUic,unit:(g==null?void 0:g.unitName)||"N/A",company:P.company,isUnitAdmin:!!P.isUnitAdmin,edipi:String(P.edipi),passwordHash:j,platoon:k||"N/A",roleCompany:Z||void 0,rolePlatoon:b||void 0});if(!te.ok){$({type:"error",message:`Failed to save profile: ${String(((ie=te==null?void 0:te.error)==null?void 0:ie.message)||(te==null?void 0:te.error)||"unknown")}`});return}$({type:"success",message:n.id?"Profile updated.":g&&!ne?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),s==null||s(P)}catch{$({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:i==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:Ce,className:"space-y-6",children:[i==="create"&&g&&!ne&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:g.unitName})," (UIC ",g.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:M,onChange:l=>F(l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:I,onChange:l=>A(l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:G,maxLength:1,onChange:l=>ee(l.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:N,onChange:l=>K(l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:U,onChange:l=>_(l.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:u,onChange:l=>de(l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(wt).map(l=>e.jsx("option",{value:l,children:l},l))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:J,onChange:l=>E(l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),x.map(l=>e.jsx("option",{value:l,children:l},l))]})]}),i==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:T,onChange:l=>ge(l.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:be,onChange:l=>Se(l.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v})]})]}):e.jsx(e.Fragment,{})]})]}),le&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:T,onChange:l=>ge(l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:be,onChange:l=>Se(l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:v})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>me(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>me(!1),children:"Save"})]})]})}),i==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:B,onChange:l=>R(l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:Cs.map(l=>e.jsx("option",{value:l,children:l},l))})}),e.jsx("div",{children:e.jsxs("select",{value:Z||String(n.roleCompany||""),onChange:l=>xe(l.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Te.length?"Select company":"No companies configured"}),Te.map(l=>e.jsx("option",{value:l,children:l},l))]})}),e.jsx("div",{children:e.jsxs("select",{value:b||String(n.rolePlatoon||""),onChange:l=>D(l.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Be.length?"Select platoon":"No platoons configured"}),Be.map(l=>e.jsx("option",{value:l,children:l},l))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:Q,onChange:l=>m(l.target.checked),disabled:v||!O}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(n==null?void 0:n.isCommandStaff)||B==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Command Sections Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(Ss,{onUnitSelect:l=>h(l),selectedUnit:g})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:S||String(n.company||""),onChange:l=>L(l.target.value),disabled:v||!g||Pe.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Pe.length?"Select company":"No companies configured"}),Pe.map(l=>e.jsx("option",{value:l,children:l},l))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:k||String(n.platoon||""),onChange:l=>H(l.target.value),disabled:v||!g||!S||Oe.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Oe.length?"Select platoon":"No platoons configured"}),Oe.map(l=>e.jsx("option",{value:l,children:l},l))]})]})]})})]}),W&&e.jsx("div",{className:`p-3 rounded-lg border ${W.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:W.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[i==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>me(!0),disabled:v,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:v,children:i==="edit"?"Save":"Create Profile"})]})]})]})},As=t.memo(function({user:n,onClose:i}){const v=()=>{const p=qe.find(I=>I.uic===n.unitUic),O=p?p.unitName:n.unit;if(n.isUnitAdmin||n.role==="COMMANDER")return O||"—";if(n.role==="COMPANY_REVIEWER")return n.company&&n.company!=="N/A"?n.company:"—";if(n.role==="PLATOON_REVIEWER"){const I=n.company&&n.company!=="N/A"?n.company:"",A=n.platoon&&n.platoon!=="N/A"?n.platoon:"",M=[I,A].filter(Boolean);return M.length?M.join(" / "):"—"}return"—"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:p=>p.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:i,children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[n.rank," ",n.lastName,", ",n.firstName,n.mi?` ${n.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:n.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:n.edipi||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:n.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:n.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:v()})]}),n.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),n.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:i,children:"Close"})})]})})}),Es=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],ks=()=>{const[s,n]=t.useState(null),[i,v]=t.useState(void 0),[p,O]=t.useState({}),[I,A]=t.useState({}),[M,F]=t.useState({}),[G,ee]=t.useState({}),[N,K]=t.useState(""),[U,_]=t.useState(""),[u,de]=t.useState(""),[J,E]=t.useState(""),[B,R]=t.useState(""),[Q,m]=t.useState([]),[S,L]=t.useState(null),[k,H]=t.useState(""),g=t.useRef(null),[h,W]=t.useState(null),[$,X]=t.useState(null),[Y,T]=t.useState(""),[ge,be]=t.useState(void 0),[Se,f]=t.useState(void 0),[V,ne]=t.useState(void 0),[se,Z]=t.useState(void 0),[xe,b]=t.useState(void 0),[D,le]=t.useState(void 0),[me,pe]=t.useState([]),[we,he]=t.useState([]),[Ae,r]=t.useState(""),[y,z]=t.useState("unit"),[d,x]=t.useState([]),[q,w]=t.useState(!1),[ae,Ne]=t.useState(!1),[De,We]=t.useState(!1),[Pe,Oe]=t.useState("admin"),Te=t.useRef(!1);t.useEffect(()=>{h&&Pe==="admin"&&!Te.current&&(!ge&&h.company&&h.company!=="N/A"&&(be(h.company),ne(h.company)),!Se&&h.platoon&&h.platoon!=="N/A"&&(f(h.platoon),Z(h.platoon)),!xe&&h.roleCompany&&h.roleCompany!=="N/A"&&b(h.roleCompany),!D&&h.rolePlatoon&&h.rolePlatoon!=="N/A"&&le(h.rolePlatoon),Te.current=!0)},[h,Pe]),t.useEffect(()=>{try{const a=localStorage.getItem("unit_structure");a&&O(JSON.parse(a))}catch{}try{const a=localStorage.getItem("unit_structure"),c={},C={},ce={};if(a){const ye=JSON.parse(a);for(const je of Object.keys(ye||{})){const re=ye[je];re&&Array.isArray(re._sections)&&(c[je]=re._sections),re&&Array.isArray(re._commandSections)&&(C[je]=re._commandSections),re&&re._platoonSectionMap&&typeof re._platoonSectionMap=="object"&&(ce[je]=re._platoonSectionMap)}}else(async()=>{try{const ye=await ft();for(const je of Object.keys(ye||{})){const re=ye[je];re&&Array.isArray(re._sections)&&(c[je]=re._sections),re&&Array.isArray(re._commandSections)&&(C[je]=re._commandSections),re&&re._platoonSectionMap&&typeof re._platoonSectionMap=="object"&&(ce[je]=re._platoonSectionMap)}O(ye)}catch{}})();A(c),F(C),ee(ce)}catch{}Qe().then(a=>{m(a)}).catch(()=>m([]));try{const a=localStorage.getItem("currentUser");if(a){const c=JSON.parse(a);if(n(c),c.unitUic){const C=qe.find(ce=>ce.uic===c.unitUic);C&&v(C)}}}catch{}},[]),t.useEffect(()=>{try{if(!i){const a=Object.keys(p||{});if(a.length){const c=a[0],C=p[c]||{},ye=qe.find(je=>je.uic===c)||{ruc:String(C._ruc||""),mcc:String(C._mcc||""),uic:c,unitName:String(C._unitName||c),streetAddress:String(C._streetAddress||"")};v(ye)}}}catch{}},[p]),t.useEffect(()=>{const a=(h==null?void 0:h.unitUic)||"";if(!a){pe([]);return}Mt(a).then(c=>pe(c||[])).catch(()=>pe([]))},[h]),t.useEffect(()=>{const a=(h==null?void 0:h.unitUic)||"",c=xe||"";if(!a||!c){he([]);return}mt(a,c).then(C=>he(C||[])).catch(()=>he([]))},[h,xe]);const Be=t.useMemo(()=>{const a=(i==null?void 0:i.uic)||"";if(!a)return[];const c=p[a]||{};return Object.keys(c).filter(C=>!C.startsWith("_")&&Array.isArray(c[C]))},[i,p]),Ue=t.useMemo(()=>{var C;const a=(i==null?void 0:i.uic)||"";if(!a||!N)return[];const c=(C=p[a])==null?void 0:C[N];return Array.isArray(c)?c:[]},[i,N,p]),Je=t.useMemo(()=>{const a=(i==null?void 0:i.uic)||"";return a?I[a]||[]:[]},[i,I]),Ce=t.useMemo(()=>{const a=(i==null?void 0:i.uic)||"";return a?M[a]||[]:[]},[i,M]),l=t.useMemo(()=>{const a=(h==null?void 0:h.unitUic)||"";if(!a)return[];const c=me;if(c&&c.length)return c;const C=p[a]||{};return Object.keys(C).filter(ce=>!ce.startsWith("_")&&Array.isArray(C[ce]))},[h,p,me]),o=t.useMemo(()=>{var ce;const a=(h==null?void 0:h.unitUic)||"",c=V||"";if(!a||!c)return[];const C=(ce=p[a])==null?void 0:ce[c];return Array.isArray(C)?C:[]},[h,V,p]),j=t.useMemo(()=>{var ye,je;const a=(h==null?void 0:h.unitUic)||"",c=xe||"";if(!c)return[];const C=we;if(C&&C.length>0)return C;if(a){const re=(ye=p[a])==null?void 0:ye[c];if(Array.isArray(re)&&re.length>0)return re}const ce=(i==null?void 0:i.uic)||"";if(ce&&ce!==a){const re=(je=p[ce])==null?void 0:je[c];if(Array.isArray(re))return re}return[]},[h,xe,p,we,i]),P=t.useMemo(()=>{const a=l.slice(),c=ge||(h&&h.company!=="N/A"?h.company:"");return c&&!a.includes(c)?[c,...a]:a},[l,ge,h]);t.useMemo(()=>{const a=o.slice(),c=se||(h&&h.platoon&&h.platoon!=="N/A"?h.platoon:"");return c&&!a.includes(c)?[c,...a]:a},[o,se,h]);const oe=t.useMemo(()=>{const a=j.slice(),c=D||(h&&h.rolePlatoon&&h.rolePlatoon!=="N/A"?h.rolePlatoon:"");return c&&!a.includes(c)?[c,...a]:a},[j,D,h]),ie=()=>{try{if(i){const a=i.uic,c={...p};c[a]=c[a]||{},c[a]._mcc=i.mcc||c[a]._mcc||"",c[a]._unitName=i.unitName||c[a]._unitName||"",O(c),localStorage.setItem("unit_structure",JSON.stringify(c)),(async()=>{try{if(navigator.sendBeacon){const ce=new Blob([JSON.stringify(c)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",ce),L({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),keepalive:!0})).ok)throw new Error("persist_failed");L({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{L({type:"error",message:"Failed to persist unit structure."})}})()}else{const a=JSON.stringify(p);localStorage.setItem("unit_structure",a),(async()=>{try{if(navigator.sendBeacon){const C=new Blob([a],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",C),L({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:a,keepalive:!0})).ok)throw new Error("persist_failed");L({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{L({type:"error",message:"Failed to persist unit structure."})}})()}}catch{L({type:"error",message:"Failed to save unit structure."})}},te=()=>{try{if(!i)return;const a=i.uic,c={...p};c[a]=c[a]||{},c[a]._sections=I[a]||[],c[a]._mcc=i.mcc||c[a]._mcc||"",c[a]._unitName=i.unitName||c[a]._unitName||"",O(c),localStorage.setItem("unit_structure",JSON.stringify(c)),(async()=>{try{if(navigator.sendBeacon){const ce=new Blob([JSON.stringify(c)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",ce),L({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),keepalive:!0})).ok)throw new Error("persist_failed");L({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{L({type:"error",message:"Failed to persist unit sections."})}})()}catch{L({type:"error",message:"Failed to save unit sections."})}},ve=()=>{try{if(!i)return;const a=i.uic,c={...p};c[a]=c[a]||{},c[a]._commandSections=M[a]||[],c[a]._mcc=i.mcc||c[a]._mcc||"",c[a]._unitName=i.unitName||c[a]._unitName||"",O(c),localStorage.setItem("unit_structure",JSON.stringify(c)),(async()=>{try{if(navigator.sendBeacon){const ce=new Blob([JSON.stringify(c)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",ce),L({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),keepalive:!0})).ok)throw new Error("persist_failed");L({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{L({type:"error",message:"Failed to persist command sections."})}})()}catch{L({type:"error",message:"Failed to save command sections."})}},ue=()=>{try{if(!i)return;const a=i.uic,c={...p};c[a]=c[a]||{},c[a]._platoonSectionMap=G[a]||{},c[a]._mcc=i.mcc||c[a]._mcc||"",c[a]._unitName=i.unitName||c[a]._unitName||"",O(c),localStorage.setItem("unit_structure",JSON.stringify(c)),(async()=>{try{if(navigator.sendBeacon){const ce=new Blob([JSON.stringify(c)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",ce),L({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),keepalive:!0})).ok)throw new Error("persist_failed");L({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{L({type:"error",message:"Failed to persist links."})}})()}catch{L({type:"error",message:"Failed to save links."})}},Re=()=>{if(!i||!U.trim())return;const a=i.uic,c={...p};c[a]=c[a]||{},c[a][U.trim()]||(c[a][U.trim()]=[],O(c),K(U.trim()),_(""))},fe=a=>{if(!i)return;const c=i.uic,C={...p};C[c]&&(delete C[c][a],O(C),N===a&&K(""))},Ie=()=>{if(!i||!N||!u.trim())return;const a=i.uic,c={...p};c[a]=c[a]||{},c[a][N]=c[a][N]||[],c[a][N].includes(u.trim())||(c[a][N]=[...c[a][N],u.trim()],O(c),de(""))},Me=a=>{if(!i||!N)return;const c=i.uic,C={...p};C[c][N]=(C[c][N]||[]).filter(ce=>ce!==a),O(C)},Fe=()=>{if(!i||!J.trim())return;const a=i.uic,c={...I};c[a]=c[a]||[],c[a].includes(J.trim())||(c[a]=[...c[a],J.trim()],A(c),E(""))},$e=a=>{if(!i)return;const c=i.uic,C={...I};C[c]=(C[c]||[]).filter(ce=>ce!==a),A(C)},it=()=>{if(!i||!B.trim())return;const a=i.uic,c={...M};c[a]=c[a]||[],c[a].includes(B.trim())||(c[a]=[...c[a],B.trim()],F(c),R(""))},Ve=a=>{if(!i)return;const c=i.uic,C={...M};C[c]=(C[c]||[]).filter(ce=>ce!==a),F(C)},Ee=()=>{const a=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],c=Q.map(re=>[re.firstName,re.mi||"",re.lastName,re.email,re.edipi,re.service,re.rank,re.role,re.company,re.unit,re.unitUic||""].map(Tt=>{const Ye=String(Tt??"");return Ye.includes(",")||Ye.includes('"')||Ye.includes(`
`)?'"'+Ye.replace(/"/g,'""')+'"':Ye}).join(",")),C="\uFEFF"+[a.join(","),...c].join(`
`),ce=new Blob([C],{type:"text/csv;charset=utf-8"}),ye=URL.createObjectURL(ce),je=document.createElement("a");je.href=ye,je.download="users-export.csv",je.click(),URL.revokeObjectURL(ye)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${y==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>z("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${y==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>z("users"),children:"User Administration"})]})})}),y==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:i?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",i.uic," | RUC: ",i.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ie,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:U,onChange:a=>_(a.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Re,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Be.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>K(a),children:a}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>fe(a),children:"Remove"})]},a)),Be.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",N?`• ${N}`:""]}),i&&N&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ue,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:u,onChange:a=>de(a.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!N}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:Ie,disabled:!N,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Ue.map(a=>{var c,C;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:a})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:((C=(c=G[(i==null?void 0:i.uic)||""])==null?void 0:c[N])==null?void 0:C[a])||"",onChange:ce=>{const ye=(i==null?void 0:i.uic)||"";ee(je=>{const re={...je};return re[ye]=re[ye]||{},re[ye][N]=re[ye][N]||{},re[ye][N][a]=ce.target.value,re})},children:[e.jsx("option",{value:"",children:"Link to section"}),(I[(i==null?void 0:i.uic)||""]||[]).map(ce=>e.jsx("option",{value:ce,children:ce},ce))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Me(a),children:"Remove"})]})]},a)}),Ue.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:te,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:J,onChange:a=>E(a.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Fe,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Je.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:a}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>$e(a),children:"Remove"})]},a)),Je.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ve,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:B,onChange:a=>R(a.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:it,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Ce.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:a}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Ve(a),children:"Remove"})]},a)),Ce.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),y==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[Q.filter(a=>{const c=!k||(a.email??"").toLowerCase().includes(k.toLowerCase())||(a.lastName??"").toLowerCase().includes(k.toLowerCase()),C=i?a.unitUic===i.uic||a.unit&&a.unit===i.unitName:!0;return c&&C}).map(a=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:a.email}),e.jsx("td",{className:"py-2 px-3",children:a.edipi}),e.jsx("td",{className:"py-2 px-3",children:a.service}),e.jsx("td",{className:"py-2 px-3",children:a.rank}),e.jsx("td",{className:"py-2 px-3",children:a.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const c=qe.find(ce=>ce.uic===a.unitUic),C=c?c.unitName:a.unit;if(a.isUnitAdmin||a.role==="COMMANDER")return C||"—";if(a.role==="COMPANY_REVIEWER")return a.company&&a.company!=="N/A"?a.company:"—";if(a.role==="PLATOON_REVIEWER"){const ce=a.company&&a.company!=="N/A"?a.company:"",ye=a.platoon&&a.platoon!=="N/A"?a.platoon:"",je=[ce,ye].filter(Boolean);return je.length?je.join(" / "):"—"}return"—"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>X(a),children:"View"}),((s==null?void 0:s.isUnitAdmin)||(s==null?void 0:s.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{Oe("admin"),W(a),T(a.role??"MEMBER"),be(a.company!=="N/A"?a.company:void 0),ne(a.company!=="N/A"?a.company:void 0),f(a.platoon&&a.platoon!=="N/A"?a.platoon:void 0),Z(a.platoon&&a.platoon!=="N/A"?a.platoon:void 0),r(typeof a.commandOrder=="number"?String(a.commandOrder):""),Ne(!!a.isUnitAdmin),We(!!a.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{m(c=>c.filter(C=>C.id!==a.id));try{localStorage.removeItem(`fs/users/${a.id}.json`)}catch(c){console.error("Failed to remove user from localStorage",c)}},children:"Delete"})]})})]},a.id)),Q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:"No users"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:g,type:"text",placeholder:"Filter users...",value:k,onChange:a=>H(a.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var a;return(a=g.current)==null?void 0:a.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:Ee,children:"Export All"})]})]}),$&&e.jsx(As,{user:$,onClose:()=>X(null)}),h&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>W(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>W(null),children:"✕"})]}),Pe==="profile"&&s&&h&&s.edipi===h.edipi&&e.jsx(qt,{mode:"edit",initial:h,readOnly:!1,onSaved:a=>{m(c=>c.map(C=>C.edipi===a.edipi?a:C)),W(null),L({type:"success",message:"Profile updated."})}}),Pe==="admin"&&((s==null?void 0:s.isUnitAdmin)||(s==null?void 0:s.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:Y,onChange:a=>{const c=a.target.value;T(c),c==="COMMANDER"&&(be(void 0),f(void 0))},className:"w-full px-3 py-2 border rounded",children:Es.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:xe||"",onChange:a=>b(a.target.value||void 0),disabled:!Y.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:P.length?"Select company":"No companies configured"}),P.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:D||"",onChange:a=>le(a.target.value||void 0),disabled:!Y.includes("REVIEW")||!xe,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:oe.length?"Select platoon":"No platoons configured"}),oe.map(a=>e.jsx("option",{value:a,children:a},a))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:ae,onChange:a=>Ne(a.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:De,disabled:Y==="COMMANDER",onChange:async a=>{const c=a.target.checked;We(c);try{if(h&&!(await He({id:h.id,email:h.email,rank:h.rank,firstName:h.firstName,lastName:h.lastName,mi:h.mi,service:h.service,role:h.role,unitUic:h.unitUic,unit:h.unit,company:h.company,isUnitAdmin:!!h.isUnitAdmin,isCommandStaff:c,edipi:h.edipi,passwordHash:h.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Command Sections Dashboard"})]})]}),d.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:d.map((a,c)=>e.jsx("div",{className:"text-sm",children:a},c))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{W(null),Te.current=!1,x([]),w(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${q?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":q,disabled:q,onClick:async()=>{var ce;if(!h)return;const a=[];if(Y==="COMPANY_REVIEWER"&&!ge&&a.push("Company is required for Company Reviewer."),Y==="PLATOON_REVIEWER"&&(!ge||!Se)&&a.push("Company and Platoon are required for Platoon Reviewer."),x(a),a.length)return;w(!0);const c=((ce=qe.find(ye=>ye.uic===h.unitUic))==null?void 0:ce.unitName)||"N/A",C={...h,role:Y,isUnitAdmin:ae,isCommandStaff:Y==="COMMANDER"?!1:De,company:V||"N/A",unit:c,platoon:se||"N/A",roleCompany:Y.includes("REVIEW")?xe||"N/A":void 0,rolePlatoon:Y.includes("REVIEW")?D||"N/A":void 0};try{localStorage.setItem(`fs/users/${C.edipi}.json`,JSON.stringify(C))}catch{}try{if(!(await He({id:C.id,email:C.email,rank:C.rank,firstName:C.firstName,lastName:C.lastName,mi:C.mi,service:C.service,role:C.role,unitUic:C.unitUic,unit:C.unit,company:C.company,isUnitAdmin:!!C.isUnitAdmin,isCommandStaff:!!C.isCommandStaff,edipi:C.edipi,passwordHash:C.passwordHash,roleCompany:C.roleCompany,rolePlatoon:C.rolePlatoon,platoon:C.platoon})).ok)throw new Error("persist_failed")}catch{w(!1),L({type:"error",message:"Failed to save administrative changes."});return}m(ye=>ye.map(je=>je.edipi===C.edipi?C:je));try{s&&s.edipi===C.edipi&&(localStorage.setItem("currentUser",JSON.stringify(C)),n(C))}catch{}W(null),Te.current=!1,w(!1),L({type:"success",message:"Administrative changes saved."})},children:[q&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),S&&e.jsx("div",{className:`p-3 rounded-lg border ${S.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:S.message})]})};function Is(){const[s,n]=t.useState([]),[i,v]=t.useState(null),[p,O]=t.useState({}),[I,A]=t.useState({}),[M,F]=t.useState([]),[G,ee]=t.useState("unit"),[N,K]=t.useState("assigned"),[U,_]=t.useState([]),[u,de]=t.useState(""),[J,E]=t.useState([]),[B,R]=t.useState(""),Q=()=>{Qe().then(d=>n(d)).catch(()=>n([]))},m=()=>{nt().then(d=>F(d)).catch(()=>F([]))},S=()=>{v(null),Q(),m()};t.useEffect(()=>{S(),Pt().then(d=>_(d)),kt().then(d=>E(d))},[G,N]);const L=t.useMemo(()=>{const d={};for(const x of s)x.isUnitAdmin&&x.unitUic&&(d[x.unitUic]=x);return d},[s]),k=t.useMemo(()=>{const d={};for(const x of s)if(x.isInstallationAdmin&&x.installationId){const q=x.installationId;d[q]=d[q]||[],d[q].push(x)}return d},[s]),H=d=>s.filter(x=>x.unitUic===d.uic||!x.unitUic&&x.unit===d.unitName),g=async d=>{const x=p[d.uic];if(!x)return;const q=s.find(ae=>ae.id===x);if(!q)return;const w={...q,isUnitAdmin:!0,unitUic:d.uic,unit:d.unitName,company:"N/A"};try{if(!(await He({id:w.id,email:w.email,rank:w.rank,firstName:w.firstName,lastName:w.lastName,mi:w.mi,service:w.service,role:w.role,unitUic:w.unitUic,unit:w.unit,company:w.company,isUnitAdmin:!!w.isUnitAdmin,isInstallationAdmin:!!w.isInstallationAdmin,isCommandStaff:!!w.isCommandStaff,edipi:w.edipi})).ok){v({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}n(ae=>ae.map(Ne=>Ne.id===w.id?w:Ne)),v({type:"success",message:`Assigned ${w.rank} ${w.lastName} as admin for ${d.unitName}.`})},h=t.useMemo(()=>qe.filter(d=>!!L[d.uic]),[L]);t.useMemo(()=>s.filter(d=>!!d.isHqmcAdmin),[s]);const W=t.useMemo(()=>qe.filter(d=>!L[d.uic]),[L]),$=t.useMemo(()=>U.filter(d=>{var x;return(x=k[d.id])==null?void 0:x.length}),[U,k]),X=t.useMemo(()=>U.filter(d=>{var x;return!((x=k[d.id])!=null&&x.length)}),[U,k]),Y=t.useMemo(()=>{const d={};for(const x of s)if(x.isHqmcAdmin&&x.hqmcDivision){const q=x.hqmcDivision;d[q]=d[q]||[],d[q].push(x)}return d},[s]),T=t.useMemo(()=>J.filter(d=>{var x;return(x=Y[d.code])==null?void 0:x.length}),[J,Y]);t.useMemo(()=>{const d=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return M.filter(x=>d.includes(String(x.currentStage||"")))},[M]);const[ge,be]=t.useState(1),[Se,f]=t.useState(10),V=h.length,ne=Math.max(1,Math.ceil(V/(Se||1))),se=Math.min(ge,ne),Z=V===0?0:(se-1)*Se+1,xe=V===0?0:Math.min(Z+Se-1,V),b=h.slice((se-1)*Se,(se-1)*Se+Se),[D,le]=t.useState(1),[me,pe]=t.useState(10),we=W.length,he=Math.max(1,Math.ceil(we/(me||1))),Ae=Math.min(D,he),r=we===0?0:(Ae-1)*me+1,y=we===0?0:Math.min(r+me-1,we),z=W.slice((Ae-1)*me,(Ae-1)*me+me);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${G==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{ee("unit"),K("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${G==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{ee("installation"),K("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${G==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{ee("hqmc"),K("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${N==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>K("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${N==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>K("missing"),children:"Missing"})]}),G==="installation"&&N==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[$.map(d=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:d.name}),e.jsx("td",{className:"py-2 px-3",children:(k[d.id]||[]).map(x=>`${x.rank} ${x.lastName}, ${x.firstName}${x.mi?` ${x.mi}`:""}`).join(" • ")})]},d.id)),$.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),G==="installation"&&N==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[X.map(d=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:d.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:I[d.id]||"",onChange:x=>A(q=>({...q,[d.id]:x.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),s.map(x=>e.jsx("option",{value:x.id,children:`${x.rank} ${x.lastName}, ${x.firstName}${x.mi?` ${x.mi}`:""}`},x.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!I[d.id],onClick:async()=>{const x=I[d.id],q=s.find(ae=>ae.id===x);if(!q)return;const w={...q,isInstallationAdmin:!0,installationId:d.id};try{if(!(await He({id:w.id,email:w.email,rank:w.rank,firstName:w.firstName,lastName:w.lastName,mi:w.mi,service:w.service,role:w.role,unitUic:w.unitUic,unit:w.unit,company:w.company,isUnitAdmin:!!w.isUnitAdmin,isInstallationAdmin:!!w.isInstallationAdmin,isCommandStaff:!!w.isCommandStaff,edipi:w.edipi,installationId:w.installationId})).ok){v({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}n(ae=>ae.map(Ne=>Ne.id===w.id?w:Ne)),v({type:"success",message:`Assigned ${w.rank} ${w.lastName} as installation admin.`})},children:"Assign"})})]},d.id)),X.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),G==="unit"&&N==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[b.map(d=>{const x=L[d.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:d.unitName}),e.jsx("td",{className:"py-2 px-3",children:d.uic}),e.jsx("td",{className:"py-2 px-3",children:`${x.rank} ${x.lastName}, ${x.firstName}${x.mi?` ${x.mi}`:""}`})]},d.uic)}),h.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(ut,{currentPage:se,totalPages:ne,totalItems:V,pageSize:Se,startIndex:Z,endIndex:xe,onPageChange:d=>be(d),onPageSizeChange:d=>{f(d),be(1)},onNext:()=>be(Math.min(se+1,ne)),onPrevious:()=>be(Math.max(se-1,1)),onFirst:()=>be(1),onLast:()=>be(ne),canGoNext:se<ne,canGoPrevious:se>1,pageSizeOptions:[5,10,25,50]})})]}),G==="unit"&&N==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[z.map(d=>{const x=H(d);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:d.unitName}),e.jsx("td",{className:"py-2 px-3",children:d.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:p[d.uic]||"",onChange:q=>O(w=>({...w,[d.uic]:q.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:x.length?"Select user":"No eligible users"}),x.map(q=>e.jsx("option",{value:q.id,children:`${q.rank} ${q.lastName}, ${q.firstName}${q.mi?` ${q.mi}`:""}`},q.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!p[d.uic],onClick:()=>g(d),children:"Assign"})})]},d.uic)}),W.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(ut,{currentPage:Ae,totalPages:he,totalItems:we,pageSize:me,startIndex:r,endIndex:y,onPageChange:d=>le(d),onPageSizeChange:d=>{pe(d),le(1)},onNext:()=>le(Math.min(Ae+1,he)),onPrevious:()=>le(Math.max(Ae-1,1)),onFirst:()=>le(1),onLast:()=>le(he),canGoNext:Ae<he,canGoPrevious:Ae>1,pageSizeOptions:[5,10,25,50]})})]}),G==="hqmc"&&N==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[T.map(d=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[d.code," — ",d.name]}),e.jsx("td",{className:"py-2 px-3",children:(Y[d.code]||[]).map(x=>`${x.rank} ${x.lastName}, ${x.firstName}${x.mi?` ${x.mi}`:""}`).join(" • ")})]},d.code)),T.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),G==="hqmc"&&N==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[J.filter(d=>{var x;return!((x=Y[d.code])!=null&&x.length)}).map(d=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[d.code," — ",d.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:I[`hqmc_${d.code}`]||"",onChange:x=>A(q=>({...q,[`hqmc_${d.code}`]:x.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),s.map(x=>e.jsx("option",{value:x.id,children:`${x.rank} ${x.lastName}, ${x.firstName}${x.mi?` ${x.mi}`:""}`},x.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!I[`hqmc_${d.code}`],onClick:async()=>{const x=I[`hqmc_${d.code}`],q=s.find(ae=>ae.id===x);if(!q)return;const w={...q,isHqmcAdmin:!0,hqmcDivision:d.code};try{if(!(await He({id:w.id,email:w.email,rank:w.rank,firstName:w.firstName,lastName:w.lastName,mi:w.mi,service:w.service,role:w.role,unitUic:w.unitUic,unit:w.unit,company:w.company,isUnitAdmin:!!w.isUnitAdmin,isInstallationAdmin:!!w.isInstallationAdmin,isCommandStaff:!!w.isCommandStaff,isHqmcAdmin:!!w.isHqmcAdmin,hqmcDivision:w.hqmcDivision,edipi:w.edipi})).ok){v({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}n(ae=>ae.map(Ne=>Ne.id===w.id?w:Ne)),v({type:"success",message:`Assigned ${w.rank} ${w.lastName} as HQMC admin for ${d.code}.`})},children:"Assign"})})]},d.code)),J.filter(d=>{var x;return!((x=Y[d.code])!=null&&x.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),i&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${i.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:i.message})]})})}const Ct=!0,Rs=({onLoggedIn:s,onCreateAccount:n})=>{const[i,v]=t.useState(""),[p,O]=t.useState(""),[I,A]=t.useState(null),[M,F]=t.useState(!0),[G,ee]=t.useState(!0);Wt.useEffect(()=>{},[]);const N=async K=>{K.preventDefault(),A(null);try{const U=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,_=/^[0-9]{10}$/.test(i),u=Ct?U.test(i.trim().toLowerCase())||_:U.test(i.trim().toLowerCase()),de=p.length>=6;if(F(u),ee(de),!u){A({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!de){A({type:"error",message:"Password must be at least 6 characters."});return}let J=null,E=null,B=i.trim().toLowerCase();if(Ct&&_){const{user:H,error:g}=await lt(String(i));J=H,E=g,B=String((J==null?void 0:J.email)||"")}else if(U.test(B)){const{user:H,error:g}=await vt(B);J=H,E=g}else{A({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(E){A({type:"error",message:`Database Error: ${E}`});return}if(!J||!B){A({type:"error",message:"Account not found."});return}const R=String(J.passwordHash||J.password_hash||"").trim();if(!R){A({type:"error",message:"No password set for this user."});return}const Q=await xt(p);if(!(/^[0-9a-f]{64}$/i.test(R)?R.toLowerCase()===Q.toLowerCase():R===p)){A({type:"error",message:"Invalid credentials."});return}const{user:L,error:k}=await vt(B);if(k){A({type:"error",message:`Profile Error: ${k}`});return}if(!L){console.error("[Login] User profile not found after successful password verification",{emailForLogin:B}),A({type:"error",message:"User profile not found."});return}A({type:"success",message:"Logged in."}),s(L)}catch(U){console.error("[Login] Login failed:",U),A({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:i,onChange:K=>v(K.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${M?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!M}),!M&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:p,onChange:K=>O(K.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${G?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!G}),!G&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),I&&e.jsx("div",{className:`p-3 rounded-lg border ${I.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:I.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:n,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!M||!G,children:"Login"})]})]})]})},At=""+new URL("logo-DLcHofKE.png",import.meta.url).href,Ms=({currentUser:s,hasSectionDashboard:n,hasCommandDashboard:i,hasInstallationSectionDashboard:v=!1,hasInstallationCommandDashboard:p=!1,hasHQMCSectionDashboard:O=!1,hasHQMCApproverDashboard:I=!1,onManageProfile:A,onLogout:M,onNavigate:F,isLogin:G=!1})=>{const[ee,N]=t.useState(!1),[K,U]=t.useState(!1),_=t.useRef(null);return t.useEffect(()=>{const u=J=>{if(!ee)return;const E=_.current;E&&J.target&&!E.contains(J.target)&&N(!1)},de=J=>{J.key==="Escape"&&N(!1)};return document.addEventListener("mousedown",u),document.addEventListener("touchstart",u,{passive:!0}),document.addEventListener("keydown",de),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("touchstart",u),document.removeEventListener("keydown",de)}},[ee]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:G?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:At,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:At,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:s?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[s.rank," ",s.lastName,s.lastName?",":""," ",s.firstName,s.mi?` ${s.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[s.service," • ",s.role,(()=>{const u={PLATOON_REVIEWER:s.role_platoon,COMPANY_REVIEWER:s.role_company}[s.role];return u?` - ${u}`:null})()]}),(()=>{var B;const u=((B=qe.find(R=>R.uic===((s==null?void 0:s.unitUic)||"")))==null?void 0:B.unitName)||(s==null?void 0:s.unit)||"",de=s!=null&&s.company&&s.company!=="N/A"?s.company:s!=null&&s.user_company&&s.user_company!=="N/A"?s.user_company:null,J=s!=null&&s.platoon&&s.platoon!=="N/A"?s.platoon:s!=null&&s.user_platoon&&s.user_platoon!=="N/A"?s.user_platoon:null,E=[u||null,de,J].filter(Boolean);return E.length?e.jsx("div",{className:"text-xs text-white/70",children:E.join(" • ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(s.lastName||"").charAt(0)}${(s.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:A,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:M,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),s&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>U(!K),children:`${(s.lastName||"").charAt(0)}${(s.firstName||"").charAt(0)}`.toUpperCase()}),K&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{A(),U(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{M(),U(!1)},children:"Logout"})]})]}),!s&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>F("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:_,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":ee,onClick:()=>N(u=>!u),children:"Dashboards"}),e.jsxs("div",{className:`${ee?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:s&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{F("dashboard"),N(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(s==null?void 0:s.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{F("admin"),N(!1)},children:"Admin"}),s&&!!s.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{F("appadmin"),N(!1)},children:"App Admin"}),s&&!!s.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{F("hqmc-admin"),N(!1)},children:"HQMC Admin"}),s&&!!s.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{F("installation"),N(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[s&&n&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{F("section"),N(!1)},children:"Battalion Section Dashboard"}),i&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{F("command"),N(!1)},children:"Command Sections Dashboard"}),String((s==null?void 0:s.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{F("review"),N(!1)},children:"Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[s&&v&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{F("installation-section"),N(!1)},children:"Installation Section Dashboard"}),s&&p&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{F("installation-command"),N(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[s&&(O||!!s.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{F("hqmc-section"),N(!1)},children:"HQMC Section Dashboard"}),s&&I&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{F("hqmc-approver"),N(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})};function Ps(){const[s,n]=t.useState(null),[i,v]=t.useState("login"),[p,O]=t.useState(()=>{try{const m=localStorage.getItem("currentUser");return m?JSON.parse(m):null}catch(m){return console.error("Failed to parse user from localStorage:",m),null}}),[I,A]=t.useState("create"),[M,F]=t.useState(!1),[G,ee]=t.useState(!1),[N,K]=t.useState(!1),[U,_]=t.useState(!1),[u,de]=t.useState(!1),[J,E]=t.useState(!1),[B,R]=t.useState(!1),Q=Vt();return t.useEffect(()=>{try{const S=new URLSearchParams(window.location.search).get("view");if(S==="admin"||S==="profile"||S==="dashboard"||S==="login"||S==="appadmin"||S==="hqmc-admin"||S==="hqmc-section"||S==="hqmc-approver"||S==="review"||S==="section"||S==="command"||S==="installation"||S==="installation-section"||S==="installation-command"||S==="documents"||S==="document-viewer"||S==="upload")v(S);else{const L=localStorage.getItem("currentView"),k=localStorage.getItem("currentUser");v(L&&k?L:"login")}}catch{v("login")}},[]),t.useEffect(()=>{p?localStorage.setItem("currentUser",JSON.stringify(p)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"))},[p]),t.useEffect(()=>{let m=!1;return(async()=>{try{const S=(p==null?void 0:p.id)||"";if(!S)return;const L=await Rt(S);L&&!m&&(O(L),localStorage.setItem("currentUser",JSON.stringify(L)))}catch{}})(),()=>{m=!0}},[]),t.useEffect(()=>{i!=="login"&&p&&localStorage.setItem("currentView",i)},[i,p]),t.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const S=await ft();localStorage.setItem("unit_structure",JSON.stringify(S))}catch(m){console.error("Failed to load unit structure:",m)}})()},[]),t.useEffect(()=>{var S,L,k;try{const H=localStorage.getItem("unit_structure");if(!p||!H){ee(!1);return}const g=JSON.parse(H),h=(p==null?void 0:p.unitUic)||"",W=p!=null&&p.company&&p.company!=="N/A"?p.company:"",$=p!=null&&p.platoon&&p.platoon!=="N/A"?p.platoon:"",X=((k=(L=(S=g==null?void 0:g[h])==null?void 0:S._platoonSectionMap)==null?void 0:L[W])==null?void 0:k[$])||"";ee(!!X)}catch(H){console.error("Failed to parse unit structure for section dashboard check",H),ee(!1)}const m=p==null?void 0:p.isCommandStaff;K(!!m),(async()=>{try{const H=(p==null?void 0:p.installationId)||"";if(!H){_(!1),de(!1);return}const g=await Pt();try{localStorage.setItem("installations_cache",JSON.stringify(g))}catch{}const h=g==null?void 0:g.find(Y=>Y.id===H),W=(p==null?void 0:p.id)||"",$=!!(h&&h.sectionAssignments&&Object.values(h.sectionAssignments).some(Y=>Array.isArray(Y)&&Y.includes(W))),X=!!(h&&(h.commandSectionAssignments&&Object.values(h.commandSectionAssignments).some(Y=>Array.isArray(Y)&&Y.includes(W))||h.commanderUserId&&String(h.commanderUserId)===W));_($),de(X)}catch{_(!1),de(!1)}})(),(async()=>{try{const H=String((p==null?void 0:p.hqmcDivision)||""),g=String((p==null?void 0:p.id)||"");if(!H||!g){E(!!(p!=null&&p.isHqmcAdmin));return}const{listHQMCSectionAssignmentsLegacy:h}=await zt(async()=>{const{listHQMCSectionAssignmentsLegacy:Y}=await import("./db-DT7oWH3m.js").then(T=>T.z);return{listHQMCSectionAssignmentsLegacy:Y}},__vite__mapDeps([0,1,2]),import.meta.url),W=await h(),$=W.some(Y=>Y.division_code===H&&((Y.reviewers||[]).includes(g)||(Y.approvers||[]).includes(g)));E($||!!(p!=null&&p.isHqmcAdmin));const X=W.some(Y=>Y.division_code===H&&(Y.approvers||[]).includes(g));R(X)}catch{E(!!(p!=null&&p.isHqmcAdmin))}})()},[p]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(Ms,{currentUser:p,hasSectionDashboard:G,hasCommandDashboard:N,hasInstallationSectionDashboard:U,hasInstallationCommandDashboard:u,hasHQMCSectionDashboard:J,hasHQMCApproverDashboard:B,onManageProfile:()=>{A("edit"),v("profile"),Q("/?view=profile")},onLogout:()=>{O(null),v("login"),Q("/?view=login")},onNavigate:m=>{v(m),Q(`/?view=${m}`)},isLogin:i==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:i==="profile"?e.jsx(qt,{mode:I,initial:I==="edit"?p||{}:{},onSaved:m=>{O(m),v("dashboard"),Q("/?view=dashboard")}}):i==="admin"?e.jsx(ks,{}):i==="appadmin"?e.jsx(Is,{}):i==="login"?e.jsx(Rs,{onLoggedIn:m=>{O(m),v("dashboard"),Q("/?view=dashboard")},onCreateAccount:()=>{A("create"),v("profile"),Q("/?view=profile")}}):i==="review"?e.jsx(ps,{}):i==="section"?e.jsx(ss,{}):i==="command"?e.jsx(as,{}):i==="installation"?e.jsx(Zt,{}):i==="hqmc-admin"?e.jsx(bs,{}):i==="installation-section"?e.jsx(ns,{}):i==="installation-command"?e.jsx(is,{}):i==="hqmc-section"?e.jsx(vs,{}):i==="hqmc-approver"?e.jsx(js,{}):e.jsx(os,{selectedUnit:s,currentUser:p})})]})}function Vs(){return e.jsx(Ps,{})}export{Vs as default};
