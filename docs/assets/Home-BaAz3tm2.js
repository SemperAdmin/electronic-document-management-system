const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-DocjssFb.js","./index-DcVd3XOr.js","./index-CfqkKZXo.css"])))=>i.map(i=>d[i]);
import{r as s,j as e,c as ps,f as hs,a as gs,s as ss,S as Wt,v as bs,l as Dt,M as Ht,b as fs,u as ys,R as vs,d as Ns,_ as js}from"./index-DcVd3XOr.js";import{s as Me,d as ws,a as Ss,b as Cs,l as qt,c as vt,e as it,u as Fe,f as Pt,g as Nt,h as Ke,i as As,j as ks,k as as,m as ns,n as Ft,o as Es,p as rs,q as $t,r as Rs,t as is,v as os,w as Ot,x as cs,y as Ut}from"./db-DocjssFb.js";import{P as _t,I as Is}from"./InstallationAdmin-DMm1o6VM.js";import{f as ls,R as Xe,S as Je,o as zt,c as Ds,a as Ms}from"./RequestTable-CoUDJpb_.js";import{c as Ps,F as $s,D as ds,a as at}from"./DocumentListItem-BF3G7sNT.js";import{l as jt}from"./unitStructure-QC5qYuxv.js";import Os from"./SectionDashboard-CNf4fBUj.js";import _s from"./CommandDashboard-BDEOkBl2.js";import Ls from"./InstallationSectionDashboard-BgE-O54v.js";import Ts from"./InstallationCommandDashboard-DM8Xcu76.js";import{U as Ue}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-BpBekQ4j.js";import"./utils-CLmukD0c.js";const qs={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},Fs=({filters:t,onFiltersChange:a,statusOptions:o=[],originatorOptions:j=[],searchPlaceholder:d="Search requests...",showAdvanced:R=!0,className:I=""})=>{var Q;const[A,O]=s.useState(!1),T=s.useRef(null),W=s.useMemo(()=>Array.isArray(t.status)?t.status:[],[t.status]),X=s.useMemo(()=>{let y=0;return W.length>0&&y++,t.dateFrom&&y++,t.dateTo&&y++,t.originatorId&&y++,y},[W,t.dateFrom,t.dateTo,t.originatorId]),S=s.useCallback(y=>{a({...t,search:y.target.value})},[t,a]),J=s.useCallback(y=>{const H=W.includes(y)?W.filter(h=>h!==y):[...W,y];a({...t,status:H})},[t,W,a]),z=s.useCallback(y=>{a({...t,dateFrom:y.target.value})},[t,a]),V=s.useCallback(y=>{a({...t,dateTo:y.target.value})},[t,a]),l=s.useCallback(y=>{a({...t,originatorId:y.target.value})},[t,a]),ee=s.useCallback(()=>{var y;a(qs),(y=T.current)==null||y.focus()},[a]),L=s.useCallback(()=>{var y;a({...t,search:""}),(y=T.current)==null||y.focus()},[t,a]);s.useEffect(()=>{const y=H=>{var h;(H.metaKey||H.ctrlKey)&&H.key==="k"&&(H.preventDefault(),(h=T.current)==null||h.focus())};return document.addEventListener("keydown",y),()=>document.removeEventListener("keydown",y)},[]);const _=t.search||X>0;return e.jsxs("div",{className:`space-y-3 ${I}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{ref:T,type:"text",value:t.search,onChange:S,placeholder:d,className:"block w-full pl-10 pr-10 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold bg-[var(--surface)] text-[var(--text)]","aria-label":"Search"}),t.search&&e.jsx("button",{onClick:L,className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600","aria-label":"Clear search",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute inset-y-0 right-8 flex items-center pointer-events-none text-xs text-gray-400",children:e.jsx("kbd",{className:"hidden sm:inline-block px-1.5 py-0.5 bg-gray-100 rounded border border-gray-200 font-mono",children:"âŒ˜K"})})]}),R&&e.jsxs("button",{onClick:()=>O(!A),className:`
              flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors
              ${A||X>0?"bg-brand-gold/10 border-brand-gold text-brand-navy":"border-brand-navy/30 text-[var(--text)] hover:bg-brand-cream/50"}
            `,"aria-expanded":A,"aria-controls":"filter-panel",children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"})}),e.jsx("span",{className:"hidden sm:inline",children:"Filters"}),X>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-brand-navy rounded-full",children:X})]}),_&&e.jsxs("button",{onClick:ee,className:"flex items-center gap-1 px-3 py-2 text-sm text-brand-red hover:text-brand-red-2 hover:bg-red-50 rounded-lg transition-colors","aria-label":"Clear all filters",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),R&&A&&e.jsxs("div",{id:"filter-panel",className:"p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[o.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Status"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:o.map(y=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-white/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:W.includes(y.value),onChange:()=>J(y.value),className:"h-4 w-4 text-brand-navy border-gray-300 rounded focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-[var(--text)]",children:y.label})]},y.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Date Range"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"From date"}),e.jsx("input",{type:"date",value:t.dateFrom,onChange:z,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"From date"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"To date"}),e.jsx("input",{type:"date",value:t.dateTo,onChange:V,min:t.dateFrom,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"To date"})]})]})]}),j.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Originator"}),e.jsxs("select",{value:t.originatorId,onChange:l,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"Filter by originator",children:[e.jsx("option",{value:"",children:"All originators"}),j.map(y=>e.jsx("option",{value:y.value,children:y.label},y.value))]})]})]}),X>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 pt-2 border-t border-brand-navy/10",children:[e.jsx("span",{className:"text-sm text-[var(--muted)]",children:"Active filters:"}),W.map(y=>{const H=o.find(h=>h.value===y);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[(H==null?void 0:H.label)||y,e.jsx("button",{onClick:()=>J(y),className:"hover:text-brand-red","aria-label":`Remove ${(H==null?void 0:H.label)||y} filter`,children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},y)}),t.dateFrom&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["From: ",t.dateFrom,e.jsx("button",{onClick:()=>a({...t,dateFrom:""}),className:"hover:text-brand-red","aria-label":"Remove from date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.dateTo&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["To: ",t.dateTo,e.jsx("button",{onClick:()=>a({...t,dateTo:""}),className:"hover:text-brand-red","aria-label":"Remove to date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.originatorId&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[((Q=j.find(y=>y.value===t.originatorId))==null?void 0:Q.label)||"Originator",e.jsx("button",{onClick:()=>a({...t,originatorId:""}),className:"hover:text-brand-red","aria-label":"Remove originator filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]})]})};function Bs(t,a){return s.useMemo(()=>{let o=Array.isArray(a.items)?a.items:[];const j=Array.isArray(t.status)?t.status:[];if(t.search){const d=t.search.toLowerCase();o=o.filter(R=>a.getSearchText(R).toLowerCase().includes(d))}return j.length>0&&a.getStatus&&(o=o.filter(d=>j.includes(a.getStatus(d)))),(t.dateFrom||t.dateTo)&&a.getDate&&(o=o.filter(d=>{const R=a.getDate(d);if(!R)return!1;const I=new Date(R);if(isNaN(I.getTime()))return!1;if(t.dateFrom){const A=new Date(t.dateFrom);if(I<A)return!1}if(t.dateTo){const A=new Date(t.dateTo);if(A.setHours(23,59,59,999),I>A)return!1}return!0})),t.originatorId&&a.getOriginatorId&&(o=o.filter(d=>a.getOriginatorId(d)===t.originatorId)),o},[t,a])}function Qt(t){if(t==null)return"";const a=String(t);return a.includes('"')||a.includes(",")||a.includes(`
`)||a.includes("\r")?`"${a.replace(/"/g,'""')}"`:a}function Vs(t,a){const j=a.map(R=>Qt(R.header)).join(","),d=t.map(R=>a.map(I=>{const A=I.getValue(R),O=I.format?I.format(A):A;return Qt(O)}).join(","));return[j,...d].join(`\r
`)}function Ws(t,a){const o=t.map(j=>{const d={};return a.forEach(R=>{const I=R.getValue(j);d[R.header]=R.format?R.format(I):I}),d});return JSON.stringify(o,null,2)}function Yt(t,a,o){const j=new Blob([t],{type:`${o};charset=utf-8;`}),d=URL.createObjectURL(j),R=document.createElement("a");R.href=d,R.download=a,document.body.appendChild(R),R.click(),document.body.removeChild(R),URL.revokeObjectURL(d)}function Hs({items:t,columns:a,filename:o="export",label:j="Export",variant:d="secondary",className:R="",disabled:I=!1,showCount:A=!0,formats:O=["csv"]}){const[T,W]=s.useState(!1),[X,S]=s.useState(!1),J=s.useRef(null),z=s.useCallback(ee=>{S(!0),W(!1),setTimeout(()=>{try{const L=new Date().toISOString().slice(0,10),_=`${o}_${L}`;if(ee==="csv"){const Q=Vs(t,a);Yt(Q,`${_}.csv`,"text/csv")}else{const Q=Ws(t,a);Yt(Q,`${_}.json`,"application/json")}}catch(L){console.error("Export failed:",L)}finally{S(!1)}},100)},[t,a,o]);s.useEffect(()=>{const ee=L=>{J.current&&!J.current.contains(L.target)&&W(!1)};return T&&document.addEventListener("mousedown",ee),()=>{document.removeEventListener("mousedown",ee)}},[T]),s.useEffect(()=>{const ee=L=>{L.key==="Escape"&&W(!1)};return T&&document.addEventListener("keydown",ee),()=>{document.removeEventListener("keydown",ee)}},[T]);const V={primary:"bg-brand-navy text-brand-cream hover:bg-brand-navy/90",secondary:"bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold/10",text:"text-brand-navy hover:bg-brand-cream/50"},l=I||t.length===0||X;return O.length===1?e.jsxs("button",{onClick:()=>z(O[0]),disabled:l,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${V[d]}
          ${R}
        `,children:[X?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:j}),A&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]})]}):e.jsxs("div",{className:"relative",ref:J,children:[e.jsxs("button",{onClick:()=>W(!T),disabled:l,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${V[d]}
          ${R}
        `,"aria-expanded":T,"aria-haspopup":"menu",children:[X?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:j}),A&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${T?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),T&&e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-[var(--surface)] border border-brand-navy/20 rounded-lg shadow-lg z-50",role:"menu",children:[O.includes("csv")&&e.jsxs("button",{onClick:()=>z("csv"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 first:rounded-t-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export as CSV"]}),O.includes("json")&&e.jsxs("button",{onClick:()=>z("json"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 last:rounded-b-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})}),"Export as JSON"]})]})]})}const Gt=t=>{if(!t)return"";const a=new Date(t);return isNaN(a.getTime())?"":a.toLocaleDateString()},Us=({request:t})=>{if(!t.ssic)return e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg text-center",children:[e.jsx("div",{className:"text-[var(--muted)] text-sm",children:"No retention schedule assigned"}),e.jsx("div",{className:"text-xs text-[var(--muted)] mt-1",children:"SSIC classification was not set when this request was created"})]});const a=new Date(t.createdAt),o={ssic:t.ssic,nomenclature:t.ssicNomenclature||"",bucket:t.ssicBucket||"",bucketTitle:t.ssicBucketTitle||"",dau:t.dau||"",isPermanent:t.isPermanent||!1,cutoffTrigger:t.cutoffTrigger||"CALENDAR_YEAR",cutoffDescription:t.cutoffDescription||"",retentionValue:t.retentionValue??null,retentionUnit:t.retentionUnit||"YEARS",disposalAction:t.disposalAction||"DESTROY"},j=ps(o,a),d=t.isPermanent||!1;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:`p-4 rounded-lg ${d?"bg-blue-50 border border-blue-200":"bg-amber-50 border border-amber-200"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`text-2xl ${d?"text-blue-600":"text-amber-600"}`,children:d?"ðŸ“":"â±ï¸"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-semibold text-[var(--text)]",children:[t.ssic," - ",t.ssicNomenclature]}),t.ssicBucketTitle&&e.jsx("div",{className:"text-sm text-[var(--muted)] mt-1",children:t.ssicBucketTitle}),e.jsx("div",{className:`text-xs font-medium uppercase tracking-wide mt-2 ${d?"text-blue-600":"text-amber-600"}`,children:d?"Permanent Record":"Temporary Record"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Retention Period"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:hs(o)})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Cutoff Trigger"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:gs(o.cutoffTrigger)}),t.cutoffDescription&&e.jsx("div",{className:"text-xs text-[var(--muted)] mt-1",children:t.cutoffDescription})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Disposal Action"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:d?"Transfer to National Archives":"Destroy"})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Record Created"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:a.toLocaleDateString()})]})]}),!d&&e.jsxs("div",{className:"p-4 bg-[var(--surface)] rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-2",children:"Estimated Disposal Eligibility"}),j?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-2xl font-bold text-brand-navy",children:j.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}),e.jsx("div",{className:"text-sm text-[var(--muted)]",children:j>new Date?e.jsxs(e.Fragment,{children:["(",Math.ceil((j.getTime()-Date.now())/(1e3*60*60*24))," days remaining)"]}):e.jsx("span",{className:"text-green-600 font-medium",children:"Eligible for disposal"})})]}):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"Unable to calculate - may require event date (case closure, separation, etc.)"})]}),t.dau&&e.jsxs("div",{className:"text-xs text-[var(--muted)] border-t border-brand-navy/10 pt-3",children:[e.jsx("span",{className:"font-medium",children:"Disposition Authority:"})," ",t.dau]})]})};function Lt(t,a={}){const{pageSize:o=25,initialPage:j=1}=a,[d,R]=s.useState(j),[I,A]=s.useState(o),O=t.length,T=Math.ceil(O/I),W=(d-1)*I,X=Math.min(W+I,O);return{currentData:s.useMemo(()=>t.slice(W,X),[t,W,X]),currentPage:d,pageSize:I,totalPages:T,totalItems:O,goToPage:_=>{const Q=Math.max(1,Math.min(_,T));R(Q)},nextPage:()=>{d<T&&R(d+1)},previousPage:()=>{d>1&&R(d-1)},goToFirstPage:()=>{R(1)},goToLastPage:()=>{R(T)},setPageSize:_=>{A(_),R(1)},canGoNext:d<T,canGoPrevious:d>1,startIndex:W+1,endIndex:X}}const mt="edms-docs";function zs(){return{uploadFile:async(R,I)=>{if(!Me)return{url:"",error:"Supabase not configured"};try{const{error:A}=await Me.storage.from(mt).upload(I,R,{upsert:!0});if(A)return{url:"",error:A.message};const{data:O}=Me.storage.from(mt).getPublicUrl(I);return{url:(O==null?void 0:O.publicUrl)||""}}catch(A){return{url:"",error:A instanceof Error?A.message:"Upload failed"}}},deleteFile:async R=>{if(!Me||!R)return!1;try{return await Me.storage.from(mt).remove([R]),!0}catch{return!1}},deleteFolder:async R=>{if(!Me)return!1;try{const{data:I}=await Me.storage.from(mt).list(R.replace(/\/$/,""));if(I&&I.length>0){const A=I.map(O=>`${R.replace(/\/$/,"")}/${O.name}`);await Me.storage.from(mt).remove(A)}return!0}catch{return!1}},extractStoragePath:R=>{if(!R)return null;try{const I=R.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(I!=null&&I[1])return decodeURIComponent(I[1])}catch{}return null},buildStoragePath:(R,I,A,O)=>{const T=Date.now();return`${R||"N-A"}/${I}/${T}-${O}-${ss(A)}`}}}const We=t=>{const a=String(t||"").trim();return a&&a!=="N/A"?a:""},st=(t,a,o)=>t.some(j=>String(j.role||"")!==a||We(j.roleCompany||j.company)!==o.company||a==="PLATOON_REVIEWER"&&We(j.rolePlatoon||j.platoon)!==(o.platoon||"")?!1:String(j.unitUic||"")===String(o.uic||""));function ms(t){if(t===0)return"0 Bytes";const a=1024,o=["Bytes","KB","MB","GB"],j=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,j)).toFixed(2))+" "+o[j]}const Jt=s.memo(function({doc:a,onView:o,onDelete:j}){const[d,R]=s.useState(!1),I=a.fileUrl&&Ps(a.type,a.name);return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:"flex items-center justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors","aria-label":`Document: ${a.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx($s,{type:a.type,fileName:a.name,size:"md"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-[var(--text)]",children:a.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)]",children:[a.name," â€¢ ",ms(a.size)," â€¢ ",new Date(a.uploadedAt).toLocaleDateString()]}),a.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(a.dueDate).toLocaleDateString()]}),a.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Notes: ",a.notes]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",role:"group","aria-label":"Document actions",children:[a.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:ls({currentStage:a.currentStage})}),I&&e.jsx("button",{type:"button",onClick:A=>{A.stopPropagation(),R(!0)},className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Preview document ${a.name}`,children:"Preview"}),a.fileUrl&&e.jsx("a",{href:a.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${a.name} in new tab`,children:"Open"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:A=>{A.stopPropagation(),o(a)},"aria-label":`View or edit document ${a.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:A=>{A.stopPropagation(),j(a)},"aria-label":`Delete document ${a.subject}`,children:"Delete"})]})]}),a.fileUrl&&e.jsx(ds,{url:a.fileUrl,fileName:a.name,mimeType:a.type,fileSize:a.size,isOpen:d,onClose:()=>R(!1)})]})}),tt="edms-docs",Qs=({selectedUnit:t,currentUser:a})=>{const[o,j]=s.useState([]),[d,R]=s.useState(!1),[I,A]=s.useState(""),[O,T]=s.useState(""),[W,X]=s.useState(""),[S,J]=s.useState([]),[z,V]=s.useState(null),[l,ee]=s.useState(null),[L,_]=s.useState([]),[Q,y]=s.useState(!1),[H,h]=s.useState(null),[D,q]=s.useState(""),[E,G]=s.useState(""),[C,v]=s.useState(""),[Y,U]=s.useState([]),[K,ie]=s.useState([]),[M,he]=s.useState(null),[je,we]=s.useState(""),[be,Se]=s.useState(""),[fe,N]=s.useState(""),[P,se]=s.useState([]),[le,oe]=s.useState(!1),[Re,Ce]=s.useState({}),[ye,$e]=s.useState(""),[Ae,m]=s.useState("Pending"),[w,Z]=s.useState({}),[ae,ue]=s.useState(""),[p,k]=s.useState(null),[i,c]=s.useState("documents"),[F,te]=s.useState(!1),[me,xe]=s.useState(null),[De,Ne]=s.useState(!1),[pe,Ie]=s.useState(""),Ve=zs(),Ze=r=>{const x=r.target.files?Array.from(r.target.files):[];if(x.length===0)return;if(S.length+x.length>Ht){V({type:"error",message:`Cannot add ${x.length} file(s). Maximum ${Ht} files allowed per request.`});try{r.target.value=""}catch{}return}const f=[],g=[];for(const B of x){const re=fs(B);re.valid?f.push(B):g.push(...re.errors)}f.length>0&&J(B=>[...B,...f]),g.length>0&&V({type:"error",message:g.slice(0,3).join(" ")+(g.length>3?` (+${g.length-3} more errors)`:"")});try{r.target.value=""}catch{}},b=()=>{if(!(M!=null&&M.ssic)){V({type:"error",message:"Request must have SSIC/retention classification before filing."});return}Ie(new Date().toISOString().split("T")[0]),Ne(!0)},ce=async()=>{if(!M||!(l!=null&&l.id))return;if(!pe){V({type:"error",message:"Please select a finalized date."});return}const r=new Date(pe+"T23:59:59").toISOString(),f={actor:`${l.rank} ${l.lastName}, ${l.firstName}${l.mi?` ${l.mi}`:""}`,timestamp:new Date().toISOString(),action:"Filed for Records Management",comment:`Date Finalized: ${new Date(pe).toLocaleDateString()}${fe!=null&&fe.trim()?` - ${fe.trim()}`:""}`},g={...M,currentStage:Je.ARCHIVED,finalStatus:"Filed",filedAt:r,activity:Array.isArray(M.activity)?[...M.activity,f]:[f]};try{const B=await Fe(g);if(!B.ok)throw new Error(qe(B,"request_upsert_failed"));ie(re=>re.map(de=>de.id===g.id?g:de)),he(g),Ne(!1),Ie(""),V({type:"success",message:"Request filed for records management."})}catch(B){V({type:"error",message:`Failed to file request: ${String((B==null?void 0:B.message)||B)}`})}},ve=async()=>{if(!M||!(l!=null&&l.id)||M.uploadedById!==l.id)return;const r=L.find(ge=>ge.id===M.uploadedById),x=M.unitUic||(r==null?void 0:r.unitUic)||"",f=We(r==null?void 0:r.company),g=We(r==null?void 0:r.platoon),B=st(L,"PLATOON_REVIEWER",{company:f,platoon:g,uic:x}),re=st(L,"COMPANY_REVIEWER",{company:f,uic:x}),de=B?Je.PLATOON_REVIEW:re?Je.COMPANY_REVIEW:Je.BATTALION_REVIEW,ne={actor:`${l.rank} ${l.lastName}, ${l.firstName}${l.mi?` ${l.mi}`:""}`,actorRole:"Member",timestamp:new Date().toISOString(),action:"Resubmitted request",comment:(fe||"").trim()},Oe={...M,currentStage:de,routeSection:"",activity:[...M.activity||[],ne]};try{const ge=await Fe(Oe);if(!ge.ok)throw new Error(qe(ge,"request_upsert_failed"));ie(Le=>Le.map(Te=>Te.id===Oe.id?Oe:Te)),he(Oe),N(""),V({type:"success",message:"Request resubmitted for review."})}catch(ge){V({type:"error",message:`Failed to resubmit: ${String((ge==null?void 0:ge.message)||ge)}`})}},Pe=async r=>{r.preventDefault(),V(null);const x=I.trim();if(!x){V({type:"error",message:"Subject is required."});return}if(x.length>500){V({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(W.length>5e3){V({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(l!=null&&l.id)){V({type:"error",message:"Create a profile before submitting."});return}if(S.length>0){const ge=bs(S);if(!ge.valid){V({type:"error",message:ge.errors[0]});return}}R(!0);const f=Date.now(),g=ye||l.id,B=L.find(ge=>ge.id===g),re=t?t.uic:(B==null?void 0:B.unitUic)||"N/A",de=`req-${f}`;let ne=[];async function Oe(ge,Le){if(!Me)throw new Error("Supabase not configured");const{error:Te}=await Me.storage.from(tt).upload(Le,ge,{upsert:!0});if(Te)throw new Error(Te.message);const{data:Ye}=Me.storage.from(tt).getPublicUrl(Le);return(Ye==null?void 0:Ye.publicUrl)||""}if(S&&S.length>0){const ge=[];for(let Le=0;Le<S.length;Le++){const Te=S[Le],Ye=`${re}/${de}/${f}-${Le}-${ss(Te.name)}`;try{const Ge=await Oe(Te,Ye);ge.push(Ge)}catch(Ge){R(!1),V({type:"error",message:`Failed to upload ${Te.name}: ${String((Ge==null?void 0:Ge.message)||Ge)}`});return}}ne=S.map((Le,Te)=>({id:`${f}-${Te}`,name:Le.name,type:Le.type,size:Le.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:re,subject:I.trim(),dueDate:O||void 0,notes:W.trim()||void 0,uploadedById:g,currentStage:"PLATOON_REVIEW",fileUrl:ge[Te]}))}ne=ne.map(ge=>({...ge,requestId:de})),j(ge=>[...ge,...ne]),J([]),A(""),T(""),X("");try{const ge=l?`${l.rank} ${l.lastName}, ${l.firstName}${l.mi?` ${l.mi}`:""}`:"Unknown",Le="Member",Te=re,Ye=We(B==null?void 0:B.company),Ge=We(B==null?void 0:B.platoon),Bt=st(L,"PLATOON_REVIEWER",{company:Ye,platoon:Ge,uic:Te}),Vt=st(L,"COMPANY_REVIEWER",{company:Ye,uic:Te}),xs=!Bt&&!Vt,dt={id:de,subject:I.trim(),dueDate:O||void 0,notes:W.trim()||void 0,unitUic:re,uploadedById:g,submitForUserId:g,documentIds:ne.map(_e=>_e.id),createdAt:new Date().toISOString(),currentStage:Bt?Je.PLATOON_REVIEW:Vt?Je.COMPANY_REVIEW:Je.BATTALION_REVIEW,routeSection:xs&&ae?ae:void 0,ssic:p==null?void 0:p.ssic,ssicNomenclature:p==null?void 0:p.nomenclature,ssicBucket:p==null?void 0:p.bucket,ssicBucketTitle:p==null?void 0:p.bucketTitle,isPermanent:p==null?void 0:p.isPermanent,retentionValue:p==null?void 0:p.retentionValue,retentionUnit:p==null?void 0:p.retentionUnit,cutoffTrigger:p==null?void 0:p.cutoffTrigger,cutoffDescription:p==null?void 0:p.cutoffDescription,disposalAction:p==null?void 0:p.disposalAction,dau:p==null?void 0:p.dau,activity:[{actor:ge,actorRole:Le,timestamp:new Date().toISOString(),action:"Submitted request",comment:(W||"").trim()}]};try{const _e=await Fe(dt);if(!_e.ok)throw new Error(qe(_e,"request_upsert_failed"));const It=await Pt(ne);if(!It.ok)throw new Error(qe(It,"document_upsert_failed"))}catch(_e){R(!1);try{Dt("request_persist_failed",{requestId:de,error:String((_e==null?void 0:_e.message)||_e)},"error")}catch{}V({type:"error",message:`Failed to persist submission: ${String((_e==null?void 0:_e.message)||_e)}`});return}ie(_e=>_e.some(ft=>ft.id===dt.id)?_e.map(ft=>ft.id===dt.id?dt:ft):[..._e,dt]),R(!1),V({type:"success",message:"Submission successful."}),y(!1),ue(""),k(null)}catch{R(!1);try{Dt("request_persist_failed",{requestId:de},"error")}catch{}V({type:"error",message:"Failed to persist submission."})}},ze=s.useCallback(r=>{h(r),q(r.subject||""),G(r.dueDate||""),v(r.notes||"");try{const x=localStorage.getItem(`fs/requests/${r.requestId}.json`);if(x){const f=JSON.parse(x);U(Array.isArray(f.activity)?f.activity:[])}else{const B=Object.values(Object.assign({})).map(re=>(re==null?void 0:re.default)??re).find(re=>re&&re.id===r.requestId);U(B&&Array.isArray(B.activity)?B.activity:[])}}catch{U([])}},[]),qe=(r,x)=>{var f;return String(((f=r.error)==null?void 0:f.message)||r.error||x)},ke=async()=>{if(!H)return;const r=o.map(x=>x.id===H.id?{...x,subject:D.trim()||x.subject,dueDate:E||void 0,notes:C.trim()||void 0}:x);j(r);try{const g={actor:l?`${l.rank} ${l.lastName}, ${l.firstName}${l.mi?` ${l.mi}`:""}`:"Unknown",actorRole:"Member",timestamp:new Date().toISOString(),action:"Updated document",comment:(C||"").trim()},B=H.requestId?K.find(re=>re.id===H.requestId):null;if(B){const re={...B,activity:Array.isArray(B.activity)?[...B.activity,g]:[g]};try{const de=await Fe(re);if(!de.ok)throw new Error(qe(de,"request_upsert_failed"))}catch(de){console.error("Failed to save document edits:",de),V({type:"error",message:`Failed to save document edits: ${de.message}`});return}U(de=>[...de,g])}}catch{}v(""),h(null)};o.filter(r=>!(!(l!=null&&l.id)||l.role==="MEMBER"&&r.uploadedById!==l.id||r.type==="request"));const Qe=r=>r.currentStage==="ORIGINATOR_REVIEW",et=()=>String((l==null?void 0:l.role)||"").includes("REVIEW"),xt=()=>{if(!et())return[];const r=String((l==null?void 0:l.role)||"");return L.filter(x=>{if(x.id===(l==null?void 0:l.id))return!1;if(r.includes("PLATOON")){const f=x.company&&x.company!=="N/A"?x.company:"",g=x.unit&&x.unit!=="N/A"?x.unit:"",B=l!=null&&l.company&&l.company!=="N/A"?l.company:"",re=l!=null&&l.unit&&l.unit!=="N/A"?l.unit:"";return f===B&&g===re}if(r.includes("COMPANY")){const f=x.company&&x.company!=="N/A"?x.company:"",g=l!=null&&l.company&&l.company!=="N/A"?l.company:"";return f===g}return r.includes("COMMANDER")?(x.unitUic||"")===((l==null?void 0:l.unitUic)||""):!1})},ot=s.useCallback(async r=>{const x=Ve.extractStoragePath(r.fileUrl);try{x&&Me&&await Me.storage.from(tt).remove([x])}catch{}try{await ws(r.id),j(f=>f.filter(g=>g.id!==r.id)),r.requestId&&ie(f=>f.map(g=>g.id===r.requestId?{...g,documentIds:(g.documentIds||[]).filter(B=>B!==r.id)}:g)),V({type:"success",message:"Document deleted."})}catch(f){V({type:"error",message:`Failed to delete: ${String((f==null?void 0:f.message)||f)}`})}},[]),nt=s.useCallback(async r=>{const x=`${r.unitUic||"N-A"}/${r.id}/`;try{if(Me){const{data:f}=await Me.storage.from(tt).list(x.slice(0,-1));if(f&&f.length>0){const g=f.map(B=>`${x.slice(0,-1)}/${B.name}`);await Me.storage.from(tt).remove(g)}}}catch{}try{await Ss(r.id),await Cs(r.id),j(f=>f.filter(g=>g.requestId!==r.id)),ie(f=>f.filter(g=>g.id!==r.id)),he(null),V({type:"success",message:"Request and files deleted."})}catch(f){V({type:"error",message:`Failed to delete request: ${String((f==null?void 0:f.message)||f)}`})}},[]),pt=async()=>{if(!M||!(l!=null&&l.id)||M.uploadedById!==l.id){V({type:"error",message:"Only the requester can edit this."});return}const r=Date.now(),x=de=>de.replace(/[^A-Za-z0-9._-]/g,"-");async function f(de,ne){if(!Me)throw new Error("Supabase not configured");const{error:Oe}=await Me.storage.from(tt).upload(ne,de,{upsert:!0});if(Oe)throw new Error(Oe.message);const{data:ge}=Me.storage.from(tt).getPublicUrl(ne);return(ge==null?void 0:ge.publicUrl)||""}const g=[];for(let de=0;de<P.length;de++){const ne=P[de],Oe=`${M.unitUic||"N-A"}/${M.id}/${r}-${de}-${x(ne.name)}`;try{const ge=await f(ne,Oe);g.push(ge)}catch(ge){V({type:"error",message:`Failed to upload ${ne.name}: ${String((ge==null?void 0:ge.message)||ge)}`});return}}const B=P.map((de,ne)=>({id:`${r}-${ne}`,name:de.name,type:de.type,size:de.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:M.unitUic||"N/A",subject:je.trim()||M.subject,dueDate:be||void 0,notes:fe.trim()||void 0,uploadedById:l.id,currentStage:M.currentStage||"PLATOON_REVIEW",requestId:M.id,fileUrl:g[ne]})),re={...M,subject:je.trim()||M.subject,dueDate:be||void 0,notes:fe.trim()||void 0,documentIds:[...M.documentIds||[],...B.map(de=>de.id)],activity:[...M.activity||[],{actor:`${l.rank} ${l.lastName}, ${l.firstName}${l.mi?` ${l.mi}`:""}`,timestamp:new Date().toISOString(),action:B.length?`Updated request and added ${B.length} document(s)`:"Updated request",comment:(fe||"").trim()}]};try{if(!(l&&Ms(M,String(l.id||"")))){V({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const ne=await Pt(B);if(!ne.ok)throw new Error(qe(ne,"document_upsert_failed"));const Oe=await Fe(re);if(!Oe.ok)throw new Error(qe(Oe,"request_upsert_failed"))}catch(ne){try{Dt("request_update_failed",{requestId:re.id,error:String((ne==null?void 0:ne.message)||ne)},"error")}catch{}V({type:"error",message:`Failed to persist documents: ${String((ne==null?void 0:ne.message)||ne)}`});return}j(ne=>[...ne,...B]),ie(ne=>ne.map(Oe=>Oe.id===re.id?re:Oe)),he(re),se([]),N(""),V({type:"success",message:B.length?"Files added and request updated.":"Request updated."})}catch{V({type:"error",message:"Failed to update request."})}},wt=async()=>{if(!M||!l||!me)return;const r=`${l.rank} ${l.lastName}, ${l.firstName}${l.mi?` ${l.mi}`:""}`,x=l.role||"Reviewer",f={actor:r,actorRole:x,timestamp:new Date().toISOString(),action:"Updated retention classification",comment:`Changed SSIC to ${me.ssic} - ${me.nomenclature}`},g={...M,ssic:me.ssic,ssicNomenclature:me.nomenclature,ssicBucket:me.bucket,ssicBucketTitle:me.bucketTitle,isPermanent:me.isPermanent,retentionValue:me.retentionValue,retentionUnit:me.retentionUnit,cutoffTrigger:me.cutoffTrigger,cutoffDescription:me.cutoffDescription,disposalAction:me.disposalAction,dau:me.dau,activity:[...M.activity||[],f]};try{const B=await Fe(g);if(!B.ok)throw new Error(qe(B,"request_upsert_failed"));ie(re=>re.map(de=>de.id===g.id?g:de)),he(g),te(!1),xe(null),V({type:"success",message:"Retention classification updated."})}catch(B){V({type:"error",message:`Failed to update retention: ${String((B==null?void 0:B.message)||B)}`})}},[ht,St]=s.useState(!0),[ct,Ct]=s.useState(!0);s.useEffect(()=>{qt().then(r=>{j(r)}).catch(()=>j([])).finally(()=>St(!1))},[]),s.useEffect(()=>{M&&(we(M.subject||""),Se(M.dueDate||""),N(M.notes||""),se([]),te(!1),xe(null))},[M]),s.useEffect(()=>{},[o]),s.useEffect(()=>{vt().then(r=>{ie(r)}).catch(()=>ie([])).finally(()=>Ct(!1))},[]),s.useEffect(()=>{ee(a||null)},[a]),s.useEffect(()=>{it().then(r=>{_(r)}).catch(()=>_([]))},[]),s.useEffect(()=>{try{const r=localStorage.getItem("unit_structure"),x={};if(r){const f=JSON.parse(r);for(const g of Object.keys(f||{})){const B=f[g];B&&Array.isArray(B._sections)&&(x[g]=B._sections)}Z(x)}else(async()=>{try{const f=await jt();for(const g of Object.keys(f||{})){const B=f[g];B&&Array.isArray(B._sections)&&(x[g]=B._sections)}Z(x)}catch{}})()}catch{}},[]);const At=s.useMemo(()=>l!=null&&l.id?K.filter(x=>x.uploadedById===l.id).filter(x=>x.currentStage!=="ARCHIVED"):[],[K,l]),gt=s.useCallback(r=>{if(r.isPermanent)return"Permanent";if(!r.retentionValue||!r.cutoffTrigger||!r.filedAt)return"Unknown";const x=new Date(r.filedAt);let f;switch(r.cutoffTrigger){case"CALENDAR_YEAR":f=new Date(x.getFullYear(),11,31);break;case"FISCAL_YEAR":f=x.getMonth()>=9?new Date(x.getFullYear()+1,8,30):new Date(x.getFullYear(),8,30);break;default:f=x}const g=new Date(f);return r.retentionUnit==="years"?g.setFullYear(g.getFullYear()+r.retentionValue):r.retentionUnit==="months"?g.setMonth(g.getMonth()+r.retentionValue):r.retentionUnit==="days"&&g.setDate(g.getDate()+r.retentionValue),g.getFullYear().toString()},[]),lt=s.useMemo(()=>{if(!(l!=null&&l.id))return{};const r=K.filter(f=>f.uploadedById===l.id&&f.ssic&&f.filedAt),x={};for(const f of r){const g=gt(f),B=f.ssicBucketTitle||f.ssicBucket||"Uncategorized";x[g]||(x[g]={}),x[g][B]||(x[g][B]=[]),x[g][B].push(f)}for(const f of Object.keys(x))for(const g of Object.keys(x[f]))x[f][g].sort((B,re)=>new Date(re.createdAt).getTime()-new Date(B.createdAt).getTime());return x},[K,l,gt]),bt=s.useMemo(()=>Object.keys(lt).sort((x,f)=>x==="Permanent"?-1:f==="Permanent"||x==="Unknown"?1:f==="Unknown"?-1:parseInt(x)-parseInt(f)),[lt]),kt=s.useCallback(r=>{if(!r.retentionValue||!r.cutoffTrigger||!r.filedAt)return"N/A";if(r.isPermanent)return"Permanent";const x=new Date(r.filedAt);let f;switch(r.cutoffTrigger){case"CALENDAR_YEAR":f=new Date(x.getFullYear(),11,31);break;case"FISCAL_YEAR":f=x.getMonth()>=9?new Date(x.getFullYear()+1,8,30):new Date(x.getFullYear(),8,30);break;default:f=x}const g=new Date(f);return r.retentionUnit==="years"?g.setFullYear(g.getFullYear()+r.retentionValue):r.retentionUnit==="months"?g.setMonth(g.getMonth()+r.retentionValue):r.retentionUnit==="days"&&g.setDate(g.getDate()+r.retentionValue),g.toLocaleDateString()},[]),Et=s.useCallback(r=>{var f;const x=L.find(g=>g.id===r.uploadedById);return x?`${x.lastName}, ${((f=x.firstName)==null?void 0:f.charAt(0))||""}`:"Unknown"},[L]),Ee=Lt(At,{pageSize:10}),Rt=s.useMemo(()=>L.reduce((r,x)=>({...r,[x.id]:x}),{}),[L]),n=s.useMemo(()=>{const r=ye||(l==null?void 0:l.id),x=L.find(ne=>ne.id===r),f=t?t.uic:(x==null?void 0:x.unitUic)||"",g=We(x==null?void 0:x.company),B=We(x==null?void 0:x.platoon);if(!f)return!1;const re=st(L,"PLATOON_REVIEWER",{company:g,platoon:B,uic:f}),de=st(L,"COMPANY_REVIEWER",{company:g,uic:f});return!re&&!de},[L,l,ye,t]),u=s.useMemo(()=>{const r=ye||(l==null?void 0:l.id),x=L.find(g=>g.id===r),f=t?t.uic:(x==null?void 0:x.unitUic)||"";return w[f]||[]},[w,L,l,ye,t]),$=s.useCallback(r=>{const x=We(r.currentStage||"PLATOON_REVIEW"),f=L.find(g=>g.id===r.uploadedById);switch(x){case"ORIGINATOR_REVIEW":return{level:"Member",scope:""};case"PLATOON_REVIEW":{const g=f!=null&&f.company&&f.company!=="N/A"?f.company:"",B=f!=null&&f.platoon&&f.platoon!=="N/A"?f.platoon:"";return g&&B?{level:"Platoon",scope:`(${g}-${B})`}:g?{level:"Platoon",scope:`(${g})`}:{level:"Platoon",scope:""}}case"COMPANY_REVIEW":{const g=f!=null&&f.company&&f.company!=="N/A"?f.company:"";return{level:"Company",scope:g?`(${g})`:""}}case"BATTALION_REVIEW":return{level:"Battalion",scope:r.routeSection?`(${r.routeSection})`:""};case"COMMANDER_REVIEW":return{level:"Commander",scope:r.routeSection?`(${r.routeSection})`:""};case"ARCHIVED":return{level:"Archived",scope:""};default:return{level:ls(r),scope:""}}},[L]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>y(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),Q&&e.jsxs("form",{onSubmit:Pe,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:I,onChange:r=>A(r.target.value),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${I.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:O,onChange:r=>T(r.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),e.jsx("div",{children:e.jsx(Wt,{value:p,onChange:k,required:!0})}),String((l==null?void 0:l.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:ye,onChange:r=>$e(r.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),xt().map(r=>e.jsxs("option",{value:r.id,children:[r.rank," ",r.lastName,", ",r.firstName,r.mi?` ${r.mi}`:""]},r.id))]})]})}),n&&u.length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Battalion Section"}),e.jsxs("select",{value:ae,onChange:r=>ue(r.target.value),className:`w-full px-3 py-2 border ${ae?"border-brand-navy/30":"border-brand-gold"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`,children:[e.jsx("option",{value:"",children:"Select section"}),u.map(r=>e.jsx("option",{value:r,children:r},r))]}),e.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"No platoon/company reviewer available. Select a section for routing."})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:W,onChange:r=>X(r.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:Ze,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:S.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:S.map((r,x)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:r.name,children:r.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>J(f=>f.filter((g,B)=>B!==x)),children:"Delete"})]},x))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{y(!1),J([]),A(""),T(""),X(""),ue(""),k(null),V(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!I.trim()||!p,children:"Submit"})]})]}),z&&e.jsx("div",{className:`p-3 rounded-lg border ${z.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:z.message})]})]}),e.jsxs("div",{className:"p-6",children:[l&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>m("Pending"),className:`${Ae==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>m("Files"),className:`${Ae==="Files"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Files"})]})}),Ae==="Pending"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:Ee.totalItems>0?`${Ee.startIndex}â€“${Ee.endIndex} of ${Ee.totalItems}`:""}),ct&&e.jsx("div",{className:"animate-pulse",children:"Loading requestsâ€¦"})]}),e.jsx(Xe,{title:"Your Requests",requests:ct?Array.from({length:5}).map((r,x)=>({id:`s-${x}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:Je.PLATOON_REVIEW})):Ee.currentData,users:Rt,onRowClick:r=>he(r),expandedRows:Re,children:r=>e.jsxs("div",{id:`req-docs-${r.id}`,children:[ht?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):o.filter(x=>x.requestId===r.id&&x.type!=="request").map(x=>e.jsx(Jt,{doc:x,onView:ze,onDelete:ot},x.id)),!ht&&o.filter(x=>x.requestId===r.id&&x.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),Ee.totalItems>0&&e.jsx(_t,{currentPage:Ee.currentPage,totalPages:Ee.totalPages,totalItems:Ee.totalItems,pageSize:Ee.pageSize,startIndex:Ee.startIndex,endIndex:Ee.endIndex,onPageChange:Ee.goToPage,onPageSizeChange:Ee.setPageSize,onNext:Ee.nextPage,onPrevious:Ee.previousPage,onFirst:Ee.goToFirstPage,onLast:Ee.goToLastPage,canGoNext:Ee.canGoNext,canGoPrevious:Ee.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),Ae==="Files"&&e.jsx("div",{className:"py-4 space-y-6",children:ct?e.jsx("div",{className:"animate-pulse",children:"Loading recordsâ€¦"}):bt.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("p",{children:"No filed records yet."}),e.jsx("p",{className:"text-sm mt-1",children:'Archive a request and click "File" to add it to records management.'})]}):e.jsx(e.Fragment,{children:bt.map(r=>{const x=lt[r],f=Object.keys(x).sort(),g=r==="Permanent",B=Object.values(x).reduce((re,de)=>re+de.length,0);return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`${g?"bg-blue-800":"bg-brand-navy"} text-brand-cream px-4 py-2 rounded-lg font-medium flex items-center justify-between`,children:[e.jsx("span",{children:g?"Permanent Records":`Disposal Year: ${r}`}),e.jsxs("span",{className:"text-xs bg-white/20 px-2 py-0.5 rounded",children:[B," record",B!==1?"s":""]})]}),f.map(re=>{const de=x[re];return e.jsxs("div",{className:"ml-4",children:[e.jsxs("div",{className:"bg-gray-100 text-gray-700 px-3 py-1.5 rounded-t-lg font-medium text-sm border border-b-0 border-gray-200 flex items-center justify-between",children:[e.jsx("span",{children:re}),e.jsxs("span",{className:"text-xs text-gray-500",children:[de.length," item",de.length!==1?"s":""]})]}),e.jsx("div",{className:"border border-gray-200 rounded-b-lg overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Name"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"SSIC"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Retention"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Disposal Date"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Date Finalized"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Originator"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Disposal Action"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:de.map(ne=>e.jsxs("tr",{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>he(ne),children:[e.jsx("td",{className:"px-3 py-2 font-medium text-brand-navy",children:ne.subject}),e.jsx("td",{className:"px-3 py-2",children:ne.ssic}),e.jsx("td",{className:"px-3 py-2",children:ne.isPermanent?e.jsx("span",{className:"inline-flex px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded",children:"Permanent"}):e.jsxs("span",{className:"inline-flex px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded",children:[ne.retentionValue," ",ne.retentionUnit]})}),e.jsx("td",{className:"px-3 py-2",children:kt(ne)}),e.jsx("td",{className:"px-3 py-2",children:ne.filedAt?new Date(ne.filedAt).toLocaleDateString():"N/A"}),e.jsx("td",{className:"px-3 py-2",children:Et(ne)}),e.jsx("td",{className:"px-3 py-2",children:ne.disposalAction||(ne.isPermanent?"TRANSFER":"DESTROY")})]},ne.id))})]})})]},`${r}-${re}`)})]},r)})})})]}),d&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),H&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>h(null),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:D,onChange:r=>q(r.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:E,onChange:r=>G(r.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:H.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:C,onChange:r=>v(r.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[H.name," â€¢ ",ms(H.size)," â€¢ ",new Date(H.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:Y.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):Y.map((r,x)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[r.actor,r.actorRole?` â€¢ ${r.actorRole}`:""," â€¢ ",new Date(r.timestamp).toLocaleString()," â€¢ ",r.action]}),r.comment&&e.jsx("div",{className:"text-gray-600",children:r.comment})]},x))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>h(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:ke,children:"Save"})]})]})}),M&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>he(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>he(null),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:je,onChange:r=>we(r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(M.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:be,onChange:r=>Se(r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),M.currentStage&&(()=>{const{level:r,scope:x}=$(M);return e.jsxs("span",{className:"inline-flex flex-col items-center px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-lg border border-brand-navy/30 leading-tight",children:[e.jsx("span",{children:r}),x&&e.jsx("span",{className:"text-[10px]",children:x})]})})(),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:3,value:fe,onChange:r=>N(r.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-4","aria-label":"Request details tabs",children:[e.jsx("button",{onClick:()=>c("documents"),className:`${i==="documents"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Documents"}),e.jsx("button",{onClick:()=>c("retention"),className:`${i==="retention"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Retention"}),e.jsx("button",{onClick:()=>c("activity"),className:`${i==="activity"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Activity"})]})}),e.jsxs("div",{className:"mt-3",children:[i==="documents"&&e.jsxs("div",{className:"space-y-3",children:[o.filter(r=>r.requestId===M.id&&r.type!=="request").length>0?o.filter(r=>r.requestId===M.id&&r.type!=="request").map(r=>e.jsx(Jt,{doc:r,onView:ze,onDelete:ot},r.id)):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents attached"}),!zt(M,String((l==null?void 0:l.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:r=>{const x=r.target.files?Array.from(r.target.files):[];se(f=>[...f,...x]);try{r.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2 mt-2",children:P.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):P.map((r,x)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:r.name,children:r.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>se(f=>f.filter((g,B)=>B!==x)),children:"Delete"})]},x))})]})]}),i==="retention"&&e.jsx("div",{children:F?e.jsxs("div",{className:"space-y-4",children:[e.jsx(Wt,{value:me,onChange:xe,required:!0}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{te(!1),xe(null)},className:"px-3 py-1 rounded border border-brand-navy/30 text-brand-navy hover:bg-brand-cream text-sm",children:"Cancel"}),e.jsx("button",{type:"button",onClick:wt,disabled:!me,className:"px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 text-sm disabled:opacity-50",children:"Save Retention"})]})]}):e.jsxs("div",{children:[M.ssic?e.jsx(Us,{request:M}):e.jsx("div",{className:"text-sm text-[var(--muted)] p-4 bg-gray-50 rounded-lg",children:"No retention information available for this request."}),l&&M.currentStage!=="ARCHIVED"&&e.jsx("button",{type:"button",onClick:()=>te(!0),className:"mt-3 px-3 py-1 rounded border border-brand-navy/30 text-brand-navy hover:bg-brand-cream text-sm",children:M.ssic?"Change Retention":"Add Retention Info"})]})}),i==="activity"&&e.jsx("div",{className:"space-y-2",children:M.activity&&M.activity.length?M.activity.map((r,x)=>e.jsxs("div",{className:"text-xs text-gray-700 p-2 bg-gray-50 rounded",children:[e.jsxs("div",{className:"font-medium",children:[r.actor,r.actorRole?` â€¢ ${r.actorRole}`:""," â€¢ ",new Date(r.timestamp).toLocaleString()," â€¢ ",r.action]}),r.comment&&e.jsx("div",{className:"text-gray-600 mt-1",children:r.comment})]},x)):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No activity recorded"})})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>he(null),children:"Close"}),zt(M,String((l==null?void 0:l.id)||""))&&!M.filedAt?e.jsx("button",{className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700",onClick:b,children:"File"}):M.filedAt?null:e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:pt,disabled:!l||l.id!==((M==null?void 0:M.uploadedById)||""),children:"Save Changes"}),l&&Qe(M)&&l.id===M.uploadedById&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700",onClick:ve,children:"Resubmit"}),l&&Ds(M,String((l==null?void 0:l.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>nt(M),children:"Delete Request"})]})]})}),De&&M&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]",onClick:()=>Ne(!1),children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md p-6",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"File for Records Management"}),e.jsx("button",{className:"text-gray-500 hover:text-gray-700",onClick:()=>Ne(!1),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date Finalized"}),e.jsx("input",{type:"date",value:pe,onChange:r=>Ie(r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"This date will be used to calculate the disposal date based on the retention schedule."})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 text-sm",children:[e.jsx("div",{className:"font-medium text-gray-700 mb-1",children:"Retention Info"}),e.jsxs("div",{className:"text-gray-600",children:[e.jsxs("div",{children:["SSIC: ",M.ssic," - ",M.ssicNomenclature]}),e.jsxs("div",{children:["Retention: ",M.isPermanent?"Permanent":`${M.retentionValue} ${M.retentionUnit}`]}),e.jsxs("div",{children:["Cutoff: ",M.cutoffDescription||M.cutoffTrigger]})]})]}),z&&e.jsx("div",{className:`p-3 rounded-lg border ${z.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:z.message})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>Ne(!1),className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"button",onClick:ce,disabled:!pe,className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50",children:"File Record"})]})]})})]})},Ys=({currentUser:t,onClose:a})=>{const[o,j]=s.useState([]),[d,R]=s.useState(""),[I,A]=s.useState(!1),[O,T]=s.useState(""),[W,X]=s.useState(!1),[S,J]=s.useState("");s.useEffect(()=>{Nt().then(_=>{j(_.data||[])}).catch(()=>j([]))},[]);const z=s.useMemo(()=>String(t.role||"")!=="MEMBER",[t]),V=s.useMemo(()=>{const _=Q=>{const y=t.unitUic||"",H=String(t.role||"");if(H.includes("PLATOON")){const h=Q.company&&Q.company!=="N/A"?Q.company:"",D=Q.platoon&&Q.platoon!=="N/A"?Q.platoon:"",q=t.company&&t.company!=="N/A"?t.company:"",E=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return h===q&&D===E}if(H.includes("COMPANY")){const h=Q.company&&Q.company!=="N/A"?Q.company:"",D=t.company&&t.company!=="N/A"?t.company:"";return h===D}return H.includes("COMMANDER")?(Q.unitUic||"")===y:!1};return o.filter(Q=>Q.id!==t.id&&_(Q))},[o,t]),l=s.useMemo(()=>{const _=String(t.role||""),Q=y=>{const H=t.unitUic||"";if(_.includes("PLATOON")){const h=y.company&&y.company!=="N/A"?y.company:"",D=y.platoon&&y.platoon!=="N/A"?y.platoon:"",q=t.company&&t.company!=="N/A"?t.company:"",E=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return h===q&&D===E}if(_.includes("COMPANY")){const h=y.company&&y.company!=="N/A"?y.company:"",D=t.company&&t.company!=="N/A"?t.company:"";return h===D}return _.includes("COMMANDER")?(y.unitUic||"")===H:!1};return o.filter(y=>y.id!==t.id&&Q(y)&&String(y.role||"")===_)},[o,t]),ee=async()=>{try{A(!0),T("");const _=o.find(h=>h.id===d);if(!z||!_){A(!1);return}const Q=String(t.role||""),y={..._};if(y.role=Q,Q.includes("PLATOON")){y.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A";const h=t.platoon&&t.platoon!=="N/A"?t.platoon:"N/A";y.rolePlatoon=h}else Q.includes("COMPANY")?(y.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A",y.rolePlatoon="N/A"):Q.includes("COMMANDER")&&(y.roleCompany="N/A",y.rolePlatoon="N/A");try{if(!(await Ke({id:y.id,email:y.email,rank:y.rank,firstName:y.firstName,lastName:y.lastName,mi:y.mi,service:y.service,role:y.role,unitUic:y.unitUic,unit:y.unit,company:y.company,isUnitAdmin:!!y.isUnitAdmin,isCommandStaff:!!y.isCommandStaff,edipi:y.edipi,passwordHash:y.passwordHash,roleCompany:y.roleCompany,rolePlatoon:y.rolePlatoon})).ok)throw new Error("persist_failed")}catch{T("Failed to persist user changes")}const H={actorId:t.id,actorRole:t.role,targetId:y.id,grantedRole:y.role,timestamp:new Date().toISOString(),scope:{unitUic:t.unitUic||"",company:t.company,unit:t.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(H)})}catch{}j(h=>h.map(D=>D.id===y.id?y:D)),R(""),X(!1),A(!1)}catch{A(!1),T("Operation failed")}},L=async _=>{try{A(!0),T("");const Q=o.find(q=>q.id===_);if(!Q){A(!1);return}const y=String(t.role||"");if(!l.some(q=>q.id===_)){A(!1),T("Target not in scope");return}const h={...Q};h.role="MEMBER",h.company="N/A",h.unit="N/A",h.isCommandStaff=!1,h.roleCompany="N/A",h.rolePlatoon="N/A";try{if(!(await Ke({id:h.id,email:h.email,rank:h.rank,firstName:h.firstName,lastName:h.lastName,mi:h.mi,service:h.service,role:h.role,unitUic:h.unitUic,unit:h.unit,company:h.company,isUnitAdmin:!!h.isUnitAdmin,isCommandStaff:!!h.isCommandStaff,edipi:h.edipi,passwordHash:h.passwordHash,roleCompany:h.roleCompany,rolePlatoon:h.rolePlatoon})).ok)throw new Error("persist_failed")}catch{T("Failed to persist user changes")}const D={actorId:t.id,actorRole:t.role,targetId:h.id,action:"Revoked",previousRole:y,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(D)})}catch{}j(q=>q.map(E=>E.id===h.id?h:E)),J(""),A(!1)}catch{A(!1),T("Operation failed")}};return z?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:a,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:_=>_.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:a,children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:d,onChange:_=>R(_.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),V.map(_=>e.jsxs("option",{value:_.id,children:[_.rank," ",_.lastName,", ",_.firstName,_.mi?` ${_.mi}`:""," â€¢ ",_.email]},_.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[l.map(_=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[_.rank," ",_.lastName,", ",_.firstName,_.mi?` ${_.mi}`:""," â€¢ ",_.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>J(_.id),children:"Remove Access"})]},_.id)),l.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),O&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:O})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!d||I,onClick:()=>X(!0),children:"Grant Equivalent Permission"})}),W&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>X(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:I,onClick:ee,children:"Confirm"})]})]}),S&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>J(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:I,onClick:()=>L(S),children:"Remove"})]})]})]})}):null},Kt="ORIGINATOR_REVIEW",He=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Gs=[{value:"PLATOON_REVIEW",label:"Platoon Review"},{value:"COMPANY_REVIEW",label:"Company Review"},{value:"BATTALION_REVIEW",label:"Battalion Review"},{value:"COMMANDER_REVIEW",label:"Commander Review"},{value:"ARCHIVED",label:"Archived"}],Js={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},Ks=t=>{const a=He.indexOf(t||He[0]);return a>=0&&a<He.length-1?He[a+1]:He[a]||He[0]},Xt=t=>{const a=He.indexOf(t||He[0]);return a>0?He[a-1]:He[0]},yt=(t,a)=>{var o;return((o=t.activity)==null?void 0:o.some(j=>a.test(String(j.action||""))))||!1},Xs=t=>yt(t,/(approved by commander|commander.*approved)/i)&&!yt(t,/installation commander/i),Zs=t=>yt(t,/(endorsed by commander|commander.*endorsed)/i)&&!yt(t,/installation commander/i),Mt=t=>{if(!t)return"MEMBER";const a=String(t.role||"MEMBER"),o=(t.roleCompany||t.company||"").trim(),j=(t.rolePlatoon||t.platoon||"").trim();switch(a){case"PLATOON_REVIEWER":if(o&&j)return`Platoon (${o}-${j})`;break;case"COMPANY_REVIEWER":if(o)return`Company (${o})`;break;case"BATTALION_REVIEWER":return"Battalion";case"COMMANDER_REVIEWER":return"Commander"}return a};function ea(){const t=ys(),[a,o]=s.useState(()=>{try{const i=localStorage.getItem("currentUser");return i?JSON.parse(i):null}catch(i){return console.error("Failed to parse user from localStorage:",i),null}}),[j,d]=s.useState([]),[R,I]=s.useState([]),[A,O]=s.useState({}),[T,W]=s.useState({}),[X,S]=s.useState({}),[J,z]=s.useState({}),[V,l]=s.useState({}),[ee,L]=s.useState({}),[_,Q]=s.useState({}),[y,H]=s.useState(!1),[h,D]=s.useState({}),[q,E]=s.useState({}),[G,C]=s.useState(!1),[v,Y]=s.useState({}),[U,K]=s.useState(null),ie=s.useRef(null),[M,he]=s.useState("Pending"),[je,we]=s.useState(Js),[be,Se]=s.useState(null);s.useEffect(()=>{const i=F=>{U&&ie.current&&!ie.current.contains(F.target)&&(Y(te=>({...te,[U]:!1})),K(null))},c=F=>{F.key==="Escape"&&U&&(Y(te=>({...te,[U]:!1})),K(null))};return document.addEventListener("mousedown",i),document.addEventListener("keydown",c),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("keydown",c)}},[U]),s.useEffect(()=>{As().then(i=>{d(i.data||[])}).catch(()=>d([]))},[]),s.useEffect(()=>{ks().then(i=>{I(i.data||[])}).catch(()=>I([]))},[]),s.useEffect(()=>{Nt().then(i=>{const c={},F=i.data||[];for(const te of F)te!=null&&te.id&&(c[te.id]=te);W(c)}).catch(()=>W({}))},[]),s.useEffect(()=>{try{const i=localStorage.getItem("unit_structure"),c={},F={};if(i){const te=JSON.parse(i);for(const me of Object.keys(te||{})){const xe=te[me];xe&&Array.isArray(xe._sections)&&(c[me]=xe._sections),xe&&xe._platoonSectionMap&&typeof xe._platoonSectionMap=="object"&&(F[me]=xe._platoonSectionMap)}}else(async()=>{try{const te=await jt();for(const me of Object.keys(te||{})){const xe=te[me];xe&&Array.isArray(xe._sections)&&(c[me]=xe._sections),xe&&xe._platoonSectionMap&&typeof xe._platoonSectionMap=="object"&&(F[me]=xe._platoonSectionMap)}}catch{}})();L(c),Q(F)}catch{}},[]);const fe=s.useMemo(()=>{const i=String((a==null?void 0:a.role)||"");return i.includes("PLATOON")?"PLATOON_REVIEW":i.includes("COMPANY")?"COMPANY_REVIEW":i.includes("BATTALION")?"BATTALION_REVIEW":i.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[a]),N=s.useMemo(()=>Object.values(T),[T]),P=i=>{const c=T[i.uploadedById];if(!c)return!1;const F=We(c.company),te=i.unitUic||c.unitUic||"";return st(N,"COMPANY_REVIEWER",{company:F,uic:te})},se=i=>String((a==null?void 0:a.role)||"").includes("PLATOON")?!P(i):!1,le=i=>T[i.uploadedById]||null,oe=i=>i&&i!=="N/A"?i.trim():"",Re=i=>{var De,Ne;const c=le(i),F=i.unitUic||(c==null?void 0:c.unitUic)||"",te=String((a==null?void 0:a.role)||""),me=(a==null?void 0:a.unitUic)||"",xe=(oe(a==null?void 0:a.roleCompany)||oe(a==null?void 0:a.company)).toUpperCase();if(te.includes("PLATOON")){if(!me||F!==me)return!1;const pe=c?oe(c.company).toUpperCase():"",Ie=c?oe(c.platoon).toUpperCase():"",Ve=(oe(a==null?void 0:a.rolePlatoon)||oe(a==null?void 0:a.platoon)).toUpperCase();return!xe||!Ve||!pe||!Ie?!1:pe===xe&&Ie===Ve}if(te.includes("COMPANY")){if(!me||F!==me)return!1;const pe=c?oe(c.company).toUpperCase():"";return!xe||!pe?!1:pe===xe}if(te.includes("BATTALION")){if(!me||F!==me)return!1;const pe=oe(a==null?void 0:a.company),Ie=oe(a==null?void 0:a.platoon),Ve=((Ne=(De=_[me])==null?void 0:De[pe])==null?void 0:Ne[Ie])||"";return i.routeSection&&Ve?i.routeSection===Ve:!0}return te.includes("COMMANDER")?!!me&&F===me:!0},Ce=s.useMemo(()=>(Array.isArray(j)?j:[]).filter(Re),[j,a,T,_]),ye=s.useMemo(()=>{const i=new Map;for(const c of Ce){const F=le(c);if(F&&F.id&&!i.has(F.id)){const te=`${F.rank||""} ${F.lastName||""}, ${F.firstName||""}`.trim();i.set(F.id,{value:F.id,label:te||F.id})}}return Array.from(i.values()).sort((c,F)=>c.label.localeCompare(F.label))},[Ce,T]),$e=Bs(je,{items:Ce,getSearchText:i=>`${i.subject||""} ${i.id||""} ${i.routeSection||""}`,getStatus:i=>i.currentStage||"PLATOON_REVIEW",getDate:i=>i.createdAt,getOriginatorId:i=>i.uploadedById}),Ae=s.useMemo(()=>$e.filter(i=>(i.currentStage||"PLATOON_REVIEW")===fe),[$e,fe]),m=s.useMemo(()=>$e.filter(i=>(i.currentStage||"PLATOON_REVIEW")!==fe),[$e,fe]),w=Lt(Ae,{pageSize:25}),Z=Lt(m,{pageSize:25}),ae=i=>R.filter(c=>c.requestId===i),ue=s.useMemo(()=>[{header:"Request ID",getValue:i=>i.id},{header:"Subject",getValue:i=>i.subject},{header:"Stage",getValue:i=>i.currentStage||""},{header:"Route Section",getValue:i=>i.routeSection||""},{header:"Originator",getValue:i=>{const c=le(i);return c?`${c.rank||""} ${c.lastName||""}, ${c.firstName||""}${c.mi?` ${c.mi}`:""}`.trim():""}},{header:"Unit UIC",getValue:i=>i.unitUic||""},{header:"Created At",getValue:i=>i.createdAt,format:Gt},{header:"Due Date",getValue:i=>i.dueDate||"",format:Gt},{header:"Documents",getValue:i=>ae(i.id).map(c=>c.name).join(" | ")}],[T,R]),p=async(i,c,F)=>{const te=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",me=Mt(a),xe={actor:te,actorRole:me,timestamp:new Date().toISOString(),action:F,comment:(A[i.id]||"").trim()},De={...i,currentStage:c,routeSection:c==="BATTALION_REVIEW"&&V[i.id]?V[i.id]:i.routeSection,activity:Array.isArray(i.activity)?[...i.activity,xe]:[xe]};try{await Fe(De),F.toLowerCase().includes("approved")?t.success("Request approved",{message:`"${i.subject}" advanced to next stage`}):F.toLowerCase().includes("return")?t.warning("Request returned",{message:`"${i.subject}" sent back for revision`}):F.toLowerCase().includes("archive")?t.info("Request archived",{message:`"${i.subject}" has been archived`}):t.success(F,{message:`Request "${i.subject}" updated`}),d(Ne=>Ne.map(pe=>pe.id===De.id?De:pe)),O(Ne=>({...Ne,[i.id]:""}))}catch(Ne){t.error("Failed to update request",{message:String(Ne)})}},k=async i=>{const c=J[i.id]||[];if(!c.length||!(a!=null&&a.id))return;const F=Date.now(),te=c.map((pe,Ie)=>({id:`${F}-${Ie}`,name:pe.name,type:pe.type,size:pe.size,uploadedAt:new Date().toISOString(),subject:i.subject,requestId:i.id,fileUrl:URL.createObjectURL(pe)})),me=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",xe=Mt(a),De={actor:me,actorRole:xe,timestamp:new Date().toISOString(),action:`Reviewer added ${te.length} document(s)`,comment:(A[i.id]||"").trim()},Ne={...i,documentIds:[...i.documentIds||[],...te.map(pe=>pe.id)],activity:Array.isArray(i.activity)?[...i.activity,De]:[De]};try{await Pt(te),await Fe(Ne),t.success(`${te.length} file${te.length!==1?"s":""} added`,{message:`Documents added to "${i.subject}"`})}catch(pe){t.error("Failed to add files",{message:String(pe)})}I(pe=>[...pe,...te]),d(pe=>pe.map(Ie=>Ie.id===Ne.id?Ne:Ie)),z(pe=>({...pe,[i.id]:[]})),O(pe=>({...pe,[i.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Unit Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Mt(a)}),e.jsx(Hs,{items:[...Ae,...m],columns:ue,filename:"review_requests",label:"Export",className:"hidden md:inline-flex"})]})]}),a&&String(a.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>H(!0),children:"Manage Permissions"})})]}),e.jsx(Fs,{filters:je,onFiltersChange:we,statusOptions:Gs,originatorOptions:ye,searchPlaceholder:"Search requests by subject, ID, or section...",className:"mb-4"}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>he("Pending"),className:`${M==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>he("In Scope"),className:`${M==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[M==="Pending"&&e.jsx(Xe,{title:"Pending",requests:w.currentData,users:T,onRowClick:i=>D(c=>({...c,[i.id]:!c[i.id]})),expandedRows:h,platoonSectionMap:_,children:i=>e.jsxs("div",{id:`details-rev-${i.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!v[i.id],"aria-controls":`docs-rev-${i.id}`,onClick:()=>{Y(c=>({...c,[i.id]:!c[i.id]})),K(c=>v[i.id]?null:i.id)},onKeyDown:c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),Y(F=>({...F,[i.id]:!F[i.id]})),K(F=>v[i.id]?null:i.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${v[i.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${i.id}`,ref:v[i.id]?ie:void 0,className:`${v[i.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:ae(i.id).map(c=>({...c,fileUrl:c.fileUrl})),showIcons:!0,onPreview:c=>Se(ae(i.id).find(F=>F.id===c.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>S(c=>({...c,[i.id]:!c[i.id]})),"aria-expanded":!!X[i.id],"aria-controls":`logs-${i.id}`,children:[X[i.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${i.id}`,className:X[i.id]?"mt-2 space-y-2":"hidden",children:i.activity&&i.activity.length?i.activity.map((c,F)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[c.actor,c.actorRole?` â€¢ ${c.actorRole}`:""," â€¢ ",new Date(c.timestamp).toLocaleString()," â€¢ ",c.action]}),c.comment&&e.jsx("div",{className:"text-gray-600",children:c.comment})]},F)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:A[i.id]||"",onChange:c=>O(F=>({...F,[i.id]:c.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:c=>z(F=>({...F,[i.id]:c.target.files?Array.from(c.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(J[i.id]||[]).length?`${(J[i.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>k(i),disabled:!J[i.id]||!(J[i.id]||[]).length,children:"Save Files"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[(String((a==null?void 0:a.role)||"").includes("COMPANY")||se(i))&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:V[i.id]||"",onChange:c=>l(F=>({...F,[i.id]:c.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(ee[(a==null?void 0:a.unitUic)||""]||[]).map(c=>e.jsx("option",{value:c,children:c},c))]}),se(i)&&e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No company reviewer"})]}),(()=>{const c=Xs(i),F=Zs(i),te=String((a==null?void 0:a.role)||"").includes("COMPANY")||se(i);return c||F?e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>p(i,i.currentStage==="PLATOON_REVIEW"?Kt:Xt(i.currentStage),"Returned to previous stage"),children:"Return to Previous"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(te){if(!V[i.id])return;p(i,"BATTALION_REVIEW",`Approved and routed to ${V[i.id]}`)}else p(i,Ks(i.currentStage),"Approved")},disabled:te&&!V[i.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>p(i,i.currentStage==="PLATOON_REVIEW"?Kt:Xt(i.currentStage),i.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),M==="In Scope"&&e.jsx(Xe,{title:"In Scope",requests:Z.currentData,users:T,onRowClick:i=>D(c=>({...c,[i.id]:!c[i.id]})),expandedRows:h,platoonSectionMap:_,children:i=>e.jsxs("div",{id:`details-rev-${i.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!v[i.id],"aria-controls":`docs-rev-${i.id}`,onClick:()=>{Y(c=>({...c,[i.id]:!c[i.id]})),K(c=>v[i.id]?null:i.id)},onKeyDown:c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),Y(F=>({...F,[i.id]:!F[i.id]})),K(F=>v[i.id]?null:i.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${v[i.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${i.id}`,ref:v[i.id]?ie:void 0,className:`${v[i.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:ae(i.id).map(c=>({...c,fileUrl:c.fileUrl})),showIcons:!0,onPreview:c=>Se(ae(i.id).find(F=>F.id===c.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>S(c=>({...c,[i.id]:!c[i.id]})),"aria-expanded":!!X[i.id],"aria-controls":`logs-${i.id}`,children:[X[i.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${i.id}`,className:X[i.id]?"mt-2 space-y-2":"hidden",children:i.activity&&i.activity.length?i.activity.map((c,F)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[c.actor,c.actorRole?` â€¢ ${c.actorRole}`:""," â€¢ ",new Date(c.timestamp).toLocaleString()," â€¢ ",c.action]}),c.comment&&e.jsx("div",{className:"text-gray-600",children:c.comment})]},F)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),y&&a&&e.jsx(Ys,{currentUser:a,onClose:()=>H(!1)}),be&&be.fileUrl&&e.jsx(ds,{url:be.fileUrl,fileName:be.name,mimeType:be.type,fileSize:be.size,isOpen:!!be,onClose:()=>Se(null)})]})}function ta(){var q;const[t,a]=s.useState(null),[o,j]=s.useState([]),[d,R]=s.useState([]),[I,A]=s.useState(""),[O,T]=s.useState(""),[W,X]=s.useState([]),[S,J]=s.useState(null),[z,V]=s.useState("structure"),[l,ee]=s.useState({}),[L,_]=s.useState({}),[Q,y]=s.useState({});s.useEffect(()=>{try{const E=localStorage.getItem("currentUser");E&&a(JSON.parse(E))}catch{}as().then(E=>{try{j(E.map(G=>({code:String(G.code||""),name:String(G.name||"")})))}catch{j([])}}),ns().then(E=>{R(E)}).catch(()=>R([])),it().then(E=>X(E)).catch(()=>X([])),Ft().then(E=>{const G={};for(const C of E){const v=`${C.division_code}::${C.branch}`;G[v]={reviewers:C.reviewers||[],approvers:C.approvers||[]}}ee(G)})},[]);const H=(t==null?void 0:t.hqmcDivision)||((q=o[0])==null?void 0:q.code)||"",h=s.useMemo(()=>o.find(E=>E.code===H),[o,H]),D=s.useMemo(()=>(Array.isArray(d)?d:[]).filter(E=>String(E.division_code||"")===H),[d,H]);return s.useMemo(()=>(Array.isArray(W)?W:[]).filter(E=>!!E.isHqmcAdmin&&String(E.hqmcDivision||"")===H),[W,H]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(t!=null&&t.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",h?`${h.code} â€” ${h.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>V("structure"),className:`${z==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>V("permissions"),className:`${z==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),z==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[D.map(E=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:E.branch}),e.jsx("td",{className:"py-2 px-3",children:E.description||""}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700",onClick:async()=>{if(!confirm(`Delete branch "${E.branch}"?`))return;const G=await Es(H,E.branch);G.ok?(R(C=>C.filter(v=>!(v.division_code===H&&v.branch===E.branch))),J({type:"success",message:`Deleted branch "${E.branch}"`})):J({type:"error",message:`Failed to delete: ${G.error}`})},children:"Delete"})})]},E.branch)),D.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:I,onChange:E=>A(E.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:O,onChange:E=>T(E.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!I.trim(),onClick:async()=>{var E;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:H,division_name:((E=o.find(C=>C.code===H))==null?void 0:E.name)||"",branch:I.trim(),description:O.trim()})});const G=await fetch("/api/hqmc-structure").then(C=>C.json());R(G),A(""),T("")}catch{}},children:"Add"})]})]})]}),z==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const E of D){const G=`${H}::${E.branch}`,C=l[G]||{reviewers:[],approvers:[]};await rs({division_code:H,branch:E.branch,reviewers:C.reviewers,approvers:C.approvers})}J({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:D.map(E=>{const G=`${H}::${E.branch}`,C=l[G]||{reviewers:[],approvers:[]},v=Y=>`${Y.rank||""} ${Y.lastName||""}, ${Y.firstName||""}${Y.mi?" "+Y.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:E.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:L[G]||"",onChange:Y=>_(U=>({...U,[G]:Y.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!L[G],onClick:async()=>{const Y=(L[G]||"").trim();if(!Y)return;const{user:U,error:K}=await $t(Y);if(K){J({type:"error",message:`Database error: ${K}`});return}if(!(U!=null&&U.id)){J({type:"error",message:`No user found for EDIPI ${Y}`});return}ee(ie=>({...ie,[G]:{...C,reviewers:Array.from(new Set([...C.reviewers||[],U.id]))}})),_(ie=>({...ie,[G]:""})),J({type:"success",message:`Added reviewer ${U.lastName||""}, ${U.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(C.reviewers||[]).map(Y=>{const U=W.find(K=>K.id===Y);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:U?v(U):Y}),e.jsx("button",{className:"text-red-600",onClick:()=>ee(K=>({...K,[G]:{...C,reviewers:(C.reviewers||[]).filter(ie=>ie!==Y)}})),children:"âœ•"})]},Y)}),(C.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:Q[G]||"",onChange:Y=>y(U=>({...U,[G]:Y.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!Q[G],onClick:async()=>{const Y=(Q[G]||"").trim();if(!Y)return;const{user:U,error:K}=await $t(Y);if(K){J({type:"error",message:`Database error: ${K}`});return}if(!(U!=null&&U.id)){J({type:"error",message:`No user found for EDIPI ${Y}`});return}ee(ie=>({...ie,[G]:{...C,approvers:Array.from(new Set([...C.approvers||[],U.id]))}})),y(ie=>({...ie,[G]:""})),J({type:"success",message:`Added approver ${U.lastName||""}, ${U.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(C.approvers||[]).map(Y=>{const U=W.find(K=>K.id===Y);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:U?v(U):Y}),e.jsx("button",{className:"text-red-600",onClick:()=>ee(K=>({...K,[G]:{...C,approvers:(C.approvers||[]).filter(ie=>ie!==Y)}})),children:"âœ•"})]},Y)}),(C.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},G)})})]})})]}),S&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${S.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:S.message})]})}const ut=(t,a)=>`${t}::${a}`;function sa({currentUser:t,divisionCode:a,branches:o,assignments:j,onClose:d}){const[R,I]=s.useState([]),[A,O]=s.useState(""),[T,W]=s.useState(""),[X,S]=s.useState("reviewer"),[J,z]=s.useState(!1);s.useEffect(()=>{Nt().then(h=>I(h)).catch(()=>I([]))},[]);const V=s.useMemo(()=>{const h={};for(const D of j)h[ut(D.division_code,D.branch)]={reviewers:D.reviewers||[],approvers:D.approvers||[]};return h},[j]),l=String(t.id||""),ee=s.useMemo(()=>{if(!A)return!1;const h=V[ut(a,A)]||{reviewers:[],approvers:[]};return(h.reviewers||[]).includes(l)||(h.approvers||[]).includes(l)||!!t.isHqmcAdmin},[A,V,l,t]),L=s.useMemo(()=>R.filter(h=>String(h.hqmcDivision||"")===String(a||"")&&String(h.id||"")!==l),[R,a,l]),_=s.useMemo(()=>{if(!A)return[];const h=V[ut(a,A)]||{reviewers:[],approvers:[]};return Array.from(new Set([...h.reviewers||[],...h.approvers||[]])).map(q=>L.find(E=>E.id===q)).filter(Boolean)},[A,V,L,a]),Q=async h=>{z(!0);try{await rs({division_code:a,branch:A,reviewers:h.reviewers,approvers:h.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:t.id,scope:{hqmcDivision:a,branch:A},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{z(!1)}},y=async()=>{if(!ee||!A||!T)return;const h=V[ut(a,A)]||{reviewers:[],approvers:[]},D={reviewers:Array.from(new Set(h.reviewers||[])),approvers:Array.from(new Set(h.approvers||[]))};X==="reviewer"?D.reviewers=Array.from(new Set([...D.reviewers,T])):D.approvers=Array.from(new Set([...D.approvers,T])),await Q(D),W("")},H=async h=>{if(!ee||!A)return;const D=V[ut(a,A)]||{reviewers:[],approvers:[]},q={reviewers:(D.reviewers||[]).filter(E=>E!==h),approvers:(D.approvers||[]).filter(E=>E!==h)};await Q(q)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:d,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:h=>h.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:d,children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:A,onChange:h=>O(h.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),o.map(h=>e.jsx("option",{value:h,children:h},h))]})]}),A&&!ee&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),A&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:T,onChange:h=>W(h.target.value),disabled:!ee,children:[e.jsx("option",{value:"",children:"Choose user"}),L.map(h=>e.jsxs("option",{value:h.id,children:[h.rank," ",h.lastName,", ",h.firstName,h.mi?` ${h.mi}`:""," â€¢ ",h.email]},h.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:X,onChange:h=>S(h.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!ee||!T||J,onClick:y,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[_.map(h=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[h.rank," ",h.lastName,", ",h.firstName,h.mi?` ${h.mi}`:""," â€¢ ",h.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!ee||J,onClick:()=>H(h.id),children:"Remove"})]},h.id)),_.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}function aa(){const[t,a]=s.useState(()=>{try{const m=localStorage.getItem("currentUser");return m?JSON.parse(m):null}catch{return null}}),[o,j]=s.useState([]),[d,R]=s.useState([]),[I,A]=s.useState({}),[O,T]=s.useState({}),[W,X]=s.useState({}),[S,J]=s.useState({}),[z,V]=s.useState({}),[l,ee]=s.useState(null),L=s.useRef(null),[_,Q]=s.useState([]),[y,H]=s.useState("Pending"),[h,D]=s.useState([]),[q,E]=s.useState({}),[G,C]=s.useState(!1);s.useEffect(()=>{const m=Z=>{l&&L.current&&!L.current.contains(Z.target)&&(J(ae=>({...ae,[l]:!1})),ee(null))},w=Z=>{Z.key==="Escape"&&l&&(J(ae=>({...ae,[l]:!1})),ee(null))};return document.addEventListener("mousedown",m),document.addEventListener("keydown",w),()=>{document.removeEventListener("mousedown",m),document.removeEventListener("keydown",w)}},[l]),s.useEffect(()=>{vt().then(m=>j(m)).catch(()=>j([]))},[]),s.useEffect(()=>{qt().then(m=>R(m)).catch(()=>R([]))},[]),s.useEffect(()=>{it().then(m=>{const w={};for(const Z of m)Z!=null&&Z.id&&(w[Z.id]=Z);T(w)}).catch(()=>T({}))},[]),s.useEffect(()=>{Ft().then(Q).catch(()=>Q([]))},[]),s.useEffect(()=>{ns().then(D).catch(()=>D([]))},[]);const v=(t==null?void 0:t.id)||"",Y=String((t==null?void 0:t.hqmcDivision)||""),U=s.useMemo(()=>_.filter(m=>m.division_code===Y&&((m.reviewers||[]).includes(v)||(m.approvers||[]).includes(v))).map(m=>m.branch),[_,Y,v]),K=m=>O[m.uploadedById]||null,ie=m=>{if(!Y||!v)return!1;const w=String(m.routeSection||"");return U.includes(w)},M=m=>(m.activity||[]).some(w=>/HQMC Approver Approved/i.test(String(w.action||""))),he=s.useMemo(()=>(Array.isArray(o)?o:[]).filter(ie),[o,U]),je=s.useMemo(()=>he.filter(m=>(m.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&!M(m)),[he]),we=s.useMemo(()=>he.filter(m=>(m.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&M(m)),[he]),be=s.useMemo(()=>he.filter(m=>(m.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[he]),Se=m=>d.filter(w=>w.requestId===m),fe=m=>`"${String(m??"").replace(/"/g,'""')}"`,N=m=>{const Z=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const ae of m){const ue=K(ae),p=ue?`${ue.rank} ${ue.lastName}, ${ue.firstName}${ue.mi?` ${ue.mi}`:""}`:"",k=Se(ae.id).map(i=>i.name).join(" | ");Z.push([ae.id,ae.subject,ae.currentStage||"",ae.routeSection||"",p,ae.unitUic||"",new Date(ae.createdAt).toLocaleString(),k])}return Z.map(ae=>ae.map(fe).join(",")).join(`\r
`)},P=(m,w)=>{const Z=new Blob([w],{type:"text/csv;charset=utf-8;"}),ae=URL.createObjectURL(Z),ue=document.createElement("a");ue.href=ae,ue.download=m,document.body.appendChild(ue),ue.click(),document.body.removeChild(ue),URL.revokeObjectURL(ae)},se=()=>P("hqmc_pending.csv",N(je)),le=()=>P("hqmc_approved.csv",N(we)),oe=()=>P("hqmc_archived.csv",N(be)),Re=()=>P("hqmc_all.csv",N([...je,...we,...be])),Ce=async m=>{const w=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",Z=String(q[m.id]||"").trim();if(!Z){alert("Select an HQMC section to route to approver");return}const ae={actor:w,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${Z}`,comment:(I[m.id]||"").trim()},ue={...m,routeSection:Z,activity:Array.isArray(m.activity)?[...m.activity,ae]:[ae]};try{await Fe(ue)}catch{}j(p=>p.map(k=>k.id===ue.id?ue:k)),A(p=>({...p,[m.id]:""}))},ye=async m=>{const Z={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC to Installation",comment:(I[m.id]||"").trim()},ae={...m,currentStage:"INSTALLATION_REVIEW",activity:Array.isArray(m.activity)?[...m.activity,Z]:[Z]};try{await Fe(ae)}catch{}j(ue=>ue.map(p=>p.id===ae.id?ae:p)),A(ue=>({...ue,[m.id]:""}))},$e=async m=>{const Z={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Section",timestamp:new Date().toISOString(),action:"Archived by HQMC Section",comment:(I[m.id]||"").trim()},ae={...m,currentStage:"ARCHIVED",activity:Array.isArray(m.activity)?[...m.activity,Z]:[Z]};try{await Fe(ae)}catch{}j(ue=>ue.map(p=>p.id===ae.id?ae:p)),A(ue=>({...ue,[m.id]:""}))},Ae=async m=>{const w=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Section",Z=String(q[m.id]||"").trim();if(!Z){alert("Select an HQMC section to reassign to");return}const ae={actor:w,timestamp:new Date().toISOString(),action:`Reassigned to HQMC section: ${Z}`,comment:(I[m.id]||"").trim()},ue={...m,routeSection:Z,activity:Array.isArray(m.activity)?[...m.activity,ae]:[ae]};try{await Fe(ue)}catch{}j(p=>p.map(k=>k.id===ue.id?ue:k)),A(p=>({...p,[m.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Y||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Re,children:"Export All"}),U.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>C(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>H("Pending"),className:`${y==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>H("Approved"),className:`${y==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"}),e.jsx("button",{onClick:()=>H("Archived"),className:`${y==="Archived"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Archived"})]})}),e.jsxs("div",{className:"mt-4",children:[y==="Pending"&&e.jsx(Xe,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:se,children:"Export Pending"}),requests:je,users:O,onRowClick:m=>X(w=>({...w,[m.id]:!w[m.id]})),expandedRows:W,children:m=>e.jsxs("div",{id:`details-hq-${m.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!S[m.id],"aria-controls":`docs-hq-${m.id}`,onClick:()=>{J(w=>({...w,[m.id]:!w[m.id]})),ee(w=>S[m.id]?null:m.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${S[m.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${m.id}`,ref:S[m.id]?L:void 0,className:`${S[m.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:Se(m.id).map(w=>({...w,fileUrl:w.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[m.id],"aria-controls":`logs-hq-${m.id}`,onClick:()=>V(w=>({...w,[m.id]:!w[m.id]})),children:[z[m.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hq-${m.id}`,className:z[m.id]?"mt-2 space-y-2":"hidden",children:m.activity&&m.activity.length?m.activity.map((w,Z)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[w.actor," â€¢ ",new Date(w.timestamp).toLocaleString()," â€¢ ",w.action]}),w.comment&&e.jsx("div",{className:"text-gray-600",children:w.comment})]},Z)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:I[m.id]||"",onChange:w=>A(Z=>({...Z,[m.id]:w.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:q[m.id]||"",onChange:w=>E(Z=>({...Z,[m.id]:w.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),h.filter(w=>String(w.division_code||"")===Y).map(w=>e.jsx("option",{value:w.branch,children:w.branch},w.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Ce(m),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>ye(m),children:"Return"})]})]})]})}),y==="Approved"&&e.jsx(Xe,{title:"Approved by HQMC Approver",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:le,children:"Export Approved"}),requests:we,users:O,onRowClick:m=>X(w=>({...w,[m.id]:!w[m.id]})),expandedRows:W,children:m=>e.jsxs("div",{id:`details-hqa-${m.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!S[m.id],"aria-controls":`docs-hqa-${m.id}`,onClick:()=>{J(w=>({...w,[m.id]:!w[m.id]})),ee(w=>S[m.id]?null:m.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${S[m.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${m.id}`,ref:S[m.id]?L:void 0,className:`${S[m.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:Se(m.id).map(w=>({...w,fileUrl:w.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[m.id],"aria-controls":`logs-hqa-${m.id}`,onClick:()=>V(w=>({...w,[m.id]:!w[m.id]})),children:[z[m.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqa-${m.id}`,className:z[m.id]?"mt-2 space-y-2":"hidden",children:m.activity&&m.activity.length?m.activity.map((w,Z)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[w.actor," â€¢ ",new Date(w.timestamp).toLocaleString()," â€¢ ",w.action]}),w.comment&&e.jsx("div",{className:"text-gray-600",children:w.comment})]},Z)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:I[m.id]||"",onChange:w=>A(Z=>({...Z,[m.id]:w.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Reassign to Section"}),e.jsxs("select",{value:q[m.id]||"",onChange:w=>E(Z=>({...Z,[m.id]:w.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),h.filter(w=>String(w.division_code||"")===Y).map(w=>e.jsx("option",{value:w.branch,children:w.branch},w.branch))]}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Ae(m),children:"Reassign"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700",onClick:()=>$e(m),children:"Archive"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>ye(m),children:"Return to Installation"})]})]})]})}),y==="Archived"&&e.jsx(Xe,{title:"Archived",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:oe,children:"Export Archived"}),requests:be,users:O,onRowClick:m=>X(w=>({...w,[m.id]:!w[m.id]})),expandedRows:W,children:m=>e.jsxs("div",{id:`details-hqarc-${m.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!S[m.id],"aria-controls":`docs-hqarc-${m.id}`,onClick:()=>{J(w=>({...w,[m.id]:!w[m.id]})),ee(w=>S[m.id]?null:m.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${S[m.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqarc-${m.id}`,ref:S[m.id]?L:void 0,className:`${S[m.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:Se(m.id).map(w=>({...w,fileUrl:w.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[m.id],"aria-controls":`logs-hqarc-${m.id}`,onClick:()=>V(w=>({...w,[m.id]:!w[m.id]})),children:[z[m.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqarc-${m.id}`,className:z[m.id]?"mt-2 space-y-2":"hidden",children:m.activity&&m.activity.length?m.activity.map((w,Z)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[w.actor," â€¢ ",new Date(w.timestamp).toLocaleString()," â€¢ ",w.action]}),w.comment&&e.jsx("div",{className:"text-gray-600",children:w.comment})]},Z)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),G&&t&&e.jsx(sa,{currentUser:t,divisionCode:Y,branches:h.filter(m=>String(m.division_code||"")===Y).map(m=>m.branch),assignments:_,onClose:()=>C(!1)})]})}function na(){const[t,a]=s.useState(()=>{try{const N=localStorage.getItem("currentUser");return N?JSON.parse(N):null}catch{return null}}),[o,j]=s.useState([]),[d,R]=s.useState([]),[I,A]=s.useState({}),[O,T]=s.useState({}),[W,X]=s.useState({}),[S,J]=s.useState({}),[z,V]=s.useState({}),[l,ee]=s.useState(null),L=s.useRef(null),[_,Q]=s.useState([]),[y,H]=s.useState("Pending");s.useEffect(()=>{const N=se=>{l&&L.current&&!L.current.contains(se.target)&&(J(le=>({...le,[l]:!1})),ee(null))},P=se=>{se.key==="Escape"&&l&&(J(le=>({...le,[l]:!1})),ee(null))};return document.addEventListener("mousedown",N),document.addEventListener("keydown",P),()=>{document.removeEventListener("mousedown",N),document.removeEventListener("keydown",P)}},[l]),s.useEffect(()=>{vt().then(N=>j(N)).catch(()=>j([]))},[]),s.useEffect(()=>{qt().then(N=>R(N)).catch(()=>R([]))},[]),s.useEffect(()=>{it().then(N=>{const P={};for(const se of N)se!=null&&se.id&&(P[se.id]=se);T(P)}).catch(()=>T({}))},[]),s.useEffect(()=>{Ft().then(Q).catch(()=>Q([]))},[]);const h=(t==null?void 0:t.id)||"",D=String((t==null?void 0:t.hqmcDivision)||""),q=s.useMemo(()=>_.filter(N=>N.division_code===D&&(N.approvers||[]).includes(h)).map(N=>N.branch),[_,D,h]),E=N=>O[N.uploadedById]||null,G=N=>{if(!D||!h)return!1;const P=String(N.routeSection||"");return q.includes(P)},C=N=>(N.activity||[]).some(P=>/HQMC Approver Approved/i.test(String(P.action||""))),v=s.useMemo(()=>(Array.isArray(o)?o:[]).filter(G),[o,q]),Y=s.useMemo(()=>v.filter(N=>(N.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&!C(N)),[v]),U=s.useMemo(()=>v.filter(N=>C(N)),[v]),K=N=>d.filter(P=>P.requestId===N),ie=N=>`"${String(N??"").replace(/"/g,'""')}"`,M=N=>{const se=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const le of N){const oe=E(le),Re=oe?`${oe.rank} ${oe.lastName}, ${oe.firstName}${oe.mi?` ${oe.mi}`:""}`:"",Ce=K(le.id).map(ye=>ye.name).join(" | ");se.push([le.id,le.subject,le.currentStage||"",le.routeSection||"",Re,le.unitUic||"",new Date(le.createdAt).toLocaleString(),Ce])}return se.map(le=>le.map(ie).join(",")).join(`\r
`)},he=(N,P)=>{const se=new Blob([P],{type:"text/csv;charset=utf-8;"}),le=URL.createObjectURL(se),oe=document.createElement("a");oe.href=le,oe.download=N,document.body.appendChild(oe),oe.click(),document.body.removeChild(oe),URL.revokeObjectURL(le)},je=()=>he("hqmc_approver_pending.csv",M(Y)),we=()=>he("hqmc_approver_approved.csv",M(U)),be=()=>he("hqmc_approver_all.csv",M([...Y,...U])),Se=async N=>{const se={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved - Pending HQMC Section Action",comment:(I[N.id]||"").trim()},le={...N,currentStage:"HQMC_REVIEW",activity:Array.isArray(N.activity)?[...N.activity,se]:[se]};try{await Fe(le)}catch{}j(oe=>oe.map(Re=>Re.id===le.id?le:Re)),A(oe=>({...oe,[N.id]:""}))},fe=async N=>{const se={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver to Installation",comment:(I[N.id]||"").trim()},le={...N,currentStage:"INSTALLATION_REVIEW",activity:Array.isArray(N.activity)?[...N.activity,se]:[se]};try{await Fe(le)}catch{}j(oe=>oe.map(Re=>Re.id===le.id?le:Re)),A(oe=>({...oe,[N.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((t==null?void 0:t.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:be,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>H("Pending"),className:`${y==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>H("Approved"),className:`${y==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"})]})}),e.jsxs("div",{className:"mt-4",children:[y==="Pending"&&e.jsx(Xe,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:je,children:"Export Pending"}),requests:Y,users:O,onRowClick:N=>X(P=>({...P,[N.id]:!P[N.id]})),expandedRows:W,children:N=>e.jsxs("div",{id:`details-hqa-${N.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!S[N.id],"aria-controls":`docs-hqa-${N.id}`,onClick:()=>{J(P=>({...P,[N.id]:!P[N.id]})),ee(P=>S[N.id]?null:N.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${S[N.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${N.id}`,ref:S[N.id]?L:void 0,className:`${S[N.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:K(N.id).map(P=>({...P,fileUrl:P.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[N.id],"aria-controls":`logs-hqa-${N.id}`,onClick:()=>V(P=>({...P,[N.id]:!P[N.id]})),children:[z[N.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqa-${N.id}`,className:z[N.id]?"mt-2 space-y-2":"hidden",children:N.activity&&N.activity.length?N.activity.map((P,se)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[P.actor," â€¢ ",new Date(P.timestamp).toLocaleString()," â€¢ ",P.action]}),P.comment&&e.jsx("div",{className:"text-gray-600",children:P.comment})]},se)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:I[N.id]||"",onChange:P=>A(se=>({...se,[N.id]:P.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Se(N),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>fe(N),children:"Return"})]})]})}),y==="Approved"&&e.jsx(Xe,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:we,children:"Export Approved"}),requests:U,users:O,onRowClick:N=>X(P=>({...P,[N.id]:!P[N.id]})),expandedRows:W,children:N=>e.jsxs("div",{id:`details-hqa-${N.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!S[N.id],"aria-controls":`docs-hqa-${N.id}`,onClick:()=>{J(P=>({...P,[N.id]:!P[N.id]})),ee(P=>S[N.id]?null:N.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${S[N.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${N.id}`,ref:S[N.id]?L:void 0,className:`${S[N.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:K(N.id).map(P=>({...P,fileUrl:P.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[N.id],"aria-controls":`logs-hqaa-${N.id}`,onClick:()=>V(P=>({...P,[N.id]:!P[N.id]})),children:[z[N.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqaa-${N.id}`,className:z[N.id]?"mt-2 space-y-2":"hidden",children:N.activity&&N.activity.length?N.activity.map((P,se)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[P.actor," â€¢ ",new Date(P.timestamp).toLocaleString()," â€¢ ",P.action]}),P.comment&&e.jsx("div",{className:"text-gray-600",children:P.comment})]},se)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]})})}const ra=({onUnitSelect:t,selectedUnit:a})=>{const[o,j]=s.useState(""),[d,R]=s.useState(!1),I=Ue.filter(O=>O.unitName.toLowerCase().startsWith(o.toLowerCase())||O.uic.toLowerCase().startsWith(o.toLowerCase())||O.ruc.toLowerCase().startsWith(o.toLowerCase())),A=O=>{t(O),R(!1),j("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>R(!d),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[a?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",a.uic," | RUC: ",a.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),d&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:o,onChange:O=>j(O.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:I.map(O=>e.jsxs("button",{type:"button",onClick:()=>A(O),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:O.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",O.uic," | RUC: ",O.ruc," | MCC: ",O.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[O.streetAddress,", ",O.cityState," ",O.zip]})]},O.uic))})]})]})]})},Tt=async t=>{const o=new TextEncoder().encode(t),j=await crypto.subtle.digest("SHA-256",o);return Array.from(new Uint8Array(j)).map(d=>d.toString(16).padStart(2,"0")).join("")};async function ia(t,a){const o=Rs();return o!=null&&o.auth?await o.auth.signUp({email:t,password:a}):{data:null,error:new Error("supabase_not_initialized")}}const Zt={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},oa=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],us=({onSaved:t,initial:a={},mode:o="create",readOnly:j=!1,canEditRole:d=!1,canEditAdmin:R=!1})=>{const[I,A]=s.useState(""),[O,T]=s.useState(""),[W,X]=s.useState(""),[S,J]=s.useState(a.email||""),[z,V]=s.useState(a.edipi||""),[l,ee]=s.useState(a.service||""),[L,_]=s.useState(a.rank||""),[Q,y]=s.useState(a.role||"MEMBER"),[H,h]=s.useState(!!a.isUnitAdmin),[D,q]=s.useState(a.company||""),[E,G]=s.useState(a.platoon||""),[C,v]=s.useState(void 0),[Y,U]=s.useState(null),[K,ie]=s.useState({}),[M,he]=s.useState(""),[je,we]=s.useState(""),[be,Se]=s.useState([]),[fe,N]=s.useState(!1),[P,se]=s.useState(a.roleCompany||""),[le,oe]=s.useState(a.rolePlatoon||""),[Re,Ce]=s.useState(!1),[ye,$e]=s.useState([]),[Ae,m]=s.useState([]),[w,Z]=s.useState([]),[ae,ue]=s.useState([]);s.useEffect(()=>{if(a.firstName&&A(String(a.firstName)),a.lastName&&T(String(a.lastName)),a.mi&&X(String(a.mi)),a.company&&q(String(a.company)),a.platoon&&G(String(a.platoon)),a.roleCompany&&se(String(a.roleCompany)),a.rolePlatoon&&oe(String(a.rolePlatoon)),a.unitUic){const b=Ue.find(ce=>ce.uic===a.unitUic);b&&v(b)}},[a]);const p=s.useMemo(()=>Zt[l]||[],[l]),k=s.useMemo(()=>{if(!C)return[];const b=ye;if(b&&b.length)return b;const ce=K[C.uic]||{};return Object.keys(ce).filter(ve=>!ve.startsWith("_")&&Array.isArray(ce[ve]))},[C,K,ye]),i=s.useMemo(()=>{var b;return C&&D?((b=K[C.uic])==null?void 0:b[D])||[]:[]},[C,D,K]),c=s.useMemo(()=>{if(!C||!D)return[];const b=Ae;return b&&b.length?b:i},[C,D,Ae,i]),F=s.useMemo(()=>{if(!C)return[];const b=w;if(b&&b.length)return b;const ce=K[C.uic]||{};return Object.keys(ce).filter(ve=>!ve.startsWith("_")&&Array.isArray(ce[ve]))},[C,K,w]),te=s.useMemo(()=>{var b;return C&&P?((b=K[C.uic])==null?void 0:b[P])||[]:[]},[C,P,K]),me=s.useMemo(()=>{if(!C||!P)return[];const b=ae;return b&&b.length?b:te},[C,P,ae,te]),xe=s.useMemo(()=>{const b=k.slice(),ce=D||a.company||a.user_company||"";return ce&&!b.includes(ce)?[ce,...b]:b},[k,D,a]),De=s.useMemo(()=>{const b=c.slice(),ce=E||a.platoon||a.user_platoon||"";return ce&&!b.includes(ce)?[ce,...b]:b},[c,E,a]),Ne=s.useMemo(()=>{const b=F.slice(),ce=P||a.roleCompany||"",ve=ce&&!b.includes(ce)?[ce,...b]:b;return Array.from(new Set(ve))},[F,P,a]),pe=s.useMemo(()=>{const b=me.slice(),ce=le||a.rolePlatoon||"";return ce&&!b.includes(ce)?[ce,...b]:b},[me,le,a]);s.useEffect(()=>{(async()=>{try{if(o==="edit"&&a.id){const b=await is(String(a.id));b&&(b.company&&!D&&q(String(b.company)),b.platoon&&!E&&G(String(b.platoon)),b.roleCompany&&!P&&se(String(b.roleCompany)),b.rolePlatoon&&!le&&oe(String(b.rolePlatoon)))}}catch{}})()},[o,a.id]),s.useEffect(()=>{p.includes(L)||_("")},[p]),s.useEffect(()=>{G("")},[D]),s.useEffect(()=>{oe("")},[P]),s.useEffect(()=>{try{const b=localStorage.getItem("unit_structure");b&&ie(JSON.parse(b))}catch{}},[C]),s.useEffect(()=>{const b=(C==null?void 0:C.uic)||"";if(!b){$e([]),Z([]);return}os(b).then(ce=>{$e(ce||[]),Z(ce||[])}).catch(()=>{$e([]),Z([])})},[C]),s.useEffect(()=>{const b=(C==null?void 0:C.uic)||"",ce=D||"";if(!b||!ce){m([]);return}Ot(b,ce).then(ve=>m(ve||[])).catch(()=>m([]))},[C,D]),s.useEffect(()=>{const b=(C==null?void 0:C.uic)||"",ce=P||"";if(!b||!ce){ue([]);return}Ot(b,ce).then(ve=>ue(ve||[])).catch(()=>ue([]))},[C,P]),s.useEffect(()=>{it().then(b=>{Se(b)}).catch(()=>Se([]))},[]),s.useEffect(()=>{const b=(C==null?void 0:C.uic)||"";if(!b){N(!1);return}const ce=be.some(ve=>!!ve.isUnitAdmin&&(ve.unitUic||"")===b);N(ce)},[C,be]),s.useEffect(()=>{if(C){!D&&a.company&&xe.includes(a.company)&&q(String(a.company));const b=a.platoon;!E&&b&&De.includes(b)&&G(String(b))}},[C,xe,De,D,E,a]);const Ie=b=>/^[0-9]{10}$/.test(b),Ve=(b,ce)=>{try{return be.some(ve=>String(ve.edipi)===String(b)&&String(ve.id)!==String(ce||""))}catch{return!1}},Ze=async b=>{var ze,qe;if(b.preventDefault(),U(null),j)return;if(!I.trim())return U({type:"error",message:"First name is required."});if(!O.trim())return U({type:"error",message:"Last name is required."});if(W&&!/^[A-Za-z]$/.test(W))return U({type:"error",message:"MI must be a single letter."});if(!S.trim())return U({type:"error",message:"Email is required."});if(!Ie(String(z)))return U({type:"error",message:"EDIPI must be 10 digits."});if(!l)return U({type:"error",message:"Service is required."});if(!L)return U({type:"error",message:"Rank is required."});if(Ve(String(z),a.id?String(a.id):void 0))return U({type:"error",message:"EDIPI already exists."});if(Q==="COMPANY_REVIEWER"&&!P)return U({type:"error",message:"Role Company is required for Company Reviewer."});if(Q==="PLATOON_REVIEWER"&&(!P||!le))return U({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${I.trim()}`,W&&""+W.trim().toUpperCase(),`${O.trim()}`;let ce=a.id?String(a.id):`usr-${Date.now()}`,ve=a.passwordHash||"";if(o==="create"){if(!M||M.length<8)return U({type:"error",message:"Password must be at least 8 characters."});if(M!==je)return U({type:"error",message:"Passwords do not match."});try{const{data:ke,error:Qe}=await ia(S.trim(),M);if(Qe){U({type:"error",message:`Failed to create auth user: ${String(Qe.message||Qe)}`});return}const et=(ze=ke==null?void 0:ke.user)!=null&&ze.id?String(ke.user.id):"";if(!et){U({type:"error",message:"Auth user ID missing after sign up."});return}ce=et}catch(ke){U({type:"error",message:`Failed to create auth user: ${String((ke==null?void 0:ke.message)||ke)}`});return}ve=await Tt(M)}else if(o==="edit"&&M){if(M.length<8)return U({type:"error",message:"Password must be at least 8 characters."});if(M!==je)return U({type:"error",message:"Passwords do not match."});ve=await Tt(M)}const Pe={id:ce,firstName:I.trim(),lastName:O.trim(),mi:W?W.trim().toUpperCase():void 0,email:S.trim(),edipi:z,service:l,rank:L,role:Q,company:D||"N/A",unit:(C==null?void 0:C.unitName)||"N/A",unitUic:C==null?void 0:C.uic,passwordHash:ve,isUnitAdmin:o==="create"&&C&&!fe?!0:H,roleCompany:P||void 0,rolePlatoon:le||void 0,platoon:E||"N/A"};try{const ke=await Ke({id:Pe.id,email:Pe.email,rank:Pe.rank,firstName:Pe.firstName,lastName:Pe.lastName,mi:Pe.mi,service:Pe.service,role:Pe.role,unitUic:Pe.unitUic,unit:(C==null?void 0:C.unitName)||"N/A",company:Pe.company,isUnitAdmin:!!Pe.isUnitAdmin,edipi:String(Pe.edipi),passwordHash:ve,platoon:E||"N/A",roleCompany:P||void 0,rolePlatoon:le||void 0});if(!ke.ok){U({type:"error",message:`Failed to save profile: ${String(((qe=ke==null?void 0:ke.error)==null?void 0:qe.message)||(ke==null?void 0:ke.error)||"unknown")}`});return}U({type:"success",message:a.id?"Profile updated.":C&&!fe?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),t==null||t(Pe)}catch{U({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:o==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:Ze,className:"space-y-6",children:[o==="create"&&C&&!fe&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:C.unitName})," (UIC ",C.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:O,onChange:b=>T(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:j})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:I,onChange:b=>A(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:j})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:W,maxLength:1,onChange:b=>X(b.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:j})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:S,onChange:b=>J(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:j})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:z,onChange:b=>V(b.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:j}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:l,onChange:b=>ee(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:j,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(Zt).map(b=>e.jsx("option",{value:b,children:b},b))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:L,onChange:b=>_(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:j,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),p.map(b=>e.jsx("option",{value:b,children:b},b))]})]}),o==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:M,onChange:b=>he(b.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:j}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:je,onChange:b=>we(b.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:j})]})]}):e.jsx(e.Fragment,{})]})]}),Re&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:M,onChange:b=>he(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:j}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:je,onChange:b=>we(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:j})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>Ce(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>Ce(!1),children:"Save"})]})]})}),o==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:Q,onChange:b=>y(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:oa.map(b=>e.jsx("option",{value:b,children:b},b))})}),e.jsx("div",{children:e.jsxs("select",{value:P||String(a.roleCompany||""),onChange:b=>se(b.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Ne.length?"Select company":"No companies configured"}),Ne.map(b=>e.jsx("option",{value:b,children:b},b))]})}),e.jsx("div",{children:e.jsxs("select",{value:le||String(a.rolePlatoon||""),onChange:b=>oe(b.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:pe.length?"Select platoon":"No platoons configured"}),pe.map(b=>e.jsx("option",{value:b,children:b},b))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:H,onChange:b=>h(b.target.checked),disabled:j||!R}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(a==null?void 0:a.isCommandStaff)||Q==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(ra,{onUnitSelect:b=>v(b),selectedUnit:C})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:D||String(a.company||""),onChange:b=>q(b.target.value),disabled:j||!C||xe.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:xe.length?"Select company":"No companies configured"}),xe.map(b=>e.jsx("option",{value:b,children:b},b))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:E||String(a.platoon||""),onChange:b=>G(b.target.value),disabled:j||!C||!D||De.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:De.length?"Select platoon":"No platoons configured"}),De.map(b=>e.jsx("option",{value:b,children:b},b))]})]})]})})]}),Y&&e.jsx("div",{className:`p-3 rounded-lg border ${Y.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:Y.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[o==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>Ce(!0),disabled:j,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:j,children:o==="edit"?"Save":"Create Profile"})]})]})]})},ca=s.memo(function({user:a,onClose:o}){const j=()=>{const d=Ue.find(I=>I.uic===a.unitUic),R=d?d.unitName:a.unit;if(a.isUnitAdmin||a.role==="COMMANDER")return R||"â€”";if(a.role==="COMPANY_REVIEWER")return a.company&&a.company!=="N/A"?a.company:"â€”";if(a.role==="PLATOON_REVIEWER"){const I=a.company&&a.company!=="N/A"?a.company:"",A=a.platoon&&a.platoon!=="N/A"?a.platoon:"",O=[I,A].filter(Boolean);return O.length?O.join(" / "):"â€”"}return"â€”"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:o,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:o,children:"âœ•"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:a.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:a.edipi||"â€”"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:a.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:a.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:j()})]}),a.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),a.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:o,children:"Close"})})]})})}),la=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],da=()=>{const[t,a]=s.useState(null),[o,j]=s.useState(void 0),[d,R]=s.useState({}),[I,A]=s.useState({}),[O,T]=s.useState({}),[W,X]=s.useState({}),[S,J]=s.useState(""),[z,V]=s.useState(""),[l,ee]=s.useState(""),[L,_]=s.useState(""),[Q,y]=s.useState(""),[H,h]=s.useState([]),[D,q]=s.useState(null),[E,G]=s.useState(""),C=s.useRef(null),[v,Y]=s.useState(null),[U,K]=s.useState(null),[ie,M]=s.useState(""),[he,je]=s.useState(void 0),[we,be]=s.useState(void 0),[Se,fe]=s.useState(void 0),[N,P]=s.useState(void 0),[se,le]=s.useState(void 0),[oe,Re]=s.useState(void 0),[Ce,ye]=s.useState([]),[$e,Ae]=s.useState([]),[m,w]=s.useState(""),[Z,ae]=s.useState("unit"),[ue,p]=s.useState([]),[k,i]=s.useState(!1),[c,F]=s.useState(!1),[te,me]=s.useState(!1),[xe,De]=s.useState("admin"),[Ne,pe]=s.useState(!0),[Ie,Ve]=s.useState(null),[Ze,b]=s.useState(0),ce=s.useRef(!1);s.useEffect(()=>{v&&xe==="admin"&&!ce.current&&(!he&&v.company&&v.company!=="N/A"&&(je(v.company),fe(v.company)),!we&&v.platoon&&v.platoon!=="N/A"&&(be(v.platoon),P(v.platoon)),!se&&v.roleCompany&&v.roleCompany!=="N/A"&&le(v.roleCompany),!oe&&v.rolePlatoon&&v.rolePlatoon!=="N/A"&&Re(v.rolePlatoon),ce.current=!0)},[v,xe]),s.useEffect(()=>{try{const n=localStorage.getItem("unit_structure");n&&R(JSON.parse(n))}catch{}try{const n=localStorage.getItem("unit_structure"),u={},$={},r={};if(n){const x=JSON.parse(n);for(const f of Object.keys(x||{})){const g=x[f];g&&Array.isArray(g._sections)&&(u[f]=g._sections),g&&Array.isArray(g._commandSections)&&($[f]=g._commandSections),g&&g._platoonSectionMap&&typeof g._platoonSectionMap=="object"&&(r[f]=g._platoonSectionMap)}}else(async()=>{try{const x=await jt();for(const f of Object.keys(x||{})){const g=x[f];g&&Array.isArray(g._sections)&&(u[f]=g._sections),g&&Array.isArray(g._commandSections)&&($[f]=g._commandSections),g&&g._platoonSectionMap&&typeof g._platoonSectionMap=="object"&&(r[f]=g._platoonSectionMap)}R(x)}catch{}})();A(u),T($),X(r)}catch{}(async()=>{pe(!0),Ve(null);try{const n=await Nt();if(n.error)throw new Error(n.error);h(n.data),b(n.data.length)}catch(n){const u=(n==null?void 0:n.message)||"Unknown error fetching users";console.error("[AdminPanel] Failed to fetch users:",u),Ve(u),h([]),b(0)}finally{pe(!1)}})();try{const n=localStorage.getItem("currentUser");if(n){const u=JSON.parse(n);if(a(u),u.unitUic){const $=Ue.find(r=>r.uic===u.unitUic);$&&j($)}}}catch{}},[]),s.useEffect(()=>{try{if(!o){const n=Object.keys(d||{});if(n.length){const u=n[0],$=d[u]||{},x=Ue.find(f=>f.uic===u)||{ruc:String($._ruc||""),mcc:String($._mcc||""),uic:u,unitName:String($._unitName||u),streetAddress:String($._streetAddress||"")};j(x)}}}catch{}},[d]),s.useEffect(()=>{const n=(v==null?void 0:v.unitUic)||"";if(!n){ye([]);return}os(n).then(u=>ye(u||[])).catch(()=>ye([]))},[v]),s.useEffect(()=>{const n=(v==null?void 0:v.unitUic)||"",u=se||"";if(!n||!u){Ae([]);return}Ot(n,u).then($=>Ae($||[])).catch(()=>Ae([]))},[v,se]);const ve=s.useMemo(()=>{const n=(o==null?void 0:o.uic)||"";if(!n)return[];const u=d[n]||{};return Object.keys(u).filter($=>!$.startsWith("_")&&Array.isArray(u[$]))},[o,d]),Pe=s.useMemo(()=>{var $;const n=(o==null?void 0:o.uic)||"";if(!n||!S)return[];const u=($=d[n])==null?void 0:$[S];return Array.isArray(u)?u:[]},[o,S,d]),ze=s.useMemo(()=>{const n=(o==null?void 0:o.uic)||"";return n?I[n]||[]:[]},[o,I]),qe=s.useMemo(()=>{const n=(o==null?void 0:o.uic)||"";return n?O[n]||[]:[]},[o,O]),ke=s.useMemo(()=>{const n=(v==null?void 0:v.unitUic)||"";if(!n)return[];const u=Ce;if(u&&u.length)return u;const $=d[n]||{};return Object.keys($).filter(r=>!r.startsWith("_")&&Array.isArray($[r]))},[v,d,Ce]),Qe=s.useMemo(()=>{var r;const n=(v==null?void 0:v.unitUic)||"",u=Se||"";if(!n||!u)return[];const $=(r=d[n])==null?void 0:r[u];return Array.isArray($)?$:[]},[v,Se,d]),et=s.useMemo(()=>{var x,f;const n=(v==null?void 0:v.unitUic)||"",u=se||"";if(!u)return[];const $=$e;if($&&$.length>0)return $;if(n){const g=(x=d[n])==null?void 0:x[u];if(Array.isArray(g)&&g.length>0)return g}const r=(o==null?void 0:o.uic)||"";if(r&&r!==n){const g=(f=d[r])==null?void 0:f[u];if(Array.isArray(g))return g}return[]},[v,se,d,$e,o]),xt=s.useMemo(()=>{const n=ke.slice(),u=he||(v&&v.company!=="N/A"?v.company:"");return u&&!n.includes(u)?[u,...n]:n},[ke,he,v]);s.useMemo(()=>{const n=Qe.slice(),u=N||(v&&v.platoon&&v.platoon!=="N/A"?v.platoon:"");return u&&!n.includes(u)?[u,...n]:n},[Qe,N,v]);const ot=s.useMemo(()=>{const n=et.slice(),u=oe||(v&&v.rolePlatoon&&v.rolePlatoon!=="N/A"?v.rolePlatoon:"");return u&&!n.includes(u)?[u,...n]:n},[et,oe,v]),nt=s.useMemo(()=>o?H.filter(n=>{const u=String(n.unitUic||"").trim().toUpperCase(),$=String(o.uic||"").trim().toUpperCase(),r=String(n.unit||"").trim().toLowerCase(),x=String(o.unitName||"").trim().toLowerCase();return u&&u===$||r&&r===x}):H,[H,o]),pt=s.useMemo(()=>{if(!E)return nt;const n=E.toLowerCase();return nt.filter(u=>(u.email??"").toLowerCase().includes(n)||(u.lastName??"").toLowerCase().includes(n))},[nt,E]),wt=()=>{try{if(o){const n=o.uic,u={...d};u[n]=u[n]||{},u[n]._mcc=o.mcc||u[n]._mcc||"",u[n]._unitName=o.unitName||u[n]._unitName||"",R(u),localStorage.setItem("unit_structure",JSON.stringify(u)),(async()=>{try{if(navigator.sendBeacon){const r=new Blob([JSON.stringify(u)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",r),q({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),keepalive:!0})).ok)throw new Error("persist_failed");q({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{q({type:"error",message:"Failed to persist unit structure."})}})()}else{const n=JSON.stringify(d);localStorage.setItem("unit_structure",n),(async()=>{try{if(navigator.sendBeacon){const $=new Blob([n],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",$),q({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:n,keepalive:!0})).ok)throw new Error("persist_failed");q({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{q({type:"error",message:"Failed to persist unit structure."})}})()}}catch{q({type:"error",message:"Failed to save unit structure."})}},ht=()=>{try{if(!o)return;const n=o.uic,u={...d};u[n]=u[n]||{},u[n]._sections=I[n]||[],u[n]._mcc=o.mcc||u[n]._mcc||"",u[n]._unitName=o.unitName||u[n]._unitName||"",R(u),localStorage.setItem("unit_structure",JSON.stringify(u)),(async()=>{try{if(navigator.sendBeacon){const r=new Blob([JSON.stringify(u)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",r),q({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),keepalive:!0})).ok)throw new Error("persist_failed");q({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{q({type:"error",message:"Failed to persist unit sections."})}})()}catch{q({type:"error",message:"Failed to save unit sections."})}},St=()=>{try{if(!o)return;const n=o.uic,u={...d};u[n]=u[n]||{},u[n]._commandSections=O[n]||[],u[n]._mcc=o.mcc||u[n]._mcc||"",u[n]._unitName=o.unitName||u[n]._unitName||"",R(u),localStorage.setItem("unit_structure",JSON.stringify(u)),(async()=>{try{if(navigator.sendBeacon){const r=new Blob([JSON.stringify(u)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",r),q({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),keepalive:!0})).ok)throw new Error("persist_failed");q({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{q({type:"error",message:"Failed to persist command sections."})}})()}catch{q({type:"error",message:"Failed to save command sections."})}},ct=()=>{try{if(!o)return;const n=o.uic,u={...d};u[n]=u[n]||{},u[n]._platoonSectionMap=W[n]||{},u[n]._mcc=o.mcc||u[n]._mcc||"",u[n]._unitName=o.unitName||u[n]._unitName||"",R(u),localStorage.setItem("unit_structure",JSON.stringify(u)),(async()=>{try{if(navigator.sendBeacon){const r=new Blob([JSON.stringify(u)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",r),q({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),keepalive:!0})).ok)throw new Error("persist_failed");q({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{q({type:"error",message:"Failed to persist links."})}})()}catch{q({type:"error",message:"Failed to save links."})}},Ct=()=>{if(!o||!z.trim())return;const n=o.uic,u={...d};u[n]=u[n]||{},u[n][z.trim()]||(u[n][z.trim()]=[],R(u),J(z.trim()),V(""))},At=n=>{if(!o)return;const u=o.uic,$={...d};$[u]&&(delete $[u][n],R($),S===n&&J(""))},gt=()=>{if(!o||!S||!l.trim())return;const n=o.uic,u={...d};u[n]=u[n]||{},u[n][S]=u[n][S]||[],u[n][S].includes(l.trim())||(u[n][S]=[...u[n][S],l.trim()],R(u),ee(""))},lt=n=>{if(!o||!S)return;const u=o.uic,$={...d};$[u][S]=($[u][S]||[]).filter(r=>r!==n),R($)},bt=()=>{if(!o||!L.trim())return;const n=o.uic,u={...I};u[n]=u[n]||[],u[n].includes(L.trim())||(u[n]=[...u[n],L.trim()],A(u),_(""))},kt=n=>{if(!o)return;const u=o.uic,$={...I};$[u]=($[u]||[]).filter(r=>r!==n),A($)},Et=()=>{if(!o||!Q.trim())return;const n=o.uic,u={...O};u[n]=u[n]||[],u[n].includes(Q.trim())||(u[n]=[...u[n],Q.trim()],T(u),y(""))},Ee=n=>{if(!o)return;const u=o.uic,$={...O};$[u]=($[u]||[]).filter(r=>r!==n),T($)},Rt=()=>{const n=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],u=H.map(g=>[g.firstName,g.mi||"",g.lastName,g.email,g.edipi,g.service,g.rank,g.role,g.company,g.unit,g.unitUic||""].map(B=>{const re=String(B??"");return re.includes(",")||re.includes('"')||re.includes(`
`)?'"'+re.replace(/"/g,'""')+'"':re}).join(",")),$="\uFEFF"+[n.join(","),...u].join(`
`),r=new Blob([$],{type:"text/csv;charset=utf-8"}),x=URL.createObjectURL(r),f=document.createElement("a");f.href=x,f.download="users-export.csv",f.click(),URL.revokeObjectURL(x)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${Z==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>ae("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${Z==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>ae("users"),children:"User Administration"})]})})}),Z==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:o?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:o.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",o.uic," | RUC: ",o.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:wt,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:z,onChange:n=>V(n.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Ct,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[ve.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>J(n),children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>At(n),children:"Remove"})]},n)),ve.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",S?`â€¢ ${S}`:""]}),o&&S&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ct,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:l,onChange:n=>ee(n.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!S}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:gt,disabled:!S,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Pe.map(n=>{var u,$;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:n})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:(($=(u=W[(o==null?void 0:o.uic)||""])==null?void 0:u[S])==null?void 0:$[n])||"",onChange:r=>{const x=(o==null?void 0:o.uic)||"";X(f=>{const g={...f};return g[x]=g[x]||{},g[x][S]=g[x][S]||{},g[x][S][n]=r.target.value,g})},children:[e.jsx("option",{value:"",children:"Link to section"}),(I[(o==null?void 0:o.uic)||""]||[]).map(r=>e.jsx("option",{value:r,children:r},r))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>lt(n),children:"Remove"})]})]},n)}),Pe.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ht,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:L,onChange:n=>_(n.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:bt,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[ze.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>kt(n),children:"Remove"})]},n)),ze.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:St,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:Q,onChange:n=>y(n.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Et,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[qe.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Ee(n),children:"Remove"})]},n)),qe.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),Z==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),Ie&&e.jsxs("div",{className:"mb-4 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:[e.jsx("strong",{children:"Error loading users:"})," ",Ie]}),Ne&&e.jsx("div",{className:"mb-4 p-3 border border-blue-200 bg-blue-50 text-blue-800 rounded",children:"Loading users..."}),!Ne&&!Ie&&Ze>0&&nt.length===0&&e.jsxs("div",{className:"mb-4 p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:[e.jsx("strong",{children:"Note:"})," ",Ze," user(s) found in database, but none match your unit (",(o==null?void 0:o.unitName)||"No unit selected",", UIC: ",(o==null?void 0:o.uic)||"N/A",").",e.jsx("br",{}),e.jsx("span",{className:"text-sm",children:"Users may be assigned to different units."})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[pt.map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[n.lastName,", ",n.firstName,n.mi?` ${n.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:n.email}),e.jsx("td",{className:"py-2 px-3",children:n.edipi}),e.jsx("td",{className:"py-2 px-3",children:n.service}),e.jsx("td",{className:"py-2 px-3",children:n.rank}),e.jsx("td",{className:"py-2 px-3",children:n.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const u=Ue.find(r=>r.uic===n.unitUic),$=u?u.unitName:n.unit;if(n.isUnitAdmin||n.role==="COMMANDER")return $||"â€”";if(n.role==="COMPANY_REVIEWER")return n.company&&n.company!=="N/A"?n.company:"â€”";if(n.role==="PLATOON_REVIEWER"){const r=n.company&&n.company!=="N/A"?n.company:"",x=n.platoon&&n.platoon!=="N/A"?n.platoon:"",f=[r,x].filter(Boolean);return f.length?f.join(" / "):"â€”"}return"â€”"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>K(n),children:"View"}),((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{De("admin"),Y(n),M(n.role??"MEMBER"),je(n.company!=="N/A"?n.company:void 0),fe(n.company!=="N/A"?n.company:void 0),be(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),P(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),w(typeof n.commandOrder=="number"?String(n.commandOrder):""),F(!!n.isUnitAdmin),me(!!n.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{h(u=>u.filter($=>$.id!==n.id));try{localStorage.removeItem(`fs/users/${n.id}.json`)}catch(u){console.error("Failed to remove user from localStorage",u)}},children:"Delete"})]})})]},n.id)),pt.length===0&&!Ne&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:Ie?"Failed to load users - check console for details":Ze===0?"No users found in database":E?"No users match your search":"No users in this unit"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:C,type:"text",placeholder:"Filter users...",value:E,onChange:n=>G(n.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var n;return(n=C.current)==null?void 0:n.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:Rt,children:"Export All"})]})]}),U&&e.jsx(ca,{user:U,onClose:()=>K(null)}),v&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>Y(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>Y(null),children:"âœ•"})]}),xe==="profile"&&t&&v&&t.edipi===v.edipi&&e.jsx(us,{mode:"edit",initial:v,readOnly:!1,onSaved:n=>{h(u=>u.map($=>$.edipi===n.edipi?n:$)),Y(null),q({type:"success",message:"Profile updated."})}}),xe==="admin"&&((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:ie,onChange:n=>{const u=n.target.value;M(u),u==="COMMANDER"&&(je(void 0),be(void 0))},className:"w-full px-3 py-2 border rounded",children:la.map(n=>e.jsx("option",{value:n,children:n},n))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:se||"",onChange:n=>le(n.target.value||void 0),disabled:!ie.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:xt.length?"Select company":"No companies configured"}),xt.map(n=>e.jsx("option",{value:n,children:n},n))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:oe||"",onChange:n=>Re(n.target.value||void 0),disabled:!ie.includes("REVIEW")||!se,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:ot.length?"Select platoon":"No platoons configured"}),ot.map(n=>e.jsx("option",{value:n,children:n},n))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:c,onChange:n=>F(n.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:te,disabled:ie==="COMMANDER",onChange:async n=>{const u=n.target.checked;me(u);try{if(v&&!(await Ke({id:v.id,email:v.email,rank:v.rank,firstName:v.firstName,lastName:v.lastName,mi:v.mi,service:v.service,role:v.role,unitUic:v.unitUic,unit:v.unit,company:v.company,isUnitAdmin:!!v.isUnitAdmin,isCommandStaff:u,edipi:v.edipi,passwordHash:v.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})]}),ue.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:ue.map((n,u)=>e.jsx("div",{className:"text-sm",children:n},u))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{Y(null),ce.current=!1,p([]),i(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${k?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":k,disabled:k,onClick:async()=>{var r;if(!v)return;const n=[];if(ie==="COMPANY_REVIEWER"&&!he&&n.push("Company is required for Company Reviewer."),ie==="PLATOON_REVIEWER"&&(!he||!we)&&n.push("Company and Platoon are required for Platoon Reviewer."),p(n),n.length)return;i(!0);const u=((r=Ue.find(x=>x.uic===v.unitUic))==null?void 0:r.unitName)||"N/A",$={...v,role:ie,isUnitAdmin:c,isCommandStaff:ie==="COMMANDER"?!1:te,company:Se||"N/A",unit:u,platoon:N||"N/A",roleCompany:ie.includes("REVIEW")?se||"N/A":void 0,rolePlatoon:ie.includes("REVIEW")?oe||"N/A":void 0};try{localStorage.setItem(`fs/users/${$.edipi}.json`,JSON.stringify($))}catch{}try{if(!(await Ke({id:$.id,email:$.email,rank:$.rank,firstName:$.firstName,lastName:$.lastName,mi:$.mi,service:$.service,role:$.role,unitUic:$.unitUic,unit:$.unit,company:$.company,isUnitAdmin:!!$.isUnitAdmin,isCommandStaff:!!$.isCommandStaff,edipi:$.edipi,passwordHash:$.passwordHash,roleCompany:$.roleCompany,rolePlatoon:$.rolePlatoon,platoon:$.platoon})).ok)throw new Error("persist_failed")}catch{i(!1),q({type:"error",message:"Failed to save administrative changes."});return}h(x=>x.map(f=>f.edipi===$.edipi?$:f));try{t&&t.edipi===$.edipi&&(localStorage.setItem("currentUser",JSON.stringify($)),a($))}catch{}Y(null),ce.current=!1,i(!1),q({type:"success",message:"Administrative changes saved."})},children:[k&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),D&&e.jsx("div",{className:`p-3 rounded-lg border ${D.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:D.message})]})};function ma(){const[t,a]=s.useState([]),[o,j]=s.useState(null),[d,R]=s.useState({}),[I,A]=s.useState({}),[O,T]=s.useState([]),[W,X]=s.useState("unit"),[S,J]=s.useState("assigned"),[z,V]=s.useState([]),[l,ee]=s.useState(""),[L,_]=s.useState([]),[Q,y]=s.useState(""),H=()=>{it().then(p=>a(p)).catch(()=>a([]))},h=()=>{vt().then(p=>T(p)).catch(()=>T([]))},D=()=>{j(null),H(),h()};s.useEffect(()=>{D(),cs().then(p=>V(p)),as().then(p=>_(p))},[W,S]);const q=s.useMemo(()=>{const p={};for(const k of t)k.isUnitAdmin&&k.unitUic&&(p[k.unitUic]=k);return p},[t]),E=s.useMemo(()=>{const p=new Set;return Ue.filter(k=>p.has(k.uic)?!1:(p.add(k.uic),!0))},[]),G=s.useMemo(()=>{const p={};for(const k of t)if(k.isInstallationAdmin&&k.installationId){const i=k.installationId;p[i]=p[i]||[],p[i].push(k)}return p},[t]),C=p=>t.filter(k=>k.unitUic===p.uic||!k.unitUic&&k.unit===p.unitName),v=async p=>{const k=d[p.uic];if(!k)return;const i=t.find(F=>F.id===k);if(!i)return;const c={...i,isUnitAdmin:!0,unitUic:p.uic,unit:p.unitName,company:"N/A"};try{if(!(await Ke({id:c.id,email:c.email,rank:c.rank,firstName:c.firstName,lastName:c.lastName,mi:c.mi,service:c.service,role:c.role,unitUic:c.unitUic,unit:c.unit,company:c.company,isUnitAdmin:!!c.isUnitAdmin,isInstallationAdmin:!!c.isInstallationAdmin,isCommandStaff:!!c.isCommandStaff,edipi:c.edipi})).ok){j({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}a(F=>F.map(te=>te.id===c.id?c:te)),j({type:"success",message:`Assigned ${c.rank} ${c.lastName} as admin for ${p.unitName}.`})},Y=s.useMemo(()=>E.filter(p=>!!q[p.uic]),[E,q]);s.useMemo(()=>(Array.isArray(t)?t:[]).filter(p=>!!p.isHqmcAdmin),[t]);const U=s.useMemo(()=>E.filter(p=>!q[p.uic]),[E,q]),K=s.useMemo(()=>(Array.isArray(z)?z:[]).filter(p=>{var k;return(k=G[p.id])==null?void 0:k.length}),[z,G]),ie=s.useMemo(()=>(Array.isArray(z)?z:[]).filter(p=>{var k;return!((k=G[p.id])!=null&&k.length)}),[z,G]),M=s.useMemo(()=>{const p={};for(const k of Array.isArray(t)?t:[])if(k.isHqmcAdmin&&k.hqmcDivision){const i=k.hqmcDivision;p[i]=p[i]||[],p[i].push(k)}return p},[t]),he=s.useMemo(()=>(Array.isArray(L)?L:[]).filter(p=>{var k;return(k=M[p.code])==null?void 0:k.length}),[L,M]);s.useMemo(()=>{const p=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return(Array.isArray(O)?O:[]).filter(k=>p.includes(String(k.currentStage||"")))},[O]);const[je,we]=s.useState(1),[be,Se]=s.useState(10),fe=Y.length,N=Math.max(1,Math.ceil(fe/(be||1))),P=Math.min(je,N),se=fe===0?0:(P-1)*be+1,le=fe===0?0:Math.min(se+be-1,fe),oe=Y.slice((P-1)*be,(P-1)*be+be),[Re,Ce]=s.useState(1),[ye,$e]=s.useState(10),Ae=U.length,m=Math.max(1,Math.ceil(Ae/(ye||1))),w=Math.min(Re,m),Z=Ae===0?0:(w-1)*ye+1,ae=Ae===0?0:Math.min(Z+ye-1,Ae),ue=U.slice((w-1)*ye,(w-1)*ye+ye);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${W==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{X("unit"),J("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${W==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{X("installation"),J("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${W==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{X("hqmc"),J("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${S==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>J("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${S==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>J("missing"),children:"Missing"})]}),W==="installation"&&S==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[K.map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.name}),e.jsx("td",{className:"py-2 px-3",children:(G[p.id]||[]).map(k=>`${k.rank} ${k.lastName}, ${k.firstName}${k.mi?` ${k.mi}`:""}`).join(" â€¢ ")})]},p.id)),K.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),W==="installation"&&S==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[ie.map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:I[p.id]||"",onChange:k=>A(i=>({...i,[p.id]:k.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(k=>e.jsx("option",{value:k.id,children:`${k.rank} ${k.lastName}, ${k.firstName}${k.mi?` ${k.mi}`:""}`},k.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!I[p.id],onClick:async()=>{const k=I[p.id],i=t.find(F=>F.id===k);if(!i)return;const c={...i,isInstallationAdmin:!0,installationId:p.id};try{if(!(await Ke({id:c.id,email:c.email,rank:c.rank,firstName:c.firstName,lastName:c.lastName,mi:c.mi,service:c.service,role:c.role,unitUic:c.unitUic,unit:c.unit,company:c.company,isUnitAdmin:!!c.isUnitAdmin,isInstallationAdmin:!!c.isInstallationAdmin,isCommandStaff:!!c.isCommandStaff,edipi:c.edipi,installationId:c.installationId})).ok){j({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}a(F=>F.map(te=>te.id===c.id?c:te)),j({type:"success",message:`Assigned ${c.rank} ${c.lastName} as installation admin.`})},children:"Assign"})})]},p.id)),ie.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),W==="unit"&&S==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[oe.map(p=>{const k=q[p.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.unitName}),e.jsx("td",{className:"py-2 px-3",children:p.uic}),e.jsx("td",{className:"py-2 px-3",children:`${k.rank} ${k.lastName}, ${k.firstName}${k.mi?` ${k.mi}`:""}`})]},p.uic)}),Y.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(_t,{currentPage:P,totalPages:N,totalItems:fe,pageSize:be,startIndex:se,endIndex:le,onPageChange:p=>we(p),onPageSizeChange:p=>{Se(p),we(1)},onNext:()=>we(Math.min(P+1,N)),onPrevious:()=>we(Math.max(P-1,1)),onFirst:()=>we(1),onLast:()=>we(N),canGoNext:P<N,canGoPrevious:P>1,pageSizeOptions:[5,10,25,50]})})]}),W==="unit"&&S==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[ue.map(p=>{const k=C(p);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.unitName}),e.jsx("td",{className:"py-2 px-3",children:p.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:d[p.uic]||"",onChange:i=>R(c=>({...c,[p.uic]:i.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:k.length?"Select user":"No eligible users"}),k.map(i=>e.jsx("option",{value:i.id,children:`${i.rank} ${i.lastName}, ${i.firstName}${i.mi?` ${i.mi}`:""}`},i.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!d[p.uic],onClick:()=>v(p),children:"Assign"})})]},p.uic)}),U.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(_t,{currentPage:w,totalPages:m,totalItems:Ae,pageSize:ye,startIndex:Z,endIndex:ae,onPageChange:p=>Ce(p),onPageSizeChange:p=>{$e(p),Ce(1)},onNext:()=>Ce(Math.min(w+1,m)),onPrevious:()=>Ce(Math.max(w-1,1)),onFirst:()=>Ce(1),onLast:()=>Ce(m),canGoNext:w<m,canGoPrevious:w>1,pageSizeOptions:[5,10,25,50]})})]}),W==="hqmc"&&S==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[he.map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[p.code," â€” ",p.name]}),e.jsx("td",{className:"py-2 px-3",children:(M[p.code]||[]).map(k=>`${k.rank} ${k.lastName}, ${k.firstName}${k.mi?` ${k.mi}`:""}`).join(" â€¢ ")})]},p.code)),he.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),W==="hqmc"&&S==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[L.filter(p=>{var k;return!((k=M[p.code])!=null&&k.length)}).map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[p.code," â€” ",p.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:I[`hqmc_${p.code}`]||"",onChange:k=>A(i=>({...i,[`hqmc_${p.code}`]:k.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(k=>e.jsx("option",{value:k.id,children:`${k.rank} ${k.lastName}, ${k.firstName}${k.mi?` ${k.mi}`:""}`},k.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!I[`hqmc_${p.code}`],onClick:async()=>{const k=I[`hqmc_${p.code}`],i=t.find(F=>F.id===k);if(!i)return;const c={...i,isHqmcAdmin:!0,hqmcDivision:p.code};try{if(!(await Ke({id:c.id,email:c.email,rank:c.rank,firstName:c.firstName,lastName:c.lastName,mi:c.mi,service:c.service,role:c.role,unitUic:c.unitUic,unit:c.unit,company:c.company,isUnitAdmin:!!c.isUnitAdmin,isInstallationAdmin:!!c.isInstallationAdmin,isCommandStaff:!!c.isCommandStaff,isHqmcAdmin:!!c.isHqmcAdmin,hqmcDivision:c.hqmcDivision,edipi:c.edipi})).ok){j({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}a(F=>F.map(te=>te.id===c.id?c:te)),j({type:"success",message:`Assigned ${c.rank} ${c.lastName} as HQMC admin for ${p.code}.`})},children:"Assign"})})]},p.code)),L.filter(p=>{var k;return!((k=M[p.code])!=null&&k.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),o&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${o.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:o.message})]})})}const es=!0,ua=({onLoggedIn:t,onCreateAccount:a})=>{const[o,j]=s.useState(""),[d,R]=s.useState(""),[I,A]=s.useState(null),[O,T]=s.useState(!0),[W,X]=s.useState(!0);vs.useEffect(()=>{},[]);const S=async J=>{J.preventDefault(),A(null);try{const z=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,V=/^[0-9]{10}$/.test(o),l=es?z.test(o.trim().toLowerCase())||V:z.test(o.trim().toLowerCase()),ee=d.length>=6;if(T(l),X(ee),!l){A({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!ee){A({type:"error",message:"Password must be at least 6 characters."});return}let L=null,_=null,Q=o.trim().toLowerCase();if(es&&V){const{user:G,error:C}=await $t(String(o));L=G,_=C,Q=String((L==null?void 0:L.email)||"")}else if(z.test(Q)){const{user:G,error:C}=await Ut(Q);L=G,_=C}else{A({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(_){A({type:"error",message:`Database Error: ${_}`});return}if(!L||!Q){A({type:"error",message:"Account not found."});return}const y=String(L.passwordHash||L.password_hash||"").trim();if(!y){A({type:"error",message:"No password set for this user."});return}const H=await Tt(d);if(!(/^[0-9a-f]{64}$/i.test(y)?y.toLowerCase()===H.toLowerCase():y===d)){A({type:"error",message:"Invalid credentials."});return}const{user:q,error:E}=await Ut(Q);if(E){A({type:"error",message:`Profile Error: ${E}`});return}if(!q){console.error("[Login] User profile not found after successful password verification",{emailForLogin:Q}),A({type:"error",message:"User profile not found."});return}A({type:"success",message:"Logged in."}),t(q)}catch(z){console.error("[Login] Login failed:",z),A({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:S,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:o,onChange:J=>j(J.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${O?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!O}),!O&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:d,onChange:J=>R(J.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${W?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!W}),!W&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),I&&e.jsx("div",{className:`p-3 rounded-lg border ${I.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:I.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:a,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!O||!W,children:"Login"})]})]})]})},ts=""+new URL("logo-DLcHofKE.png",import.meta.url).href,xa=({currentUser:t,hasSectionDashboard:a,hasCommandDashboard:o,hasInstallationSectionDashboard:j=!1,hasInstallationCommandDashboard:d=!1,hasHQMCSectionDashboard:R=!1,hasHQMCApproverDashboard:I=!1,onManageProfile:A,onLogout:O,onNavigate:T,isLogin:W=!1})=>{const[X,S]=s.useState(!1),[J,z]=s.useState(!1),V=s.useRef(null);return s.useEffect(()=>{const l=L=>{if(!X)return;const _=V.current;_&&L.target&&!_.contains(L.target)&&S(!1)},ee=L=>{L.key==="Escape"&&S(!1)};return document.addEventListener("mousedown",l),document.addEventListener("touchstart",l,{passive:!0}),document.addEventListener("keydown",ee),()=>{document.removeEventListener("mousedown",l),document.removeEventListener("touchstart",l),document.removeEventListener("keydown",ee)}},[X]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:W?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:ts,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:ts,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:t?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[t.rank," ",t.lastName,t.lastName?",":""," ",t.firstName,t.mi?` ${t.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[t.service," â€¢ ",t.role,(()=>{const l={PLATOON_REVIEWER:t.role_platoon,COMPANY_REVIEWER:t.role_company}[t.role];return l?` - ${l}`:null})()]}),(()=>{var Q;const l=((Q=Ue.find(y=>y.uic===((t==null?void 0:t.unitUic)||"")))==null?void 0:Q.unitName)||(t==null?void 0:t.unit)||"",ee=t!=null&&t.company&&t.company!=="N/A"?t.company:t!=null&&t.user_company&&t.user_company!=="N/A"?t.user_company:null,L=t!=null&&t.platoon&&t.platoon!=="N/A"?t.platoon:t!=null&&t.user_platoon&&t.user_platoon!=="N/A"?t.user_platoon:null,_=[l||null,ee,L].filter(Boolean);return _.length?e.jsx("div",{className:"text-xs text-white/70",children:_.join(" â€¢ ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:A,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:O,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),t&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>z(!J),children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),J&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{A(),z(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{O(),z(!1)},children:"Logout"})]})]}),!t&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>T("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:V,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":X,onClick:()=>S(l=>!l),children:"Dashboards"}),e.jsxs("div",{className:`${X?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:t&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{T("dashboard"),S(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(t==null?void 0:t.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{T("admin"),S(!1)},children:"Unit Admin"}),t&&!!t.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{T("appadmin"),S(!1)},children:"App Admin"}),t&&!!t.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{T("hqmc-admin"),S(!1)},children:"HQMC Admin"}),t&&!!t.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{T("installation"),S(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[t&&a&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{T("section"),S(!1)},children:"Unit Section Dashboard"}),o&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{T("command"),S(!1)},children:"Unit Command Dashboard"}),String((t==null?void 0:t.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{T("review"),S(!1)},children:"Unit Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[t&&j&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{T("installation-section"),S(!1)},children:"Installation Section Dashboard"}),t&&d&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{T("installation-command"),S(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[t&&(R||!!t.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{T("hqmc-section"),S(!1)},children:"HQMC Section Dashboard"}),t&&I&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{T("hqmc-approver"),S(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})},Be={SECTION:"perm_section",COMMAND:"perm_command",INST_SECTION:"perm_inst_section",INST_COMMAND:"perm_inst_command",HQMC_SECTION:"perm_hqmc_section",HQMC_APPROVER:"perm_hqmc_approver"},rt=t=>{try{return localStorage.getItem(t)==="true"}catch(a){return console.error(`Failed to read from localStorage for key "${t}":`,a),!1}};function pa(){const[t,a]=s.useState(null),[o,j]=s.useState("login"),[d,R]=s.useState(()=>{try{const h=localStorage.getItem("currentUser");return h?JSON.parse(h):null}catch(h){return console.error("Failed to parse user from localStorage:",h),null}}),[I,A]=s.useState("create"),[O,T]=s.useState(!1),[W,X]=s.useState(()=>rt(Be.SECTION)),[S,J]=s.useState(()=>rt(Be.COMMAND)),[z,V]=s.useState(()=>rt(Be.INST_SECTION)),[l,ee]=s.useState(()=>rt(Be.INST_COMMAND)),[L,_]=s.useState(()=>rt(Be.HQMC_SECTION)),[Q,y]=s.useState(()=>rt(Be.HQMC_APPROVER)),H=Ns();return s.useEffect(()=>{try{const D=new URLSearchParams(window.location.search).get("view");if(D==="admin"||D==="profile"||D==="dashboard"||D==="login"||D==="appadmin"||D==="hqmc-admin"||D==="hqmc-section"||D==="hqmc-approver"||D==="review"||D==="section"||D==="command"||D==="installation"||D==="installation-section"||D==="installation-command"||D==="documents"||D==="document-viewer"||D==="upload")j(D);else{const q=localStorage.getItem("currentView"),E=localStorage.getItem("currentUser");j(q&&E?q:"login")}}catch{j("login")}},[]),s.useEffect(()=>{d?localStorage.setItem("currentUser",JSON.stringify(d)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"),Object.values(Be).forEach(h=>{try{localStorage.removeItem(h)}catch(D){console.error(`Failed to remove item from localStorage for key "${h}":`,D)}}))},[d]),s.useEffect(()=>{if(!d)return;const h={[Be.SECTION]:W,[Be.COMMAND]:S,[Be.INST_SECTION]:z,[Be.INST_COMMAND]:l,[Be.HQMC_SECTION]:L,[Be.HQMC_APPROVER]:Q};for(const[D,q]of Object.entries(h))try{localStorage.setItem(D,String(q))}catch(E){console.error(`Failed to set item in localStorage for key "${D}":`,E)}},[d,W,S,z,l,L,Q]),s.useEffect(()=>{let h=!1;return(async()=>{try{const D=(d==null?void 0:d.id)||"";if(!D)return;const q=await is(D);if(q&&!h){const E=(v,Y)=>v===!0||v===!1?v:Y||!1,G=(v,Y)=>v!=null?v||void 0:Y,C={...q,isAppAdmin:E(q.isAppAdmin,d==null?void 0:d.isAppAdmin),isUnitAdmin:E(q.isUnitAdmin,d==null?void 0:d.isUnitAdmin),isInstallationAdmin:E(q.isInstallationAdmin,d==null?void 0:d.isInstallationAdmin),isHqmcAdmin:E(q.isHqmcAdmin,d==null?void 0:d.isHqmcAdmin),isCommandStaff:E(q.isCommandStaff,d==null?void 0:d.isCommandStaff),installationId:G(q.installationId,d==null?void 0:d.installationId),hqmcDivision:G(q.hqmcDivision,d==null?void 0:d.hqmcDivision)};R(C),localStorage.setItem("currentUser",JSON.stringify(C))}}catch{}})(),()=>{h=!0}},[]),s.useEffect(()=>{o!=="login"&&d&&localStorage.setItem("currentView",o)},[o,d]),s.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const D=await jt();localStorage.setItem("unit_structure",JSON.stringify(D))}catch(h){console.error("Failed to load unit structure:",h)}})()},[]),s.useEffect(()=>{var h,D,q;if(d){try{const E=localStorage.getItem("unit_structure");if(E){const G=JSON.parse(E),C=(d==null?void 0:d.unitUic)||"",v=d!=null&&d.company&&d.company!=="N/A"?d.company:"",Y=d!=null&&d.platoon&&d.platoon!=="N/A"?d.platoon:"",U=((q=(D=(h=G==null?void 0:G[C])==null?void 0:h._platoonSectionMap)==null?void 0:D[v])==null?void 0:q[Y])||"";X(!!U)}}catch(E){console.error("Failed to parse unit structure for section dashboard check",E)}J(!!(d!=null&&d.isCommandStaff)),(async()=>{try{const E=(d==null?void 0:d.installationId)||"";if(!E){V(!1),ee(!1);return}const G=await cs();try{localStorage.setItem("installations_cache",JSON.stringify(G))}catch{}const C=G==null?void 0:G.find(K=>K.id===E),v=(d==null?void 0:d.id)||"",Y=!!(C&&C.sectionAssignments&&Object.values(C.sectionAssignments).some(K=>Array.isArray(K)&&K.includes(v))),U=!!(C&&(C.commandSectionAssignments&&Object.values(C.commandSectionAssignments).some(K=>Array.isArray(K)&&K.includes(v))||C.commanderUserId&&String(C.commanderUserId)===v));V(Y),ee(U)}catch{}})(),(async()=>{try{const E=String((d==null?void 0:d.hqmcDivision)||""),G=String((d==null?void 0:d.id)||"");if(!E||!G){_(!!(d!=null&&d.isHqmcAdmin)),y(!1);return}const{listHQMCSectionAssignmentsLegacy:C}=await js(async()=>{const{listHQMCSectionAssignmentsLegacy:K}=await import("./db-DocjssFb.js").then(ie=>ie.A);return{listHQMCSectionAssignmentsLegacy:K}},__vite__mapDeps([0,1,2]),import.meta.url),v=await C(),Y=v.some(K=>K.division_code===E&&((K.reviewers||[]).includes(G)||(K.approvers||[]).includes(G))),U=v.some(K=>K.division_code===E&&(K.approvers||[]).includes(G));_(Y||!!(d!=null&&d.isHqmcAdmin)),y(U)}catch{d!=null&&d.isHqmcAdmin&&_(!0)}})()}},[d]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(xa,{currentUser:d,hasSectionDashboard:W,hasCommandDashboard:S,hasInstallationSectionDashboard:z,hasInstallationCommandDashboard:l,hasHQMCSectionDashboard:L,hasHQMCApproverDashboard:Q,onManageProfile:()=>{A("edit"),j("profile"),H("/?view=profile")},onLogout:()=>{R(null),j("login"),H("/?view=login")},onNavigate:h=>{j(h),H(`/?view=${h}`)},isLogin:o==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:o==="profile"?e.jsx(us,{mode:I,initial:I==="edit"?d||{}:{},onSaved:h=>{R(h),j("dashboard"),H("/?view=dashboard")}}):o==="admin"?e.jsx(da,{}):o==="appadmin"?e.jsx(ma,{}):o==="login"?e.jsx(ua,{onLoggedIn:h=>{R(h),j("dashboard"),H("/?view=dashboard")},onCreateAccount:()=>{A("create"),j("profile"),H("/?view=profile")}}):o==="review"?e.jsx(ea,{}):o==="section"?e.jsx(Os,{}):o==="command"?e.jsx(_s,{}):o==="installation"?e.jsx(Is,{}):o==="hqmc-admin"?e.jsx(ta,{}):o==="installation-section"?e.jsx(Ls,{}):o==="installation-command"?e.jsx(Ts,{}):o==="hqmc-section"?e.jsx(aa,{}):o==="hqmc-approver"?e.jsx(na,{}):e.jsx(Qs,{selectedUnit:t,currentUser:d})})]})}function Ea(){return e.jsx(pa,{})}export{Ea as default};
