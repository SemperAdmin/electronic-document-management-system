const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-txr9OHg1.js","./index-Dztzn6rj.js","./index-Oix-c3JW.css"])))=>i.map(i=>d[i]);
import{r as n,j as e,c as Ls,f as Os,a as $s,s as bs,S as Gt,v as _s,l as _t,M as Jt,b as Fs,u as fs,R as Ts,d as Bs,_ as Vs}from"./index-Dztzn6rj.js";import{s as He,g as ys,a as vs,b as js,u as ze,d as qs,c as Ws,e as Hs,l as Yt,f as yt,h as xt,i as Tt,j as Ct,k as at,m as Ys,n as Us,o as Ns,p as ws,q as Ut,r as zs,t as Ss,v as Bt,w as Cs,x as As,y as Vt,z as ks,A as Kt}from"./db-txr9OHg1.js";import{P as qt,I as Qs}from"./InstallationAdmin-CYddCxMN.js";import{f as Es,R as lt,S as Xe,o as Gs,c as Xt,a as Zt,b as Js,d as Ks,g as Xs}from"./RequestTable-BeMOMe1c.js";import{c as Zs,F as ea,D as Rs,a as ut}from"./DocumentListItem-Df6jmYpy.js";import{l as At}from"./unitStructure-QC5qYuxv.js";import ta from"./SectionDashboard-C2MVSx11.js";import sa from"./CommandDashboard-Cvr7K9xH.js";import aa from"./InstallationSectionDashboard-Cl-dQIEz.js";import na from"./InstallationCommandDashboard-CJ23ggHG.js";import{U as st}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-BYYPiji6.js";import"./utils-CLmukD0c.js";const ra={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},ia=({filters:s,onFiltersChange:r,statusOptions:o=[],originatorOptions:f=[],searchPlaceholder:d="Search requests...",showAdvanced:D=!0,className:I=""})=>{var Q;const[A,$]=n.useState(!1),L=n.useRef(null),q=n.useMemo(()=>Array.isArray(s.status)?s.status:[],[s.status]),se=n.useMemo(()=>{let v=0;return q.length>0&&v++,s.dateFrom&&v++,s.dateTo&&v++,s.originatorId&&v++,v},[q,s.dateFrom,s.dateTo,s.originatorId]),E=n.useCallback(v=>{r({...s,search:v.target.value})},[s,r]),K=n.useCallback(v=>{const Y=q.includes(v)?q.filter(p=>p!==v):[...q,v];r({...s,status:Y})},[s,q,r]),z=n.useCallback(v=>{r({...s,dateFrom:v.target.value})},[s,r]),T=n.useCallback(v=>{r({...s,dateTo:v.target.value})},[s,r]),m=n.useCallback(v=>{r({...s,originatorId:v.target.value})},[s,r]),ie=n.useCallback(()=>{var v;r(ra),(v=L.current)==null||v.focus()},[r]),B=n.useCallback(()=>{var v;r({...s,search:""}),(v=L.current)==null||v.focus()},[s,r]);n.useEffect(()=>{const v=Y=>{var p;(Y.metaKey||Y.ctrlKey)&&Y.key==="k"&&(Y.preventDefault(),(p=L.current)==null||p.focus())};return document.addEventListener("keydown",v),()=>document.removeEventListener("keydown",v)},[]);const _=s.search||se>0;return e.jsxs("div",{className:`space-y-3 ${I}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{ref:L,type:"text",value:s.search,onChange:E,placeholder:d,className:"block w-full pl-10 pr-10 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold bg-[var(--surface)] text-[var(--text)]","aria-label":"Search"}),s.search&&e.jsx("button",{onClick:B,className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600","aria-label":"Clear search",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute inset-y-0 right-8 flex items-center pointer-events-none text-xs text-gray-400",children:e.jsx("kbd",{className:"hidden sm:inline-block px-1.5 py-0.5 bg-gray-100 rounded border border-gray-200 font-mono",children:"âŒ˜K"})})]}),D&&e.jsxs("button",{onClick:()=>$(!A),className:`
              flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors
              ${A||se>0?"bg-brand-gold/10 border-brand-gold text-brand-navy":"border-brand-navy/30 text-[var(--text)] hover:bg-brand-cream/50"}
            `,"aria-expanded":A,"aria-controls":"filter-panel",children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"})}),e.jsx("span",{className:"hidden sm:inline",children:"Filters"}),se>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-brand-navy rounded-full",children:se})]}),_&&e.jsxs("button",{onClick:ie,className:"flex items-center gap-1 px-3 py-2 text-sm text-brand-red hover:text-brand-red-2 hover:bg-red-50 rounded-lg transition-colors","aria-label":"Clear all filters",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),D&&A&&e.jsxs("div",{id:"filter-panel",className:"p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[o.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Status"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:o.map(v=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-white/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:q.includes(v.value),onChange:()=>K(v.value),className:"h-4 w-4 text-brand-navy border-gray-300 rounded focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-[var(--text)]",children:v.label})]},v.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Date Range"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"From date"}),e.jsx("input",{type:"date",value:s.dateFrom,onChange:z,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"From date"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"To date"}),e.jsx("input",{type:"date",value:s.dateTo,onChange:T,min:s.dateFrom,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"To date"})]})]})]}),f.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Originator"}),e.jsxs("select",{value:s.originatorId,onChange:m,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"Filter by originator",children:[e.jsx("option",{value:"",children:"All originators"}),f.map(v=>e.jsx("option",{value:v.value,children:v.label},v.value))]})]})]}),se>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 pt-2 border-t border-brand-navy/10",children:[e.jsx("span",{className:"text-sm text-[var(--muted)]",children:"Active filters:"}),q.map(v=>{const Y=o.find(p=>p.value===v);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[(Y==null?void 0:Y.label)||v,e.jsx("button",{onClick:()=>K(v),className:"hover:text-brand-red","aria-label":`Remove ${(Y==null?void 0:Y.label)||v} filter`,children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},v)}),s.dateFrom&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["From: ",s.dateFrom,e.jsx("button",{onClick:()=>r({...s,dateFrom:""}),className:"hover:text-brand-red","aria-label":"Remove from date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),s.dateTo&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["To: ",s.dateTo,e.jsx("button",{onClick:()=>r({...s,dateTo:""}),className:"hover:text-brand-red","aria-label":"Remove to date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),s.originatorId&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[((Q=f.find(v=>v.value===s.originatorId))==null?void 0:Q.label)||"Originator",e.jsx("button",{onClick:()=>r({...s,originatorId:""}),className:"hover:text-brand-red","aria-label":"Remove originator filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]})]})};function oa(s,r){return n.useMemo(()=>{let o=Array.isArray(r.items)?r.items:[];const f=Array.isArray(s.status)?s.status:[];if(s.search){const d=s.search.toLowerCase();o=o.filter(D=>r.getSearchText(D).toLowerCase().includes(d))}return f.length>0&&r.getStatus&&(o=o.filter(d=>f.includes(r.getStatus(d)))),(s.dateFrom||s.dateTo)&&r.getDate&&(o=o.filter(d=>{const D=r.getDate(d);if(!D)return!1;const I=new Date(D);if(isNaN(I.getTime()))return!1;if(s.dateFrom){const A=new Date(s.dateFrom);if(I<A)return!1}if(s.dateTo){const A=new Date(s.dateTo);if(A.setHours(23,59,59,999),I>A)return!1}return!0})),s.originatorId&&r.getOriginatorId&&(o=o.filter(d=>r.getOriginatorId(d)===s.originatorId)),o},[s,r])}function es(s){if(s==null)return"";const r=String(s);return r.includes('"')||r.includes(",")||r.includes(`
`)||r.includes("\r")?`"${r.replace(/"/g,'""')}"`:r}function la(s,r){const f=r.map(D=>es(D.header)).join(","),d=s.map(D=>r.map(I=>{const A=I.getValue(D),$=I.format?I.format(A):A;return es($)}).join(","));return[f,...d].join(`\r
`)}function ca(s,r){const o=s.map(f=>{const d={};return r.forEach(D=>{const I=D.getValue(f);d[D.header]=D.format?D.format(I):I}),d});return JSON.stringify(o,null,2)}function ts(s,r,o){const f=new Blob([s],{type:`${o};charset=utf-8;`}),d=URL.createObjectURL(f),D=document.createElement("a");D.href=d,D.download=r,document.body.appendChild(D),D.click(),document.body.removeChild(D),URL.revokeObjectURL(d)}function da({items:s,columns:r,filename:o="export",label:f="Export",variant:d="secondary",className:D="",disabled:I=!1,showCount:A=!0,formats:$=["csv"]}){const[L,q]=n.useState(!1),[se,E]=n.useState(!1),K=n.useRef(null),z=n.useCallback(ie=>{E(!0),q(!1),setTimeout(()=>{try{const B=new Date().toISOString().slice(0,10),_=`${o}_${B}`;if(ie==="csv"){const Q=la(s,r);ts(Q,`${_}.csv`,"text/csv")}else{const Q=ca(s,r);ts(Q,`${_}.json`,"application/json")}}catch(B){console.error("Export failed:",B)}finally{E(!1)}},100)},[s,r,o]);n.useEffect(()=>{const ie=B=>{K.current&&!K.current.contains(B.target)&&q(!1)};return L&&document.addEventListener("mousedown",ie),()=>{document.removeEventListener("mousedown",ie)}},[L]),n.useEffect(()=>{const ie=B=>{B.key==="Escape"&&q(!1)};return L&&document.addEventListener("keydown",ie),()=>{document.removeEventListener("keydown",ie)}},[L]);const T={primary:"bg-brand-navy text-brand-cream hover:bg-brand-navy/90",secondary:"bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold/10",text:"text-brand-navy hover:bg-brand-cream/50"},m=I||s.length===0||se;return $.length===1?e.jsxs("button",{onClick:()=>z($[0]),disabled:m,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${T[d]}
          ${D}
        `,children:[se?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:f}),A&&s.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",s.length,")"]})]}):e.jsxs("div",{className:"relative",ref:K,children:[e.jsxs("button",{onClick:()=>q(!L),disabled:m,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${T[d]}
          ${D}
        `,"aria-expanded":L,"aria-haspopup":"menu",children:[se?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:f}),A&&s.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",s.length,")"]}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${L?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),L&&e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-[var(--surface)] border border-brand-navy/20 rounded-lg shadow-lg z-50",role:"menu",children:[$.includes("csv")&&e.jsxs("button",{onClick:()=>z("csv"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 first:rounded-t-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export as CSV"]}),$.includes("json")&&e.jsxs("button",{onClick:()=>z("json"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 last:rounded-b-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})}),"Export as JSON"]})]})]})}const ss=s=>{if(!s)return"";const r=new Date(s);return isNaN(r.getTime())?"":r.toLocaleDateString()},ma=({request:s})=>{if(!s.ssic)return e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg text-center",children:[e.jsx("div",{className:"text-[var(--muted)] text-sm",children:"No retention schedule assigned"}),e.jsx("div",{className:"text-xs text-[var(--muted)] mt-1",children:"SSIC classification was not set when this request was created"})]});const r=new Date(s.createdAt),o={ssic:s.ssic,nomenclature:s.ssicNomenclature||"",bucket:s.ssicBucket||"",bucketTitle:s.ssicBucketTitle||"",dau:s.dau||"",isPermanent:s.isPermanent||!1,cutoffTrigger:s.cutoffTrigger||"CALENDAR_YEAR",cutoffDescription:s.cutoffDescription||"",retentionValue:s.retentionValue??null,retentionUnit:s.retentionUnit||"YEARS",disposalAction:s.disposalAction||"DESTROY"},f=Ls(o,r),d=s.isPermanent||!1;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:`p-4 rounded-lg ${d?"bg-blue-50 border border-blue-200":"bg-amber-50 border border-amber-200"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`text-2xl ${d?"text-blue-600":"text-amber-600"}`,children:d?"ðŸ“":"â±ï¸"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-semibold text-[var(--text)]",children:[s.ssic," - ",s.ssicNomenclature]}),s.ssicBucketTitle&&e.jsx("div",{className:"text-sm text-[var(--muted)] mt-1",children:s.ssicBucketTitle}),e.jsx("div",{className:`text-xs font-medium uppercase tracking-wide mt-2 ${d?"text-blue-600":"text-amber-600"}`,children:d?"Permanent Record":"Temporary Record"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Retention Period"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:Os(o)})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Cutoff Trigger"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:$s(o.cutoffTrigger)}),s.cutoffDescription&&e.jsx("div",{className:"text-xs text-[var(--muted)] mt-1",children:s.cutoffDescription})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Disposal Action"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:d?"Transfer to National Archives":"Destroy"})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Record Created"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:r.toLocaleDateString()})]})]}),!d&&e.jsxs("div",{className:"p-4 bg-[var(--surface)] rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-2",children:"Estimated Disposal Eligibility"}),f?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-2xl font-bold text-brand-navy",children:f.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}),e.jsx("div",{className:"text-sm text-[var(--muted)]",children:f>new Date?e.jsxs(e.Fragment,{children:["(",Math.ceil((f.getTime()-Date.now())/(1e3*60*60*24))," days remaining)"]}):e.jsx("span",{className:"text-green-600 font-medium",children:"Eligible for disposal"})})]}):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"Unable to calculate - may require event date (case closure, separation, etc.)"})]}),s.dau&&e.jsxs("div",{className:"text-xs text-[var(--muted)] border-t border-brand-navy/10 pt-3",children:[e.jsx("span",{className:"font-medium",children:"Disposition Authority:"})," ",s.dau]})]})};function Wt(s,r={}){const{pageSize:o=25,initialPage:f=1}=r,[d,D]=n.useState(f),[I,A]=n.useState(o),$=s.length,L=Math.ceil($/I),q=(d-1)*I,se=Math.min(q+I,$);return{currentData:n.useMemo(()=>s.slice(q,se),[s,q,se]),currentPage:d,pageSize:I,totalPages:L,totalItems:$,goToPage:_=>{const Q=Math.max(1,Math.min(_,L));D(Q)},nextPage:()=>{d<L&&D(d+1)},previousPage:()=>{d>1&&D(d-1)},goToFirstPage:()=>{D(1)},goToLastPage:()=>{D(L)},setPageSize:_=>{A(_),D(1)},canGoNext:d<L,canGoPrevious:d>1,startIndex:q+1,endIndex:se}}const bt="edms-docs";function ua(){return{uploadFile:async(D,I)=>{if(!He)return{url:"",error:"Supabase not configured"};try{const{error:A}=await He.storage.from(bt).upload(I,D,{upsert:!0});if(A)return{url:"",error:A.message};const{data:$}=He.storage.from(bt).getPublicUrl(I);return{url:($==null?void 0:$.publicUrl)||""}}catch(A){return{url:"",error:A instanceof Error?A.message:"Upload failed"}}},deleteFile:async D=>{if(!He||!D)return!1;try{return await He.storage.from(bt).remove([D]),!0}catch{return!1}},deleteFolder:async D=>{if(!He)return!1;try{const{data:I}=await He.storage.from(bt).list(D.replace(/\/$/,""));if(I&&I.length>0){const A=I.map($=>`${D.replace(/\/$/,"")}/${$.name}`);await He.storage.from(bt).remove(A)}return!0}catch{return!1}},extractStoragePath:D=>{if(!D)return null;try{const I=D.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(I!=null&&I[1])return decodeURIComponent(I[1])}catch{}return null},buildStoragePath:(D,I,A,$)=>{const L=Date.now();return`${D||"N-A"}/${I}/${L}-${$}-${bs(A)}`}}}const Ze=s=>{const r=String(s||"").trim();return r&&r!=="N/A"?r:""},ot=(s,r,o)=>s.some(f=>String(f.role||"")!==r||Ze(f.roleCompany||f.company)!==o.company||r==="PLATOON_REVIEWER"&&Ze(f.rolePlatoon||f.platoon)!==(o.platoon||"")?!1:String(f.unitUic||"")===String(o.uic||""));var cs,ds;const xa=((ds=(cs=import.meta)==null?void 0:cs.env)==null?void 0:ds.VITE_NLF_URL)||"https://semperadmin.github.io/naval-letter-formatter";function pa(s){return s.category==="naval-letter"||s.name.startsWith("naval-letter-")||s.type==="application/json"&&s.name.includes("naval-letter")}function ha(s){const r=ys(),o=vs(),f=encodeURIComponent(window.location.href),d=new URLSearchParams({mode:"edit",documentId:s.id,returnUrl:f});return s.requestId&&d.set("edmsId",s.requestId),s.fileUrl&&d.set("fileUrl",s.fileUrl),r&&d.set("supabaseUrl",r),o&&d.set("supabaseKey",o),`${xa}?${d.toString()}`}function Ds(s){if(s===0)return"0 Bytes";const r=1024,o=["Bytes","KB","MB","GB"],f=Math.floor(Math.log(s)/Math.log(r));return parseFloat((s/Math.pow(r,f)).toFixed(2))+" "+o[f]}const as=n.memo(function({doc:r,onView:o,onDelete:f}){const[d,D]=n.useState(!1),I=r.fileUrl&&Zs(r.type,r.name),A=pa(r),$=L=>{L.stopPropagation();const q=ha(r);window.open(q,"_blank","noopener,noreferrer")};return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors gap-3","aria-label":`Document: ${r.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3 min-w-0",children:[e.jsx(ea,{type:r.type,fileName:r.name,size:"md"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h4",{className:"font-medium text-[var(--text)] truncate",children:r.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)] truncate",children:[r.name," â€¢ ",Ds(r.size)," â€¢ ",new Date(r.uploadedAt).toLocaleDateString()]}),r.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(r.dueDate).toLocaleDateString()]}),r.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1 truncate",children:["Notes: ",r.notes]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",role:"group","aria-label":"Document actions",children:[r.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Es({currentStage:r.currentStage})}),I&&e.jsx("button",{type:"button",onClick:L=>{L.stopPropagation(),D(!0)},className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Preview document ${r.name}`,children:"Preview"}),r.fileUrl&&A&&e.jsx("button",{type:"button",onClick:$,className:"px-3 py-1 text-xs bg-brand-navy text-brand-cream rounded hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Edit ${r.name} in Naval Letter Formatter`,children:"Edit in NLF"}),r.fileUrl&&!A&&e.jsx("a",{href:r.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${r.name} in new tab`,children:"Open"}),!A&&e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:L=>{L.stopPropagation(),o(r)},"aria-label":`View or edit document ${r.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:L=>{L.stopPropagation(),f(r)},"aria-label":`Delete document ${r.subject}`,children:"Delete"})]})]}),r.fileUrl&&e.jsx(Rs,{url:r.fileUrl,fileName:r.name,mimeType:r.type,fileSize:r.size,isOpen:d,onClose:()=>D(!1)})]})});async function ga(s,r){const o=js();return o!=null&&o.auth?await o.auth.signUp({email:s,password:r}):{data:null,error:new Error("supabase_not_initialized")}}async function ba(){const s=js();if(!(s!=null&&s.auth))return null;const{data:r}=await s.auth.getSession();return(r==null?void 0:r.session)??null}async function fa(){const s=await ba();return(s==null?void 0:s.access_token)??null}var ms,us;(us=(ms=import.meta)==null?void 0:ms.env)!=null&&us.VITE_NLF_URL;var xs,ps;const ya=((ps=(xs=import.meta)==null?void 0:xs.env)==null?void 0:ps.VITE_NLF_URL)||"https://semperadmin.github.io/naval-letter-formatter";function va({currentUser:s,onRequestCreated:r,className:o=""}){const[f,d]=n.useState(!1),[D,I]=n.useState(null),A=n.useCallback(async()=>{if(!(!s||f)){d(!0),I(null);try{const L=await fa(),q=crypto.randomUUID(),se=await ze({id:q,subject:"(Draft - Naval Letter in Progress)",uploadedById:s.id,unitUic:s.unitUic,documentIds:[],createdAt:new Date().toISOString(),currentStage:"ORIGINATOR_REVIEW",activity:[{actor:`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim(),actorRole:s.role,timestamp:new Date().toISOString(),action:"Created draft for Naval Letter"}]});if(!se.ok){I(se.error||"Failed to create draft request"),d(!1);return}const E=encodeURIComponent(window.location.href),K=ys(),z=vs(),T=new URLSearchParams({edmsId:q,unitCode:s.unitUic||"",returnUrl:E});K&&T.set("supabaseUrl",K),z&&T.set("supabaseKey",z),L&&T.set("token",L);const m=`${ya}?${T.toString()}`;r&&r(q),window.open(m,"_blank","noopener,noreferrer")}catch(L){console.error("Failed to create draft and launch NLF:",L),I("Failed to start naval letter")}finally{d(!1)}}},[s,r,f]),$=!s||f;return e.jsxs("div",{className:"inline-flex flex-col items-start",children:[e.jsxs("button",{type:"button",onClick:A,disabled:$,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          bg-brand-navy text-brand-cream
          hover:brightness-110
          focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          transition-colors
          ${o}
        `,"aria-describedby":D?"start-nlf-error":void 0,children:[f?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"})}),e.jsx("span",{children:f?"Creating...":"Start from Naval Letter"})]}),D&&e.jsx("p",{id:"start-nlf-error",className:"mt-1 text-xs text-red-600",role:"alert",children:D})]})}var hs,gs;(gs=(hs=import.meta)==null?void 0:hs.env)!=null&&gs.VITE_NLF_URL;const it="edms-docs",ja=({selectedUnit:s,currentUser:r})=>{const[o,f]=n.useState([]),[d,D]=n.useState(!1),[I,A]=n.useState(""),[$,L]=n.useState(""),[q,se]=n.useState(""),[E,K]=n.useState([]),[z,T]=n.useState(null),[m,ie]=n.useState(null),[B,_]=n.useState([]),[Q,v]=n.useState(!1),[Y,p]=n.useState(null),[P,W]=n.useState(""),[M,G]=n.useState(""),[k,j]=n.useState(""),[X,H]=n.useState([]),[te,de]=n.useState([]),[R,ye]=n.useState(null),[De,Ee]=n.useState(""),[ve,Le]=n.useState(""),[pe,Ae]=n.useState(""),[xe,be]=n.useState([]),[Oe,Fe]=n.useState(!1),[_e,Te]=n.useState({}),[we,Ve]=n.useState(""),[ke,Ce]=n.useState("Pending"),[h,C]=n.useState({}),[J,U]=n.useState({}),[g,N]=n.useState(""),[ae,F]=n.useState({}),[fe,Ie]=n.useState(""),[ne,qe]=n.useState(null),[Be,We]=n.useState("documents"),[Je,Ye]=n.useState(!1),[Me,t]=n.useState(null),[a,l]=n.useState(!1),[x,w]=n.useState(""),Z=ua(),oe=n.useMemo(()=>m?`${m.rank||""} ${m.lastName||""}, ${m.firstName||""}${m.mi?` ${m.mi}`:""}`.trim():"Unknown",[m]),le=c=>{const b=c.target.files?Array.from(c.target.files):[];if(b.length===0)return;if(E.length+b.length>Jt){T({type:"error",message:`Cannot add ${b.length} file(s). Maximum ${Jt} files allowed per request.`});try{c.target.value=""}catch{}return}const y=[],S=[];for(const V of b){const ce=Fs(V);ce.valid?y.push(V):S.push(...ce.errors)}y.length>0&&K(V=>[...V,...y]),S.length>0&&T({type:"error",message:S.slice(0,3).join(" ")+(S.length>3?` (+${S.length-3} more errors)`:"")});try{c.target.value=""}catch{}},me=()=>{if(!(R!=null&&R.ssic)){T({type:"error",message:"Request must have SSIC/retention classification before filing."});return}w(new Date().toISOString().split("T")[0]),l(!0)},$e=async()=>{if(!R||!(m!=null&&m.id))return;if(!x){T({type:"error",message:"Please select a finalized date."});return}const c=new Date(x+"T23:59:59").toISOString(),b={actor:oe,timestamp:new Date().toISOString(),action:"Filed for Records Management",comment:`Date Finalized: ${new Date(x).toLocaleDateString()}${pe!=null&&pe.trim()?` - ${pe.trim()}`:""}`},y={...R,currentStage:Xe.ARCHIVED,finalStatus:"Filed",filedAt:c,activity:Array.isArray(R.activity)?[...R.activity,b]:[b]};try{const S=await ze(y);if(!S.ok)throw new Error(Ke(S,"request_upsert_failed"));de(V=>V.map(ce=>ce.id===y.id?y:ce)),ye(y),l(!1),w(""),T({type:"success",message:"Request filed for records management."})}catch(S){T({type:"error",message:`Failed to file request: ${String((S==null?void 0:S.message)||S)}`})}},Se=async()=>{if(!R||!(m!=null&&m.id))return;const c=Xs(R.currentStage||"");if(!c){T({type:"error",message:"Cannot return from this stage."});return}const b=c===Xe.ORIGINATOR_REVIEW?"Originator":c===Xe.PLATOON_REVIEW?"Platoon":c===Xe.COMPANY_REVIEW?"Company":"Lower Level",y={actor:oe,actorRole:m.role||"Reviewer",timestamp:new Date().toISOString(),action:`Returned to ${b} for filing`,comment:(pe||"").trim()},S={...R,currentStage:c,activity:Array.isArray(R.activity)?[...R.activity,y]:[y]};try{const V=await ze(S);if(!V.ok)throw new Error(Ke(V,"request_upsert_failed"));de(ce=>ce.map(he=>he.id===S.id?S:he)),ye(S),Ae(""),T({type:"success",message:`Request returned to ${b}.`})}catch(V){T({type:"error",message:`Failed to return request: ${String((V==null?void 0:V.message)||V)}`})}},vt=async()=>{if(!R||!(m!=null&&m.id)||R.uploadedById!==m.id)return;const c=B.find(ge=>ge.id===R.uploadedById),b=R.unitUic||(c==null?void 0:c.unitUic)||"",y=Ze(c==null?void 0:c.company),S=Ze(c==null?void 0:c.platoon),V=ot(B,"PLATOON_REVIEWER",{company:y,platoon:S,uic:b}),ce=ot(B,"COMPANY_REVIEWER",{company:y,uic:b}),he=V?Xe.PLATOON_REVIEW:ce?Xe.COMPANY_REVIEW:Xe.BATTALION_REVIEW,ue={actor:`${m.rank} ${m.lastName}, ${m.firstName}${m.mi?` ${m.mi}`:""}`,actorRole:"Member",timestamp:new Date().toISOString(),action:"Resubmitted request",comment:(pe||"").trim()},Pe={...R,currentStage:he,routeSection:"",activity:[...R.activity||[],ue]};try{const ge=await ze(Pe);if(!ge.ok)throw new Error(Ke(ge,"request_upsert_failed"));de(Ne=>Ne.map(Qe=>Qe.id===Pe.id?Pe:Qe)),ye(Pe),Ae(""),T({type:"success",message:"Request resubmitted for review."})}catch(ge){T({type:"error",message:`Failed to resubmit: ${String((ge==null?void 0:ge.message)||ge)}`})}},ct=async c=>{c.preventDefault(),T(null);const b=I.trim();if(!b){T({type:"error",message:"Subject is required."});return}if(b.length>500){T({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(q.length>5e3){T({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(m!=null&&m.id)){T({type:"error",message:"Create a profile before submitting."});return}if(E.length>0){const ge=_s(E);if(!ge.valid){T({type:"error",message:ge.errors[0]});return}}D(!0);const y=Date.now(),S=we||m.id,V=B.find(ge=>ge.id===S),ce=s?s.uic:(V==null?void 0:V.unitUic)||"N/A",he=`req-${y}`;let ue=[];async function Pe(ge,Ne){if(!He)throw new Error("Supabase not configured");const{error:Qe}=await He.storage.from(it).upload(Ne,ge,{upsert:!0});if(Qe)throw new Error(Qe.message);const{data:rt}=He.storage.from(it).getPublicUrl(Ne);return(rt==null?void 0:rt.publicUrl)||""}if(E&&E.length>0){const ge=[];for(let Ne=0;Ne<E.length;Ne++){const Qe=E[Ne],rt=`${ce}/${he}/${y}-${Ne}-${bs(Qe.name)}`;try{const tt=await Pe(Qe,rt);ge.push(tt)}catch(tt){D(!1),T({type:"error",message:`Failed to upload ${Qe.name}: ${String((tt==null?void 0:tt.message)||tt)}`});return}}ue=E.map((Ne,Qe)=>({id:`${y}-${Qe}`,name:Ne.name,type:Ne.type,size:Ne.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:ce,subject:I.trim(),dueDate:$||void 0,notes:q.trim()||void 0,uploadedById:S,currentStage:"PLATOON_REVIEW",fileUrl:ge[Qe]}))}ue=ue.map(ge=>({...ge,requestId:he})),f(ge=>[...ge,...ue]),K([]),A(""),L(""),se("");try{const ge="Member",Ne=ce,Qe=Ze(V==null?void 0:V.company),rt=Ze(V==null?void 0:V.platoon),tt=ot(B,"PLATOON_REVIEWER",{company:Qe,platoon:rt,uic:Ne}),Qt=ot(B,"COMPANY_REVIEWER",{company:Qe,uic:Ne}),Ps=!tt&&!Qt,gt={id:he,subject:I.trim(),dueDate:$||void 0,notes:q.trim()||void 0,unitUic:ce,uploadedById:S,submitForUserId:S,documentIds:ue.map(Ue=>Ue.id),createdAt:new Date().toISOString(),currentStage:tt?Xe.PLATOON_REVIEW:Qt?Xe.COMPANY_REVIEW:Xe.BATTALION_REVIEW,routeSection:Ps&&fe?fe:void 0,ssic:ne==null?void 0:ne.ssic,ssicNomenclature:ne==null?void 0:ne.nomenclature,ssicBucket:ne==null?void 0:ne.bucket,ssicBucketTitle:ne==null?void 0:ne.bucketTitle,isPermanent:ne==null?void 0:ne.isPermanent,retentionValue:ne==null?void 0:ne.retentionValue,retentionUnit:ne==null?void 0:ne.retentionUnit,cutoffTrigger:ne==null?void 0:ne.cutoffTrigger,cutoffDescription:ne==null?void 0:ne.cutoffDescription,disposalAction:ne==null?void 0:ne.disposalAction,dau:ne==null?void 0:ne.dau,activity:[{actor:oe,actorRole:ge,timestamp:new Date().toISOString(),action:"Submitted request",comment:(q||"").trim()}]};try{const Ue=await ze(gt);if(!Ue.ok)throw new Error(Ke(Ue,"request_upsert_failed"));const $t=await Tt(ue);if(!$t.ok)throw new Error(Ke($t,"document_upsert_failed"))}catch(Ue){D(!1);try{_t("request_persist_failed",{requestId:he,error:String((Ue==null?void 0:Ue.message)||Ue)},"error")}catch{}T({type:"error",message:`Failed to persist submission: ${String((Ue==null?void 0:Ue.message)||Ue)}`});return}de(Ue=>Ue.some(wt=>wt.id===gt.id)?Ue.map(wt=>wt.id===gt.id?gt:wt):[...Ue,gt]),D(!1),T({type:"success",message:"Submission successful."}),v(!1),Ie(""),qe(null)}catch{D(!1);try{_t("request_persist_failed",{requestId:he},"error")}catch{}T({type:"error",message:"Failed to persist submission."})}},pt=n.useCallback(c=>{p(c),W(c.subject||""),G(c.dueDate||""),j(c.notes||"");try{const b=localStorage.getItem(`fs/requests/${c.requestId}.json`);if(b){const y=JSON.parse(b);H(Array.isArray(y.activity)?y.activity:[])}else{const V=Object.values(Object.assign({})).map(ce=>(ce==null?void 0:ce.default)??ce).find(ce=>ce&&ce.id===c.requestId);H(V&&Array.isArray(V.activity)?V.activity:[])}}catch{H([])}},[]),Ke=(c,b)=>{var y;return String(((y=c.error)==null?void 0:y.message)||c.error||b)},kt=async()=>{if(!Y)return;const c=o.map(b=>b.id===Y.id?{...b,subject:P.trim()||b.subject,dueDate:M||void 0,notes:k.trim()||void 0}:b);f(c);try{const y={actor:oe,actorRole:"Member",timestamp:new Date().toISOString(),action:"Updated document",comment:(k||"").trim()},S=Y.requestId?te.find(V=>V.id===Y.requestId):null;if(S){const V={...S,activity:Array.isArray(S.activity)?[...S.activity,y]:[y]};try{const ce=await ze(V);if(!ce.ok)throw new Error(Ke(ce,"request_upsert_failed"))}catch(ce){console.error("Failed to save document edits:",ce),T({type:"error",message:`Failed to save document edits: ${ce.message}`});return}H(ce=>[...ce,y])}}catch{}j(""),p(null)};o.filter(c=>!(!(m!=null&&m.id)||m.role==="MEMBER"&&c.uploadedById!==m.id||c.type==="request"));const Et=c=>c.currentStage==="ORIGINATOR_REVIEW",Rt=()=>String((m==null?void 0:m.role)||"").includes("REVIEW"),Dt=()=>{if(!Rt())return[];const c=String((m==null?void 0:m.role)||"");return B.filter(b=>{if(b.id===(m==null?void 0:m.id))return!1;if(c.includes("PLATOON")){const y=b.company&&b.company!=="N/A"?b.company:"",S=b.unit&&b.unit!=="N/A"?b.unit:"",V=m!=null&&m.company&&m.company!=="N/A"?m.company:"",ce=m!=null&&m.unit&&m.unit!=="N/A"?m.unit:"";return y===V&&S===ce}if(c.includes("COMPANY")){const y=b.company&&b.company!=="N/A"?b.company:"",S=m!=null&&m.company&&m.company!=="N/A"?m.company:"";return y===S}return c.includes("COMMANDER")?(b.unitUic||"")===((m==null?void 0:m.unitUic)||""):!1})},jt=n.useCallback(async c=>{const b=Z.extractStoragePath(c.fileUrl);try{b&&He&&await He.storage.from(it).remove([b])}catch{}try{await qs(c.id),f(y=>y.filter(S=>S.id!==c.id)),c.requestId&&de(y=>y.map(S=>S.id===c.requestId?{...S,documentIds:(S.documentIds||[]).filter(V=>V!==c.id)}:S)),T({type:"success",message:"Document deleted."})}catch(y){T({type:"error",message:`Failed to delete: ${String((y==null?void 0:y.message)||y)}`})}},[]),It=n.useCallback(async c=>{const b=`${c.unitUic||"N-A"}/${c.id}/`;try{if(He){const{data:y}=await He.storage.from(it).list(b.slice(0,-1));if(y&&y.length>0){const S=y.map(V=>`${b.slice(0,-1)}/${V.name}`);await He.storage.from(it).remove(S)}}}catch{}try{await Ws(c.id),await Hs(c.id),f(y=>y.filter(S=>S.requestId!==c.id)),de(y=>y.filter(S=>S.id!==c.id)),ye(null),T({type:"success",message:"Request and files deleted."})}catch(y){T({type:"error",message:`Failed to delete request: ${String((y==null?void 0:y.message)||y)}`})}},[]),Mt=async()=>{if(!R||!(m!=null&&m.id)||R.uploadedById!==m.id){T({type:"error",message:"Only the requester can edit this."});return}const c=Date.now(),b=he=>he.replace(/[^A-Za-z0-9._-]/g,"-");async function y(he,ue){if(!He)throw new Error("Supabase not configured");const{error:Pe}=await He.storage.from(it).upload(ue,he,{upsert:!0});if(Pe)throw new Error(Pe.message);const{data:ge}=He.storage.from(it).getPublicUrl(ue);return(ge==null?void 0:ge.publicUrl)||""}const S=[];for(let he=0;he<xe.length;he++){const ue=xe[he],Pe=`${R.unitUic||"N-A"}/${R.id}/${c}-${he}-${b(ue.name)}`;try{const ge=await y(ue,Pe);S.push(ge)}catch(ge){T({type:"error",message:`Failed to upload ${ue.name}: ${String((ge==null?void 0:ge.message)||ge)}`});return}}const V=xe.map((he,ue)=>({id:`${c}-${ue}`,name:he.name,type:he.type,size:he.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:R.unitUic||"N/A",subject:De.trim()||R.subject,dueDate:ve||void 0,notes:pe.trim()||void 0,uploadedById:m.id,currentStage:R.currentStage||"PLATOON_REVIEW",requestId:R.id,fileUrl:S[ue]})),ce={...R,subject:De.trim()||R.subject,dueDate:ve||void 0,notes:pe.trim()||void 0,documentIds:[...R.documentIds||[],...V.map(he=>he.id)],activity:[...R.activity||[],{actor:`${m.rank} ${m.lastName}, ${m.firstName}${m.mi?` ${m.mi}`:""}`,timestamp:new Date().toISOString(),action:V.length?`Updated request and added ${V.length} document(s)`:"Updated request",comment:(pe||"").trim()}]};try{if(!(m&&Xt(R,String(m.id||"")))){T({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const ue=await Tt(V);if(!ue.ok)throw new Error(Ke(ue,"document_upsert_failed"));const Pe=await ze(ce);if(!Pe.ok)throw new Error(Ke(Pe,"request_upsert_failed"))}catch(ue){try{_t("request_update_failed",{requestId:ce.id,error:String((ue==null?void 0:ue.message)||ue)},"error")}catch{}T({type:"error",message:`Failed to persist documents: ${String((ue==null?void 0:ue.message)||ue)}`});return}f(ue=>[...ue,...V]),de(ue=>ue.map(Pe=>Pe.id===ce.id?ce:Pe)),ye(ce),be([]),Ae(""),T({type:"success",message:V.length?"Files added and request updated.":"Request updated."})}catch{T({type:"error",message:"Failed to update request."})}},Pt=async()=>{if(!R||!m||!Me)return;const c=m.role||"Reviewer",b={actor:oe,actorRole:c,timestamp:new Date().toISOString(),action:"Updated retention classification",comment:`Changed SSIC to ${Me.ssic} - ${Me.nomenclature}`},y={...R,ssic:Me.ssic,ssicNomenclature:Me.nomenclature,ssicBucket:Me.bucket,ssicBucketTitle:Me.bucketTitle,isPermanent:Me.isPermanent,retentionValue:Me.retentionValue,retentionUnit:Me.retentionUnit,cutoffTrigger:Me.cutoffTrigger,cutoffDescription:Me.cutoffDescription,disposalAction:Me.disposalAction,dau:Me.dau,activity:[...R.activity||[],b]};try{const S=await ze(y);if(!S.ok)throw new Error(Ke(S,"request_upsert_failed"));de(V=>V.map(ce=>ce.id===y.id?y:ce)),ye(y),Ye(!1),t(null),T({type:"success",message:"Retention classification updated."})}catch(S){T({type:"error",message:`Failed to update retention: ${String((S==null?void 0:S.message)||S)}`})}},[Nt,Lt]=n.useState(!0),[ht,Ot]=n.useState(!0);n.useEffect(()=>{Yt().then(c=>{f(c)}).catch(()=>f([])).finally(()=>Lt(!1))},[]),n.useEffect(()=>{R&&(Ee(R.subject||""),Le(R.dueDate||""),Ae(R.notes||""),be([]),Ye(!1),t(null))},[R]),n.useEffect(()=>{},[o]),n.useEffect(()=>{yt().then(c=>{de(c)}).catch(()=>de([])).finally(()=>Ot(!1))},[]),n.useEffect(()=>{ie(r||null)},[r]),n.useEffect(()=>{xt().then(c=>{_(c)}).catch(()=>_([]))},[]),n.useEffect(()=>{try{const c=localStorage.getItem("unit_structure"),b={};if(c){const y=JSON.parse(c);for(const S of Object.keys(y||{})){const V=y[S];V&&Array.isArray(V._sections)&&(b[S]=V._sections)}F(b)}else(async()=>{try{const y=await At();for(const S of Object.keys(y||{})){const V=y[S];V&&Array.isArray(V._sections)&&(b[S]=V._sections)}F(b)}catch{}})()}catch{}},[]);const i=n.useMemo(()=>m!=null&&m.id?te.filter(b=>b.uploadedById===m.id).filter(b=>b.currentStage!=="ARCHIVED"):[],[te,m]),u=n.useCallback(c=>{if(c.isPermanent)return"Permanent";if(!c.retentionValue||!c.cutoffTrigger||!c.filedAt)return"Unknown";const b=new Date(c.filedAt);let y;switch(c.cutoffTrigger){case"CALENDAR_YEAR":y=new Date(b.getFullYear(),11,31);break;case"FISCAL_YEAR":y=b.getMonth()>=9?new Date(b.getFullYear()+1,8,30):new Date(b.getFullYear(),8,30);break;default:y=b}const S=new Date(y),V=(c.retentionUnit||"").toLowerCase();return V==="years"?S.setFullYear(S.getFullYear()+c.retentionValue):V==="months"?S.setMonth(S.getMonth()+c.retentionValue):V==="days"&&S.setDate(S.getDate()+c.retentionValue),S.getFullYear().toString()},[]),O=n.useMemo(()=>{if(!(m!=null&&m.id))return{};let c=te.filter(y=>y.uploadedById===m.id&&y.ssic&&y.filedAt);if(g.trim()){const y=g.toLowerCase().trim();c=c.filter(S=>{var V,ce,he,ue,Pe;return((V=S.subject)==null?void 0:V.toLowerCase().includes(y))||((ce=S.ssic)==null?void 0:ce.toLowerCase().includes(y))||((he=S.ssicNomenclature)==null?void 0:he.toLowerCase().includes(y))||((ue=S.ssicBucketTitle)==null?void 0:ue.toLowerCase().includes(y))||((Pe=S.notes)==null?void 0:Pe.toLowerCase().includes(y))})}const b={};for(const y of c){const S=u(y),V=y.ssicBucketTitle||y.ssicBucket||"Uncategorized";b[S]||(b[S]={}),b[S][V]||(b[S][V]=[]),b[S][V].push(y)}for(const y of Object.keys(b))for(const S of Object.keys(b[y]))b[y][S].sort((V,ce)=>new Date(ce.createdAt).getTime()-new Date(V.createdAt).getTime());return b},[te,m,u,g]),re=n.useMemo(()=>Object.keys(O).sort((b,y)=>b==="Permanent"?-1:y==="Permanent"||b==="Unknown"?1:y==="Unknown"?-1:parseInt(b)-parseInt(y)),[O]),je=n.useCallback(c=>{if(!c.retentionValue||!c.cutoffTrigger||!c.filedAt)return"N/A";if(c.isPermanent)return"Permanent";const b=new Date(c.filedAt);let y;switch(c.cutoffTrigger){case"CALENDAR_YEAR":y=new Date(b.getFullYear(),11,31);break;case"FISCAL_YEAR":y=b.getMonth()>=9?new Date(b.getFullYear()+1,8,30):new Date(b.getFullYear(),8,30);break;default:y=b}const S=new Date(y),V=(c.retentionUnit||"").toLowerCase();return V==="years"?S.setFullYear(S.getFullYear()+c.retentionValue):V==="months"?S.setMonth(S.getMonth()+c.retentionValue):V==="days"&&S.setDate(S.getDate()+c.retentionValue),S.toLocaleDateString()},[]),Re=n.useCallback(c=>{var y;const b=B.find(S=>S.id===c.uploadedById);return b?`${b.lastName}, ${((y=b.firstName)==null?void 0:y.charAt(0))||""}`:"Unknown"},[B]),ee=Wt(i,{pageSize:10}),dt=n.useMemo(()=>B.reduce((c,b)=>({...c,[b.id]:b}),{}),[B]),nt=n.useMemo(()=>{const c=we||(m==null?void 0:m.id),b=B.find(ue=>ue.id===c),y=s?s.uic:(b==null?void 0:b.unitUic)||"",S=Ze(b==null?void 0:b.company),V=Ze(b==null?void 0:b.platoon);if(!y)return!1;const ce=ot(B,"PLATOON_REVIEWER",{company:S,platoon:V,uic:y}),he=ot(B,"COMPANY_REVIEWER",{company:S,uic:y});return!ce&&!he},[B,m,we,s]),zt=n.useMemo(()=>{const c=we||(m==null?void 0:m.id),b=B.find(S=>S.id===c),y=s?s.uic:(b==null?void 0:b.unitUic)||"";return ae[y]||[]},[ae,B,m,we,s]),Ms=n.useCallback(c=>{const b=Ze(c.currentStage||"PLATOON_REVIEW"),y=B.find(S=>S.id===c.uploadedById);switch(b){case"ORIGINATOR_REVIEW":return{level:"Member",scope:""};case"PLATOON_REVIEW":{const S=y!=null&&y.company&&y.company!=="N/A"?y.company:"",V=y!=null&&y.platoon&&y.platoon!=="N/A"?y.platoon:"";return S&&V?{level:"Platoon",scope:`(${S}-${V})`}:S?{level:"Platoon",scope:`(${S})`}:{level:"Platoon",scope:""}}case"COMPANY_REVIEW":{const S=y!=null&&y.company&&y.company!=="N/A"?y.company:"";return{level:"Company",scope:S?`(${S})`:""}}case"BATTALION_REVIEW":return{level:"Battalion",scope:c.routeSection?`(${c.routeSection})`:""};case"COMMANDER_REVIEW":return{level:"Commander",scope:c.routeSection?`(${c.routeSection})`:""};case"ARCHIVED":return{level:"Archived",scope:""};default:return{level:Es(c),scope:""}}},[B]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>v(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),Q&&e.jsxs("form",{onSubmit:ct,className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col items-center gap-3 p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg",children:[e.jsx(va,{currentUser:m,onRequestCreated:c=>{v(!1),T({type:"success",message:"Naval letter draft created. Complete your letter in the Naval Letter Formatter."}),yt().then(b=>{de(b)}).catch(()=>{})}}),e.jsx("p",{className:"text-xs text-[var(--muted)] text-center",children:"Create a formal naval letter that auto-fills request details"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-1 border-t border-brand-navy/20"}),e.jsx("span",{className:"text-xs text-[var(--muted)] font-medium",children:"OR FILL OUT MANUALLY"}),e.jsx("div",{className:"flex-1 border-t border-brand-navy/20"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:I,onChange:c=>A(c.target.value.toUpperCase()),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${I.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:$,onChange:c=>L(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),e.jsx("div",{children:e.jsx(Gt,{value:ne,onChange:qe,required:!0})}),String((m==null?void 0:m.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:we,onChange:c=>Ve(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),Dt().map(c=>e.jsxs("option",{value:c.id,children:[c.rank," ",c.lastName,", ",c.firstName,c.mi?` ${c.mi}`:""]},c.id))]})]})}),nt&&zt.length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Battalion Section"}),e.jsxs("select",{value:fe,onChange:c=>Ie(c.target.value),className:`w-full px-3 py-2 border ${fe?"border-brand-navy/30":"border-brand-gold"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`,children:[e.jsx("option",{value:"",children:"Select section"}),zt.map(c=>e.jsx("option",{value:c,children:c},c))]}),e.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"No platoon/company reviewer available. Select a section for routing."})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:q,onChange:c=>se(c.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:le,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:E.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:E.map((c,b)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:c.name,children:c.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>K(y=>y.filter((S,V)=>V!==b)),children:"Delete"})]},b))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{v(!1),K([]),A(""),L(""),se(""),Ie(""),qe(null),T(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!I.trim()||!ne,children:"Submit"})]})]}),z&&e.jsx("div",{className:`p-3 rounded-lg border ${z.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:z.message})]})]}),e.jsxs("div",{className:"p-6",children:[m&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>Ce("Pending"),className:`${ke==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>Ce("Files"),className:`${ke==="Files"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Files"})]})}),ke==="Pending"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:ee.totalItems>0?`${ee.startIndex}â€“${ee.endIndex} of ${ee.totalItems}`:""}),ht&&e.jsx("div",{className:"animate-pulse",children:"Loading requestsâ€¦"})]}),e.jsx(lt,{title:"Your Requests",requests:ht?Array.from({length:5}).map((c,b)=>({id:`s-${b}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:Xe.PLATOON_REVIEW})):ee.currentData,users:dt,onRowClick:c=>ye(c),expandedRows:_e,children:c=>e.jsxs("div",{id:`req-docs-${c.id}`,children:[Nt?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):o.filter(b=>b.requestId===c.id&&b.type!=="request").map(b=>e.jsx(as,{doc:b,onView:pt,onDelete:jt},b.id)),!Nt&&o.filter(b=>b.requestId===c.id&&b.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),ee.totalItems>0&&e.jsx(qt,{currentPage:ee.currentPage,totalPages:ee.totalPages,totalItems:ee.totalItems,pageSize:ee.pageSize,startIndex:ee.startIndex,endIndex:ee.endIndex,onPageChange:ee.goToPage,onPageSizeChange:ee.setPageSize,onNext:ee.nextPage,onPrevious:ee.previousPage,onFirst:ee.goToFirstPage,onLast:ee.goToLastPage,canGoNext:ee.canGoNext,canGoPrevious:ee.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),ke==="Files"&&e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search files by subject, SSIC, category...",value:g,onChange:c=>N(c.target.value),className:"w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold focus:border-transparent"}),e.jsx("svg",{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),g&&e.jsx("button",{onClick:()=>N(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),ht?e.jsx("div",{className:"animate-pulse",children:"Loading recordsâ€¦"}):re.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:g?e.jsx("p",{children:"No records match your search."}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"No filed records yet."}),e.jsx("p",{className:"text-sm mt-1",children:'Archive a request and click "File" to add it to records management.'})]})}):e.jsx("div",{className:"space-y-2",children:re.map(c=>{const b=O[c],y=Object.keys(b).sort(),S=c==="Permanent",V=Object.values(b).reduce((he,ue)=>he+ue.length,0),ce=h[c]||!1;return e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:()=>C(he=>({...he,[c]:!he[c]})),className:`w-full ${S?"bg-blue-800 hover:bg-blue-700":"bg-brand-navy hover:bg-brand-navy/90"} text-brand-cream px-4 py-3 font-medium flex items-center justify-between transition-colors`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:`w-4 h-4 transition-transform ${ce?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),e.jsx("span",{children:S?"Permanent Records":`Disposal Year: ${c}`})]}),e.jsxs("span",{className:"text-xs bg-white/20 px-2 py-0.5 rounded",children:[V," record",V!==1?"s":""]})]}),ce&&e.jsx("div",{className:"bg-gray-50 p-2 space-y-2",children:y.map(he=>{const ue=b[he],Pe=`${c}-${he}`,ge=J[Pe]||!1;return e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden bg-white",children:[e.jsxs("button",{onClick:()=>U(Ne=>({...Ne,[Pe]:!Ne[Pe]})),className:"w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 font-medium text-sm flex items-center justify-between transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:`w-3 h-3 transition-transform ${ge?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),e.jsx("span",{children:he})]}),e.jsxs("span",{className:"text-xs text-gray-500",children:[ue.length," item",ue.length!==1?"s":""]})]}),ge&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Name"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"SSIC"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Retention"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Disposal Date"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Date Finalized"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Originator"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Disposal Action"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:ue.map(Ne=>e.jsxs("tr",{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>ye(Ne),children:[e.jsx("td",{className:"px-3 py-2 font-medium text-brand-navy",children:Ne.subject}),e.jsx("td",{className:"px-3 py-2",children:Ne.ssic}),e.jsx("td",{className:"px-3 py-2",children:Ne.isPermanent?e.jsx("span",{className:"inline-flex px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded",children:"Permanent"}):e.jsxs("span",{className:"inline-flex px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded",children:[Ne.retentionValue," ",Ne.retentionUnit]})}),e.jsx("td",{className:"px-3 py-2",children:je(Ne)}),e.jsx("td",{className:"px-3 py-2",children:Ne.filedAt?new Date(Ne.filedAt).toLocaleDateString():"N/A"}),e.jsx("td",{className:"px-3 py-2",children:Re(Ne)}),e.jsx("td",{className:"px-3 py-2",children:Ne.disposalAction||(Ne.isPermanent?"TRANSFER":"DESTROY")})]},Ne.id))})]})})]},Pe)})})]},c)})})]})]}),d&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),Y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>p(null),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:P,onChange:c=>W(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:M,onChange:c=>G(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:Y.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:k,onChange:c=>j(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[Y.name," â€¢ ",Ds(Y.size)," â€¢ ",new Date(Y.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:X.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):X.map((c,b)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[c.actor,c.actorRole?` â€¢ ${c.actorRole}`:""," â€¢ ",new Date(c.timestamp).toLocaleString()," â€¢ ",c.action]}),c.comment&&e.jsx("div",{className:"text-gray-600",children:c.comment})]},b))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>p(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:kt,children:"Save"})]})]})}),R&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>ye(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>ye(null),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[(()=>{const c=!!R.filedAt||R.currentStage==="ARCHIVED";return e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),c?e.jsx("div",{className:"w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-700",children:R.subject}):e.jsx("input",{type:"text",value:De,onChange:b=>Ee(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(R.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),c?e.jsx("div",{className:"w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-700",children:R.dueDate?new Date(R.dueDate).toLocaleDateString():"â€”"}):e.jsx("input",{type:"date",value:ve,onChange:b=>Le(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),R.currentStage&&(()=>{const{level:b,scope:y}=Ms(R);return e.jsxs("span",{className:"inline-flex flex-col items-center px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-lg border border-brand-navy/30 leading-tight",children:[e.jsx("span",{children:b}),y&&e.jsx("span",{className:"text-[10px]",children:y})]})})(),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),c?e.jsx("div",{className:"w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 min-h-[4rem]",children:R.notes||"â€”"}):e.jsx("textarea",{rows:3,value:pe,onChange:b=>Ae(b.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]})})(),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("div",{role:"tablist",className:"-mb-px flex space-x-4","aria-label":"Request details tabs",children:[e.jsx("button",{id:"tab-documents",role:"tab","aria-selected":Be==="documents","aria-controls":"tabpanel-documents",onClick:()=>We("documents"),className:`${Be==="documents"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Documents"}),e.jsx("button",{id:"tab-retention",role:"tab","aria-selected":Be==="retention","aria-controls":"tabpanel-retention",onClick:()=>We("retention"),className:`${Be==="retention"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Retention"}),e.jsx("button",{id:"tab-activity",role:"tab","aria-selected":Be==="activity","aria-controls":"tabpanel-activity",onClick:()=>We("activity"),className:`${Be==="activity"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Activity"})]})}),e.jsxs("div",{className:"mt-3",children:[Be==="documents"&&e.jsxs("div",{id:"tabpanel-documents",role:"tabpanel","aria-labelledby":"tab-documents",className:"space-y-3",children:[(()=>{const c=o.filter(b=>b.requestId===R.id&&b.type!=="request");return c.length>0?c.map(b=>e.jsx(as,{doc:b,onView:pt,onDelete:jt},b.id)):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents attached"})})(),!R.filedAt&&R.currentStage!=="ARCHIVED"&&!Gs(R,String((m==null?void 0:m.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:c=>{const b=c.target.files?Array.from(c.target.files):[];be(y=>[...y,...b]);try{c.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2 mt-2",children:xe.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):xe.map((c,b)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:c.name,children:c.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>be(y=>y.filter((S,V)=>V!==b)),children:"Delete"})]},b))})]})]}),Be==="retention"&&e.jsx("div",{id:"tabpanel-retention",role:"tabpanel","aria-labelledby":"tab-retention",children:Je?e.jsxs("div",{className:"space-y-4",children:[e.jsx(Gt,{value:Me,onChange:t,required:!0}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Ye(!1),t(null)},className:"px-3 py-1 rounded border border-brand-navy/30 text-brand-navy hover:bg-brand-cream text-sm",children:"Cancel"}),e.jsx("button",{type:"button",onClick:Pt,disabled:!Me,className:"px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 text-sm disabled:opacity-50",children:"Save Retention"})]})]}):e.jsxs("div",{children:[R.ssic?e.jsx(ma,{request:R}):e.jsx("div",{className:"text-sm text-[var(--muted)] p-4 bg-gray-50 rounded-lg",children:"No retention information available for this request."}),m&&R.currentStage!=="ARCHIVED"&&e.jsx("button",{type:"button",onClick:()=>Ye(!0),className:"mt-3 px-3 py-1 rounded border border-brand-navy/30 text-brand-navy hover:bg-brand-cream text-sm",children:R.ssic?"Change Retention":"Add Retention Info"})]})}),Be==="activity"&&e.jsx("div",{id:"tabpanel-activity",role:"tabpanel","aria-labelledby":"tab-activity",className:"space-y-2",children:R.activity&&R.activity.length?R.activity.map((c,b)=>e.jsxs("div",{className:"text-xs text-gray-700 p-2 bg-gray-50 rounded",children:[e.jsxs("div",{className:"font-medium",children:[c.actor,c.actorRole?` â€¢ ${c.actorRole}`:""," â€¢ ",new Date(c.timestamp).toLocaleString()," â€¢ ",c.action]}),c.comment&&e.jsx("div",{className:"text-gray-600 mt-1",children:c.comment})]},`${c.timestamp}-${b}`)):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No activity recorded"})})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>ye(null),children:"Close"}),m&&!R.filedAt&&!Zt(R,String((m==null?void 0:m.id)||""))&&Xt(R,String((m==null?void 0:m.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:Mt,children:"Save Changes"}),m&&Zt(R,String((m==null?void 0:m.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700",onClick:me,children:"File"}),m&&Js(R)&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-amber-500 text-white hover:bg-amber-600",onClick:Se,children:"Return"}),m&&Et(R)&&m.id===R.uploadedById&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700",onClick:vt,children:"Resubmit"}),m&&Ks(R,String((m==null?void 0:m.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>It(R),children:"Delete Request"})]})]})}),a&&R&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]",onClick:()=>l(!1),children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md p-6",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"File for Records Management"}),e.jsx("button",{className:"text-gray-500 hover:text-gray-700",onClick:()=>l(!1),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date Finalized"}),e.jsx("input",{type:"date",value:x,onChange:c=>w(c.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"This date will be used to calculate the disposal date based on the retention schedule."})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 text-sm",children:[e.jsx("div",{className:"font-medium text-gray-700 mb-1",children:"Retention Info"}),e.jsxs("div",{className:"text-gray-600",children:[e.jsxs("div",{children:["SSIC: ",R.ssic," - ",R.ssicNomenclature]}),e.jsxs("div",{children:["Retention: ",R.isPermanent?"Permanent":`${R.retentionValue} ${R.retentionUnit}`]}),e.jsxs("div",{children:["Cutoff: ",R.cutoffDescription||R.cutoffTrigger]})]})]}),z&&e.jsx("div",{className:`p-3 rounded-lg border ${z.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:z.message})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>l(!1),className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"button",onClick:$e,disabled:!x,className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50",children:"File Record"})]})]})})]})},Na=({currentUser:s,onClose:r})=>{const[o,f]=n.useState([]),[d,D]=n.useState(""),[I,A]=n.useState(!1),[$,L]=n.useState(""),[q,se]=n.useState(!1),[E,K]=n.useState("");n.useEffect(()=>{Ct().then(_=>{f(_.data||[])}).catch(()=>f([]))},[]);const z=n.useMemo(()=>String(s.role||"")!=="MEMBER",[s]),T=n.useMemo(()=>{const _=Q=>{const v=s.unitUic||"",Y=String(s.role||"");if(Y.includes("PLATOON")){const p=Q.company&&Q.company!=="N/A"?Q.company:"",P=Q.platoon&&Q.platoon!=="N/A"?Q.platoon:"",W=s.company&&s.company!=="N/A"?s.company:"",M=s.platoon&&s.platoon!=="N/A"?s.platoon:"";return p===W&&P===M}if(Y.includes("COMPANY")){const p=Q.company&&Q.company!=="N/A"?Q.company:"",P=s.company&&s.company!=="N/A"?s.company:"";return p===P}return Y.includes("COMMANDER")?(Q.unitUic||"")===v:!1};return o.filter(Q=>Q.id!==s.id&&_(Q))},[o,s]),m=n.useMemo(()=>{const _=String(s.role||""),Q=v=>{const Y=s.unitUic||"";if(_.includes("PLATOON")){const p=v.company&&v.company!=="N/A"?v.company:"",P=v.platoon&&v.platoon!=="N/A"?v.platoon:"",W=s.company&&s.company!=="N/A"?s.company:"",M=s.platoon&&s.platoon!=="N/A"?s.platoon:"";return p===W&&P===M}if(_.includes("COMPANY")){const p=v.company&&v.company!=="N/A"?v.company:"",P=s.company&&s.company!=="N/A"?s.company:"";return p===P}return _.includes("COMMANDER")?(v.unitUic||"")===Y:!1};return o.filter(v=>v.id!==s.id&&Q(v)&&String(v.role||"")===_)},[o,s]),ie=async()=>{try{A(!0),L("");const _=o.find(p=>p.id===d);if(!z||!_){A(!1);return}const Q=String(s.role||""),v={..._};if(v.role=Q,Q.includes("PLATOON")){v.roleCompany=s.company&&s.company!=="N/A"?s.company:"N/A";const p=s.platoon&&s.platoon!=="N/A"?s.platoon:"N/A";v.rolePlatoon=p}else Q.includes("COMPANY")?(v.roleCompany=s.company&&s.company!=="N/A"?s.company:"N/A",v.rolePlatoon="N/A"):Q.includes("COMMANDER")&&(v.roleCompany="N/A",v.rolePlatoon="N/A");try{if(!(await at({id:v.id,email:v.email,rank:v.rank,firstName:v.firstName,lastName:v.lastName,mi:v.mi,service:v.service,role:v.role,unitUic:v.unitUic,unit:v.unit,company:v.company,isUnitAdmin:!!v.isUnitAdmin,isCommandStaff:!!v.isCommandStaff,edipi:v.edipi,passwordHash:v.passwordHash,roleCompany:v.roleCompany,rolePlatoon:v.rolePlatoon})).ok)throw new Error("persist_failed")}catch{L("Failed to persist user changes")}const Y={actorId:s.id,actorRole:s.role,targetId:v.id,grantedRole:v.role,timestamp:new Date().toISOString(),scope:{unitUic:s.unitUic||"",company:s.company,unit:s.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Y)})}catch{}f(p=>p.map(P=>P.id===v.id?v:P)),D(""),se(!1),A(!1)}catch{A(!1),L("Operation failed")}},B=async _=>{try{A(!0),L("");const Q=o.find(W=>W.id===_);if(!Q){A(!1);return}const v=String(s.role||"");if(!m.some(W=>W.id===_)){A(!1),L("Target not in scope");return}const p={...Q};p.role="MEMBER",p.company="N/A",p.unit="N/A",p.isCommandStaff=!1,p.roleCompany="N/A",p.rolePlatoon="N/A";try{if(!(await at({id:p.id,email:p.email,rank:p.rank,firstName:p.firstName,lastName:p.lastName,mi:p.mi,service:p.service,role:p.role,unitUic:p.unitUic,unit:p.unit,company:p.company,isUnitAdmin:!!p.isUnitAdmin,isCommandStaff:!!p.isCommandStaff,edipi:p.edipi,passwordHash:p.passwordHash,roleCompany:p.roleCompany,rolePlatoon:p.rolePlatoon})).ok)throw new Error("persist_failed")}catch{L("Failed to persist user changes")}const P={actorId:s.id,actorRole:s.role,targetId:p.id,action:"Revoked",previousRole:v,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(P)})}catch{}f(W=>W.map(M=>M.id===p.id?p:M)),K(""),A(!1)}catch{A(!1),L("Operation failed")}};return z?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:r,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:_=>_.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:r,children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:d,onChange:_=>D(_.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),T.map(_=>e.jsxs("option",{value:_.id,children:[_.rank," ",_.lastName,", ",_.firstName,_.mi?` ${_.mi}`:""," â€¢ ",_.email]},_.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[m.map(_=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[_.rank," ",_.lastName,", ",_.firstName,_.mi?` ${_.mi}`:""," â€¢ ",_.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>K(_.id),children:"Remove Access"})]},_.id)),m.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),$&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:$})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!d||I,onClick:()=>se(!0),children:"Grant Equivalent Permission"})}),q&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>se(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:I,onClick:ie,children:"Confirm"})]})]}),E&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>K(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:I,onClick:()=>B(E),children:"Remove"})]})]})]})}):null},ns="ORIGINATOR_REVIEW",et=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],wa=[{value:"PLATOON_REVIEW",label:"Platoon Review"},{value:"COMPANY_REVIEW",label:"Company Review"},{value:"BATTALION_REVIEW",label:"Battalion Review"},{value:"COMMANDER_REVIEW",label:"Commander Review"},{value:"ARCHIVED",label:"Archived"}],Sa={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},Ca=s=>{const r=et.indexOf(s||et[0]);return r>=0&&r<et.length-1?et[r+1]:et[r]||et[0]},rs=s=>{const r=et.indexOf(s||et[0]);return r>0?et[r-1]:et[0]},St=(s,r)=>{var o;return((o=s.activity)==null?void 0:o.some(f=>r.test(String(f.action||""))))||!1},Aa=s=>St(s,/(approved by commander|commander.*approved)/i)&&!St(s,/installation commander/i),ka=s=>St(s,/(endorsed by commander|commander.*endorsed)/i)&&!St(s,/installation commander/i),Ft=s=>{if(!s)return"MEMBER";const r=String(s.role||"MEMBER"),o=(s.roleCompany||s.company||"").trim(),f=(s.rolePlatoon||s.platoon||"").trim();switch(r){case"PLATOON_REVIEWER":if(o&&f)return`Platoon (${o}-${f})`;break;case"COMPANY_REVIEWER":if(o)return`Company (${o})`;break;case"BATTALION_REVIEWER":return"Battalion";case"COMMANDER_REVIEWER":return"Commander"}return r};function Ea(){const s=fs(),[r,o]=n.useState(()=>{try{const t=localStorage.getItem("currentUser");return t?JSON.parse(t):null}catch(t){return console.error("Failed to parse user from localStorage:",t),null}}),[f,d]=n.useState([]),[D,I]=n.useState([]),[A,$]=n.useState({}),[L,q]=n.useState({}),[se,E]=n.useState({}),[K,z]=n.useState({}),[T,m]=n.useState({}),[ie,B]=n.useState({}),[_,Q]=n.useState({}),[v,Y]=n.useState(!1),[p,P]=n.useState({}),[W,M]=n.useState({}),[G,k]=n.useState(!1),[j,X]=n.useState({}),[H,te]=n.useState(null),de=n.useRef(null),[R,ye]=n.useState("Pending"),[De,Ee]=n.useState(Sa),[ve,Le]=n.useState(null),[pe,Ae]=n.useState(""),[xe,be]=n.useState({}),[Oe,Fe]=n.useState({});n.useEffect(()=>{const t=l=>{H&&de.current&&!de.current.contains(l.target)&&(X(x=>({...x,[H]:!1})),te(null))},a=l=>{l.key==="Escape"&&H&&(X(x=>({...x,[H]:!1})),te(null))};return document.addEventListener("mousedown",t),document.addEventListener("keydown",a),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("keydown",a)}},[H]),n.useEffect(()=>{Ys().then(t=>{d(t.data||[])}).catch(()=>d([]))},[]),n.useEffect(()=>{Us().then(t=>{I(t.data||[])}).catch(()=>I([]))},[]),n.useEffect(()=>{Ct().then(t=>{const a={},l=t.data||[];for(const x of l)x!=null&&x.id&&(a[x.id]=x);q(a)}).catch(()=>q({}))},[]),n.useEffect(()=>{try{const t=localStorage.getItem("unit_structure"),a={},l={};if(t){const x=JSON.parse(t);for(const w of Object.keys(x||{})){const Z=x[w];Z&&Array.isArray(Z._sections)&&(a[w]=Z._sections),Z&&Z._platoonSectionMap&&typeof Z._platoonSectionMap=="object"&&(l[w]=Z._platoonSectionMap)}}else(async()=>{try{const x=await At();for(const w of Object.keys(x||{})){const Z=x[w];Z&&Array.isArray(Z._sections)&&(a[w]=Z._sections),Z&&Z._platoonSectionMap&&typeof Z._platoonSectionMap=="object"&&(l[w]=Z._platoonSectionMap)}}catch{}})();B(a),Q(l)}catch{}},[]);const _e=n.useMemo(()=>{const t=String((r==null?void 0:r.role)||"");return t.includes("PLATOON")?"PLATOON_REVIEW":t.includes("COMPANY")?"COMPANY_REVIEW":t.includes("BATTALION")?"BATTALION_REVIEW":t.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[r]),Te=n.useMemo(()=>Object.values(L),[L]),we=t=>{const a=L[t.uploadedById];if(!a)return!1;const l=Ze(a.company),x=t.unitUic||a.unitUic||"";return ot(Te,"COMPANY_REVIEWER",{company:l,uic:x})},Ve=t=>String((r==null?void 0:r.role)||"").includes("PLATOON")?!we(t):!1,ke=t=>L[t.uploadedById]||null,Ce=t=>t&&t!=="N/A"?t.trim():"",h=t=>{var oe,le;const a=ke(t),l=t.unitUic||(a==null?void 0:a.unitUic)||"",x=String((r==null?void 0:r.role)||""),w=(r==null?void 0:r.unitUic)||"",Z=(Ce(r==null?void 0:r.roleCompany)||Ce(r==null?void 0:r.company)).toUpperCase();if(x.includes("PLATOON")){if(!w||l!==w)return!1;const me=a?Ce(a.company).toUpperCase():"",$e=a?Ce(a.platoon).toUpperCase():"",Se=(Ce(r==null?void 0:r.rolePlatoon)||Ce(r==null?void 0:r.platoon)).toUpperCase();return!Z||!Se||!me||!$e?!1:me===Z&&$e===Se}if(x.includes("COMPANY")){if(!w||l!==w)return!1;const me=a?Ce(a.company).toUpperCase():"";return!Z||!me?!1:me===Z}if(x.includes("BATTALION")){if(!w||l!==w)return!1;const me=Ce(r==null?void 0:r.company),$e=Ce(r==null?void 0:r.platoon),Se=((le=(oe=_[w])==null?void 0:oe[me])==null?void 0:le[$e])||"";return t.routeSection&&Se?t.routeSection===Se:!0}return x.includes("COMMANDER")?!!w&&l===w:!0},C=n.useMemo(()=>(Array.isArray(f)?f:[]).filter(h),[f,r,L,_]),J=n.useMemo(()=>{const t=new Map;for(const a of C){const l=ke(a);if(l&&l.id&&!t.has(l.id)){const x=`${l.rank||""} ${l.lastName||""}, ${l.firstName||""}`.trim();t.set(l.id,{value:l.id,label:x||l.id})}}return Array.from(t.values()).sort((a,l)=>a.label.localeCompare(l.label))},[C,L]),U=oa(De,{items:C,getSearchText:t=>`${t.subject||""} ${t.id||""} ${t.routeSection||""}`,getStatus:t=>t.currentStage||"PLATOON_REVIEW",getDate:t=>t.createdAt,getOriginatorId:t=>t.uploadedById}),g=n.useMemo(()=>U.filter(t=>(t.currentStage||"PLATOON_REVIEW")===_e),[U,_e]),N=n.useMemo(()=>U.filter(t=>(t.currentStage||"PLATOON_REVIEW")!==_e),[U,_e]),ae=Wt(g,{pageSize:25}),F=Wt(N,{pageSize:25}),fe=n.useCallback(t=>{if(t.isPermanent)return"Permanent";if(!t.retentionValue||!t.cutoffTrigger||!t.filedAt)return"Unknown";const a=new Date(t.filedAt);let l;switch(t.cutoffTrigger){case"CALENDAR_YEAR":l=new Date(a.getFullYear(),11,31);break;case"FISCAL_YEAR":l=a.getMonth()>=9?new Date(a.getFullYear()+1,8,30):new Date(a.getFullYear(),8,30);break;default:l=a}const x=new Date(l),w=(t.retentionUnit||"").toLowerCase();return w==="years"?x.setFullYear(x.getFullYear()+t.retentionValue):w==="months"?x.setMonth(x.getMonth()+t.retentionValue):w==="days"&&x.setDate(x.getDate()+t.retentionValue),x.getFullYear().toString()},[]),Ie=n.useCallback(t=>{if(!t.retentionValue||!t.cutoffTrigger||!t.filedAt)return"N/A";if(t.isPermanent)return"Permanent";const a=new Date(t.filedAt);let l;switch(t.cutoffTrigger){case"CALENDAR_YEAR":l=new Date(a.getFullYear(),11,31);break;case"FISCAL_YEAR":l=a.getMonth()>=9?new Date(a.getFullYear()+1,8,30):new Date(a.getFullYear(),8,30);break;default:l=a}const x=new Date(l),w=(t.retentionUnit||"").toLowerCase();return w==="years"?x.setFullYear(x.getFullYear()+t.retentionValue):w==="months"?x.setMonth(x.getMonth()+t.retentionValue):w==="days"&&x.setDate(x.getDate()+t.retentionValue),x.toLocaleDateString()},[]),ne=n.useMemo(()=>{const t=(r==null?void 0:r.unitUic)||"";let a=f.filter(x=>!(!x.filedAt||t&&x.unitUic!==t));if(pe.trim()){const x=pe.toLowerCase().trim();a=a.filter(w=>{var Z,oe,le,me;return((Z=w.subject)==null?void 0:Z.toLowerCase().includes(x))||((oe=w.ssic)==null?void 0:oe.toLowerCase().includes(x))||((le=w.ssicNomenclature)==null?void 0:le.toLowerCase().includes(x))||((me=w.ssicBucketTitle)==null?void 0:me.toLowerCase().includes(x))})}const l={};for(const x of a){const w=fe(x),Z=x.ssicBucketTitle||x.ssicBucket||"Uncategorized";l[w]||(l[w]={}),l[w][Z]||(l[w][Z]=[]),l[w][Z].push(x)}for(const x of Object.keys(l))for(const w of Object.keys(l[x]))l[x][w].sort((Z,oe)=>new Date(oe.createdAt).getTime()-new Date(Z.createdAt).getTime());return l},[f,r,pe,fe]),qe=n.useMemo(()=>Object.keys(ne).sort((t,a)=>t==="Permanent"?1:a==="Permanent"?-1:t==="Unknown"?1:a==="Unknown"?-1:parseInt(t)-parseInt(a)),[ne]),Be=n.useMemo(()=>Object.values(ne).reduce((t,a)=>t+Object.values(a).reduce((l,x)=>l+x.length,0),0),[ne]),We=t=>D.filter(a=>a.requestId===t),Je=n.useMemo(()=>[{header:"Request ID",getValue:t=>t.id},{header:"Subject",getValue:t=>t.subject},{header:"Stage",getValue:t=>t.currentStage||""},{header:"Route Section",getValue:t=>t.routeSection||""},{header:"Originator",getValue:t=>{const a=ke(t);return a?`${a.rank||""} ${a.lastName||""}, ${a.firstName||""}${a.mi?` ${a.mi}`:""}`.trim():""}},{header:"Unit UIC",getValue:t=>t.unitUic||""},{header:"Created At",getValue:t=>t.createdAt,format:ss},{header:"Due Date",getValue:t=>t.dueDate||"",format:ss},{header:"Documents",getValue:t=>We(t.id).map(a=>a.name).join(" | ")}],[L,D]),Ye=async(t,a,l)=>{const x=r?`${r.rank} ${r.lastName}, ${r.firstName}${r.mi?` ${r.mi}`:""}`:"Reviewer",w=Ft(r),Z={actor:x,actorRole:w,timestamp:new Date().toISOString(),action:l,comment:(A[t.id]||"").trim()},oe={...t,currentStage:a,routeSection:a==="BATTALION_REVIEW"&&T[t.id]?T[t.id]:t.routeSection,activity:Array.isArray(t.activity)?[...t.activity,Z]:[Z]};try{await ze(oe),l.toLowerCase().includes("approved")?s.success("Request approved",{message:`"${t.subject}" advanced to next stage`}):l.toLowerCase().includes("return")?s.warning("Request returned",{message:`"${t.subject}" sent back for revision`}):l.toLowerCase().includes("archive")?s.info("Request archived",{message:`"${t.subject}" has been archived`}):s.success(l,{message:`Request "${t.subject}" updated`}),d(le=>le.map(me=>me.id===oe.id?oe:me)),$(le=>({...le,[t.id]:""}))}catch(le){s.error("Failed to update request",{message:String(le)})}},Me=async t=>{const a=K[t.id]||[];if(!a.length||!(r!=null&&r.id))return;const l=Date.now(),x=a.map((me,$e)=>({id:`${l}-${$e}`,name:me.name,type:me.type,size:me.size,uploadedAt:new Date().toISOString(),subject:t.subject,requestId:t.id,fileUrl:URL.createObjectURL(me)})),w=r?`${r.rank} ${r.lastName}, ${r.firstName}${r.mi?` ${r.mi}`:""}`:"Reviewer",Z=Ft(r),oe={actor:w,actorRole:Z,timestamp:new Date().toISOString(),action:`Reviewer added ${x.length} document(s)`,comment:(A[t.id]||"").trim()},le={...t,documentIds:[...t.documentIds||[],...x.map(me=>me.id)],activity:Array.isArray(t.activity)?[...t.activity,oe]:[oe]};try{await Tt(x),await ze(le),s.success(`${x.length} file${x.length!==1?"s":""} added`,{message:`Documents added to "${t.subject}"`})}catch(me){s.error("Failed to add files",{message:String(me)})}I(me=>[...me,...x]),d(me=>me.map($e=>$e.id===le.id?le:$e)),z(me=>({...me,[t.id]:[]})),$(me=>({...me,[t.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Unit Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Ft(r)}),e.jsx(da,{items:[...g,...N],columns:Je,filename:"review_requests",label:"Export",className:"hidden md:inline-flex"})]})]}),r&&String(r.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>Y(!0),children:"Manage Permissions"})})]}),e.jsx(ia,{filters:De,onFiltersChange:Ee,statusOptions:wa,originatorOptions:J,searchPlaceholder:"Search requests by subject, ID, or section...",className:"mb-4"}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>ye("Pending"),className:`${R==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>ye("In Scope"),className:`${R==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"}),e.jsxs("button",{onClick:()=>ye("Files"),className:`${R==="Files"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:["Files (",Be,")"]})]})}),e.jsxs("div",{className:"mt-4",children:[R==="Pending"&&e.jsx(lt,{title:"Pending",requests:ae.currentData,users:L,onRowClick:t=>P(a=>({...a,[t.id]:!a[t.id]})),expandedRows:p,platoonSectionMap:_,children:t=>e.jsxs("div",{id:`details-rev-${t.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[t.id],"aria-controls":`docs-rev-${t.id}`,onClick:()=>{X(a=>({...a,[t.id]:!a[t.id]})),te(a=>j[t.id]?null:t.id)},onKeyDown:a=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),X(l=>({...l,[t.id]:!l[t.id]})),te(l=>j[t.id]?null:t.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[t.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${t.id}`,ref:j[t.id]?de:void 0,className:`${j[t.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(ut,{documents:We(t.id).map(a=>({...a,fileUrl:a.fileUrl})),showIcons:!0,onPreview:a=>Le(We(t.id).find(l=>l.id===a.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>E(a=>({...a,[t.id]:!a[t.id]})),"aria-expanded":!!se[t.id],"aria-controls":`logs-${t.id}`,children:[se[t.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${t.id}`,className:se[t.id]?"mt-2 space-y-2":"hidden",children:t.activity&&t.activity.length?t.activity.map((a,l)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[a.actor,a.actorRole?` â€¢ ${a.actorRole}`:""," â€¢ ",new Date(a.timestamp).toLocaleString()," â€¢ ",a.action]}),a.comment&&e.jsx("div",{className:"text-gray-600",children:a.comment})]},l)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:A[t.id]||"",onChange:a=>$(l=>({...l,[t.id]:a.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:a=>z(l=>({...l,[t.id]:a.target.files?Array.from(a.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(K[t.id]||[]).length?`${(K[t.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>Me(t),disabled:!K[t.id]||!(K[t.id]||[]).length,children:"Save Files"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[(String((r==null?void 0:r.role)||"").includes("COMPANY")||Ve(t))&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:T[t.id]||"",onChange:a=>m(l=>({...l,[t.id]:a.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(ie[(r==null?void 0:r.unitUic)||""]||[]).map(a=>e.jsx("option",{value:a,children:a},a))]}),Ve(t)&&e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No company reviewer"})]}),(()=>{const a=Aa(t),l=ka(t),x=String((r==null?void 0:r.role)||"").includes("COMPANY")||Ve(t);return a||l?e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Ye(t,t.currentStage==="PLATOON_REVIEW"?ns:rs(t.currentStage),"Returned to previous stage"),children:"Return to Previous"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(x){if(!T[t.id])return;Ye(t,"BATTALION_REVIEW",`Approved and routed to ${T[t.id]}`)}else Ye(t,Ca(t.currentStage),"Approved")},disabled:x&&!T[t.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Ye(t,t.currentStage==="PLATOON_REVIEW"?ns:rs(t.currentStage),t.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),R==="In Scope"&&e.jsx(lt,{title:"In Scope",requests:F.currentData,users:L,onRowClick:t=>P(a=>({...a,[t.id]:!a[t.id]})),expandedRows:p,platoonSectionMap:_,children:t=>e.jsxs("div",{id:`details-rev-${t.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[t.id],"aria-controls":`docs-rev-${t.id}`,onClick:()=>{X(a=>({...a,[t.id]:!a[t.id]})),te(a=>j[t.id]?null:t.id)},onKeyDown:a=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),X(l=>({...l,[t.id]:!l[t.id]})),te(l=>j[t.id]?null:t.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[t.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${t.id}`,ref:j[t.id]?de:void 0,className:`${j[t.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(ut,{documents:We(t.id).map(a=>({...a,fileUrl:a.fileUrl})),showIcons:!0,onPreview:a=>Le(We(t.id).find(l=>l.id===a.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>E(a=>({...a,[t.id]:!a[t.id]})),"aria-expanded":!!se[t.id],"aria-controls":`logs-${t.id}`,children:[se[t.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${t.id}`,className:se[t.id]?"mt-2 space-y-2":"hidden",children:t.activity&&t.activity.length?t.activity.map((a,l)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[a.actor,a.actorRole?` â€¢ ${a.actorRole}`:""," â€¢ ",new Date(a.timestamp).toLocaleString()," â€¢ ",a.action]}),a.comment&&e.jsx("div",{className:"text-gray-600",children:a.comment})]},l)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})}),R==="Files"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search files by subject, SSIC, category...",value:pe,onChange:t=>Ae(t.target.value),className:"w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold focus:border-transparent"}),e.jsx("svg",{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),pe&&e.jsx("button",{onClick:()=>Ae(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),qe.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:pe?"No records match your search.":"No filed records."}):e.jsx("div",{className:"space-y-2",children:qe.map(t=>{const a=ne[t],l=Object.keys(a).sort(),x=t==="Permanent",w=Object.values(a).reduce((oe,le)=>oe+le.length,0),Z=xe[t]||!1;return e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:()=>be(oe=>({...oe,[t]:!oe[t]})),className:`w-full ${x?"bg-blue-800 hover:bg-blue-700":"bg-brand-navy hover:bg-brand-navy/90"} text-brand-cream px-4 py-3 font-medium flex items-center justify-between transition-colors`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:`w-4 h-4 transition-transform flex-shrink-0 ${Z?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),e.jsx("span",{className:"truncate",children:x?"Permanent Records":`Disposal Year: ${t}`})]}),e.jsxs("span",{className:"text-xs bg-white/20 px-2 py-0.5 rounded flex-shrink-0 ml-2",children:[w," record",w!==1?"s":""]})]}),Z&&e.jsx("div",{className:"bg-gray-50 p-2 space-y-2",children:l.map(oe=>{const le=a[oe],me=`${t}-${oe}`,$e=Oe[me]||!1;return e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden bg-white",children:[e.jsxs("button",{onClick:()=>Fe(Se=>({...Se,[me]:!Se[me]})),className:"w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 font-medium text-sm flex items-center justify-between transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("svg",{className:`w-3 h-3 transition-transform flex-shrink-0 ${$e?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),e.jsx("span",{className:"truncate",children:oe})]}),e.jsxs("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:[le.length," item",le.length!==1?"s":""]})]}),$e&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"Name"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"SSIC"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"Retention"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm hidden sm:table-cell",children:"Disposal Date"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:le.map(Se=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-2 sm:px-3 py-2 font-medium text-brand-navy text-xs sm:text-sm max-w-[120px] sm:max-w-none truncate",children:Se.subject}),e.jsx("td",{className:"px-2 sm:px-3 py-2 text-xs sm:text-sm",children:Se.ssic}),e.jsx("td",{className:"px-2 sm:px-3 py-2",children:Se.isPermanent?e.jsx("span",{className:"inline-flex px-1.5 sm:px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded whitespace-nowrap",children:"Perm"}):e.jsxs("span",{className:"inline-flex px-1.5 sm:px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded whitespace-nowrap",children:[Se.retentionValue," ",(Se.retentionUnit||"").replace("S","")]})}),e.jsx("td",{className:"px-2 sm:px-3 py-2 text-xs sm:text-sm hidden sm:table-cell",children:Ie(Se)})]},Se.id))})]})})]},me)})})]},t)})})]})]})]}),v&&r&&e.jsx(Na,{currentUser:r,onClose:()=>Y(!1)}),ve&&ve.fileUrl&&e.jsx(Rs,{url:ve.fileUrl,fileName:ve.name,mimeType:ve.type,fileSize:ve.size,isOpen:!!ve,onClose:()=>Le(null)})]})}function Ra(){var W;const[s,r]=n.useState(null),[o,f]=n.useState([]),[d,D]=n.useState([]),[I,A]=n.useState(""),[$,L]=n.useState(""),[q,se]=n.useState([]),[E,K]=n.useState(null),[z,T]=n.useState("structure"),[m,ie]=n.useState({}),[B,_]=n.useState({}),[Q,v]=n.useState({});n.useEffect(()=>{try{const M=localStorage.getItem("currentUser");M&&r(JSON.parse(M))}catch{}Ns().then(M=>{try{f(M.map(G=>({code:String(G.code||""),name:String(G.name||"")})))}catch{f([])}}),ws().then(M=>{D(M)}).catch(()=>D([])),xt().then(M=>se(M)).catch(()=>se([])),Ut().then(M=>{const G={};for(const k of M){const j=`${k.division_code}::${k.branch}`;G[j]={reviewers:k.reviewers||[],approvers:k.approvers||[]}}ie(G)})},[]);const Y=(s==null?void 0:s.hqmcDivision)||((W=o[0])==null?void 0:W.code)||"",p=n.useMemo(()=>o.find(M=>M.code===Y),[o,Y]),P=n.useMemo(()=>(Array.isArray(d)?d:[]).filter(M=>String(M.division_code||"")===Y),[d,Y]);return n.useMemo(()=>(Array.isArray(q)?q:[]).filter(M=>!!M.isHqmcAdmin&&String(M.hqmcDivision||"")===Y),[q,Y]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(s!=null&&s.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(s==null?void 0:s.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",p?`${p.code} â€” ${p.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>T("structure"),className:`${z==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>T("permissions"),className:`${z==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),z==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[P.map(M=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:M.branch}),e.jsx("td",{className:"py-2 px-3",children:M.description||""}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700",onClick:async()=>{if(!confirm(`Delete branch "${M.branch}"?`))return;const G=await zs(Y,M.branch);G.ok?(D(k=>k.filter(j=>!(j.division_code===Y&&j.branch===M.branch))),K({type:"success",message:`Deleted branch "${M.branch}"`})):K({type:"error",message:`Failed to delete: ${G.error}`})},children:"Delete"})})]},M.branch)),P.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(s==null?void 0:s.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:I,onChange:M=>A(M.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:$,onChange:M=>L(M.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!I.trim(),onClick:async()=>{var M;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:Y,division_name:((M=o.find(k=>k.code===Y))==null?void 0:M.name)||"",branch:I.trim(),description:$.trim()})});const G=await fetch("/api/hqmc-structure").then(k=>k.json());D(G),A(""),L("")}catch{}},children:"Add"})]})]})]}),z==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const M of P){const G=`${Y}::${M.branch}`,k=m[G]||{reviewers:[],approvers:[]};await Ss({division_code:Y,branch:M.branch,reviewers:k.reviewers,approvers:k.approvers})}K({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:P.map(M=>{const G=`${Y}::${M.branch}`,k=m[G]||{reviewers:[],approvers:[]},j=X=>`${X.rank||""} ${X.lastName||""}, ${X.firstName||""}${X.mi?" "+X.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:M.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:B[G]||"",onChange:X=>_(H=>({...H,[G]:X.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!B[G],onClick:async()=>{const X=(B[G]||"").trim();if(!X)return;const{user:H,error:te}=await Bt(X);if(te){K({type:"error",message:`Database error: ${te}`});return}if(!(H!=null&&H.id)){K({type:"error",message:`No user found for EDIPI ${X}`});return}ie(de=>({...de,[G]:{...k,reviewers:Array.from(new Set([...k.reviewers||[],H.id]))}})),_(de=>({...de,[G]:""})),K({type:"success",message:`Added reviewer ${H.lastName||""}, ${H.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(k.reviewers||[]).map(X=>{const H=q.find(te=>te.id===X);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:H?j(H):X}),e.jsx("button",{className:"text-red-600",onClick:()=>ie(te=>({...te,[G]:{...k,reviewers:(k.reviewers||[]).filter(de=>de!==X)}})),children:"âœ•"})]},X)}),(k.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:Q[G]||"",onChange:X=>v(H=>({...H,[G]:X.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!Q[G],onClick:async()=>{const X=(Q[G]||"").trim();if(!X)return;const{user:H,error:te}=await Bt(X);if(te){K({type:"error",message:`Database error: ${te}`});return}if(!(H!=null&&H.id)){K({type:"error",message:`No user found for EDIPI ${X}`});return}ie(de=>({...de,[G]:{...k,approvers:Array.from(new Set([...k.approvers||[],H.id]))}})),v(de=>({...de,[G]:""})),K({type:"success",message:`Added approver ${H.lastName||""}, ${H.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(k.approvers||[]).map(X=>{const H=q.find(te=>te.id===X);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:H?j(H):X}),e.jsx("button",{className:"text-red-600",onClick:()=>ie(te=>({...te,[G]:{...k,approvers:(k.approvers||[]).filter(de=>de!==X)}})),children:"âœ•"})]},X)}),(k.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},G)})})]})})]}),E&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${E.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:E.message})]})}const ft=(s,r)=>`${s}::${r}`;function Da({currentUser:s,divisionCode:r,branches:o,assignments:f,onClose:d}){const[D,I]=n.useState([]),[A,$]=n.useState(""),[L,q]=n.useState(""),[se,E]=n.useState("reviewer"),[K,z]=n.useState(!1);n.useEffect(()=>{Ct().then(p=>I(p)).catch(()=>I([]))},[]);const T=n.useMemo(()=>{const p={};for(const P of f)p[ft(P.division_code,P.branch)]={reviewers:P.reviewers||[],approvers:P.approvers||[]};return p},[f]),m=String(s.id||""),ie=n.useMemo(()=>{if(!A)return!1;const p=T[ft(r,A)]||{reviewers:[],approvers:[]};return(p.reviewers||[]).includes(m)||(p.approvers||[]).includes(m)||!!s.isHqmcAdmin},[A,T,m,s]),B=n.useMemo(()=>D.filter(p=>String(p.hqmcDivision||"")===String(r||"")&&String(p.id||"")!==m),[D,r,m]),_=n.useMemo(()=>{if(!A)return[];const p=T[ft(r,A)]||{reviewers:[],approvers:[]};return Array.from(new Set([...p.reviewers||[],...p.approvers||[]])).map(W=>B.find(M=>M.id===W)).filter(Boolean)},[A,T,B,r]),Q=async p=>{z(!0);try{await Ss({division_code:r,branch:A,reviewers:p.reviewers,approvers:p.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:s.id,scope:{hqmcDivision:r,branch:A},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{z(!1)}},v=async()=>{if(!ie||!A||!L)return;const p=T[ft(r,A)]||{reviewers:[],approvers:[]},P={reviewers:Array.from(new Set(p.reviewers||[])),approvers:Array.from(new Set(p.approvers||[]))};se==="reviewer"?P.reviewers=Array.from(new Set([...P.reviewers,L])):P.approvers=Array.from(new Set([...P.approvers,L])),await Q(P),q("")},Y=async p=>{if(!ie||!A)return;const P=T[ft(r,A)]||{reviewers:[],approvers:[]},W={reviewers:(P.reviewers||[]).filter(M=>M!==p),approvers:(P.approvers||[]).filter(M=>M!==p)};await Q(W)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:d,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:p=>p.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:d,children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:A,onChange:p=>$(p.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),o.map(p=>e.jsx("option",{value:p,children:p},p))]})]}),A&&!ie&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),A&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:L,onChange:p=>q(p.target.value),disabled:!ie,children:[e.jsx("option",{value:"",children:"Choose user"}),B.map(p=>e.jsxs("option",{value:p.id,children:[p.rank," ",p.lastName,", ",p.firstName,p.mi?` ${p.mi}`:""," â€¢ ",p.email]},p.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:se,onChange:p=>E(p.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!ie||!L||K,onClick:v,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[_.map(p=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[p.rank," ",p.lastName,", ",p.firstName,p.mi?` ${p.mi}`:""," â€¢ ",p.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!ie||K,onClick:()=>Y(p.id),children:"Remove"})]},p.id)),_.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}function Ia(){const[s,r]=n.useState(()=>{try{const t=localStorage.getItem("currentUser");return t?JSON.parse(t):null}catch{return null}}),[o,f]=n.useState([]),[d,D]=n.useState([]),[I,A]=n.useState({}),[$,L]=n.useState({}),[q,se]=n.useState({}),[E,K]=n.useState({}),[z,T]=n.useState({}),[m,ie]=n.useState(null),B=n.useRef(null),[_,Q]=n.useState([]),[v,Y]=n.useState("Pending"),[p,P]=n.useState(""),[W,M]=n.useState({}),[G,k]=n.useState({}),[j,X]=n.useState([]),[H,te]=n.useState({}),[de,R]=n.useState(!1),[ye,De]=n.useState(!1),[Ee,ve]=n.useState(null),[Le,pe]=n.useState(""),Ae=fs();n.useEffect(()=>{const t=l=>{m&&B.current&&!B.current.contains(l.target)&&(K(x=>({...x,[m]:!1})),ie(null))},a=l=>{l.key==="Escape"&&m&&(K(x=>({...x,[m]:!1})),ie(null))};return document.addEventListener("mousedown",t),document.addEventListener("keydown",a),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("keydown",a)}},[m]),n.useEffect(()=>{yt().then(t=>f(t)).catch(()=>f([]))},[]),n.useEffect(()=>{Yt().then(t=>D(t)).catch(()=>D([]))},[]),n.useEffect(()=>{xt().then(t=>{const a={};for(const l of t)l!=null&&l.id&&(a[l.id]=l);L(a)}).catch(()=>L({}))},[]),n.useEffect(()=>{Ut().then(Q).catch(()=>Q([]))},[]),n.useEffect(()=>{ws().then(X).catch(()=>X([]))},[]);const xe=(s==null?void 0:s.id)||"",be=String((s==null?void 0:s.hqmcDivision)||""),Oe=n.useMemo(()=>_.filter(t=>t.division_code===be&&((t.reviewers||[]).includes(xe)||(t.approvers||[]).includes(xe))).map(t=>t.branch),[_,be,xe]),Fe=t=>$[t.uploadedById]||null,_e=t=>{if(!be||!xe)return!1;const a=String(t.routeSection||"");return Oe.includes(a)},Te=t=>(t.activity||[]).some(a=>/HQMC Approver Approved/i.test(String(a.action||""))),we=n.useMemo(()=>(Array.isArray(o)?o:[]).filter(_e),[o,Oe]),Ve=n.useMemo(()=>we.filter(t=>(t.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&!Te(t)),[we]),ke=n.useMemo(()=>we.filter(t=>(t.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&Te(t)),[we]),Ce=n.useCallback(t=>{if(t.isPermanent)return"Permanent";if(!t.retentionValue||!t.cutoffTrigger||!t.filedAt)return"Unknown";const a=new Date(t.filedAt);let l;switch(t.cutoffTrigger){case"CALENDAR_YEAR":l=new Date(a.getFullYear(),11,31);break;case"FISCAL_YEAR":l=a.getMonth()>=9?new Date(a.getFullYear()+1,8,30):new Date(a.getFullYear(),8,30);break;default:l=a}const x=new Date(l),w=(t.retentionUnit||"").toLowerCase();return w==="years"?x.setFullYear(x.getFullYear()+t.retentionValue):w==="months"?x.setMonth(x.getMonth()+t.retentionValue):w==="days"&&x.setDate(x.getDate()+t.retentionValue),x.getFullYear().toString()},[]),h=n.useCallback(t=>{if(!t.retentionValue||!t.cutoffTrigger||!t.filedAt)return"N/A";if(t.isPermanent)return"Permanent";const a=new Date(t.filedAt);let l;switch(t.cutoffTrigger){case"CALENDAR_YEAR":l=new Date(a.getFullYear(),11,31);break;case"FISCAL_YEAR":l=a.getMonth()>=9?new Date(a.getFullYear()+1,8,30):new Date(a.getFullYear(),8,30);break;default:l=a}const x=new Date(l),w=(t.retentionUnit||"").toLowerCase();return w==="years"?x.setFullYear(x.getFullYear()+t.retentionValue):w==="months"?x.setMonth(x.getMonth()+t.retentionValue):w==="days"&&x.setDate(x.getDate()+t.retentionValue),x.toLocaleDateString()},[]),C=n.useMemo(()=>{let t=we.filter(l=>!!l.filedAt);if(p.trim()){const l=p.toLowerCase().trim();t=t.filter(x=>{var w,Z,oe,le;return((w=x.subject)==null?void 0:w.toLowerCase().includes(l))||((Z=x.ssic)==null?void 0:Z.toLowerCase().includes(l))||((oe=x.ssicNomenclature)==null?void 0:oe.toLowerCase().includes(l))||((le=x.ssicBucketTitle)==null?void 0:le.toLowerCase().includes(l))})}const a={};for(const l of t){const x=Ce(l),w=l.ssicBucketTitle||l.ssicBucket||"Uncategorized";a[x]||(a[x]={}),a[x][w]||(a[x][w]=[]),a[x][w].push(l)}for(const l of Object.keys(a))for(const x of Object.keys(a[l]))a[l][x].sort((w,Z)=>new Date(Z.createdAt).getTime()-new Date(w.createdAt).getTime());return a},[we,p,Ce]),J=n.useMemo(()=>Object.keys(C).sort((a,l)=>a==="Permanent"?-1:l==="Permanent"||a==="Unknown"?1:l==="Unknown"?-1:parseInt(a)-parseInt(l)),[C]),U=n.useMemo(()=>Object.values(C).reduce((t,a)=>t+Object.values(a).reduce((l,x)=>l+x.length,0),0),[C]),g=t=>d.filter(a=>a.requestId===t),N=t=>`"${String(t??"").replace(/"/g,'""')}"`,ae=t=>{const l=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const x of t){const w=Fe(x),Z=w?`${w.rank} ${w.lastName}, ${w.firstName}${w.mi?` ${w.mi}`:""}`:"",oe=g(x.id).map(le=>le.name).join(" | ");l.push([x.id,x.subject,x.currentStage||"",x.routeSection||"",Z,x.unitUic||"",new Date(x.createdAt).toLocaleString(),oe])}return l.map(x=>x.map(N).join(",")).join(`\r
`)},F=(t,a)=>{const l=new Blob([a],{type:"text/csv;charset=utf-8;"}),x=URL.createObjectURL(l),w=document.createElement("a");w.href=x,w.download=t,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(x)},fe=()=>F("hqmc_pending.csv",ae(Ve)),Ie=()=>F("hqmc_approved.csv",ae(ke)),ne=n.useMemo(()=>Object.values(C).flatMap(t=>Object.values(t).flat()),[C]),qe=()=>F("hqmc_all.csv",ae([...Ve,...ke,...ne])),Be=async t=>{const a=s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Reviewer",l=String(H[t.id]||"").trim();if(!l){alert("Select an HQMC section to route to approver");return}const x={actor:a,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${l}`,comment:(I[t.id]||"").trim()},w={...t,routeSection:l,activity:Array.isArray(t.activity)?[...t.activity,x]:[x]};try{await ze(w)}catch{}f(Z=>Z.map(oe=>oe.id===w.id?w:oe)),A(Z=>({...Z,[t.id]:""}))},We=async t=>{const l={actor:s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC to Installation",comment:(I[t.id]||"").trim()},x={...t,currentStage:"INSTALLATION_REVIEW",activity:Array.isArray(t.activity)?[...t.activity,l]:[l]};try{await ze(x)}catch{}f(w=>w.map(Z=>Z.id===x.id?x:Z)),A(w=>({...w,[t.id]:""}))},Je=t=>{ve(t),pe(new Date().toISOString().slice(0,10)),De(!0)},Ye=async()=>{if(!Ee||!Le)return;const t=Ee,l={actor:s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Section",timestamp:new Date().toISOString(),action:`Filed by HQMC Section (Date Finalized: ${Le})`,comment:(I[t.id]||"").trim()},x={...t,filedAt:new Date(Le).toISOString(),activity:Array.isArray(t.activity)?[...t.activity,l]:[l]};try{await ze(x),f(w=>w.map(Z=>Z.id===x.id?x:Z)),A(w=>({...w,[t.id]:""})),De(!1),ve(null),pe(""),Ae.success("Request filed successfully")}catch(w){console.error("Failed to file request:",w),Ae.error("Failed to file request")}},Me=async t=>{const a=s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Section",l=String(H[t.id]||"").trim();if(!l){alert("Select an HQMC section to reassign to");return}const x={actor:a,timestamp:new Date().toISOString(),action:`Reassigned to HQMC section: ${l}`,comment:(I[t.id]||"").trim()},w={...t,routeSection:l,activity:Array.isArray(t.activity)?[...t.activity,x]:[x]};try{await ze(w)}catch{}f(Z=>Z.map(oe=>oe.id===w.id?w:oe)),A(Z=>({...Z,[t.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:be||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:qe,children:"Export All"}),Oe.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>R(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>Y("Pending"),className:`${v==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>Y("Approved"),className:`${v==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"}),e.jsxs("button",{onClick:()=>Y("Files"),className:`${v==="Files"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:["Files (",U,")"]})]})}),e.jsxs("div",{className:"mt-4",children:[v==="Pending"&&e.jsx(lt,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:fe,children:"Export Pending"}),requests:Ve,users:$,onRowClick:t=>se(a=>({...a,[t.id]:!a[t.id]})),expandedRows:q,children:t=>e.jsxs("div",{id:`details-hq-${t.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!E[t.id],"aria-controls":`docs-hq-${t.id}`,onClick:()=>{K(a=>({...a,[t.id]:!a[t.id]})),ie(a=>E[t.id]?null:t.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${E[t.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${t.id}`,ref:E[t.id]?B:void 0,className:`${E[t.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(ut,{documents:g(t.id).map(a=>({...a,fileUrl:a.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[t.id],"aria-controls":`logs-hq-${t.id}`,onClick:()=>T(a=>({...a,[t.id]:!a[t.id]})),children:[z[t.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hq-${t.id}`,className:z[t.id]?"mt-2 space-y-2":"hidden",children:t.activity&&t.activity.length?t.activity.map((a,l)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[a.actor," â€¢ ",new Date(a.timestamp).toLocaleString()," â€¢ ",a.action]}),a.comment&&e.jsx("div",{className:"text-gray-600",children:a.comment})]},l)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:I[t.id]||"",onChange:a=>A(l=>({...l,[t.id]:a.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:H[t.id]||"",onChange:a=>te(l=>({...l,[t.id]:a.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),j.filter(a=>String(a.division_code||"")===be).map(a=>e.jsx("option",{value:a.branch,children:a.branch},a.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Be(t),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>We(t),children:"Return"})]})]})]})}),v==="Approved"&&e.jsx(lt,{title:"Approved by HQMC Approver",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ie,children:"Export Approved"}),requests:ke,users:$,onRowClick:t=>se(a=>({...a,[t.id]:!a[t.id]})),expandedRows:q,children:t=>e.jsxs("div",{id:`details-hqa-${t.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!E[t.id],"aria-controls":`docs-hqa-${t.id}`,onClick:()=>{K(a=>({...a,[t.id]:!a[t.id]})),ie(a=>E[t.id]?null:t.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${E[t.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${t.id}`,ref:E[t.id]?B:void 0,className:`${E[t.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(ut,{documents:g(t.id).map(a=>({...a,fileUrl:a.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[t.id],"aria-controls":`logs-hqa-${t.id}`,onClick:()=>T(a=>({...a,[t.id]:!a[t.id]})),children:[z[t.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqa-${t.id}`,className:z[t.id]?"mt-2 space-y-2":"hidden",children:t.activity&&t.activity.length?t.activity.map((a,l)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[a.actor," â€¢ ",new Date(a.timestamp).toLocaleString()," â€¢ ",a.action]}),a.comment&&e.jsx("div",{className:"text-gray-600",children:a.comment})]},l)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:I[t.id]||"",onChange:a=>A(l=>({...l,[t.id]:a.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Reassign to Section"}),e.jsxs("select",{value:H[t.id]||"",onChange:a=>te(l=>({...l,[t.id]:a.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),j.filter(a=>String(a.division_code||"")===be).map(a=>e.jsx("option",{value:a.branch,children:a.branch},a.branch))]}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Me(t),children:"Reassign"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.ssic&&!t.filedAt&&e.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>Je(t),children:"File"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>We(t),children:"Return to Installation"})]})]})]})}),v==="Files"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search files by subject, SSIC, category...",value:p,onChange:t=>P(t.target.value),className:"w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold focus:border-transparent"}),e.jsx("svg",{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),p&&e.jsx("button",{onClick:()=>P(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),J.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:p?"No records match your search.":"No filed records in this HQMC section."}):e.jsx("div",{className:"space-y-2",children:J.map(t=>{const a=C[t],l=Object.keys(a).sort(),x=t==="Permanent",w=Object.values(a).reduce((oe,le)=>oe+le.length,0),Z=W[t]||!1;return e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:()=>M(oe=>({...oe,[t]:!oe[t]})),className:`w-full ${x?"bg-blue-800 hover:bg-blue-700":"bg-brand-navy hover:bg-brand-navy/90"} text-brand-cream px-4 py-3 font-medium flex items-center justify-between transition-colors`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:`w-4 h-4 transition-transform flex-shrink-0 ${Z?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),e.jsx("span",{className:"truncate",children:x?"Permanent Records":`Disposal Year: ${t}`})]}),e.jsxs("span",{className:"text-xs bg-white/20 px-2 py-0.5 rounded flex-shrink-0 ml-2",children:[w," record",w!==1?"s":""]})]}),Z&&e.jsx("div",{className:"bg-gray-50 p-2 space-y-2",children:l.map(oe=>{const le=a[oe],me=`${t}-${oe}`,$e=G[me]||!1;return e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden bg-white",children:[e.jsxs("button",{onClick:()=>k(Se=>({...Se,[me]:!Se[me]})),className:"w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 font-medium text-sm flex items-center justify-between transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("svg",{className:`w-3 h-3 transition-transform flex-shrink-0 ${$e?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),e.jsx("span",{className:"truncate",children:oe})]}),e.jsxs("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:[le.length," item",le.length!==1?"s":""]})]}),$e&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"Name"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"SSIC"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"Retention"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm hidden sm:table-cell",children:"Disposal Date"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:le.map(Se=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-2 sm:px-3 py-2 font-medium text-brand-navy text-xs sm:text-sm max-w-[120px] sm:max-w-none truncate",children:Se.subject}),e.jsx("td",{className:"px-2 sm:px-3 py-2 text-xs sm:text-sm",children:Se.ssic}),e.jsx("td",{className:"px-2 sm:px-3 py-2",children:Se.isPermanent?e.jsx("span",{className:"inline-flex px-1.5 sm:px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded whitespace-nowrap",children:"Perm"}):e.jsxs("span",{className:"inline-flex px-1.5 sm:px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded whitespace-nowrap",children:[Se.retentionValue," ",(Se.retentionUnit||"").replace("S","")]})}),e.jsx("td",{className:"px-2 sm:px-3 py-2 text-xs sm:text-sm hidden sm:table-cell",children:h(Se)})]},Se.id))})]})})]},me)})})]},t)})})]})]})]}),de&&s&&e.jsx(Da,{currentUser:s,divisionCode:be,branches:j.filter(t=>String(t.division_code||"")===be).map(t=>t.branch),assignments:_,onClose:()=>R(!1)}),ye&&Ee&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"File Record"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Filing: ",e.jsx("strong",{children:Ee.subject})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date Finalized"}),e.jsx("input",{type:"date",value:Le,onChange:t=>pe(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"This date will be used to calculate the disposal date based on the retention schedule."})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{className:"px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300",onClick:()=>{De(!1),ve(null),pe("")},children:"Cancel"}),e.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:Ye,disabled:!Le,children:"Confirm File"})]})]})})]})}function Ma(){const[s,r]=n.useState(()=>{try{const h=localStorage.getItem("currentUser");return h?JSON.parse(h):null}catch{return null}}),[o,f]=n.useState([]),[d,D]=n.useState([]),[I,A]=n.useState({}),[$,L]=n.useState({}),[q,se]=n.useState({}),[E,K]=n.useState({}),[z,T]=n.useState({}),[m,ie]=n.useState(null),B=n.useRef(null),[_,Q]=n.useState([]),[v,Y]=n.useState("Pending"),[p,P]=n.useState(""),[W,M]=n.useState({}),[G,k]=n.useState({});n.useEffect(()=>{const h=J=>{m&&B.current&&!B.current.contains(J.target)&&(K(U=>({...U,[m]:!1})),ie(null))},C=J=>{J.key==="Escape"&&m&&(K(U=>({...U,[m]:!1})),ie(null))};return document.addEventListener("mousedown",h),document.addEventListener("keydown",C),()=>{document.removeEventListener("mousedown",h),document.removeEventListener("keydown",C)}},[m]),n.useEffect(()=>{yt().then(h=>f(h)).catch(()=>f([]))},[]),n.useEffect(()=>{Yt().then(h=>D(h)).catch(()=>D([]))},[]),n.useEffect(()=>{xt().then(h=>{const C={};for(const J of h)J!=null&&J.id&&(C[J.id]=J);L(C)}).catch(()=>L({}))},[]),n.useEffect(()=>{Ut().then(Q).catch(()=>Q([]))},[]);const j=(s==null?void 0:s.id)||"",X=String((s==null?void 0:s.hqmcDivision)||""),H=n.useMemo(()=>_.filter(h=>h.division_code===X&&(h.approvers||[]).includes(j)).map(h=>h.branch),[_,X,j]),te=h=>$[h.uploadedById]||null,de=h=>{if(!X||!j)return!1;const C=String(h.routeSection||"");return H.includes(C)},R=h=>(h.activity||[]).some(C=>/HQMC Approver Approved/i.test(String(C.action||""))),ye=n.useMemo(()=>(Array.isArray(o)?o:[]).filter(de),[o,H]),De=n.useMemo(()=>ye.filter(h=>(h.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&!R(h)),[ye]),Ee=n.useMemo(()=>ye.filter(h=>R(h)),[ye]),ve=n.useCallback(h=>{if(h.isPermanent)return"Permanent";if(!h.retentionValue||!h.cutoffTrigger||!h.filedAt)return"Unknown";const C=new Date(h.filedAt);let J;switch(h.cutoffTrigger){case"CALENDAR_YEAR":J=new Date(C.getFullYear(),11,31);break;case"FISCAL_YEAR":J=C.getMonth()>=9?new Date(C.getFullYear()+1,8,30):new Date(C.getFullYear(),8,30);break;default:J=C}const U=new Date(J),g=(h.retentionUnit||"").toLowerCase();return g==="years"?U.setFullYear(U.getFullYear()+h.retentionValue):g==="months"?U.setMonth(U.getMonth()+h.retentionValue):g==="days"&&U.setDate(U.getDate()+h.retentionValue),U.getFullYear().toString()},[]),Le=n.useCallback(h=>{if(!h.retentionValue||!h.cutoffTrigger||!h.filedAt)return"N/A";if(h.isPermanent)return"Permanent";const C=new Date(h.filedAt);let J;switch(h.cutoffTrigger){case"CALENDAR_YEAR":J=new Date(C.getFullYear(),11,31);break;case"FISCAL_YEAR":J=C.getMonth()>=9?new Date(C.getFullYear()+1,8,30):new Date(C.getFullYear(),8,30);break;default:J=C}const U=new Date(J),g=(h.retentionUnit||"").toLowerCase();return g==="years"?U.setFullYear(U.getFullYear()+h.retentionValue):g==="months"?U.setMonth(U.getMonth()+h.retentionValue):g==="days"&&U.setDate(U.getDate()+h.retentionValue),U.toLocaleDateString()},[]),pe=n.useMemo(()=>{let h=o.filter(J=>!(!J.filedAt||H.length>0&&!H.some(g=>String(J.routeSection||"").toUpperCase()===g.toUpperCase())));if(p.trim()){const J=p.toLowerCase().trim();h=h.filter(U=>{var g,N,ae,F;return((g=U.subject)==null?void 0:g.toLowerCase().includes(J))||((N=U.ssic)==null?void 0:N.toLowerCase().includes(J))||((ae=U.ssicNomenclature)==null?void 0:ae.toLowerCase().includes(J))||((F=U.ssicBucketTitle)==null?void 0:F.toLowerCase().includes(J))})}const C={};for(const J of h){const U=ve(J),g=J.ssicBucketTitle||J.ssicBucket||"Uncategorized";C[U]||(C[U]={}),C[U][g]||(C[U][g]=[]),C[U][g].push(J)}for(const J of Object.keys(C))for(const U of Object.keys(C[J]))C[J][U].sort((g,N)=>new Date(N.createdAt).getTime()-new Date(g.createdAt).getTime());return C},[o,H,p,ve]),Ae=n.useMemo(()=>Object.keys(pe).sort((h,C)=>h==="Permanent"?1:C==="Permanent"?-1:h==="Unknown"?1:C==="Unknown"?-1:parseInt(h)-parseInt(C)),[pe]),xe=n.useMemo(()=>Object.values(pe).reduce((h,C)=>h+Object.values(C).reduce((J,U)=>J+U.length,0),0),[pe]),be=h=>d.filter(C=>C.requestId===h),Oe=h=>`"${String(h??"").replace(/"/g,'""')}"`,Fe=h=>{const J=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const U of h){const g=te(U),N=g?`${g.rank} ${g.lastName}, ${g.firstName}${g.mi?` ${g.mi}`:""}`:"",ae=be(U.id).map(F=>F.name).join(" | ");J.push([U.id,U.subject,U.currentStage||"",U.routeSection||"",N,U.unitUic||"",new Date(U.createdAt).toLocaleString(),ae])}return J.map(U=>U.map(Oe).join(",")).join(`\r
`)},_e=(h,C)=>{const J=new Blob([C],{type:"text/csv;charset=utf-8;"}),U=URL.createObjectURL(J),g=document.createElement("a");g.href=U,g.download=h,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(U)},Te=()=>_e("hqmc_approver_pending.csv",Fe(De)),we=()=>_e("hqmc_approver_approved.csv",Fe(Ee)),Ve=()=>_e("hqmc_approver_all.csv",Fe([...De,...Ee])),ke=async h=>{const J={actor:s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved - Pending HQMC Section Action",comment:(I[h.id]||"").trim()},U={...h,currentStage:"HQMC_REVIEW",activity:Array.isArray(h.activity)?[...h.activity,J]:[J]};try{await ze(U)}catch{}f(g=>g.map(N=>N.id===U.id?U:N)),A(g=>({...g,[h.id]:""}))},Ce=async h=>{const J={actor:s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver to Installation",comment:(I[h.id]||"").trim()},U={...h,currentStage:"INSTALLATION_REVIEW",activity:Array.isArray(h.activity)?[...h.activity,J]:[J]};try{await ze(U)}catch{}f(g=>g.map(N=>N.id===U.id?U:N)),A(g=>({...g,[h.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((s==null?void 0:s.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ve,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>Y("Pending"),className:`${v==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>Y("Approved"),className:`${v==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"}),e.jsxs("button",{onClick:()=>Y("Files"),className:`${v==="Files"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:["Files (",xe,")"]})]})}),e.jsxs("div",{className:"mt-4",children:[v==="Pending"&&e.jsx(lt,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Te,children:"Export Pending"}),requests:De,users:$,onRowClick:h=>se(C=>({...C,[h.id]:!C[h.id]})),expandedRows:q,children:h=>e.jsxs("div",{id:`details-hqa-${h.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!E[h.id],"aria-controls":`docs-hqa-${h.id}`,onClick:()=>{K(C=>({...C,[h.id]:!C[h.id]})),ie(C=>E[h.id]?null:h.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${E[h.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${h.id}`,ref:E[h.id]?B:void 0,className:`${E[h.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(ut,{documents:be(h.id).map(C=>({...C,fileUrl:C.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[h.id],"aria-controls":`logs-hqa-${h.id}`,onClick:()=>T(C=>({...C,[h.id]:!C[h.id]})),children:[z[h.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqa-${h.id}`,className:z[h.id]?"mt-2 space-y-2":"hidden",children:h.activity&&h.activity.length?h.activity.map((C,J)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[C.actor," â€¢ ",new Date(C.timestamp).toLocaleString()," â€¢ ",C.action]}),C.comment&&e.jsx("div",{className:"text-gray-600",children:C.comment})]},J)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:I[h.id]||"",onChange:C=>A(J=>({...J,[h.id]:C.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>ke(h),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>Ce(h),children:"Return"})]})]})}),v==="Approved"&&e.jsx(lt,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:we,children:"Export Approved"}),requests:Ee,users:$,onRowClick:h=>se(C=>({...C,[h.id]:!C[h.id]})),expandedRows:q,children:h=>e.jsxs("div",{id:`details-hqa-${h.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!E[h.id],"aria-controls":`docs-hqa-${h.id}`,onClick:()=>{K(C=>({...C,[h.id]:!C[h.id]})),ie(C=>E[h.id]?null:h.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${E[h.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${h.id}`,ref:E[h.id]?B:void 0,className:`${E[h.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(ut,{documents:be(h.id).map(C=>({...C,fileUrl:C.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[h.id],"aria-controls":`logs-hqaa-${h.id}`,onClick:()=>T(C=>({...C,[h.id]:!C[h.id]})),children:[z[h.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqaa-${h.id}`,className:z[h.id]?"mt-2 space-y-2":"hidden",children:h.activity&&h.activity.length?h.activity.map((C,J)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[C.actor," â€¢ ",new Date(C.timestamp).toLocaleString()," â€¢ ",C.action]}),C.comment&&e.jsx("div",{className:"text-gray-600",children:C.comment})]},J)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})}),v==="Files"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search files by subject, SSIC, category...",value:p,onChange:h=>P(h.target.value),className:"w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold focus:border-transparent"}),e.jsx("svg",{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),p&&e.jsx("button",{onClick:()=>P(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),Ae.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:p?"No records match your search.":"No filed records."}):e.jsx("div",{className:"space-y-2",children:Ae.map(h=>{const C=pe[h],J=Object.keys(C).sort(),U=h==="Permanent",g=Object.values(C).reduce((ae,F)=>ae+F.length,0),N=W[h]||!1;return e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:()=>M(ae=>({...ae,[h]:!ae[h]})),className:`w-full ${U?"bg-blue-800 hover:bg-blue-700":"bg-brand-navy hover:bg-brand-navy/90"} text-brand-cream px-4 py-3 font-medium flex items-center justify-between transition-colors`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:`w-4 h-4 transition-transform flex-shrink-0 ${N?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),e.jsx("span",{className:"truncate",children:U?"Permanent Records":`Disposal Year: ${h}`})]}),e.jsxs("span",{className:"text-xs bg-white/20 px-2 py-0.5 rounded flex-shrink-0 ml-2",children:[g," record",g!==1?"s":""]})]}),N&&e.jsx("div",{className:"bg-gray-50 p-2 space-y-2",children:J.map(ae=>{const F=C[ae],fe=`${h}-${ae}`,Ie=G[fe]||!1;return e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden bg-white",children:[e.jsxs("button",{onClick:()=>k(ne=>({...ne,[fe]:!ne[fe]})),className:"w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 font-medium text-sm flex items-center justify-between transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("svg",{className:`w-3 h-3 transition-transform flex-shrink-0 ${Ie?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),e.jsx("span",{className:"truncate",children:ae})]}),e.jsxs("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:[F.length," item",F.length!==1?"s":""]})]}),Ie&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"Name"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"SSIC"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"Retention"}),e.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm hidden sm:table-cell",children:"Disposal Date"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:F.map(ne=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-2 sm:px-3 py-2 font-medium text-brand-navy text-xs sm:text-sm max-w-[120px] sm:max-w-none truncate",children:ne.subject}),e.jsx("td",{className:"px-2 sm:px-3 py-2 text-xs sm:text-sm",children:ne.ssic}),e.jsx("td",{className:"px-2 sm:px-3 py-2",children:ne.isPermanent?e.jsx("span",{className:"inline-flex px-1.5 sm:px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded whitespace-nowrap",children:"Perm"}):e.jsxs("span",{className:"inline-flex px-1.5 sm:px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded whitespace-nowrap",children:[ne.retentionValue," ",(ne.retentionUnit||"").replace("S","")]})}),e.jsx("td",{className:"px-2 sm:px-3 py-2 text-xs sm:text-sm hidden sm:table-cell",children:Le(ne)})]},ne.id))})]})})]},fe)})})]},h)})})]})]})]})})}const Pa=({onUnitSelect:s,selectedUnit:r})=>{const[o,f]=n.useState(""),[d,D]=n.useState(!1),I=st.filter($=>$.unitName.toLowerCase().startsWith(o.toLowerCase())||$.uic.toLowerCase().startsWith(o.toLowerCase())||$.ruc.toLowerCase().startsWith(o.toLowerCase())),A=$=>{s($),D(!1),f("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>D(!d),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[r?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:r.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",r.uic," | RUC: ",r.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),d&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:o,onChange:$=>f($.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:I.map($=>e.jsxs("button",{type:"button",onClick:()=>A($),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:$.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",$.uic," | RUC: ",$.ruc," | MCC: ",$.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[$.streetAddress,", ",$.cityState," ",$.zip]})]},$.uic))})]})]})]})},Ht=async s=>{const o=new TextEncoder().encode(s),f=await crypto.subtle.digest("SHA-256",o);return Array.from(new Uint8Array(f)).map(d=>d.toString(16).padStart(2,"0")).join("")},is={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},La=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Is=({onSaved:s,initial:r={},mode:o="create",readOnly:f=!1,canEditRole:d=!1,canEditAdmin:D=!1})=>{const[I,A]=n.useState(""),[$,L]=n.useState(""),[q,se]=n.useState(""),[E,K]=n.useState(r.email||""),[z,T]=n.useState(r.edipi||""),[m,ie]=n.useState(r.service||""),[B,_]=n.useState(r.rank||""),[Q,v]=n.useState(r.role||"MEMBER"),[Y,p]=n.useState(!!r.isUnitAdmin),[P,W]=n.useState(r.company||""),[M,G]=n.useState(r.platoon||""),[k,j]=n.useState(void 0),[X,H]=n.useState(null),[te,de]=n.useState({}),[R,ye]=n.useState(""),[De,Ee]=n.useState(""),[ve,Le]=n.useState([]),[pe,Ae]=n.useState(!1),[xe,be]=n.useState(r.roleCompany||""),[Oe,Fe]=n.useState(r.rolePlatoon||""),[_e,Te]=n.useState(!1),[we,Ve]=n.useState([]),[ke,Ce]=n.useState([]),[h,C]=n.useState([]),[J,U]=n.useState([]);n.useEffect(()=>{if(r.firstName&&A(String(r.firstName)),r.lastName&&L(String(r.lastName)),r.mi&&se(String(r.mi)),r.company&&W(String(r.company)),r.platoon&&G(String(r.platoon)),r.roleCompany&&be(String(r.roleCompany)),r.rolePlatoon&&Fe(String(r.rolePlatoon)),r.unitUic){const a=st.find(l=>l.uic===r.unitUic);a&&j(a)}},[r]);const g=n.useMemo(()=>is[m]||[],[m]),N=n.useMemo(()=>{if(!k)return[];const a=we;if(a&&a.length)return a;const l=te[k.uic]||{};return Object.keys(l).filter(x=>!x.startsWith("_")&&Array.isArray(l[x]))},[k,te,we]),ae=n.useMemo(()=>{var a;return k&&P?((a=te[k.uic])==null?void 0:a[P])||[]:[]},[k,P,te]),F=n.useMemo(()=>{if(!k||!P)return[];const a=ke;return a&&a.length?a:ae},[k,P,ke,ae]),fe=n.useMemo(()=>{if(!k)return[];const a=h;if(a&&a.length)return a;const l=te[k.uic]||{};return Object.keys(l).filter(x=>!x.startsWith("_")&&Array.isArray(l[x]))},[k,te,h]),Ie=n.useMemo(()=>{var a;return k&&xe?((a=te[k.uic])==null?void 0:a[xe])||[]:[]},[k,xe,te]),ne=n.useMemo(()=>{if(!k||!xe)return[];const a=J;return a&&a.length?a:Ie},[k,xe,J,Ie]),qe=n.useMemo(()=>{const a=N.slice(),l=P||r.company||r.user_company||"";return l&&!a.includes(l)?[l,...a]:a},[N,P,r]),Be=n.useMemo(()=>{const a=F.slice(),l=M||r.platoon||r.user_platoon||"";return l&&!a.includes(l)?[l,...a]:a},[F,M,r]),We=n.useMemo(()=>{const a=fe.slice(),l=xe||r.roleCompany||"",x=l&&!a.includes(l)?[l,...a]:a;return Array.from(new Set(x))},[fe,xe,r]),Je=n.useMemo(()=>{const a=ne.slice(),l=Oe||r.rolePlatoon||"";return l&&!a.includes(l)?[l,...a]:a},[ne,Oe,r]);n.useEffect(()=>{(async()=>{try{if(o==="edit"&&r.id){const a=await Cs(String(r.id));a&&(a.company&&!P&&W(String(a.company)),a.platoon&&!M&&G(String(a.platoon)),a.roleCompany&&!xe&&be(String(a.roleCompany)),a.rolePlatoon&&!Oe&&Fe(String(a.rolePlatoon)))}}catch{}})()},[o,r.id]),n.useEffect(()=>{g.includes(B)||_("")},[g]),n.useEffect(()=>{G("")},[P]),n.useEffect(()=>{Fe("")},[xe]),n.useEffect(()=>{try{const a=localStorage.getItem("unit_structure");a&&de(JSON.parse(a))}catch{}},[k]),n.useEffect(()=>{const a=(k==null?void 0:k.uic)||"";if(!a){Ve([]),C([]);return}As(a).then(l=>{Ve(l||[]),C(l||[])}).catch(()=>{Ve([]),C([])})},[k]),n.useEffect(()=>{const a=(k==null?void 0:k.uic)||"",l=P||"";if(!a||!l){Ce([]);return}Vt(a,l).then(x=>Ce(x||[])).catch(()=>Ce([]))},[k,P]),n.useEffect(()=>{const a=(k==null?void 0:k.uic)||"",l=xe||"";if(!a||!l){U([]);return}Vt(a,l).then(x=>U(x||[])).catch(()=>U([]))},[k,xe]),n.useEffect(()=>{xt().then(a=>{Le(a)}).catch(()=>Le([]))},[]),n.useEffect(()=>{const a=(k==null?void 0:k.uic)||"";if(!a){Ae(!1);return}const l=ve.some(x=>!!x.isUnitAdmin&&(x.unitUic||"")===a);Ae(l)},[k,ve]),n.useEffect(()=>{if(k){!P&&r.company&&qe.includes(r.company)&&W(String(r.company));const a=r.platoon;!M&&a&&Be.includes(a)&&G(String(a))}},[k,qe,Be,P,M,r]);const Ye=a=>/^[0-9]{10}$/.test(a),Me=(a,l)=>{try{return ve.some(x=>String(x.edipi)===String(a)&&String(x.id)!==String(l||""))}catch{return!1}},t=async a=>{var Z,oe;if(a.preventDefault(),H(null),f)return;if(!I.trim())return H({type:"error",message:"First name is required."});if(!$.trim())return H({type:"error",message:"Last name is required."});if(q&&!/^[A-Za-z]$/.test(q))return H({type:"error",message:"MI must be a single letter."});if(!E.trim())return H({type:"error",message:"Email is required."});if(!Ye(String(z)))return H({type:"error",message:"EDIPI must be 10 digits."});if(!m)return H({type:"error",message:"Service is required."});if(!B)return H({type:"error",message:"Rank is required."});if(Me(String(z),r.id?String(r.id):void 0))return H({type:"error",message:"EDIPI already exists."});if(Q==="COMPANY_REVIEWER"&&!xe)return H({type:"error",message:"Role Company is required for Company Reviewer."});if(Q==="PLATOON_REVIEWER"&&(!xe||!Oe))return H({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${I.trim()}`,q&&""+q.trim().toUpperCase(),`${$.trim()}`;let l=r.id?String(r.id):`usr-${Date.now()}`,x=r.passwordHash||"";if(o==="create"){if(!R||R.length<8)return H({type:"error",message:"Password must be at least 8 characters."});if(R!==De)return H({type:"error",message:"Passwords do not match."});try{const{data:le,error:me}=await ga(E.trim(),R);if(me){H({type:"error",message:`Failed to create auth user: ${String(me.message||me)}`});return}const $e=(Z=le==null?void 0:le.user)!=null&&Z.id?String(le.user.id):"";if(!$e){H({type:"error",message:"Auth user ID missing after sign up."});return}l=$e}catch(le){H({type:"error",message:`Failed to create auth user: ${String((le==null?void 0:le.message)||le)}`});return}x=await Ht(R)}else if(o==="edit"&&R){if(R.length<8)return H({type:"error",message:"Password must be at least 8 characters."});if(R!==De)return H({type:"error",message:"Passwords do not match."});x=await Ht(R)}const w={id:l,firstName:I.trim(),lastName:$.trim(),mi:q?q.trim().toUpperCase():void 0,email:E.trim(),edipi:z,service:m,rank:B,role:Q,company:P||"N/A",unit:(k==null?void 0:k.unitName)||"N/A",unitUic:k==null?void 0:k.uic,passwordHash:x,isUnitAdmin:o==="create"&&k&&!pe?!0:Y,roleCompany:xe||void 0,rolePlatoon:Oe||void 0,platoon:M||"N/A"};try{const le=await at({id:w.id,email:w.email,rank:w.rank,firstName:w.firstName,lastName:w.lastName,mi:w.mi,service:w.service,role:w.role,unitUic:w.unitUic,unit:(k==null?void 0:k.unitName)||"N/A",company:w.company,isUnitAdmin:!!w.isUnitAdmin,edipi:String(w.edipi),passwordHash:x,platoon:M||"N/A",roleCompany:xe||void 0,rolePlatoon:Oe||void 0});if(!le.ok){H({type:"error",message:`Failed to save profile: ${String(((oe=le==null?void 0:le.error)==null?void 0:oe.message)||(le==null?void 0:le.error)||"unknown")}`});return}H({type:"success",message:r.id?"Profile updated.":k&&!pe?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),s==null||s(w)}catch{H({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:o==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:t,className:"space-y-6",children:[o==="create"&&k&&!pe&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:k.unitName})," (UIC ",k.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:$,onChange:a=>L(a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:I,onChange:a=>A(a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:q,maxLength:1,onChange:a=>se(a.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:E,onChange:a=>K(a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:z,onChange:a=>T(a.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:m,onChange:a=>ie(a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(is).map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:B,onChange:a=>_(a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),g.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),o==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:R,onChange:a=>ye(a.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:De,onChange:a=>Ee(a.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f})]})]}):e.jsx(e.Fragment,{})]})]}),_e&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:R,onChange:a=>ye(a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:De,onChange:a=>Ee(a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>Te(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>Te(!1),children:"Save"})]})]})}),o==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:Q,onChange:a=>v(a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:La.map(a=>e.jsx("option",{value:a,children:a},a))})}),e.jsx("div",{children:e.jsxs("select",{value:xe||String(r.roleCompany||""),onChange:a=>be(a.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:We.length?"Select company":"No companies configured"}),We.map(a=>e.jsx("option",{value:a,children:a},a))]})}),e.jsx("div",{children:e.jsxs("select",{value:Oe||String(r.rolePlatoon||""),onChange:a=>Fe(a.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Je.length?"Select platoon":"No platoons configured"}),Je.map(a=>e.jsx("option",{value:a,children:a},a))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:Y,onChange:a=>p(a.target.checked),disabled:f||!D}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(r==null?void 0:r.isCommandStaff)||Q==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(Pa,{onUnitSelect:a=>j(a),selectedUnit:k})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:P||String(r.company||""),onChange:a=>W(a.target.value),disabled:f||!k||qe.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:qe.length?"Select company":"No companies configured"}),qe.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:M||String(r.platoon||""),onChange:a=>G(a.target.value),disabled:f||!k||!P||Be.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Be.length?"Select platoon":"No platoons configured"}),Be.map(a=>e.jsx("option",{value:a,children:a},a))]})]})]})})]}),X&&e.jsx("div",{className:`p-3 rounded-lg border ${X.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:X.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[o==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>Te(!0),disabled:f,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:f,children:o==="edit"?"Save":"Create Profile"})]})]})]})},Oa=n.memo(function({user:r,onClose:o}){const f=()=>{const d=st.find(I=>I.uic===r.unitUic),D=d?d.unitName:r.unit;if(r.isUnitAdmin||r.role==="COMMANDER")return D||"â€”";if(r.role==="COMPANY_REVIEWER")return r.company&&r.company!=="N/A"?r.company:"â€”";if(r.role==="PLATOON_REVIEWER"){const I=r.company&&r.company!=="N/A"?r.company:"",A=r.platoon&&r.platoon!=="N/A"?r.platoon:"",$=[I,A].filter(Boolean);return $.length?$.join(" / "):"â€”"}return"â€”"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:o,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:o,children:"âœ•"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[r.rank," ",r.lastName,", ",r.firstName,r.mi?` ${r.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:r.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:r.edipi||"â€”"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:r.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:r.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:f()})]}),r.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),r.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:o,children:"Close"})})]})})}),$a=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],_a=()=>{const[s,r]=n.useState(null),[o,f]=n.useState(void 0),[d,D]=n.useState({}),[I,A]=n.useState({}),[$,L]=n.useState({}),[q,se]=n.useState({}),[E,K]=n.useState(""),[z,T]=n.useState(""),[m,ie]=n.useState(""),[B,_]=n.useState(""),[Q,v]=n.useState(""),[Y,p]=n.useState([]),[P,W]=n.useState(null),[M,G]=n.useState(""),k=n.useRef(null),[j,X]=n.useState(null),[H,te]=n.useState(null),[de,R]=n.useState(""),[ye,De]=n.useState(void 0),[Ee,ve]=n.useState(void 0),[Le,pe]=n.useState(void 0),[Ae,xe]=n.useState(void 0),[be,Oe]=n.useState(void 0),[Fe,_e]=n.useState(void 0),[Te,we]=n.useState([]),[Ve,ke]=n.useState([]),[Ce,h]=n.useState(""),[C,J]=n.useState("unit"),[U,g]=n.useState([]),[N,ae]=n.useState(!1),[F,fe]=n.useState(!1),[Ie,ne]=n.useState(!1),[qe,Be]=n.useState("admin"),[We,Je]=n.useState(!0),[Ye,Me]=n.useState(null),[t,a]=n.useState(0),l=n.useRef(!1);n.useEffect(()=>{j&&qe==="admin"&&!l.current&&(!ye&&j.company&&j.company!=="N/A"&&(De(j.company),pe(j.company)),!Ee&&j.platoon&&j.platoon!=="N/A"&&(ve(j.platoon),xe(j.platoon)),!be&&j.roleCompany&&j.roleCompany!=="N/A"&&Oe(j.roleCompany),!Fe&&j.rolePlatoon&&j.rolePlatoon!=="N/A"&&_e(j.rolePlatoon),l.current=!0)},[j,qe]),n.useEffect(()=>{try{const i=localStorage.getItem("unit_structure");i&&D(JSON.parse(i))}catch{}try{const i=localStorage.getItem("unit_structure"),u={},O={},re={};if(i){const je=JSON.parse(i);for(const Re of Object.keys(je||{})){const ee=je[Re];ee&&Array.isArray(ee._sections)&&(u[Re]=ee._sections),ee&&Array.isArray(ee._commandSections)&&(O[Re]=ee._commandSections),ee&&ee._platoonSectionMap&&typeof ee._platoonSectionMap=="object"&&(re[Re]=ee._platoonSectionMap)}}else(async()=>{try{const je=await At();for(const Re of Object.keys(je||{})){const ee=je[Re];ee&&Array.isArray(ee._sections)&&(u[Re]=ee._sections),ee&&Array.isArray(ee._commandSections)&&(O[Re]=ee._commandSections),ee&&ee._platoonSectionMap&&typeof ee._platoonSectionMap=="object"&&(re[Re]=ee._platoonSectionMap)}D(je)}catch{}})();A(u),L(O),se(re)}catch{}(async()=>{Je(!0),Me(null);try{const i=await Ct();if(i.error)throw new Error(i.error);p(i.data),a(i.data.length)}catch(i){const u=(i==null?void 0:i.message)||"Unknown error fetching users";console.error("[AdminPanel] Failed to fetch users:",u),Me(u),p([]),a(0)}finally{Je(!1)}})();try{const i=localStorage.getItem("currentUser");if(i){const u=JSON.parse(i);if(r(u),u.unitUic){const O=st.find(re=>re.uic===u.unitUic);O&&f(O)}}}catch{}},[]),n.useEffect(()=>{try{if(!o){const i=Object.keys(d||{});if(i.length){const u=i[0],O=d[u]||{},je=st.find(Re=>Re.uic===u)||{ruc:String(O._ruc||""),mcc:String(O._mcc||""),uic:u,unitName:String(O._unitName||u),streetAddress:String(O._streetAddress||"")};f(je)}}}catch{}},[d]),n.useEffect(()=>{const i=(j==null?void 0:j.unitUic)||"";if(!i){we([]);return}As(i).then(u=>we(u||[])).catch(()=>we([]))},[j]),n.useEffect(()=>{const i=(j==null?void 0:j.unitUic)||"",u=be||"";if(!i||!u){ke([]);return}Vt(i,u).then(O=>ke(O||[])).catch(()=>ke([]))},[j,be]);const x=n.useMemo(()=>{const i=(o==null?void 0:o.uic)||"";if(!i)return[];const u=d[i]||{};return Object.keys(u).filter(O=>!O.startsWith("_")&&Array.isArray(u[O]))},[o,d]),w=n.useMemo(()=>{var O;const i=(o==null?void 0:o.uic)||"";if(!i||!E)return[];const u=(O=d[i])==null?void 0:O[E];return Array.isArray(u)?u:[]},[o,E,d]),Z=n.useMemo(()=>{const i=(o==null?void 0:o.uic)||"";return i?I[i]||[]:[]},[o,I]),oe=n.useMemo(()=>{const i=(o==null?void 0:o.uic)||"";return i?$[i]||[]:[]},[o,$]),le=n.useMemo(()=>{const i=(j==null?void 0:j.unitUic)||"";if(!i)return[];const u=Te;if(u&&u.length)return u;const O=d[i]||{};return Object.keys(O).filter(re=>!re.startsWith("_")&&Array.isArray(O[re]))},[j,d,Te]),me=n.useMemo(()=>{var re;const i=(j==null?void 0:j.unitUic)||"",u=Le||"";if(!i||!u)return[];const O=(re=d[i])==null?void 0:re[u];return Array.isArray(O)?O:[]},[j,Le,d]),$e=n.useMemo(()=>{var je,Re;const i=(j==null?void 0:j.unitUic)||"",u=be||"";if(!u)return[];const O=Ve;if(O&&O.length>0)return O;if(i){const ee=(je=d[i])==null?void 0:je[u];if(Array.isArray(ee)&&ee.length>0)return ee}const re=(o==null?void 0:o.uic)||"";if(re&&re!==i){const ee=(Re=d[re])==null?void 0:Re[u];if(Array.isArray(ee))return ee}return[]},[j,be,d,Ve,o]),Se=n.useMemo(()=>{const i=le.slice(),u=ye||(j&&j.company!=="N/A"?j.company:"");return u&&!i.includes(u)?[u,...i]:i},[le,ye,j]);n.useMemo(()=>{const i=me.slice(),u=Ae||(j&&j.platoon&&j.platoon!=="N/A"?j.platoon:"");return u&&!i.includes(u)?[u,...i]:i},[me,Ae,j]);const vt=n.useMemo(()=>{const i=$e.slice(),u=Fe||(j&&j.rolePlatoon&&j.rolePlatoon!=="N/A"?j.rolePlatoon:"");return u&&!i.includes(u)?[u,...i]:i},[$e,Fe,j]),ct=n.useMemo(()=>o?Y.filter(i=>{const u=String(i.unitUic||"").trim().toUpperCase(),O=String(o.uic||"").trim().toUpperCase(),re=String(i.unit||"").trim().toLowerCase(),je=String(o.unitName||"").trim().toLowerCase();return u&&u===O||re&&re===je}):Y,[Y,o]),pt=n.useMemo(()=>{if(!M)return ct;const i=M.toLowerCase();return ct.filter(u=>(u.email??"").toLowerCase().includes(i)||(u.lastName??"").toLowerCase().includes(i))},[ct,M]),Ke=()=>{try{if(o){const i=o.uic,u={...d};u[i]=u[i]||{},u[i]._mcc=o.mcc||u[i]._mcc||"",u[i]._unitName=o.unitName||u[i]._unitName||"",D(u),localStorage.setItem("unit_structure",JSON.stringify(u)),(async()=>{try{if(navigator.sendBeacon){const re=new Blob([JSON.stringify(u)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",re),W({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),keepalive:!0})).ok)throw new Error("persist_failed");W({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{W({type:"error",message:"Failed to persist unit structure."})}})()}else{const i=JSON.stringify(d);localStorage.setItem("unit_structure",i),(async()=>{try{if(navigator.sendBeacon){const O=new Blob([i],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",O),W({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:i,keepalive:!0})).ok)throw new Error("persist_failed");W({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{W({type:"error",message:"Failed to persist unit structure."})}})()}}catch{W({type:"error",message:"Failed to save unit structure."})}},kt=()=>{try{if(!o)return;const i=o.uic,u={...d};u[i]=u[i]||{},u[i]._sections=I[i]||[],u[i]._mcc=o.mcc||u[i]._mcc||"",u[i]._unitName=o.unitName||u[i]._unitName||"",D(u),localStorage.setItem("unit_structure",JSON.stringify(u)),(async()=>{try{if(navigator.sendBeacon){const re=new Blob([JSON.stringify(u)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",re),W({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),keepalive:!0})).ok)throw new Error("persist_failed");W({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{W({type:"error",message:"Failed to persist unit sections."})}})()}catch{W({type:"error",message:"Failed to save unit sections."})}},Et=()=>{try{if(!o)return;const i=o.uic,u={...d};u[i]=u[i]||{},u[i]._commandSections=$[i]||[],u[i]._mcc=o.mcc||u[i]._mcc||"",u[i]._unitName=o.unitName||u[i]._unitName||"",D(u),localStorage.setItem("unit_structure",JSON.stringify(u)),(async()=>{try{if(navigator.sendBeacon){const re=new Blob([JSON.stringify(u)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",re),W({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),keepalive:!0})).ok)throw new Error("persist_failed");W({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{W({type:"error",message:"Failed to persist command sections."})}})()}catch{W({type:"error",message:"Failed to save command sections."})}},Rt=()=>{try{if(!o)return;const i=o.uic,u={...d};u[i]=u[i]||{},u[i]._platoonSectionMap=q[i]||{},u[i]._mcc=o.mcc||u[i]._mcc||"",u[i]._unitName=o.unitName||u[i]._unitName||"",D(u),localStorage.setItem("unit_structure",JSON.stringify(u)),(async()=>{try{if(navigator.sendBeacon){const re=new Blob([JSON.stringify(u)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",re),W({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),keepalive:!0})).ok)throw new Error("persist_failed");W({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{W({type:"error",message:"Failed to persist links."})}})()}catch{W({type:"error",message:"Failed to save links."})}},Dt=()=>{if(!o||!z.trim())return;const i=o.uic,u={...d};u[i]=u[i]||{},u[i][z.trim()]||(u[i][z.trim()]=[],D(u),K(z.trim()),T(""))},jt=i=>{if(!o)return;const u=o.uic,O={...d};O[u]&&(delete O[u][i],D(O),E===i&&K(""))},It=()=>{if(!o||!E||!m.trim())return;const i=o.uic,u={...d};u[i]=u[i]||{},u[i][E]=u[i][E]||[],u[i][E].includes(m.trim())||(u[i][E]=[...u[i][E],m.trim()],D(u),ie(""))},Mt=i=>{if(!o||!E)return;const u=o.uic,O={...d};O[u][E]=(O[u][E]||[]).filter(re=>re!==i),D(O)},Pt=()=>{if(!o||!B.trim())return;const i=o.uic,u={...I};u[i]=u[i]||[],u[i].includes(B.trim())||(u[i]=[...u[i],B.trim()],A(u),_(""))},Nt=i=>{if(!o)return;const u=o.uic,O={...I};O[u]=(O[u]||[]).filter(re=>re!==i),A(O)},Lt=()=>{if(!o||!Q.trim())return;const i=o.uic,u={...$};u[i]=u[i]||[],u[i].includes(Q.trim())||(u[i]=[...u[i],Q.trim()],L(u),v(""))},ht=i=>{if(!o)return;const u=o.uic,O={...$};O[u]=(O[u]||[]).filter(re=>re!==i),L(O)},Ot=()=>{const i=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],u=Y.map(ee=>[ee.firstName,ee.mi||"",ee.lastName,ee.email,ee.edipi,ee.service,ee.rank,ee.role,ee.company,ee.unit,ee.unitUic||""].map(dt=>{const nt=String(dt??"");return nt.includes(",")||nt.includes('"')||nt.includes(`
`)?'"'+nt.replace(/"/g,'""')+'"':nt}).join(",")),O="\uFEFF"+[i.join(","),...u].join(`
`),re=new Blob([O],{type:"text/csv;charset=utf-8"}),je=URL.createObjectURL(re),Re=document.createElement("a");Re.href=je,Re.download="users-export.csv",Re.click(),URL.revokeObjectURL(je)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${C==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>J("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${C==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>J("users"),children:"User Administration"})]})})}),C==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:o?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:o.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",o.uic," | RUC: ",o.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:Ke,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:z,onChange:i=>T(i.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Dt,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[x.map(i=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>K(i),children:i}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>jt(i),children:"Remove"})]},i)),x.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",E?`â€¢ ${E}`:""]}),o&&E&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:Rt,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:m,onChange:i=>ie(i.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!E}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:It,disabled:!E,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[w.map(i=>{var u,O;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:i})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:((O=(u=q[(o==null?void 0:o.uic)||""])==null?void 0:u[E])==null?void 0:O[i])||"",onChange:re=>{const je=(o==null?void 0:o.uic)||"";se(Re=>{const ee={...Re};return ee[je]=ee[je]||{},ee[je][E]=ee[je][E]||{},ee[je][E][i]=re.target.value,ee})},children:[e.jsx("option",{value:"",children:"Link to section"}),(I[(o==null?void 0:o.uic)||""]||[]).map(re=>e.jsx("option",{value:re,children:re},re))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Mt(i),children:"Remove"})]})]},i)}),w.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:kt,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:B,onChange:i=>_(i.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Pt,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Z.map(i=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:i}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Nt(i),children:"Remove"})]},i)),Z.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:Et,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:Q,onChange:i=>v(i.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Lt,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[oe.map(i=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:i}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>ht(i),children:"Remove"})]},i)),oe.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),C==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),Ye&&e.jsxs("div",{className:"mb-4 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:[e.jsx("strong",{children:"Error loading users:"})," ",Ye]}),We&&e.jsx("div",{className:"mb-4 p-3 border border-blue-200 bg-blue-50 text-blue-800 rounded",children:"Loading users..."}),!We&&!Ye&&t>0&&ct.length===0&&e.jsxs("div",{className:"mb-4 p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:[e.jsx("strong",{children:"Note:"})," ",t," user(s) found in database, but none match your unit (",(o==null?void 0:o.unitName)||"No unit selected",", UIC: ",(o==null?void 0:o.uic)||"N/A",").",e.jsx("br",{}),e.jsx("span",{className:"text-sm",children:"Users may be assigned to different units."})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[pt.map(i=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[i.lastName,", ",i.firstName,i.mi?` ${i.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:i.email}),e.jsx("td",{className:"py-2 px-3",children:i.edipi}),e.jsx("td",{className:"py-2 px-3",children:i.service}),e.jsx("td",{className:"py-2 px-3",children:i.rank}),e.jsx("td",{className:"py-2 px-3",children:i.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const u=st.find(re=>re.uic===i.unitUic),O=u?u.unitName:i.unit;if(i.isUnitAdmin||i.role==="COMMANDER")return O||"â€”";if(i.role==="COMPANY_REVIEWER"){const re=i.role_company||i.roleCompany||i.company;return re&&re!=="N/A"?re:"â€”"}if(i.role==="PLATOON_REVIEWER"){const re=i.role_company||i.roleCompany||i.company,je=i.role_platoon||i.rolePlatoon||i.platoon,dt=[re&&re!=="N/A"?re:"",je&&je!=="N/A"?je:""].filter(Boolean);return dt.length?dt.join(" / "):"â€”"}return"â€”"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>te(i),children:"View"}),((s==null?void 0:s.isUnitAdmin)||(s==null?void 0:s.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{Be("admin"),X(i),R(i.role??"MEMBER"),De(i.company!=="N/A"?i.company:void 0),pe(i.company!=="N/A"?i.company:void 0),ve(i.platoon&&i.platoon!=="N/A"?i.platoon:void 0),xe(i.platoon&&i.platoon!=="N/A"?i.platoon:void 0),h(typeof i.commandOrder=="number"?String(i.commandOrder):""),fe(!!i.isUnitAdmin),ne(!!i.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{p(u=>u.filter(O=>O.id!==i.id));try{localStorage.removeItem(`fs/users/${i.id}.json`)}catch(u){console.error("Failed to remove user from localStorage",u)}},children:"Delete"})]})})]},i.id)),pt.length===0&&!We&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:Ye?"Failed to load users - check console for details":t===0?"No users found in database":M?"No users match your search":"No users in this unit"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:k,type:"text",placeholder:"Filter users...",value:M,onChange:i=>G(i.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var i;return(i=k.current)==null?void 0:i.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:Ot,children:"Export All"})]})]}),H&&e.jsx(Oa,{user:H,onClose:()=>te(null)}),j&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>X(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>X(null),children:"âœ•"})]}),qe==="profile"&&s&&j&&s.edipi===j.edipi&&e.jsx(Is,{mode:"edit",initial:j,readOnly:!1,onSaved:i=>{p(u=>u.map(O=>O.edipi===i.edipi?i:O)),X(null),W({type:"success",message:"Profile updated."})}}),qe==="admin"&&((s==null?void 0:s.isUnitAdmin)||(s==null?void 0:s.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:de,onChange:i=>{const u=i.target.value;R(u),u==="COMMANDER"?(De(void 0),ve(void 0),Oe(void 0),_e(void 0)):u==="COMPANY_REVIEWER"?_e(void 0):u==="MEMBER"&&(Oe(void 0),_e(void 0))},className:"w-full px-3 py-2 border rounded",children:$a.map(i=>e.jsx("option",{value:i,children:i},i))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:be||"",onChange:i=>Oe(i.target.value||void 0),disabled:!de.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Se.length?"Select company":"No companies configured"}),Se.map(i=>e.jsx("option",{value:i,children:i},i))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:Fe||"",onChange:i=>_e(i.target.value||void 0),disabled:!de.includes("REVIEW")||!be,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:vt.length?"Select platoon":"No platoons configured"}),vt.map(i=>e.jsx("option",{value:i,children:i},i))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:F,onChange:i=>fe(i.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:Ie,disabled:de==="COMMANDER",onChange:async i=>{const u=i.target.checked;ne(u);try{if(j&&!(await at({id:j.id,email:j.email,rank:j.rank,firstName:j.firstName,lastName:j.lastName,mi:j.mi,service:j.service,role:j.role,unitUic:j.unitUic,unit:j.unit,company:j.company,isUnitAdmin:!!j.isUnitAdmin,isCommandStaff:u,edipi:j.edipi,passwordHash:j.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})]}),U.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:U.map((i,u)=>e.jsx("div",{className:"text-sm",children:i},u))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{X(null),l.current=!1,g([]),ae(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${N?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":N,disabled:N,onClick:async()=>{var re;if(!j)return;const i=[];if(de==="COMPANY_REVIEWER"&&!ye&&i.push("Company is required for Company Reviewer."),de==="PLATOON_REVIEWER"&&(!ye||!Ee)&&i.push("Company and Platoon are required for Platoon Reviewer."),g(i),i.length)return;ae(!0);const u=((re=st.find(je=>je.uic===j.unitUic))==null?void 0:re.unitName)||"N/A",O={...j,role:de,isUnitAdmin:F,isCommandStaff:de==="COMMANDER"?!1:Ie,company:Le||"N/A",unit:u,platoon:Ae||"N/A",roleCompany:de.includes("REVIEW")?be||"N/A":void 0,rolePlatoon:de==="PLATOON_REVIEWER"?Fe||"N/A":void 0};try{localStorage.setItem(`fs/users/${O.edipi}.json`,JSON.stringify(O))}catch{}try{if(!(await at({id:O.id,email:O.email,rank:O.rank,firstName:O.firstName,lastName:O.lastName,mi:O.mi,service:O.service,role:O.role,unitUic:O.unitUic,unit:O.unit,company:O.company,isUnitAdmin:!!O.isUnitAdmin,isCommandStaff:!!O.isCommandStaff,edipi:O.edipi,passwordHash:O.passwordHash,roleCompany:O.roleCompany,rolePlatoon:O.rolePlatoon,platoon:O.platoon})).ok)throw new Error("persist_failed")}catch{ae(!1),W({type:"error",message:"Failed to save administrative changes."});return}p(je=>je.map(Re=>Re.edipi===O.edipi?O:Re));try{s&&s.edipi===O.edipi&&(localStorage.setItem("currentUser",JSON.stringify(O)),r(O))}catch{}X(null),l.current=!1,ae(!1),W({type:"success",message:"Administrative changes saved."})},children:[N&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),P&&e.jsx("div",{className:`p-3 rounded-lg border ${P.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:P.message})]})};function Fa(){const[s,r]=n.useState([]),[o,f]=n.useState(null),[d,D]=n.useState({}),[I,A]=n.useState({}),[$,L]=n.useState([]),[q,se]=n.useState("unit"),[E,K]=n.useState("assigned"),[z,T]=n.useState([]),[m,ie]=n.useState(""),[B,_]=n.useState([]),[Q,v]=n.useState(""),Y=()=>{xt().then(g=>r(g)).catch(()=>r([]))},p=()=>{yt().then(g=>L(g)).catch(()=>L([]))},P=()=>{f(null),Y(),p()};n.useEffect(()=>{P(),ks().then(g=>T(g)),Ns().then(g=>_(g))},[q,E]);const W=n.useMemo(()=>{const g={};for(const N of s)N.isUnitAdmin&&N.unitUic&&(g[N.unitUic]=N);return g},[s]),M=n.useMemo(()=>{const g=new Set;return st.filter(N=>g.has(N.uic)?!1:(g.add(N.uic),!0))},[]),G=n.useMemo(()=>{const g={};for(const N of s)if(N.isInstallationAdmin&&N.installationId){const ae=N.installationId;g[ae]=g[ae]||[],g[ae].push(N)}return g},[s]),k=g=>s.filter(N=>N.unitUic===g.uic||!N.unitUic&&N.unit===g.unitName),j=async g=>{const N=d[g.uic];if(!N)return;const ae=s.find(fe=>fe.id===N);if(!ae)return;const F={...ae,isUnitAdmin:!0,unitUic:g.uic,unit:g.unitName,company:"N/A"};try{if(!(await at({id:F.id,email:F.email,rank:F.rank,firstName:F.firstName,lastName:F.lastName,mi:F.mi,service:F.service,role:F.role,unitUic:F.unitUic,unit:F.unit,company:F.company,isUnitAdmin:!!F.isUnitAdmin,isInstallationAdmin:!!F.isInstallationAdmin,isCommandStaff:!!F.isCommandStaff,edipi:F.edipi})).ok){f({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}r(fe=>fe.map(Ie=>Ie.id===F.id?F:Ie)),f({type:"success",message:`Assigned ${F.rank} ${F.lastName} as admin for ${g.unitName}.`})},X=n.useMemo(()=>M.filter(g=>!!W[g.uic]),[M,W]);n.useMemo(()=>(Array.isArray(s)?s:[]).filter(g=>!!g.isHqmcAdmin),[s]);const H=n.useMemo(()=>M.filter(g=>!W[g.uic]),[M,W]),te=n.useMemo(()=>(Array.isArray(z)?z:[]).filter(g=>{var N;return(N=G[g.id])==null?void 0:N.length}),[z,G]),de=n.useMemo(()=>(Array.isArray(z)?z:[]).filter(g=>{var N;return!((N=G[g.id])!=null&&N.length)}),[z,G]),R=n.useMemo(()=>{const g={};for(const N of Array.isArray(s)?s:[])if(N.isHqmcAdmin&&N.hqmcDivision){const ae=N.hqmcDivision;g[ae]=g[ae]||[],g[ae].push(N)}return g},[s]),ye=n.useMemo(()=>(Array.isArray(B)?B:[]).filter(g=>{var N;return(N=R[g.code])==null?void 0:N.length}),[B,R]);n.useMemo(()=>{const g=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return(Array.isArray($)?$:[]).filter(N=>g.includes(String(N.currentStage||"")))},[$]);const[De,Ee]=n.useState(1),[ve,Le]=n.useState(10),pe=X.length,Ae=Math.max(1,Math.ceil(pe/(ve||1))),xe=Math.min(De,Ae),be=pe===0?0:(xe-1)*ve+1,Oe=pe===0?0:Math.min(be+ve-1,pe),Fe=X.slice((xe-1)*ve,(xe-1)*ve+ve),[_e,Te]=n.useState(1),[we,Ve]=n.useState(10),ke=H.length,Ce=Math.max(1,Math.ceil(ke/(we||1))),h=Math.min(_e,Ce),C=ke===0?0:(h-1)*we+1,J=ke===0?0:Math.min(C+we-1,ke),U=H.slice((h-1)*we,(h-1)*we+we);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${q==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{se("unit"),K("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${q==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{se("installation"),K("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${q==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{se("hqmc"),K("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${E==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>K("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${E==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>K("missing"),children:"Missing"})]}),q==="installation"&&E==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[te.map(g=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:g.name}),e.jsx("td",{className:"py-2 px-3",children:(G[g.id]||[]).map(N=>`${N.rank} ${N.lastName}, ${N.firstName}${N.mi?` ${N.mi}`:""}`).join(" â€¢ ")})]},g.id)),te.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),q==="installation"&&E==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[de.map(g=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:g.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:I[g.id]||"",onChange:N=>A(ae=>({...ae,[g.id]:N.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),s.map(N=>e.jsx("option",{value:N.id,children:`${N.rank} ${N.lastName}, ${N.firstName}${N.mi?` ${N.mi}`:""}`},N.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!I[g.id],onClick:async()=>{const N=I[g.id],ae=s.find(fe=>fe.id===N);if(!ae)return;const F={...ae,isInstallationAdmin:!0,installationId:g.id};try{if(!(await at({id:F.id,email:F.email,rank:F.rank,firstName:F.firstName,lastName:F.lastName,mi:F.mi,service:F.service,role:F.role,unitUic:F.unitUic,unit:F.unit,company:F.company,isUnitAdmin:!!F.isUnitAdmin,isInstallationAdmin:!!F.isInstallationAdmin,isCommandStaff:!!F.isCommandStaff,edipi:F.edipi,installationId:F.installationId})).ok){f({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}r(fe=>fe.map(Ie=>Ie.id===F.id?F:Ie)),f({type:"success",message:`Assigned ${F.rank} ${F.lastName} as installation admin.`})},children:"Assign"})})]},g.id)),de.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),q==="unit"&&E==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[Fe.map(g=>{const N=W[g.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:g.unitName}),e.jsx("td",{className:"py-2 px-3",children:g.uic}),e.jsx("td",{className:"py-2 px-3",children:`${N.rank} ${N.lastName}, ${N.firstName}${N.mi?` ${N.mi}`:""}`})]},g.uic)}),X.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(qt,{currentPage:xe,totalPages:Ae,totalItems:pe,pageSize:ve,startIndex:be,endIndex:Oe,onPageChange:g=>Ee(g),onPageSizeChange:g=>{Le(g),Ee(1)},onNext:()=>Ee(Math.min(xe+1,Ae)),onPrevious:()=>Ee(Math.max(xe-1,1)),onFirst:()=>Ee(1),onLast:()=>Ee(Ae),canGoNext:xe<Ae,canGoPrevious:xe>1,pageSizeOptions:[5,10,25,50]})})]}),q==="unit"&&E==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[U.map(g=>{const N=k(g);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:g.unitName}),e.jsx("td",{className:"py-2 px-3",children:g.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:d[g.uic]||"",onChange:ae=>D(F=>({...F,[g.uic]:ae.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:N.length?"Select user":"No eligible users"}),N.map(ae=>e.jsx("option",{value:ae.id,children:`${ae.rank} ${ae.lastName}, ${ae.firstName}${ae.mi?` ${ae.mi}`:""}`},ae.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!d[g.uic],onClick:()=>j(g),children:"Assign"})})]},g.uic)}),H.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(qt,{currentPage:h,totalPages:Ce,totalItems:ke,pageSize:we,startIndex:C,endIndex:J,onPageChange:g=>Te(g),onPageSizeChange:g=>{Ve(g),Te(1)},onNext:()=>Te(Math.min(h+1,Ce)),onPrevious:()=>Te(Math.max(h-1,1)),onFirst:()=>Te(1),onLast:()=>Te(Ce),canGoNext:h<Ce,canGoPrevious:h>1,pageSizeOptions:[5,10,25,50]})})]}),q==="hqmc"&&E==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[ye.map(g=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[g.code," â€” ",g.name]}),e.jsx("td",{className:"py-2 px-3",children:(R[g.code]||[]).map(N=>`${N.rank} ${N.lastName}, ${N.firstName}${N.mi?` ${N.mi}`:""}`).join(" â€¢ ")})]},g.code)),ye.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),q==="hqmc"&&E==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[B.filter(g=>{var N;return!((N=R[g.code])!=null&&N.length)}).map(g=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[g.code," â€” ",g.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:I[`hqmc_${g.code}`]||"",onChange:N=>A(ae=>({...ae,[`hqmc_${g.code}`]:N.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),s.map(N=>e.jsx("option",{value:N.id,children:`${N.rank} ${N.lastName}, ${N.firstName}${N.mi?` ${N.mi}`:""}`},N.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!I[`hqmc_${g.code}`],onClick:async()=>{const N=I[`hqmc_${g.code}`],ae=s.find(fe=>fe.id===N);if(!ae)return;const F={...ae,isHqmcAdmin:!0,hqmcDivision:g.code};try{if(!(await at({id:F.id,email:F.email,rank:F.rank,firstName:F.firstName,lastName:F.lastName,mi:F.mi,service:F.service,role:F.role,unitUic:F.unitUic,unit:F.unit,company:F.company,isUnitAdmin:!!F.isUnitAdmin,isInstallationAdmin:!!F.isInstallationAdmin,isCommandStaff:!!F.isCommandStaff,isHqmcAdmin:!!F.isHqmcAdmin,hqmcDivision:F.hqmcDivision,edipi:F.edipi})).ok){f({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}r(fe=>fe.map(Ie=>Ie.id===F.id?F:Ie)),f({type:"success",message:`Assigned ${F.rank} ${F.lastName} as HQMC admin for ${g.code}.`})},children:"Assign"})})]},g.code)),B.filter(g=>{var N;return!((N=R[g.code])!=null&&N.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),o&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${o.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:o.message})]})})}const os=!0,Ta=({onLoggedIn:s,onCreateAccount:r})=>{const[o,f]=n.useState(""),[d,D]=n.useState(""),[I,A]=n.useState(null),[$,L]=n.useState(!0),[q,se]=n.useState(!0);Ts.useEffect(()=>{},[]);const E=async K=>{K.preventDefault(),A(null);try{const z=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,T=/^[0-9]{10}$/.test(o),m=os?z.test(o.trim().toLowerCase())||T:z.test(o.trim().toLowerCase()),ie=d.length>=6;if(L(m),se(ie),!m){A({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!ie){A({type:"error",message:"Password must be at least 6 characters."});return}let B=null,_=null,Q=o.trim().toLowerCase();if(os&&T){const{user:G,error:k}=await Bt(String(o));B=G,_=k,Q=String((B==null?void 0:B.email)||"")}else if(z.test(Q)){const{user:G,error:k}=await Kt(Q);B=G,_=k}else{A({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(_){A({type:"error",message:`Database Error: ${_}`});return}if(!B||!Q){A({type:"error",message:"Account not found."});return}const v=String(B.passwordHash||B.password_hash||"").trim();if(!v){A({type:"error",message:"No password set for this user."});return}const Y=await Ht(d);if(!(/^[0-9a-f]{64}$/i.test(v)?v.toLowerCase()===Y.toLowerCase():v===d)){A({type:"error",message:"Invalid credentials."});return}const{user:W,error:M}=await Kt(Q);if(M){A({type:"error",message:`Profile Error: ${M}`});return}if(!W){console.error("[Login] User profile not found after successful password verification",{emailForLogin:Q}),A({type:"error",message:"User profile not found."});return}A({type:"success",message:"Logged in."}),s(W)}catch(z){console.error("[Login] Login failed:",z),A({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:E,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:o,onChange:K=>f(K.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${$?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!$}),!$&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:d,onChange:K=>D(K.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${q?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!q}),!q&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),I&&e.jsx("div",{className:`p-3 rounded-lg border ${I.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:I.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:r,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!$||!q,children:"Login"})]})]})]})},ls=""+new URL("logo-DLcHofKE.png",import.meta.url).href,Ba=({currentUser:s,hasSectionDashboard:r,hasCommandDashboard:o,hasInstallationSectionDashboard:f=!1,hasInstallationCommandDashboard:d=!1,hasHQMCSectionDashboard:D=!1,hasHQMCApproverDashboard:I=!1,onManageProfile:A,onLogout:$,onNavigate:L,isLogin:q=!1})=>{const[se,E]=n.useState(!1),[K,z]=n.useState(!1),T=n.useRef(null);return n.useEffect(()=>{const m=B=>{if(!se)return;const _=T.current;_&&B.target&&!_.contains(B.target)&&E(!1)},ie=B=>{B.key==="Escape"&&E(!1)};return document.addEventListener("mousedown",m),document.addEventListener("touchstart",m,{passive:!0}),document.addEventListener("keydown",ie),()=>{document.removeEventListener("mousedown",m),document.removeEventListener("touchstart",m),document.removeEventListener("keydown",ie)}},[se]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:q?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:ls,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:ls,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",target:"_blank",rel:"noopener noreferrer",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:s?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[s.rank," ",s.lastName,s.lastName?",":""," ",s.firstName,s.mi?` ${s.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[s.service," â€¢ ",s.role,(()=>{const m={PLATOON_REVIEWER:s.role_platoon,COMPANY_REVIEWER:s.role_company}[s.role];return m?` - ${m}`:null})()]}),(()=>{var Q;const m=((Q=st.find(v=>v.uic===((s==null?void 0:s.unitUic)||"")))==null?void 0:Q.unitName)||(s==null?void 0:s.unit)||"",ie=s!=null&&s.company&&s.company!=="N/A"?s.company:s!=null&&s.user_company&&s.user_company!=="N/A"?s.user_company:null,B=s!=null&&s.platoon&&s.platoon!=="N/A"?s.platoon:s!=null&&s.user_platoon&&s.user_platoon!=="N/A"?s.user_platoon:null,_=[m||null,ie,B].filter(Boolean);return _.length?e.jsx("div",{className:"text-xs text-white/70",children:_.join(" â€¢ ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(s.lastName||"").charAt(0)}${(s.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:A,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:$,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),s&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>z(!K),children:`${(s.lastName||"").charAt(0)}${(s.firstName||"").charAt(0)}`.toUpperCase()}),K&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{A(),z(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{$(),z(!1)},children:"Logout"})]})]}),!s&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>L("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:T,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":se,onClick:()=>E(m=>!m),children:"Dashboards"}),e.jsxs("div",{className:`${se?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:s&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("dashboard"),E(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(s==null?void 0:s.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("admin"),E(!1)},children:"Unit Admin"}),s&&!!s.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("appadmin"),E(!1)},children:"App Admin"}),s&&!!s.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("hqmc-admin"),E(!1)},children:"HQMC Admin"}),s&&!!s.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("installation"),E(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[s&&r&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("section"),E(!1)},children:"Unit Section Dashboard"}),o&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("command"),E(!1)},children:"Unit Command Dashboard"}),String((s==null?void 0:s.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("review"),E(!1)},children:"Unit Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[s&&f&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("installation-section"),E(!1)},children:"Installation Section Dashboard"}),s&&d&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("installation-command"),E(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[s&&(D||!!s.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("hqmc-section"),E(!1)},children:"HQMC Section Dashboard"}),s&&I&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("hqmc-approver"),E(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})},Ge={SECTION:"perm_section",COMMAND:"perm_command",INST_SECTION:"perm_inst_section",INST_COMMAND:"perm_inst_command",HQMC_SECTION:"perm_hqmc_section",HQMC_APPROVER:"perm_hqmc_approver"},mt=s=>{try{return localStorage.getItem(s)==="true"}catch(r){return console.error(`Failed to read from localStorage for key "${s}":`,r),!1}};function Va(){const[s,r]=n.useState(null),[o,f]=n.useState("login"),[d,D]=n.useState(()=>{try{const p=localStorage.getItem("currentUser");return p?JSON.parse(p):null}catch(p){return console.error("Failed to parse user from localStorage:",p),null}}),[I,A]=n.useState("create"),[$,L]=n.useState(!1),[q,se]=n.useState(()=>mt(Ge.SECTION)),[E,K]=n.useState(()=>mt(Ge.COMMAND)),[z,T]=n.useState(()=>mt(Ge.INST_SECTION)),[m,ie]=n.useState(()=>mt(Ge.INST_COMMAND)),[B,_]=n.useState(()=>mt(Ge.HQMC_SECTION)),[Q,v]=n.useState(()=>mt(Ge.HQMC_APPROVER)),Y=Bs();return n.useEffect(()=>{try{const P=new URLSearchParams(window.location.search).get("view");if(P==="admin"||P==="profile"||P==="dashboard"||P==="login"||P==="appadmin"||P==="hqmc-admin"||P==="hqmc-section"||P==="hqmc-approver"||P==="review"||P==="section"||P==="command"||P==="installation"||P==="installation-section"||P==="installation-command"||P==="documents"||P==="document-viewer"||P==="upload")f(P);else{const W=localStorage.getItem("currentView"),M=localStorage.getItem("currentUser");f(W&&M?W:"login")}}catch{f("login")}},[]),n.useEffect(()=>{d?localStorage.setItem("currentUser",JSON.stringify(d)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"),Object.values(Ge).forEach(p=>{try{localStorage.removeItem(p)}catch(P){console.error(`Failed to remove item from localStorage for key "${p}":`,P)}}))},[d]),n.useEffect(()=>{if(!d)return;const p={[Ge.SECTION]:q,[Ge.COMMAND]:E,[Ge.INST_SECTION]:z,[Ge.INST_COMMAND]:m,[Ge.HQMC_SECTION]:B,[Ge.HQMC_APPROVER]:Q};for(const[P,W]of Object.entries(p))try{localStorage.setItem(P,String(W))}catch(M){console.error(`Failed to set item in localStorage for key "${P}":`,M)}},[d,q,E,z,m,B,Q]),n.useEffect(()=>{let p=!1;return(async()=>{try{const P=(d==null?void 0:d.id)||"";if(!P)return;const W=await Cs(P);if(W&&!p){const M=(j,X)=>j===!0||j===!1?j:X||!1,G=(j,X)=>j!=null?j||void 0:X,k={...W,isAppAdmin:M(W.isAppAdmin,d==null?void 0:d.isAppAdmin),isUnitAdmin:M(W.isUnitAdmin,d==null?void 0:d.isUnitAdmin),isInstallationAdmin:M(W.isInstallationAdmin,d==null?void 0:d.isInstallationAdmin),isHqmcAdmin:M(W.isHqmcAdmin,d==null?void 0:d.isHqmcAdmin),isCommandStaff:M(W.isCommandStaff,d==null?void 0:d.isCommandStaff),installationId:G(W.installationId,d==null?void 0:d.installationId),hqmcDivision:G(W.hqmcDivision,d==null?void 0:d.hqmcDivision)};D(k),localStorage.setItem("currentUser",JSON.stringify(k))}}catch{}})(),()=>{p=!0}},[]),n.useEffect(()=>{o!=="login"&&d&&localStorage.setItem("currentView",o)},[o,d]),n.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const P=await At();localStorage.setItem("unit_structure",JSON.stringify(P))}catch(p){console.error("Failed to load unit structure:",p)}})()},[]),n.useEffect(()=>{var p,P,W;if(d){try{const M=localStorage.getItem("unit_structure");if(M){const G=JSON.parse(M),k=(d==null?void 0:d.unitUic)||"",j=d!=null&&d.company&&d.company!=="N/A"?d.company:"",X=d!=null&&d.platoon&&d.platoon!=="N/A"?d.platoon:"",H=((W=(P=(p=G==null?void 0:G[k])==null?void 0:p._platoonSectionMap)==null?void 0:P[j])==null?void 0:W[X])||"";se(!!H)}}catch(M){console.error("Failed to parse unit structure for section dashboard check",M)}K(!!(d!=null&&d.isCommandStaff)),(async()=>{try{const M=(d==null?void 0:d.installationId)||"";if(!M){T(!1),ie(!1);return}const G=await ks();try{localStorage.setItem("installations_cache",JSON.stringify(G))}catch{}const k=G==null?void 0:G.find(te=>te.id===M),j=(d==null?void 0:d.id)||"",X=!!(k&&k.sectionAssignments&&Object.values(k.sectionAssignments).some(te=>Array.isArray(te)&&te.includes(j))),H=!!(k&&(k.commandSectionAssignments&&Object.values(k.commandSectionAssignments).some(te=>Array.isArray(te)&&te.includes(j))||k.commanderUserId&&String(k.commanderUserId)===j));T(X),ie(H)}catch{}})(),(async()=>{try{const M=String((d==null?void 0:d.hqmcDivision)||""),G=String((d==null?void 0:d.id)||"");if(!M||!G){_(!!(d!=null&&d.isHqmcAdmin)),v(!1);return}const{listHQMCSectionAssignmentsLegacy:k}=await Vs(async()=>{const{listHQMCSectionAssignmentsLegacy:te}=await import("./db-txr9OHg1.js").then(de=>de.C);return{listHQMCSectionAssignmentsLegacy:te}},__vite__mapDeps([0,1,2]),import.meta.url),j=await k(),X=j.some(te=>te.division_code===M&&((te.reviewers||[]).includes(G)||(te.approvers||[]).includes(G))),H=j.some(te=>te.division_code===M&&(te.approvers||[]).includes(G));_(X||!!(d!=null&&d.isHqmcAdmin)),v(H)}catch{d!=null&&d.isHqmcAdmin&&_(!0)}})()}},[d]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(Ba,{currentUser:d,hasSectionDashboard:q,hasCommandDashboard:E,hasInstallationSectionDashboard:z,hasInstallationCommandDashboard:m,hasHQMCSectionDashboard:B,hasHQMCApproverDashboard:Q,onManageProfile:()=>{A("edit"),f("profile"),Y("/?view=profile")},onLogout:()=>{D(null),f("login"),Y("/?view=login")},onNavigate:p=>{f(p),Y(`/?view=${p}`)},isLogin:o==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:o==="profile"?e.jsx(Is,{mode:I,initial:I==="edit"?d||{}:{},onSaved:p=>{D(p),f("dashboard"),Y("/?view=dashboard")}}):o==="admin"?e.jsx(_a,{}):o==="appadmin"?e.jsx(Fa,{}):o==="login"?e.jsx(Ta,{onLoggedIn:p=>{D(p),f("dashboard"),Y("/?view=dashboard")},onCreateAccount:()=>{A("create"),f("profile"),Y("/?view=profile")}}):o==="review"?e.jsx(Ea,{}):o==="section"?e.jsx(ta,{}):o==="command"?e.jsx(sa,{}):o==="installation"?e.jsx(Qs,{}):o==="hqmc-admin"?e.jsx(Ra,{}):o==="installation-section"?e.jsx(aa,{}):o==="installation-command"?e.jsx(na,{}):o==="hqmc-section"?e.jsx(Ia,{}):o==="hqmc-approver"?e.jsx(Ma,{}):e.jsx(ja,{selectedUnit:s,currentUser:d})})]})}function tn(){return e.jsx(Va,{})}export{tn as default};
