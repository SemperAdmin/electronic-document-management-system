const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-B5DdF8Od.js","./index-pRRv2PjL.js","./index-D9SBkJLS.css"])))=>i.map(i=>d[i]);
import{r as a,j as e,c as ls,f as ds,a as ms,s as Kt,S as Tt,v as us,l as At,M as qt,b as xs,u as ps,R as hs,d as gs,_ as bs}from"./index-pRRv2PjL.js";import{s as Ie,d as fs,a as ys,b as vs,l as $t,c as gt,e as at,u as _e,f as Et,g as bt,h as Ge,i as Ns,j as js,k as Xt,m as Zt,n as Ot,o as ws,p as es,q as Rt,r as Ss,t as ts,v as ss,w as It,x as as,y as Ft}from"./db-B5DdF8Od.js";import{P as Mt,I as Cs}from"./InstallationAdmin-DTIx-_kG.js";import{f as ns,R as Je,S as Ye,o as Bt,c as As,a as ks}from"./RequestTable-DTF4cDMO.js";import{c as Es,F as Rs,D as rs,a as tt}from"./DocumentListItem-CnVhPFrl.js";import{l as ft}from"./unitStructure-QC5qYuxv.js";import Is from"./SectionDashboard-BNkMQWxC.js";import Ms from"./CommandDashboard-E0GziBH7.js";import Ds from"./InstallationSectionDashboard-BMTjc7ki.js";import Ps from"./InstallationCommandDashboard-B-PiJMXz.js";import{U as Be}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-D0JKW8U1.js";import"./utils-CLmukD0c.js";const $s={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},Os=({filters:t,onFiltersChange:n,statusOptions:o=[],originatorOptions:N=[],searchPlaceholder:m="Search requests...",showAdvanced:E=!0,className:R=""})=>{var U;const[C,D]=a.useState(!1),L=a.useRef(null),F=a.useMemo(()=>Array.isArray(t.status)?t.status:[],[t.status]),Z=a.useMemo(()=>{let f=0;return F.length>0&&f++,t.dateFrom&&f++,t.dateTo&&f++,t.originatorId&&f++,f},[F,t.dateFrom,t.dateTo,t.originatorId]),w=a.useCallback(f=>{n({...t,search:f.target.value})},[t,n]),J=a.useCallback(f=>{const V=F.includes(f)?F.filter(h=>h!==f):[...F,f];n({...t,status:V})},[t,F,n]),z=a.useCallback(f=>{n({...t,dateFrom:f.target.value})},[t,n]),B=a.useCallback(f=>{n({...t,dateTo:f.target.value})},[t,n]),d=a.useCallback(f=>{n({...t,originatorId:f.target.value})},[t,n]),te=a.useCallback(()=>{var f;n($s),(f=L.current)==null||f.focus()},[n]),O=a.useCallback(()=>{var f;n({...t,search:""}),(f=L.current)==null||f.focus()},[t,n]);a.useEffect(()=>{const f=V=>{var h;(V.metaKey||V.ctrlKey)&&V.key==="k"&&(V.preventDefault(),(h=L.current)==null||h.focus())};return document.addEventListener("keydown",f),()=>document.removeEventListener("keydown",f)},[]);const P=t.search||Z>0;return e.jsxs("div",{className:`space-y-3 ${R}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{ref:L,type:"text",value:t.search,onChange:w,placeholder:m,className:"block w-full pl-10 pr-10 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold bg-[var(--surface)] text-[var(--text)]","aria-label":"Search"}),t.search&&e.jsx("button",{onClick:O,className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600","aria-label":"Clear search",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute inset-y-0 right-8 flex items-center pointer-events-none text-xs text-gray-400",children:e.jsx("kbd",{className:"hidden sm:inline-block px-1.5 py-0.5 bg-gray-100 rounded border border-gray-200 font-mono",children:"âŒ˜K"})})]}),E&&e.jsxs("button",{onClick:()=>D(!C),className:`
              flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors
              ${C||Z>0?"bg-brand-gold/10 border-brand-gold text-brand-navy":"border-brand-navy/30 text-[var(--text)] hover:bg-brand-cream/50"}
            `,"aria-expanded":C,"aria-controls":"filter-panel",children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"})}),e.jsx("span",{className:"hidden sm:inline",children:"Filters"}),Z>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-brand-navy rounded-full",children:Z})]}),P&&e.jsxs("button",{onClick:te,className:"flex items-center gap-1 px-3 py-2 text-sm text-brand-red hover:text-brand-red-2 hover:bg-red-50 rounded-lg transition-colors","aria-label":"Clear all filters",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),E&&C&&e.jsxs("div",{id:"filter-panel",className:"p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[o.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Status"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:o.map(f=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-white/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:F.includes(f.value),onChange:()=>J(f.value),className:"h-4 w-4 text-brand-navy border-gray-300 rounded focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-[var(--text)]",children:f.label})]},f.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Date Range"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"From date"}),e.jsx("input",{type:"date",value:t.dateFrom,onChange:z,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"From date"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"To date"}),e.jsx("input",{type:"date",value:t.dateTo,onChange:B,min:t.dateFrom,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"To date"})]})]})]}),N.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Originator"}),e.jsxs("select",{value:t.originatorId,onChange:d,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"Filter by originator",children:[e.jsx("option",{value:"",children:"All originators"}),N.map(f=>e.jsx("option",{value:f.value,children:f.label},f.value))]})]})]}),Z>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 pt-2 border-t border-brand-navy/10",children:[e.jsx("span",{className:"text-sm text-[var(--muted)]",children:"Active filters:"}),F.map(f=>{const V=o.find(h=>h.value===f);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[(V==null?void 0:V.label)||f,e.jsx("button",{onClick:()=>J(f),className:"hover:text-brand-red","aria-label":`Remove ${(V==null?void 0:V.label)||f} filter`,children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},f)}),t.dateFrom&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["From: ",t.dateFrom,e.jsx("button",{onClick:()=>n({...t,dateFrom:""}),className:"hover:text-brand-red","aria-label":"Remove from date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.dateTo&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["To: ",t.dateTo,e.jsx("button",{onClick:()=>n({...t,dateTo:""}),className:"hover:text-brand-red","aria-label":"Remove to date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.originatorId&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[((U=N.find(f=>f.value===t.originatorId))==null?void 0:U.label)||"Originator",e.jsx("button",{onClick:()=>n({...t,originatorId:""}),className:"hover:text-brand-red","aria-label":"Remove originator filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]})]})};function _s(t,n){return a.useMemo(()=>{let o=Array.isArray(n.items)?n.items:[];const N=Array.isArray(t.status)?t.status:[];if(t.search){const m=t.search.toLowerCase();o=o.filter(E=>n.getSearchText(E).toLowerCase().includes(m))}return N.length>0&&n.getStatus&&(o=o.filter(m=>N.includes(n.getStatus(m)))),(t.dateFrom||t.dateTo)&&n.getDate&&(o=o.filter(m=>{const E=n.getDate(m);if(!E)return!1;const R=new Date(E);if(isNaN(R.getTime()))return!1;if(t.dateFrom){const C=new Date(t.dateFrom);if(R<C)return!1}if(t.dateTo){const C=new Date(t.dateTo);if(C.setHours(23,59,59,999),R>C)return!1}return!0})),t.originatorId&&n.getOriginatorId&&(o=o.filter(m=>n.getOriginatorId(m)===t.originatorId)),o},[t,n])}function Vt(t){if(t==null)return"";const n=String(t);return n.includes('"')||n.includes(",")||n.includes(`
`)||n.includes("\r")?`"${n.replace(/"/g,'""')}"`:n}function Ls(t,n){const N=n.map(E=>Vt(E.header)).join(","),m=t.map(E=>n.map(R=>{const C=R.getValue(E),D=R.format?R.format(C):C;return Vt(D)}).join(","));return[N,...m].join(`\r
`)}function Ts(t,n){const o=t.map(N=>{const m={};return n.forEach(E=>{const R=E.getValue(N);m[E.header]=E.format?E.format(R):R}),m});return JSON.stringify(o,null,2)}function Wt(t,n,o){const N=new Blob([t],{type:`${o};charset=utf-8;`}),m=URL.createObjectURL(N),E=document.createElement("a");E.href=m,E.download=n,document.body.appendChild(E),E.click(),document.body.removeChild(E),URL.revokeObjectURL(m)}function qs({items:t,columns:n,filename:o="export",label:N="Export",variant:m="secondary",className:E="",disabled:R=!1,showCount:C=!0,formats:D=["csv"]}){const[L,F]=a.useState(!1),[Z,w]=a.useState(!1),J=a.useRef(null),z=a.useCallback(te=>{w(!0),F(!1),setTimeout(()=>{try{const O=new Date().toISOString().slice(0,10),P=`${o}_${O}`;if(te==="csv"){const U=Ls(t,n);Wt(U,`${P}.csv`,"text/csv")}else{const U=Ts(t,n);Wt(U,`${P}.json`,"application/json")}}catch(O){console.error("Export failed:",O)}finally{w(!1)}},100)},[t,n,o]);a.useEffect(()=>{const te=O=>{J.current&&!J.current.contains(O.target)&&F(!1)};return L&&document.addEventListener("mousedown",te),()=>{document.removeEventListener("mousedown",te)}},[L]),a.useEffect(()=>{const te=O=>{O.key==="Escape"&&F(!1)};return L&&document.addEventListener("keydown",te),()=>{document.removeEventListener("keydown",te)}},[L]);const B={primary:"bg-brand-navy text-brand-cream hover:bg-brand-navy/90",secondary:"bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold/10",text:"text-brand-navy hover:bg-brand-cream/50"},d=R||t.length===0||Z;return D.length===1?e.jsxs("button",{onClick:()=>z(D[0]),disabled:d,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${B[m]}
          ${E}
        `,children:[Z?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:N}),C&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]})]}):e.jsxs("div",{className:"relative",ref:J,children:[e.jsxs("button",{onClick:()=>F(!L),disabled:d,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${B[m]}
          ${E}
        `,"aria-expanded":L,"aria-haspopup":"menu",children:[Z?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:N}),C&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${L?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),L&&e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-[var(--surface)] border border-brand-navy/20 rounded-lg shadow-lg z-50",role:"menu",children:[D.includes("csv")&&e.jsxs("button",{onClick:()=>z("csv"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 first:rounded-t-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export as CSV"]}),D.includes("json")&&e.jsxs("button",{onClick:()=>z("json"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 last:rounded-b-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})}),"Export as JSON"]})]})]})}const Ht=t=>{if(!t)return"";const n=new Date(t);return isNaN(n.getTime())?"":n.toLocaleDateString()},Fs=({request:t})=>{if(!t.ssic)return e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg text-center",children:[e.jsx("div",{className:"text-[var(--muted)] text-sm",children:"No retention schedule assigned"}),e.jsx("div",{className:"text-xs text-[var(--muted)] mt-1",children:"SSIC classification was not set when this request was created"})]});const n=new Date(t.createdAt),o={ssic:t.ssic,nomenclature:t.ssicNomenclature||"",bucket:t.ssicBucket||"",bucketTitle:t.ssicBucketTitle||"",dau:t.dau||"",isPermanent:t.isPermanent||!1,cutoffTrigger:t.cutoffTrigger||"CALENDAR_YEAR",cutoffDescription:t.cutoffDescription||"",retentionValue:t.retentionValue??null,retentionUnit:t.retentionUnit||"YEARS",disposalAction:t.disposalAction||"DESTROY"},N=ls(o,n),m=t.isPermanent||!1;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:`p-4 rounded-lg ${m?"bg-blue-50 border border-blue-200":"bg-amber-50 border border-amber-200"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`text-2xl ${m?"text-blue-600":"text-amber-600"}`,children:m?"ðŸ“":"â±ï¸"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-semibold text-[var(--text)]",children:[t.ssic," - ",t.ssicNomenclature]}),t.ssicBucketTitle&&e.jsx("div",{className:"text-sm text-[var(--muted)] mt-1",children:t.ssicBucketTitle}),e.jsx("div",{className:`text-xs font-medium uppercase tracking-wide mt-2 ${m?"text-blue-600":"text-amber-600"}`,children:m?"Permanent Record":"Temporary Record"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Retention Period"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:ds(o)})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Cutoff Trigger"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:ms(o.cutoffTrigger)}),t.cutoffDescription&&e.jsx("div",{className:"text-xs text-[var(--muted)] mt-1",children:t.cutoffDescription})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Disposal Action"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:m?"Transfer to National Archives":"Destroy"})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Record Created"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:n.toLocaleDateString()})]})]}),!m&&e.jsxs("div",{className:"p-4 bg-[var(--surface)] rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-2",children:"Estimated Disposal Eligibility"}),N?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-2xl font-bold text-brand-navy",children:N.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}),e.jsx("div",{className:"text-sm text-[var(--muted)]",children:N>new Date?e.jsxs(e.Fragment,{children:["(",Math.ceil((N.getTime()-Date.now())/(1e3*60*60*24))," days remaining)"]}):e.jsx("span",{className:"text-green-600 font-medium",children:"Eligible for disposal"})})]}):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"Unable to calculate - may require event date (case closure, separation, etc.)"})]}),t.dau&&e.jsxs("div",{className:"text-xs text-[var(--muted)] border-t border-brand-navy/10 pt-3",children:[e.jsx("span",{className:"font-medium",children:"Disposition Authority:"})," ",t.dau]})]})};function Dt(t,n={}){const{pageSize:o=25,initialPage:N=1}=n,[m,E]=a.useState(N),[R,C]=a.useState(o),D=t.length,L=Math.ceil(D/R),F=(m-1)*R,Z=Math.min(F+R,D);return{currentData:a.useMemo(()=>t.slice(F,Z),[t,F,Z]),currentPage:m,pageSize:R,totalPages:L,totalItems:D,goToPage:P=>{const U=Math.max(1,Math.min(P,L));E(U)},nextPage:()=>{m<L&&E(m+1)},previousPage:()=>{m>1&&E(m-1)},goToFirstPage:()=>{E(1)},goToLastPage:()=>{E(L)},setPageSize:P=>{C(P),E(1)},canGoNext:m<L,canGoPrevious:m>1,startIndex:F+1,endIndex:Z}}const ot="edms-docs";function Bs(){return{uploadFile:async(E,R)=>{if(!Ie)return{url:"",error:"Supabase not configured"};try{const{error:C}=await Ie.storage.from(ot).upload(R,E,{upsert:!0});if(C)return{url:"",error:C.message};const{data:D}=Ie.storage.from(ot).getPublicUrl(R);return{url:(D==null?void 0:D.publicUrl)||""}}catch(C){return{url:"",error:C instanceof Error?C.message:"Upload failed"}}},deleteFile:async E=>{if(!Ie||!E)return!1;try{return await Ie.storage.from(ot).remove([E]),!0}catch{return!1}},deleteFolder:async E=>{if(!Ie)return!1;try{const{data:R}=await Ie.storage.from(ot).list(E.replace(/\/$/,""));if(R&&R.length>0){const C=R.map(D=>`${E.replace(/\/$/,"")}/${D.name}`);await Ie.storage.from(ot).remove(C)}return!0}catch{return!1}},extractStoragePath:E=>{if(!E)return null;try{const R=E.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(R!=null&&R[1])return decodeURIComponent(R[1])}catch{}return null},buildStoragePath:(E,R,C,D)=>{const L=Date.now();return`${E||"N-A"}/${R}/${L}-${D}-${Kt(C)}`}}}const qe=t=>{const n=String(t||"").trim();return n&&n!=="N/A"?n:""},et=(t,n,o)=>t.some(N=>String(N.role||"")!==n||qe(N.roleCompany||N.company)!==o.company||n==="PLATOON_REVIEWER"&&qe(N.rolePlatoon||N.platoon)!==(o.platoon||"")?!1:String(N.unitUic||"")===String(o.uic||""));function is(t){if(t===0)return"0 Bytes";const n=1024,o=["Bytes","KB","MB","GB"],N=Math.floor(Math.log(t)/Math.log(n));return parseFloat((t/Math.pow(n,N)).toFixed(2))+" "+o[N]}const Ut=a.memo(function({doc:n,onView:o,onDelete:N}){const[m,E]=a.useState(!1),R=n.fileUrl&&Es(n.type,n.name);return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:"flex items-center justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors","aria-label":`Document: ${n.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Rs,{type:n.type,fileName:n.name,size:"md"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-[var(--text)]",children:n.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)]",children:[n.name," â€¢ ",is(n.size)," â€¢ ",new Date(n.uploadedAt).toLocaleDateString()]}),n.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(n.dueDate).toLocaleDateString()]}),n.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Notes: ",n.notes]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",role:"group","aria-label":"Document actions",children:[n.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:ns({currentStage:n.currentStage})}),R&&e.jsx("button",{type:"button",onClick:C=>{C.stopPropagation(),E(!0)},className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Preview document ${n.name}`,children:"Preview"}),n.fileUrl&&e.jsx("a",{href:n.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${n.name} in new tab`,children:"Open"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:C=>{C.stopPropagation(),o(n)},"aria-label":`View or edit document ${n.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:C=>{C.stopPropagation(),N(n)},"aria-label":`Delete document ${n.subject}`,children:"Delete"})]})]}),n.fileUrl&&e.jsx(rs,{url:n.fileUrl,fileName:n.name,mimeType:n.type,fileSize:n.size,isOpen:m,onClose:()=>E(!1)})]})}),Ze="edms-docs",Vs=({selectedUnit:t,currentUser:n})=>{const[o,N]=a.useState([]),[m,E]=a.useState(!1),[R,C]=a.useState(""),[D,L]=a.useState(""),[F,Z]=a.useState(""),[w,J]=a.useState([]),[z,B]=a.useState(null),[d,te]=a.useState(null),[O,P]=a.useState([]),[U,f]=a.useState(!1),[V,h]=a.useState(null),[I,T]=a.useState(""),[k,G]=a.useState(""),[S,y]=a.useState(""),[Q,W]=a.useState([]),[X,re]=a.useState([]),[_,xe]=a.useState(null),[ye,ve]=a.useState(""),[he,Ne]=a.useState(""),[ge,v]=a.useState(""),[M,ae]=a.useState([]),[ce,ie]=a.useState(!1),[Ee,je]=a.useState({}),[be,Pe]=a.useState(""),[we,u]=a.useState("Pending"),[j,ee]=a.useState({}),[ne,de]=a.useState(""),[p,A]=a.useState(null),[i,l]=a.useState("documents"),[q,se]=a.useState(!1),[le,me]=a.useState(null),Re=Bs(),Ae=c=>{const b=c.target.files?Array.from(c.target.files):[];if(b.length===0)return;if(w.length+b.length>qt){B({type:"error",message:`Cannot add ${b.length} file(s). Maximum ${qt} files allowed per request.`});try{c.target.value=""}catch{}return}const s=[],r=[];for(const x of b){const $=xs(x);$.valid?s.push(x):r.push(...$.errors)}s.length>0&&J(x=>[...x,...s]),r.length>0&&B({type:"error",message:r.slice(0,3).join(" ")+(r.length>3?` (+${r.length-3} more errors)`:"")});try{c.target.value=""}catch{}},pe=async()=>{if(!_||!(d!=null&&d.id)||_.uploadedById!==d.id)return;const c={actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,timestamp:new Date().toISOString(),action:"Archived by Originator",comment:(ge||"").trim()},b={..._,currentStage:Ye.ARCHIVED,finalStatus:"Archived",activity:Array.isArray(_.activity)?[..._.activity,c]:[c]};try{const s=await _e(b);if(!s.ok)throw new Error(g(s,"request_upsert_failed"));re(r=>r.map(x=>x.id===b.id?b:x)),xe(b),B({type:"success",message:"Request archived."})}catch(s){B({type:"error",message:`Failed to archive: ${String((s==null?void 0:s.message)||s)}`})}},Me=async()=>{if(!_||!(d!=null&&d.id)||_.uploadedById!==d.id)return;const c=O.find(ue=>ue.id===_.uploadedById),b=_.unitUic||(c==null?void 0:c.unitUic)||"",s=qe(c==null?void 0:c.company),r=qe(c==null?void 0:c.platoon),x=et(O,"PLATOON_REVIEWER",{company:s,platoon:r,uic:b}),$=et(O,"COMPANY_REVIEWER",{company:s,uic:b}),Y=x?Ye.PLATOON_REVIEW:$?Ye.COMPANY_REVIEW:Ye.BATTALION_REVIEW,H={actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,actorRole:"Member",timestamp:new Date().toISOString(),action:"Resubmitted request",comment:(ge||"").trim()},K={..._,currentStage:Y,routeSection:"",activity:[..._.activity||[],H]};try{const ue=await _e(K);if(!ue.ok)throw new Error(g(ue,"request_upsert_failed"));re(ke=>ke.map(Oe=>Oe.id===K.id?K:Oe)),xe(K),v(""),B({type:"success",message:"Request resubmitted for review."})}catch(ue){B({type:"error",message:`Failed to resubmit: ${String((ue==null?void 0:ue.message)||ue)}`})}},Te=async c=>{c.preventDefault(),B(null);const b=R.trim();if(!b){B({type:"error",message:"Subject is required."});return}if(b.length>500){B({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(F.length>5e3){B({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(d!=null&&d.id)){B({type:"error",message:"Create a profile before submitting."});return}if(w.length>0){const ue=us(w);if(!ue.valid){B({type:"error",message:ue.errors[0]});return}}E(!0);const s=Date.now(),r=be||d.id,x=O.find(ue=>ue.id===r),$=t?t.uic:(x==null?void 0:x.unitUic)||"N/A",Y=`req-${s}`;let H=[];async function K(ue,ke){if(!Ie)throw new Error("Supabase not configured");const{error:Oe}=await Ie.storage.from(Ze).upload(ke,ue,{upsert:!0});if(Oe)throw new Error(Oe.message);const{data:Qe}=Ie.storage.from(Ze).getPublicUrl(ke);return(Qe==null?void 0:Qe.publicUrl)||""}if(w&&w.length>0){const ue=[];for(let ke=0;ke<w.length;ke++){const Oe=w[ke],Qe=`${$}/${Y}/${s}-${ke}-${Kt(Oe.name)}`;try{const ze=await K(Oe,Qe);ue.push(ze)}catch(ze){E(!1),B({type:"error",message:`Failed to upload ${Oe.name}: ${String((ze==null?void 0:ze.message)||ze)}`});return}}H=w.map((ke,Oe)=>({id:`${s}-${Oe}`,name:ke.name,type:ke.type,size:ke.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:$,subject:R.trim(),dueDate:D||void 0,notes:F.trim()||void 0,uploadedById:r,currentStage:"PLATOON_REVIEW",fileUrl:ue[Oe]}))}H=H.map(ue=>({...ue,requestId:Y})),N(ue=>[...ue,...H]),J([]),C(""),L(""),Z("");try{const ue=d?`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`:"Unknown",ke="Member",Oe=$,Qe=qe(x==null?void 0:x.company),ze=qe(x==null?void 0:x.platoon),_t=et(O,"PLATOON_REVIEWER",{company:Qe,platoon:ze,uic:Oe}),Lt=et(O,"COMPANY_REVIEWER",{company:Qe,uic:Oe}),cs=!_t&&!Lt,it={id:Y,subject:R.trim(),dueDate:D||void 0,notes:F.trim()||void 0,unitUic:$,uploadedById:r,submitForUserId:r,documentIds:H.map($e=>$e.id),createdAt:new Date().toISOString(),currentStage:_t?Ye.PLATOON_REVIEW:Lt?Ye.COMPANY_REVIEW:Ye.BATTALION_REVIEW,routeSection:cs&&ne?ne:void 0,ssic:p==null?void 0:p.ssic,ssicNomenclature:p==null?void 0:p.nomenclature,ssicBucket:p==null?void 0:p.bucket,ssicBucketTitle:p==null?void 0:p.bucketTitle,isPermanent:p==null?void 0:p.isPermanent,retentionValue:p==null?void 0:p.retentionValue,retentionUnit:p==null?void 0:p.retentionUnit,cutoffTrigger:p==null?void 0:p.cutoffTrigger,cutoffDescription:p==null?void 0:p.cutoffDescription,disposalAction:p==null?void 0:p.disposalAction,dau:p==null?void 0:p.dau,activity:[{actor:ue,actorRole:ke,timestamp:new Date().toISOString(),action:"Submitted request",comment:(F||"").trim()}]};try{const $e=await _e(it);if(!$e.ok)throw new Error(g($e,"request_upsert_failed"));const Ct=await Et(H);if(!Ct.ok)throw new Error(g(Ct,"document_upsert_failed"))}catch($e){E(!1);try{At("request_persist_failed",{requestId:Y,error:String(($e==null?void 0:$e.message)||$e)},"error")}catch{}B({type:"error",message:`Failed to persist submission: ${String(($e==null?void 0:$e.message)||$e)}`});return}re($e=>$e.some(pt=>pt.id===it.id)?$e.map(pt=>pt.id===it.id?it:pt):[...$e,it]),E(!1),B({type:"success",message:"Submission successful."}),f(!1),de(""),A(null)}catch{E(!1);try{At("request_persist_failed",{requestId:Y},"error")}catch{}B({type:"error",message:"Failed to persist submission."})}},Ve=a.useCallback(c=>{h(c),T(c.subject||""),G(c.dueDate||""),y(c.notes||"");try{const b=localStorage.getItem(`fs/requests/${c.requestId}.json`);if(b){const s=JSON.parse(b);W(Array.isArray(s.activity)?s.activity:[])}else{const x=Object.values(Object.assign({})).map($=>($==null?void 0:$.default)??$).find($=>$&&$.id===c.requestId);W(x&&Array.isArray(x.activity)?x.activity:[])}}catch{W([])}},[]),g=(c,b)=>{var s;return String(((s=c.error)==null?void 0:s.message)||c.error||b)},oe=async()=>{if(!V)return;const c=o.map(b=>b.id===V.id?{...b,subject:I.trim()||b.subject,dueDate:k||void 0,notes:S.trim()||void 0}:b);N(c);try{const r={actor:d?`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`:"Unknown",actorRole:"Member",timestamp:new Date().toISOString(),action:"Updated document",comment:(S||"").trim()},x=V.requestId?X.find($=>$.id===V.requestId):null;if(x){const $={...x,activity:Array.isArray(x.activity)?[...x.activity,r]:[r]};try{const Y=await _e($);if(!Y.ok)throw new Error(g(Y,"request_upsert_failed"))}catch(Y){console.error("Failed to save document edits:",Y),B({type:"error",message:`Failed to save document edits: ${Y.message}`});return}W(Y=>[...Y,r])}}catch{}y(""),h(null)};o.filter(c=>!(!(d!=null&&d.id)||d.role==="MEMBER"&&c.uploadedById!==d.id||c.type==="request"));const fe=c=>c.currentStage==="ORIGINATOR_REVIEW",De=()=>String((d==null?void 0:d.role)||"").includes("REVIEW"),Ke=()=>{if(!De())return[];const c=String((d==null?void 0:d.role)||"");return O.filter(b=>{if(b.id===(d==null?void 0:d.id))return!1;if(c.includes("PLATOON")){const s=b.company&&b.company!=="N/A"?b.company:"",r=b.unit&&b.unit!=="N/A"?b.unit:"",x=d!=null&&d.company&&d.company!=="N/A"?d.company:"",$=d!=null&&d.unit&&d.unit!=="N/A"?d.unit:"";return s===x&&r===$}if(c.includes("COMPANY")){const s=b.company&&b.company!=="N/A"?b.company:"",r=d!=null&&d.company&&d.company!=="N/A"?d.company:"";return s===r}return c.includes("COMMANDER")?(b.unitUic||"")===((d==null?void 0:d.unitUic)||""):!1})},We=a.useCallback(async c=>{const b=Re.extractStoragePath(c.fileUrl);try{b&&Ie&&await Ie.storage.from(Ze).remove([b])}catch{}try{await fs(c.id),N(s=>s.filter(r=>r.id!==c.id)),c.requestId&&re(s=>s.map(r=>r.id===c.requestId?{...r,documentIds:(r.documentIds||[]).filter(x=>x!==c.id)}:r)),B({type:"success",message:"Document deleted."})}catch(s){B({type:"error",message:`Failed to delete: ${String((s==null?void 0:s.message)||s)}`})}},[]),Se=a.useCallback(async c=>{const b=`${c.unitUic||"N-A"}/${c.id}/`;try{if(Ie){const{data:s}=await Ie.storage.from(Ze).list(b.slice(0,-1));if(s&&s.length>0){const r=s.map(x=>`${b.slice(0,-1)}/${x.name}`);await Ie.storage.from(Ze).remove(r)}}}catch{}try{await ys(c.id),await vs(c.id),N(s=>s.filter(r=>r.requestId!==c.id)),re(s=>s.filter(r=>r.id!==c.id)),xe(null),B({type:"success",message:"Request and files deleted."})}catch(s){B({type:"error",message:`Failed to delete request: ${String((s==null?void 0:s.message)||s)}`})}},[]),He=async()=>{if(!_||!(d!=null&&d.id)||_.uploadedById!==d.id){B({type:"error",message:"Only the requester can edit this."});return}const c=Date.now(),b=Y=>Y.replace(/[^A-Za-z0-9._-]/g,"-");async function s(Y,H){if(!Ie)throw new Error("Supabase not configured");const{error:K}=await Ie.storage.from(Ze).upload(H,Y,{upsert:!0});if(K)throw new Error(K.message);const{data:ue}=Ie.storage.from(Ze).getPublicUrl(H);return(ue==null?void 0:ue.publicUrl)||""}const r=[];for(let Y=0;Y<M.length;Y++){const H=M[Y],K=`${_.unitUic||"N-A"}/${_.id}/${c}-${Y}-${b(H.name)}`;try{const ue=await s(H,K);r.push(ue)}catch(ue){B({type:"error",message:`Failed to upload ${H.name}: ${String((ue==null?void 0:ue.message)||ue)}`});return}}const x=M.map((Y,H)=>({id:`${c}-${H}`,name:Y.name,type:Y.type,size:Y.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:_.unitUic||"N/A",subject:ye.trim()||_.subject,dueDate:he||void 0,notes:ge.trim()||void 0,uploadedById:d.id,currentStage:_.currentStage||"PLATOON_REVIEW",requestId:_.id,fileUrl:r[H]})),$={..._,subject:ye.trim()||_.subject,dueDate:he||void 0,notes:ge.trim()||void 0,documentIds:[..._.documentIds||[],...x.map(Y=>Y.id)],activity:[..._.activity||[],{actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,timestamp:new Date().toISOString(),action:x.length?`Updated request and added ${x.length} document(s)`:"Updated request",comment:(ge||"").trim()}]};try{if(!(d&&ks(_,String(d.id||"")))){B({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const H=await Et(x);if(!H.ok)throw new Error(g(H,"document_upsert_failed"));const K=await _e($);if(!K.ok)throw new Error(g(K,"request_upsert_failed"))}catch(H){try{At("request_update_failed",{requestId:$.id,error:String((H==null?void 0:H.message)||H)},"error")}catch{}B({type:"error",message:`Failed to persist documents: ${String((H==null?void 0:H.message)||H)}`});return}N(H=>[...H,...x]),re(H=>H.map(K=>K.id===$.id?$:K)),xe($),ae([]),v(""),B({type:"success",message:x.length?"Files added and request updated.":"Request updated."})}catch{B({type:"error",message:"Failed to update request."})}},Xe=async()=>{if(!_||!d||!le)return;const c=`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,b=d.role||"Reviewer",s={actor:c,actorRole:b,timestamp:new Date().toISOString(),action:"Updated retention classification",comment:`Changed SSIC to ${le.ssic} - ${le.nomenclature}`},r={..._,ssic:le.ssic,ssicNomenclature:le.nomenclature,ssicBucket:le.bucket,ssicBucketTitle:le.bucketTitle,isPermanent:le.isPermanent,retentionValue:le.retentionValue,retentionUnit:le.retentionUnit,cutoffTrigger:le.cutoffTrigger,cutoffDescription:le.cutoffDescription,disposalAction:le.disposalAction,dau:le.dau,activity:[..._.activity||[],s]};try{const x=await _e(r);if(!x.ok)throw new Error(g(x,"request_upsert_failed"));re($=>$.map(Y=>Y.id===r.id?r:Y)),xe(r),se(!1),me(null),B({type:"success",message:"Retention classification updated."})}catch(x){B({type:"error",message:`Failed to update retention: ${String((x==null?void 0:x.message)||x)}`})}},[nt,lt]=a.useState(!0),[Ue,dt]=a.useState(!0);a.useEffect(()=>{$t().then(c=>{N(c)}).catch(()=>N([])).finally(()=>lt(!1))},[]),a.useEffect(()=>{_&&(ve(_.subject||""),Ne(_.dueDate||""),v(_.notes||""),ae([]),se(!1),me(null))},[_]),a.useEffect(()=>{},[o]),a.useEffect(()=>{gt().then(c=>{re(c)}).catch(()=>re([])).finally(()=>dt(!1))},[]),a.useEffect(()=>{te(n||null)},[n]),a.useEffect(()=>{at().then(c=>{P(c)}).catch(()=>P([]))},[]),a.useEffect(()=>{try{const c=localStorage.getItem("unit_structure"),b={};if(c){const s=JSON.parse(c);for(const r of Object.keys(s||{})){const x=s[r];x&&Array.isArray(x._sections)&&(b[r]=x._sections)}ee(b)}else(async()=>{try{const s=await ft();for(const r of Object.keys(s||{})){const x=s[r];x&&Array.isArray(x._sections)&&(b[r]=x._sections)}ee(b)}catch{}})()}catch{}},[]);const yt=a.useMemo(()=>d!=null&&d.id?X.filter(b=>b.uploadedById===d.id).filter(b=>b.currentStage!=="ARCHIVED"):[],[X,d]),mt=a.useCallback(c=>{if(c.isPermanent)return"Permanent";if(!c.retentionValue||!c.cutoffTrigger)return"Unknown";const b=new Date(c.createdAt);let s;switch(c.cutoffTrigger){case"CALENDAR_YEAR":s=new Date(b.getFullYear(),11,31);break;case"FISCAL_YEAR":s=b.getMonth()>=9?new Date(b.getFullYear()+1,8,30):new Date(b.getFullYear(),8,30);break;default:s=b}const r=new Date(s);return c.retentionUnit==="years"?r.setFullYear(r.getFullYear()+c.retentionValue):c.retentionUnit==="months"?r.setMonth(r.getMonth()+c.retentionValue):c.retentionUnit==="days"&&r.setDate(r.getDate()+c.retentionValue),r.getFullYear().toString()},[]),rt=a.useMemo(()=>{if(!(d!=null&&d.id))return{};const c=X.filter(s=>s.uploadedById===d.id&&s.ssic),b={};for(const s of c){const r=mt(s),x=s.ssicBucketTitle||s.ssicBucket||"Uncategorized";b[r]||(b[r]={}),b[r][x]||(b[r][x]=[]),b[r][x].push(s)}for(const s of Object.keys(b))for(const r of Object.keys(b[s]))b[s][r].sort((x,$)=>new Date($.createdAt).getTime()-new Date(x.createdAt).getTime());return b},[X,d,mt]),ut=a.useMemo(()=>Object.keys(rt).sort((b,s)=>b==="Permanent"?-1:s==="Permanent"||b==="Unknown"?1:s==="Unknown"?-1:parseInt(b)-parseInt(s)),[rt]),vt=a.useCallback(c=>{if(!c.retentionValue||!c.cutoffTrigger)return"N/A";if(c.isPermanent)return"Permanent";const b=new Date(c.createdAt);let s;switch(c.cutoffTrigger){case"CALENDAR_YEAR":s=new Date(b.getFullYear(),11,31);break;case"FISCAL_YEAR":s=b.getMonth()>=9?new Date(b.getFullYear()+1,8,30):new Date(b.getFullYear(),8,30);break;default:s=b}const r=new Date(s);return c.retentionUnit==="years"?r.setFullYear(r.getFullYear()+c.retentionValue):c.retentionUnit==="months"?r.setMonth(r.getMonth()+c.retentionValue):c.retentionUnit==="days"&&r.setDate(r.getDate()+c.retentionValue),r.toLocaleDateString()},[]),Nt=a.useCallback(c=>{var s;const b=O.find(r=>r.id===c.uploadedById);return b?`${b.lastName}, ${((s=b.firstName)==null?void 0:s.charAt(0))||""}`:"Unknown"},[O]),Ce=Dt(yt,{pageSize:10}),jt=a.useMemo(()=>O.reduce((c,b)=>({...c,[b.id]:b}),{}),[O]),wt=a.useMemo(()=>{const c=be||(d==null?void 0:d.id),b=O.find(H=>H.id===c),s=t?t.uic:(b==null?void 0:b.unitUic)||"",r=qe(b==null?void 0:b.company),x=qe(b==null?void 0:b.platoon);if(!s)return!1;const $=et(O,"PLATOON_REVIEWER",{company:r,platoon:x,uic:s}),Y=et(O,"COMPANY_REVIEWER",{company:r,uic:s});return!$&&!Y},[O,d,be,t]),xt=a.useMemo(()=>{const c=be||(d==null?void 0:d.id),b=O.find(r=>r.id===c),s=t?t.uic:(b==null?void 0:b.unitUic)||"";return j[s]||[]},[j,O,d,be,t]),St=a.useCallback(c=>{const b=qe(c.currentStage||"PLATOON_REVIEW"),s=O.find(r=>r.id===c.uploadedById);switch(b){case"ORIGINATOR_REVIEW":return{level:"Member",scope:""};case"PLATOON_REVIEW":{const r=s!=null&&s.company&&s.company!=="N/A"?s.company:"",x=s!=null&&s.platoon&&s.platoon!=="N/A"?s.platoon:"";return r&&x?{level:"Platoon",scope:`(${r}-${x})`}:r?{level:"Platoon",scope:`(${r})`}:{level:"Platoon",scope:""}}case"COMPANY_REVIEW":{const r=s!=null&&s.company&&s.company!=="N/A"?s.company:"";return{level:"Company",scope:r?`(${r})`:""}}case"BATTALION_REVIEW":return{level:"Battalion",scope:c.routeSection?`(${c.routeSection})`:""};case"COMMANDER_REVIEW":return{level:"Commander",scope:c.routeSection?`(${c.routeSection})`:""};case"ARCHIVED":return{level:"Archived",scope:""};default:return{level:ns(c),scope:""}}},[O]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>f(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),U&&e.jsxs("form",{onSubmit:Te,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:R,onChange:c=>C(c.target.value),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${R.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:D,onChange:c=>L(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),e.jsx("div",{children:e.jsx(Tt,{value:p,onChange:A,required:!0})}),String((d==null?void 0:d.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:be,onChange:c=>Pe(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),Ke().map(c=>e.jsxs("option",{value:c.id,children:[c.rank," ",c.lastName,", ",c.firstName,c.mi?` ${c.mi}`:""]},c.id))]})]})}),wt&&xt.length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Battalion Section"}),e.jsxs("select",{value:ne,onChange:c=>de(c.target.value),className:`w-full px-3 py-2 border ${ne?"border-brand-navy/30":"border-brand-gold"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`,children:[e.jsx("option",{value:"",children:"Select section"}),xt.map(c=>e.jsx("option",{value:c,children:c},c))]}),e.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"No platoon/company reviewer available. Select a section for routing."})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:F,onChange:c=>Z(c.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:Ae,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:w.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:w.map((c,b)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:c.name,children:c.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>J(s=>s.filter((r,x)=>x!==b)),children:"Delete"})]},b))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{f(!1),J([]),C(""),L(""),Z(""),de(""),A(null),B(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!R.trim()||!p,children:"Submit"})]})]}),z&&e.jsx("div",{className:`p-3 rounded-lg border ${z.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:z.message})]})]}),e.jsxs("div",{className:"p-6",children:[d&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>u("Pending"),className:`${we==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>u("Files"),className:`${we==="Files"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Files"})]})}),we==="Pending"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:Ce.totalItems>0?`${Ce.startIndex}â€“${Ce.endIndex} of ${Ce.totalItems}`:""}),Ue&&e.jsx("div",{className:"animate-pulse",children:"Loading requestsâ€¦"})]}),e.jsx(Je,{title:"Your Requests",requests:Ue?Array.from({length:5}).map((c,b)=>({id:`s-${b}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:Ye.PLATOON_REVIEW})):Ce.currentData,users:jt,onRowClick:c=>xe(c),expandedRows:Ee,children:c=>e.jsxs("div",{id:`req-docs-${c.id}`,children:[nt?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):o.filter(b=>b.requestId===c.id&&b.type!=="request").map(b=>e.jsx(Ut,{doc:b,onView:Ve,onDelete:We},b.id)),!nt&&o.filter(b=>b.requestId===c.id&&b.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),Ce.totalItems>0&&e.jsx(Mt,{currentPage:Ce.currentPage,totalPages:Ce.totalPages,totalItems:Ce.totalItems,pageSize:Ce.pageSize,startIndex:Ce.startIndex,endIndex:Ce.endIndex,onPageChange:Ce.goToPage,onPageSizeChange:Ce.setPageSize,onNext:Ce.nextPage,onPrevious:Ce.previousPage,onFirst:Ce.goToFirstPage,onLast:Ce.goToLastPage,canGoNext:Ce.canGoNext,canGoPrevious:Ce.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),we==="Files"&&e.jsx("div",{className:"py-4 space-y-6",children:Ue?e.jsx("div",{className:"animate-pulse",children:"Loading recordsâ€¦"}):ut.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("p",{children:"No records with retention classification yet."}),e.jsx("p",{className:"text-sm mt-1",children:"Create a new request with SSIC classification to see records here."})]}):e.jsx(e.Fragment,{children:ut.map(c=>{const b=rt[c],s=Object.keys(b).sort(),r=c==="Permanent",x=Object.values(b).reduce(($,Y)=>$+Y.length,0);return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`${r?"bg-blue-800":"bg-brand-navy"} text-brand-cream px-4 py-2 rounded-lg font-medium flex items-center justify-between`,children:[e.jsx("span",{children:r?"Permanent Records":`Disposal Year: ${c}`}),e.jsxs("span",{className:"text-xs bg-white/20 px-2 py-0.5 rounded",children:[x," record",x!==1?"s":""]})]}),s.map($=>{const Y=b[$];return e.jsxs("div",{className:"ml-4",children:[e.jsxs("div",{className:"bg-gray-100 text-gray-700 px-3 py-1.5 rounded-t-lg font-medium text-sm border border-b-0 border-gray-200 flex items-center justify-between",children:[e.jsx("span",{children:$}),e.jsxs("span",{className:"text-xs text-gray-500",children:[Y.length," item",Y.length!==1?"s":""]})]}),e.jsx("div",{className:"border border-gray-200 rounded-b-lg overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Name"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"SSIC"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Retention"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Disposal Date"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Originator"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Date Created"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Disposal Action"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:Y.map(H=>e.jsxs("tr",{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>xe(H),children:[e.jsx("td",{className:"px-3 py-2 font-medium text-brand-navy",children:H.subject}),e.jsx("td",{className:"px-3 py-2",children:H.ssic}),e.jsx("td",{className:"px-3 py-2",children:H.isPermanent?e.jsx("span",{className:"inline-flex px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded",children:"Permanent"}):e.jsxs("span",{className:"inline-flex px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded",children:[H.retentionValue," ",H.retentionUnit]})}),e.jsx("td",{className:"px-3 py-2",children:vt(H)}),e.jsx("td",{className:"px-3 py-2",children:Nt(H)}),e.jsx("td",{className:"px-3 py-2",children:new Date(H.createdAt).toLocaleDateString()}),e.jsx("td",{className:"px-3 py-2",children:H.disposalAction||(H.isPermanent?"TRANSFER":"DESTROY")})]},H.id))})]})})]},`${c}-${$}`)})]},c)})})})]}),m&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),V&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>h(null),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:I,onChange:c=>T(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:k,onChange:c=>G(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:V.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:S,onChange:c=>y(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[V.name," â€¢ ",is(V.size)," â€¢ ",new Date(V.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:Q.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):Q.map((c,b)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[c.actor,c.actorRole?` â€¢ ${c.actorRole}`:""," â€¢ ",new Date(c.timestamp).toLocaleString()," â€¢ ",c.action]}),c.comment&&e.jsx("div",{className:"text-gray-600",children:c.comment})]},b))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>h(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:oe,children:"Save"})]})]})}),_&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>xe(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>xe(null),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:ye,onChange:c=>ve(c.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(_.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:he,onChange:c=>Ne(c.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),_.currentStage&&(()=>{const{level:c,scope:b}=St(_);return e.jsxs("span",{className:"inline-flex flex-col items-center px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-lg border border-brand-navy/30 leading-tight",children:[e.jsx("span",{children:c}),b&&e.jsx("span",{className:"text-[10px]",children:b})]})})(),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:3,value:ge,onChange:c=>v(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-4","aria-label":"Request details tabs",children:[e.jsx("button",{onClick:()=>l("documents"),className:`${i==="documents"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Documents"}),e.jsx("button",{onClick:()=>l("retention"),className:`${i==="retention"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Retention"}),e.jsx("button",{onClick:()=>l("activity"),className:`${i==="activity"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Activity"})]})}),e.jsxs("div",{className:"mt-3",children:[i==="documents"&&e.jsxs("div",{className:"space-y-3",children:[o.filter(c=>c.requestId===_.id&&c.type!=="request").length>0?o.filter(c=>c.requestId===_.id&&c.type!=="request").map(c=>e.jsx(Ut,{doc:c,onView:Ve,onDelete:We},c.id)):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents attached"}),!Bt(_,String((d==null?void 0:d.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:c=>{const b=c.target.files?Array.from(c.target.files):[];ae(s=>[...s,...b]);try{c.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2 mt-2",children:M.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):M.map((c,b)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:c.name,children:c.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>ae(s=>s.filter((r,x)=>x!==b)),children:"Delete"})]},b))})]})]}),i==="retention"&&e.jsx("div",{children:q?e.jsxs("div",{className:"space-y-4",children:[e.jsx(Tt,{value:le,onChange:me,required:!0}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{se(!1),me(null)},className:"px-3 py-1 rounded border border-brand-navy/30 text-brand-navy hover:bg-brand-cream text-sm",children:"Cancel"}),e.jsx("button",{type:"button",onClick:Xe,disabled:!le,className:"px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 text-sm disabled:opacity-50",children:"Save Retention"})]})]}):e.jsxs("div",{children:[_.ssic?e.jsx(Fs,{request:_}):e.jsx("div",{className:"text-sm text-[var(--muted)] p-4 bg-gray-50 rounded-lg",children:"No retention information available for this request."}),d&&_.currentStage!=="ARCHIVED"&&e.jsx("button",{type:"button",onClick:()=>se(!0),className:"mt-3 px-3 py-1 rounded border border-brand-navy/30 text-brand-navy hover:bg-brand-cream text-sm",children:_.ssic?"Change Retention":"Add Retention Info"})]})}),i==="activity"&&e.jsx("div",{className:"space-y-2",children:_.activity&&_.activity.length?_.activity.map((c,b)=>e.jsxs("div",{className:"text-xs text-gray-700 p-2 bg-gray-50 rounded",children:[e.jsxs("div",{className:"font-medium",children:[c.actor,c.actorRole?` â€¢ ${c.actorRole}`:""," â€¢ ",new Date(c.timestamp).toLocaleString()," â€¢ ",c.action]}),c.comment&&e.jsx("div",{className:"text-gray-600 mt-1",children:c.comment})]},b)):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No activity recorded"})})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>xe(null),children:"Close"}),Bt(_,String((d==null?void 0:d.id)||""))?e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-gold text-brand-charcoal hover:brightness-110",onClick:pe,children:"Archive"}):e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:He,disabled:!d||d.id!==((_==null?void 0:_.uploadedById)||""),children:"Save Changes"}),d&&fe(_)&&d.id===_.uploadedById&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700",onClick:Me,children:"Resubmit"}),d&&As(_,String((d==null?void 0:d.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>Se(_),children:"Delete Request"})]})]})})]})},Ws=({currentUser:t,onClose:n})=>{const[o,N]=a.useState([]),[m,E]=a.useState(""),[R,C]=a.useState(!1),[D,L]=a.useState(""),[F,Z]=a.useState(!1),[w,J]=a.useState("");a.useEffect(()=>{bt().then(P=>{N(P.data||[])}).catch(()=>N([]))},[]);const z=a.useMemo(()=>String(t.role||"")!=="MEMBER",[t]),B=a.useMemo(()=>{const P=U=>{const f=t.unitUic||"",V=String(t.role||"");if(V.includes("PLATOON")){const h=U.company&&U.company!=="N/A"?U.company:"",I=U.platoon&&U.platoon!=="N/A"?U.platoon:"",T=t.company&&t.company!=="N/A"?t.company:"",k=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return h===T&&I===k}if(V.includes("COMPANY")){const h=U.company&&U.company!=="N/A"?U.company:"",I=t.company&&t.company!=="N/A"?t.company:"";return h===I}return V.includes("COMMANDER")?(U.unitUic||"")===f:!1};return o.filter(U=>U.id!==t.id&&P(U))},[o,t]),d=a.useMemo(()=>{const P=String(t.role||""),U=f=>{const V=t.unitUic||"";if(P.includes("PLATOON")){const h=f.company&&f.company!=="N/A"?f.company:"",I=f.platoon&&f.platoon!=="N/A"?f.platoon:"",T=t.company&&t.company!=="N/A"?t.company:"",k=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return h===T&&I===k}if(P.includes("COMPANY")){const h=f.company&&f.company!=="N/A"?f.company:"",I=t.company&&t.company!=="N/A"?t.company:"";return h===I}return P.includes("COMMANDER")?(f.unitUic||"")===V:!1};return o.filter(f=>f.id!==t.id&&U(f)&&String(f.role||"")===P)},[o,t]),te=async()=>{try{C(!0),L("");const P=o.find(h=>h.id===m);if(!z||!P){C(!1);return}const U=String(t.role||""),f={...P};if(f.role=U,U.includes("PLATOON")){f.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A";const h=t.platoon&&t.platoon!=="N/A"?t.platoon:"N/A";f.rolePlatoon=h}else U.includes("COMPANY")?(f.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A",f.rolePlatoon="N/A"):U.includes("COMMANDER")&&(f.roleCompany="N/A",f.rolePlatoon="N/A");try{if(!(await Ge({id:f.id,email:f.email,rank:f.rank,firstName:f.firstName,lastName:f.lastName,mi:f.mi,service:f.service,role:f.role,unitUic:f.unitUic,unit:f.unit,company:f.company,isUnitAdmin:!!f.isUnitAdmin,isCommandStaff:!!f.isCommandStaff,edipi:f.edipi,passwordHash:f.passwordHash,roleCompany:f.roleCompany,rolePlatoon:f.rolePlatoon})).ok)throw new Error("persist_failed")}catch{L("Failed to persist user changes")}const V={actorId:t.id,actorRole:t.role,targetId:f.id,grantedRole:f.role,timestamp:new Date().toISOString(),scope:{unitUic:t.unitUic||"",company:t.company,unit:t.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(V)})}catch{}N(h=>h.map(I=>I.id===f.id?f:I)),E(""),Z(!1),C(!1)}catch{C(!1),L("Operation failed")}},O=async P=>{try{C(!0),L("");const U=o.find(T=>T.id===P);if(!U){C(!1);return}const f=String(t.role||"");if(!d.some(T=>T.id===P)){C(!1),L("Target not in scope");return}const h={...U};h.role="MEMBER",h.company="N/A",h.unit="N/A",h.isCommandStaff=!1,h.roleCompany="N/A",h.rolePlatoon="N/A";try{if(!(await Ge({id:h.id,email:h.email,rank:h.rank,firstName:h.firstName,lastName:h.lastName,mi:h.mi,service:h.service,role:h.role,unitUic:h.unitUic,unit:h.unit,company:h.company,isUnitAdmin:!!h.isUnitAdmin,isCommandStaff:!!h.isCommandStaff,edipi:h.edipi,passwordHash:h.passwordHash,roleCompany:h.roleCompany,rolePlatoon:h.rolePlatoon})).ok)throw new Error("persist_failed")}catch{L("Failed to persist user changes")}const I={actorId:t.id,actorRole:t.role,targetId:h.id,action:"Revoked",previousRole:f,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(I)})}catch{}N(T=>T.map(k=>k.id===h.id?h:k)),J(""),C(!1)}catch{C(!1),L("Operation failed")}};return z?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:n,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:P=>P.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:n,children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:m,onChange:P=>E(P.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),B.map(P=>e.jsxs("option",{value:P.id,children:[P.rank," ",P.lastName,", ",P.firstName,P.mi?` ${P.mi}`:""," â€¢ ",P.email]},P.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[d.map(P=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[P.rank," ",P.lastName,", ",P.firstName,P.mi?` ${P.mi}`:""," â€¢ ",P.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>J(P.id),children:"Remove Access"})]},P.id)),d.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),D&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:D})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!m||R,onClick:()=>Z(!0),children:"Grant Equivalent Permission"})}),F&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>Z(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:R,onClick:te,children:"Confirm"})]})]}),w&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>J(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:R,onClick:()=>O(w),children:"Remove"})]})]})]})}):null},Qt="ORIGINATOR_REVIEW",Fe=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Hs=[{value:"PLATOON_REVIEW",label:"Platoon Review"},{value:"COMPANY_REVIEW",label:"Company Review"},{value:"BATTALION_REVIEW",label:"Battalion Review"},{value:"COMMANDER_REVIEW",label:"Commander Review"},{value:"ARCHIVED",label:"Archived"}],Us={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},Qs=t=>{const n=Fe.indexOf(t||Fe[0]);return n>=0&&n<Fe.length-1?Fe[n+1]:Fe[n]||Fe[0]},zt=t=>{const n=Fe.indexOf(t||Fe[0]);return n>0?Fe[n-1]:Fe[0]},ht=(t,n)=>{var o;return((o=t.activity)==null?void 0:o.some(N=>n.test(String(N.action||""))))||!1},zs=t=>ht(t,/(approved by commander|commander.*approved)/i)&&!ht(t,/installation commander/i),Ys=t=>ht(t,/(endorsed by commander|commander.*endorsed)/i)&&!ht(t,/installation commander/i),kt=t=>{if(!t)return"MEMBER";const n=String(t.role||"MEMBER"),o=(t.roleCompany||t.company||"").trim(),N=(t.rolePlatoon||t.platoon||"").trim();switch(n){case"PLATOON_REVIEWER":if(o&&N)return`Platoon (${o}-${N})`;break;case"COMPANY_REVIEWER":if(o)return`Company (${o})`;break;case"BATTALION_REVIEWER":return"Battalion";case"COMMANDER_REVIEWER":return"Commander"}return n};function Gs(){const t=ps(),[n,o]=a.useState(()=>{try{const i=localStorage.getItem("currentUser");return i?JSON.parse(i):null}catch(i){return console.error("Failed to parse user from localStorage:",i),null}}),[N,m]=a.useState([]),[E,R]=a.useState([]),[C,D]=a.useState({}),[L,F]=a.useState({}),[Z,w]=a.useState({}),[J,z]=a.useState({}),[B,d]=a.useState({}),[te,O]=a.useState({}),[P,U]=a.useState({}),[f,V]=a.useState(!1),[h,I]=a.useState({}),[T,k]=a.useState({}),[G,S]=a.useState(!1),[y,Q]=a.useState({}),[W,X]=a.useState(null),re=a.useRef(null),[_,xe]=a.useState("Pending"),[ye,ve]=a.useState(Us),[he,Ne]=a.useState(null);a.useEffect(()=>{const i=q=>{W&&re.current&&!re.current.contains(q.target)&&(Q(se=>({...se,[W]:!1})),X(null))},l=q=>{q.key==="Escape"&&W&&(Q(se=>({...se,[W]:!1})),X(null))};return document.addEventListener("mousedown",i),document.addEventListener("keydown",l),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("keydown",l)}},[W]),a.useEffect(()=>{Ns().then(i=>{m(i.data||[])}).catch(()=>m([]))},[]),a.useEffect(()=>{js().then(i=>{R(i.data||[])}).catch(()=>R([]))},[]),a.useEffect(()=>{bt().then(i=>{const l={},q=i.data||[];for(const se of q)se!=null&&se.id&&(l[se.id]=se);F(l)}).catch(()=>F({}))},[]),a.useEffect(()=>{try{const i=localStorage.getItem("unit_structure"),l={},q={};if(i){const se=JSON.parse(i);for(const le of Object.keys(se||{})){const me=se[le];me&&Array.isArray(me._sections)&&(l[le]=me._sections),me&&me._platoonSectionMap&&typeof me._platoonSectionMap=="object"&&(q[le]=me._platoonSectionMap)}}else(async()=>{try{const se=await ft();for(const le of Object.keys(se||{})){const me=se[le];me&&Array.isArray(me._sections)&&(l[le]=me._sections),me&&me._platoonSectionMap&&typeof me._platoonSectionMap=="object"&&(q[le]=me._platoonSectionMap)}}catch{}})();O(l),U(q)}catch{}},[]);const ge=a.useMemo(()=>{const i=String((n==null?void 0:n.role)||"");return i.includes("PLATOON")?"PLATOON_REVIEW":i.includes("COMPANY")?"COMPANY_REVIEW":i.includes("BATTALION")?"BATTALION_REVIEW":i.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[n]),v=a.useMemo(()=>Object.values(L),[L]),M=i=>{const l=L[i.uploadedById];if(!l)return!1;const q=qe(l.company),se=i.unitUic||l.unitUic||"";return et(v,"COMPANY_REVIEWER",{company:q,uic:se})},ae=i=>String((n==null?void 0:n.role)||"").includes("PLATOON")?!M(i):!1,ce=i=>L[i.uploadedById]||null,ie=i=>i&&i!=="N/A"?i.trim():"",Ee=i=>{var Re,Ae;const l=ce(i),q=i.unitUic||(l==null?void 0:l.unitUic)||"",se=String((n==null?void 0:n.role)||""),le=(n==null?void 0:n.unitUic)||"",me=(ie(n==null?void 0:n.roleCompany)||ie(n==null?void 0:n.company)).toUpperCase();if(se.includes("PLATOON")){if(!le||q!==le)return!1;const pe=l?ie(l.company).toUpperCase():"",Me=l?ie(l.platoon).toUpperCase():"",Te=(ie(n==null?void 0:n.rolePlatoon)||ie(n==null?void 0:n.platoon)).toUpperCase();return!me||!Te||!pe||!Me?!1:pe===me&&Me===Te}if(se.includes("COMPANY")){if(!le||q!==le)return!1;const pe=l?ie(l.company).toUpperCase():"";return!me||!pe?!1:pe===me}if(se.includes("BATTALION")){if(!le||q!==le)return!1;const pe=ie(n==null?void 0:n.company),Me=ie(n==null?void 0:n.platoon),Te=((Ae=(Re=P[le])==null?void 0:Re[pe])==null?void 0:Ae[Me])||"";return i.routeSection&&Te?i.routeSection===Te:!0}return se.includes("COMMANDER")?!!le&&q===le:!0},je=a.useMemo(()=>(Array.isArray(N)?N:[]).filter(Ee),[N,n,L,P]),be=a.useMemo(()=>{const i=new Map;for(const l of je){const q=ce(l);if(q&&q.id&&!i.has(q.id)){const se=`${q.rank||""} ${q.lastName||""}, ${q.firstName||""}`.trim();i.set(q.id,{value:q.id,label:se||q.id})}}return Array.from(i.values()).sort((l,q)=>l.label.localeCompare(q.label))},[je,L]),Pe=_s(ye,{items:je,getSearchText:i=>`${i.subject||""} ${i.id||""} ${i.routeSection||""}`,getStatus:i=>i.currentStage||"PLATOON_REVIEW",getDate:i=>i.createdAt,getOriginatorId:i=>i.uploadedById}),we=a.useMemo(()=>Pe.filter(i=>(i.currentStage||"PLATOON_REVIEW")===ge),[Pe,ge]),u=a.useMemo(()=>Pe.filter(i=>(i.currentStage||"PLATOON_REVIEW")!==ge),[Pe,ge]),j=Dt(we,{pageSize:25}),ee=Dt(u,{pageSize:25}),ne=i=>E.filter(l=>l.requestId===i),de=a.useMemo(()=>[{header:"Request ID",getValue:i=>i.id},{header:"Subject",getValue:i=>i.subject},{header:"Stage",getValue:i=>i.currentStage||""},{header:"Route Section",getValue:i=>i.routeSection||""},{header:"Originator",getValue:i=>{const l=ce(i);return l?`${l.rank||""} ${l.lastName||""}, ${l.firstName||""}${l.mi?` ${l.mi}`:""}`.trim():""}},{header:"Unit UIC",getValue:i=>i.unitUic||""},{header:"Created At",getValue:i=>i.createdAt,format:Ht},{header:"Due Date",getValue:i=>i.dueDate||"",format:Ht},{header:"Documents",getValue:i=>ne(i.id).map(l=>l.name).join(" | ")}],[L,E]),p=async(i,l,q)=>{const se=n?`${n.rank} ${n.lastName}, ${n.firstName}${n.mi?` ${n.mi}`:""}`:"Reviewer",le=kt(n),me={actor:se,actorRole:le,timestamp:new Date().toISOString(),action:q,comment:(C[i.id]||"").trim()},Re={...i,currentStage:l,routeSection:l==="BATTALION_REVIEW"&&B[i.id]?B[i.id]:i.routeSection,activity:Array.isArray(i.activity)?[...i.activity,me]:[me]};try{await _e(Re),q.toLowerCase().includes("approved")?t.success("Request approved",{message:`"${i.subject}" advanced to next stage`}):q.toLowerCase().includes("return")?t.warning("Request returned",{message:`"${i.subject}" sent back for revision`}):q.toLowerCase().includes("archive")?t.info("Request archived",{message:`"${i.subject}" has been archived`}):t.success(q,{message:`Request "${i.subject}" updated`}),m(Ae=>Ae.map(pe=>pe.id===Re.id?Re:pe)),D(Ae=>({...Ae,[i.id]:""}))}catch(Ae){t.error("Failed to update request",{message:String(Ae)})}},A=async i=>{const l=J[i.id]||[];if(!l.length||!(n!=null&&n.id))return;const q=Date.now(),se=l.map((pe,Me)=>({id:`${q}-${Me}`,name:pe.name,type:pe.type,size:pe.size,uploadedAt:new Date().toISOString(),subject:i.subject,requestId:i.id,fileUrl:URL.createObjectURL(pe)})),le=n?`${n.rank} ${n.lastName}, ${n.firstName}${n.mi?` ${n.mi}`:""}`:"Reviewer",me=kt(n),Re={actor:le,actorRole:me,timestamp:new Date().toISOString(),action:`Reviewer added ${se.length} document(s)`,comment:(C[i.id]||"").trim()},Ae={...i,documentIds:[...i.documentIds||[],...se.map(pe=>pe.id)],activity:Array.isArray(i.activity)?[...i.activity,Re]:[Re]};try{await Et(se),await _e(Ae),t.success(`${se.length} file${se.length!==1?"s":""} added`,{message:`Documents added to "${i.subject}"`})}catch(pe){t.error("Failed to add files",{message:String(pe)})}R(pe=>[...pe,...se]),m(pe=>pe.map(Me=>Me.id===Ae.id?Ae:Me)),z(pe=>({...pe,[i.id]:[]})),D(pe=>({...pe,[i.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Unit Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:kt(n)}),e.jsx(qs,{items:[...we,...u],columns:de,filename:"review_requests",label:"Export",className:"hidden md:inline-flex"})]})]}),n&&String(n.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>V(!0),children:"Manage Permissions"})})]}),e.jsx(Os,{filters:ye,onFiltersChange:ve,statusOptions:Hs,originatorOptions:be,searchPlaceholder:"Search requests by subject, ID, or section...",className:"mb-4"}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>xe("Pending"),className:`${_==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>xe("In Scope"),className:`${_==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[_==="Pending"&&e.jsx(Je,{title:"Pending",requests:j.currentData,users:L,onRowClick:i=>I(l=>({...l,[i.id]:!l[i.id]})),expandedRows:h,platoonSectionMap:P,children:i=>e.jsxs("div",{id:`details-rev-${i.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!y[i.id],"aria-controls":`docs-rev-${i.id}`,onClick:()=>{Q(l=>({...l,[i.id]:!l[i.id]})),X(l=>y[i.id]?null:i.id)},onKeyDown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),Q(q=>({...q,[i.id]:!q[i.id]})),X(q=>y[i.id]?null:i.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${y[i.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${i.id}`,ref:y[i.id]?re:void 0,className:`${y[i.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:ne(i.id).map(l=>({...l,fileUrl:l.fileUrl})),showIcons:!0,onPreview:l=>Ne(ne(i.id).find(q=>q.id===l.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>w(l=>({...l,[i.id]:!l[i.id]})),"aria-expanded":!!Z[i.id],"aria-controls":`logs-${i.id}`,children:[Z[i.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${i.id}`,className:Z[i.id]?"mt-2 space-y-2":"hidden",children:i.activity&&i.activity.length?i.activity.map((l,q)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[l.actor,l.actorRole?` â€¢ ${l.actorRole}`:""," â€¢ ",new Date(l.timestamp).toLocaleString()," â€¢ ",l.action]}),l.comment&&e.jsx("div",{className:"text-gray-600",children:l.comment})]},q)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:C[i.id]||"",onChange:l=>D(q=>({...q,[i.id]:l.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:l=>z(q=>({...q,[i.id]:l.target.files?Array.from(l.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(J[i.id]||[]).length?`${(J[i.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>A(i),disabled:!J[i.id]||!(J[i.id]||[]).length,children:"Save Files"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[(String((n==null?void 0:n.role)||"").includes("COMPANY")||ae(i))&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:B[i.id]||"",onChange:l=>d(q=>({...q,[i.id]:l.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(te[(n==null?void 0:n.unitUic)||""]||[]).map(l=>e.jsx("option",{value:l,children:l},l))]}),ae(i)&&e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No company reviewer"})]}),(()=>{const l=zs(i),q=Ys(i),se=String((n==null?void 0:n.role)||"").includes("COMPANY")||ae(i);return l||q?e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>p(i,i.currentStage==="PLATOON_REVIEW"?Qt:zt(i.currentStage),"Returned to previous stage"),children:"Return to Previous"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(se){if(!B[i.id])return;p(i,"BATTALION_REVIEW",`Approved and routed to ${B[i.id]}`)}else p(i,Qs(i.currentStage),"Approved")},disabled:se&&!B[i.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>p(i,i.currentStage==="PLATOON_REVIEW"?Qt:zt(i.currentStage),i.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),_==="In Scope"&&e.jsx(Je,{title:"In Scope",requests:ee.currentData,users:L,onRowClick:i=>I(l=>({...l,[i.id]:!l[i.id]})),expandedRows:h,platoonSectionMap:P,children:i=>e.jsxs("div",{id:`details-rev-${i.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!y[i.id],"aria-controls":`docs-rev-${i.id}`,onClick:()=>{Q(l=>({...l,[i.id]:!l[i.id]})),X(l=>y[i.id]?null:i.id)},onKeyDown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),Q(q=>({...q,[i.id]:!q[i.id]})),X(q=>y[i.id]?null:i.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${y[i.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${i.id}`,ref:y[i.id]?re:void 0,className:`${y[i.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:ne(i.id).map(l=>({...l,fileUrl:l.fileUrl})),showIcons:!0,onPreview:l=>Ne(ne(i.id).find(q=>q.id===l.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>w(l=>({...l,[i.id]:!l[i.id]})),"aria-expanded":!!Z[i.id],"aria-controls":`logs-${i.id}`,children:[Z[i.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${i.id}`,className:Z[i.id]?"mt-2 space-y-2":"hidden",children:i.activity&&i.activity.length?i.activity.map((l,q)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[l.actor,l.actorRole?` â€¢ ${l.actorRole}`:""," â€¢ ",new Date(l.timestamp).toLocaleString()," â€¢ ",l.action]}),l.comment&&e.jsx("div",{className:"text-gray-600",children:l.comment})]},q)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),f&&n&&e.jsx(Ws,{currentUser:n,onClose:()=>V(!1)}),he&&he.fileUrl&&e.jsx(rs,{url:he.fileUrl,fileName:he.name,mimeType:he.type,fileSize:he.size,isOpen:!!he,onClose:()=>Ne(null)})]})}function Js(){var T;const[t,n]=a.useState(null),[o,N]=a.useState([]),[m,E]=a.useState([]),[R,C]=a.useState(""),[D,L]=a.useState(""),[F,Z]=a.useState([]),[w,J]=a.useState(null),[z,B]=a.useState("structure"),[d,te]=a.useState({}),[O,P]=a.useState({}),[U,f]=a.useState({});a.useEffect(()=>{try{const k=localStorage.getItem("currentUser");k&&n(JSON.parse(k))}catch{}Xt().then(k=>{try{N(k.map(G=>({code:String(G.code||""),name:String(G.name||"")})))}catch{N([])}}),Zt().then(k=>{E(k)}).catch(()=>E([])),at().then(k=>Z(k)).catch(()=>Z([])),Ot().then(k=>{const G={};for(const S of k){const y=`${S.division_code}::${S.branch}`;G[y]={reviewers:S.reviewers||[],approvers:S.approvers||[]}}te(G)})},[]);const V=(t==null?void 0:t.hqmcDivision)||((T=o[0])==null?void 0:T.code)||"",h=a.useMemo(()=>o.find(k=>k.code===V),[o,V]),I=a.useMemo(()=>(Array.isArray(m)?m:[]).filter(k=>String(k.division_code||"")===V),[m,V]);return a.useMemo(()=>(Array.isArray(F)?F:[]).filter(k=>!!k.isHqmcAdmin&&String(k.hqmcDivision||"")===V),[F,V]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(t!=null&&t.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",h?`${h.code} â€” ${h.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>B("structure"),className:`${z==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>B("permissions"),className:`${z==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),z==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[I.map(k=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:k.branch}),e.jsx("td",{className:"py-2 px-3",children:k.description||""}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700",onClick:async()=>{if(!confirm(`Delete branch "${k.branch}"?`))return;const G=await ws(V,k.branch);G.ok?(E(S=>S.filter(y=>!(y.division_code===V&&y.branch===k.branch))),J({type:"success",message:`Deleted branch "${k.branch}"`})):J({type:"error",message:`Failed to delete: ${G.error}`})},children:"Delete"})})]},k.branch)),I.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:R,onChange:k=>C(k.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:D,onChange:k=>L(k.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!R.trim(),onClick:async()=>{var k;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:V,division_name:((k=o.find(S=>S.code===V))==null?void 0:k.name)||"",branch:R.trim(),description:D.trim()})});const G=await fetch("/api/hqmc-structure").then(S=>S.json());E(G),C(""),L("")}catch{}},children:"Add"})]})]})]}),z==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const k of I){const G=`${V}::${k.branch}`,S=d[G]||{reviewers:[],approvers:[]};await es({division_code:V,branch:k.branch,reviewers:S.reviewers,approvers:S.approvers})}J({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:I.map(k=>{const G=`${V}::${k.branch}`,S=d[G]||{reviewers:[],approvers:[]},y=Q=>`${Q.rank||""} ${Q.lastName||""}, ${Q.firstName||""}${Q.mi?" "+Q.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:k.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:O[G]||"",onChange:Q=>P(W=>({...W,[G]:Q.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!O[G],onClick:async()=>{const Q=(O[G]||"").trim();if(!Q)return;const{user:W,error:X}=await Rt(Q);if(X){J({type:"error",message:`Database error: ${X}`});return}if(!(W!=null&&W.id)){J({type:"error",message:`No user found for EDIPI ${Q}`});return}te(re=>({...re,[G]:{...S,reviewers:Array.from(new Set([...S.reviewers||[],W.id]))}})),P(re=>({...re,[G]:""})),J({type:"success",message:`Added reviewer ${W.lastName||""}, ${W.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(S.reviewers||[]).map(Q=>{const W=F.find(X=>X.id===Q);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:W?y(W):Q}),e.jsx("button",{className:"text-red-600",onClick:()=>te(X=>({...X,[G]:{...S,reviewers:(S.reviewers||[]).filter(re=>re!==Q)}})),children:"âœ•"})]},Q)}),(S.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:U[G]||"",onChange:Q=>f(W=>({...W,[G]:Q.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!U[G],onClick:async()=>{const Q=(U[G]||"").trim();if(!Q)return;const{user:W,error:X}=await Rt(Q);if(X){J({type:"error",message:`Database error: ${X}`});return}if(!(W!=null&&W.id)){J({type:"error",message:`No user found for EDIPI ${Q}`});return}te(re=>({...re,[G]:{...S,approvers:Array.from(new Set([...S.approvers||[],W.id]))}})),f(re=>({...re,[G]:""})),J({type:"success",message:`Added approver ${W.lastName||""}, ${W.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(S.approvers||[]).map(Q=>{const W=F.find(X=>X.id===Q);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:W?y(W):Q}),e.jsx("button",{className:"text-red-600",onClick:()=>te(X=>({...X,[G]:{...S,approvers:(S.approvers||[]).filter(re=>re!==Q)}})),children:"âœ•"})]},Q)}),(S.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},G)})})]})})]}),w&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${w.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:w.message})]})}const ct=(t,n)=>`${t}::${n}`;function Ks({currentUser:t,divisionCode:n,branches:o,assignments:N,onClose:m}){const[E,R]=a.useState([]),[C,D]=a.useState(""),[L,F]=a.useState(""),[Z,w]=a.useState("reviewer"),[J,z]=a.useState(!1);a.useEffect(()=>{bt().then(h=>R(h)).catch(()=>R([]))},[]);const B=a.useMemo(()=>{const h={};for(const I of N)h[ct(I.division_code,I.branch)]={reviewers:I.reviewers||[],approvers:I.approvers||[]};return h},[N]),d=String(t.id||""),te=a.useMemo(()=>{if(!C)return!1;const h=B[ct(n,C)]||{reviewers:[],approvers:[]};return(h.reviewers||[]).includes(d)||(h.approvers||[]).includes(d)||!!t.isHqmcAdmin},[C,B,d,t]),O=a.useMemo(()=>E.filter(h=>String(h.hqmcDivision||"")===String(n||"")&&String(h.id||"")!==d),[E,n,d]),P=a.useMemo(()=>{if(!C)return[];const h=B[ct(n,C)]||{reviewers:[],approvers:[]};return Array.from(new Set([...h.reviewers||[],...h.approvers||[]])).map(T=>O.find(k=>k.id===T)).filter(Boolean)},[C,B,O,n]),U=async h=>{z(!0);try{await es({division_code:n,branch:C,reviewers:h.reviewers,approvers:h.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:t.id,scope:{hqmcDivision:n,branch:C},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{z(!1)}},f=async()=>{if(!te||!C||!L)return;const h=B[ct(n,C)]||{reviewers:[],approvers:[]},I={reviewers:Array.from(new Set(h.reviewers||[])),approvers:Array.from(new Set(h.approvers||[]))};Z==="reviewer"?I.reviewers=Array.from(new Set([...I.reviewers,L])):I.approvers=Array.from(new Set([...I.approvers,L])),await U(I),F("")},V=async h=>{if(!te||!C)return;const I=B[ct(n,C)]||{reviewers:[],approvers:[]},T={reviewers:(I.reviewers||[]).filter(k=>k!==h),approvers:(I.approvers||[]).filter(k=>k!==h)};await U(T)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:m,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:h=>h.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:m,children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:C,onChange:h=>D(h.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),o.map(h=>e.jsx("option",{value:h,children:h},h))]})]}),C&&!te&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),C&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:L,onChange:h=>F(h.target.value),disabled:!te,children:[e.jsx("option",{value:"",children:"Choose user"}),O.map(h=>e.jsxs("option",{value:h.id,children:[h.rank," ",h.lastName,", ",h.firstName,h.mi?` ${h.mi}`:""," â€¢ ",h.email]},h.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:Z,onChange:h=>w(h.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!te||!L||J,onClick:f,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[P.map(h=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[h.rank," ",h.lastName,", ",h.firstName,h.mi?` ${h.mi}`:""," â€¢ ",h.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!te||J,onClick:()=>V(h.id),children:"Remove"})]},h.id)),P.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}function Xs(){const[t,n]=a.useState(()=>{try{const u=localStorage.getItem("currentUser");return u?JSON.parse(u):null}catch{return null}}),[o,N]=a.useState([]),[m,E]=a.useState([]),[R,C]=a.useState({}),[D,L]=a.useState({}),[F,Z]=a.useState({}),[w,J]=a.useState({}),[z,B]=a.useState({}),[d,te]=a.useState(null),O=a.useRef(null),[P,U]=a.useState([]),[f,V]=a.useState("Pending"),[h,I]=a.useState([]),[T,k]=a.useState({}),[G,S]=a.useState(!1);a.useEffect(()=>{const u=ee=>{d&&O.current&&!O.current.contains(ee.target)&&(J(ne=>({...ne,[d]:!1})),te(null))},j=ee=>{ee.key==="Escape"&&d&&(J(ne=>({...ne,[d]:!1})),te(null))};return document.addEventListener("mousedown",u),document.addEventListener("keydown",j),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("keydown",j)}},[d]),a.useEffect(()=>{gt().then(u=>N(u)).catch(()=>N([]))},[]),a.useEffect(()=>{$t().then(u=>E(u)).catch(()=>E([]))},[]),a.useEffect(()=>{at().then(u=>{const j={};for(const ee of u)ee!=null&&ee.id&&(j[ee.id]=ee);L(j)}).catch(()=>L({}))},[]),a.useEffect(()=>{Ot().then(U).catch(()=>U([]))},[]),a.useEffect(()=>{Zt().then(I).catch(()=>I([]))},[]);const y=(t==null?void 0:t.id)||"",Q=String((t==null?void 0:t.hqmcDivision)||""),W=a.useMemo(()=>P.filter(u=>u.division_code===Q&&((u.reviewers||[]).includes(y)||(u.approvers||[]).includes(y))).map(u=>u.branch),[P,Q,y]),X=u=>D[u.uploadedById]||null,re=u=>{if(!Q||!y)return!1;const j=String(u.routeSection||"");return W.includes(j)},_=u=>(u.activity||[]).some(j=>/HQMC Approver Approved/i.test(String(j.action||""))),xe=a.useMemo(()=>(Array.isArray(o)?o:[]).filter(re),[o,W]),ye=a.useMemo(()=>xe.filter(u=>(u.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&!_(u)),[xe]),ve=a.useMemo(()=>xe.filter(u=>(u.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&_(u)),[xe]),he=a.useMemo(()=>xe.filter(u=>(u.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[xe]),Ne=u=>m.filter(j=>j.requestId===u),ge=u=>`"${String(u??"").replace(/"/g,'""')}"`,v=u=>{const ee=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const ne of u){const de=X(ne),p=de?`${de.rank} ${de.lastName}, ${de.firstName}${de.mi?` ${de.mi}`:""}`:"",A=Ne(ne.id).map(i=>i.name).join(" | ");ee.push([ne.id,ne.subject,ne.currentStage||"",ne.routeSection||"",p,ne.unitUic||"",new Date(ne.createdAt).toLocaleString(),A])}return ee.map(ne=>ne.map(ge).join(",")).join(`\r
`)},M=(u,j)=>{const ee=new Blob([j],{type:"text/csv;charset=utf-8;"}),ne=URL.createObjectURL(ee),de=document.createElement("a");de.href=ne,de.download=u,document.body.appendChild(de),de.click(),document.body.removeChild(de),URL.revokeObjectURL(ne)},ae=()=>M("hqmc_pending.csv",v(ye)),ce=()=>M("hqmc_approved.csv",v(ve)),ie=()=>M("hqmc_archived.csv",v(he)),Ee=()=>M("hqmc_all.csv",v([...ye,...ve,...he])),je=async u=>{const j=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",ee=String(T[u.id]||"").trim();if(!ee){alert("Select an HQMC section to route to approver");return}const ne={actor:j,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${ee}`,comment:(R[u.id]||"").trim()},de={...u,routeSection:ee,activity:Array.isArray(u.activity)?[...u.activity,ne]:[ne]};try{await _e(de)}catch{}N(p=>p.map(A=>A.id===de.id?de:A)),C(p=>({...p,[u.id]:""}))},be=async u=>{const ee={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC to Installation",comment:(R[u.id]||"").trim()},ne={...u,currentStage:"INSTALLATION_REVIEW",activity:Array.isArray(u.activity)?[...u.activity,ee]:[ee]};try{await _e(ne)}catch{}N(de=>de.map(p=>p.id===ne.id?ne:p)),C(de=>({...de,[u.id]:""}))},Pe=async u=>{const ee={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Section",timestamp:new Date().toISOString(),action:"Archived by HQMC Section",comment:(R[u.id]||"").trim()},ne={...u,currentStage:"ARCHIVED",activity:Array.isArray(u.activity)?[...u.activity,ee]:[ee]};try{await _e(ne)}catch{}N(de=>de.map(p=>p.id===ne.id?ne:p)),C(de=>({...de,[u.id]:""}))},we=async u=>{const j=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Section",ee=String(T[u.id]||"").trim();if(!ee){alert("Select an HQMC section to reassign to");return}const ne={actor:j,timestamp:new Date().toISOString(),action:`Reassigned to HQMC section: ${ee}`,comment:(R[u.id]||"").trim()},de={...u,routeSection:ee,activity:Array.isArray(u.activity)?[...u.activity,ne]:[ne]};try{await _e(de)}catch{}N(p=>p.map(A=>A.id===de.id?de:A)),C(p=>({...p,[u.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Q||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ee,children:"Export All"}),W.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>S(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>V("Pending"),className:`${f==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>V("Approved"),className:`${f==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"}),e.jsx("button",{onClick:()=>V("Archived"),className:`${f==="Archived"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Archived"})]})}),e.jsxs("div",{className:"mt-4",children:[f==="Pending"&&e.jsx(Je,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ae,children:"Export Pending"}),requests:ye,users:D,onRowClick:u=>Z(j=>({...j,[u.id]:!j[u.id]})),expandedRows:F,children:u=>e.jsxs("div",{id:`details-hq-${u.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!w[u.id],"aria-controls":`docs-hq-${u.id}`,onClick:()=>{J(j=>({...j,[u.id]:!j[u.id]})),te(j=>w[u.id]?null:u.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${w[u.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${u.id}`,ref:w[u.id]?O:void 0,className:`${w[u.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:Ne(u.id).map(j=>({...j,fileUrl:j.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[u.id],"aria-controls":`logs-hq-${u.id}`,onClick:()=>B(j=>({...j,[u.id]:!j[u.id]})),children:[z[u.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hq-${u.id}`,className:z[u.id]?"mt-2 space-y-2":"hidden",children:u.activity&&u.activity.length?u.activity.map((j,ee)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[j.actor," â€¢ ",new Date(j.timestamp).toLocaleString()," â€¢ ",j.action]}),j.comment&&e.jsx("div",{className:"text-gray-600",children:j.comment})]},ee)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:R[u.id]||"",onChange:j=>C(ee=>({...ee,[u.id]:j.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:T[u.id]||"",onChange:j=>k(ee=>({...ee,[u.id]:j.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),h.filter(j=>String(j.division_code||"")===Q).map(j=>e.jsx("option",{value:j.branch,children:j.branch},j.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>je(u),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>be(u),children:"Return"})]})]})]})}),f==="Approved"&&e.jsx(Je,{title:"Approved by HQMC Approver",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ce,children:"Export Approved"}),requests:ve,users:D,onRowClick:u=>Z(j=>({...j,[u.id]:!j[u.id]})),expandedRows:F,children:u=>e.jsxs("div",{id:`details-hqa-${u.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!w[u.id],"aria-controls":`docs-hqa-${u.id}`,onClick:()=>{J(j=>({...j,[u.id]:!j[u.id]})),te(j=>w[u.id]?null:u.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${w[u.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${u.id}`,ref:w[u.id]?O:void 0,className:`${w[u.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:Ne(u.id).map(j=>({...j,fileUrl:j.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[u.id],"aria-controls":`logs-hqa-${u.id}`,onClick:()=>B(j=>({...j,[u.id]:!j[u.id]})),children:[z[u.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqa-${u.id}`,className:z[u.id]?"mt-2 space-y-2":"hidden",children:u.activity&&u.activity.length?u.activity.map((j,ee)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[j.actor," â€¢ ",new Date(j.timestamp).toLocaleString()," â€¢ ",j.action]}),j.comment&&e.jsx("div",{className:"text-gray-600",children:j.comment})]},ee)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:R[u.id]||"",onChange:j=>C(ee=>({...ee,[u.id]:j.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Reassign to Section"}),e.jsxs("select",{value:T[u.id]||"",onChange:j=>k(ee=>({...ee,[u.id]:j.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),h.filter(j=>String(j.division_code||"")===Q).map(j=>e.jsx("option",{value:j.branch,children:j.branch},j.branch))]}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>we(u),children:"Reassign"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700",onClick:()=>Pe(u),children:"Archive"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>be(u),children:"Return to Installation"})]})]})]})}),f==="Archived"&&e.jsx(Je,{title:"Archived",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ie,children:"Export Archived"}),requests:he,users:D,onRowClick:u=>Z(j=>({...j,[u.id]:!j[u.id]})),expandedRows:F,children:u=>e.jsxs("div",{id:`details-hqarc-${u.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!w[u.id],"aria-controls":`docs-hqarc-${u.id}`,onClick:()=>{J(j=>({...j,[u.id]:!j[u.id]})),te(j=>w[u.id]?null:u.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${w[u.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqarc-${u.id}`,ref:w[u.id]?O:void 0,className:`${w[u.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:Ne(u.id).map(j=>({...j,fileUrl:j.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[u.id],"aria-controls":`logs-hqarc-${u.id}`,onClick:()=>B(j=>({...j,[u.id]:!j[u.id]})),children:[z[u.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqarc-${u.id}`,className:z[u.id]?"mt-2 space-y-2":"hidden",children:u.activity&&u.activity.length?u.activity.map((j,ee)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[j.actor," â€¢ ",new Date(j.timestamp).toLocaleString()," â€¢ ",j.action]}),j.comment&&e.jsx("div",{className:"text-gray-600",children:j.comment})]},ee)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),G&&t&&e.jsx(Ks,{currentUser:t,divisionCode:Q,branches:h.filter(u=>String(u.division_code||"")===Q).map(u=>u.branch),assignments:P,onClose:()=>S(!1)})]})}function Zs(){const[t,n]=a.useState(()=>{try{const v=localStorage.getItem("currentUser");return v?JSON.parse(v):null}catch{return null}}),[o,N]=a.useState([]),[m,E]=a.useState([]),[R,C]=a.useState({}),[D,L]=a.useState({}),[F,Z]=a.useState({}),[w,J]=a.useState({}),[z,B]=a.useState({}),[d,te]=a.useState(null),O=a.useRef(null),[P,U]=a.useState([]),[f,V]=a.useState("Pending");a.useEffect(()=>{const v=ae=>{d&&O.current&&!O.current.contains(ae.target)&&(J(ce=>({...ce,[d]:!1})),te(null))},M=ae=>{ae.key==="Escape"&&d&&(J(ce=>({...ce,[d]:!1})),te(null))};return document.addEventListener("mousedown",v),document.addEventListener("keydown",M),()=>{document.removeEventListener("mousedown",v),document.removeEventListener("keydown",M)}},[d]),a.useEffect(()=>{gt().then(v=>N(v)).catch(()=>N([]))},[]),a.useEffect(()=>{$t().then(v=>E(v)).catch(()=>E([]))},[]),a.useEffect(()=>{at().then(v=>{const M={};for(const ae of v)ae!=null&&ae.id&&(M[ae.id]=ae);L(M)}).catch(()=>L({}))},[]),a.useEffect(()=>{Ot().then(U).catch(()=>U([]))},[]);const h=(t==null?void 0:t.id)||"",I=String((t==null?void 0:t.hqmcDivision)||""),T=a.useMemo(()=>P.filter(v=>v.division_code===I&&(v.approvers||[]).includes(h)).map(v=>v.branch),[P,I,h]),k=v=>D[v.uploadedById]||null,G=v=>{if(!I||!h)return!1;const M=String(v.routeSection||"");return T.includes(M)},S=v=>(v.activity||[]).some(M=>/HQMC Approver Approved/i.test(String(M.action||""))),y=a.useMemo(()=>(Array.isArray(o)?o:[]).filter(G),[o,T]),Q=a.useMemo(()=>y.filter(v=>(v.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&!S(v)),[y]),W=a.useMemo(()=>y.filter(v=>S(v)),[y]),X=v=>m.filter(M=>M.requestId===v),re=v=>`"${String(v??"").replace(/"/g,'""')}"`,_=v=>{const ae=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const ce of v){const ie=k(ce),Ee=ie?`${ie.rank} ${ie.lastName}, ${ie.firstName}${ie.mi?` ${ie.mi}`:""}`:"",je=X(ce.id).map(be=>be.name).join(" | ");ae.push([ce.id,ce.subject,ce.currentStage||"",ce.routeSection||"",Ee,ce.unitUic||"",new Date(ce.createdAt).toLocaleString(),je])}return ae.map(ce=>ce.map(re).join(",")).join(`\r
`)},xe=(v,M)=>{const ae=new Blob([M],{type:"text/csv;charset=utf-8;"}),ce=URL.createObjectURL(ae),ie=document.createElement("a");ie.href=ce,ie.download=v,document.body.appendChild(ie),ie.click(),document.body.removeChild(ie),URL.revokeObjectURL(ce)},ye=()=>xe("hqmc_approver_pending.csv",_(Q)),ve=()=>xe("hqmc_approver_approved.csv",_(W)),he=()=>xe("hqmc_approver_all.csv",_([...Q,...W])),Ne=async v=>{const ae={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved - Pending HQMC Section Action",comment:(R[v.id]||"").trim()},ce={...v,currentStage:"HQMC_REVIEW",activity:Array.isArray(v.activity)?[...v.activity,ae]:[ae]};try{await _e(ce)}catch{}N(ie=>ie.map(Ee=>Ee.id===ce.id?ce:Ee)),C(ie=>({...ie,[v.id]:""}))},ge=async v=>{const ae={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver to Installation",comment:(R[v.id]||"").trim()},ce={...v,currentStage:"INSTALLATION_REVIEW",activity:Array.isArray(v.activity)?[...v.activity,ae]:[ae]};try{await _e(ce)}catch{}N(ie=>ie.map(Ee=>Ee.id===ce.id?ce:Ee)),C(ie=>({...ie,[v.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((t==null?void 0:t.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:he,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>V("Pending"),className:`${f==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>V("Approved"),className:`${f==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"})]})}),e.jsxs("div",{className:"mt-4",children:[f==="Pending"&&e.jsx(Je,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ye,children:"Export Pending"}),requests:Q,users:D,onRowClick:v=>Z(M=>({...M,[v.id]:!M[v.id]})),expandedRows:F,children:v=>e.jsxs("div",{id:`details-hqa-${v.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!w[v.id],"aria-controls":`docs-hqa-${v.id}`,onClick:()=>{J(M=>({...M,[v.id]:!M[v.id]})),te(M=>w[v.id]?null:v.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${w[v.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${v.id}`,ref:w[v.id]?O:void 0,className:`${w[v.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:X(v.id).map(M=>({...M,fileUrl:M.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[v.id],"aria-controls":`logs-hqa-${v.id}`,onClick:()=>B(M=>({...M,[v.id]:!M[v.id]})),children:[z[v.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqa-${v.id}`,className:z[v.id]?"mt-2 space-y-2":"hidden",children:v.activity&&v.activity.length?v.activity.map((M,ae)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[M.actor," â€¢ ",new Date(M.timestamp).toLocaleString()," â€¢ ",M.action]}),M.comment&&e.jsx("div",{className:"text-gray-600",children:M.comment})]},ae)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:R[v.id]||"",onChange:M=>C(ae=>({...ae,[v.id]:M.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Ne(v),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>ge(v),children:"Return"})]})]})}),f==="Approved"&&e.jsx(Je,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ve,children:"Export Approved"}),requests:W,users:D,onRowClick:v=>Z(M=>({...M,[v.id]:!M[v.id]})),expandedRows:F,children:v=>e.jsxs("div",{id:`details-hqa-${v.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!w[v.id],"aria-controls":`docs-hqa-${v.id}`,onClick:()=>{J(M=>({...M,[v.id]:!M[v.id]})),te(M=>w[v.id]?null:v.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${w[v.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${v.id}`,ref:w[v.id]?O:void 0,className:`${w[v.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:X(v.id).map(M=>({...M,fileUrl:M.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[v.id],"aria-controls":`logs-hqaa-${v.id}`,onClick:()=>B(M=>({...M,[v.id]:!M[v.id]})),children:[z[v.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqaa-${v.id}`,className:z[v.id]?"mt-2 space-y-2":"hidden",children:v.activity&&v.activity.length?v.activity.map((M,ae)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[M.actor," â€¢ ",new Date(M.timestamp).toLocaleString()," â€¢ ",M.action]}),M.comment&&e.jsx("div",{className:"text-gray-600",children:M.comment})]},ae)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]})})}const ea=({onUnitSelect:t,selectedUnit:n})=>{const[o,N]=a.useState(""),[m,E]=a.useState(!1),R=Be.filter(D=>D.unitName.toLowerCase().startsWith(o.toLowerCase())||D.uic.toLowerCase().startsWith(o.toLowerCase())||D.ruc.toLowerCase().startsWith(o.toLowerCase())),C=D=>{t(D),E(!1),N("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>E(!m),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[n?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:n.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",n.uic," | RUC: ",n.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),m&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:o,onChange:D=>N(D.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:R.map(D=>e.jsxs("button",{type:"button",onClick:()=>C(D),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:D.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",D.uic," | RUC: ",D.ruc," | MCC: ",D.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[D.streetAddress,", ",D.cityState," ",D.zip]})]},D.uic))})]})]})]})},Pt=async t=>{const o=new TextEncoder().encode(t),N=await crypto.subtle.digest("SHA-256",o);return Array.from(new Uint8Array(N)).map(m=>m.toString(16).padStart(2,"0")).join("")};async function ta(t,n){const o=Ss();return o!=null&&o.auth?await o.auth.signUp({email:t,password:n}):{data:null,error:new Error("supabase_not_initialized")}}const Yt={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},sa=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],os=({onSaved:t,initial:n={},mode:o="create",readOnly:N=!1,canEditRole:m=!1,canEditAdmin:E=!1})=>{const[R,C]=a.useState(""),[D,L]=a.useState(""),[F,Z]=a.useState(""),[w,J]=a.useState(n.email||""),[z,B]=a.useState(n.edipi||""),[d,te]=a.useState(n.service||""),[O,P]=a.useState(n.rank||""),[U,f]=a.useState(n.role||"MEMBER"),[V,h]=a.useState(!!n.isUnitAdmin),[I,T]=a.useState(n.company||""),[k,G]=a.useState(n.platoon||""),[S,y]=a.useState(void 0),[Q,W]=a.useState(null),[X,re]=a.useState({}),[_,xe]=a.useState(""),[ye,ve]=a.useState(""),[he,Ne]=a.useState([]),[ge,v]=a.useState(!1),[M,ae]=a.useState(n.roleCompany||""),[ce,ie]=a.useState(n.rolePlatoon||""),[Ee,je]=a.useState(!1),[be,Pe]=a.useState([]),[we,u]=a.useState([]),[j,ee]=a.useState([]),[ne,de]=a.useState([]);a.useEffect(()=>{if(n.firstName&&C(String(n.firstName)),n.lastName&&L(String(n.lastName)),n.mi&&Z(String(n.mi)),n.company&&T(String(n.company)),n.platoon&&G(String(n.platoon)),n.roleCompany&&ae(String(n.roleCompany)),n.rolePlatoon&&ie(String(n.rolePlatoon)),n.unitUic){const g=Be.find(oe=>oe.uic===n.unitUic);g&&y(g)}},[n]);const p=a.useMemo(()=>Yt[d]||[],[d]),A=a.useMemo(()=>{if(!S)return[];const g=be;if(g&&g.length)return g;const oe=X[S.uic]||{};return Object.keys(oe).filter(fe=>!fe.startsWith("_")&&Array.isArray(oe[fe]))},[S,X,be]),i=a.useMemo(()=>{var g;return S&&I?((g=X[S.uic])==null?void 0:g[I])||[]:[]},[S,I,X]),l=a.useMemo(()=>{if(!S||!I)return[];const g=we;return g&&g.length?g:i},[S,I,we,i]),q=a.useMemo(()=>{if(!S)return[];const g=j;if(g&&g.length)return g;const oe=X[S.uic]||{};return Object.keys(oe).filter(fe=>!fe.startsWith("_")&&Array.isArray(oe[fe]))},[S,X,j]),se=a.useMemo(()=>{var g;return S&&M?((g=X[S.uic])==null?void 0:g[M])||[]:[]},[S,M,X]),le=a.useMemo(()=>{if(!S||!M)return[];const g=ne;return g&&g.length?g:se},[S,M,ne,se]),me=a.useMemo(()=>{const g=A.slice(),oe=I||n.company||n.user_company||"";return oe&&!g.includes(oe)?[oe,...g]:g},[A,I,n]),Re=a.useMemo(()=>{const g=l.slice(),oe=k||n.platoon||n.user_platoon||"";return oe&&!g.includes(oe)?[oe,...g]:g},[l,k,n]),Ae=a.useMemo(()=>{const g=q.slice(),oe=M||n.roleCompany||"",fe=oe&&!g.includes(oe)?[oe,...g]:g;return Array.from(new Set(fe))},[q,M,n]),pe=a.useMemo(()=>{const g=le.slice(),oe=ce||n.rolePlatoon||"";return oe&&!g.includes(oe)?[oe,...g]:g},[le,ce,n]);a.useEffect(()=>{(async()=>{try{if(o==="edit"&&n.id){const g=await ts(String(n.id));g&&(g.company&&!I&&T(String(g.company)),g.platoon&&!k&&G(String(g.platoon)),g.roleCompany&&!M&&ae(String(g.roleCompany)),g.rolePlatoon&&!ce&&ie(String(g.rolePlatoon)))}}catch{}})()},[o,n.id]),a.useEffect(()=>{p.includes(O)||P("")},[p]),a.useEffect(()=>{G("")},[I]),a.useEffect(()=>{ie("")},[M]),a.useEffect(()=>{try{const g=localStorage.getItem("unit_structure");g&&re(JSON.parse(g))}catch{}},[S]),a.useEffect(()=>{const g=(S==null?void 0:S.uic)||"";if(!g){Pe([]),ee([]);return}ss(g).then(oe=>{Pe(oe||[]),ee(oe||[])}).catch(()=>{Pe([]),ee([])})},[S]),a.useEffect(()=>{const g=(S==null?void 0:S.uic)||"",oe=I||"";if(!g||!oe){u([]);return}It(g,oe).then(fe=>u(fe||[])).catch(()=>u([]))},[S,I]),a.useEffect(()=>{const g=(S==null?void 0:S.uic)||"",oe=M||"";if(!g||!oe){de([]);return}It(g,oe).then(fe=>de(fe||[])).catch(()=>de([]))},[S,M]),a.useEffect(()=>{at().then(g=>{Ne(g)}).catch(()=>Ne([]))},[]),a.useEffect(()=>{const g=(S==null?void 0:S.uic)||"";if(!g){v(!1);return}const oe=he.some(fe=>!!fe.isUnitAdmin&&(fe.unitUic||"")===g);v(oe)},[S,he]),a.useEffect(()=>{if(S){!I&&n.company&&me.includes(n.company)&&T(String(n.company));const g=n.platoon;!k&&g&&Re.includes(g)&&G(String(g))}},[S,me,Re,I,k,n]);const Me=g=>/^[0-9]{10}$/.test(g),Te=(g,oe)=>{try{return he.some(fe=>String(fe.edipi)===String(g)&&String(fe.id)!==String(oe||""))}catch{return!1}},Ve=async g=>{var Ke,We;if(g.preventDefault(),W(null),N)return;if(!R.trim())return W({type:"error",message:"First name is required."});if(!D.trim())return W({type:"error",message:"Last name is required."});if(F&&!/^[A-Za-z]$/.test(F))return W({type:"error",message:"MI must be a single letter."});if(!w.trim())return W({type:"error",message:"Email is required."});if(!Me(String(z)))return W({type:"error",message:"EDIPI must be 10 digits."});if(!d)return W({type:"error",message:"Service is required."});if(!O)return W({type:"error",message:"Rank is required."});if(Te(String(z),n.id?String(n.id):void 0))return W({type:"error",message:"EDIPI already exists."});if(U==="COMPANY_REVIEWER"&&!M)return W({type:"error",message:"Role Company is required for Company Reviewer."});if(U==="PLATOON_REVIEWER"&&(!M||!ce))return W({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${R.trim()}`,F&&""+F.trim().toUpperCase(),`${D.trim()}`;let oe=n.id?String(n.id):`usr-${Date.now()}`,fe=n.passwordHash||"";if(o==="create"){if(!_||_.length<8)return W({type:"error",message:"Password must be at least 8 characters."});if(_!==ye)return W({type:"error",message:"Passwords do not match."});try{const{data:Se,error:He}=await ta(w.trim(),_);if(He){W({type:"error",message:`Failed to create auth user: ${String(He.message||He)}`});return}const Xe=(Ke=Se==null?void 0:Se.user)!=null&&Ke.id?String(Se.user.id):"";if(!Xe){W({type:"error",message:"Auth user ID missing after sign up."});return}oe=Xe}catch(Se){W({type:"error",message:`Failed to create auth user: ${String((Se==null?void 0:Se.message)||Se)}`});return}fe=await Pt(_)}else if(o==="edit"&&_){if(_.length<8)return W({type:"error",message:"Password must be at least 8 characters."});if(_!==ye)return W({type:"error",message:"Passwords do not match."});fe=await Pt(_)}const De={id:oe,firstName:R.trim(),lastName:D.trim(),mi:F?F.trim().toUpperCase():void 0,email:w.trim(),edipi:z,service:d,rank:O,role:U,company:I||"N/A",unit:(S==null?void 0:S.unitName)||"N/A",unitUic:S==null?void 0:S.uic,passwordHash:fe,isUnitAdmin:o==="create"&&S&&!ge?!0:V,roleCompany:M||void 0,rolePlatoon:ce||void 0,platoon:k||"N/A"};try{const Se=await Ge({id:De.id,email:De.email,rank:De.rank,firstName:De.firstName,lastName:De.lastName,mi:De.mi,service:De.service,role:De.role,unitUic:De.unitUic,unit:(S==null?void 0:S.unitName)||"N/A",company:De.company,isUnitAdmin:!!De.isUnitAdmin,edipi:String(De.edipi),passwordHash:fe,platoon:k||"N/A",roleCompany:M||void 0,rolePlatoon:ce||void 0});if(!Se.ok){W({type:"error",message:`Failed to save profile: ${String(((We=Se==null?void 0:Se.error)==null?void 0:We.message)||(Se==null?void 0:Se.error)||"unknown")}`});return}W({type:"success",message:n.id?"Profile updated.":S&&!ge?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),t==null||t(De)}catch{W({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:o==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:Ve,className:"space-y-6",children:[o==="create"&&S&&!ge&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:S.unitName})," (UIC ",S.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:D,onChange:g=>L(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:R,onChange:g=>C(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:F,maxLength:1,onChange:g=>Z(g.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:w,onChange:g=>J(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:z,onChange:g=>B(g.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:d,onChange:g=>te(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(Yt).map(g=>e.jsx("option",{value:g,children:g},g))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:O,onChange:g=>P(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),p.map(g=>e.jsx("option",{value:g,children:g},g))]})]}),o==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:_,onChange:g=>xe(g.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:ye,onChange:g=>ve(g.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N})]})]}):e.jsx(e.Fragment,{})]})]}),Ee&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:_,onChange:g=>xe(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:ye,onChange:g=>ve(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>je(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>je(!1),children:"Save"})]})]})}),o==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:U,onChange:g=>f(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:sa.map(g=>e.jsx("option",{value:g,children:g},g))})}),e.jsx("div",{children:e.jsxs("select",{value:M||String(n.roleCompany||""),onChange:g=>ae(g.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Ae.length?"Select company":"No companies configured"}),Ae.map(g=>e.jsx("option",{value:g,children:g},g))]})}),e.jsx("div",{children:e.jsxs("select",{value:ce||String(n.rolePlatoon||""),onChange:g=>ie(g.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:pe.length?"Select platoon":"No platoons configured"}),pe.map(g=>e.jsx("option",{value:g,children:g},g))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:V,onChange:g=>h(g.target.checked),disabled:N||!E}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(n==null?void 0:n.isCommandStaff)||U==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(ea,{onUnitSelect:g=>y(g),selectedUnit:S})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:I||String(n.company||""),onChange:g=>T(g.target.value),disabled:N||!S||me.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:me.length?"Select company":"No companies configured"}),me.map(g=>e.jsx("option",{value:g,children:g},g))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:k||String(n.platoon||""),onChange:g=>G(g.target.value),disabled:N||!S||!I||Re.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Re.length?"Select platoon":"No platoons configured"}),Re.map(g=>e.jsx("option",{value:g,children:g},g))]})]})]})})]}),Q&&e.jsx("div",{className:`p-3 rounded-lg border ${Q.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:Q.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[o==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>je(!0),disabled:N,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:N,children:o==="edit"?"Save":"Create Profile"})]})]})]})},aa=a.memo(function({user:n,onClose:o}){const N=()=>{const m=Be.find(R=>R.uic===n.unitUic),E=m?m.unitName:n.unit;if(n.isUnitAdmin||n.role==="COMMANDER")return E||"â€”";if(n.role==="COMPANY_REVIEWER")return n.company&&n.company!=="N/A"?n.company:"â€”";if(n.role==="PLATOON_REVIEWER"){const R=n.company&&n.company!=="N/A"?n.company:"",C=n.platoon&&n.platoon!=="N/A"?n.platoon:"",D=[R,C].filter(Boolean);return D.length?D.join(" / "):"â€”"}return"â€”"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:o,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:o,children:"âœ•"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[n.rank," ",n.lastName,", ",n.firstName,n.mi?` ${n.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:n.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:n.edipi||"â€”"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:n.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:n.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:N()})]}),n.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),n.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:o,children:"Close"})})]})})}),na=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],ra=()=>{const[t,n]=a.useState(null),[o,N]=a.useState(void 0),[m,E]=a.useState({}),[R,C]=a.useState({}),[D,L]=a.useState({}),[F,Z]=a.useState({}),[w,J]=a.useState(""),[z,B]=a.useState(""),[d,te]=a.useState(""),[O,P]=a.useState(""),[U,f]=a.useState(""),[V,h]=a.useState([]),[I,T]=a.useState(null),[k,G]=a.useState(""),S=a.useRef(null),[y,Q]=a.useState(null),[W,X]=a.useState(null),[re,_]=a.useState(""),[xe,ye]=a.useState(void 0),[ve,he]=a.useState(void 0),[Ne,ge]=a.useState(void 0),[v,M]=a.useState(void 0),[ae,ce]=a.useState(void 0),[ie,Ee]=a.useState(void 0),[je,be]=a.useState([]),[Pe,we]=a.useState([]),[u,j]=a.useState(""),[ee,ne]=a.useState("unit"),[de,p]=a.useState([]),[A,i]=a.useState(!1),[l,q]=a.useState(!1),[se,le]=a.useState(!1),[me,Re]=a.useState("admin"),[Ae,pe]=a.useState(!0),[Me,Te]=a.useState(null),[Ve,g]=a.useState(0),oe=a.useRef(!1);a.useEffect(()=>{y&&me==="admin"&&!oe.current&&(!xe&&y.company&&y.company!=="N/A"&&(ye(y.company),ge(y.company)),!ve&&y.platoon&&y.platoon!=="N/A"&&(he(y.platoon),M(y.platoon)),!ae&&y.roleCompany&&y.roleCompany!=="N/A"&&ce(y.roleCompany),!ie&&y.rolePlatoon&&y.rolePlatoon!=="N/A"&&Ee(y.rolePlatoon),oe.current=!0)},[y,me]),a.useEffect(()=>{try{const s=localStorage.getItem("unit_structure");s&&E(JSON.parse(s))}catch{}try{const s=localStorage.getItem("unit_structure"),r={},x={},$={};if(s){const Y=JSON.parse(s);for(const H of Object.keys(Y||{})){const K=Y[H];K&&Array.isArray(K._sections)&&(r[H]=K._sections),K&&Array.isArray(K._commandSections)&&(x[H]=K._commandSections),K&&K._platoonSectionMap&&typeof K._platoonSectionMap=="object"&&($[H]=K._platoonSectionMap)}}else(async()=>{try{const Y=await ft();for(const H of Object.keys(Y||{})){const K=Y[H];K&&Array.isArray(K._sections)&&(r[H]=K._sections),K&&Array.isArray(K._commandSections)&&(x[H]=K._commandSections),K&&K._platoonSectionMap&&typeof K._platoonSectionMap=="object"&&($[H]=K._platoonSectionMap)}E(Y)}catch{}})();C(r),L(x),Z($)}catch{}(async()=>{pe(!0),Te(null);try{const s=await bt();if(s.error)throw new Error(s.error);h(s.data),g(s.data.length)}catch(s){const r=(s==null?void 0:s.message)||"Unknown error fetching users";console.error("[AdminPanel] Failed to fetch users:",r),Te(r),h([]),g(0)}finally{pe(!1)}})();try{const s=localStorage.getItem("currentUser");if(s){const r=JSON.parse(s);if(n(r),r.unitUic){const x=Be.find($=>$.uic===r.unitUic);x&&N(x)}}}catch{}},[]),a.useEffect(()=>{try{if(!o){const s=Object.keys(m||{});if(s.length){const r=s[0],x=m[r]||{},Y=Be.find(H=>H.uic===r)||{ruc:String(x._ruc||""),mcc:String(x._mcc||""),uic:r,unitName:String(x._unitName||r),streetAddress:String(x._streetAddress||"")};N(Y)}}}catch{}},[m]),a.useEffect(()=>{const s=(y==null?void 0:y.unitUic)||"";if(!s){be([]);return}ss(s).then(r=>be(r||[])).catch(()=>be([]))},[y]),a.useEffect(()=>{const s=(y==null?void 0:y.unitUic)||"",r=ae||"";if(!s||!r){we([]);return}It(s,r).then(x=>we(x||[])).catch(()=>we([]))},[y,ae]);const fe=a.useMemo(()=>{const s=(o==null?void 0:o.uic)||"";if(!s)return[];const r=m[s]||{};return Object.keys(r).filter(x=>!x.startsWith("_")&&Array.isArray(r[x]))},[o,m]),De=a.useMemo(()=>{var x;const s=(o==null?void 0:o.uic)||"";if(!s||!w)return[];const r=(x=m[s])==null?void 0:x[w];return Array.isArray(r)?r:[]},[o,w,m]),Ke=a.useMemo(()=>{const s=(o==null?void 0:o.uic)||"";return s?R[s]||[]:[]},[o,R]),We=a.useMemo(()=>{const s=(o==null?void 0:o.uic)||"";return s?D[s]||[]:[]},[o,D]),Se=a.useMemo(()=>{const s=(y==null?void 0:y.unitUic)||"";if(!s)return[];const r=je;if(r&&r.length)return r;const x=m[s]||{};return Object.keys(x).filter($=>!$.startsWith("_")&&Array.isArray(x[$]))},[y,m,je]),He=a.useMemo(()=>{var $;const s=(y==null?void 0:y.unitUic)||"",r=Ne||"";if(!s||!r)return[];const x=($=m[s])==null?void 0:$[r];return Array.isArray(x)?x:[]},[y,Ne,m]),Xe=a.useMemo(()=>{var Y,H;const s=(y==null?void 0:y.unitUic)||"",r=ae||"";if(!r)return[];const x=Pe;if(x&&x.length>0)return x;if(s){const K=(Y=m[s])==null?void 0:Y[r];if(Array.isArray(K)&&K.length>0)return K}const $=(o==null?void 0:o.uic)||"";if($&&$!==s){const K=(H=m[$])==null?void 0:H[r];if(Array.isArray(K))return K}return[]},[y,ae,m,Pe,o]),nt=a.useMemo(()=>{const s=Se.slice(),r=xe||(y&&y.company!=="N/A"?y.company:"");return r&&!s.includes(r)?[r,...s]:s},[Se,xe,y]);a.useMemo(()=>{const s=He.slice(),r=v||(y&&y.platoon&&y.platoon!=="N/A"?y.platoon:"");return r&&!s.includes(r)?[r,...s]:s},[He,v,y]);const lt=a.useMemo(()=>{const s=Xe.slice(),r=ie||(y&&y.rolePlatoon&&y.rolePlatoon!=="N/A"?y.rolePlatoon:"");return r&&!s.includes(r)?[r,...s]:s},[Xe,ie,y]),Ue=a.useMemo(()=>o?V.filter(s=>{const r=String(s.unitUic||"").trim().toUpperCase(),x=String(o.uic||"").trim().toUpperCase(),$=String(s.unit||"").trim().toLowerCase(),Y=String(o.unitName||"").trim().toLowerCase();return r&&r===x||$&&$===Y}):V,[V,o]),dt=a.useMemo(()=>{if(!k)return Ue;const s=k.toLowerCase();return Ue.filter(r=>(r.email??"").toLowerCase().includes(s)||(r.lastName??"").toLowerCase().includes(s))},[Ue,k]),yt=()=>{try{if(o){const s=o.uic,r={...m};r[s]=r[s]||{},r[s]._mcc=o.mcc||r[s]._mcc||"",r[s]._unitName=o.unitName||r[s]._unitName||"",E(r),localStorage.setItem("unit_structure",JSON.stringify(r)),(async()=>{try{if(navigator.sendBeacon){const $=new Blob([JSON.stringify(r)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",$),T({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist unit structure."})}})()}else{const s=JSON.stringify(m);localStorage.setItem("unit_structure",s),(async()=>{try{if(navigator.sendBeacon){const x=new Blob([s],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",x),T({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:s,keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist unit structure."})}})()}}catch{T({type:"error",message:"Failed to save unit structure."})}},mt=()=>{try{if(!o)return;const s=o.uic,r={...m};r[s]=r[s]||{},r[s]._sections=R[s]||[],r[s]._mcc=o.mcc||r[s]._mcc||"",r[s]._unitName=o.unitName||r[s]._unitName||"",E(r),localStorage.setItem("unit_structure",JSON.stringify(r)),(async()=>{try{if(navigator.sendBeacon){const $=new Blob([JSON.stringify(r)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",$),T({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist unit sections."})}})()}catch{T({type:"error",message:"Failed to save unit sections."})}},rt=()=>{try{if(!o)return;const s=o.uic,r={...m};r[s]=r[s]||{},r[s]._commandSections=D[s]||[],r[s]._mcc=o.mcc||r[s]._mcc||"",r[s]._unitName=o.unitName||r[s]._unitName||"",E(r),localStorage.setItem("unit_structure",JSON.stringify(r)),(async()=>{try{if(navigator.sendBeacon){const $=new Blob([JSON.stringify(r)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",$),T({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist command sections."})}})()}catch{T({type:"error",message:"Failed to save command sections."})}},ut=()=>{try{if(!o)return;const s=o.uic,r={...m};r[s]=r[s]||{},r[s]._platoonSectionMap=F[s]||{},r[s]._mcc=o.mcc||r[s]._mcc||"",r[s]._unitName=o.unitName||r[s]._unitName||"",E(r),localStorage.setItem("unit_structure",JSON.stringify(r)),(async()=>{try{if(navigator.sendBeacon){const $=new Blob([JSON.stringify(r)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",$),T({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),keepalive:!0})).ok)throw new Error("persist_failed");T({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{T({type:"error",message:"Failed to persist links."})}})()}catch{T({type:"error",message:"Failed to save links."})}},vt=()=>{if(!o||!z.trim())return;const s=o.uic,r={...m};r[s]=r[s]||{},r[s][z.trim()]||(r[s][z.trim()]=[],E(r),J(z.trim()),B(""))},Nt=s=>{if(!o)return;const r=o.uic,x={...m};x[r]&&(delete x[r][s],E(x),w===s&&J(""))},Ce=()=>{if(!o||!w||!d.trim())return;const s=o.uic,r={...m};r[s]=r[s]||{},r[s][w]=r[s][w]||[],r[s][w].includes(d.trim())||(r[s][w]=[...r[s][w],d.trim()],E(r),te(""))},jt=s=>{if(!o||!w)return;const r=o.uic,x={...m};x[r][w]=(x[r][w]||[]).filter($=>$!==s),E(x)},wt=()=>{if(!o||!O.trim())return;const s=o.uic,r={...R};r[s]=r[s]||[],r[s].includes(O.trim())||(r[s]=[...r[s],O.trim()],C(r),P(""))},xt=s=>{if(!o)return;const r=o.uic,x={...R};x[r]=(x[r]||[]).filter($=>$!==s),C(x)},St=()=>{if(!o||!U.trim())return;const s=o.uic,r={...D};r[s]=r[s]||[],r[s].includes(U.trim())||(r[s]=[...r[s],U.trim()],L(r),f(""))},c=s=>{if(!o)return;const r=o.uic,x={...D};x[r]=(x[r]||[]).filter($=>$!==s),L(x)},b=()=>{const s=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],r=V.map(K=>[K.firstName,K.mi||"",K.lastName,K.email,K.edipi,K.service,K.rank,K.role,K.company,K.unit,K.unitUic||""].map(ue=>{const ke=String(ue??"");return ke.includes(",")||ke.includes('"')||ke.includes(`
`)?'"'+ke.replace(/"/g,'""')+'"':ke}).join(",")),x="\uFEFF"+[s.join(","),...r].join(`
`),$=new Blob([x],{type:"text/csv;charset=utf-8"}),Y=URL.createObjectURL($),H=document.createElement("a");H.href=Y,H.download="users-export.csv",H.click(),URL.revokeObjectURL(Y)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${ee==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>ne("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${ee==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>ne("users"),children:"User Administration"})]})})}),ee==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:o?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:o.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",o.uic," | RUC: ",o.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:yt,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:z,onChange:s=>B(s.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:vt,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[fe.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>J(s),children:s}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Nt(s),children:"Remove"})]},s)),fe.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",w?`â€¢ ${w}`:""]}),o&&w&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ut,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:d,onChange:s=>te(s.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!w}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:Ce,disabled:!w,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[De.map(s=>{var r,x;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:s})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:((x=(r=F[(o==null?void 0:o.uic)||""])==null?void 0:r[w])==null?void 0:x[s])||"",onChange:$=>{const Y=(o==null?void 0:o.uic)||"";Z(H=>{const K={...H};return K[Y]=K[Y]||{},K[Y][w]=K[Y][w]||{},K[Y][w][s]=$.target.value,K})},children:[e.jsx("option",{value:"",children:"Link to section"}),(R[(o==null?void 0:o.uic)||""]||[]).map($=>e.jsx("option",{value:$,children:$},$))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>jt(s),children:"Remove"})]})]},s)}),De.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:mt,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:O,onChange:s=>P(s.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:wt,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Ke.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:s}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>xt(s),children:"Remove"})]},s)),Ke.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:rt,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:U,onChange:s=>f(s.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:St,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[We.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:s}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>c(s),children:"Remove"})]},s)),We.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),ee==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),Me&&e.jsxs("div",{className:"mb-4 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:[e.jsx("strong",{children:"Error loading users:"})," ",Me]}),Ae&&e.jsx("div",{className:"mb-4 p-3 border border-blue-200 bg-blue-50 text-blue-800 rounded",children:"Loading users..."}),!Ae&&!Me&&Ve>0&&Ue.length===0&&e.jsxs("div",{className:"mb-4 p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:[e.jsx("strong",{children:"Note:"})," ",Ve," user(s) found in database, but none match your unit (",(o==null?void 0:o.unitName)||"No unit selected",", UIC: ",(o==null?void 0:o.uic)||"N/A",").",e.jsx("br",{}),e.jsx("span",{className:"text-sm",children:"Users may be assigned to different units."})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[dt.map(s=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[s.lastName,", ",s.firstName,s.mi?` ${s.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:s.email}),e.jsx("td",{className:"py-2 px-3",children:s.edipi}),e.jsx("td",{className:"py-2 px-3",children:s.service}),e.jsx("td",{className:"py-2 px-3",children:s.rank}),e.jsx("td",{className:"py-2 px-3",children:s.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const r=Be.find($=>$.uic===s.unitUic),x=r?r.unitName:s.unit;if(s.isUnitAdmin||s.role==="COMMANDER")return x||"â€”";if(s.role==="COMPANY_REVIEWER")return s.company&&s.company!=="N/A"?s.company:"â€”";if(s.role==="PLATOON_REVIEWER"){const $=s.company&&s.company!=="N/A"?s.company:"",Y=s.platoon&&s.platoon!=="N/A"?s.platoon:"",H=[$,Y].filter(Boolean);return H.length?H.join(" / "):"â€”"}return"â€”"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>X(s),children:"View"}),((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{Re("admin"),Q(s),_(s.role??"MEMBER"),ye(s.company!=="N/A"?s.company:void 0),ge(s.company!=="N/A"?s.company:void 0),he(s.platoon&&s.platoon!=="N/A"?s.platoon:void 0),M(s.platoon&&s.platoon!=="N/A"?s.platoon:void 0),j(typeof s.commandOrder=="number"?String(s.commandOrder):""),q(!!s.isUnitAdmin),le(!!s.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{h(r=>r.filter(x=>x.id!==s.id));try{localStorage.removeItem(`fs/users/${s.id}.json`)}catch(r){console.error("Failed to remove user from localStorage",r)}},children:"Delete"})]})})]},s.id)),dt.length===0&&!Ae&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:Me?"Failed to load users - check console for details":Ve===0?"No users found in database":k?"No users match your search":"No users in this unit"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:S,type:"text",placeholder:"Filter users...",value:k,onChange:s=>G(s.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var s;return(s=S.current)==null?void 0:s.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:b,children:"Export All"})]})]}),W&&e.jsx(aa,{user:W,onClose:()=>X(null)}),y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>Q(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>Q(null),children:"âœ•"})]}),me==="profile"&&t&&y&&t.edipi===y.edipi&&e.jsx(os,{mode:"edit",initial:y,readOnly:!1,onSaved:s=>{h(r=>r.map(x=>x.edipi===s.edipi?s:x)),Q(null),T({type:"success",message:"Profile updated."})}}),me==="admin"&&((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:re,onChange:s=>{const r=s.target.value;_(r),r==="COMMANDER"&&(ye(void 0),he(void 0))},className:"w-full px-3 py-2 border rounded",children:na.map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:ae||"",onChange:s=>ce(s.target.value||void 0),disabled:!re.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:nt.length?"Select company":"No companies configured"}),nt.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:ie||"",onChange:s=>Ee(s.target.value||void 0),disabled:!re.includes("REVIEW")||!ae,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:lt.length?"Select platoon":"No platoons configured"}),lt.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:l,onChange:s=>q(s.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:se,disabled:re==="COMMANDER",onChange:async s=>{const r=s.target.checked;le(r);try{if(y&&!(await Ge({id:y.id,email:y.email,rank:y.rank,firstName:y.firstName,lastName:y.lastName,mi:y.mi,service:y.service,role:y.role,unitUic:y.unitUic,unit:y.unit,company:y.company,isUnitAdmin:!!y.isUnitAdmin,isCommandStaff:r,edipi:y.edipi,passwordHash:y.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})]}),de.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:de.map((s,r)=>e.jsx("div",{className:"text-sm",children:s},r))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{Q(null),oe.current=!1,p([]),i(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${A?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":A,disabled:A,onClick:async()=>{var $;if(!y)return;const s=[];if(re==="COMPANY_REVIEWER"&&!xe&&s.push("Company is required for Company Reviewer."),re==="PLATOON_REVIEWER"&&(!xe||!ve)&&s.push("Company and Platoon are required for Platoon Reviewer."),p(s),s.length)return;i(!0);const r=(($=Be.find(Y=>Y.uic===y.unitUic))==null?void 0:$.unitName)||"N/A",x={...y,role:re,isUnitAdmin:l,isCommandStaff:re==="COMMANDER"?!1:se,company:Ne||"N/A",unit:r,platoon:v||"N/A",roleCompany:re.includes("REVIEW")?ae||"N/A":void 0,rolePlatoon:re.includes("REVIEW")?ie||"N/A":void 0};try{localStorage.setItem(`fs/users/${x.edipi}.json`,JSON.stringify(x))}catch{}try{if(!(await Ge({id:x.id,email:x.email,rank:x.rank,firstName:x.firstName,lastName:x.lastName,mi:x.mi,service:x.service,role:x.role,unitUic:x.unitUic,unit:x.unit,company:x.company,isUnitAdmin:!!x.isUnitAdmin,isCommandStaff:!!x.isCommandStaff,edipi:x.edipi,passwordHash:x.passwordHash,roleCompany:x.roleCompany,rolePlatoon:x.rolePlatoon,platoon:x.platoon})).ok)throw new Error("persist_failed")}catch{i(!1),T({type:"error",message:"Failed to save administrative changes."});return}h(Y=>Y.map(H=>H.edipi===x.edipi?x:H));try{t&&t.edipi===x.edipi&&(localStorage.setItem("currentUser",JSON.stringify(x)),n(x))}catch{}Q(null),oe.current=!1,i(!1),T({type:"success",message:"Administrative changes saved."})},children:[A&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),I&&e.jsx("div",{className:`p-3 rounded-lg border ${I.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:I.message})]})};function ia(){const[t,n]=a.useState([]),[o,N]=a.useState(null),[m,E]=a.useState({}),[R,C]=a.useState({}),[D,L]=a.useState([]),[F,Z]=a.useState("unit"),[w,J]=a.useState("assigned"),[z,B]=a.useState([]),[d,te]=a.useState(""),[O,P]=a.useState([]),[U,f]=a.useState(""),V=()=>{at().then(p=>n(p)).catch(()=>n([]))},h=()=>{gt().then(p=>L(p)).catch(()=>L([]))},I=()=>{N(null),V(),h()};a.useEffect(()=>{I(),as().then(p=>B(p)),Xt().then(p=>P(p))},[F,w]);const T=a.useMemo(()=>{const p={};for(const A of t)A.isUnitAdmin&&A.unitUic&&(p[A.unitUic]=A);return p},[t]),k=a.useMemo(()=>{const p=new Set;return Be.filter(A=>p.has(A.uic)?!1:(p.add(A.uic),!0))},[]),G=a.useMemo(()=>{const p={};for(const A of t)if(A.isInstallationAdmin&&A.installationId){const i=A.installationId;p[i]=p[i]||[],p[i].push(A)}return p},[t]),S=p=>t.filter(A=>A.unitUic===p.uic||!A.unitUic&&A.unit===p.unitName),y=async p=>{const A=m[p.uic];if(!A)return;const i=t.find(q=>q.id===A);if(!i)return;const l={...i,isUnitAdmin:!0,unitUic:p.uic,unit:p.unitName,company:"N/A"};try{if(!(await Ge({id:l.id,email:l.email,rank:l.rank,firstName:l.firstName,lastName:l.lastName,mi:l.mi,service:l.service,role:l.role,unitUic:l.unitUic,unit:l.unit,company:l.company,isUnitAdmin:!!l.isUnitAdmin,isInstallationAdmin:!!l.isInstallationAdmin,isCommandStaff:!!l.isCommandStaff,edipi:l.edipi})).ok){N({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}n(q=>q.map(se=>se.id===l.id?l:se)),N({type:"success",message:`Assigned ${l.rank} ${l.lastName} as admin for ${p.unitName}.`})},Q=a.useMemo(()=>k.filter(p=>!!T[p.uic]),[k,T]);a.useMemo(()=>(Array.isArray(t)?t:[]).filter(p=>!!p.isHqmcAdmin),[t]);const W=a.useMemo(()=>k.filter(p=>!T[p.uic]),[k,T]),X=a.useMemo(()=>(Array.isArray(z)?z:[]).filter(p=>{var A;return(A=G[p.id])==null?void 0:A.length}),[z,G]),re=a.useMemo(()=>(Array.isArray(z)?z:[]).filter(p=>{var A;return!((A=G[p.id])!=null&&A.length)}),[z,G]),_=a.useMemo(()=>{const p={};for(const A of Array.isArray(t)?t:[])if(A.isHqmcAdmin&&A.hqmcDivision){const i=A.hqmcDivision;p[i]=p[i]||[],p[i].push(A)}return p},[t]),xe=a.useMemo(()=>(Array.isArray(O)?O:[]).filter(p=>{var A;return(A=_[p.code])==null?void 0:A.length}),[O,_]);a.useMemo(()=>{const p=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return(Array.isArray(D)?D:[]).filter(A=>p.includes(String(A.currentStage||"")))},[D]);const[ye,ve]=a.useState(1),[he,Ne]=a.useState(10),ge=Q.length,v=Math.max(1,Math.ceil(ge/(he||1))),M=Math.min(ye,v),ae=ge===0?0:(M-1)*he+1,ce=ge===0?0:Math.min(ae+he-1,ge),ie=Q.slice((M-1)*he,(M-1)*he+he),[Ee,je]=a.useState(1),[be,Pe]=a.useState(10),we=W.length,u=Math.max(1,Math.ceil(we/(be||1))),j=Math.min(Ee,u),ee=we===0?0:(j-1)*be+1,ne=we===0?0:Math.min(ee+be-1,we),de=W.slice((j-1)*be,(j-1)*be+be);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${F==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Z("unit"),J("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${F==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Z("installation"),J("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${F==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Z("hqmc"),J("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${w==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>J("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${w==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>J("missing"),children:"Missing"})]}),F==="installation"&&w==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[X.map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.name}),e.jsx("td",{className:"py-2 px-3",children:(G[p.id]||[]).map(A=>`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`).join(" â€¢ ")})]},p.id)),X.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),F==="installation"&&w==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[re.map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:R[p.id]||"",onChange:A=>C(i=>({...i,[p.id]:A.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(A=>e.jsx("option",{value:A.id,children:`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`},A.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!R[p.id],onClick:async()=>{const A=R[p.id],i=t.find(q=>q.id===A);if(!i)return;const l={...i,isInstallationAdmin:!0,installationId:p.id};try{if(!(await Ge({id:l.id,email:l.email,rank:l.rank,firstName:l.firstName,lastName:l.lastName,mi:l.mi,service:l.service,role:l.role,unitUic:l.unitUic,unit:l.unit,company:l.company,isUnitAdmin:!!l.isUnitAdmin,isInstallationAdmin:!!l.isInstallationAdmin,isCommandStaff:!!l.isCommandStaff,edipi:l.edipi,installationId:l.installationId})).ok){N({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}n(q=>q.map(se=>se.id===l.id?l:se)),N({type:"success",message:`Assigned ${l.rank} ${l.lastName} as installation admin.`})},children:"Assign"})})]},p.id)),re.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),F==="unit"&&w==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[ie.map(p=>{const A=T[p.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.unitName}),e.jsx("td",{className:"py-2 px-3",children:p.uic}),e.jsx("td",{className:"py-2 px-3",children:`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`})]},p.uic)}),Q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(Mt,{currentPage:M,totalPages:v,totalItems:ge,pageSize:he,startIndex:ae,endIndex:ce,onPageChange:p=>ve(p),onPageSizeChange:p=>{Ne(p),ve(1)},onNext:()=>ve(Math.min(M+1,v)),onPrevious:()=>ve(Math.max(M-1,1)),onFirst:()=>ve(1),onLast:()=>ve(v),canGoNext:M<v,canGoPrevious:M>1,pageSizeOptions:[5,10,25,50]})})]}),F==="unit"&&w==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[de.map(p=>{const A=S(p);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.unitName}),e.jsx("td",{className:"py-2 px-3",children:p.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:m[p.uic]||"",onChange:i=>E(l=>({...l,[p.uic]:i.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:A.length?"Select user":"No eligible users"}),A.map(i=>e.jsx("option",{value:i.id,children:`${i.rank} ${i.lastName}, ${i.firstName}${i.mi?` ${i.mi}`:""}`},i.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!m[p.uic],onClick:()=>y(p),children:"Assign"})})]},p.uic)}),W.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(Mt,{currentPage:j,totalPages:u,totalItems:we,pageSize:be,startIndex:ee,endIndex:ne,onPageChange:p=>je(p),onPageSizeChange:p=>{Pe(p),je(1)},onNext:()=>je(Math.min(j+1,u)),onPrevious:()=>je(Math.max(j-1,1)),onFirst:()=>je(1),onLast:()=>je(u),canGoNext:j<u,canGoPrevious:j>1,pageSizeOptions:[5,10,25,50]})})]}),F==="hqmc"&&w==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[xe.map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[p.code," â€” ",p.name]}),e.jsx("td",{className:"py-2 px-3",children:(_[p.code]||[]).map(A=>`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`).join(" â€¢ ")})]},p.code)),xe.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),F==="hqmc"&&w==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[O.filter(p=>{var A;return!((A=_[p.code])!=null&&A.length)}).map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[p.code," â€” ",p.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:R[`hqmc_${p.code}`]||"",onChange:A=>C(i=>({...i,[`hqmc_${p.code}`]:A.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(A=>e.jsx("option",{value:A.id,children:`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`},A.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!R[`hqmc_${p.code}`],onClick:async()=>{const A=R[`hqmc_${p.code}`],i=t.find(q=>q.id===A);if(!i)return;const l={...i,isHqmcAdmin:!0,hqmcDivision:p.code};try{if(!(await Ge({id:l.id,email:l.email,rank:l.rank,firstName:l.firstName,lastName:l.lastName,mi:l.mi,service:l.service,role:l.role,unitUic:l.unitUic,unit:l.unit,company:l.company,isUnitAdmin:!!l.isUnitAdmin,isInstallationAdmin:!!l.isInstallationAdmin,isCommandStaff:!!l.isCommandStaff,isHqmcAdmin:!!l.isHqmcAdmin,hqmcDivision:l.hqmcDivision,edipi:l.edipi})).ok){N({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}n(q=>q.map(se=>se.id===l.id?l:se)),N({type:"success",message:`Assigned ${l.rank} ${l.lastName} as HQMC admin for ${p.code}.`})},children:"Assign"})})]},p.code)),O.filter(p=>{var A;return!((A=_[p.code])!=null&&A.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),o&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${o.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:o.message})]})})}const Gt=!0,oa=({onLoggedIn:t,onCreateAccount:n})=>{const[o,N]=a.useState(""),[m,E]=a.useState(""),[R,C]=a.useState(null),[D,L]=a.useState(!0),[F,Z]=a.useState(!0);hs.useEffect(()=>{},[]);const w=async J=>{J.preventDefault(),C(null);try{const z=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,B=/^[0-9]{10}$/.test(o),d=Gt?z.test(o.trim().toLowerCase())||B:z.test(o.trim().toLowerCase()),te=m.length>=6;if(L(d),Z(te),!d){C({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!te){C({type:"error",message:"Password must be at least 6 characters."});return}let O=null,P=null,U=o.trim().toLowerCase();if(Gt&&B){const{user:G,error:S}=await Rt(String(o));O=G,P=S,U=String((O==null?void 0:O.email)||"")}else if(z.test(U)){const{user:G,error:S}=await Ft(U);O=G,P=S}else{C({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(P){C({type:"error",message:`Database Error: ${P}`});return}if(!O||!U){C({type:"error",message:"Account not found."});return}const f=String(O.passwordHash||O.password_hash||"").trim();if(!f){C({type:"error",message:"No password set for this user."});return}const V=await Pt(m);if(!(/^[0-9a-f]{64}$/i.test(f)?f.toLowerCase()===V.toLowerCase():f===m)){C({type:"error",message:"Invalid credentials."});return}const{user:T,error:k}=await Ft(U);if(k){C({type:"error",message:`Profile Error: ${k}`});return}if(!T){console.error("[Login] User profile not found after successful password verification",{emailForLogin:U}),C({type:"error",message:"User profile not found."});return}C({type:"success",message:"Logged in."}),t(T)}catch(z){console.error("[Login] Login failed:",z),C({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:w,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:o,onChange:J=>N(J.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${D?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!D}),!D&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:m,onChange:J=>E(J.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${F?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!F}),!F&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),R&&e.jsx("div",{className:`p-3 rounded-lg border ${R.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:R.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:n,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!D||!F,children:"Login"})]})]})]})},Jt=""+new URL("logo-DLcHofKE.png",import.meta.url).href,ca=({currentUser:t,hasSectionDashboard:n,hasCommandDashboard:o,hasInstallationSectionDashboard:N=!1,hasInstallationCommandDashboard:m=!1,hasHQMCSectionDashboard:E=!1,hasHQMCApproverDashboard:R=!1,onManageProfile:C,onLogout:D,onNavigate:L,isLogin:F=!1})=>{const[Z,w]=a.useState(!1),[J,z]=a.useState(!1),B=a.useRef(null);return a.useEffect(()=>{const d=O=>{if(!Z)return;const P=B.current;P&&O.target&&!P.contains(O.target)&&w(!1)},te=O=>{O.key==="Escape"&&w(!1)};return document.addEventListener("mousedown",d),document.addEventListener("touchstart",d,{passive:!0}),document.addEventListener("keydown",te),()=>{document.removeEventListener("mousedown",d),document.removeEventListener("touchstart",d),document.removeEventListener("keydown",te)}},[Z]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:F?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:Jt,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:Jt,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:t?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[t.rank," ",t.lastName,t.lastName?",":""," ",t.firstName,t.mi?` ${t.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[t.service," â€¢ ",t.role,(()=>{const d={PLATOON_REVIEWER:t.role_platoon,COMPANY_REVIEWER:t.role_company}[t.role];return d?` - ${d}`:null})()]}),(()=>{var U;const d=((U=Be.find(f=>f.uic===((t==null?void 0:t.unitUic)||"")))==null?void 0:U.unitName)||(t==null?void 0:t.unit)||"",te=t!=null&&t.company&&t.company!=="N/A"?t.company:t!=null&&t.user_company&&t.user_company!=="N/A"?t.user_company:null,O=t!=null&&t.platoon&&t.platoon!=="N/A"?t.platoon:t!=null&&t.user_platoon&&t.user_platoon!=="N/A"?t.user_platoon:null,P=[d||null,te,O].filter(Boolean);return P.length?e.jsx("div",{className:"text-xs text-white/70",children:P.join(" â€¢ ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:C,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:D,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),t&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>z(!J),children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),J&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{C(),z(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{D(),z(!1)},children:"Logout"})]})]}),!t&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>L("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:B,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":Z,onClick:()=>w(d=>!d),children:"Dashboards"}),e.jsxs("div",{className:`${Z?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:t&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("dashboard"),w(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(t==null?void 0:t.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("admin"),w(!1)},children:"Unit Admin"}),t&&!!t.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("appadmin"),w(!1)},children:"App Admin"}),t&&!!t.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("hqmc-admin"),w(!1)},children:"HQMC Admin"}),t&&!!t.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("installation"),w(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[t&&n&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("section"),w(!1)},children:"Unit Section Dashboard"}),o&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("command"),w(!1)},children:"Unit Command Dashboard"}),String((t==null?void 0:t.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("review"),w(!1)},children:"Unit Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[t&&N&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("installation-section"),w(!1)},children:"Installation Section Dashboard"}),t&&m&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("installation-command"),w(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[t&&(E||!!t.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("hqmc-section"),w(!1)},children:"HQMC Section Dashboard"}),t&&R&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{L("hqmc-approver"),w(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})},Le={SECTION:"perm_section",COMMAND:"perm_command",INST_SECTION:"perm_inst_section",INST_COMMAND:"perm_inst_command",HQMC_SECTION:"perm_hqmc_section",HQMC_APPROVER:"perm_hqmc_approver"},st=t=>{try{return localStorage.getItem(t)==="true"}catch(n){return console.error(`Failed to read from localStorage for key "${t}":`,n),!1}};function la(){const[t,n]=a.useState(null),[o,N]=a.useState("login"),[m,E]=a.useState(()=>{try{const h=localStorage.getItem("currentUser");return h?JSON.parse(h):null}catch(h){return console.error("Failed to parse user from localStorage:",h),null}}),[R,C]=a.useState("create"),[D,L]=a.useState(!1),[F,Z]=a.useState(()=>st(Le.SECTION)),[w,J]=a.useState(()=>st(Le.COMMAND)),[z,B]=a.useState(()=>st(Le.INST_SECTION)),[d,te]=a.useState(()=>st(Le.INST_COMMAND)),[O,P]=a.useState(()=>st(Le.HQMC_SECTION)),[U,f]=a.useState(()=>st(Le.HQMC_APPROVER)),V=gs();return a.useEffect(()=>{try{const I=new URLSearchParams(window.location.search).get("view");if(I==="admin"||I==="profile"||I==="dashboard"||I==="login"||I==="appadmin"||I==="hqmc-admin"||I==="hqmc-section"||I==="hqmc-approver"||I==="review"||I==="section"||I==="command"||I==="installation"||I==="installation-section"||I==="installation-command"||I==="documents"||I==="document-viewer"||I==="upload")N(I);else{const T=localStorage.getItem("currentView"),k=localStorage.getItem("currentUser");N(T&&k?T:"login")}}catch{N("login")}},[]),a.useEffect(()=>{m?localStorage.setItem("currentUser",JSON.stringify(m)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"),Object.values(Le).forEach(h=>{try{localStorage.removeItem(h)}catch(I){console.error(`Failed to remove item from localStorage for key "${h}":`,I)}}))},[m]),a.useEffect(()=>{if(!m)return;const h={[Le.SECTION]:F,[Le.COMMAND]:w,[Le.INST_SECTION]:z,[Le.INST_COMMAND]:d,[Le.HQMC_SECTION]:O,[Le.HQMC_APPROVER]:U};for(const[I,T]of Object.entries(h))try{localStorage.setItem(I,String(T))}catch(k){console.error(`Failed to set item in localStorage for key "${I}":`,k)}},[m,F,w,z,d,O,U]),a.useEffect(()=>{let h=!1;return(async()=>{try{const I=(m==null?void 0:m.id)||"";if(!I)return;const T=await ts(I);if(T&&!h){const k=(y,Q)=>y===!0||y===!1?y:Q||!1,G=(y,Q)=>y!=null?y||void 0:Q,S={...T,isAppAdmin:k(T.isAppAdmin,m==null?void 0:m.isAppAdmin),isUnitAdmin:k(T.isUnitAdmin,m==null?void 0:m.isUnitAdmin),isInstallationAdmin:k(T.isInstallationAdmin,m==null?void 0:m.isInstallationAdmin),isHqmcAdmin:k(T.isHqmcAdmin,m==null?void 0:m.isHqmcAdmin),isCommandStaff:k(T.isCommandStaff,m==null?void 0:m.isCommandStaff),installationId:G(T.installationId,m==null?void 0:m.installationId),hqmcDivision:G(T.hqmcDivision,m==null?void 0:m.hqmcDivision)};E(S),localStorage.setItem("currentUser",JSON.stringify(S))}}catch{}})(),()=>{h=!0}},[]),a.useEffect(()=>{o!=="login"&&m&&localStorage.setItem("currentView",o)},[o,m]),a.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const I=await ft();localStorage.setItem("unit_structure",JSON.stringify(I))}catch(h){console.error("Failed to load unit structure:",h)}})()},[]),a.useEffect(()=>{var h,I,T;if(m){try{const k=localStorage.getItem("unit_structure");if(k){const G=JSON.parse(k),S=(m==null?void 0:m.unitUic)||"",y=m!=null&&m.company&&m.company!=="N/A"?m.company:"",Q=m!=null&&m.platoon&&m.platoon!=="N/A"?m.platoon:"",W=((T=(I=(h=G==null?void 0:G[S])==null?void 0:h._platoonSectionMap)==null?void 0:I[y])==null?void 0:T[Q])||"";Z(!!W)}}catch(k){console.error("Failed to parse unit structure for section dashboard check",k)}J(!!(m!=null&&m.isCommandStaff)),(async()=>{try{const k=(m==null?void 0:m.installationId)||"";if(!k){B(!1),te(!1);return}const G=await as();try{localStorage.setItem("installations_cache",JSON.stringify(G))}catch{}const S=G==null?void 0:G.find(X=>X.id===k),y=(m==null?void 0:m.id)||"",Q=!!(S&&S.sectionAssignments&&Object.values(S.sectionAssignments).some(X=>Array.isArray(X)&&X.includes(y))),W=!!(S&&(S.commandSectionAssignments&&Object.values(S.commandSectionAssignments).some(X=>Array.isArray(X)&&X.includes(y))||S.commanderUserId&&String(S.commanderUserId)===y));B(Q),te(W)}catch{}})(),(async()=>{try{const k=String((m==null?void 0:m.hqmcDivision)||""),G=String((m==null?void 0:m.id)||"");if(!k||!G){P(!!(m!=null&&m.isHqmcAdmin)),f(!1);return}const{listHQMCSectionAssignmentsLegacy:S}=await bs(async()=>{const{listHQMCSectionAssignmentsLegacy:X}=await import("./db-B5DdF8Od.js").then(re=>re.A);return{listHQMCSectionAssignmentsLegacy:X}},__vite__mapDeps([0,1,2]),import.meta.url),y=await S(),Q=y.some(X=>X.division_code===k&&((X.reviewers||[]).includes(G)||(X.approvers||[]).includes(G))),W=y.some(X=>X.division_code===k&&(X.approvers||[]).includes(G));P(Q||!!(m!=null&&m.isHqmcAdmin)),f(W)}catch{m!=null&&m.isHqmcAdmin&&P(!0)}})()}},[m]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(ca,{currentUser:m,hasSectionDashboard:F,hasCommandDashboard:w,hasInstallationSectionDashboard:z,hasInstallationCommandDashboard:d,hasHQMCSectionDashboard:O,hasHQMCApproverDashboard:U,onManageProfile:()=>{C("edit"),N("profile"),V("/?view=profile")},onLogout:()=>{E(null),N("login"),V("/?view=login")},onNavigate:h=>{N(h),V(`/?view=${h}`)},isLogin:o==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:o==="profile"?e.jsx(os,{mode:R,initial:R==="edit"?m||{}:{},onSaved:h=>{E(h),N("dashboard"),V("/?view=dashboard")}}):o==="admin"?e.jsx(ra,{}):o==="appadmin"?e.jsx(ia,{}):o==="login"?e.jsx(oa,{onLoggedIn:h=>{E(h),N("dashboard"),V("/?view=dashboard")},onCreateAccount:()=>{C("create"),N("profile"),V("/?view=profile")}}):o==="review"?e.jsx(Gs,{}):o==="section"?e.jsx(Is,{}):o==="command"?e.jsx(Ms,{}):o==="installation"?e.jsx(Cs,{}):o==="hqmc-admin"?e.jsx(Js,{}):o==="installation-section"?e.jsx(Ds,{}):o==="installation-command"?e.jsx(Ps,{}):o==="hqmc-section"?e.jsx(Xs,{}):o==="hqmc-approver"?e.jsx(Zs,{}):e.jsx(Vs,{selectedUnit:t,currentUser:m})})]})}function wa(){return e.jsx(la,{})}export{wa as default};
