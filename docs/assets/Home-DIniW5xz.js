const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-DiCMDLv-.js","./index-D9Sw8rYQ.js","./index-DOJlyb3T.css"])))=>i.map(i=>d[i]);
import{r as s,j as e,s as Tt,v as Zt,l as gt,M as Et,a as es,u as ts,R as ss,b as as,_ as ns}from"./index-D9Sw8rYQ.js";import{s as Me,d as rs,a as is,b as os,l as wt,c as ut,e as Xe,u as qe,f as ft,g as Ct,h as We,i as cs,j as ls,k as Bt,m as At,n as Ft,o as yt,p as ds,q as ms,r as Vt,t as Wt,v as vt,w as Ht,x as kt}from"./db-DiCMDLv-.js";import{P as Nt,I as us}from"./InstallationAdmin-Bc2i-1v6.js";import{f as zt,R as Ke,S as Ve,o as It,c as ps,a as xs}from"./RequestTable-BhrwK0ho.js";import{c as hs,F as gs,D as Qt,a as at}from"./DocumentListItem-xZkCGjhj.js";import{l as pt}from"./unitStructure-QC5qYuxv.js";import bs from"./SectionDashboard-BCvD8Eu6.js";import fs from"./CommandDashboard-jBvGPIPF.js";import ys from"./InstallationSectionDashboard-D3d0dcKc.js";import vs from"./InstallationCommandDashboard-Dc3qmSc9.js";import{U as Fe}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-BnMvYp2M.js";import"./utils-CLmukD0c.js";const Ns={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},js=({filters:t,onFiltersChange:a,statusOptions:i=[],originatorOptions:h=[],searchPlaceholder:l="Search requests...",showAdvanced:w=!0,className:E=""})=>{var T;const[y,P]=s.useState(!1),O=s.useRef(null),L=s.useMemo(()=>Array.isArray(t.status)?t.status:[],[t.status]),Z=s.useMemo(()=>{let g=0;return L.length>0&&g++,t.dateFrom&&g++,t.dateTo&&g++,t.originatorId&&g++,g},[L,t.dateFrom,t.dateTo,t.originatorId]),j=s.useCallback(g=>{a({...t,search:g.target.value})},[t,a]),J=s.useCallback(g=>{const F=L.includes(g)?L.filter(u=>u!==g):[...L,g];a({...t,status:F})},[t,L,a]),H=s.useCallback(g=>{a({...t,dateFrom:g.target.value})},[t,a]),_=s.useCallback(g=>{a({...t,dateTo:g.target.value})},[t,a]),d=s.useCallback(g=>{a({...t,originatorId:g.target.value})},[t,a]),te=s.useCallback(()=>{var g;a(Ns),(g=O.current)==null||g.focus()},[a]),D=s.useCallback(()=>{var g;a({...t,search:""}),(g=O.current)==null||g.focus()},[t,a]);s.useEffect(()=>{const g=F=>{var u;(F.metaKey||F.ctrlKey)&&F.key==="k"&&(F.preventDefault(),(u=O.current)==null||u.focus())};return document.addEventListener("keydown",g),()=>document.removeEventListener("keydown",g)},[]);const R=t.search||Z>0;return e.jsxs("div",{className:`space-y-3 ${E}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{ref:O,type:"text",value:t.search,onChange:j,placeholder:l,className:"block w-full pl-10 pr-10 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold bg-[var(--surface)] text-[var(--text)]","aria-label":"Search"}),t.search&&e.jsx("button",{onClick:D,className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600","aria-label":"Clear search",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute inset-y-0 right-8 flex items-center pointer-events-none text-xs text-gray-400",children:e.jsx("kbd",{className:"hidden sm:inline-block px-1.5 py-0.5 bg-gray-100 rounded border border-gray-200 font-mono",children:"⌘K"})})]}),w&&e.jsxs("button",{onClick:()=>P(!y),className:`
              flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors
              ${y||Z>0?"bg-brand-gold/10 border-brand-gold text-brand-navy":"border-brand-navy/30 text-[var(--text)] hover:bg-brand-cream/50"}
            `,"aria-expanded":y,"aria-controls":"filter-panel",children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"})}),e.jsx("span",{className:"hidden sm:inline",children:"Filters"}),Z>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-brand-navy rounded-full",children:Z})]}),R&&e.jsxs("button",{onClick:te,className:"flex items-center gap-1 px-3 py-2 text-sm text-brand-red hover:text-brand-red-2 hover:bg-red-50 rounded-lg transition-colors","aria-label":"Clear all filters",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),w&&y&&e.jsxs("div",{id:"filter-panel",className:"p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[i.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Status"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:i.map(g=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-white/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:L.includes(g.value),onChange:()=>J(g.value),className:"h-4 w-4 text-brand-navy border-gray-300 rounded focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-[var(--text)]",children:g.label})]},g.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Date Range"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"From date"}),e.jsx("input",{type:"date",value:t.dateFrom,onChange:H,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"From date"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"To date"}),e.jsx("input",{type:"date",value:t.dateTo,onChange:_,min:t.dateFrom,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"To date"})]})]})]}),h.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Originator"}),e.jsxs("select",{value:t.originatorId,onChange:d,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"Filter by originator",children:[e.jsx("option",{value:"",children:"All originators"}),h.map(g=>e.jsx("option",{value:g.value,children:g.label},g.value))]})]})]}),Z>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 pt-2 border-t border-brand-navy/10",children:[e.jsx("span",{className:"text-sm text-[var(--muted)]",children:"Active filters:"}),L.map(g=>{const F=i.find(u=>u.value===g);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[(F==null?void 0:F.label)||g,e.jsx("button",{onClick:()=>J(g),className:"hover:text-brand-red","aria-label":`Remove ${(F==null?void 0:F.label)||g} filter`,children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},g)}),t.dateFrom&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["From: ",t.dateFrom,e.jsx("button",{onClick:()=>a({...t,dateFrom:""}),className:"hover:text-brand-red","aria-label":"Remove from date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.dateTo&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["To: ",t.dateTo,e.jsx("button",{onClick:()=>a({...t,dateTo:""}),className:"hover:text-brand-red","aria-label":"Remove to date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.originatorId&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[((T=h.find(g=>g.value===t.originatorId))==null?void 0:T.label)||"Originator",e.jsx("button",{onClick:()=>a({...t,originatorId:""}),className:"hover:text-brand-red","aria-label":"Remove originator filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]})]})};function Ss(t,a){return s.useMemo(()=>{let i=Array.isArray(a.items)?a.items:[];const h=Array.isArray(t.status)?t.status:[];if(t.search){const l=t.search.toLowerCase();i=i.filter(w=>a.getSearchText(w).toLowerCase().includes(l))}return h.length>0&&a.getStatus&&(i=i.filter(l=>h.includes(a.getStatus(l)))),(t.dateFrom||t.dateTo)&&a.getDate&&(i=i.filter(l=>{const w=a.getDate(l);if(!w)return!1;const E=new Date(w);if(isNaN(E.getTime()))return!1;if(t.dateFrom){const y=new Date(t.dateFrom);if(E<y)return!1}if(t.dateTo){const y=new Date(t.dateTo);if(y.setHours(23,59,59,999),E>y)return!1}return!0})),t.originatorId&&a.getOriginatorId&&(i=i.filter(l=>a.getOriginatorId(l)===t.originatorId)),i},[t,a])}function Rt(t){if(t==null)return"";const a=String(t);return a.includes('"')||a.includes(",")||a.includes(`
`)||a.includes("\r")?`"${a.replace(/"/g,'""')}"`:a}function ws(t,a){const h=a.map(w=>Rt(w.header)).join(","),l=t.map(w=>a.map(E=>{const y=E.getValue(w),P=E.format?E.format(y):y;return Rt(P)}).join(","));return[h,...l].join(`\r
`)}function Cs(t,a){const i=t.map(h=>{const l={};return a.forEach(w=>{const E=w.getValue(h);l[w.header]=w.format?w.format(E):E}),l});return JSON.stringify(i,null,2)}function Mt(t,a,i){const h=new Blob([t],{type:`${i};charset=utf-8;`}),l=URL.createObjectURL(h),w=document.createElement("a");w.href=l,w.download=a,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(l)}function As({items:t,columns:a,filename:i="export",label:h="Export",variant:l="secondary",className:w="",disabled:E=!1,showCount:y=!0,formats:P=["csv"]}){const[O,L]=s.useState(!1),[Z,j]=s.useState(!1),J=s.useRef(null),H=s.useCallback(te=>{j(!0),L(!1),setTimeout(()=>{try{const D=new Date().toISOString().slice(0,10),R=`${i}_${D}`;if(te==="csv"){const T=ws(t,a);Mt(T,`${R}.csv`,"text/csv")}else{const T=Cs(t,a);Mt(T,`${R}.json`,"application/json")}}catch(D){console.error("Export failed:",D)}finally{j(!1)}},100)},[t,a,i]);s.useEffect(()=>{const te=D=>{J.current&&!J.current.contains(D.target)&&L(!1)};return O&&document.addEventListener("mousedown",te),()=>{document.removeEventListener("mousedown",te)}},[O]),s.useEffect(()=>{const te=D=>{D.key==="Escape"&&L(!1)};return O&&document.addEventListener("keydown",te),()=>{document.removeEventListener("keydown",te)}},[O]);const _={primary:"bg-brand-navy text-brand-cream hover:bg-brand-navy/90",secondary:"bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold/10",text:"text-brand-navy hover:bg-brand-cream/50"},d=E||t.length===0||Z;return P.length===1?e.jsxs("button",{onClick:()=>H(P[0]),disabled:d,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${_[l]}
          ${w}
        `,children:[Z?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:h}),y&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]})]}):e.jsxs("div",{className:"relative",ref:J,children:[e.jsxs("button",{onClick:()=>L(!O),disabled:d,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${_[l]}
          ${w}
        `,"aria-expanded":O,"aria-haspopup":"menu",children:[Z?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:h}),y&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${O?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),O&&e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-[var(--surface)] border border-brand-navy/20 rounded-lg shadow-lg z-50",role:"menu",children:[P.includes("csv")&&e.jsxs("button",{onClick:()=>H("csv"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 first:rounded-t-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export as CSV"]}),P.includes("json")&&e.jsxs("button",{onClick:()=>H("json"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 last:rounded-b-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})}),"Export as JSON"]})]})]})}const Pt=t=>{if(!t)return"";const a=new Date(t);return isNaN(a.getTime())?"":a.toLocaleDateString()};function jt(t,a={}){const{pageSize:i=25,initialPage:h=1}=a,[l,w]=s.useState(h),[E,y]=s.useState(i),P=t.length,O=Math.ceil(P/E),L=(l-1)*E,Z=Math.min(L+E,P);return{currentData:s.useMemo(()=>t.slice(L,Z),[t,L,Z]),currentPage:l,pageSize:E,totalPages:O,totalItems:P,goToPage:R=>{const T=Math.max(1,Math.min(R,O));w(T)},nextPage:()=>{l<O&&w(l+1)},previousPage:()=>{l>1&&w(l-1)},goToFirstPage:()=>{w(1)},goToLastPage:()=>{w(O)},setPageSize:R=>{y(R),w(1)},canGoNext:l<O,canGoPrevious:l>1,startIndex:L+1,endIndex:Z}}const rt="edms-docs";function Es(){return{uploadFile:async(w,E)=>{if(!Me)return{url:"",error:"Supabase not configured"};try{const{error:y}=await Me.storage.from(rt).upload(E,w,{upsert:!0});if(y)return{url:"",error:y.message};const{data:P}=Me.storage.from(rt).getPublicUrl(E);return{url:(P==null?void 0:P.publicUrl)||""}}catch(y){return{url:"",error:y instanceof Error?y.message:"Upload failed"}}},deleteFile:async w=>{if(!Me||!w)return!1;try{return await Me.storage.from(rt).remove([w]),!0}catch{return!1}},deleteFolder:async w=>{if(!Me)return!1;try{const{data:E}=await Me.storage.from(rt).list(w.replace(/\/$/,""));if(E&&E.length>0){const y=E.map(P=>`${w.replace(/\/$/,"")}/${P.name}`);await Me.storage.from(rt).remove(y)}return!0}catch{return!1}},extractStoragePath:w=>{if(!w)return null;try{const E=w.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(E!=null&&E[1])return decodeURIComponent(E[1])}catch{}return null},buildStoragePath:(w,E,y,P)=>{const O=Date.now();return`${w||"N-A"}/${E}/${O}-${P}-${Tt(y)}`}}}const Be=t=>{const a=String(t||"").trim();return a&&a!=="N/A"?a:""},tt=(t,a,i)=>t.some(h=>String(h.role||"")!==a||Be(h.roleCompany||h.company)!==i.company||a==="PLATOON_REVIEWER"&&Be(h.rolePlatoon||h.platoon)!==(i.platoon||"")?!1:String(h.unitUic||"")===String(i.uic||""));function Gt(t){if(t===0)return"0 Bytes";const a=1024,i=["Bytes","KB","MB","GB"],h=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,h)).toFixed(2))+" "+i[h]}const Ot=s.memo(function({doc:a,onView:i,onDelete:h}){const[l,w]=s.useState(!1),E=a.fileUrl&&hs(a.type,a.name);return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:"flex items-center justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors","aria-label":`Document: ${a.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(gs,{type:a.type,fileName:a.name,size:"md"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-[var(--text)]",children:a.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)]",children:[a.name," • ",Gt(a.size)," • ",new Date(a.uploadedAt).toLocaleDateString()]}),a.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(a.dueDate).toLocaleDateString()]}),a.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Notes: ",a.notes]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",role:"group","aria-label":"Document actions",children:[a.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:zt({currentStage:a.currentStage})}),E&&e.jsx("button",{type:"button",onClick:y=>{y.stopPropagation(),w(!0)},className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Preview document ${a.name}`,children:"Preview"}),a.fileUrl&&e.jsx("a",{href:a.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${a.name} in new tab`,children:"Open"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:y=>{y.stopPropagation(),i(a)},"aria-label":`View or edit document ${a.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:y=>{y.stopPropagation(),h(a)},"aria-label":`Delete document ${a.subject}`,children:"Delete"})]})]}),a.fileUrl&&e.jsx(Qt,{url:a.fileUrl,fileName:a.name,mimeType:a.type,fileSize:a.size,isOpen:l,onClose:()=>w(!1)})]})}),Ye="edms-docs",ks=({selectedUnit:t,currentUser:a})=>{const[i,h]=s.useState([]),[l,w]=s.useState(!1),[E,y]=s.useState(""),[P,O]=s.useState(""),[L,Z]=s.useState(""),[j,J]=s.useState([]),[H,_]=s.useState(null),[d,te]=s.useState(null),[D,R]=s.useState([]),[T,g]=s.useState(!1),[F,u]=s.useState(null),[k,$]=s.useState(""),[A,V]=s.useState(""),[f,b]=s.useState(""),[G,B]=s.useState([]),[z,le]=s.useState([]),[q,fe]=s.useState(null),[Ce,we]=s.useState(""),[v,ee]=s.useState(""),[se,ne]=s.useState(""),[Q,be]=s.useState([]),[N,U]=s.useState(!1),[de,ce]=s.useState({}),[ie,Ae]=s.useState(""),[Se,Ee]=s.useState("Pending"),[Pe,Ie]=s.useState({}),[_e,c]=s.useState(""),r=Es(),p=m=>{const C=m.target.files?Array.from(m.target.files):[];if(C.length===0)return;if(j.length+C.length>Et){_({type:"error",message:`Cannot add ${C.length} file(s). Maximum ${Et} files allowed per request.`});try{m.target.value=""}catch{}return}const M=[],Y=[];for(const X of C){const ge=es(X);ge.valid?M.push(X):Y.push(...ge.errors)}M.length>0&&J(X=>[...X,...M]),Y.length>0&&_({type:"error",message:Y.slice(0,3).join(" ")+(Y.length>3?` (+${Y.length-3} more errors)`:"")});try{m.target.value=""}catch{}},W=async()=>{if(!q||!(d!=null&&d.id)||q.uploadedById!==d.id)return;const m={actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,timestamp:new Date().toISOString(),action:"Archived by Originator",comment:(se||"").trim()},C={...q,currentStage:Ve.ARCHIVED,finalStatus:"Archived",activity:Array.isArray(q.activity)?[...q.activity,m]:[m]};try{const M=await qe(C);if(!M.ok)throw new Error(Ne(M,"request_upsert_failed"));le(Y=>Y.map(X=>X.id===C.id?C:X)),fe(C),_({type:"success",message:"Request archived."})}catch(M){_({type:"error",message:`Failed to archive: ${String((M==null?void 0:M.message)||M)}`})}},I=async()=>{if(!q||!(d!=null&&d.id)||q.uploadedById!==d.id)return;const m=D.find(o=>o.id===q.uploadedById),C=q.unitUic||(m==null?void 0:m.unitUic)||"",M=Be(m==null?void 0:m.company),Y=Be(m==null?void 0:m.platoon),X=tt(D,"PLATOON_REVIEWER",{company:M,platoon:Y,uic:C}),ge=tt(D,"COMPANY_REVIEWER",{company:M,uic:C}),xe=X?Ve.PLATOON_REVIEW:ge?Ve.COMPANY_REVIEW:Ve.BATTALION_REVIEW,ue={actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,actorRole:"Member",timestamp:new Date().toISOString(),action:"Resubmitted request",comment:(se||"").trim()},n={...q,currentStage:xe,routeSection:"",activity:[...q.activity||[],ue]};try{const o=await qe(n);if(!o.ok)throw new Error(Ne(o,"request_upsert_failed"));le(S=>S.map(K=>K.id===n.id?n:K)),fe(n),ne(""),_({type:"success",message:"Request resubmitted for review."})}catch(o){_({type:"error",message:`Failed to resubmit: ${String((o==null?void 0:o.message)||o)}`})}},re=async m=>{m.preventDefault(),_(null);const C=E.trim();if(!C){_({type:"error",message:"Subject is required."});return}if(C.length>500){_({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(L.length>5e3){_({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(d!=null&&d.id)){_({type:"error",message:"Create a profile before submitting."});return}if(j.length>0){const o=Zt(j);if(!o.valid){_({type:"error",message:o.errors[0]});return}}w(!0);const M=Date.now(),Y=ie||d.id,X=D.find(o=>o.id===Y),ge=t?t.uic:(X==null?void 0:X.unitUic)||"N/A",xe=`req-${M}`;let ue=[];async function n(o,S){if(!Me)throw new Error("Supabase not configured");const{error:K}=await Me.storage.from(Ye).upload(S,o,{upsert:!0});if(K)throw new Error(K.message);const{data:pe}=Me.storage.from(Ye).getPublicUrl(S);return(pe==null?void 0:pe.publicUrl)||""}if(j&&j.length>0){const o=[];for(let S=0;S<j.length;S++){const K=j[S],pe=`${ge}/${xe}/${M}-${S}-${Tt(K.name)}`;try{const he=await n(K,pe);o.push(he)}catch(he){w(!1),_({type:"error",message:`Failed to upload ${K.name}: ${String((he==null?void 0:he.message)||he)}`});return}}ue=j.map((S,K)=>({id:`${M}-${K}`,name:S.name,type:S.type,size:S.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:ge,subject:E.trim(),dueDate:P||void 0,notes:L.trim()||void 0,uploadedById:Y,currentStage:"PLATOON_REVIEW",fileUrl:o[K]}))}ue=ue.map(o=>({...o,requestId:xe})),h(o=>[...o,...ue]),J([]),y(""),O(""),Z("");try{const o=d?`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`:"Unknown",S="Member",K=ge,pe=Be(X==null?void 0:X.company),he=Be(X==null?void 0:X.platoon),ae=tt(D,"PLATOON_REVIEWER",{company:pe,platoon:he,uic:K}),ot=tt(D,"COMPANY_REVIEWER",{company:pe,uic:K}),Je=!ae&&!ot,nt={id:xe,subject:E.trim(),dueDate:P||void 0,notes:L.trim()||void 0,unitUic:ge,uploadedById:Y,submitForUserId:Y,documentIds:ue.map(De=>De.id),createdAt:new Date().toISOString(),currentStage:ae?Ve.PLATOON_REVIEW:ot?Ve.COMPANY_REVIEW:Ve.BATTALION_REVIEW,routeSection:Je&&_e?_e:void 0,activity:[{actor:o,actorRole:S,timestamp:new Date().toISOString(),action:"Submitted request",comment:(L||"").trim()}]};try{const De=await qe(nt);if(!De.ok)throw new Error(Ne(De,"request_upsert_failed"));const ht=await ft(ue);if(!ht.ok)throw new Error(Ne(ht,"document_upsert_failed"))}catch(De){w(!1);try{gt("request_persist_failed",{requestId:xe,error:String((De==null?void 0:De.message)||De)},"error")}catch{}_({type:"error",message:`Failed to persist submission: ${String((De==null?void 0:De.message)||De)}`});return}le(De=>De.some(ct=>ct.id===nt.id)?De.map(ct=>ct.id===nt.id?nt:ct):[...De,nt]),w(!1),_({type:"success",message:"Submission successful."}),g(!1),c("")}catch{w(!1);try{gt("request_persist_failed",{requestId:xe},"error")}catch{}_({type:"error",message:"Failed to persist submission."})}},ve=s.useCallback(m=>{u(m),$(m.subject||""),V(m.dueDate||""),b(m.notes||"");try{const C=localStorage.getItem(`fs/requests/${m.requestId}.json`);if(C){const M=JSON.parse(C);B(Array.isArray(M.activity)?M.activity:[])}else{const X=Object.values(Object.assign({})).map(ge=>(ge==null?void 0:ge.default)??ge).find(ge=>ge&&ge.id===m.requestId);B(X&&Array.isArray(X.activity)?X.activity:[])}}catch{B([])}},[]),Ne=(m,C)=>{var M;return String(((M=m.error)==null?void 0:M.message)||m.error||C)},me=async()=>{if(!F)return;const m=i.map(C=>C.id===F.id?{...C,subject:k.trim()||C.subject,dueDate:A||void 0,notes:f.trim()||void 0}:C);h(m);try{const Y={actor:d?`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`:"Unknown",actorRole:"Member",timestamp:new Date().toISOString(),action:"Updated document",comment:(f||"").trim()},X=F.requestId?z.find(ge=>ge.id===F.requestId):null;if(X){const ge={...X,activity:Array.isArray(X.activity)?[...X.activity,Y]:[Y]};try{const xe=await qe(ge);if(!xe.ok)throw new Error(Ne(xe,"request_upsert_failed"))}catch(xe){console.error("Failed to save document edits:",xe),_({type:"error",message:`Failed to save document edits: ${xe.message}`});return}B(xe=>[...xe,Y])}}catch{}b(""),u(null)};i.filter(m=>!(!(d!=null&&d.id)||d.role==="MEMBER"&&m.uploadedById!==d.id||m.type==="request"));const Re=m=>!m.activity||!m.activity.length?!1:m.currentStage==="ORIGINATOR_REVIEW",$e=()=>String((d==null?void 0:d.role)||"").includes("REVIEW"),He=()=>{if(!$e())return[];const m=String((d==null?void 0:d.role)||"");return D.filter(C=>{if(C.id===(d==null?void 0:d.id))return!1;if(m.includes("PLATOON")){const M=C.company&&C.company!=="N/A"?C.company:"",Y=C.unit&&C.unit!=="N/A"?C.unit:"",X=d!=null&&d.company&&d.company!=="N/A"?d.company:"",ge=d!=null&&d.unit&&d.unit!=="N/A"?d.unit:"";return M===X&&Y===ge}if(m.includes("COMPANY")){const M=C.company&&C.company!=="N/A"?C.company:"",Y=d!=null&&d.company&&d.company!=="N/A"?d.company:"";return M===Y}return m.includes("COMMANDER")?(C.unitUic||"")===((d==null?void 0:d.unitUic)||""):!1})},ze=s.useCallback(async m=>{const C=r.extractStoragePath(m.fileUrl);try{C&&Me&&await Me.storage.from(Ye).remove([C])}catch{}try{await rs(m.id),h(M=>M.filter(Y=>Y.id!==m.id)),m.requestId&&le(M=>M.map(Y=>Y.id===m.requestId?{...Y,documentIds:(Y.documentIds||[]).filter(X=>X!==m.id)}:Y)),_({type:"success",message:"Document deleted."})}catch(M){_({type:"error",message:`Failed to delete: ${String((M==null?void 0:M.message)||M)}`})}},[]),Ze=s.useCallback(async m=>{const C=`${m.unitUic||"N-A"}/${m.id}/`;try{if(Me){const{data:M}=await Me.storage.from(Ye).list(C.slice(0,-1));if(M&&M.length>0){const Y=M.map(X=>`${C.slice(0,-1)}/${X.name}`);await Me.storage.from(Ye).remove(Y)}}}catch{}try{await is(m.id),await os(m.id),h(M=>M.filter(Y=>Y.requestId!==m.id)),le(M=>M.filter(Y=>Y.id!==m.id)),fe(null),_({type:"success",message:"Request and files deleted."})}catch(M){_({type:"error",message:`Failed to delete request: ${String((M==null?void 0:M.message)||M)}`})}},[]),et=async()=>{if(!q||!(d!=null&&d.id)||q.uploadedById!==d.id){_({type:"error",message:"Only the requester can edit this."});return}const m=Date.now(),C=xe=>xe.replace(/[^A-Za-z0-9._-]/g,"-");async function M(xe,ue){if(!Me)throw new Error("Supabase not configured");const{error:n}=await Me.storage.from(Ye).upload(ue,xe,{upsert:!0});if(n)throw new Error(n.message);const{data:o}=Me.storage.from(Ye).getPublicUrl(ue);return(o==null?void 0:o.publicUrl)||""}const Y=[];for(let xe=0;xe<Q.length;xe++){const ue=Q[xe],n=`${q.unitUic||"N-A"}/${q.id}/${m}-${xe}-${C(ue.name)}`;try{const o=await M(ue,n);Y.push(o)}catch(o){_({type:"error",message:`Failed to upload ${ue.name}: ${String((o==null?void 0:o.message)||o)}`});return}}const X=Q.map((xe,ue)=>({id:`${m}-${ue}`,name:xe.name,type:xe.type,size:xe.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:q.unitUic||"N/A",subject:Ce.trim()||q.subject,dueDate:v||void 0,notes:se.trim()||void 0,uploadedById:d.id,currentStage:q.currentStage||"PLATOON_REVIEW",requestId:q.id,fileUrl:Y[ue]})),ge={...q,subject:Ce.trim()||q.subject,dueDate:v||void 0,notes:se.trim()||void 0,documentIds:[...q.documentIds||[],...X.map(xe=>xe.id)],activity:[...q.activity||[],{actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,timestamp:new Date().toISOString(),action:X.length?`Updated request and added ${X.length} document(s)`:"Updated request",comment:(se||"").trim()}]};try{if(!(d&&xs(q,String(d.id||"")))){_({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const ue=await ft(X);if(!ue.ok)throw new Error(Ne(ue,"document_upsert_failed"));const n=await qe(ge);if(!n.ok)throw new Error(Ne(n,"request_upsert_failed"))}catch(ue){try{gt("request_update_failed",{requestId:ge.id,error:String((ue==null?void 0:ue.message)||ue)},"error")}catch{}_({type:"error",message:`Failed to persist documents: ${String((ue==null?void 0:ue.message)||ue)}`});return}h(ue=>[...ue,...X]),le(ue=>ue.map(n=>n.id===ge.id?ge:n)),fe(ge),be([]),ne(""),_({type:"success",message:X.length?"Files added and request updated.":"Request updated."})}catch{_({type:"error",message:"Failed to update request."})}},[x,oe]=s.useState(!0),[ye,Oe]=s.useState(!0);s.useEffect(()=>{wt().then(m=>{h(m)}).catch(()=>h([])).finally(()=>oe(!1))},[]),s.useEffect(()=>{q&&(we(q.subject||""),ee(q.dueDate||""),ne(q.notes||""),be([]))},[q]),s.useEffect(()=>{},[i]),s.useEffect(()=>{ut().then(m=>{le(m)}).catch(()=>le([])).finally(()=>Oe(!1))},[]),s.useEffect(()=>{te(a||null)},[a]),s.useEffect(()=>{Xe().then(m=>{R(m)}).catch(()=>R([]))},[]),s.useEffect(()=>{try{const m=localStorage.getItem("unit_structure"),C={};if(m){const M=JSON.parse(m);for(const Y of Object.keys(M||{})){const X=M[Y];X&&Array.isArray(X._sections)&&(C[Y]=X._sections)}Ie(C)}else(async()=>{try{const M=await pt();for(const Y of Object.keys(M||{})){const X=M[Y];X&&Array.isArray(X._sections)&&(C[Y]=X._sections)}Ie(C)}catch{}})()}catch{}},[]);const Qe=s.useMemo(()=>{if(!(d!=null&&d.id))return[];const m=z.filter(C=>C.uploadedById===d.id);return Se==="Pending"?m.filter(C=>C.currentStage!=="ARCHIVED"):m.filter(C=>C.currentStage==="ARCHIVED")},[z,d,Se]),je=jt(Qe,{pageSize:10}),ke=s.useMemo(()=>D.reduce((m,C)=>({...m,[C.id]:C}),{}),[D]),Ge=s.useMemo(()=>{const m=ie||(d==null?void 0:d.id),C=D.find(ue=>ue.id===m),M=t?t.uic:(C==null?void 0:C.unitUic)||"",Y=Be(C==null?void 0:C.company),X=Be(C==null?void 0:C.platoon);if(!M)return!1;const ge=tt(D,"PLATOON_REVIEWER",{company:Y,platoon:X,uic:M}),xe=tt(D,"COMPANY_REVIEWER",{company:Y,uic:M});return!ge&&!xe},[D,d,ie,t]),Ue=s.useMemo(()=>{const m=ie||(d==null?void 0:d.id),C=D.find(Y=>Y.id===m),M=t?t.uic:(C==null?void 0:C.unitUic)||"";return Pe[M]||[]},[Pe,D,d,ie,t]),xt=s.useCallback(m=>{const C=Be(m.currentStage||"PLATOON_REVIEW"),M=D.find(Y=>Y.id===m.uploadedById);switch(C){case"ORIGINATOR_REVIEW":return{level:"Member",scope:""};case"PLATOON_REVIEW":{const Y=M!=null&&M.company&&M.company!=="N/A"?M.company:"",X=M!=null&&M.platoon&&M.platoon!=="N/A"?M.platoon:"";return Y&&X?{level:"Platoon",scope:`(${Y}-${X})`}:Y?{level:"Platoon",scope:`(${Y})`}:{level:"Platoon",scope:""}}case"COMPANY_REVIEW":{const Y=M!=null&&M.company&&M.company!=="N/A"?M.company:"";return{level:"Company",scope:Y?`(${Y})`:""}}case"BATTALION_REVIEW":return{level:"Battalion",scope:m.routeSection?`(${m.routeSection})`:""};case"COMMANDER_REVIEW":return{level:"Commander",scope:m.routeSection?`(${m.routeSection})`:""};case"ARCHIVED":return{level:"Archived",scope:""};default:return{level:zt(m),scope:""}}},[D]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>g(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),T&&e.jsxs("form",{onSubmit:re,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:E,onChange:m=>y(m.target.value),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${E.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:P,onChange:m=>O(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),String((d==null?void 0:d.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:ie,onChange:m=>Ae(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),He().map(m=>e.jsxs("option",{value:m.id,children:[m.rank," ",m.lastName,", ",m.firstName,m.mi?` ${m.mi}`:""]},m.id))]})]})}),Ge&&Ue.length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Battalion Section"}),e.jsxs("select",{value:_e,onChange:m=>c(m.target.value),className:`w-full px-3 py-2 border ${_e?"border-brand-navy/30":"border-brand-gold"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`,children:[e.jsx("option",{value:"",children:"Select section"}),Ue.map(m=>e.jsx("option",{value:m,children:m},m))]}),e.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"No platoon/company reviewer available. Select a section for routing."})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:L,onChange:m=>Z(m.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:p,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:j.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:j.map((m,C)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:m.name,children:m.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>J(M=>M.filter((Y,X)=>X!==C)),children:"Delete"})]},C))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{g(!1),J([]),y(""),O(""),Z(""),c(""),_(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!E.trim(),children:"Submit"})]})]}),H&&e.jsx("div",{className:`p-3 rounded-lg border ${H.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:H.message})]})]}),e.jsxs("div",{className:"p-6",children:[d&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>Ee("Pending"),className:`${Se==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>Ee("Archived"),className:`${Se==="Archived"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Archived"})]})}),e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:je.totalItems>0?`${je.startIndex}–${je.endIndex} of ${je.totalItems}`:""}),ye&&e.jsx("div",{className:"animate-pulse",children:"Loading requests…"})]}),e.jsx(Ke,{title:"Your Requests",requests:ye?Array.from({length:5}).map((m,C)=>({id:`s-${C}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:Ve.PLATOON_REVIEW})):je.currentData,users:ke,onRowClick:m=>fe(m),expandedRows:de,children:m=>e.jsxs("div",{id:`req-docs-${m.id}`,children:[x?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):i.filter(C=>C.requestId===m.id&&C.type!=="request").map(C=>e.jsx(Ot,{doc:C,onView:ve,onDelete:ze},C.id)),!x&&i.filter(C=>C.requestId===m.id&&C.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),je.totalItems>0&&e.jsx(Nt,{currentPage:je.currentPage,totalPages:je.totalPages,totalItems:je.totalItems,pageSize:je.pageSize,startIndex:je.startIndex,endIndex:je.endIndex,onPageChange:je.goToPage,onPageSizeChange:je.setPageSize,onNext:je.nextPage,onPrevious:je.previousPage,onFirst:je.goToFirstPage,onLast:je.goToLastPage,canGoNext:je.canGoNext,canGoPrevious:je.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),l&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),F&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>u(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:k,onChange:m=>$(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:A,onChange:m=>V(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:F.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:f,onChange:m=>b(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[F.name," • ",Gt(F.size)," • ",new Date(F.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:G.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):G.map((m,C)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[m.actor,m.actorRole?` • ${m.actorRole}`:""," • ",new Date(m.timestamp).toLocaleString()," • ",m.action]}),m.comment&&e.jsx("div",{className:"text-gray-600",children:m.comment})]},C))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>u(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:me,children:"Save"})]})]})}),q&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>fe(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>fe(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:Ce,onChange:m=>we(m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(q.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:v,onChange:m=>ee(m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),q.currentStage&&(()=>{const{level:m,scope:C}=xt(q);return e.jsxs("span",{className:"inline-flex flex-col items-center px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-lg border border-brand-navy/30 leading-tight",children:[e.jsx("span",{children:m}),C&&e.jsx("span",{className:"text-[10px]",children:C})]})})(),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:3,value:se,onChange:m=>ne(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:q.activity&&q.activity.length?q.activity.map((m,C)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[m.actor,m.actorRole?` • ${m.actorRole}`:""," • ",new Date(m.timestamp).toLocaleString()," • ",m.action]}),m.comment&&e.jsx("div",{className:"text-gray-600",children:m.comment})]},C)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Documents"}),e.jsxs("button",{className:"mt-2 px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-expanded":N,"aria-controls":"docs-panel",onClick:()=>U(m=>!m),children:[N?"Hide":"Show"," Documents"]}),e.jsx("div",{id:"docs-panel",className:N?"mt-3 space-y-2":"hidden",children:i.filter(m=>m.requestId===q.id&&m.type!=="request").map(m=>e.jsx(Ot,{doc:m,onView:ve,onDelete:ze},m.id))}),!It(q,String((d==null?void 0:d.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:m=>{const C=m.target.files?Array.from(m.target.files):[];be(M=>[...M,...C]);try{m.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:Q.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):Q.map((m,C)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:m.name,children:m.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>be(M=>M.filter((Y,X)=>X!==C)),children:"Delete"})]},C))})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>fe(null),children:"Close"}),It(q,String((d==null?void 0:d.id)||""))?e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-gold text-brand-charcoal hover:brightness-110",onClick:W,children:"Archive"}):e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:et,disabled:!d||d.id!==((q==null?void 0:q.uploadedById)||""),children:"Save Changes"}),d&&Re(q)&&d.id===q.uploadedById&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700",onClick:I,children:"Resubmit"}),d&&ps(q,String((d==null?void 0:d.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>Ze(q),children:"Delete Request"})]})]})})]})},Is=({currentUser:t,onClose:a})=>{const[i,h]=s.useState([]),[l,w]=s.useState(""),[E,y]=s.useState(!1),[P,O]=s.useState(""),[L,Z]=s.useState(!1),[j,J]=s.useState("");s.useEffect(()=>{Ct().then(R=>{h(R.data||[])}).catch(()=>h([]))},[]);const H=s.useMemo(()=>String(t.role||"")!=="MEMBER",[t]),_=s.useMemo(()=>{const R=T=>{const g=t.unitUic||"",F=String(t.role||"");if(F.includes("PLATOON")){const u=T.company&&T.company!=="N/A"?T.company:"",k=T.platoon&&T.platoon!=="N/A"?T.platoon:"",$=t.company&&t.company!=="N/A"?t.company:"",A=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return u===$&&k===A}if(F.includes("COMPANY")){const u=T.company&&T.company!=="N/A"?T.company:"",k=t.company&&t.company!=="N/A"?t.company:"";return u===k}return F.includes("COMMANDER")?(T.unitUic||"")===g:!1};return i.filter(T=>T.id!==t.id&&R(T))},[i,t]),d=s.useMemo(()=>{const R=String(t.role||""),T=g=>{const F=t.unitUic||"";if(R.includes("PLATOON")){const u=g.company&&g.company!=="N/A"?g.company:"",k=g.platoon&&g.platoon!=="N/A"?g.platoon:"",$=t.company&&t.company!=="N/A"?t.company:"",A=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return u===$&&k===A}if(R.includes("COMPANY")){const u=g.company&&g.company!=="N/A"?g.company:"",k=t.company&&t.company!=="N/A"?t.company:"";return u===k}return R.includes("COMMANDER")?(g.unitUic||"")===F:!1};return i.filter(g=>g.id!==t.id&&T(g)&&String(g.role||"")===R)},[i,t]),te=async()=>{try{y(!0),O("");const R=i.find(u=>u.id===l);if(!H||!R){y(!1);return}const T=String(t.role||""),g={...R};if(g.role=T,T.includes("PLATOON")){g.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A";const u=t.platoon&&t.platoon!=="N/A"?t.platoon:"N/A";g.rolePlatoon=u}else T.includes("COMPANY")?(g.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A",g.rolePlatoon="N/A"):T.includes("COMMANDER")&&(g.roleCompany="N/A",g.rolePlatoon="N/A");try{if(!(await We({id:g.id,email:g.email,rank:g.rank,firstName:g.firstName,lastName:g.lastName,mi:g.mi,service:g.service,role:g.role,unitUic:g.unitUic,unit:g.unit,company:g.company,isUnitAdmin:!!g.isUnitAdmin,isCommandStaff:!!g.isCommandStaff,edipi:g.edipi,passwordHash:g.passwordHash,roleCompany:g.roleCompany,rolePlatoon:g.rolePlatoon})).ok)throw new Error("persist_failed")}catch{O("Failed to persist user changes")}const F={actorId:t.id,actorRole:t.role,targetId:g.id,grantedRole:g.role,timestamp:new Date().toISOString(),scope:{unitUic:t.unitUic||"",company:t.company,unit:t.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(F)})}catch{}h(u=>u.map(k=>k.id===g.id?g:k)),w(""),Z(!1),y(!1)}catch{y(!1),O("Operation failed")}},D=async R=>{try{y(!0),O("");const T=i.find($=>$.id===R);if(!T){y(!1);return}const g=String(t.role||"");if(!d.some($=>$.id===R)){y(!1),O("Target not in scope");return}const u={...T};u.role="MEMBER",u.company="N/A",u.unit="N/A",u.isCommandStaff=!1,u.roleCompany="N/A",u.rolePlatoon="N/A";try{if(!(await We({id:u.id,email:u.email,rank:u.rank,firstName:u.firstName,lastName:u.lastName,mi:u.mi,service:u.service,role:u.role,unitUic:u.unitUic,unit:u.unit,company:u.company,isUnitAdmin:!!u.isUnitAdmin,isCommandStaff:!!u.isCommandStaff,edipi:u.edipi,passwordHash:u.passwordHash,roleCompany:u.roleCompany,rolePlatoon:u.rolePlatoon})).ok)throw new Error("persist_failed")}catch{O("Failed to persist user changes")}const k={actorId:t.id,actorRole:t.role,targetId:u.id,action:"Revoked",previousRole:g,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)})}catch{}h($=>$.map(A=>A.id===u.id?u:A)),J(""),y(!1)}catch{y(!1),O("Operation failed")}};return H?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:a,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:R=>R.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:a,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:l,onChange:R=>w(R.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),_.map(R=>e.jsxs("option",{value:R.id,children:[R.rank," ",R.lastName,", ",R.firstName,R.mi?` ${R.mi}`:""," • ",R.email]},R.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[d.map(R=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[R.rank," ",R.lastName,", ",R.firstName,R.mi?` ${R.mi}`:""," • ",R.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>J(R.id),children:"Remove Access"})]},R.id)),d.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),P&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:P})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!l||E,onClick:()=>Z(!0),children:"Grant Equivalent Permission"})}),L&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>Z(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:E,onClick:te,children:"Confirm"})]})]}),j&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>J(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:E,onClick:()=>D(j),children:"Remove"})]})]})]})}):null},Dt="ORIGINATOR_REVIEW",Te=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Rs=[{value:"PLATOON_REVIEW",label:"Platoon Review"},{value:"COMPANY_REVIEW",label:"Company Review"},{value:"BATTALION_REVIEW",label:"Battalion Review"},{value:"COMMANDER_REVIEW",label:"Commander Review"},{value:"ARCHIVED",label:"Archived"}],Ms={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},Ps=t=>{const a=Te.indexOf(t||Te[0]);return a>=0&&a<Te.length-1?Te[a+1]:Te[a]||Te[0]},$t=t=>{const a=Te.indexOf(t||Te[0]);return a>0?Te[a-1]:Te[0]},mt=(t,a)=>{var i;return((i=t.activity)==null?void 0:i.some(h=>a.test(String(h.action||""))))||!1},Os=t=>mt(t,/(approved by commander|commander.*approved)/i)&&!mt(t,/installation commander/i),Ds=t=>mt(t,/(endorsed by commander|commander.*endorsed)/i)&&!mt(t,/installation commander/i),bt=t=>{if(!t)return"MEMBER";const a=String(t.role||"MEMBER"),i=(t.roleCompany||t.company||"").trim(),h=(t.rolePlatoon||t.platoon||"").trim();switch(a){case"PLATOON_REVIEWER":if(i&&h)return`Platoon (${i}-${h})`;break;case"COMPANY_REVIEWER":if(i)return`Company (${i})`;break;case"BATTALION_REVIEWER":return"Battalion";case"COMMANDER_REVIEWER":return"Commander"}return a};function $s(){const t=ts(),[a,i]=s.useState(()=>{try{const c=localStorage.getItem("currentUser");return c?JSON.parse(c):null}catch(c){return console.error("Failed to parse user from localStorage:",c),null}}),[h,l]=s.useState([]),[w,E]=s.useState([]),[y,P]=s.useState({}),[O,L]=s.useState({}),[Z,j]=s.useState({}),[J,H]=s.useState({}),[_,d]=s.useState({}),[te,D]=s.useState({}),[R,T]=s.useState({}),[g,F]=s.useState(!1),[u,k]=s.useState({}),[$,A]=s.useState({}),[V,f]=s.useState(!1),[b,G]=s.useState({}),[B,z]=s.useState(null),le=s.useRef(null),[q,fe]=s.useState("Pending"),[Ce,we]=s.useState(Ms),[v,ee]=s.useState(null);s.useEffect(()=>{const c=p=>{B&&le.current&&!le.current.contains(p.target)&&(G(W=>({...W,[B]:!1})),z(null))},r=p=>{p.key==="Escape"&&B&&(G(W=>({...W,[B]:!1})),z(null))};return document.addEventListener("mousedown",c),document.addEventListener("keydown",r),()=>{document.removeEventListener("mousedown",c),document.removeEventListener("keydown",r)}},[B]),s.useEffect(()=>{cs().then(c=>{l(c.data||[])}).catch(()=>l([]))},[]),s.useEffect(()=>{ls().then(c=>{E(c.data||[])}).catch(()=>E([]))},[]),s.useEffect(()=>{Ct().then(c=>{const r={},p=c.data||[];for(const W of p)W!=null&&W.id&&(r[W.id]=W);L(r)}).catch(()=>L({}))},[]),s.useEffect(()=>{try{const c=localStorage.getItem("unit_structure"),r={},p={};if(c){const W=JSON.parse(c);for(const I of Object.keys(W||{})){const re=W[I];re&&Array.isArray(re._sections)&&(r[I]=re._sections),re&&re._platoonSectionMap&&typeof re._platoonSectionMap=="object"&&(p[I]=re._platoonSectionMap)}}else(async()=>{try{const W=await pt();for(const I of Object.keys(W||{})){const re=W[I];re&&Array.isArray(re._sections)&&(r[I]=re._sections),re&&re._platoonSectionMap&&typeof re._platoonSectionMap=="object"&&(p[I]=re._platoonSectionMap)}}catch{}})();D(r),T(p)}catch{}},[]);const se=s.useMemo(()=>{const c=String((a==null?void 0:a.role)||"");return c.includes("PLATOON")?"PLATOON_REVIEW":c.includes("COMPANY")?"COMPANY_REVIEW":c.includes("BATTALION")?"BATTALION_REVIEW":c.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[a]),ne=c=>O[c.uploadedById]||null,Q=c=>c&&c!=="N/A"?c.trim():"",be=c=>{var ve,Ne;const r=ne(c),p=c.unitUic||(r==null?void 0:r.unitUic)||"",W=String((a==null?void 0:a.role)||""),I=(a==null?void 0:a.unitUic)||"",re=(Q(a==null?void 0:a.roleCompany)||Q(a==null?void 0:a.company)).toUpperCase();if(W.includes("PLATOON")){if(!I||p!==I)return!1;const me=r?Q(r.company).toUpperCase():"",Re=r?Q(r.platoon).toUpperCase():"",$e=(Q(a==null?void 0:a.rolePlatoon)||Q(a==null?void 0:a.platoon)).toUpperCase();return!re||!$e||!me||!Re?!1:me===re&&Re===$e}if(W.includes("COMPANY")){if(!I||p!==I)return!1;const me=r?Q(r.company).toUpperCase():"";return!re||!me?!1:me===re}if(W.includes("BATTALION")){if(!I||p!==I)return!1;const me=Q(a==null?void 0:a.company),Re=Q(a==null?void 0:a.platoon),$e=((Ne=(ve=R[I])==null?void 0:ve[me])==null?void 0:Ne[Re])||"";return c.routeSection&&$e?c.routeSection===$e:!0}return W.includes("COMMANDER")?!!I&&p===I:!0},N=s.useMemo(()=>(Array.isArray(h)?h:[]).filter(be),[h,a,O,R]),U=s.useMemo(()=>{const c=new Map;for(const r of N){const p=ne(r);if(p&&p.id&&!c.has(p.id)){const W=`${p.rank||""} ${p.lastName||""}, ${p.firstName||""}`.trim();c.set(p.id,{value:p.id,label:W||p.id})}}return Array.from(c.values()).sort((r,p)=>r.label.localeCompare(p.label))},[N,O]),de=Ss(Ce,{items:N,getSearchText:c=>`${c.subject||""} ${c.id||""} ${c.routeSection||""}`,getStatus:c=>c.currentStage||"PLATOON_REVIEW",getDate:c=>c.createdAt,getOriginatorId:c=>c.uploadedById}),ce=s.useMemo(()=>de.filter(c=>(c.currentStage||"PLATOON_REVIEW")===se),[de,se]),ie=s.useMemo(()=>de.filter(c=>(c.currentStage||"PLATOON_REVIEW")!==se),[de,se]),Ae=jt(ce,{pageSize:25}),Se=jt(ie,{pageSize:25}),Ee=c=>w.filter(r=>r.requestId===c),Pe=s.useMemo(()=>[{header:"Request ID",getValue:c=>c.id},{header:"Subject",getValue:c=>c.subject},{header:"Stage",getValue:c=>c.currentStage||""},{header:"Route Section",getValue:c=>c.routeSection||""},{header:"Originator",getValue:c=>{const r=ne(c);return r?`${r.rank||""} ${r.lastName||""}, ${r.firstName||""}${r.mi?` ${r.mi}`:""}`.trim():""}},{header:"Unit UIC",getValue:c=>c.unitUic||""},{header:"Created At",getValue:c=>c.createdAt,format:Pt},{header:"Due Date",getValue:c=>c.dueDate||"",format:Pt},{header:"Documents",getValue:c=>Ee(c.id).map(r=>r.name).join(" | ")}],[O,w]),Ie=async(c,r,p)=>{const W=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",I=bt(a),re={actor:W,actorRole:I,timestamp:new Date().toISOString(),action:p,comment:(y[c.id]||"").trim()},ve={...c,currentStage:r,routeSection:r==="BATTALION_REVIEW"&&_[c.id]?_[c.id]:c.routeSection,activity:Array.isArray(c.activity)?[...c.activity,re]:[re]};try{await qe(ve),p.toLowerCase().includes("approved")?t.success("Request approved",{message:`"${c.subject}" advanced to next stage`}):p.toLowerCase().includes("return")?t.warning("Request returned",{message:`"${c.subject}" sent back for revision`}):p.toLowerCase().includes("archive")?t.info("Request archived",{message:`"${c.subject}" has been archived`}):t.success(p,{message:`Request "${c.subject}" updated`}),l(Ne=>Ne.map(me=>me.id===ve.id?ve:me)),P(Ne=>({...Ne,[c.id]:""}))}catch(Ne){t.error("Failed to update request",{message:String(Ne)})}},_e=async c=>{const r=J[c.id]||[];if(!r.length||!(a!=null&&a.id))return;const p=Date.now(),W=r.map((me,Re)=>({id:`${p}-${Re}`,name:me.name,type:me.type,size:me.size,uploadedAt:new Date().toISOString(),subject:c.subject,requestId:c.id,fileUrl:URL.createObjectURL(me)})),I=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",re=bt(a),ve={actor:I,actorRole:re,timestamp:new Date().toISOString(),action:`Reviewer added ${W.length} document(s)`,comment:(y[c.id]||"").trim()},Ne={...c,documentIds:[...c.documentIds||[],...W.map(me=>me.id)],activity:Array.isArray(c.activity)?[...c.activity,ve]:[ve]};try{await ft(W),await qe(Ne),t.success(`${W.length} file${W.length!==1?"s":""} added`,{message:`Documents added to "${c.subject}"`})}catch(me){t.error("Failed to add files",{message:String(me)})}E(me=>[...me,...W]),l(me=>me.map(Re=>Re.id===Ne.id?Ne:Re)),H(me=>({...me,[c.id]:[]})),P(me=>({...me,[c.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Unit Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:bt(a)}),e.jsx(As,{items:[...ce,...ie],columns:Pe,filename:"review_requests",label:"Export",className:"hidden md:inline-flex"})]})]}),a&&String(a.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>F(!0),children:"Manage Permissions"})})]}),e.jsx(js,{filters:Ce,onFiltersChange:we,statusOptions:Rs,originatorOptions:U,searchPlaceholder:"Search requests by subject, ID, or section...",className:"mb-4"}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>fe("Pending"),className:`${q==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>fe("In Scope"),className:`${q==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[q==="Pending"&&e.jsx(Ke,{title:"Pending",requests:Ae.currentData,users:O,onRowClick:c=>k(r=>({...r,[c.id]:!r[c.id]})),expandedRows:u,platoonSectionMap:R,children:c=>e.jsxs("div",{id:`details-rev-${c.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!b[c.id],"aria-controls":`docs-rev-${c.id}`,onClick:()=>{G(r=>({...r,[c.id]:!r[c.id]})),z(r=>b[c.id]?null:c.id)},onKeyDown:r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),G(p=>({...p,[c.id]:!p[c.id]})),z(p=>b[c.id]?null:c.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${b[c.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${c.id}`,ref:b[c.id]?le:void 0,className:`${b[c.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:Ee(c.id).map(r=>({...r,fileUrl:r.fileUrl})),showIcons:!0,onPreview:r=>ee(Ee(c.id).find(p=>p.id===r.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>j(r=>({...r,[c.id]:!r[c.id]})),"aria-expanded":!!Z[c.id],"aria-controls":`logs-${c.id}`,children:[Z[c.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${c.id}`,className:Z[c.id]?"mt-2 space-y-2":"hidden",children:c.activity&&c.activity.length?c.activity.map((r,p)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[r.actor,r.actorRole?` • ${r.actorRole}`:""," • ",new Date(r.timestamp).toLocaleString()," • ",r.action]}),r.comment&&e.jsx("div",{className:"text-gray-600",children:r.comment})]},p)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:y[c.id]||"",onChange:r=>P(p=>({...p,[c.id]:r.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:r=>H(p=>({...p,[c.id]:r.target.files?Array.from(r.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(J[c.id]||[]).length?`${(J[c.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>_e(c),disabled:!J[c.id]||!(J[c.id]||[]).length,children:"Save Files"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[String((a==null?void 0:a.role)||"").includes("COMPANY")&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:_[c.id]||"",onChange:r=>d(p=>({...p,[c.id]:r.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(te[(a==null?void 0:a.unitUic)||""]||[]).map(r=>e.jsx("option",{value:r,children:r},r))]})]}),(()=>{const r=Os(c),p=Ds(c);return r||p?e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Ie(c,c.currentStage==="PLATOON_REVIEW"?Dt:$t(c.currentStage),"Returned to previous stage"),children:"Return to Previous"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(String((a==null?void 0:a.role)||"").includes("COMPANY")){if(!_[c.id])return;Ie(c,"BATTALION_REVIEW",`Approved and routed to ${_[c.id]}`)}else Ie(c,Ps(c.currentStage),"Approved")},disabled:String((a==null?void 0:a.role)||"").includes("COMPANY")&&!_[c.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Ie(c,c.currentStage==="PLATOON_REVIEW"?Dt:$t(c.currentStage),c.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),q==="In Scope"&&e.jsx(Ke,{title:"In Scope",requests:Se.currentData,users:O,onRowClick:c=>k(r=>({...r,[c.id]:!r[c.id]})),expandedRows:u,platoonSectionMap:R,children:c=>e.jsxs("div",{id:`details-rev-${c.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!b[c.id],"aria-controls":`docs-rev-${c.id}`,onClick:()=>{G(r=>({...r,[c.id]:!r[c.id]})),z(r=>b[c.id]?null:c.id)},onKeyDown:r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),G(p=>({...p,[c.id]:!p[c.id]})),z(p=>b[c.id]?null:c.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${b[c.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${c.id}`,ref:b[c.id]?le:void 0,className:`${b[c.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:Ee(c.id).map(r=>({...r,fileUrl:r.fileUrl})),showIcons:!0,onPreview:r=>ee(Ee(c.id).find(p=>p.id===r.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>j(r=>({...r,[c.id]:!r[c.id]})),"aria-expanded":!!Z[c.id],"aria-controls":`logs-${c.id}`,children:[Z[c.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${c.id}`,className:Z[c.id]?"mt-2 space-y-2":"hidden",children:c.activity&&c.activity.length?c.activity.map((r,p)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[r.actor,r.actorRole?` • ${r.actorRole}`:""," • ",new Date(r.timestamp).toLocaleString()," • ",r.action]}),r.comment&&e.jsx("div",{className:"text-gray-600",children:r.comment})]},p)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),g&&a&&e.jsx(Is,{currentUser:a,onClose:()=>F(!1)}),v&&v.fileUrl&&e.jsx(Qt,{url:v.fileUrl,fileName:v.name,mimeType:v.type,fileSize:v.size,isOpen:!!v,onClose:()=>ee(null)})]})}const Ut="MM",Jt="Manpower Management",Yt="MMEA",Kt="Enlisted Personnel Assignments (General oversight)",_s={division_code:Ut,division_name:Jt,branch:Yt,description:Kt},Ls=Object.freeze(Object.defineProperty({__proto__:null,branch:Yt,default:_s,description:Kt,division_code:Ut,division_name:Jt},Symbol.toStringTag,{value:"Module"}));async function qs(){try{const t=Object.assign({"../hqmc-structure/MM__manpower-management__mmea.json":Ls}),a=[];for(const i of Object.values(t)){const h=(i==null?void 0:i.default)??i;if(h&&typeof h=="object"){const l=String(h.division_code||""),w=String(h.division_name||""),E=String(h.branch||""),y=h.description?String(h.description):void 0;l&&E&&a.push({division_code:l,division_name:w,branch:E,description:y})}}return a}catch{return[]}}function Ts(){var $;const[t,a]=s.useState(null),[i,h]=s.useState([]),[l,w]=s.useState([]),[E,y]=s.useState(""),[P,O]=s.useState(""),[L,Z]=s.useState([]),[j,J]=s.useState(null),[H,_]=s.useState("structure"),[d,te]=s.useState({}),[D,R]=s.useState({}),[T,g]=s.useState({});s.useEffect(()=>{try{const A=localStorage.getItem("currentUser");A&&a(JSON.parse(A))}catch{}Bt().then(A=>{try{h(A.map(V=>({code:String(V.code||""),name:String(V.name||"")})))}catch{h([])}}),qs().then(A=>{w(A)}),Xe().then(A=>Z(A)).catch(()=>Z([])),At().then(A=>{const V={};for(const f of A){const b=`${f.division_code}::${f.branch}`;V[b]={reviewers:f.reviewers||[],approvers:f.approvers||[]}}te(V)})},[]);const F=(t==null?void 0:t.hqmcDivision)||(($=i[0])==null?void 0:$.code)||"",u=s.useMemo(()=>i.find(A=>A.code===F),[i,F]),k=s.useMemo(()=>(Array.isArray(l)?l:[]).filter(A=>String(A.division_code||"")===F),[l,F]);return s.useMemo(()=>(Array.isArray(L)?L:[]).filter(A=>!!A.isHqmcAdmin&&String(A.hqmcDivision||"")===F),[L,F]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(t!=null&&t.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",u?`${u.code} — ${u.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>_("structure"),className:`${H==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>_("permissions"),className:`${H==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),H==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"})]})}),e.jsxs("tbody",{children:[k.map(A=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:A.branch}),e.jsx("td",{className:"py-2 px-3",children:A.description||""})]},A.branch)),k.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:E,onChange:A=>y(A.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:P,onChange:A=>O(A.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!E.trim(),onClick:async()=>{var A;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:F,division_name:((A=i.find(f=>f.code===F))==null?void 0:A.name)||"",branch:E.trim(),description:P.trim()})});const V=await fetch("/api/hqmc-structure").then(f=>f.json());w(V),y(""),O("")}catch{}},children:"Add"})]})]})]}),H==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const A of k){const V=`${F}::${A.branch}`,f=d[V]||{reviewers:[],approvers:[]};await Ft({division_code:F,branch:A.branch,reviewers:f.reviewers,approvers:f.approvers})}J({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:k.map(A=>{const V=`${F}::${A.branch}`,f=d[V]||{reviewers:[],approvers:[]},b=G=>`${G.rank||""} ${G.lastName||""}, ${G.firstName||""}${G.mi?" "+G.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:A.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:D[V]||"",onChange:G=>R(B=>({...B,[V]:G.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!D[V],onClick:async()=>{const G=(D[V]||"").trim();if(!G)return;const{user:B}=await yt(G);if(!(B!=null&&B.id)){J({type:"error",message:`No user found for EDIPI ${G}`});return}te(z=>({...z,[V]:{...f,reviewers:Array.from(new Set([...f.reviewers||[],B.id]))}})),R(z=>({...z,[V]:""})),J({type:"success",message:`Added reviewer ${B.lastName||""}, ${B.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(f.reviewers||[]).map(G=>{const B=L.find(z=>z.id===G);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:B?b(B):G}),e.jsx("button",{className:"text-red-600",onClick:()=>te(z=>({...z,[V]:{...f,reviewers:(f.reviewers||[]).filter(le=>le!==G)}})),children:"✕"})]},G)}),(f.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:T[V]||"",onChange:G=>g(B=>({...B,[V]:G.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!T[V],onClick:async()=>{const G=(T[V]||"").trim();if(!G)return;const{user:B}=await yt(G);if(!(B!=null&&B.id)){J({type:"error",message:`No user found for EDIPI ${G}`});return}te(z=>({...z,[V]:{...f,approvers:Array.from(new Set([...f.approvers||[],B.id]))}})),g(z=>({...z,[V]:""})),J({type:"success",message:`Added approver ${B.lastName||""}, ${B.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(f.approvers||[]).map(G=>{const B=L.find(z=>z.id===G);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:B?b(B):G}),e.jsx("button",{className:"text-red-600",onClick:()=>te(z=>({...z,[V]:{...f,approvers:(f.approvers||[]).filter(le=>le!==G)}})),children:"✕"})]},G)}),(f.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},V)})})]})})]}),j&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${j.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:j.message})]})}const it=(t,a)=>`${t}::${a}`;function Bs({currentUser:t,divisionCode:a,branches:i,assignments:h,onClose:l}){const[w,E]=s.useState([]),[y,P]=s.useState(""),[O,L]=s.useState(""),[Z,j]=s.useState("reviewer"),[J,H]=s.useState(!1);s.useEffect(()=>{Ct().then(u=>E(u)).catch(()=>E([]))},[]);const _=s.useMemo(()=>{const u={};for(const k of h)u[it(k.division_code,k.branch)]={reviewers:k.reviewers||[],approvers:k.approvers||[]};return u},[h]),d=String(t.id||""),te=s.useMemo(()=>{if(!y)return!1;const u=_[it(a,y)]||{reviewers:[],approvers:[]};return(u.reviewers||[]).includes(d)||(u.approvers||[]).includes(d)||!!t.isHqmcAdmin},[y,_,d,t]),D=s.useMemo(()=>w.filter(u=>String(u.hqmcDivision||"")===String(a||"")&&String(u.id||"")!==d),[w,a,d]),R=s.useMemo(()=>{if(!y)return[];const u=_[it(a,y)]||{reviewers:[],approvers:[]};return Array.from(new Set([...u.reviewers||[],...u.approvers||[]])).map($=>D.find(A=>A.id===$)).filter(Boolean)},[y,_,D,a]),T=async u=>{H(!0);try{await Ft({division_code:a,branch:y,reviewers:u.reviewers,approvers:u.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:t.id,scope:{hqmcDivision:a,branch:y},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{H(!1)}},g=async()=>{if(!te||!y||!O)return;const u=_[it(a,y)]||{reviewers:[],approvers:[]},k={reviewers:Array.from(new Set(u.reviewers||[])),approvers:Array.from(new Set(u.approvers||[]))};Z==="reviewer"?k.reviewers=Array.from(new Set([...k.reviewers,O])):k.approvers=Array.from(new Set([...k.approvers,O])),await T(k),L("")},F=async u=>{if(!te||!y)return;const k=_[it(a,y)]||{reviewers:[],approvers:[]},$={reviewers:(k.reviewers||[]).filter(A=>A!==u),approvers:(k.approvers||[]).filter(A=>A!==u)};await T($)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:l,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:u=>u.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:l,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:y,onChange:u=>P(u.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),i.map(u=>e.jsx("option",{value:u,children:u},u))]})]}),y&&!te&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),y&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:O,onChange:u=>L(u.target.value),disabled:!te,children:[e.jsx("option",{value:"",children:"Choose user"}),D.map(u=>e.jsxs("option",{value:u.id,children:[u.rank," ",u.lastName,", ",u.firstName,u.mi?` ${u.mi}`:""," • ",u.email]},u.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:Z,onChange:u=>j(u.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!te||!O||J,onClick:g,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[R.map(u=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[u.rank," ",u.lastName,", ",u.firstName,u.mi?` ${u.mi}`:""," • ",u.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!te||J,onClick:()=>F(u.id),children:"Remove"})]},u.id)),R.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}const lt=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Fs=t=>{const a=lt.indexOf(t||lt[0]);return a>0?lt[a-1]:lt[0]};function Vs(){const[t,a]=s.useState(()=>{try{const N=localStorage.getItem("currentUser");return N?JSON.parse(N):null}catch{return null}}),[i,h]=s.useState([]),[l,w]=s.useState([]),[E,y]=s.useState({}),[P,O]=s.useState({}),[L,Z]=s.useState({}),[j,J]=s.useState({}),[H,_]=s.useState(null),d=s.useRef(null),[te,D]=s.useState([]),[R,T]=s.useState("Pending"),[g,F]=s.useState([]),[u,k]=s.useState({}),[$,A]=s.useState(!1);s.useEffect(()=>{const N=de=>{H&&d.current&&!d.current.contains(de.target)&&(J(ce=>({...ce,[H]:!1})),_(null))},U=de=>{de.key==="Escape"&&H&&(J(ce=>({...ce,[H]:!1})),_(null))};return document.addEventListener("mousedown",N),document.addEventListener("keydown",U),()=>{document.removeEventListener("mousedown",N),document.removeEventListener("keydown",U)}},[H]),s.useEffect(()=>{ut().then(N=>h(N)).catch(()=>h([]))},[]),s.useEffect(()=>{wt().then(N=>w(N)).catch(()=>w([]))},[]),s.useEffect(()=>{Xe().then(N=>{const U={};for(const de of N)de!=null&&de.id&&(U[de.id]=de);O(U)}).catch(()=>O({}))},[]),s.useEffect(()=>{At().then(D).catch(()=>D([]))},[]),s.useEffect(()=>{ds().then(F).catch(()=>F([]))},[]);const V=(t==null?void 0:t.id)||"",f=String((t==null?void 0:t.hqmcDivision)||""),b=s.useMemo(()=>te.filter(N=>N.division_code===f&&((N.reviewers||[]).includes(V)||(N.approvers||[]).includes(V))).map(N=>N.branch),[te,f,V]),G=N=>P[N.uploadedById]||null,B=N=>{if(!f||!V)return!1;const U=String(N.routeSection||"");return b.includes(U)},z=s.useMemo(()=>(Array.isArray(i)?i:[]).filter(B),[i,b]),le=s.useMemo(()=>z.filter(N=>(N.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[z]),q=s.useMemo(()=>z.filter(N=>(N.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[z]),fe=N=>l.filter(U=>U.requestId===N),Ce=N=>`"${String(N??"").replace(/"/g,'""')}"`,we=N=>{const de=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const ce of N){const ie=G(ce),Ae=ie?`${ie.rank} ${ie.lastName}, ${ie.firstName}${ie.mi?` ${ie.mi}`:""}`:"",Se=fe(ce.id).map(Ee=>Ee.name).join(" | ");de.push([ce.id,ce.subject,ce.currentStage||"",ce.routeSection||"",Ae,ce.unitUic||"",new Date(ce.createdAt).toLocaleString(),Se])}return de.map(ce=>ce.map(Ce).join(",")).join(`\r
`)},v=(N,U)=>{const de=new Blob([U],{type:"text/csv;charset=utf-8;"}),ce=URL.createObjectURL(de),ie=document.createElement("a");ie.href=ce,ie.download=N,document.body.appendChild(ie),ie.click(),document.body.removeChild(ie),URL.revokeObjectURL(ce)},ee=()=>v("hqmc_pending.csv",we(le)),se=()=>v("hqmc_in_scope.csv",we(q)),ne=()=>v("hqmc_all.csv",we([...le,...q])),Q=async N=>{const U=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",de=String(u[N.id]||"").trim();if(!de){alert("Select an HQMC section to route to approver");return}const ce={actor:U,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${de}`,comment:(E[N.id]||"").trim()},ie={...N,routeSection:de,activity:Array.isArray(N.activity)?[...N.activity,ce]:[ce]};try{await qe(ie)}catch{}h(Ae=>Ae.map(Se=>Se.id===ie.id?ie:Se)),y(Ae=>({...Ae,[N.id]:""}))},be=async N=>{const de={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC",comment:(E[N.id]||"").trim()},ce={...N,currentStage:Fs(N.currentStage),activity:Array.isArray(N.activity)?[...N.activity,de]:[de]};try{await qe(ce)}catch{}h(ie=>ie.map(Ae=>Ae.id===ce.id?ce:Ae)),y(ie=>({...ie,[N.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:f||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ne,children:"Export All"}),b.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>A(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>T("Pending"),className:`${R==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>T("In Scope"),className:`${R==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[R==="Pending"&&e.jsx(Ke,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ee,children:"Export Pending"}),requests:le,users:P,onRowClick:N=>Z(U=>({...U,[N.id]:!U[N.id]})),expandedRows:L,children:N=>e.jsxs("div",{id:`details-hq-${N.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[N.id],"aria-controls":`docs-hq-${N.id}`,onClick:()=>{J(U=>({...U,[N.id]:!U[N.id]})),_(U=>j[N.id]?null:N.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[N.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${N.id}`,ref:j[N.id]?d:void 0,className:`${j[N.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:fe(N.id).map(U=>({...U,fileUrl:U.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:E[N.id]||"",onChange:U=>y(de=>({...de,[N.id]:U.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:u[N.id]||"",onChange:U=>k(de=>({...de,[N.id]:U.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),g.filter(U=>String(U.division_code||"")===f).map(U=>e.jsx("option",{value:U.branch,children:U.branch},U.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Q(N),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>be(N),children:"Return"})]})]})]})}),R==="In Scope"&&e.jsx(Ke,{title:"In Scope",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:se,children:"Export In Scope"}),requests:q,users:P,onRowClick:N=>Z(U=>({...U,[N.id]:!U[N.id]})),expandedRows:L,children:N=>e.jsxs("div",{id:`details-hq-${N.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[N.id],"aria-controls":`docs-hq-${N.id}`,onClick:()=>{J(U=>({...U,[N.id]:!U[N.id]})),_(U=>j[N.id]?null:N.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[N.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${N.id}`,ref:j[N.id]?d:void 0,className:`${j[N.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:fe(N.id).map(U=>({...U,fileUrl:U.fileUrl}))})})]})})]})]}),$&&t&&e.jsx(Bs,{currentUser:t,divisionCode:f,branches:g.filter(N=>String(N.division_code||"")===f).map(N=>N.branch),assignments:te,onClose:()=>A(!1)})]})}const dt=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Ws=t=>{const a=dt.indexOf(t||dt[0]);return a>0?dt[a-1]:dt[0]};function Hs(){const[t,a]=s.useState(()=>{try{const v=localStorage.getItem("currentUser");return v?JSON.parse(v):null}catch{return null}}),[i,h]=s.useState([]),[l,w]=s.useState([]),[E,y]=s.useState({}),[P,O]=s.useState({}),[L,Z]=s.useState({}),[j,J]=s.useState({}),[H,_]=s.useState(null),d=s.useRef(null),[te,D]=s.useState([]),[R,T]=s.useState("Pending");s.useEffect(()=>{const v=se=>{H&&d.current&&!d.current.contains(se.target)&&(J(ne=>({...ne,[H]:!1})),_(null))},ee=se=>{se.key==="Escape"&&H&&(J(ne=>({...ne,[H]:!1})),_(null))};return document.addEventListener("mousedown",v),document.addEventListener("keydown",ee),()=>{document.removeEventListener("mousedown",v),document.removeEventListener("keydown",ee)}},[H]),s.useEffect(()=>{ut().then(v=>h(v)).catch(()=>h([]))},[]),s.useEffect(()=>{wt().then(v=>w(v)).catch(()=>w([]))},[]),s.useEffect(()=>{Xe().then(v=>{const ee={};for(const se of v)se!=null&&se.id&&(ee[se.id]=se);O(ee)}).catch(()=>O({}))},[]),s.useEffect(()=>{At().then(D).catch(()=>D([]))},[]);const g=(t==null?void 0:t.id)||"",F=String((t==null?void 0:t.hqmcDivision)||""),u=s.useMemo(()=>te.filter(v=>v.division_code===F&&(v.approvers||[]).includes(g)).map(v=>v.branch),[te,F,g]),k=v=>P[v.uploadedById]||null,$=v=>{if(!F||!g)return!1;const ee=String(v.routeSection||"");return u.includes(ee)},A=s.useMemo(()=>(Array.isArray(i)?i:[]).filter($),[i,u]),V=s.useMemo(()=>A.filter(v=>(v.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[A]),f=s.useMemo(()=>A.filter(v=>(v.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[A]),b=v=>l.filter(ee=>ee.requestId===v),G=v=>`"${String(v??"").replace(/"/g,'""')}"`,B=v=>{const se=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const ne of v){const Q=k(ne),be=Q?`${Q.rank} ${Q.lastName}, ${Q.firstName}${Q.mi?` ${Q.mi}`:""}`:"",N=b(ne.id).map(U=>U.name).join(" | ");se.push([ne.id,ne.subject,ne.currentStage||"",ne.routeSection||"",be,ne.unitUic||"",new Date(ne.createdAt).toLocaleString(),N])}return se.map(ne=>ne.map(G).join(",")).join(`\r
`)},z=(v,ee)=>{const se=new Blob([ee],{type:"text/csv;charset=utf-8;"}),ne=URL.createObjectURL(se),Q=document.createElement("a");Q.href=ne,Q.download=v,document.body.appendChild(Q),Q.click(),document.body.removeChild(Q),URL.revokeObjectURL(ne)},le=()=>z("hqmc_approver_pending.csv",B(V)),q=()=>z("hqmc_approver_approved.csv",B(f)),fe=()=>z("hqmc_approver_all.csv",B([...V,...f])),Ce=async v=>{const se={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved",comment:(E[v.id]||"").trim()},ne={...v,currentStage:"ARCHIVED",activity:Array.isArray(v.activity)?[...v.activity,se]:[se]};try{await qe(ne)}catch{}h(Q=>Q.map(be=>be.id===ne.id?ne:be)),y(Q=>({...Q,[v.id]:""}))},we=async v=>{const se={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver",comment:(E[v.id]||"").trim()},ne={...v,currentStage:Ws(v.currentStage),activity:Array.isArray(v.activity)?[...v.activity,se]:[se]};try{await qe(ne)}catch{}h(Q=>Q.map(be=>be.id===ne.id?ne:be)),y(Q=>({...Q,[v.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((t==null?void 0:t.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:fe,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>T("Pending"),className:`${R==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>T("Approved"),className:`${R==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"})]})}),e.jsxs("div",{className:"mt-4",children:[R==="Pending"&&e.jsx(Ke,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:le,children:"Export Pending"}),requests:V,users:P,onRowClick:v=>Z(ee=>({...ee,[v.id]:!ee[v.id]})),expandedRows:L,children:v=>e.jsxs("div",{id:`details-hqa-${v.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[v.id],"aria-controls":`docs-hqa-${v.id}`,onClick:()=>{J(ee=>({...ee,[v.id]:!ee[v.id]})),_(ee=>j[v.id]?null:v.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[v.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${v.id}`,ref:j[v.id]?d:void 0,className:`${j[v.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:b(v.id).map(ee=>({...ee,fileUrl:ee.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:E[v.id]||"",onChange:ee=>y(se=>({...se,[v.id]:ee.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Ce(v),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>we(v),children:"Return"})]})]})}),R==="Approved"&&e.jsx(Ke,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:q,children:"Export Approved"}),requests:f,users:P,onRowClick:v=>Z(ee=>({...ee,[v.id]:!ee[v.id]})),expandedRows:L,children:v=>e.jsxs("div",{id:`details-hqa-${v.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[v.id],"aria-controls":`docs-hqa-${v.id}`,onClick:()=>{J(ee=>({...ee,[v.id]:!ee[v.id]})),_(ee=>j[v.id]?null:v.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[v.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${v.id}`,ref:j[v.id]?d:void 0,className:`${j[v.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(at,{documents:b(v.id).map(ee=>({...ee,fileUrl:ee.fileUrl}))})})]})})]})]})})}const zs=({onUnitSelect:t,selectedUnit:a})=>{const[i,h]=s.useState(""),[l,w]=s.useState(!1),E=Fe.filter(P=>P.unitName.toLowerCase().startsWith(i.toLowerCase())||P.uic.toLowerCase().startsWith(i.toLowerCase())||P.ruc.toLowerCase().startsWith(i.toLowerCase())),y=P=>{t(P),w(!1),h("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>w(!l),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[a?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",a.uic," | RUC: ",a.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),l&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:i,onChange:P=>h(P.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:E.map(P=>e.jsxs("button",{type:"button",onClick:()=>y(P),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:P.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",P.uic," | RUC: ",P.ruc," | MCC: ",P.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[P.streetAddress,", ",P.cityState," ",P.zip]})]},P.uic))})]})]})]})},St=async t=>{const i=new TextEncoder().encode(t),h=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(h)).map(l=>l.toString(16).padStart(2,"0")).join("")};async function Qs(t,a){const i=ms();return i!=null&&i.auth?await i.auth.signUp({email:t,password:a}):{data:null,error:new Error("supabase_not_initialized")}}const _t={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},Gs=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Xt=({onSaved:t,initial:a={},mode:i="create",readOnly:h=!1,canEditRole:l=!1,canEditAdmin:w=!1})=>{const[E,y]=s.useState(""),[P,O]=s.useState(""),[L,Z]=s.useState(""),[j,J]=s.useState(a.email||""),[H,_]=s.useState(a.edipi||""),[d,te]=s.useState(a.service||""),[D,R]=s.useState(a.rank||""),[T,g]=s.useState(a.role||"MEMBER"),[F,u]=s.useState(!!a.isUnitAdmin),[k,$]=s.useState(a.company||""),[A,V]=s.useState(a.platoon||""),[f,b]=s.useState(void 0),[G,B]=s.useState(null),[z,le]=s.useState({}),[q,fe]=s.useState(""),[Ce,we]=s.useState(""),[v,ee]=s.useState([]),[se,ne]=s.useState(!1),[Q,be]=s.useState(a.roleCompany||""),[N,U]=s.useState(a.rolePlatoon||""),[de,ce]=s.useState(!1),[ie,Ae]=s.useState([]),[Se,Ee]=s.useState([]),[Pe,Ie]=s.useState([]),[_e,c]=s.useState([]);s.useEffect(()=>{if(a.firstName&&y(String(a.firstName)),a.lastName&&O(String(a.lastName)),a.mi&&Z(String(a.mi)),a.company&&$(String(a.company)),a.platoon&&V(String(a.platoon)),a.roleCompany&&be(String(a.roleCompany)),a.rolePlatoon&&U(String(a.rolePlatoon)),a.unitUic){const x=Fe.find(oe=>oe.uic===a.unitUic);x&&b(x)}},[a]);const r=s.useMemo(()=>_t[d]||[],[d]),p=s.useMemo(()=>{if(!f)return[];const x=ie;if(x&&x.length)return x;const oe=z[f.uic]||{};return Object.keys(oe).filter(ye=>!ye.startsWith("_")&&Array.isArray(oe[ye]))},[f,z,ie]),W=s.useMemo(()=>{var x;return f&&k?((x=z[f.uic])==null?void 0:x[k])||[]:[]},[f,k,z]),I=s.useMemo(()=>{if(!f||!k)return[];const x=Se;return x&&x.length?x:W},[f,k,Se,W]),re=s.useMemo(()=>{if(!f)return[];const x=Pe;if(x&&x.length)return x;const oe=z[f.uic]||{};return Object.keys(oe).filter(ye=>!ye.startsWith("_")&&Array.isArray(oe[ye]))},[f,z,Pe]),ve=s.useMemo(()=>{var x;return f&&Q?((x=z[f.uic])==null?void 0:x[Q])||[]:[]},[f,Q,z]),Ne=s.useMemo(()=>{if(!f||!Q)return[];const x=_e;return x&&x.length?x:ve},[f,Q,_e,ve]),me=s.useMemo(()=>{const x=p.slice(),oe=k||a.company||a.user_company||"";return oe&&!x.includes(oe)?[oe,...x]:x},[p,k,a]),Re=s.useMemo(()=>{const x=I.slice(),oe=A||a.platoon||a.user_platoon||"";return oe&&!x.includes(oe)?[oe,...x]:x},[I,A,a]),$e=s.useMemo(()=>{const x=re.slice(),oe=Q||a.roleCompany||"",ye=oe&&!x.includes(oe)?[oe,...x]:x;return Array.from(new Set(ye))},[re,Q,a]),He=s.useMemo(()=>{const x=Ne.slice(),oe=N||a.rolePlatoon||"";return oe&&!x.includes(oe)?[oe,...x]:x},[Ne,N,a]);s.useEffect(()=>{(async()=>{try{if(i==="edit"&&a.id){const x=await Vt(String(a.id));x&&(x.company&&!k&&$(String(x.company)),x.platoon&&!A&&V(String(x.platoon)),x.roleCompany&&!Q&&be(String(x.roleCompany)),x.rolePlatoon&&!N&&U(String(x.rolePlatoon)))}}catch{}})()},[i,a.id]),s.useEffect(()=>{r.includes(D)||R("")},[r]),s.useEffect(()=>{V("")},[k]),s.useEffect(()=>{U("")},[Q]),s.useEffect(()=>{try{const x=localStorage.getItem("unit_structure");x&&le(JSON.parse(x))}catch{}},[f]),s.useEffect(()=>{const x=(f==null?void 0:f.uic)||"";if(!x){Ae([]),Ie([]);return}Wt(x).then(oe=>{Ae(oe||[]),Ie(oe||[])}).catch(()=>{Ae([]),Ie([])})},[f]),s.useEffect(()=>{const x=(f==null?void 0:f.uic)||"",oe=k||"";if(!x||!oe){Ee([]);return}vt(x,oe).then(ye=>Ee(ye||[])).catch(()=>Ee([]))},[f,k]),s.useEffect(()=>{const x=(f==null?void 0:f.uic)||"",oe=Q||"";if(!x||!oe){c([]);return}vt(x,oe).then(ye=>c(ye||[])).catch(()=>c([]))},[f,Q]),s.useEffect(()=>{Xe().then(x=>{ee(x)}).catch(()=>ee([]))},[]),s.useEffect(()=>{const x=(f==null?void 0:f.uic)||"";if(!x){ne(!1);return}const oe=v.some(ye=>!!ye.isUnitAdmin&&(ye.unitUic||"")===x);ne(oe)},[f,v]),s.useEffect(()=>{if(f){!k&&a.company&&me.includes(a.company)&&$(String(a.company));const x=a.platoon;!A&&x&&Re.includes(x)&&V(String(x))}},[f,me,Re,k,A,a]);const ze=x=>/^[0-9]{10}$/.test(x),Ze=(x,oe)=>{try{return v.some(ye=>String(ye.edipi)===String(x)&&String(ye.id)!==String(oe||""))}catch{return!1}},et=async x=>{var Qe,je;if(x.preventDefault(),B(null),h)return;if(!E.trim())return B({type:"error",message:"First name is required."});if(!P.trim())return B({type:"error",message:"Last name is required."});if(L&&!/^[A-Za-z]$/.test(L))return B({type:"error",message:"MI must be a single letter."});if(!j.trim())return B({type:"error",message:"Email is required."});if(!ze(String(H)))return B({type:"error",message:"EDIPI must be 10 digits."});if(!d)return B({type:"error",message:"Service is required."});if(!D)return B({type:"error",message:"Rank is required."});if(Ze(String(H),a.id?String(a.id):void 0))return B({type:"error",message:"EDIPI already exists."});if(T==="COMPANY_REVIEWER"&&!Q)return B({type:"error",message:"Role Company is required for Company Reviewer."});if(T==="PLATOON_REVIEWER"&&(!Q||!N))return B({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${E.trim()}`,L&&""+L.trim().toUpperCase(),`${P.trim()}`;let oe=a.id?String(a.id):`usr-${Date.now()}`,ye=a.passwordHash||"";if(i==="create"){if(!q||q.length<8)return B({type:"error",message:"Password must be at least 8 characters."});if(q!==Ce)return B({type:"error",message:"Passwords do not match."});try{const{data:ke,error:Ge}=await Qs(j.trim(),q);if(Ge){B({type:"error",message:`Failed to create auth user: ${String(Ge.message||Ge)}`});return}const Ue=(Qe=ke==null?void 0:ke.user)!=null&&Qe.id?String(ke.user.id):"";if(!Ue){B({type:"error",message:"Auth user ID missing after sign up."});return}oe=Ue}catch(ke){B({type:"error",message:`Failed to create auth user: ${String((ke==null?void 0:ke.message)||ke)}`});return}ye=await St(q)}else if(i==="edit"&&q){if(q.length<8)return B({type:"error",message:"Password must be at least 8 characters."});if(q!==Ce)return B({type:"error",message:"Passwords do not match."});ye=await St(q)}const Oe={id:oe,firstName:E.trim(),lastName:P.trim(),mi:L?L.trim().toUpperCase():void 0,email:j.trim(),edipi:H,service:d,rank:D,role:T,company:k||"N/A",unit:(f==null?void 0:f.unitName)||"N/A",unitUic:f==null?void 0:f.uic,passwordHash:ye,isUnitAdmin:i==="create"&&f&&!se?!0:F,roleCompany:Q||void 0,rolePlatoon:N||void 0,platoon:A||"N/A"};try{const ke=await We({id:Oe.id,email:Oe.email,rank:Oe.rank,firstName:Oe.firstName,lastName:Oe.lastName,mi:Oe.mi,service:Oe.service,role:Oe.role,unitUic:Oe.unitUic,unit:(f==null?void 0:f.unitName)||"N/A",company:Oe.company,isUnitAdmin:!!Oe.isUnitAdmin,edipi:String(Oe.edipi),passwordHash:ye,platoon:A||"N/A",roleCompany:Q||void 0,rolePlatoon:N||void 0});if(!ke.ok){B({type:"error",message:`Failed to save profile: ${String(((je=ke==null?void 0:ke.error)==null?void 0:je.message)||(ke==null?void 0:ke.error)||"unknown")}`});return}B({type:"success",message:a.id?"Profile updated.":f&&!se?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),t==null||t(Oe)}catch{B({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:i==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:et,className:"space-y-6",children:[i==="create"&&f&&!se&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:f.unitName})," (UIC ",f.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:P,onChange:x=>O(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:E,onChange:x=>y(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:L,maxLength:1,onChange:x=>Z(x.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:j,onChange:x=>J(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:H,onChange:x=>_(x.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:d,onChange:x=>te(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(_t).map(x=>e.jsx("option",{value:x,children:x},x))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:D,onChange:x=>R(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),r.map(x=>e.jsx("option",{value:x,children:x},x))]})]}),i==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:q,onChange:x=>fe(x.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:Ce,onChange:x=>we(x.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]})]}):e.jsx(e.Fragment,{})]})]}),de&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:q,onChange:x=>fe(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:Ce,onChange:x=>we(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>ce(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>ce(!1),children:"Save"})]})]})}),i==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:T,onChange:x=>g(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:Gs.map(x=>e.jsx("option",{value:x,children:x},x))})}),e.jsx("div",{children:e.jsxs("select",{value:Q||String(a.roleCompany||""),onChange:x=>be(x.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:$e.length?"Select company":"No companies configured"}),$e.map(x=>e.jsx("option",{value:x,children:x},x))]})}),e.jsx("div",{children:e.jsxs("select",{value:N||String(a.rolePlatoon||""),onChange:x=>U(x.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:He.length?"Select platoon":"No platoons configured"}),He.map(x=>e.jsx("option",{value:x,children:x},x))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:F,onChange:x=>u(x.target.checked),disabled:h||!w}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(a==null?void 0:a.isCommandStaff)||T==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(zs,{onUnitSelect:x=>b(x),selectedUnit:f})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:k||String(a.company||""),onChange:x=>$(x.target.value),disabled:h||!f||me.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:me.length?"Select company":"No companies configured"}),me.map(x=>e.jsx("option",{value:x,children:x},x))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:A||String(a.platoon||""),onChange:x=>V(x.target.value),disabled:h||!f||!k||Re.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Re.length?"Select platoon":"No platoons configured"}),Re.map(x=>e.jsx("option",{value:x,children:x},x))]})]})]})})]}),G&&e.jsx("div",{className:`p-3 rounded-lg border ${G.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:G.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[i==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>ce(!0),disabled:h,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:h,children:i==="edit"?"Save":"Create Profile"})]})]})]})},Us=s.memo(function({user:a,onClose:i}){const h=()=>{const l=Fe.find(E=>E.uic===a.unitUic),w=l?l.unitName:a.unit;if(a.isUnitAdmin||a.role==="COMMANDER")return w||"—";if(a.role==="COMPANY_REVIEWER")return a.company&&a.company!=="N/A"?a.company:"—";if(a.role==="PLATOON_REVIEWER"){const E=a.company&&a.company!=="N/A"?a.company:"",y=a.platoon&&a.platoon!=="N/A"?a.platoon:"",P=[E,y].filter(Boolean);return P.length?P.join(" / "):"—"}return"—"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:l=>l.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:i,children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:a.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:a.edipi||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:a.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:a.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:h()})]}),a.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),a.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:i,children:"Close"})})]})})}),Js=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Ys=()=>{const[t,a]=s.useState(null),[i,h]=s.useState(void 0),[l,w]=s.useState({}),[E,y]=s.useState({}),[P,O]=s.useState({}),[L,Z]=s.useState({}),[j,J]=s.useState(""),[H,_]=s.useState(""),[d,te]=s.useState(""),[D,R]=s.useState(""),[T,g]=s.useState(""),[F,u]=s.useState([]),[k,$]=s.useState(null),[A,V]=s.useState(""),f=s.useRef(null),[b,G]=s.useState(null),[B,z]=s.useState(null),[le,q]=s.useState(""),[fe,Ce]=s.useState(void 0),[we,v]=s.useState(void 0),[ee,se]=s.useState(void 0),[ne,Q]=s.useState(void 0),[be,N]=s.useState(void 0),[U,de]=s.useState(void 0),[ce,ie]=s.useState([]),[Ae,Se]=s.useState([]),[Ee,Pe]=s.useState(""),[Ie,_e]=s.useState("unit"),[c,r]=s.useState([]),[p,W]=s.useState(!1),[I,re]=s.useState(!1),[ve,Ne]=s.useState(!1),[me,Re]=s.useState("admin"),$e=s.useRef(!1);s.useEffect(()=>{b&&me==="admin"&&!$e.current&&(!fe&&b.company&&b.company!=="N/A"&&(Ce(b.company),se(b.company)),!we&&b.platoon&&b.platoon!=="N/A"&&(v(b.platoon),Q(b.platoon)),!be&&b.roleCompany&&b.roleCompany!=="N/A"&&N(b.roleCompany),!U&&b.rolePlatoon&&b.rolePlatoon!=="N/A"&&de(b.rolePlatoon),$e.current=!0)},[b,me]),s.useEffect(()=>{try{const n=localStorage.getItem("unit_structure");n&&w(JSON.parse(n))}catch{}try{const n=localStorage.getItem("unit_structure"),o={},S={},K={};if(n){const pe=JSON.parse(n);for(const he of Object.keys(pe||{})){const ae=pe[he];ae&&Array.isArray(ae._sections)&&(o[he]=ae._sections),ae&&Array.isArray(ae._commandSections)&&(S[he]=ae._commandSections),ae&&ae._platoonSectionMap&&typeof ae._platoonSectionMap=="object"&&(K[he]=ae._platoonSectionMap)}}else(async()=>{try{const pe=await pt();for(const he of Object.keys(pe||{})){const ae=pe[he];ae&&Array.isArray(ae._sections)&&(o[he]=ae._sections),ae&&Array.isArray(ae._commandSections)&&(S[he]=ae._commandSections),ae&&ae._platoonSectionMap&&typeof ae._platoonSectionMap=="object"&&(K[he]=ae._platoonSectionMap)}w(pe)}catch{}})();y(o),O(S),Z(K)}catch{}Xe().then(n=>{u(n)}).catch(()=>u([]));try{const n=localStorage.getItem("currentUser");if(n){const o=JSON.parse(n);if(a(o),o.unitUic){const S=Fe.find(K=>K.uic===o.unitUic);S&&h(S)}}}catch{}},[]),s.useEffect(()=>{try{if(!i){const n=Object.keys(l||{});if(n.length){const o=n[0],S=l[o]||{},pe=Fe.find(he=>he.uic===o)||{ruc:String(S._ruc||""),mcc:String(S._mcc||""),uic:o,unitName:String(S._unitName||o),streetAddress:String(S._streetAddress||"")};h(pe)}}}catch{}},[l]),s.useEffect(()=>{const n=(b==null?void 0:b.unitUic)||"";if(!n){ie([]);return}Wt(n).then(o=>ie(o||[])).catch(()=>ie([]))},[b]),s.useEffect(()=>{const n=(b==null?void 0:b.unitUic)||"",o=be||"";if(!n||!o){Se([]);return}vt(n,o).then(S=>Se(S||[])).catch(()=>Se([]))},[b,be]);const He=s.useMemo(()=>{const n=(i==null?void 0:i.uic)||"";if(!n)return[];const o=l[n]||{};return Object.keys(o).filter(S=>!S.startsWith("_")&&Array.isArray(o[S]))},[i,l]),ze=s.useMemo(()=>{var S;const n=(i==null?void 0:i.uic)||"";if(!n||!j)return[];const o=(S=l[n])==null?void 0:S[j];return Array.isArray(o)?o:[]},[i,j,l]),Ze=s.useMemo(()=>{const n=(i==null?void 0:i.uic)||"";return n?E[n]||[]:[]},[i,E]),et=s.useMemo(()=>{const n=(i==null?void 0:i.uic)||"";return n?P[n]||[]:[]},[i,P]),x=s.useMemo(()=>{const n=(b==null?void 0:b.unitUic)||"";if(!n)return[];const o=ce;if(o&&o.length)return o;const S=l[n]||{};return Object.keys(S).filter(K=>!K.startsWith("_")&&Array.isArray(S[K]))},[b,l,ce]),oe=s.useMemo(()=>{var K;const n=(b==null?void 0:b.unitUic)||"",o=ee||"";if(!n||!o)return[];const S=(K=l[n])==null?void 0:K[o];return Array.isArray(S)?S:[]},[b,ee,l]),ye=s.useMemo(()=>{var pe,he;const n=(b==null?void 0:b.unitUic)||"",o=be||"";if(!o)return[];const S=Ae;if(S&&S.length>0)return S;if(n){const ae=(pe=l[n])==null?void 0:pe[o];if(Array.isArray(ae)&&ae.length>0)return ae}const K=(i==null?void 0:i.uic)||"";if(K&&K!==n){const ae=(he=l[K])==null?void 0:he[o];if(Array.isArray(ae))return ae}return[]},[b,be,l,Ae,i]),Oe=s.useMemo(()=>{const n=x.slice(),o=fe||(b&&b.company!=="N/A"?b.company:"");return o&&!n.includes(o)?[o,...n]:n},[x,fe,b]);s.useMemo(()=>{const n=oe.slice(),o=ne||(b&&b.platoon&&b.platoon!=="N/A"?b.platoon:"");return o&&!n.includes(o)?[o,...n]:n},[oe,ne,b]);const Qe=s.useMemo(()=>{const n=ye.slice(),o=U||(b&&b.rolePlatoon&&b.rolePlatoon!=="N/A"?b.rolePlatoon:"");return o&&!n.includes(o)?[o,...n]:n},[ye,U,b]),je=()=>{try{if(i){const n=i.uic,o={...l};o[n]=o[n]||{},o[n]._mcc=i.mcc||o[n]._mcc||"",o[n]._unitName=i.unitName||o[n]._unitName||"",w(o),localStorage.setItem("unit_structure",JSON.stringify(o)),(async()=>{try{if(navigator.sendBeacon){const K=new Blob([JSON.stringify(o)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",K),$({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o),keepalive:!0})).ok)throw new Error("persist_failed");$({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{$({type:"error",message:"Failed to persist unit structure."})}})()}else{const n=JSON.stringify(l);localStorage.setItem("unit_structure",n),(async()=>{try{if(navigator.sendBeacon){const S=new Blob([n],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",S),$({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:n,keepalive:!0})).ok)throw new Error("persist_failed");$({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{$({type:"error",message:"Failed to persist unit structure."})}})()}}catch{$({type:"error",message:"Failed to save unit structure."})}},ke=()=>{try{if(!i)return;const n=i.uic,o={...l};o[n]=o[n]||{},o[n]._sections=E[n]||[],o[n]._mcc=i.mcc||o[n]._mcc||"",o[n]._unitName=i.unitName||o[n]._unitName||"",w(o),localStorage.setItem("unit_structure",JSON.stringify(o)),(async()=>{try{if(navigator.sendBeacon){const K=new Blob([JSON.stringify(o)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",K),$({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o),keepalive:!0})).ok)throw new Error("persist_failed");$({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{$({type:"error",message:"Failed to persist unit sections."})}})()}catch{$({type:"error",message:"Failed to save unit sections."})}},Ge=()=>{try{if(!i)return;const n=i.uic,o={...l};o[n]=o[n]||{},o[n]._commandSections=P[n]||[],o[n]._mcc=i.mcc||o[n]._mcc||"",o[n]._unitName=i.unitName||o[n]._unitName||"",w(o),localStorage.setItem("unit_structure",JSON.stringify(o)),(async()=>{try{if(navigator.sendBeacon){const K=new Blob([JSON.stringify(o)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",K),$({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o),keepalive:!0})).ok)throw new Error("persist_failed");$({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{$({type:"error",message:"Failed to persist command sections."})}})()}catch{$({type:"error",message:"Failed to save command sections."})}},Ue=()=>{try{if(!i)return;const n=i.uic,o={...l};o[n]=o[n]||{},o[n]._platoonSectionMap=L[n]||{},o[n]._mcc=i.mcc||o[n]._mcc||"",o[n]._unitName=i.unitName||o[n]._unitName||"",w(o),localStorage.setItem("unit_structure",JSON.stringify(o)),(async()=>{try{if(navigator.sendBeacon){const K=new Blob([JSON.stringify(o)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",K),$({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o),keepalive:!0})).ok)throw new Error("persist_failed");$({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{$({type:"error",message:"Failed to persist links."})}})()}catch{$({type:"error",message:"Failed to save links."})}},xt=()=>{if(!i||!H.trim())return;const n=i.uic,o={...l};o[n]=o[n]||{},o[n][H.trim()]||(o[n][H.trim()]=[],w(o),J(H.trim()),_(""))},m=n=>{if(!i)return;const o=i.uic,S={...l};S[o]&&(delete S[o][n],w(S),j===n&&J(""))},C=()=>{if(!i||!j||!d.trim())return;const n=i.uic,o={...l};o[n]=o[n]||{},o[n][j]=o[n][j]||[],o[n][j].includes(d.trim())||(o[n][j]=[...o[n][j],d.trim()],w(o),te(""))},M=n=>{if(!i||!j)return;const o=i.uic,S={...l};S[o][j]=(S[o][j]||[]).filter(K=>K!==n),w(S)},Y=()=>{if(!i||!D.trim())return;const n=i.uic,o={...E};o[n]=o[n]||[],o[n].includes(D.trim())||(o[n]=[...o[n],D.trim()],y(o),R(""))},X=n=>{if(!i)return;const o=i.uic,S={...E};S[o]=(S[o]||[]).filter(K=>K!==n),y(S)},ge=()=>{if(!i||!T.trim())return;const n=i.uic,o={...P};o[n]=o[n]||[],o[n].includes(T.trim())||(o[n]=[...o[n],T.trim()],O(o),g(""))},xe=n=>{if(!i)return;const o=i.uic,S={...P};S[o]=(S[o]||[]).filter(K=>K!==n),O(S)},ue=()=>{const n=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],o=F.map(ae=>[ae.firstName,ae.mi||"",ae.lastName,ae.email,ae.edipi,ae.service,ae.rank,ae.role,ae.company,ae.unit,ae.unitUic||""].map(ot=>{const Je=String(ot??"");return Je.includes(",")||Je.includes('"')||Je.includes(`
`)?'"'+Je.replace(/"/g,'""')+'"':Je}).join(",")),S="\uFEFF"+[n.join(","),...o].join(`
`),K=new Blob([S],{type:"text/csv;charset=utf-8"}),pe=URL.createObjectURL(K),he=document.createElement("a");he.href=pe,he.download="users-export.csv",he.click(),URL.revokeObjectURL(pe)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${Ie==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>_e("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${Ie==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>_e("users"),children:"User Administration"})]})})}),Ie==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:i?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",i.uic," | RUC: ",i.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:je,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:H,onChange:n=>_(n.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:xt,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[He.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>J(n),children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>m(n),children:"Remove"})]},n)),He.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",j?`• ${j}`:""]}),i&&j&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:Ue,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:d,onChange:n=>te(n.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!j}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:C,disabled:!j,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[ze.map(n=>{var o,S;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:n})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:((S=(o=L[(i==null?void 0:i.uic)||""])==null?void 0:o[j])==null?void 0:S[n])||"",onChange:K=>{const pe=(i==null?void 0:i.uic)||"";Z(he=>{const ae={...he};return ae[pe]=ae[pe]||{},ae[pe][j]=ae[pe][j]||{},ae[pe][j][n]=K.target.value,ae})},children:[e.jsx("option",{value:"",children:"Link to section"}),(E[(i==null?void 0:i.uic)||""]||[]).map(K=>e.jsx("option",{value:K,children:K},K))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>M(n),children:"Remove"})]})]},n)}),ze.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ke,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:D,onChange:n=>R(n.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Y,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Ze.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>X(n),children:"Remove"})]},n)),Ze.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:Ge,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:T,onChange:n=>g(n.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:ge,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[et.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>xe(n),children:"Remove"})]},n)),et.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),Ie==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[F.filter(n=>{const o=!A||(n.email??"").toLowerCase().includes(A.toLowerCase())||(n.lastName??"").toLowerCase().includes(A.toLowerCase()),S=i?n.unitUic===i.uic||n.unit&&n.unit===i.unitName:!0;return o&&S}).map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[n.lastName,", ",n.firstName,n.mi?` ${n.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:n.email}),e.jsx("td",{className:"py-2 px-3",children:n.edipi}),e.jsx("td",{className:"py-2 px-3",children:n.service}),e.jsx("td",{className:"py-2 px-3",children:n.rank}),e.jsx("td",{className:"py-2 px-3",children:n.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const o=Fe.find(K=>K.uic===n.unitUic),S=o?o.unitName:n.unit;if(n.isUnitAdmin||n.role==="COMMANDER")return S||"—";if(n.role==="COMPANY_REVIEWER")return n.company&&n.company!=="N/A"?n.company:"—";if(n.role==="PLATOON_REVIEWER"){const K=n.company&&n.company!=="N/A"?n.company:"",pe=n.platoon&&n.platoon!=="N/A"?n.platoon:"",he=[K,pe].filter(Boolean);return he.length?he.join(" / "):"—"}return"—"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>z(n),children:"View"}),((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{Re("admin"),G(n),q(n.role??"MEMBER"),Ce(n.company!=="N/A"?n.company:void 0),se(n.company!=="N/A"?n.company:void 0),v(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),Q(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),Pe(typeof n.commandOrder=="number"?String(n.commandOrder):""),re(!!n.isUnitAdmin),Ne(!!n.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{u(o=>o.filter(S=>S.id!==n.id));try{localStorage.removeItem(`fs/users/${n.id}.json`)}catch(o){console.error("Failed to remove user from localStorage",o)}},children:"Delete"})]})})]},n.id)),F.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:"No users"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:f,type:"text",placeholder:"Filter users...",value:A,onChange:n=>V(n.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var n;return(n=f.current)==null?void 0:n.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:ue,children:"Export All"})]})]}),B&&e.jsx(Us,{user:B,onClose:()=>z(null)}),b&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>G(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>G(null),children:"✕"})]}),me==="profile"&&t&&b&&t.edipi===b.edipi&&e.jsx(Xt,{mode:"edit",initial:b,readOnly:!1,onSaved:n=>{u(o=>o.map(S=>S.edipi===n.edipi?n:S)),G(null),$({type:"success",message:"Profile updated."})}}),me==="admin"&&((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:le,onChange:n=>{const o=n.target.value;q(o),o==="COMMANDER"&&(Ce(void 0),v(void 0))},className:"w-full px-3 py-2 border rounded",children:Js.map(n=>e.jsx("option",{value:n,children:n},n))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:be||"",onChange:n=>N(n.target.value||void 0),disabled:!le.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Oe.length?"Select company":"No companies configured"}),Oe.map(n=>e.jsx("option",{value:n,children:n},n))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:U||"",onChange:n=>de(n.target.value||void 0),disabled:!le.includes("REVIEW")||!be,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Qe.length?"Select platoon":"No platoons configured"}),Qe.map(n=>e.jsx("option",{value:n,children:n},n))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:I,onChange:n=>re(n.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:ve,disabled:le==="COMMANDER",onChange:async n=>{const o=n.target.checked;Ne(o);try{if(b&&!(await We({id:b.id,email:b.email,rank:b.rank,firstName:b.firstName,lastName:b.lastName,mi:b.mi,service:b.service,role:b.role,unitUic:b.unitUic,unit:b.unit,company:b.company,isUnitAdmin:!!b.isUnitAdmin,isCommandStaff:o,edipi:b.edipi,passwordHash:b.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})]}),c.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:c.map((n,o)=>e.jsx("div",{className:"text-sm",children:n},o))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{G(null),$e.current=!1,r([]),W(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${p?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":p,disabled:p,onClick:async()=>{var K;if(!b)return;const n=[];if(le==="COMPANY_REVIEWER"&&!fe&&n.push("Company is required for Company Reviewer."),le==="PLATOON_REVIEWER"&&(!fe||!we)&&n.push("Company and Platoon are required for Platoon Reviewer."),r(n),n.length)return;W(!0);const o=((K=Fe.find(pe=>pe.uic===b.unitUic))==null?void 0:K.unitName)||"N/A",S={...b,role:le,isUnitAdmin:I,isCommandStaff:le==="COMMANDER"?!1:ve,company:ee||"N/A",unit:o,platoon:ne||"N/A",roleCompany:le.includes("REVIEW")?be||"N/A":void 0,rolePlatoon:le.includes("REVIEW")?U||"N/A":void 0};try{localStorage.setItem(`fs/users/${S.edipi}.json`,JSON.stringify(S))}catch{}try{if(!(await We({id:S.id,email:S.email,rank:S.rank,firstName:S.firstName,lastName:S.lastName,mi:S.mi,service:S.service,role:S.role,unitUic:S.unitUic,unit:S.unit,company:S.company,isUnitAdmin:!!S.isUnitAdmin,isCommandStaff:!!S.isCommandStaff,edipi:S.edipi,passwordHash:S.passwordHash,roleCompany:S.roleCompany,rolePlatoon:S.rolePlatoon,platoon:S.platoon})).ok)throw new Error("persist_failed")}catch{W(!1),$({type:"error",message:"Failed to save administrative changes."});return}u(pe=>pe.map(he=>he.edipi===S.edipi?S:he));try{t&&t.edipi===S.edipi&&(localStorage.setItem("currentUser",JSON.stringify(S)),a(S))}catch{}G(null),$e.current=!1,W(!1),$({type:"success",message:"Administrative changes saved."})},children:[p&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),k&&e.jsx("div",{className:`p-3 rounded-lg border ${k.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:k.message})]})};function Ks(){const[t,a]=s.useState([]),[i,h]=s.useState(null),[l,w]=s.useState({}),[E,y]=s.useState({}),[P,O]=s.useState([]),[L,Z]=s.useState("unit"),[j,J]=s.useState("assigned"),[H,_]=s.useState([]),[d,te]=s.useState(""),[D,R]=s.useState([]),[T,g]=s.useState(""),F=()=>{Xe().then(r=>a(r)).catch(()=>a([]))},u=()=>{ut().then(r=>O(r)).catch(()=>O([]))},k=()=>{h(null),F(),u()};s.useEffect(()=>{k(),Ht().then(r=>_(r)),Bt().then(r=>R(r))},[L,j]);const $=s.useMemo(()=>{const r={};for(const p of t)p.isUnitAdmin&&p.unitUic&&(r[p.unitUic]=p);return r},[t]),A=s.useMemo(()=>{const r=new Set;return Fe.filter(p=>r.has(p.uic)?!1:(r.add(p.uic),!0))},[]),V=s.useMemo(()=>{const r={};for(const p of t)if(p.isInstallationAdmin&&p.installationId){const W=p.installationId;r[W]=r[W]||[],r[W].push(p)}return r},[t]),f=r=>t.filter(p=>p.unitUic===r.uic||!p.unitUic&&p.unit===r.unitName),b=async r=>{const p=l[r.uic];if(!p)return;const W=t.find(re=>re.id===p);if(!W)return;const I={...W,isUnitAdmin:!0,unitUic:r.uic,unit:r.unitName,company:"N/A"};try{if(!(await We({id:I.id,email:I.email,rank:I.rank,firstName:I.firstName,lastName:I.lastName,mi:I.mi,service:I.service,role:I.role,unitUic:I.unitUic,unit:I.unit,company:I.company,isUnitAdmin:!!I.isUnitAdmin,isInstallationAdmin:!!I.isInstallationAdmin,isCommandStaff:!!I.isCommandStaff,edipi:I.edipi})).ok){h({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}a(re=>re.map(ve=>ve.id===I.id?I:ve)),h({type:"success",message:`Assigned ${I.rank} ${I.lastName} as admin for ${r.unitName}.`})},G=s.useMemo(()=>A.filter(r=>!!$[r.uic]),[A,$]);s.useMemo(()=>(Array.isArray(t)?t:[]).filter(r=>!!r.isHqmcAdmin),[t]);const B=s.useMemo(()=>A.filter(r=>!$[r.uic]),[A,$]),z=s.useMemo(()=>(Array.isArray(H)?H:[]).filter(r=>{var p;return(p=V[r.id])==null?void 0:p.length}),[H,V]),le=s.useMemo(()=>(Array.isArray(H)?H:[]).filter(r=>{var p;return!((p=V[r.id])!=null&&p.length)}),[H,V]),q=s.useMemo(()=>{const r={};for(const p of Array.isArray(t)?t:[])if(p.isHqmcAdmin&&p.hqmcDivision){const W=p.hqmcDivision;r[W]=r[W]||[],r[W].push(p)}return r},[t]),fe=s.useMemo(()=>(Array.isArray(D)?D:[]).filter(r=>{var p;return(p=q[r.code])==null?void 0:p.length}),[D,q]);s.useMemo(()=>{const r=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return(Array.isArray(P)?P:[]).filter(p=>r.includes(String(p.currentStage||"")))},[P]);const[Ce,we]=s.useState(1),[v,ee]=s.useState(10),se=G.length,ne=Math.max(1,Math.ceil(se/(v||1))),Q=Math.min(Ce,ne),be=se===0?0:(Q-1)*v+1,N=se===0?0:Math.min(be+v-1,se),U=G.slice((Q-1)*v,(Q-1)*v+v),[de,ce]=s.useState(1),[ie,Ae]=s.useState(10),Se=B.length,Ee=Math.max(1,Math.ceil(Se/(ie||1))),Pe=Math.min(de,Ee),Ie=Se===0?0:(Pe-1)*ie+1,_e=Se===0?0:Math.min(Ie+ie-1,Se),c=B.slice((Pe-1)*ie,(Pe-1)*ie+ie);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${L==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Z("unit"),J("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${L==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Z("installation"),J("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${L==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Z("hqmc"),J("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${j==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>J("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${j==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>J("missing"),children:"Missing"})]}),L==="installation"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[z.map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:r.name}),e.jsx("td",{className:"py-2 px-3",children:(V[r.id]||[]).map(p=>`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`).join(" • ")})]},r.id)),z.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),L==="installation"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[le.map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:r.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:E[r.id]||"",onChange:p=>y(W=>({...W,[r.id]:p.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(p=>e.jsx("option",{value:p.id,children:`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`},p.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!E[r.id],onClick:async()=>{const p=E[r.id],W=t.find(re=>re.id===p);if(!W)return;const I={...W,isInstallationAdmin:!0,installationId:r.id};try{if(!(await We({id:I.id,email:I.email,rank:I.rank,firstName:I.firstName,lastName:I.lastName,mi:I.mi,service:I.service,role:I.role,unitUic:I.unitUic,unit:I.unit,company:I.company,isUnitAdmin:!!I.isUnitAdmin,isInstallationAdmin:!!I.isInstallationAdmin,isCommandStaff:!!I.isCommandStaff,edipi:I.edipi,installationId:I.installationId})).ok){h({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}a(re=>re.map(ve=>ve.id===I.id?I:ve)),h({type:"success",message:`Assigned ${I.rank} ${I.lastName} as installation admin.`})},children:"Assign"})})]},r.id)),le.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),L==="unit"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[U.map(r=>{const p=$[r.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:r.unitName}),e.jsx("td",{className:"py-2 px-3",children:r.uic}),e.jsx("td",{className:"py-2 px-3",children:`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`})]},r.uic)}),G.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(Nt,{currentPage:Q,totalPages:ne,totalItems:se,pageSize:v,startIndex:be,endIndex:N,onPageChange:r=>we(r),onPageSizeChange:r=>{ee(r),we(1)},onNext:()=>we(Math.min(Q+1,ne)),onPrevious:()=>we(Math.max(Q-1,1)),onFirst:()=>we(1),onLast:()=>we(ne),canGoNext:Q<ne,canGoPrevious:Q>1,pageSizeOptions:[5,10,25,50]})})]}),L==="unit"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[c.map(r=>{const p=f(r);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:r.unitName}),e.jsx("td",{className:"py-2 px-3",children:r.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:l[r.uic]||"",onChange:W=>w(I=>({...I,[r.uic]:W.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:p.length?"Select user":"No eligible users"}),p.map(W=>e.jsx("option",{value:W.id,children:`${W.rank} ${W.lastName}, ${W.firstName}${W.mi?` ${W.mi}`:""}`},W.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!l[r.uic],onClick:()=>b(r),children:"Assign"})})]},r.uic)}),B.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(Nt,{currentPage:Pe,totalPages:Ee,totalItems:Se,pageSize:ie,startIndex:Ie,endIndex:_e,onPageChange:r=>ce(r),onPageSizeChange:r=>{Ae(r),ce(1)},onNext:()=>ce(Math.min(Pe+1,Ee)),onPrevious:()=>ce(Math.max(Pe-1,1)),onFirst:()=>ce(1),onLast:()=>ce(Ee),canGoNext:Pe<Ee,canGoPrevious:Pe>1,pageSizeOptions:[5,10,25,50]})})]}),L==="hqmc"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[fe.map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[r.code," — ",r.name]}),e.jsx("td",{className:"py-2 px-3",children:(q[r.code]||[]).map(p=>`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`).join(" • ")})]},r.code)),fe.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),L==="hqmc"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[D.filter(r=>{var p;return!((p=q[r.code])!=null&&p.length)}).map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[r.code," — ",r.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:E[`hqmc_${r.code}`]||"",onChange:p=>y(W=>({...W,[`hqmc_${r.code}`]:p.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(p=>e.jsx("option",{value:p.id,children:`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`},p.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!E[`hqmc_${r.code}`],onClick:async()=>{const p=E[`hqmc_${r.code}`],W=t.find(re=>re.id===p);if(!W)return;const I={...W,isHqmcAdmin:!0,hqmcDivision:r.code};try{if(!(await We({id:I.id,email:I.email,rank:I.rank,firstName:I.firstName,lastName:I.lastName,mi:I.mi,service:I.service,role:I.role,unitUic:I.unitUic,unit:I.unit,company:I.company,isUnitAdmin:!!I.isUnitAdmin,isInstallationAdmin:!!I.isInstallationAdmin,isCommandStaff:!!I.isCommandStaff,isHqmcAdmin:!!I.isHqmcAdmin,hqmcDivision:I.hqmcDivision,edipi:I.edipi})).ok){h({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}a(re=>re.map(ve=>ve.id===I.id?I:ve)),h({type:"success",message:`Assigned ${I.rank} ${I.lastName} as HQMC admin for ${r.code}.`})},children:"Assign"})})]},r.code)),D.filter(r=>{var p;return!((p=q[r.code])!=null&&p.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),i&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${i.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:i.message})]})})}const Lt=!0,Xs=({onLoggedIn:t,onCreateAccount:a})=>{const[i,h]=s.useState(""),[l,w]=s.useState(""),[E,y]=s.useState(null),[P,O]=s.useState(!0),[L,Z]=s.useState(!0);ss.useEffect(()=>{},[]);const j=async J=>{J.preventDefault(),y(null);try{const H=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,_=/^[0-9]{10}$/.test(i),d=Lt?H.test(i.trim().toLowerCase())||_:H.test(i.trim().toLowerCase()),te=l.length>=6;if(O(d),Z(te),!d){y({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!te){y({type:"error",message:"Password must be at least 6 characters."});return}let D=null,R=null,T=i.trim().toLowerCase();if(Lt&&_){const{user:V,error:f}=await yt(String(i));D=V,R=f,T=String((D==null?void 0:D.email)||"")}else if(H.test(T)){const{user:V,error:f}=await kt(T);D=V,R=f}else{y({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(R){y({type:"error",message:`Database Error: ${R}`});return}if(!D||!T){y({type:"error",message:"Account not found."});return}const g=String(D.passwordHash||D.password_hash||"").trim();if(!g){y({type:"error",message:"No password set for this user."});return}const F=await St(l);if(!(/^[0-9a-f]{64}$/i.test(g)?g.toLowerCase()===F.toLowerCase():g===l)){y({type:"error",message:"Invalid credentials."});return}const{user:$,error:A}=await kt(T);if(A){y({type:"error",message:`Profile Error: ${A}`});return}if(!$){console.error("[Login] User profile not found after successful password verification",{emailForLogin:T}),y({type:"error",message:"User profile not found."});return}y({type:"success",message:"Logged in."}),t($)}catch(H){console.error("[Login] Login failed:",H),y({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:j,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:i,onChange:J=>h(J.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${P?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!P}),!P&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:l,onChange:J=>w(J.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${L?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!L}),!L&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),E&&e.jsx("div",{className:`p-3 rounded-lg border ${E.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:E.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:a,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!P||!L,children:"Login"})]})]})]})},qt=""+new URL("logo-DLcHofKE.png",import.meta.url).href,Zs=({currentUser:t,hasSectionDashboard:a,hasCommandDashboard:i,hasInstallationSectionDashboard:h=!1,hasInstallationCommandDashboard:l=!1,hasHQMCSectionDashboard:w=!1,hasHQMCApproverDashboard:E=!1,onManageProfile:y,onLogout:P,onNavigate:O,isLogin:L=!1})=>{const[Z,j]=s.useState(!1),[J,H]=s.useState(!1),_=s.useRef(null);return s.useEffect(()=>{const d=D=>{if(!Z)return;const R=_.current;R&&D.target&&!R.contains(D.target)&&j(!1)},te=D=>{D.key==="Escape"&&j(!1)};return document.addEventListener("mousedown",d),document.addEventListener("touchstart",d,{passive:!0}),document.addEventListener("keydown",te),()=>{document.removeEventListener("mousedown",d),document.removeEventListener("touchstart",d),document.removeEventListener("keydown",te)}},[Z]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:L?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:qt,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:qt,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:t?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[t.rank," ",t.lastName,t.lastName?",":""," ",t.firstName,t.mi?` ${t.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[t.service," • ",t.role,(()=>{const d={PLATOON_REVIEWER:t.role_platoon,COMPANY_REVIEWER:t.role_company}[t.role];return d?` - ${d}`:null})()]}),(()=>{var T;const d=((T=Fe.find(g=>g.uic===((t==null?void 0:t.unitUic)||"")))==null?void 0:T.unitName)||(t==null?void 0:t.unit)||"",te=t!=null&&t.company&&t.company!=="N/A"?t.company:t!=null&&t.user_company&&t.user_company!=="N/A"?t.user_company:null,D=t!=null&&t.platoon&&t.platoon!=="N/A"?t.platoon:t!=null&&t.user_platoon&&t.user_platoon!=="N/A"?t.user_platoon:null,R=[d||null,te,D].filter(Boolean);return R.length?e.jsx("div",{className:"text-xs text-white/70",children:R.join(" • ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:y,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:P,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),t&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>H(!J),children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),J&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{y(),H(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{P(),H(!1)},children:"Logout"})]})]}),!t&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>O("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:_,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":Z,onClick:()=>j(d=>!d),children:"Dashboards"}),e.jsxs("div",{className:`${Z?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:t&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("dashboard"),j(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(t==null?void 0:t.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("admin"),j(!1)},children:"Unit Admin"}),t&&!!t.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("appadmin"),j(!1)},children:"App Admin"}),t&&!!t.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("hqmc-admin"),j(!1)},children:"HQMC Admin"}),t&&!!t.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("installation"),j(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[t&&a&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("section"),j(!1)},children:"Unit Section Dashboard"}),i&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("command"),j(!1)},children:"Unit Command Dashboard"}),String((t==null?void 0:t.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("review"),j(!1)},children:"Unit Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[t&&h&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("installation-section"),j(!1)},children:"Installation Section Dashboard"}),t&&l&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("installation-command"),j(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[t&&(w||!!t.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("hqmc-section"),j(!1)},children:"HQMC Section Dashboard"}),t&&E&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("hqmc-approver"),j(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})},Le={SECTION:"perm_section",COMMAND:"perm_command",INST_SECTION:"perm_inst_section",INST_COMMAND:"perm_inst_command",HQMC_SECTION:"perm_hqmc_section",HQMC_APPROVER:"perm_hqmc_approver"},st=t=>{try{return localStorage.getItem(t)==="true"}catch(a){return console.error(`Failed to read from localStorage for key "${t}":`,a),!1}};function ea(){const[t,a]=s.useState(null),[i,h]=s.useState("login"),[l,w]=s.useState(()=>{try{const u=localStorage.getItem("currentUser");return u?JSON.parse(u):null}catch(u){return console.error("Failed to parse user from localStorage:",u),null}}),[E,y]=s.useState("create"),[P,O]=s.useState(!1),[L,Z]=s.useState(()=>st(Le.SECTION)),[j,J]=s.useState(()=>st(Le.COMMAND)),[H,_]=s.useState(()=>st(Le.INST_SECTION)),[d,te]=s.useState(()=>st(Le.INST_COMMAND)),[D,R]=s.useState(()=>st(Le.HQMC_SECTION)),[T,g]=s.useState(()=>st(Le.HQMC_APPROVER)),F=as();return s.useEffect(()=>{try{const k=new URLSearchParams(window.location.search).get("view");if(k==="admin"||k==="profile"||k==="dashboard"||k==="login"||k==="appadmin"||k==="hqmc-admin"||k==="hqmc-section"||k==="hqmc-approver"||k==="review"||k==="section"||k==="command"||k==="installation"||k==="installation-section"||k==="installation-command"||k==="documents"||k==="document-viewer"||k==="upload")h(k);else{const $=localStorage.getItem("currentView"),A=localStorage.getItem("currentUser");h($&&A?$:"login")}}catch{h("login")}},[]),s.useEffect(()=>{l?localStorage.setItem("currentUser",JSON.stringify(l)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"),Object.values(Le).forEach(u=>{try{localStorage.removeItem(u)}catch(k){console.error(`Failed to remove item from localStorage for key "${u}":`,k)}}))},[l]),s.useEffect(()=>{if(!l)return;const u={[Le.SECTION]:L,[Le.COMMAND]:j,[Le.INST_SECTION]:H,[Le.INST_COMMAND]:d,[Le.HQMC_SECTION]:D,[Le.HQMC_APPROVER]:T};for(const[k,$]of Object.entries(u))try{localStorage.setItem(k,String($))}catch(A){console.error(`Failed to set item in localStorage for key "${k}":`,A)}},[l,L,j,H,d,D,T]),s.useEffect(()=>{let u=!1;return(async()=>{try{const k=(l==null?void 0:l.id)||"";if(!k)return;const $=await Vt(k);if($&&!u){const A=(b,G)=>b===!0||b===!1?b:G||!1,V=(b,G)=>b!=null?b||void 0:G,f={...$,isAppAdmin:A($.isAppAdmin,l==null?void 0:l.isAppAdmin),isUnitAdmin:A($.isUnitAdmin,l==null?void 0:l.isUnitAdmin),isInstallationAdmin:A($.isInstallationAdmin,l==null?void 0:l.isInstallationAdmin),isHqmcAdmin:A($.isHqmcAdmin,l==null?void 0:l.isHqmcAdmin),isCommandStaff:A($.isCommandStaff,l==null?void 0:l.isCommandStaff),installationId:V($.installationId,l==null?void 0:l.installationId),hqmcDivision:V($.hqmcDivision,l==null?void 0:l.hqmcDivision)};w(f),localStorage.setItem("currentUser",JSON.stringify(f))}}catch{}})(),()=>{u=!0}},[]),s.useEffect(()=>{i!=="login"&&l&&localStorage.setItem("currentView",i)},[i,l]),s.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const k=await pt();localStorage.setItem("unit_structure",JSON.stringify(k))}catch(u){console.error("Failed to load unit structure:",u)}})()},[]),s.useEffect(()=>{var u,k,$;if(l){try{const A=localStorage.getItem("unit_structure");if(A){const V=JSON.parse(A),f=(l==null?void 0:l.unitUic)||"",b=l!=null&&l.company&&l.company!=="N/A"?l.company:"",G=l!=null&&l.platoon&&l.platoon!=="N/A"?l.platoon:"",B=(($=(k=(u=V==null?void 0:V[f])==null?void 0:u._platoonSectionMap)==null?void 0:k[b])==null?void 0:$[G])||"";Z(!!B)}}catch(A){console.error("Failed to parse unit structure for section dashboard check",A)}J(!!(l!=null&&l.isCommandStaff)),(async()=>{try{const A=(l==null?void 0:l.installationId)||"";if(!A){_(!1),te(!1);return}const V=await Ht();try{localStorage.setItem("installations_cache",JSON.stringify(V))}catch{}const f=V==null?void 0:V.find(z=>z.id===A),b=(l==null?void 0:l.id)||"",G=!!(f&&f.sectionAssignments&&Object.values(f.sectionAssignments).some(z=>Array.isArray(z)&&z.includes(b))),B=!!(f&&(f.commandSectionAssignments&&Object.values(f.commandSectionAssignments).some(z=>Array.isArray(z)&&z.includes(b))||f.commanderUserId&&String(f.commanderUserId)===b));_(G),te(B)}catch{}})(),(async()=>{try{const A=String((l==null?void 0:l.hqmcDivision)||""),V=String((l==null?void 0:l.id)||"");if(!A||!V){R(!!(l!=null&&l.isHqmcAdmin)),g(!1);return}const{listHQMCSectionAssignmentsLegacy:f}=await ns(async()=>{const{listHQMCSectionAssignmentsLegacy:z}=await import("./db-DiCMDLv-.js").then(le=>le.z);return{listHQMCSectionAssignmentsLegacy:z}},__vite__mapDeps([0,1,2]),import.meta.url),b=await f(),G=b.some(z=>z.division_code===A&&((z.reviewers||[]).includes(V)||(z.approvers||[]).includes(V))),B=b.some(z=>z.division_code===A&&(z.approvers||[]).includes(V));R(G||!!(l!=null&&l.isHqmcAdmin)),g(B)}catch{l!=null&&l.isHqmcAdmin&&R(!0)}})()}},[l]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(Zs,{currentUser:l,hasSectionDashboard:L,hasCommandDashboard:j,hasInstallationSectionDashboard:H,hasInstallationCommandDashboard:d,hasHQMCSectionDashboard:D,hasHQMCApproverDashboard:T,onManageProfile:()=>{y("edit"),h("profile"),F("/?view=profile")},onLogout:()=>{w(null),h("login"),F("/?view=login")},onNavigate:u=>{h(u),F(`/?view=${u}`)},isLogin:i==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:i==="profile"?e.jsx(Xt,{mode:E,initial:E==="edit"?l||{}:{},onSaved:u=>{w(u),h("dashboard"),F("/?view=dashboard")}}):i==="admin"?e.jsx(Ys,{}):i==="appadmin"?e.jsx(Ks,{}):i==="login"?e.jsx(Xs,{onLoggedIn:u=>{w(u),h("dashboard"),F("/?view=dashboard")},onCreateAccount:()=>{y("create"),h("profile"),F("/?view=profile")}}):i==="review"?e.jsx($s,{}):i==="section"?e.jsx(bs,{}):i==="command"?e.jsx(fs,{}):i==="installation"?e.jsx(us,{}):i==="hqmc-admin"?e.jsx(Ts,{}):i==="installation-section"?e.jsx(ys,{}):i==="installation-command"?e.jsx(vs,{}):i==="hqmc-section"?e.jsx(Vs,{}):i==="hqmc-approver"?e.jsx(Hs,{}):e.jsx(ks,{selectedUnit:t,currentUser:l})})]})}function xa(){return e.jsx(ea,{})}export{xa as default};
