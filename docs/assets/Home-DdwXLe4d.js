const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-CdX_sRVb.js","./index-j0Hbw1lu.js","./index-BeXtzUXR.css"])))=>i.map(i=>d[i]);
import{r as s,j as e,c as gs,f as bs,a as fs,s as ns,S as Ht,v as ys,l as Mt,M as Ut,b as vs,u as Ns,R as js,d as ws,_ as Ss}from"./index-j0Hbw1lu.js";import{s as Pe,d as Cs,a as As,b as ks,l as Ft,c as Nt,e as ot,u as Fe,f as $t,g as jt,h as Ke,i as Es,j as Rs,k as rs,m as is,n as Bt,o as Is,p as os,q as Ot,r as Ds,t as cs,v as ls,w as _t,x as ds,y as zt}from"./db-CdX_sRVb.js";import{P as Lt,I as Ms}from"./InstallationAdmin-BV8jyFYh.js";import{f as ms,R as Xe,S as We,o as Ps,c as Qt,a as Yt,b as $s,d as Os,g as _s}from"./RequestTable-DYBxZ8YD.js";import{c as Ls,F as Ts,D as us,a as rt}from"./DocumentListItem-CxzoMo6B.js";import{l as wt}from"./unitStructure-QC5qYuxv.js";import qs from"./SectionDashboard-DA7IPlZj.js";import Fs from"./CommandDashboard-xRgpFJx7.js";import Bs from"./InstallationSectionDashboard-DAsKaKSI.js";import Vs from"./InstallationCommandDashboard-DNdXZNy2.js";import{U as ze}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-C6m1njU0.js";import"./utils-CLmukD0c.js";const Ws={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},Hs=({filters:t,onFiltersChange:a,statusOptions:o=[],originatorOptions:N=[],searchPlaceholder:d="Search requests...",showAdvanced:E=!0,className:D=""})=>{var Q;const[C,_]=s.useState(!1),q=s.useRef(null),W=s.useMemo(()=>Array.isArray(t.status)?t.status:[],[t.status]),X=s.useMemo(()=>{let f=0;return W.length>0&&f++,t.dateFrom&&f++,t.dateTo&&f++,t.originatorId&&f++,f},[W,t.dateFrom,t.dateTo,t.originatorId]),w=s.useCallback(f=>{a({...t,search:f.target.value})},[t,a]),J=s.useCallback(f=>{const H=W.includes(f)?W.filter(g=>g!==f):[...W,f];a({...t,status:H})},[t,W,a]),z=s.useCallback(f=>{a({...t,dateFrom:f.target.value})},[t,a]),B=s.useCallback(f=>{a({...t,dateTo:f.target.value})},[t,a]),c=s.useCallback(f=>{a({...t,originatorId:f.target.value})},[t,a]),ee=s.useCallback(()=>{var f;a(Ws),(f=q.current)==null||f.focus()},[a]),T=s.useCallback(()=>{var f;a({...t,search:""}),(f=q.current)==null||f.focus()},[t,a]);s.useEffect(()=>{const f=H=>{var g;(H.metaKey||H.ctrlKey)&&H.key==="k"&&(H.preventDefault(),(g=q.current)==null||g.focus())};return document.addEventListener("keydown",f),()=>document.removeEventListener("keydown",f)},[]);const L=t.search||X>0;return e.jsxs("div",{className:`space-y-3 ${D}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{ref:q,type:"text",value:t.search,onChange:w,placeholder:d,className:"block w-full pl-10 pr-10 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold bg-[var(--surface)] text-[var(--text)]","aria-label":"Search"}),t.search&&e.jsx("button",{onClick:T,className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600","aria-label":"Clear search",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute inset-y-0 right-8 flex items-center pointer-events-none text-xs text-gray-400",children:e.jsx("kbd",{className:"hidden sm:inline-block px-1.5 py-0.5 bg-gray-100 rounded border border-gray-200 font-mono",children:"âŒ˜K"})})]}),E&&e.jsxs("button",{onClick:()=>_(!C),className:`
              flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors
              ${C||X>0?"bg-brand-gold/10 border-brand-gold text-brand-navy":"border-brand-navy/30 text-[var(--text)] hover:bg-brand-cream/50"}
            `,"aria-expanded":C,"aria-controls":"filter-panel",children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"})}),e.jsx("span",{className:"hidden sm:inline",children:"Filters"}),X>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-brand-navy rounded-full",children:X})]}),L&&e.jsxs("button",{onClick:ee,className:"flex items-center gap-1 px-3 py-2 text-sm text-brand-red hover:text-brand-red-2 hover:bg-red-50 rounded-lg transition-colors","aria-label":"Clear all filters",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),E&&C&&e.jsxs("div",{id:"filter-panel",className:"p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[o.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Status"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:o.map(f=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-white/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:W.includes(f.value),onChange:()=>J(f.value),className:"h-4 w-4 text-brand-navy border-gray-300 rounded focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-[var(--text)]",children:f.label})]},f.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Date Range"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"From date"}),e.jsx("input",{type:"date",value:t.dateFrom,onChange:z,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"From date"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"To date"}),e.jsx("input",{type:"date",value:t.dateTo,onChange:B,min:t.dateFrom,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"To date"})]})]})]}),N.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Originator"}),e.jsxs("select",{value:t.originatorId,onChange:c,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"Filter by originator",children:[e.jsx("option",{value:"",children:"All originators"}),N.map(f=>e.jsx("option",{value:f.value,children:f.label},f.value))]})]})]}),X>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 pt-2 border-t border-brand-navy/10",children:[e.jsx("span",{className:"text-sm text-[var(--muted)]",children:"Active filters:"}),W.map(f=>{const H=o.find(g=>g.value===f);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[(H==null?void 0:H.label)||f,e.jsx("button",{onClick:()=>J(f),className:"hover:text-brand-red","aria-label":`Remove ${(H==null?void 0:H.label)||f} filter`,children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},f)}),t.dateFrom&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["From: ",t.dateFrom,e.jsx("button",{onClick:()=>a({...t,dateFrom:""}),className:"hover:text-brand-red","aria-label":"Remove from date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.dateTo&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["To: ",t.dateTo,e.jsx("button",{onClick:()=>a({...t,dateTo:""}),className:"hover:text-brand-red","aria-label":"Remove to date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.originatorId&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[((Q=N.find(f=>f.value===t.originatorId))==null?void 0:Q.label)||"Originator",e.jsx("button",{onClick:()=>a({...t,originatorId:""}),className:"hover:text-brand-red","aria-label":"Remove originator filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]})]})};function Us(t,a){return s.useMemo(()=>{let o=Array.isArray(a.items)?a.items:[];const N=Array.isArray(t.status)?t.status:[];if(t.search){const d=t.search.toLowerCase();o=o.filter(E=>a.getSearchText(E).toLowerCase().includes(d))}return N.length>0&&a.getStatus&&(o=o.filter(d=>N.includes(a.getStatus(d)))),(t.dateFrom||t.dateTo)&&a.getDate&&(o=o.filter(d=>{const E=a.getDate(d);if(!E)return!1;const D=new Date(E);if(isNaN(D.getTime()))return!1;if(t.dateFrom){const C=new Date(t.dateFrom);if(D<C)return!1}if(t.dateTo){const C=new Date(t.dateTo);if(C.setHours(23,59,59,999),D>C)return!1}return!0})),t.originatorId&&a.getOriginatorId&&(o=o.filter(d=>a.getOriginatorId(d)===t.originatorId)),o},[t,a])}function Gt(t){if(t==null)return"";const a=String(t);return a.includes('"')||a.includes(",")||a.includes(`
`)||a.includes("\r")?`"${a.replace(/"/g,'""')}"`:a}function zs(t,a){const N=a.map(E=>Gt(E.header)).join(","),d=t.map(E=>a.map(D=>{const C=D.getValue(E),_=D.format?D.format(C):C;return Gt(_)}).join(","));return[N,...d].join(`\r
`)}function Qs(t,a){const o=t.map(N=>{const d={};return a.forEach(E=>{const D=E.getValue(N);d[E.header]=E.format?E.format(D):D}),d});return JSON.stringify(o,null,2)}function Jt(t,a,o){const N=new Blob([t],{type:`${o};charset=utf-8;`}),d=URL.createObjectURL(N),E=document.createElement("a");E.href=d,E.download=a,document.body.appendChild(E),E.click(),document.body.removeChild(E),URL.revokeObjectURL(d)}function Ys({items:t,columns:a,filename:o="export",label:N="Export",variant:d="secondary",className:E="",disabled:D=!1,showCount:C=!0,formats:_=["csv"]}){const[q,W]=s.useState(!1),[X,w]=s.useState(!1),J=s.useRef(null),z=s.useCallback(ee=>{w(!0),W(!1),setTimeout(()=>{try{const T=new Date().toISOString().slice(0,10),L=`${o}_${T}`;if(ee==="csv"){const Q=zs(t,a);Jt(Q,`${L}.csv`,"text/csv")}else{const Q=Qs(t,a);Jt(Q,`${L}.json`,"application/json")}}catch(T){console.error("Export failed:",T)}finally{w(!1)}},100)},[t,a,o]);s.useEffect(()=>{const ee=T=>{J.current&&!J.current.contains(T.target)&&W(!1)};return q&&document.addEventListener("mousedown",ee),()=>{document.removeEventListener("mousedown",ee)}},[q]),s.useEffect(()=>{const ee=T=>{T.key==="Escape"&&W(!1)};return q&&document.addEventListener("keydown",ee),()=>{document.removeEventListener("keydown",ee)}},[q]);const B={primary:"bg-brand-navy text-brand-cream hover:bg-brand-navy/90",secondary:"bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold/10",text:"text-brand-navy hover:bg-brand-cream/50"},c=D||t.length===0||X;return _.length===1?e.jsxs("button",{onClick:()=>z(_[0]),disabled:c,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${B[d]}
          ${E}
        `,children:[X?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:N}),C&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]})]}):e.jsxs("div",{className:"relative",ref:J,children:[e.jsxs("button",{onClick:()=>W(!q),disabled:c,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${B[d]}
          ${E}
        `,"aria-expanded":q,"aria-haspopup":"menu",children:[X?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:N}),C&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${q?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),q&&e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-[var(--surface)] border border-brand-navy/20 rounded-lg shadow-lg z-50",role:"menu",children:[_.includes("csv")&&e.jsxs("button",{onClick:()=>z("csv"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 first:rounded-t-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export as CSV"]}),_.includes("json")&&e.jsxs("button",{onClick:()=>z("json"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 last:rounded-b-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})}),"Export as JSON"]})]})]})}const Kt=t=>{if(!t)return"";const a=new Date(t);return isNaN(a.getTime())?"":a.toLocaleDateString()},Gs=({request:t})=>{if(!t.ssic)return e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg text-center",children:[e.jsx("div",{className:"text-[var(--muted)] text-sm",children:"No retention schedule assigned"}),e.jsx("div",{className:"text-xs text-[var(--muted)] mt-1",children:"SSIC classification was not set when this request was created"})]});const a=new Date(t.createdAt),o={ssic:t.ssic,nomenclature:t.ssicNomenclature||"",bucket:t.ssicBucket||"",bucketTitle:t.ssicBucketTitle||"",dau:t.dau||"",isPermanent:t.isPermanent||!1,cutoffTrigger:t.cutoffTrigger||"CALENDAR_YEAR",cutoffDescription:t.cutoffDescription||"",retentionValue:t.retentionValue??null,retentionUnit:t.retentionUnit||"YEARS",disposalAction:t.disposalAction||"DESTROY"},N=gs(o,a),d=t.isPermanent||!1;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:`p-4 rounded-lg ${d?"bg-blue-50 border border-blue-200":"bg-amber-50 border border-amber-200"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`text-2xl ${d?"text-blue-600":"text-amber-600"}`,children:d?"ðŸ“":"â±ï¸"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-semibold text-[var(--text)]",children:[t.ssic," - ",t.ssicNomenclature]}),t.ssicBucketTitle&&e.jsx("div",{className:"text-sm text-[var(--muted)] mt-1",children:t.ssicBucketTitle}),e.jsx("div",{className:`text-xs font-medium uppercase tracking-wide mt-2 ${d?"text-blue-600":"text-amber-600"}`,children:d?"Permanent Record":"Temporary Record"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Retention Period"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:bs(o)})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Cutoff Trigger"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:fs(o.cutoffTrigger)}),t.cutoffDescription&&e.jsx("div",{className:"text-xs text-[var(--muted)] mt-1",children:t.cutoffDescription})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Disposal Action"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:d?"Transfer to National Archives":"Destroy"})]}),e.jsxs("div",{className:"bg-[var(--surface)] p-3 rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-1",children:"Record Created"}),e.jsx("div",{className:"font-medium text-[var(--text)]",children:a.toLocaleDateString()})]})]}),!d&&e.jsxs("div",{className:"p-4 bg-[var(--surface)] rounded-lg border border-brand-navy/10",children:[e.jsx("div",{className:"text-xs text-[var(--muted)] uppercase tracking-wide mb-2",children:"Estimated Disposal Eligibility"}),N?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-2xl font-bold text-brand-navy",children:N.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}),e.jsx("div",{className:"text-sm text-[var(--muted)]",children:N>new Date?e.jsxs(e.Fragment,{children:["(",Math.ceil((N.getTime()-Date.now())/(1e3*60*60*24))," days remaining)"]}):e.jsx("span",{className:"text-green-600 font-medium",children:"Eligible for disposal"})})]}):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"Unable to calculate - may require event date (case closure, separation, etc.)"})]}),t.dau&&e.jsxs("div",{className:"text-xs text-[var(--muted)] border-t border-brand-navy/10 pt-3",children:[e.jsx("span",{className:"font-medium",children:"Disposition Authority:"})," ",t.dau]})]})};function Tt(t,a={}){const{pageSize:o=25,initialPage:N=1}=a,[d,E]=s.useState(N),[D,C]=s.useState(o),_=t.length,q=Math.ceil(_/D),W=(d-1)*D,X=Math.min(W+D,_);return{currentData:s.useMemo(()=>t.slice(W,X),[t,W,X]),currentPage:d,pageSize:D,totalPages:q,totalItems:_,goToPage:L=>{const Q=Math.max(1,Math.min(L,q));E(Q)},nextPage:()=>{d<q&&E(d+1)},previousPage:()=>{d>1&&E(d-1)},goToFirstPage:()=>{E(1)},goToLastPage:()=>{E(q)},setPageSize:L=>{C(L),E(1)},canGoNext:d<q,canGoPrevious:d>1,startIndex:W+1,endIndex:X}}const mt="edms-docs";function Js(){return{uploadFile:async(E,D)=>{if(!Pe)return{url:"",error:"Supabase not configured"};try{const{error:C}=await Pe.storage.from(mt).upload(D,E,{upsert:!0});if(C)return{url:"",error:C.message};const{data:_}=Pe.storage.from(mt).getPublicUrl(D);return{url:(_==null?void 0:_.publicUrl)||""}}catch(C){return{url:"",error:C instanceof Error?C.message:"Upload failed"}}},deleteFile:async E=>{if(!Pe||!E)return!1;try{return await Pe.storage.from(mt).remove([E]),!0}catch{return!1}},deleteFolder:async E=>{if(!Pe)return!1;try{const{data:D}=await Pe.storage.from(mt).list(E.replace(/\/$/,""));if(D&&D.length>0){const C=D.map(_=>`${E.replace(/\/$/,"")}/${_.name}`);await Pe.storage.from(mt).remove(C)}return!0}catch{return!1}},extractStoragePath:E=>{if(!E)return null;try{const D=E.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(D!=null&&D[1])return decodeURIComponent(D[1])}catch{}return null},buildStoragePath:(E,D,C,_)=>{const q=Date.now();return`${E||"N-A"}/${D}/${q}-${_}-${ns(C)}`}}}const He=t=>{const a=String(t||"").trim();return a&&a!=="N/A"?a:""},nt=(t,a,o)=>t.some(N=>String(N.role||"")!==a||He(N.roleCompany||N.company)!==o.company||a==="PLATOON_REVIEWER"&&He(N.rolePlatoon||N.platoon)!==(o.platoon||"")?!1:String(N.unitUic||"")===String(o.uic||""));function xs(t){if(t===0)return"0 Bytes";const a=1024,o=["Bytes","KB","MB","GB"],N=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,N)).toFixed(2))+" "+o[N]}const Xt=s.memo(function({doc:a,onView:o,onDelete:N}){const[d,E]=s.useState(!1),D=a.fileUrl&&Ls(a.type,a.name);return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:"flex items-center justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors","aria-label":`Document: ${a.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ts,{type:a.type,fileName:a.name,size:"md"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-[var(--text)]",children:a.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)]",children:[a.name," â€¢ ",xs(a.size)," â€¢ ",new Date(a.uploadedAt).toLocaleDateString()]}),a.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(a.dueDate).toLocaleDateString()]}),a.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Notes: ",a.notes]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",role:"group","aria-label":"Document actions",children:[a.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:ms({currentStage:a.currentStage})}),D&&e.jsx("button",{type:"button",onClick:C=>{C.stopPropagation(),E(!0)},className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Preview document ${a.name}`,children:"Preview"}),a.fileUrl&&e.jsx("a",{href:a.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${a.name} in new tab`,children:"Open"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:C=>{C.stopPropagation(),o(a)},"aria-label":`View or edit document ${a.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:C=>{C.stopPropagation(),N(a)},"aria-label":`Delete document ${a.subject}`,children:"Delete"})]})]}),a.fileUrl&&e.jsx(us,{url:a.fileUrl,fileName:a.name,mimeType:a.type,fileSize:a.size,isOpen:d,onClose:()=>E(!1)})]})}),at="edms-docs",Ks=({selectedUnit:t,currentUser:a})=>{const[o,N]=s.useState([]),[d,E]=s.useState(!1),[D,C]=s.useState(""),[_,q]=s.useState(""),[W,X]=s.useState(""),[w,J]=s.useState([]),[z,B]=s.useState(null),[c,ee]=s.useState(null),[T,L]=s.useState([]),[Q,f]=s.useState(!1),[H,g]=s.useState(null),[M,F]=s.useState(""),[k,G]=s.useState(""),[S,y]=s.useState(""),[Y,U]=s.useState([]),[K,oe]=s.useState([]),[I,ge]=s.useState(null),[Se,Ce]=s.useState(""),[fe,Ae]=s.useState(""),[ye,v]=s.useState(""),[P,se]=s.useState([]),[me,le]=s.useState(!1),[Ie,ke]=s.useState({}),[Ne,Oe]=s.useState(""),[Ee,m]=s.useState("Pending"),[j,Z]=s.useState({}),[re,xe]=s.useState(""),[p,A]=s.useState(null),[i,l]=s.useState("documents"),[V,te]=s.useState(!1),[ue,pe]=s.useState(null),[Me,we]=s.useState(!1),[he,De]=s.useState(""),Ve=Js(),Ze=r=>{const h=r.target.files?Array.from(r.target.files):[];if(h.length===0)return;if(w.length+h.length>Ut){B({type:"error",message:`Cannot add ${h.length} file(s). Maximum ${Ut} files allowed per request.`});try{r.target.value=""}catch{}return}const x=[],R=[];for(const O of h){const ne=vs(O);ne.valid?x.push(O):R.push(...ne.errors)}x.length>0&&J(O=>[...O,...x]),R.length>0&&B({type:"error",message:R.slice(0,3).join(" ")+(R.length>3?` (+${R.length-3} more errors)`:"")});try{r.target.value=""}catch{}},b=()=>{if(!(I!=null&&I.ssic)){B({type:"error",message:"Request must have SSIC/retention classification before filing."});return}De(new Date().toISOString().split("T")[0]),we(!0)},de=async()=>{if(!I||!(c!=null&&c.id))return;if(!he){B({type:"error",message:"Please select a finalized date."});return}const r=new Date(he+"T23:59:59").toISOString(),x={actor:`${c.rank} ${c.lastName}, ${c.firstName}${c.mi?` ${c.mi}`:""}`,timestamp:new Date().toISOString(),action:"Filed for Records Management",comment:`Date Finalized: ${new Date(he).toLocaleDateString()}${ye!=null&&ye.trim()?` - ${ye.trim()}`:""}`},R={...I,currentStage:We.ARCHIVED,finalStatus:"Filed",filedAt:r,activity:Array.isArray(I.activity)?[...I.activity,x]:[x]};try{const O=await Fe(R);if(!O.ok)throw new Error(ve(O,"request_upsert_failed"));oe(ne=>ne.map(ce=>ce.id===R.id?R:ce)),ge(R),we(!1),De(""),B({type:"success",message:"Request filed for records management."})}catch(O){B({type:"error",message:`Failed to file request: ${String((O==null?void 0:O.message)||O)}`})}},je=async()=>{if(!I||!(c!=null&&c.id))return;const r=_s(I.currentStage||"");if(!r){B({type:"error",message:"Cannot return from this stage."});return}const h=`${c.rank} ${c.lastName}, ${c.firstName}${c.mi?` ${c.mi}`:""}`,x=r===We.ORIGINATOR_REVIEW?"Originator":r===We.PLATOON_REVIEW?"Platoon":r===We.COMPANY_REVIEW?"Company":"Lower Level",R={actor:h,actorRole:c.role||"Reviewer",timestamp:new Date().toISOString(),action:`Returned to ${x} for filing`,comment:(ye||"").trim()},O={...I,currentStage:r,activity:Array.isArray(I.activity)?[...I.activity,R]:[R]};try{const ne=await Fe(O);if(!ne.ok)throw new Error(ve(ne,"request_upsert_failed"));oe(ce=>ce.map(ae=>ae.id===O.id?O:ae)),ge(O),v(""),B({type:"success",message:`Request returned to ${x}.`})}catch(ne){B({type:"error",message:`Failed to return request: ${String((ne==null?void 0:ne.message)||ne)}`})}},$e=async()=>{if(!I||!(c!=null&&c.id)||I.uploadedById!==c.id)return;const r=T.find(be=>be.id===I.uploadedById),h=I.unitUic||(r==null?void 0:r.unitUic)||"",x=He(r==null?void 0:r.company),R=He(r==null?void 0:r.platoon),O=nt(T,"PLATOON_REVIEWER",{company:x,platoon:R,uic:h}),ne=nt(T,"COMPANY_REVIEWER",{company:x,uic:h}),ce=O?We.PLATOON_REVIEW:ne?We.COMPANY_REVIEW:We.BATTALION_REVIEW,ae={actor:`${c.rank} ${c.lastName}, ${c.firstName}${c.mi?` ${c.mi}`:""}`,actorRole:"Member",timestamp:new Date().toISOString(),action:"Resubmitted request",comment:(ye||"").trim()},_e={...I,currentStage:ce,routeSection:"",activity:[...I.activity||[],ae]};try{const be=await Fe(_e);if(!be.ok)throw new Error(ve(be,"request_upsert_failed"));oe(Te=>Te.map(qe=>qe.id===_e.id?_e:qe)),ge(_e),v(""),B({type:"success",message:"Request resubmitted for review."})}catch(be){B({type:"error",message:`Failed to resubmit: ${String((be==null?void 0:be.message)||be)}`})}},et=async r=>{r.preventDefault(),B(null);const h=D.trim();if(!h){B({type:"error",message:"Subject is required."});return}if(h.length>500){B({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(W.length>5e3){B({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(c!=null&&c.id)){B({type:"error",message:"Create a profile before submitting."});return}if(w.length>0){const be=ys(w);if(!be.valid){B({type:"error",message:be.errors[0]});return}}E(!0);const x=Date.now(),R=Ne||c.id,O=T.find(be=>be.id===R),ne=t?t.uic:(O==null?void 0:O.unitUic)||"N/A",ce=`req-${x}`;let ae=[];async function _e(be,Te){if(!Pe)throw new Error("Supabase not configured");const{error:qe}=await Pe.storage.from(at).upload(Te,be,{upsert:!0});if(qe)throw new Error(qe.message);const{data:Ge}=Pe.storage.from(at).getPublicUrl(Te);return(Ge==null?void 0:Ge.publicUrl)||""}if(w&&w.length>0){const be=[];for(let Te=0;Te<w.length;Te++){const qe=w[Te],Ge=`${ne}/${ce}/${x}-${Te}-${ns(qe.name)}`;try{const Je=await _e(qe,Ge);be.push(Je)}catch(Je){E(!1),B({type:"error",message:`Failed to upload ${qe.name}: ${String((Je==null?void 0:Je.message)||Je)}`});return}}ae=w.map((Te,qe)=>({id:`${x}-${qe}`,name:Te.name,type:Te.type,size:Te.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:ne,subject:D.trim(),dueDate:_||void 0,notes:W.trim()||void 0,uploadedById:R,currentStage:"PLATOON_REVIEW",fileUrl:be[qe]}))}ae=ae.map(be=>({...be,requestId:ce})),N(be=>[...be,...ae]),J([]),C(""),q(""),X("");try{const be=c?`${c.rank} ${c.lastName}, ${c.firstName}${c.mi?` ${c.mi}`:""}`:"Unknown",Te="Member",qe=ne,Ge=He(O==null?void 0:O.company),Je=He(O==null?void 0:O.platoon),Vt=nt(T,"PLATOON_REVIEWER",{company:Ge,platoon:Je,uic:qe}),Wt=nt(T,"COMPANY_REVIEWER",{company:Ge,uic:qe}),hs=!Vt&&!Wt,dt={id:ce,subject:D.trim(),dueDate:_||void 0,notes:W.trim()||void 0,unitUic:ne,uploadedById:R,submitForUserId:R,documentIds:ae.map(Le=>Le.id),createdAt:new Date().toISOString(),currentStage:Vt?We.PLATOON_REVIEW:Wt?We.COMPANY_REVIEW:We.BATTALION_REVIEW,routeSection:hs&&re?re:void 0,ssic:p==null?void 0:p.ssic,ssicNomenclature:p==null?void 0:p.nomenclature,ssicBucket:p==null?void 0:p.bucket,ssicBucketTitle:p==null?void 0:p.bucketTitle,isPermanent:p==null?void 0:p.isPermanent,retentionValue:p==null?void 0:p.retentionValue,retentionUnit:p==null?void 0:p.retentionUnit,cutoffTrigger:p==null?void 0:p.cutoffTrigger,cutoffDescription:p==null?void 0:p.cutoffDescription,disposalAction:p==null?void 0:p.disposalAction,dau:p==null?void 0:p.dau,activity:[{actor:be,actorRole:Te,timestamp:new Date().toISOString(),action:"Submitted request",comment:(W||"").trim()}]};try{const Le=await Fe(dt);if(!Le.ok)throw new Error(ve(Le,"request_upsert_failed"));const Dt=await $t(ae);if(!Dt.ok)throw new Error(ve(Dt,"document_upsert_failed"))}catch(Le){E(!1);try{Mt("request_persist_failed",{requestId:ce,error:String((Le==null?void 0:Le.message)||Le)},"error")}catch{}B({type:"error",message:`Failed to persist submission: ${String((Le==null?void 0:Le.message)||Le)}`});return}oe(Le=>Le.some(yt=>yt.id===dt.id)?Le.map(yt=>yt.id===dt.id?dt:yt):[...Le,dt]),E(!1),B({type:"success",message:"Submission successful."}),f(!1),xe(""),A(null)}catch{E(!1);try{Mt("request_persist_failed",{requestId:ce},"error")}catch{}B({type:"error",message:"Failed to persist submission."})}},Qe=s.useCallback(r=>{g(r),F(r.subject||""),G(r.dueDate||""),y(r.notes||"");try{const h=localStorage.getItem(`fs/requests/${r.requestId}.json`);if(h){const x=JSON.parse(h);U(Array.isArray(x.activity)?x.activity:[])}else{const O=Object.values(Object.assign({})).map(ne=>(ne==null?void 0:ne.default)??ne).find(ne=>ne&&ne.id===r.requestId);U(O&&Array.isArray(O.activity)?O.activity:[])}}catch{U([])}},[]),ve=(r,h)=>{var x;return String(((x=r.error)==null?void 0:x.message)||r.error||h)},Ye=async()=>{if(!H)return;const r=o.map(h=>h.id===H.id?{...h,subject:M.trim()||h.subject,dueDate:k||void 0,notes:S.trim()||void 0}:h);N(r);try{const R={actor:c?`${c.rank} ${c.lastName}, ${c.firstName}${c.mi?` ${c.mi}`:""}`:"Unknown",actorRole:"Member",timestamp:new Date().toISOString(),action:"Updated document",comment:(S||"").trim()},O=H.requestId?K.find(ne=>ne.id===H.requestId):null;if(O){const ne={...O,activity:Array.isArray(O.activity)?[...O.activity,R]:[R]};try{const ce=await Fe(ne);if(!ce.ok)throw new Error(ve(ce,"request_upsert_failed"))}catch(ce){console.error("Failed to save document edits:",ce),B({type:"error",message:`Failed to save document edits: ${ce.message}`});return}U(ce=>[...ce,R])}}catch{}y(""),g(null)};o.filter(r=>!(!(c!=null&&c.id)||c.role==="MEMBER"&&r.uploadedById!==c.id||r.type==="request"));const tt=r=>r.currentStage==="ORIGINATOR_REVIEW",xt=()=>String((c==null?void 0:c.role)||"").includes("REVIEW"),pt=()=>{if(!xt())return[];const r=String((c==null?void 0:c.role)||"");return T.filter(h=>{if(h.id===(c==null?void 0:c.id))return!1;if(r.includes("PLATOON")){const x=h.company&&h.company!=="N/A"?h.company:"",R=h.unit&&h.unit!=="N/A"?h.unit:"",O=c!=null&&c.company&&c.company!=="N/A"?c.company:"",ne=c!=null&&c.unit&&c.unit!=="N/A"?c.unit:"";return x===O&&R===ne}if(r.includes("COMPANY")){const x=h.company&&h.company!=="N/A"?h.company:"",R=c!=null&&c.company&&c.company!=="N/A"?c.company:"";return x===R}return r.includes("COMMANDER")?(h.unitUic||"")===((c==null?void 0:c.unitUic)||""):!1})},st=s.useCallback(async r=>{const h=Ve.extractStoragePath(r.fileUrl);try{h&&Pe&&await Pe.storage.from(at).remove([h])}catch{}try{await Cs(r.id),N(x=>x.filter(R=>R.id!==r.id)),r.requestId&&oe(x=>x.map(R=>R.id===r.requestId?{...R,documentIds:(R.documentIds||[]).filter(O=>O!==r.id)}:R)),B({type:"success",message:"Document deleted."})}catch(x){B({type:"error",message:`Failed to delete: ${String((x==null?void 0:x.message)||x)}`})}},[]),ht=s.useCallback(async r=>{const h=`${r.unitUic||"N-A"}/${r.id}/`;try{if(Pe){const{data:x}=await Pe.storage.from(at).list(h.slice(0,-1));if(x&&x.length>0){const R=x.map(O=>`${h.slice(0,-1)}/${O.name}`);await Pe.storage.from(at).remove(R)}}}catch{}try{await As(r.id),await ks(r.id),N(x=>x.filter(R=>R.requestId!==r.id)),oe(x=>x.filter(R=>R.id!==r.id)),ge(null),B({type:"success",message:"Request and files deleted."})}catch(x){B({type:"error",message:`Failed to delete request: ${String((x==null?void 0:x.message)||x)}`})}},[]),St=async()=>{if(!I||!(c!=null&&c.id)||I.uploadedById!==c.id){B({type:"error",message:"Only the requester can edit this."});return}const r=Date.now(),h=ce=>ce.replace(/[^A-Za-z0-9._-]/g,"-");async function x(ce,ae){if(!Pe)throw new Error("Supabase not configured");const{error:_e}=await Pe.storage.from(at).upload(ae,ce,{upsert:!0});if(_e)throw new Error(_e.message);const{data:be}=Pe.storage.from(at).getPublicUrl(ae);return(be==null?void 0:be.publicUrl)||""}const R=[];for(let ce=0;ce<P.length;ce++){const ae=P[ce],_e=`${I.unitUic||"N-A"}/${I.id}/${r}-${ce}-${h(ae.name)}`;try{const be=await x(ae,_e);R.push(be)}catch(be){B({type:"error",message:`Failed to upload ${ae.name}: ${String((be==null?void 0:be.message)||be)}`});return}}const O=P.map((ce,ae)=>({id:`${r}-${ae}`,name:ce.name,type:ce.type,size:ce.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:I.unitUic||"N/A",subject:Se.trim()||I.subject,dueDate:fe||void 0,notes:ye.trim()||void 0,uploadedById:c.id,currentStage:I.currentStage||"PLATOON_REVIEW",requestId:I.id,fileUrl:R[ae]})),ne={...I,subject:Se.trim()||I.subject,dueDate:fe||void 0,notes:ye.trim()||void 0,documentIds:[...I.documentIds||[],...O.map(ce=>ce.id)],activity:[...I.activity||[],{actor:`${c.rank} ${c.lastName}, ${c.firstName}${c.mi?` ${c.mi}`:""}`,timestamp:new Date().toISOString(),action:O.length?`Updated request and added ${O.length} document(s)`:"Updated request",comment:(ye||"").trim()}]};try{if(!(c&&Qt(I,String(c.id||"")))){B({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const ae=await $t(O);if(!ae.ok)throw new Error(ve(ae,"document_upsert_failed"));const _e=await Fe(ne);if(!_e.ok)throw new Error(ve(_e,"request_upsert_failed"))}catch(ae){try{Mt("request_update_failed",{requestId:ne.id,error:String((ae==null?void 0:ae.message)||ae)},"error")}catch{}B({type:"error",message:`Failed to persist documents: ${String((ae==null?void 0:ae.message)||ae)}`});return}N(ae=>[...ae,...O]),oe(ae=>ae.map(_e=>_e.id===ne.id?ne:_e)),ge(ne),se([]),v(""),B({type:"success",message:O.length?"Files added and request updated.":"Request updated."})}catch{B({type:"error",message:"Failed to update request."})}},Ct=async()=>{if(!I||!c||!ue)return;const r=`${c.rank} ${c.lastName}, ${c.firstName}${c.mi?` ${c.mi}`:""}`,h=c.role||"Reviewer",x={actor:r,actorRole:h,timestamp:new Date().toISOString(),action:"Updated retention classification",comment:`Changed SSIC to ${ue.ssic} - ${ue.nomenclature}`},R={...I,ssic:ue.ssic,ssicNomenclature:ue.nomenclature,ssicBucket:ue.bucket,ssicBucketTitle:ue.bucketTitle,isPermanent:ue.isPermanent,retentionValue:ue.retentionValue,retentionUnit:ue.retentionUnit,cutoffTrigger:ue.cutoffTrigger,cutoffDescription:ue.cutoffDescription,disposalAction:ue.disposalAction,dau:ue.dau,activity:[...I.activity||[],x]};try{const O=await Fe(R);if(!O.ok)throw new Error(ve(O,"request_upsert_failed"));oe(ne=>ne.map(ce=>ce.id===R.id?R:ce)),ge(R),te(!1),pe(null),B({type:"success",message:"Retention classification updated."})}catch(O){B({type:"error",message:`Failed to update retention: ${String((O==null?void 0:O.message)||O)}`})}},[gt,At]=s.useState(!0),[ct,kt]=s.useState(!0);s.useEffect(()=>{Ft().then(r=>{N(r)}).catch(()=>N([])).finally(()=>At(!1))},[]),s.useEffect(()=>{I&&(Ce(I.subject||""),Ae(I.dueDate||""),v(I.notes||""),se([]),te(!1),pe(null))},[I]),s.useEffect(()=>{},[o]),s.useEffect(()=>{Nt().then(r=>{oe(r)}).catch(()=>oe([])).finally(()=>kt(!1))},[]),s.useEffect(()=>{ee(a||null)},[a]),s.useEffect(()=>{ot().then(r=>{L(r)}).catch(()=>L([]))},[]),s.useEffect(()=>{try{const r=localStorage.getItem("unit_structure"),h={};if(r){const x=JSON.parse(r);for(const R of Object.keys(x||{})){const O=x[R];O&&Array.isArray(O._sections)&&(h[R]=O._sections)}Z(h)}else(async()=>{try{const x=await wt();for(const R of Object.keys(x||{})){const O=x[R];O&&Array.isArray(O._sections)&&(h[R]=O._sections)}Z(h)}catch{}})()}catch{}},[]);const Et=s.useMemo(()=>c!=null&&c.id?K.filter(h=>h.uploadedById===c.id).filter(h=>h.currentStage!=="ARCHIVED"):[],[K,c]),bt=s.useCallback(r=>{if(r.isPermanent)return"Permanent";if(!r.retentionValue||!r.cutoffTrigger||!r.filedAt)return"Unknown";const h=new Date(r.filedAt);let x;switch(r.cutoffTrigger){case"CALENDAR_YEAR":x=new Date(h.getFullYear(),11,31);break;case"FISCAL_YEAR":x=h.getMonth()>=9?new Date(h.getFullYear()+1,8,30):new Date(h.getFullYear(),8,30);break;default:x=h}const R=new Date(x);return r.retentionUnit==="years"?R.setFullYear(R.getFullYear()+r.retentionValue):r.retentionUnit==="months"?R.setMonth(R.getMonth()+r.retentionValue):r.retentionUnit==="days"&&R.setDate(R.getDate()+r.retentionValue),R.getFullYear().toString()},[]),lt=s.useMemo(()=>{if(!(c!=null&&c.id))return{};const r=K.filter(x=>x.uploadedById===c.id&&x.ssic&&x.filedAt),h={};for(const x of r){const R=bt(x),O=x.ssicBucketTitle||x.ssicBucket||"Uncategorized";h[R]||(h[R]={}),h[R][O]||(h[R][O]=[]),h[R][O].push(x)}for(const x of Object.keys(h))for(const R of Object.keys(h[x]))h[x][R].sort((O,ne)=>new Date(ne.createdAt).getTime()-new Date(O.createdAt).getTime());return h},[K,c,bt]),ft=s.useMemo(()=>Object.keys(lt).sort((h,x)=>h==="Permanent"?-1:x==="Permanent"||h==="Unknown"?1:x==="Unknown"?-1:parseInt(h)-parseInt(x)),[lt]),Rt=s.useCallback(r=>{if(!r.retentionValue||!r.cutoffTrigger||!r.filedAt)return"N/A";if(r.isPermanent)return"Permanent";const h=new Date(r.filedAt);let x;switch(r.cutoffTrigger){case"CALENDAR_YEAR":x=new Date(h.getFullYear(),11,31);break;case"FISCAL_YEAR":x=h.getMonth()>=9?new Date(h.getFullYear()+1,8,30):new Date(h.getFullYear(),8,30);break;default:x=h}const R=new Date(x);return r.retentionUnit==="years"?R.setFullYear(R.getFullYear()+r.retentionValue):r.retentionUnit==="months"?R.setMonth(R.getMonth()+r.retentionValue):r.retentionUnit==="days"&&R.setDate(R.getDate()+r.retentionValue),R.toLocaleDateString()},[]),It=s.useCallback(r=>{var x;const h=T.find(R=>R.id===r.uploadedById);return h?`${h.lastName}, ${((x=h.firstName)==null?void 0:x.charAt(0))||""}`:"Unknown"},[T]),Re=Tt(Et,{pageSize:10}),n=s.useMemo(()=>T.reduce((r,h)=>({...r,[h.id]:h}),{}),[T]),u=s.useMemo(()=>{const r=Ne||(c==null?void 0:c.id),h=T.find(ae=>ae.id===r),x=t?t.uic:(h==null?void 0:h.unitUic)||"",R=He(h==null?void 0:h.company),O=He(h==null?void 0:h.platoon);if(!x)return!1;const ne=nt(T,"PLATOON_REVIEWER",{company:R,platoon:O,uic:x}),ce=nt(T,"COMPANY_REVIEWER",{company:R,uic:x});return!ne&&!ce},[T,c,Ne,t]),$=s.useMemo(()=>{const r=Ne||(c==null?void 0:c.id),h=T.find(R=>R.id===r),x=t?t.uic:(h==null?void 0:h.unitUic)||"";return j[x]||[]},[j,T,c,Ne,t]),ie=s.useCallback(r=>{const h=He(r.currentStage||"PLATOON_REVIEW"),x=T.find(R=>R.id===r.uploadedById);switch(h){case"ORIGINATOR_REVIEW":return{level:"Member",scope:""};case"PLATOON_REVIEW":{const R=x!=null&&x.company&&x.company!=="N/A"?x.company:"",O=x!=null&&x.platoon&&x.platoon!=="N/A"?x.platoon:"";return R&&O?{level:"Platoon",scope:`(${R}-${O})`}:R?{level:"Platoon",scope:`(${R})`}:{level:"Platoon",scope:""}}case"COMPANY_REVIEW":{const R=x!=null&&x.company&&x.company!=="N/A"?x.company:"";return{level:"Company",scope:R?`(${R})`:""}}case"BATTALION_REVIEW":return{level:"Battalion",scope:r.routeSection?`(${r.routeSection})`:""};case"COMMANDER_REVIEW":return{level:"Commander",scope:r.routeSection?`(${r.routeSection})`:""};case"ARCHIVED":return{level:"Archived",scope:""};default:return{level:ms(r),scope:""}}},[T]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>f(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),Q&&e.jsxs("form",{onSubmit:et,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:D,onChange:r=>C(r.target.value),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${D.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:_,onChange:r=>q(r.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),e.jsx("div",{children:e.jsx(Ht,{value:p,onChange:A,required:!0})}),String((c==null?void 0:c.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:Ne,onChange:r=>Oe(r.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),pt().map(r=>e.jsxs("option",{value:r.id,children:[r.rank," ",r.lastName,", ",r.firstName,r.mi?` ${r.mi}`:""]},r.id))]})]})}),u&&$.length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Battalion Section"}),e.jsxs("select",{value:re,onChange:r=>xe(r.target.value),className:`w-full px-3 py-2 border ${re?"border-brand-navy/30":"border-brand-gold"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`,children:[e.jsx("option",{value:"",children:"Select section"}),$.map(r=>e.jsx("option",{value:r,children:r},r))]}),e.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"No platoon/company reviewer available. Select a section for routing."})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:W,onChange:r=>X(r.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:Ze,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:w.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:w.map((r,h)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:r.name,children:r.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>J(x=>x.filter((R,O)=>O!==h)),children:"Delete"})]},h))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{f(!1),J([]),C(""),q(""),X(""),xe(""),A(null),B(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!D.trim()||!p,children:"Submit"})]})]}),z&&e.jsx("div",{className:`p-3 rounded-lg border ${z.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:z.message})]})]}),e.jsxs("div",{className:"p-6",children:[c&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>m("Pending"),className:`${Ee==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>m("Files"),className:`${Ee==="Files"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Files"})]})}),Ee==="Pending"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:Re.totalItems>0?`${Re.startIndex}â€“${Re.endIndex} of ${Re.totalItems}`:""}),ct&&e.jsx("div",{className:"animate-pulse",children:"Loading requestsâ€¦"})]}),e.jsx(Xe,{title:"Your Requests",requests:ct?Array.from({length:5}).map((r,h)=>({id:`s-${h}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:We.PLATOON_REVIEW})):Re.currentData,users:n,onRowClick:r=>ge(r),expandedRows:Ie,children:r=>e.jsxs("div",{id:`req-docs-${r.id}`,children:[gt?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):o.filter(h=>h.requestId===r.id&&h.type!=="request").map(h=>e.jsx(Xt,{doc:h,onView:Qe,onDelete:st},h.id)),!gt&&o.filter(h=>h.requestId===r.id&&h.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),Re.totalItems>0&&e.jsx(Lt,{currentPage:Re.currentPage,totalPages:Re.totalPages,totalItems:Re.totalItems,pageSize:Re.pageSize,startIndex:Re.startIndex,endIndex:Re.endIndex,onPageChange:Re.goToPage,onPageSizeChange:Re.setPageSize,onNext:Re.nextPage,onPrevious:Re.previousPage,onFirst:Re.goToFirstPage,onLast:Re.goToLastPage,canGoNext:Re.canGoNext,canGoPrevious:Re.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),Ee==="Files"&&e.jsx("div",{className:"py-4 space-y-6",children:ct?e.jsx("div",{className:"animate-pulse",children:"Loading recordsâ€¦"}):ft.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("p",{children:"No filed records yet."}),e.jsx("p",{className:"text-sm mt-1",children:'Archive a request and click "File" to add it to records management.'})]}):e.jsx(e.Fragment,{children:ft.map(r=>{const h=lt[r],x=Object.keys(h).sort(),R=r==="Permanent",O=Object.values(h).reduce((ne,ce)=>ne+ce.length,0);return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`${R?"bg-blue-800":"bg-brand-navy"} text-brand-cream px-4 py-2 rounded-lg font-medium flex items-center justify-between`,children:[e.jsx("span",{children:R?"Permanent Records":`Disposal Year: ${r}`}),e.jsxs("span",{className:"text-xs bg-white/20 px-2 py-0.5 rounded",children:[O," record",O!==1?"s":""]})]}),x.map(ne=>{const ce=h[ne];return e.jsxs("div",{className:"ml-4",children:[e.jsxs("div",{className:"bg-gray-100 text-gray-700 px-3 py-1.5 rounded-t-lg font-medium text-sm border border-b-0 border-gray-200 flex items-center justify-between",children:[e.jsx("span",{children:ne}),e.jsxs("span",{className:"text-xs text-gray-500",children:[ce.length," item",ce.length!==1?"s":""]})]}),e.jsx("div",{className:"border border-gray-200 rounded-b-lg overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Name"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"SSIC"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Retention"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Disposal Date"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Date Finalized"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Originator"}),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-500",children:"Disposal Action"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:ce.map(ae=>e.jsxs("tr",{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>ge(ae),children:[e.jsx("td",{className:"px-3 py-2 font-medium text-brand-navy",children:ae.subject}),e.jsx("td",{className:"px-3 py-2",children:ae.ssic}),e.jsx("td",{className:"px-3 py-2",children:ae.isPermanent?e.jsx("span",{className:"inline-flex px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded",children:"Permanent"}):e.jsxs("span",{className:"inline-flex px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded",children:[ae.retentionValue," ",ae.retentionUnit]})}),e.jsx("td",{className:"px-3 py-2",children:Rt(ae)}),e.jsx("td",{className:"px-3 py-2",children:ae.filedAt?new Date(ae.filedAt).toLocaleDateString():"N/A"}),e.jsx("td",{className:"px-3 py-2",children:It(ae)}),e.jsx("td",{className:"px-3 py-2",children:ae.disposalAction||(ae.isPermanent?"TRANSFER":"DESTROY")})]},ae.id))})]})})]},`${r}-${ne}`)})]},r)})})})]}),d&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),H&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>g(null),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:M,onChange:r=>F(r.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:k,onChange:r=>G(r.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:H.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:S,onChange:r=>y(r.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[H.name," â€¢ ",xs(H.size)," â€¢ ",new Date(H.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:Y.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):Y.map((r,h)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[r.actor,r.actorRole?` â€¢ ${r.actorRole}`:""," â€¢ ",new Date(r.timestamp).toLocaleString()," â€¢ ",r.action]}),r.comment&&e.jsx("div",{className:"text-gray-600",children:r.comment})]},h))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>g(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:Ye,children:"Save"})]})]})}),I&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>ge(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>ge(null),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:Se,onChange:r=>Ce(r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(I.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:fe,onChange:r=>Ae(r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),I.currentStage&&(()=>{const{level:r,scope:h}=ie(I);return e.jsxs("span",{className:"inline-flex flex-col items-center px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-lg border border-brand-navy/30 leading-tight",children:[e.jsx("span",{children:r}),h&&e.jsx("span",{className:"text-[10px]",children:h})]})})(),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:3,value:ye,onChange:r=>v(r.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-4","aria-label":"Request details tabs",children:[e.jsx("button",{onClick:()=>l("documents"),className:`${i==="documents"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Documents"}),e.jsx("button",{onClick:()=>l("retention"),className:`${i==="retention"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Retention"}),e.jsx("button",{onClick:()=>l("activity"),className:`${i==="activity"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Activity"})]})}),e.jsxs("div",{className:"mt-3",children:[i==="documents"&&e.jsxs("div",{className:"space-y-3",children:[o.filter(r=>r.requestId===I.id&&r.type!=="request").length>0?o.filter(r=>r.requestId===I.id&&r.type!=="request").map(r=>e.jsx(Xt,{doc:r,onView:Qe,onDelete:st},r.id)):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents attached"}),!Ps(I,String((c==null?void 0:c.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:r=>{const h=r.target.files?Array.from(r.target.files):[];se(x=>[...x,...h]);try{r.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2 mt-2",children:P.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):P.map((r,h)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:r.name,children:r.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>se(x=>x.filter((R,O)=>O!==h)),children:"Delete"})]},h))})]})]}),i==="retention"&&e.jsx("div",{children:V?e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ht,{value:ue,onChange:pe,required:!0}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{te(!1),pe(null)},className:"px-3 py-1 rounded border border-brand-navy/30 text-brand-navy hover:bg-brand-cream text-sm",children:"Cancel"}),e.jsx("button",{type:"button",onClick:Ct,disabled:!ue,className:"px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 text-sm disabled:opacity-50",children:"Save Retention"})]})]}):e.jsxs("div",{children:[I.ssic?e.jsx(Gs,{request:I}):e.jsx("div",{className:"text-sm text-[var(--muted)] p-4 bg-gray-50 rounded-lg",children:"No retention information available for this request."}),c&&I.currentStage!=="ARCHIVED"&&e.jsx("button",{type:"button",onClick:()=>te(!0),className:"mt-3 px-3 py-1 rounded border border-brand-navy/30 text-brand-navy hover:bg-brand-cream text-sm",children:I.ssic?"Change Retention":"Add Retention Info"})]})}),i==="activity"&&e.jsx("div",{className:"space-y-2",children:I.activity&&I.activity.length?I.activity.map((r,h)=>e.jsxs("div",{className:"text-xs text-gray-700 p-2 bg-gray-50 rounded",children:[e.jsxs("div",{className:"font-medium",children:[r.actor,r.actorRole?` â€¢ ${r.actorRole}`:""," â€¢ ",new Date(r.timestamp).toLocaleString()," â€¢ ",r.action]}),r.comment&&e.jsx("div",{className:"text-gray-600 mt-1",children:r.comment})]},h)):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No activity recorded"})})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>ge(null),children:"Close"}),c&&!I.filedAt&&!Yt(I,String((c==null?void 0:c.id)||""))&&Qt(I,String((c==null?void 0:c.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:St,children:"Save Changes"}),c&&Yt(I,String((c==null?void 0:c.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700",onClick:b,children:"File"}),c&&$s(I)&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-amber-500 text-white hover:bg-amber-600",onClick:je,children:"Return"}),c&&tt(I)&&c.id===I.uploadedById&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700",onClick:$e,children:"Resubmit"}),c&&Os(I,String((c==null?void 0:c.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>ht(I),children:"Delete Request"})]})]})}),Me&&I&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]",onClick:()=>we(!1),children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md p-6",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"File for Records Management"}),e.jsx("button",{className:"text-gray-500 hover:text-gray-700",onClick:()=>we(!1),children:"âœ•"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date Finalized"}),e.jsx("input",{type:"date",value:he,onChange:r=>De(r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"This date will be used to calculate the disposal date based on the retention schedule."})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 text-sm",children:[e.jsx("div",{className:"font-medium text-gray-700 mb-1",children:"Retention Info"}),e.jsxs("div",{className:"text-gray-600",children:[e.jsxs("div",{children:["SSIC: ",I.ssic," - ",I.ssicNomenclature]}),e.jsxs("div",{children:["Retention: ",I.isPermanent?"Permanent":`${I.retentionValue} ${I.retentionUnit}`]}),e.jsxs("div",{children:["Cutoff: ",I.cutoffDescription||I.cutoffTrigger]})]})]}),z&&e.jsx("div",{className:`p-3 rounded-lg border ${z.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:z.message})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>we(!1),className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"button",onClick:de,disabled:!he,className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50",children:"File Record"})]})]})})]})},Xs=({currentUser:t,onClose:a})=>{const[o,N]=s.useState([]),[d,E]=s.useState(""),[D,C]=s.useState(!1),[_,q]=s.useState(""),[W,X]=s.useState(!1),[w,J]=s.useState("");s.useEffect(()=>{jt().then(L=>{N(L.data||[])}).catch(()=>N([]))},[]);const z=s.useMemo(()=>String(t.role||"")!=="MEMBER",[t]),B=s.useMemo(()=>{const L=Q=>{const f=t.unitUic||"",H=String(t.role||"");if(H.includes("PLATOON")){const g=Q.company&&Q.company!=="N/A"?Q.company:"",M=Q.platoon&&Q.platoon!=="N/A"?Q.platoon:"",F=t.company&&t.company!=="N/A"?t.company:"",k=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return g===F&&M===k}if(H.includes("COMPANY")){const g=Q.company&&Q.company!=="N/A"?Q.company:"",M=t.company&&t.company!=="N/A"?t.company:"";return g===M}return H.includes("COMMANDER")?(Q.unitUic||"")===f:!1};return o.filter(Q=>Q.id!==t.id&&L(Q))},[o,t]),c=s.useMemo(()=>{const L=String(t.role||""),Q=f=>{const H=t.unitUic||"";if(L.includes("PLATOON")){const g=f.company&&f.company!=="N/A"?f.company:"",M=f.platoon&&f.platoon!=="N/A"?f.platoon:"",F=t.company&&t.company!=="N/A"?t.company:"",k=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return g===F&&M===k}if(L.includes("COMPANY")){const g=f.company&&f.company!=="N/A"?f.company:"",M=t.company&&t.company!=="N/A"?t.company:"";return g===M}return L.includes("COMMANDER")?(f.unitUic||"")===H:!1};return o.filter(f=>f.id!==t.id&&Q(f)&&String(f.role||"")===L)},[o,t]),ee=async()=>{try{C(!0),q("");const L=o.find(g=>g.id===d);if(!z||!L){C(!1);return}const Q=String(t.role||""),f={...L};if(f.role=Q,Q.includes("PLATOON")){f.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A";const g=t.platoon&&t.platoon!=="N/A"?t.platoon:"N/A";f.rolePlatoon=g}else Q.includes("COMPANY")?(f.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A",f.rolePlatoon="N/A"):Q.includes("COMMANDER")&&(f.roleCompany="N/A",f.rolePlatoon="N/A");try{if(!(await Ke({id:f.id,email:f.email,rank:f.rank,firstName:f.firstName,lastName:f.lastName,mi:f.mi,service:f.service,role:f.role,unitUic:f.unitUic,unit:f.unit,company:f.company,isUnitAdmin:!!f.isUnitAdmin,isCommandStaff:!!f.isCommandStaff,edipi:f.edipi,passwordHash:f.passwordHash,roleCompany:f.roleCompany,rolePlatoon:f.rolePlatoon})).ok)throw new Error("persist_failed")}catch{q("Failed to persist user changes")}const H={actorId:t.id,actorRole:t.role,targetId:f.id,grantedRole:f.role,timestamp:new Date().toISOString(),scope:{unitUic:t.unitUic||"",company:t.company,unit:t.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(H)})}catch{}N(g=>g.map(M=>M.id===f.id?f:M)),E(""),X(!1),C(!1)}catch{C(!1),q("Operation failed")}},T=async L=>{try{C(!0),q("");const Q=o.find(F=>F.id===L);if(!Q){C(!1);return}const f=String(t.role||"");if(!c.some(F=>F.id===L)){C(!1),q("Target not in scope");return}const g={...Q};g.role="MEMBER",g.company="N/A",g.unit="N/A",g.isCommandStaff=!1,g.roleCompany="N/A",g.rolePlatoon="N/A";try{if(!(await Ke({id:g.id,email:g.email,rank:g.rank,firstName:g.firstName,lastName:g.lastName,mi:g.mi,service:g.service,role:g.role,unitUic:g.unitUic,unit:g.unit,company:g.company,isUnitAdmin:!!g.isUnitAdmin,isCommandStaff:!!g.isCommandStaff,edipi:g.edipi,passwordHash:g.passwordHash,roleCompany:g.roleCompany,rolePlatoon:g.rolePlatoon})).ok)throw new Error("persist_failed")}catch{q("Failed to persist user changes")}const M={actorId:t.id,actorRole:t.role,targetId:g.id,action:"Revoked",previousRole:f,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(M)})}catch{}N(F=>F.map(k=>k.id===g.id?g:k)),J(""),C(!1)}catch{C(!1),q("Operation failed")}};return z?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:a,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:L=>L.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:a,children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:d,onChange:L=>E(L.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),B.map(L=>e.jsxs("option",{value:L.id,children:[L.rank," ",L.lastName,", ",L.firstName,L.mi?` ${L.mi}`:""," â€¢ ",L.email]},L.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[c.map(L=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[L.rank," ",L.lastName,", ",L.firstName,L.mi?` ${L.mi}`:""," â€¢ ",L.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>J(L.id),children:"Remove Access"})]},L.id)),c.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),_&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:_})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!d||D,onClick:()=>X(!0),children:"Grant Equivalent Permission"})}),W&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>X(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:D,onClick:ee,children:"Confirm"})]})]}),w&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>J(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:D,onClick:()=>T(w),children:"Remove"})]})]})]})}):null},Zt="ORIGINATOR_REVIEW",Ue=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Zs=[{value:"PLATOON_REVIEW",label:"Platoon Review"},{value:"COMPANY_REVIEW",label:"Company Review"},{value:"BATTALION_REVIEW",label:"Battalion Review"},{value:"COMMANDER_REVIEW",label:"Commander Review"},{value:"ARCHIVED",label:"Archived"}],ea={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},ta=t=>{const a=Ue.indexOf(t||Ue[0]);return a>=0&&a<Ue.length-1?Ue[a+1]:Ue[a]||Ue[0]},es=t=>{const a=Ue.indexOf(t||Ue[0]);return a>0?Ue[a-1]:Ue[0]},vt=(t,a)=>{var o;return((o=t.activity)==null?void 0:o.some(N=>a.test(String(N.action||""))))||!1},sa=t=>vt(t,/(approved by commander|commander.*approved)/i)&&!vt(t,/installation commander/i),aa=t=>vt(t,/(endorsed by commander|commander.*endorsed)/i)&&!vt(t,/installation commander/i),Pt=t=>{if(!t)return"MEMBER";const a=String(t.role||"MEMBER"),o=(t.roleCompany||t.company||"").trim(),N=(t.rolePlatoon||t.platoon||"").trim();switch(a){case"PLATOON_REVIEWER":if(o&&N)return`Platoon (${o}-${N})`;break;case"COMPANY_REVIEWER":if(o)return`Company (${o})`;break;case"BATTALION_REVIEWER":return"Battalion";case"COMMANDER_REVIEWER":return"Commander"}return a};function na(){const t=Ns(),[a,o]=s.useState(()=>{try{const i=localStorage.getItem("currentUser");return i?JSON.parse(i):null}catch(i){return console.error("Failed to parse user from localStorage:",i),null}}),[N,d]=s.useState([]),[E,D]=s.useState([]),[C,_]=s.useState({}),[q,W]=s.useState({}),[X,w]=s.useState({}),[J,z]=s.useState({}),[B,c]=s.useState({}),[ee,T]=s.useState({}),[L,Q]=s.useState({}),[f,H]=s.useState(!1),[g,M]=s.useState({}),[F,k]=s.useState({}),[G,S]=s.useState(!1),[y,Y]=s.useState({}),[U,K]=s.useState(null),oe=s.useRef(null),[I,ge]=s.useState("Pending"),[Se,Ce]=s.useState(ea),[fe,Ae]=s.useState(null);s.useEffect(()=>{const i=V=>{U&&oe.current&&!oe.current.contains(V.target)&&(Y(te=>({...te,[U]:!1})),K(null))},l=V=>{V.key==="Escape"&&U&&(Y(te=>({...te,[U]:!1})),K(null))};return document.addEventListener("mousedown",i),document.addEventListener("keydown",l),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("keydown",l)}},[U]),s.useEffect(()=>{Es().then(i=>{d(i.data||[])}).catch(()=>d([]))},[]),s.useEffect(()=>{Rs().then(i=>{D(i.data||[])}).catch(()=>D([]))},[]),s.useEffect(()=>{jt().then(i=>{const l={},V=i.data||[];for(const te of V)te!=null&&te.id&&(l[te.id]=te);W(l)}).catch(()=>W({}))},[]),s.useEffect(()=>{try{const i=localStorage.getItem("unit_structure"),l={},V={};if(i){const te=JSON.parse(i);for(const ue of Object.keys(te||{})){const pe=te[ue];pe&&Array.isArray(pe._sections)&&(l[ue]=pe._sections),pe&&pe._platoonSectionMap&&typeof pe._platoonSectionMap=="object"&&(V[ue]=pe._platoonSectionMap)}}else(async()=>{try{const te=await wt();for(const ue of Object.keys(te||{})){const pe=te[ue];pe&&Array.isArray(pe._sections)&&(l[ue]=pe._sections),pe&&pe._platoonSectionMap&&typeof pe._platoonSectionMap=="object"&&(V[ue]=pe._platoonSectionMap)}}catch{}})();T(l),Q(V)}catch{}},[]);const ye=s.useMemo(()=>{const i=String((a==null?void 0:a.role)||"");return i.includes("PLATOON")?"PLATOON_REVIEW":i.includes("COMPANY")?"COMPANY_REVIEW":i.includes("BATTALION")?"BATTALION_REVIEW":i.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[a]),v=s.useMemo(()=>Object.values(q),[q]),P=i=>{const l=q[i.uploadedById];if(!l)return!1;const V=He(l.company),te=i.unitUic||l.unitUic||"";return nt(v,"COMPANY_REVIEWER",{company:V,uic:te})},se=i=>String((a==null?void 0:a.role)||"").includes("PLATOON")?!P(i):!1,me=i=>q[i.uploadedById]||null,le=i=>i&&i!=="N/A"?i.trim():"",Ie=i=>{var Me,we;const l=me(i),V=i.unitUic||(l==null?void 0:l.unitUic)||"",te=String((a==null?void 0:a.role)||""),ue=(a==null?void 0:a.unitUic)||"",pe=(le(a==null?void 0:a.roleCompany)||le(a==null?void 0:a.company)).toUpperCase();if(te.includes("PLATOON")){if(!ue||V!==ue)return!1;const he=l?le(l.company).toUpperCase():"",De=l?le(l.platoon).toUpperCase():"",Ve=(le(a==null?void 0:a.rolePlatoon)||le(a==null?void 0:a.platoon)).toUpperCase();return!pe||!Ve||!he||!De?!1:he===pe&&De===Ve}if(te.includes("COMPANY")){if(!ue||V!==ue)return!1;const he=l?le(l.company).toUpperCase():"";return!pe||!he?!1:he===pe}if(te.includes("BATTALION")){if(!ue||V!==ue)return!1;const he=le(a==null?void 0:a.company),De=le(a==null?void 0:a.platoon),Ve=((we=(Me=L[ue])==null?void 0:Me[he])==null?void 0:we[De])||"";return i.routeSection&&Ve?i.routeSection===Ve:!0}return te.includes("COMMANDER")?!!ue&&V===ue:!0},ke=s.useMemo(()=>(Array.isArray(N)?N:[]).filter(Ie),[N,a,q,L]),Ne=s.useMemo(()=>{const i=new Map;for(const l of ke){const V=me(l);if(V&&V.id&&!i.has(V.id)){const te=`${V.rank||""} ${V.lastName||""}, ${V.firstName||""}`.trim();i.set(V.id,{value:V.id,label:te||V.id})}}return Array.from(i.values()).sort((l,V)=>l.label.localeCompare(V.label))},[ke,q]),Oe=Us(Se,{items:ke,getSearchText:i=>`${i.subject||""} ${i.id||""} ${i.routeSection||""}`,getStatus:i=>i.currentStage||"PLATOON_REVIEW",getDate:i=>i.createdAt,getOriginatorId:i=>i.uploadedById}),Ee=s.useMemo(()=>Oe.filter(i=>(i.currentStage||"PLATOON_REVIEW")===ye),[Oe,ye]),m=s.useMemo(()=>Oe.filter(i=>(i.currentStage||"PLATOON_REVIEW")!==ye),[Oe,ye]),j=Tt(Ee,{pageSize:25}),Z=Tt(m,{pageSize:25}),re=i=>E.filter(l=>l.requestId===i),xe=s.useMemo(()=>[{header:"Request ID",getValue:i=>i.id},{header:"Subject",getValue:i=>i.subject},{header:"Stage",getValue:i=>i.currentStage||""},{header:"Route Section",getValue:i=>i.routeSection||""},{header:"Originator",getValue:i=>{const l=me(i);return l?`${l.rank||""} ${l.lastName||""}, ${l.firstName||""}${l.mi?` ${l.mi}`:""}`.trim():""}},{header:"Unit UIC",getValue:i=>i.unitUic||""},{header:"Created At",getValue:i=>i.createdAt,format:Kt},{header:"Due Date",getValue:i=>i.dueDate||"",format:Kt},{header:"Documents",getValue:i=>re(i.id).map(l=>l.name).join(" | ")}],[q,E]),p=async(i,l,V)=>{const te=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",ue=Pt(a),pe={actor:te,actorRole:ue,timestamp:new Date().toISOString(),action:V,comment:(C[i.id]||"").trim()},Me={...i,currentStage:l,routeSection:l==="BATTALION_REVIEW"&&B[i.id]?B[i.id]:i.routeSection,activity:Array.isArray(i.activity)?[...i.activity,pe]:[pe]};try{await Fe(Me),V.toLowerCase().includes("approved")?t.success("Request approved",{message:`"${i.subject}" advanced to next stage`}):V.toLowerCase().includes("return")?t.warning("Request returned",{message:`"${i.subject}" sent back for revision`}):V.toLowerCase().includes("archive")?t.info("Request archived",{message:`"${i.subject}" has been archived`}):t.success(V,{message:`Request "${i.subject}" updated`}),d(we=>we.map(he=>he.id===Me.id?Me:he)),_(we=>({...we,[i.id]:""}))}catch(we){t.error("Failed to update request",{message:String(we)})}},A=async i=>{const l=J[i.id]||[];if(!l.length||!(a!=null&&a.id))return;const V=Date.now(),te=l.map((he,De)=>({id:`${V}-${De}`,name:he.name,type:he.type,size:he.size,uploadedAt:new Date().toISOString(),subject:i.subject,requestId:i.id,fileUrl:URL.createObjectURL(he)})),ue=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",pe=Pt(a),Me={actor:ue,actorRole:pe,timestamp:new Date().toISOString(),action:`Reviewer added ${te.length} document(s)`,comment:(C[i.id]||"").trim()},we={...i,documentIds:[...i.documentIds||[],...te.map(he=>he.id)],activity:Array.isArray(i.activity)?[...i.activity,Me]:[Me]};try{await $t(te),await Fe(we),t.success(`${te.length} file${te.length!==1?"s":""} added`,{message:`Documents added to "${i.subject}"`})}catch(he){t.error("Failed to add files",{message:String(he)})}D(he=>[...he,...te]),d(he=>he.map(De=>De.id===we.id?we:De)),z(he=>({...he,[i.id]:[]})),_(he=>({...he,[i.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Unit Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Pt(a)}),e.jsx(Ys,{items:[...Ee,...m],columns:xe,filename:"review_requests",label:"Export",className:"hidden md:inline-flex"})]})]}),a&&String(a.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>H(!0),children:"Manage Permissions"})})]}),e.jsx(Hs,{filters:Se,onFiltersChange:Ce,statusOptions:Zs,originatorOptions:Ne,searchPlaceholder:"Search requests by subject, ID, or section...",className:"mb-4"}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>ge("Pending"),className:`${I==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>ge("In Scope"),className:`${I==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[I==="Pending"&&e.jsx(Xe,{title:"Pending",requests:j.currentData,users:q,onRowClick:i=>M(l=>({...l,[i.id]:!l[i.id]})),expandedRows:g,platoonSectionMap:L,children:i=>e.jsxs("div",{id:`details-rev-${i.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!y[i.id],"aria-controls":`docs-rev-${i.id}`,onClick:()=>{Y(l=>({...l,[i.id]:!l[i.id]})),K(l=>y[i.id]?null:i.id)},onKeyDown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),Y(V=>({...V,[i.id]:!V[i.id]})),K(V=>y[i.id]?null:i.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${y[i.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${i.id}`,ref:y[i.id]?oe:void 0,className:`${y[i.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:re(i.id).map(l=>({...l,fileUrl:l.fileUrl})),showIcons:!0,onPreview:l=>Ae(re(i.id).find(V=>V.id===l.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>w(l=>({...l,[i.id]:!l[i.id]})),"aria-expanded":!!X[i.id],"aria-controls":`logs-${i.id}`,children:[X[i.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${i.id}`,className:X[i.id]?"mt-2 space-y-2":"hidden",children:i.activity&&i.activity.length?i.activity.map((l,V)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[l.actor,l.actorRole?` â€¢ ${l.actorRole}`:""," â€¢ ",new Date(l.timestamp).toLocaleString()," â€¢ ",l.action]}),l.comment&&e.jsx("div",{className:"text-gray-600",children:l.comment})]},V)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:C[i.id]||"",onChange:l=>_(V=>({...V,[i.id]:l.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:l=>z(V=>({...V,[i.id]:l.target.files?Array.from(l.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(J[i.id]||[]).length?`${(J[i.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>A(i),disabled:!J[i.id]||!(J[i.id]||[]).length,children:"Save Files"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[(String((a==null?void 0:a.role)||"").includes("COMPANY")||se(i))&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:B[i.id]||"",onChange:l=>c(V=>({...V,[i.id]:l.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(ee[(a==null?void 0:a.unitUic)||""]||[]).map(l=>e.jsx("option",{value:l,children:l},l))]}),se(i)&&e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No company reviewer"})]}),(()=>{const l=sa(i),V=aa(i),te=String((a==null?void 0:a.role)||"").includes("COMPANY")||se(i);return l||V?e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>p(i,i.currentStage==="PLATOON_REVIEW"?Zt:es(i.currentStage),"Returned to previous stage"),children:"Return to Previous"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(te){if(!B[i.id])return;p(i,"BATTALION_REVIEW",`Approved and routed to ${B[i.id]}`)}else p(i,ta(i.currentStage),"Approved")},disabled:te&&!B[i.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>p(i,i.currentStage==="PLATOON_REVIEW"?Zt:es(i.currentStage),i.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),I==="In Scope"&&e.jsx(Xe,{title:"In Scope",requests:Z.currentData,users:q,onRowClick:i=>M(l=>({...l,[i.id]:!l[i.id]})),expandedRows:g,platoonSectionMap:L,children:i=>e.jsxs("div",{id:`details-rev-${i.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!y[i.id],"aria-controls":`docs-rev-${i.id}`,onClick:()=>{Y(l=>({...l,[i.id]:!l[i.id]})),K(l=>y[i.id]?null:i.id)},onKeyDown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),Y(V=>({...V,[i.id]:!V[i.id]})),K(V=>y[i.id]?null:i.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${y[i.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${i.id}`,ref:y[i.id]?oe:void 0,className:`${y[i.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:re(i.id).map(l=>({...l,fileUrl:l.fileUrl})),showIcons:!0,onPreview:l=>Ae(re(i.id).find(V=>V.id===l.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>w(l=>({...l,[i.id]:!l[i.id]})),"aria-expanded":!!X[i.id],"aria-controls":`logs-${i.id}`,children:[X[i.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${i.id}`,className:X[i.id]?"mt-2 space-y-2":"hidden",children:i.activity&&i.activity.length?i.activity.map((l,V)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[l.actor,l.actorRole?` â€¢ ${l.actorRole}`:""," â€¢ ",new Date(l.timestamp).toLocaleString()," â€¢ ",l.action]}),l.comment&&e.jsx("div",{className:"text-gray-600",children:l.comment})]},V)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),f&&a&&e.jsx(Xs,{currentUser:a,onClose:()=>H(!1)}),fe&&fe.fileUrl&&e.jsx(us,{url:fe.fileUrl,fileName:fe.name,mimeType:fe.type,fileSize:fe.size,isOpen:!!fe,onClose:()=>Ae(null)})]})}function ra(){var F;const[t,a]=s.useState(null),[o,N]=s.useState([]),[d,E]=s.useState([]),[D,C]=s.useState(""),[_,q]=s.useState(""),[W,X]=s.useState([]),[w,J]=s.useState(null),[z,B]=s.useState("structure"),[c,ee]=s.useState({}),[T,L]=s.useState({}),[Q,f]=s.useState({});s.useEffect(()=>{try{const k=localStorage.getItem("currentUser");k&&a(JSON.parse(k))}catch{}rs().then(k=>{try{N(k.map(G=>({code:String(G.code||""),name:String(G.name||"")})))}catch{N([])}}),is().then(k=>{E(k)}).catch(()=>E([])),ot().then(k=>X(k)).catch(()=>X([])),Bt().then(k=>{const G={};for(const S of k){const y=`${S.division_code}::${S.branch}`;G[y]={reviewers:S.reviewers||[],approvers:S.approvers||[]}}ee(G)})},[]);const H=(t==null?void 0:t.hqmcDivision)||((F=o[0])==null?void 0:F.code)||"",g=s.useMemo(()=>o.find(k=>k.code===H),[o,H]),M=s.useMemo(()=>(Array.isArray(d)?d:[]).filter(k=>String(k.division_code||"")===H),[d,H]);return s.useMemo(()=>(Array.isArray(W)?W:[]).filter(k=>!!k.isHqmcAdmin&&String(k.hqmcDivision||"")===H),[W,H]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(t!=null&&t.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",g?`${g.code} â€” ${g.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>B("structure"),className:`${z==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>B("permissions"),className:`${z==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),z==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[M.map(k=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:k.branch}),e.jsx("td",{className:"py-2 px-3",children:k.description||""}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700",onClick:async()=>{if(!confirm(`Delete branch "${k.branch}"?`))return;const G=await Is(H,k.branch);G.ok?(E(S=>S.filter(y=>!(y.division_code===H&&y.branch===k.branch))),J({type:"success",message:`Deleted branch "${k.branch}"`})):J({type:"error",message:`Failed to delete: ${G.error}`})},children:"Delete"})})]},k.branch)),M.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:D,onChange:k=>C(k.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:_,onChange:k=>q(k.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!D.trim(),onClick:async()=>{var k;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:H,division_name:((k=o.find(S=>S.code===H))==null?void 0:k.name)||"",branch:D.trim(),description:_.trim()})});const G=await fetch("/api/hqmc-structure").then(S=>S.json());E(G),C(""),q("")}catch{}},children:"Add"})]})]})]}),z==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const k of M){const G=`${H}::${k.branch}`,S=c[G]||{reviewers:[],approvers:[]};await os({division_code:H,branch:k.branch,reviewers:S.reviewers,approvers:S.approvers})}J({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:M.map(k=>{const G=`${H}::${k.branch}`,S=c[G]||{reviewers:[],approvers:[]},y=Y=>`${Y.rank||""} ${Y.lastName||""}, ${Y.firstName||""}${Y.mi?" "+Y.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:k.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:T[G]||"",onChange:Y=>L(U=>({...U,[G]:Y.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!T[G],onClick:async()=>{const Y=(T[G]||"").trim();if(!Y)return;const{user:U,error:K}=await Ot(Y);if(K){J({type:"error",message:`Database error: ${K}`});return}if(!(U!=null&&U.id)){J({type:"error",message:`No user found for EDIPI ${Y}`});return}ee(oe=>({...oe,[G]:{...S,reviewers:Array.from(new Set([...S.reviewers||[],U.id]))}})),L(oe=>({...oe,[G]:""})),J({type:"success",message:`Added reviewer ${U.lastName||""}, ${U.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(S.reviewers||[]).map(Y=>{const U=W.find(K=>K.id===Y);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:U?y(U):Y}),e.jsx("button",{className:"text-red-600",onClick:()=>ee(K=>({...K,[G]:{...S,reviewers:(S.reviewers||[]).filter(oe=>oe!==Y)}})),children:"âœ•"})]},Y)}),(S.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:Q[G]||"",onChange:Y=>f(U=>({...U,[G]:Y.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!Q[G],onClick:async()=>{const Y=(Q[G]||"").trim();if(!Y)return;const{user:U,error:K}=await Ot(Y);if(K){J({type:"error",message:`Database error: ${K}`});return}if(!(U!=null&&U.id)){J({type:"error",message:`No user found for EDIPI ${Y}`});return}ee(oe=>({...oe,[G]:{...S,approvers:Array.from(new Set([...S.approvers||[],U.id]))}})),f(oe=>({...oe,[G]:""})),J({type:"success",message:`Added approver ${U.lastName||""}, ${U.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(S.approvers||[]).map(Y=>{const U=W.find(K=>K.id===Y);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:U?y(U):Y}),e.jsx("button",{className:"text-red-600",onClick:()=>ee(K=>({...K,[G]:{...S,approvers:(S.approvers||[]).filter(oe=>oe!==Y)}})),children:"âœ•"})]},Y)}),(S.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},G)})})]})})]}),w&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${w.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:w.message})]})}const ut=(t,a)=>`${t}::${a}`;function ia({currentUser:t,divisionCode:a,branches:o,assignments:N,onClose:d}){const[E,D]=s.useState([]),[C,_]=s.useState(""),[q,W]=s.useState(""),[X,w]=s.useState("reviewer"),[J,z]=s.useState(!1);s.useEffect(()=>{jt().then(g=>D(g)).catch(()=>D([]))},[]);const B=s.useMemo(()=>{const g={};for(const M of N)g[ut(M.division_code,M.branch)]={reviewers:M.reviewers||[],approvers:M.approvers||[]};return g},[N]),c=String(t.id||""),ee=s.useMemo(()=>{if(!C)return!1;const g=B[ut(a,C)]||{reviewers:[],approvers:[]};return(g.reviewers||[]).includes(c)||(g.approvers||[]).includes(c)||!!t.isHqmcAdmin},[C,B,c,t]),T=s.useMemo(()=>E.filter(g=>String(g.hqmcDivision||"")===String(a||"")&&String(g.id||"")!==c),[E,a,c]),L=s.useMemo(()=>{if(!C)return[];const g=B[ut(a,C)]||{reviewers:[],approvers:[]};return Array.from(new Set([...g.reviewers||[],...g.approvers||[]])).map(F=>T.find(k=>k.id===F)).filter(Boolean)},[C,B,T,a]),Q=async g=>{z(!0);try{await os({division_code:a,branch:C,reviewers:g.reviewers,approvers:g.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:t.id,scope:{hqmcDivision:a,branch:C},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{z(!1)}},f=async()=>{if(!ee||!C||!q)return;const g=B[ut(a,C)]||{reviewers:[],approvers:[]},M={reviewers:Array.from(new Set(g.reviewers||[])),approvers:Array.from(new Set(g.approvers||[]))};X==="reviewer"?M.reviewers=Array.from(new Set([...M.reviewers,q])):M.approvers=Array.from(new Set([...M.approvers,q])),await Q(M),W("")},H=async g=>{if(!ee||!C)return;const M=B[ut(a,C)]||{reviewers:[],approvers:[]},F={reviewers:(M.reviewers||[]).filter(k=>k!==g),approvers:(M.approvers||[]).filter(k=>k!==g)};await Q(F)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:d,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:g=>g.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:d,children:"âœ•"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:C,onChange:g=>_(g.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),o.map(g=>e.jsx("option",{value:g,children:g},g))]})]}),C&&!ee&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),C&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:q,onChange:g=>W(g.target.value),disabled:!ee,children:[e.jsx("option",{value:"",children:"Choose user"}),T.map(g=>e.jsxs("option",{value:g.id,children:[g.rank," ",g.lastName,", ",g.firstName,g.mi?` ${g.mi}`:""," â€¢ ",g.email]},g.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:X,onChange:g=>w(g.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!ee||!q||J,onClick:f,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[L.map(g=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[g.rank," ",g.lastName,", ",g.firstName,g.mi?` ${g.mi}`:""," â€¢ ",g.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!ee||J,onClick:()=>H(g.id),children:"Remove"})]},g.id)),L.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}function oa(){const[t,a]=s.useState(()=>{try{const m=localStorage.getItem("currentUser");return m?JSON.parse(m):null}catch{return null}}),[o,N]=s.useState([]),[d,E]=s.useState([]),[D,C]=s.useState({}),[_,q]=s.useState({}),[W,X]=s.useState({}),[w,J]=s.useState({}),[z,B]=s.useState({}),[c,ee]=s.useState(null),T=s.useRef(null),[L,Q]=s.useState([]),[f,H]=s.useState("Pending"),[g,M]=s.useState([]),[F,k]=s.useState({}),[G,S]=s.useState(!1);s.useEffect(()=>{const m=Z=>{c&&T.current&&!T.current.contains(Z.target)&&(J(re=>({...re,[c]:!1})),ee(null))},j=Z=>{Z.key==="Escape"&&c&&(J(re=>({...re,[c]:!1})),ee(null))};return document.addEventListener("mousedown",m),document.addEventListener("keydown",j),()=>{document.removeEventListener("mousedown",m),document.removeEventListener("keydown",j)}},[c]),s.useEffect(()=>{Nt().then(m=>N(m)).catch(()=>N([]))},[]),s.useEffect(()=>{Ft().then(m=>E(m)).catch(()=>E([]))},[]),s.useEffect(()=>{ot().then(m=>{const j={};for(const Z of m)Z!=null&&Z.id&&(j[Z.id]=Z);q(j)}).catch(()=>q({}))},[]),s.useEffect(()=>{Bt().then(Q).catch(()=>Q([]))},[]),s.useEffect(()=>{is().then(M).catch(()=>M([]))},[]);const y=(t==null?void 0:t.id)||"",Y=String((t==null?void 0:t.hqmcDivision)||""),U=s.useMemo(()=>L.filter(m=>m.division_code===Y&&((m.reviewers||[]).includes(y)||(m.approvers||[]).includes(y))).map(m=>m.branch),[L,Y,y]),K=m=>_[m.uploadedById]||null,oe=m=>{if(!Y||!y)return!1;const j=String(m.routeSection||"");return U.includes(j)},I=m=>(m.activity||[]).some(j=>/HQMC Approver Approved/i.test(String(j.action||""))),ge=s.useMemo(()=>(Array.isArray(o)?o:[]).filter(oe),[o,U]),Se=s.useMemo(()=>ge.filter(m=>(m.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&!I(m)),[ge]),Ce=s.useMemo(()=>ge.filter(m=>(m.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&I(m)),[ge]),fe=s.useMemo(()=>ge.filter(m=>(m.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[ge]),Ae=m=>d.filter(j=>j.requestId===m),ye=m=>`"${String(m??"").replace(/"/g,'""')}"`,v=m=>{const Z=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const re of m){const xe=K(re),p=xe?`${xe.rank} ${xe.lastName}, ${xe.firstName}${xe.mi?` ${xe.mi}`:""}`:"",A=Ae(re.id).map(i=>i.name).join(" | ");Z.push([re.id,re.subject,re.currentStage||"",re.routeSection||"",p,re.unitUic||"",new Date(re.createdAt).toLocaleString(),A])}return Z.map(re=>re.map(ye).join(",")).join(`\r
`)},P=(m,j)=>{const Z=new Blob([j],{type:"text/csv;charset=utf-8;"}),re=URL.createObjectURL(Z),xe=document.createElement("a");xe.href=re,xe.download=m,document.body.appendChild(xe),xe.click(),document.body.removeChild(xe),URL.revokeObjectURL(re)},se=()=>P("hqmc_pending.csv",v(Se)),me=()=>P("hqmc_approved.csv",v(Ce)),le=()=>P("hqmc_archived.csv",v(fe)),Ie=()=>P("hqmc_all.csv",v([...Se,...Ce,...fe])),ke=async m=>{const j=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",Z=String(F[m.id]||"").trim();if(!Z){alert("Select an HQMC section to route to approver");return}const re={actor:j,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${Z}`,comment:(D[m.id]||"").trim()},xe={...m,routeSection:Z,activity:Array.isArray(m.activity)?[...m.activity,re]:[re]};try{await Fe(xe)}catch{}N(p=>p.map(A=>A.id===xe.id?xe:A)),C(p=>({...p,[m.id]:""}))},Ne=async m=>{const Z={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC to Installation",comment:(D[m.id]||"").trim()},re={...m,currentStage:"INSTALLATION_REVIEW",activity:Array.isArray(m.activity)?[...m.activity,Z]:[Z]};try{await Fe(re)}catch{}N(xe=>xe.map(p=>p.id===re.id?re:p)),C(xe=>({...xe,[m.id]:""}))},Oe=async m=>{const Z={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Section",timestamp:new Date().toISOString(),action:"Archived by HQMC Section",comment:(D[m.id]||"").trim()},re={...m,currentStage:"ARCHIVED",activity:Array.isArray(m.activity)?[...m.activity,Z]:[Z]};try{await Fe(re)}catch{}N(xe=>xe.map(p=>p.id===re.id?re:p)),C(xe=>({...xe,[m.id]:""}))},Ee=async m=>{const j=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Section",Z=String(F[m.id]||"").trim();if(!Z){alert("Select an HQMC section to reassign to");return}const re={actor:j,timestamp:new Date().toISOString(),action:`Reassigned to HQMC section: ${Z}`,comment:(D[m.id]||"").trim()},xe={...m,routeSection:Z,activity:Array.isArray(m.activity)?[...m.activity,re]:[re]};try{await Fe(xe)}catch{}N(p=>p.map(A=>A.id===xe.id?xe:A)),C(p=>({...p,[m.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Y||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ie,children:"Export All"}),U.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>S(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>H("Pending"),className:`${f==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>H("Approved"),className:`${f==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"}),e.jsx("button",{onClick:()=>H("Archived"),className:`${f==="Archived"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Archived"})]})}),e.jsxs("div",{className:"mt-4",children:[f==="Pending"&&e.jsx(Xe,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:se,children:"Export Pending"}),requests:Se,users:_,onRowClick:m=>X(j=>({...j,[m.id]:!j[m.id]})),expandedRows:W,children:m=>e.jsxs("div",{id:`details-hq-${m.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!w[m.id],"aria-controls":`docs-hq-${m.id}`,onClick:()=>{J(j=>({...j,[m.id]:!j[m.id]})),ee(j=>w[m.id]?null:m.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${w[m.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${m.id}`,ref:w[m.id]?T:void 0,className:`${w[m.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:Ae(m.id).map(j=>({...j,fileUrl:j.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[m.id],"aria-controls":`logs-hq-${m.id}`,onClick:()=>B(j=>({...j,[m.id]:!j[m.id]})),children:[z[m.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hq-${m.id}`,className:z[m.id]?"mt-2 space-y-2":"hidden",children:m.activity&&m.activity.length?m.activity.map((j,Z)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[j.actor," â€¢ ",new Date(j.timestamp).toLocaleString()," â€¢ ",j.action]}),j.comment&&e.jsx("div",{className:"text-gray-600",children:j.comment})]},Z)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:D[m.id]||"",onChange:j=>C(Z=>({...Z,[m.id]:j.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:F[m.id]||"",onChange:j=>k(Z=>({...Z,[m.id]:j.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),g.filter(j=>String(j.division_code||"")===Y).map(j=>e.jsx("option",{value:j.branch,children:j.branch},j.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>ke(m),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>Ne(m),children:"Return"})]})]})]})}),f==="Approved"&&e.jsx(Xe,{title:"Approved by HQMC Approver",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:me,children:"Export Approved"}),requests:Ce,users:_,onRowClick:m=>X(j=>({...j,[m.id]:!j[m.id]})),expandedRows:W,children:m=>e.jsxs("div",{id:`details-hqa-${m.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!w[m.id],"aria-controls":`docs-hqa-${m.id}`,onClick:()=>{J(j=>({...j,[m.id]:!j[m.id]})),ee(j=>w[m.id]?null:m.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${w[m.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${m.id}`,ref:w[m.id]?T:void 0,className:`${w[m.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:Ae(m.id).map(j=>({...j,fileUrl:j.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[m.id],"aria-controls":`logs-hqa-${m.id}`,onClick:()=>B(j=>({...j,[m.id]:!j[m.id]})),children:[z[m.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqa-${m.id}`,className:z[m.id]?"mt-2 space-y-2":"hidden",children:m.activity&&m.activity.length?m.activity.map((j,Z)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[j.actor," â€¢ ",new Date(j.timestamp).toLocaleString()," â€¢ ",j.action]}),j.comment&&e.jsx("div",{className:"text-gray-600",children:j.comment})]},Z)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:D[m.id]||"",onChange:j=>C(Z=>({...Z,[m.id]:j.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Reassign to Section"}),e.jsxs("select",{value:F[m.id]||"",onChange:j=>k(Z=>({...Z,[m.id]:j.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),g.filter(j=>String(j.division_code||"")===Y).map(j=>e.jsx("option",{value:j.branch,children:j.branch},j.branch))]}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Ee(m),children:"Reassign"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700",onClick:()=>Oe(m),children:"Archive"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>Ne(m),children:"Return to Installation"})]})]})]})}),f==="Archived"&&e.jsx(Xe,{title:"Archived",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:le,children:"Export Archived"}),requests:fe,users:_,onRowClick:m=>X(j=>({...j,[m.id]:!j[m.id]})),expandedRows:W,children:m=>e.jsxs("div",{id:`details-hqarc-${m.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!w[m.id],"aria-controls":`docs-hqarc-${m.id}`,onClick:()=>{J(j=>({...j,[m.id]:!j[m.id]})),ee(j=>w[m.id]?null:m.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${w[m.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqarc-${m.id}`,ref:w[m.id]?T:void 0,className:`${w[m.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:Ae(m.id).map(j=>({...j,fileUrl:j.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[m.id],"aria-controls":`logs-hqarc-${m.id}`,onClick:()=>B(j=>({...j,[m.id]:!j[m.id]})),children:[z[m.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqarc-${m.id}`,className:z[m.id]?"mt-2 space-y-2":"hidden",children:m.activity&&m.activity.length?m.activity.map((j,Z)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[j.actor," â€¢ ",new Date(j.timestamp).toLocaleString()," â€¢ ",j.action]}),j.comment&&e.jsx("div",{className:"text-gray-600",children:j.comment})]},Z)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),G&&t&&e.jsx(ia,{currentUser:t,divisionCode:Y,branches:g.filter(m=>String(m.division_code||"")===Y).map(m=>m.branch),assignments:L,onClose:()=>S(!1)})]})}function ca(){const[t,a]=s.useState(()=>{try{const v=localStorage.getItem("currentUser");return v?JSON.parse(v):null}catch{return null}}),[o,N]=s.useState([]),[d,E]=s.useState([]),[D,C]=s.useState({}),[_,q]=s.useState({}),[W,X]=s.useState({}),[w,J]=s.useState({}),[z,B]=s.useState({}),[c,ee]=s.useState(null),T=s.useRef(null),[L,Q]=s.useState([]),[f,H]=s.useState("Pending");s.useEffect(()=>{const v=se=>{c&&T.current&&!T.current.contains(se.target)&&(J(me=>({...me,[c]:!1})),ee(null))},P=se=>{se.key==="Escape"&&c&&(J(me=>({...me,[c]:!1})),ee(null))};return document.addEventListener("mousedown",v),document.addEventListener("keydown",P),()=>{document.removeEventListener("mousedown",v),document.removeEventListener("keydown",P)}},[c]),s.useEffect(()=>{Nt().then(v=>N(v)).catch(()=>N([]))},[]),s.useEffect(()=>{Ft().then(v=>E(v)).catch(()=>E([]))},[]),s.useEffect(()=>{ot().then(v=>{const P={};for(const se of v)se!=null&&se.id&&(P[se.id]=se);q(P)}).catch(()=>q({}))},[]),s.useEffect(()=>{Bt().then(Q).catch(()=>Q([]))},[]);const g=(t==null?void 0:t.id)||"",M=String((t==null?void 0:t.hqmcDivision)||""),F=s.useMemo(()=>L.filter(v=>v.division_code===M&&(v.approvers||[]).includes(g)).map(v=>v.branch),[L,M,g]),k=v=>_[v.uploadedById]||null,G=v=>{if(!M||!g)return!1;const P=String(v.routeSection||"");return F.includes(P)},S=v=>(v.activity||[]).some(P=>/HQMC Approver Approved/i.test(String(P.action||""))),y=s.useMemo(()=>(Array.isArray(o)?o:[]).filter(G),[o,F]),Y=s.useMemo(()=>y.filter(v=>(v.currentStage||"PLATOON_REVIEW")==="HQMC_REVIEW"&&!S(v)),[y]),U=s.useMemo(()=>y.filter(v=>S(v)),[y]),K=v=>d.filter(P=>P.requestId===v),oe=v=>`"${String(v??"").replace(/"/g,'""')}"`,I=v=>{const se=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const me of v){const le=k(me),Ie=le?`${le.rank} ${le.lastName}, ${le.firstName}${le.mi?` ${le.mi}`:""}`:"",ke=K(me.id).map(Ne=>Ne.name).join(" | ");se.push([me.id,me.subject,me.currentStage||"",me.routeSection||"",Ie,me.unitUic||"",new Date(me.createdAt).toLocaleString(),ke])}return se.map(me=>me.map(oe).join(",")).join(`\r
`)},ge=(v,P)=>{const se=new Blob([P],{type:"text/csv;charset=utf-8;"}),me=URL.createObjectURL(se),le=document.createElement("a");le.href=me,le.download=v,document.body.appendChild(le),le.click(),document.body.removeChild(le),URL.revokeObjectURL(me)},Se=()=>ge("hqmc_approver_pending.csv",I(Y)),Ce=()=>ge("hqmc_approver_approved.csv",I(U)),fe=()=>ge("hqmc_approver_all.csv",I([...Y,...U])),Ae=async v=>{const se={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved - Pending HQMC Section Action",comment:(D[v.id]||"").trim()},me={...v,currentStage:"HQMC_REVIEW",activity:Array.isArray(v.activity)?[...v.activity,se]:[se]};try{await Fe(me)}catch{}N(le=>le.map(Ie=>Ie.id===me.id?me:Ie)),C(le=>({...le,[v.id]:""}))},ye=async v=>{const se={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver to Installation",comment:(D[v.id]||"").trim()},me={...v,currentStage:"INSTALLATION_REVIEW",activity:Array.isArray(v.activity)?[...v.activity,se]:[se]};try{await Fe(me)}catch{}N(le=>le.map(Ie=>Ie.id===me.id?me:Ie)),C(le=>({...le,[v.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((t==null?void 0:t.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:fe,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>H("Pending"),className:`${f==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>H("Approved"),className:`${f==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"})]})}),e.jsxs("div",{className:"mt-4",children:[f==="Pending"&&e.jsx(Xe,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Se,children:"Export Pending"}),requests:Y,users:_,onRowClick:v=>X(P=>({...P,[v.id]:!P[v.id]})),expandedRows:W,children:v=>e.jsxs("div",{id:`details-hqa-${v.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!w[v.id],"aria-controls":`docs-hqa-${v.id}`,onClick:()=>{J(P=>({...P,[v.id]:!P[v.id]})),ee(P=>w[v.id]?null:v.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${w[v.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${v.id}`,ref:w[v.id]?T:void 0,className:`${w[v.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:K(v.id).map(P=>({...P,fileUrl:P.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[v.id],"aria-controls":`logs-hqa-${v.id}`,onClick:()=>B(P=>({...P,[v.id]:!P[v.id]})),children:[z[v.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqa-${v.id}`,className:z[v.id]?"mt-2 space-y-2":"hidden",children:v.activity&&v.activity.length?v.activity.map((P,se)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[P.actor," â€¢ ",new Date(P.timestamp).toLocaleString()," â€¢ ",P.action]}),P.comment&&e.jsx("div",{className:"text-gray-600",children:P.comment})]},se)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:D[v.id]||"",onChange:P=>C(se=>({...se,[v.id]:P.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Ae(v),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>ye(v),children:"Return"})]})]})}),f==="Approved"&&e.jsx(Xe,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ce,children:"Export Approved"}),requests:U,users:_,onRowClick:v=>X(P=>({...P,[v.id]:!P[v.id]})),expandedRows:W,children:v=>e.jsxs("div",{id:`details-hqa-${v.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!w[v.id],"aria-controls":`docs-hqa-${v.id}`,onClick:()=>{J(P=>({...P,[v.id]:!P[v.id]})),ee(P=>w[v.id]?null:v.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${w[v.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${v.id}`,ref:w[v.id]?T:void 0,className:`${w[v.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:K(v.id).map(P=>({...P,fileUrl:P.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!z[v.id],"aria-controls":`logs-hqaa-${v.id}`,onClick:()=>B(P=>({...P,[v.id]:!P[v.id]})),children:[z[v.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqaa-${v.id}`,className:z[v.id]?"mt-2 space-y-2":"hidden",children:v.activity&&v.activity.length?v.activity.map((P,se)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[P.actor," â€¢ ",new Date(P.timestamp).toLocaleString()," â€¢ ",P.action]}),P.comment&&e.jsx("div",{className:"text-gray-600",children:P.comment})]},se)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]})})}const la=({onUnitSelect:t,selectedUnit:a})=>{const[o,N]=s.useState(""),[d,E]=s.useState(!1),D=ze.filter(_=>_.unitName.toLowerCase().startsWith(o.toLowerCase())||_.uic.toLowerCase().startsWith(o.toLowerCase())||_.ruc.toLowerCase().startsWith(o.toLowerCase())),C=_=>{t(_),E(!1),N("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>E(!d),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[a?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",a.uic," | RUC: ",a.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),d&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:o,onChange:_=>N(_.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:D.map(_=>e.jsxs("button",{type:"button",onClick:()=>C(_),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:_.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",_.uic," | RUC: ",_.ruc," | MCC: ",_.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[_.streetAddress,", ",_.cityState," ",_.zip]})]},_.uic))})]})]})]})},qt=async t=>{const o=new TextEncoder().encode(t),N=await crypto.subtle.digest("SHA-256",o);return Array.from(new Uint8Array(N)).map(d=>d.toString(16).padStart(2,"0")).join("")};async function da(t,a){const o=Ds();return o!=null&&o.auth?await o.auth.signUp({email:t,password:a}):{data:null,error:new Error("supabase_not_initialized")}}const ts={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},ma=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],ps=({onSaved:t,initial:a={},mode:o="create",readOnly:N=!1,canEditRole:d=!1,canEditAdmin:E=!1})=>{const[D,C]=s.useState(""),[_,q]=s.useState(""),[W,X]=s.useState(""),[w,J]=s.useState(a.email||""),[z,B]=s.useState(a.edipi||""),[c,ee]=s.useState(a.service||""),[T,L]=s.useState(a.rank||""),[Q,f]=s.useState(a.role||"MEMBER"),[H,g]=s.useState(!!a.isUnitAdmin),[M,F]=s.useState(a.company||""),[k,G]=s.useState(a.platoon||""),[S,y]=s.useState(void 0),[Y,U]=s.useState(null),[K,oe]=s.useState({}),[I,ge]=s.useState(""),[Se,Ce]=s.useState(""),[fe,Ae]=s.useState([]),[ye,v]=s.useState(!1),[P,se]=s.useState(a.roleCompany||""),[me,le]=s.useState(a.rolePlatoon||""),[Ie,ke]=s.useState(!1),[Ne,Oe]=s.useState([]),[Ee,m]=s.useState([]),[j,Z]=s.useState([]),[re,xe]=s.useState([]);s.useEffect(()=>{if(a.firstName&&C(String(a.firstName)),a.lastName&&q(String(a.lastName)),a.mi&&X(String(a.mi)),a.company&&F(String(a.company)),a.platoon&&G(String(a.platoon)),a.roleCompany&&se(String(a.roleCompany)),a.rolePlatoon&&le(String(a.rolePlatoon)),a.unitUic){const b=ze.find(de=>de.uic===a.unitUic);b&&y(b)}},[a]);const p=s.useMemo(()=>ts[c]||[],[c]),A=s.useMemo(()=>{if(!S)return[];const b=Ne;if(b&&b.length)return b;const de=K[S.uic]||{};return Object.keys(de).filter(je=>!je.startsWith("_")&&Array.isArray(de[je]))},[S,K,Ne]),i=s.useMemo(()=>{var b;return S&&M?((b=K[S.uic])==null?void 0:b[M])||[]:[]},[S,M,K]),l=s.useMemo(()=>{if(!S||!M)return[];const b=Ee;return b&&b.length?b:i},[S,M,Ee,i]),V=s.useMemo(()=>{if(!S)return[];const b=j;if(b&&b.length)return b;const de=K[S.uic]||{};return Object.keys(de).filter(je=>!je.startsWith("_")&&Array.isArray(de[je]))},[S,K,j]),te=s.useMemo(()=>{var b;return S&&P?((b=K[S.uic])==null?void 0:b[P])||[]:[]},[S,P,K]),ue=s.useMemo(()=>{if(!S||!P)return[];const b=re;return b&&b.length?b:te},[S,P,re,te]),pe=s.useMemo(()=>{const b=A.slice(),de=M||a.company||a.user_company||"";return de&&!b.includes(de)?[de,...b]:b},[A,M,a]),Me=s.useMemo(()=>{const b=l.slice(),de=k||a.platoon||a.user_platoon||"";return de&&!b.includes(de)?[de,...b]:b},[l,k,a]),we=s.useMemo(()=>{const b=V.slice(),de=P||a.roleCompany||"",je=de&&!b.includes(de)?[de,...b]:b;return Array.from(new Set(je))},[V,P,a]),he=s.useMemo(()=>{const b=ue.slice(),de=me||a.rolePlatoon||"";return de&&!b.includes(de)?[de,...b]:b},[ue,me,a]);s.useEffect(()=>{(async()=>{try{if(o==="edit"&&a.id){const b=await cs(String(a.id));b&&(b.company&&!M&&F(String(b.company)),b.platoon&&!k&&G(String(b.platoon)),b.roleCompany&&!P&&se(String(b.roleCompany)),b.rolePlatoon&&!me&&le(String(b.rolePlatoon)))}}catch{}})()},[o,a.id]),s.useEffect(()=>{p.includes(T)||L("")},[p]),s.useEffect(()=>{G("")},[M]),s.useEffect(()=>{le("")},[P]),s.useEffect(()=>{try{const b=localStorage.getItem("unit_structure");b&&oe(JSON.parse(b))}catch{}},[S]),s.useEffect(()=>{const b=(S==null?void 0:S.uic)||"";if(!b){Oe([]),Z([]);return}ls(b).then(de=>{Oe(de||[]),Z(de||[])}).catch(()=>{Oe([]),Z([])})},[S]),s.useEffect(()=>{const b=(S==null?void 0:S.uic)||"",de=M||"";if(!b||!de){m([]);return}_t(b,de).then(je=>m(je||[])).catch(()=>m([]))},[S,M]),s.useEffect(()=>{const b=(S==null?void 0:S.uic)||"",de=P||"";if(!b||!de){xe([]);return}_t(b,de).then(je=>xe(je||[])).catch(()=>xe([]))},[S,P]),s.useEffect(()=>{ot().then(b=>{Ae(b)}).catch(()=>Ae([]))},[]),s.useEffect(()=>{const b=(S==null?void 0:S.uic)||"";if(!b){v(!1);return}const de=fe.some(je=>!!je.isUnitAdmin&&(je.unitUic||"")===b);v(de)},[S,fe]),s.useEffect(()=>{if(S){!M&&a.company&&pe.includes(a.company)&&F(String(a.company));const b=a.platoon;!k&&b&&Me.includes(b)&&G(String(b))}},[S,pe,Me,M,k,a]);const De=b=>/^[0-9]{10}$/.test(b),Ve=(b,de)=>{try{return fe.some(je=>String(je.edipi)===String(b)&&String(je.id)!==String(de||""))}catch{return!1}},Ze=async b=>{var et,Qe;if(b.preventDefault(),U(null),N)return;if(!D.trim())return U({type:"error",message:"First name is required."});if(!_.trim())return U({type:"error",message:"Last name is required."});if(W&&!/^[A-Za-z]$/.test(W))return U({type:"error",message:"MI must be a single letter."});if(!w.trim())return U({type:"error",message:"Email is required."});if(!De(String(z)))return U({type:"error",message:"EDIPI must be 10 digits."});if(!c)return U({type:"error",message:"Service is required."});if(!T)return U({type:"error",message:"Rank is required."});if(Ve(String(z),a.id?String(a.id):void 0))return U({type:"error",message:"EDIPI already exists."});if(Q==="COMPANY_REVIEWER"&&!P)return U({type:"error",message:"Role Company is required for Company Reviewer."});if(Q==="PLATOON_REVIEWER"&&(!P||!me))return U({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${D.trim()}`,W&&""+W.trim().toUpperCase(),`${_.trim()}`;let de=a.id?String(a.id):`usr-${Date.now()}`,je=a.passwordHash||"";if(o==="create"){if(!I||I.length<8)return U({type:"error",message:"Password must be at least 8 characters."});if(I!==Se)return U({type:"error",message:"Passwords do not match."});try{const{data:ve,error:Ye}=await da(w.trim(),I);if(Ye){U({type:"error",message:`Failed to create auth user: ${String(Ye.message||Ye)}`});return}const tt=(et=ve==null?void 0:ve.user)!=null&&et.id?String(ve.user.id):"";if(!tt){U({type:"error",message:"Auth user ID missing after sign up."});return}de=tt}catch(ve){U({type:"error",message:`Failed to create auth user: ${String((ve==null?void 0:ve.message)||ve)}`});return}je=await qt(I)}else if(o==="edit"&&I){if(I.length<8)return U({type:"error",message:"Password must be at least 8 characters."});if(I!==Se)return U({type:"error",message:"Passwords do not match."});je=await qt(I)}const $e={id:de,firstName:D.trim(),lastName:_.trim(),mi:W?W.trim().toUpperCase():void 0,email:w.trim(),edipi:z,service:c,rank:T,role:Q,company:M||"N/A",unit:(S==null?void 0:S.unitName)||"N/A",unitUic:S==null?void 0:S.uic,passwordHash:je,isUnitAdmin:o==="create"&&S&&!ye?!0:H,roleCompany:P||void 0,rolePlatoon:me||void 0,platoon:k||"N/A"};try{const ve=await Ke({id:$e.id,email:$e.email,rank:$e.rank,firstName:$e.firstName,lastName:$e.lastName,mi:$e.mi,service:$e.service,role:$e.role,unitUic:$e.unitUic,unit:(S==null?void 0:S.unitName)||"N/A",company:$e.company,isUnitAdmin:!!$e.isUnitAdmin,edipi:String($e.edipi),passwordHash:je,platoon:k||"N/A",roleCompany:P||void 0,rolePlatoon:me||void 0});if(!ve.ok){U({type:"error",message:`Failed to save profile: ${String(((Qe=ve==null?void 0:ve.error)==null?void 0:Qe.message)||(ve==null?void 0:ve.error)||"unknown")}`});return}U({type:"success",message:a.id?"Profile updated.":S&&!ye?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),t==null||t($e)}catch{U({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:o==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:Ze,className:"space-y-6",children:[o==="create"&&S&&!ye&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:S.unitName})," (UIC ",S.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:_,onChange:b=>q(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:D,onChange:b=>C(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:W,maxLength:1,onChange:b=>X(b.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:w,onChange:b=>J(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:z,onChange:b=>B(b.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:c,onChange:b=>ee(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(ts).map(b=>e.jsx("option",{value:b,children:b},b))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:T,onChange:b=>L(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),p.map(b=>e.jsx("option",{value:b,children:b},b))]})]}),o==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:I,onChange:b=>ge(b.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:Se,onChange:b=>Ce(b.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N})]})]}):e.jsx(e.Fragment,{})]})]}),Ie&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:I,onChange:b=>ge(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:Se,onChange:b=>Ce(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:N})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>ke(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>ke(!1),children:"Save"})]})]})}),o==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:Q,onChange:b=>f(b.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:ma.map(b=>e.jsx("option",{value:b,children:b},b))})}),e.jsx("div",{children:e.jsxs("select",{value:P||String(a.roleCompany||""),onChange:b=>se(b.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:we.length?"Select company":"No companies configured"}),we.map(b=>e.jsx("option",{value:b,children:b},b))]})}),e.jsx("div",{children:e.jsxs("select",{value:me||String(a.rolePlatoon||""),onChange:b=>le(b.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:he.length?"Select platoon":"No platoons configured"}),he.map(b=>e.jsx("option",{value:b,children:b},b))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:H,onChange:b=>g(b.target.checked),disabled:N||!E}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(a==null?void 0:a.isCommandStaff)||Q==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(la,{onUnitSelect:b=>y(b),selectedUnit:S})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:M||String(a.company||""),onChange:b=>F(b.target.value),disabled:N||!S||pe.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:pe.length?"Select company":"No companies configured"}),pe.map(b=>e.jsx("option",{value:b,children:b},b))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:k||String(a.platoon||""),onChange:b=>G(b.target.value),disabled:N||!S||!M||Me.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Me.length?"Select platoon":"No platoons configured"}),Me.map(b=>e.jsx("option",{value:b,children:b},b))]})]})]})})]}),Y&&e.jsx("div",{className:`p-3 rounded-lg border ${Y.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:Y.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[o==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>ke(!0),disabled:N,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:N,children:o==="edit"?"Save":"Create Profile"})]})]})]})},ua=s.memo(function({user:a,onClose:o}){const N=()=>{const d=ze.find(D=>D.uic===a.unitUic),E=d?d.unitName:a.unit;if(a.isUnitAdmin||a.role==="COMMANDER")return E||"â€”";if(a.role==="COMPANY_REVIEWER")return a.company&&a.company!=="N/A"?a.company:"â€”";if(a.role==="PLATOON_REVIEWER"){const D=a.company&&a.company!=="N/A"?a.company:"",C=a.platoon&&a.platoon!=="N/A"?a.platoon:"",_=[D,C].filter(Boolean);return _.length?_.join(" / "):"â€”"}return"â€”"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:o,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:o,children:"âœ•"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:a.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:a.edipi||"â€”"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:a.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:a.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:N()})]}),a.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),a.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:o,children:"Close"})})]})})}),xa=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],pa=()=>{const[t,a]=s.useState(null),[o,N]=s.useState(void 0),[d,E]=s.useState({}),[D,C]=s.useState({}),[_,q]=s.useState({}),[W,X]=s.useState({}),[w,J]=s.useState(""),[z,B]=s.useState(""),[c,ee]=s.useState(""),[T,L]=s.useState(""),[Q,f]=s.useState(""),[H,g]=s.useState([]),[M,F]=s.useState(null),[k,G]=s.useState(""),S=s.useRef(null),[y,Y]=s.useState(null),[U,K]=s.useState(null),[oe,I]=s.useState(""),[ge,Se]=s.useState(void 0),[Ce,fe]=s.useState(void 0),[Ae,ye]=s.useState(void 0),[v,P]=s.useState(void 0),[se,me]=s.useState(void 0),[le,Ie]=s.useState(void 0),[ke,Ne]=s.useState([]),[Oe,Ee]=s.useState([]),[m,j]=s.useState(""),[Z,re]=s.useState("unit"),[xe,p]=s.useState([]),[A,i]=s.useState(!1),[l,V]=s.useState(!1),[te,ue]=s.useState(!1),[pe,Me]=s.useState("admin"),[we,he]=s.useState(!0),[De,Ve]=s.useState(null),[Ze,b]=s.useState(0),de=s.useRef(!1);s.useEffect(()=>{y&&pe==="admin"&&!de.current&&(!ge&&y.company&&y.company!=="N/A"&&(Se(y.company),ye(y.company)),!Ce&&y.platoon&&y.platoon!=="N/A"&&(fe(y.platoon),P(y.platoon)),!se&&y.roleCompany&&y.roleCompany!=="N/A"&&me(y.roleCompany),!le&&y.rolePlatoon&&y.rolePlatoon!=="N/A"&&Ie(y.rolePlatoon),de.current=!0)},[y,pe]),s.useEffect(()=>{try{const n=localStorage.getItem("unit_structure");n&&E(JSON.parse(n))}catch{}try{const n=localStorage.getItem("unit_structure"),u={},$={},ie={};if(n){const r=JSON.parse(n);for(const h of Object.keys(r||{})){const x=r[h];x&&Array.isArray(x._sections)&&(u[h]=x._sections),x&&Array.isArray(x._commandSections)&&($[h]=x._commandSections),x&&x._platoonSectionMap&&typeof x._platoonSectionMap=="object"&&(ie[h]=x._platoonSectionMap)}}else(async()=>{try{const r=await wt();for(const h of Object.keys(r||{})){const x=r[h];x&&Array.isArray(x._sections)&&(u[h]=x._sections),x&&Array.isArray(x._commandSections)&&($[h]=x._commandSections),x&&x._platoonSectionMap&&typeof x._platoonSectionMap=="object"&&(ie[h]=x._platoonSectionMap)}E(r)}catch{}})();C(u),q($),X(ie)}catch{}(async()=>{he(!0),Ve(null);try{const n=await jt();if(n.error)throw new Error(n.error);g(n.data),b(n.data.length)}catch(n){const u=(n==null?void 0:n.message)||"Unknown error fetching users";console.error("[AdminPanel] Failed to fetch users:",u),Ve(u),g([]),b(0)}finally{he(!1)}})();try{const n=localStorage.getItem("currentUser");if(n){const u=JSON.parse(n);if(a(u),u.unitUic){const $=ze.find(ie=>ie.uic===u.unitUic);$&&N($)}}}catch{}},[]),s.useEffect(()=>{try{if(!o){const n=Object.keys(d||{});if(n.length){const u=n[0],$=d[u]||{},r=ze.find(h=>h.uic===u)||{ruc:String($._ruc||""),mcc:String($._mcc||""),uic:u,unitName:String($._unitName||u),streetAddress:String($._streetAddress||"")};N(r)}}}catch{}},[d]),s.useEffect(()=>{const n=(y==null?void 0:y.unitUic)||"";if(!n){Ne([]);return}ls(n).then(u=>Ne(u||[])).catch(()=>Ne([]))},[y]),s.useEffect(()=>{const n=(y==null?void 0:y.unitUic)||"",u=se||"";if(!n||!u){Ee([]);return}_t(n,u).then($=>Ee($||[])).catch(()=>Ee([]))},[y,se]);const je=s.useMemo(()=>{const n=(o==null?void 0:o.uic)||"";if(!n)return[];const u=d[n]||{};return Object.keys(u).filter($=>!$.startsWith("_")&&Array.isArray(u[$]))},[o,d]),$e=s.useMemo(()=>{var $;const n=(o==null?void 0:o.uic)||"";if(!n||!w)return[];const u=($=d[n])==null?void 0:$[w];return Array.isArray(u)?u:[]},[o,w,d]),et=s.useMemo(()=>{const n=(o==null?void 0:o.uic)||"";return n?D[n]||[]:[]},[o,D]),Qe=s.useMemo(()=>{const n=(o==null?void 0:o.uic)||"";return n?_[n]||[]:[]},[o,_]),ve=s.useMemo(()=>{const n=(y==null?void 0:y.unitUic)||"";if(!n)return[];const u=ke;if(u&&u.length)return u;const $=d[n]||{};return Object.keys($).filter(ie=>!ie.startsWith("_")&&Array.isArray($[ie]))},[y,d,ke]),Ye=s.useMemo(()=>{var ie;const n=(y==null?void 0:y.unitUic)||"",u=Ae||"";if(!n||!u)return[];const $=(ie=d[n])==null?void 0:ie[u];return Array.isArray($)?$:[]},[y,Ae,d]),tt=s.useMemo(()=>{var r,h;const n=(y==null?void 0:y.unitUic)||"",u=se||"";if(!u)return[];const $=Oe;if($&&$.length>0)return $;if(n){const x=(r=d[n])==null?void 0:r[u];if(Array.isArray(x)&&x.length>0)return x}const ie=(o==null?void 0:o.uic)||"";if(ie&&ie!==n){const x=(h=d[ie])==null?void 0:h[u];if(Array.isArray(x))return x}return[]},[y,se,d,Oe,o]),xt=s.useMemo(()=>{const n=ve.slice(),u=ge||(y&&y.company!=="N/A"?y.company:"");return u&&!n.includes(u)?[u,...n]:n},[ve,ge,y]);s.useMemo(()=>{const n=Ye.slice(),u=v||(y&&y.platoon&&y.platoon!=="N/A"?y.platoon:"");return u&&!n.includes(u)?[u,...n]:n},[Ye,v,y]);const pt=s.useMemo(()=>{const n=tt.slice(),u=le||(y&&y.rolePlatoon&&y.rolePlatoon!=="N/A"?y.rolePlatoon:"");return u&&!n.includes(u)?[u,...n]:n},[tt,le,y]),st=s.useMemo(()=>o?H.filter(n=>{const u=String(n.unitUic||"").trim().toUpperCase(),$=String(o.uic||"").trim().toUpperCase(),ie=String(n.unit||"").trim().toLowerCase(),r=String(o.unitName||"").trim().toLowerCase();return u&&u===$||ie&&ie===r}):H,[H,o]),ht=s.useMemo(()=>{if(!k)return st;const n=k.toLowerCase();return st.filter(u=>(u.email??"").toLowerCase().includes(n)||(u.lastName??"").toLowerCase().includes(n))},[st,k]),St=()=>{try{if(o){const n=o.uic,u={...d};u[n]=u[n]||{},u[n]._mcc=o.mcc||u[n]._mcc||"",u[n]._unitName=o.unitName||u[n]._unitName||"",E(u),localStorage.setItem("unit_structure",JSON.stringify(u)),(async()=>{try{if(navigator.sendBeacon){const ie=new Blob([JSON.stringify(u)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",ie),F({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),keepalive:!0})).ok)throw new Error("persist_failed");F({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{F({type:"error",message:"Failed to persist unit structure."})}})()}else{const n=JSON.stringify(d);localStorage.setItem("unit_structure",n),(async()=>{try{if(navigator.sendBeacon){const $=new Blob([n],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",$),F({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:n,keepalive:!0})).ok)throw new Error("persist_failed");F({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{F({type:"error",message:"Failed to persist unit structure."})}})()}}catch{F({type:"error",message:"Failed to save unit structure."})}},Ct=()=>{try{if(!o)return;const n=o.uic,u={...d};u[n]=u[n]||{},u[n]._sections=D[n]||[],u[n]._mcc=o.mcc||u[n]._mcc||"",u[n]._unitName=o.unitName||u[n]._unitName||"",E(u),localStorage.setItem("unit_structure",JSON.stringify(u)),(async()=>{try{if(navigator.sendBeacon){const ie=new Blob([JSON.stringify(u)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",ie),F({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),keepalive:!0})).ok)throw new Error("persist_failed");F({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{F({type:"error",message:"Failed to persist unit sections."})}})()}catch{F({type:"error",message:"Failed to save unit sections."})}},gt=()=>{try{if(!o)return;const n=o.uic,u={...d};u[n]=u[n]||{},u[n]._commandSections=_[n]||[],u[n]._mcc=o.mcc||u[n]._mcc||"",u[n]._unitName=o.unitName||u[n]._unitName||"",E(u),localStorage.setItem("unit_structure",JSON.stringify(u)),(async()=>{try{if(navigator.sendBeacon){const ie=new Blob([JSON.stringify(u)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",ie),F({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),keepalive:!0})).ok)throw new Error("persist_failed");F({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{F({type:"error",message:"Failed to persist command sections."})}})()}catch{F({type:"error",message:"Failed to save command sections."})}},At=()=>{try{if(!o)return;const n=o.uic,u={...d};u[n]=u[n]||{},u[n]._platoonSectionMap=W[n]||{},u[n]._mcc=o.mcc||u[n]._mcc||"",u[n]._unitName=o.unitName||u[n]._unitName||"",E(u),localStorage.setItem("unit_structure",JSON.stringify(u)),(async()=>{try{if(navigator.sendBeacon){const ie=new Blob([JSON.stringify(u)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",ie),F({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),keepalive:!0})).ok)throw new Error("persist_failed");F({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{F({type:"error",message:"Failed to persist links."})}})()}catch{F({type:"error",message:"Failed to save links."})}},ct=()=>{if(!o||!z.trim())return;const n=o.uic,u={...d};u[n]=u[n]||{},u[n][z.trim()]||(u[n][z.trim()]=[],E(u),J(z.trim()),B(""))},kt=n=>{if(!o)return;const u=o.uic,$={...d};$[u]&&(delete $[u][n],E($),w===n&&J(""))},Et=()=>{if(!o||!w||!c.trim())return;const n=o.uic,u={...d};u[n]=u[n]||{},u[n][w]=u[n][w]||[],u[n][w].includes(c.trim())||(u[n][w]=[...u[n][w],c.trim()],E(u),ee(""))},bt=n=>{if(!o||!w)return;const u=o.uic,$={...d};$[u][w]=($[u][w]||[]).filter(ie=>ie!==n),E($)},lt=()=>{if(!o||!T.trim())return;const n=o.uic,u={...D};u[n]=u[n]||[],u[n].includes(T.trim())||(u[n]=[...u[n],T.trim()],C(u),L(""))},ft=n=>{if(!o)return;const u=o.uic,$={...D};$[u]=($[u]||[]).filter(ie=>ie!==n),C($)},Rt=()=>{if(!o||!Q.trim())return;const n=o.uic,u={..._};u[n]=u[n]||[],u[n].includes(Q.trim())||(u[n]=[...u[n],Q.trim()],q(u),f(""))},It=n=>{if(!o)return;const u=o.uic,$={..._};$[u]=($[u]||[]).filter(ie=>ie!==n),q($)},Re=()=>{const n=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],u=H.map(x=>[x.firstName,x.mi||"",x.lastName,x.email,x.edipi,x.service,x.rank,x.role,x.company,x.unit,x.unitUic||""].map(R=>{const O=String(R??"");return O.includes(",")||O.includes('"')||O.includes(`
`)?'"'+O.replace(/"/g,'""')+'"':O}).join(",")),$="\uFEFF"+[n.join(","),...u].join(`
`),ie=new Blob([$],{type:"text/csv;charset=utf-8"}),r=URL.createObjectURL(ie),h=document.createElement("a");h.href=r,h.download="users-export.csv",h.click(),URL.revokeObjectURL(r)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${Z==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>re("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${Z==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>re("users"),children:"User Administration"})]})})}),Z==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:o?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:o.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",o.uic," | RUC: ",o.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:St,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:z,onChange:n=>B(n.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:ct,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[je.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>J(n),children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>kt(n),children:"Remove"})]},n)),je.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",w?`â€¢ ${w}`:""]}),o&&w&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:At,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:c,onChange:n=>ee(n.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!w}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:Et,disabled:!w,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[$e.map(n=>{var u,$;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:n})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:(($=(u=W[(o==null?void 0:o.uic)||""])==null?void 0:u[w])==null?void 0:$[n])||"",onChange:ie=>{const r=(o==null?void 0:o.uic)||"";X(h=>{const x={...h};return x[r]=x[r]||{},x[r][w]=x[r][w]||{},x[r][w][n]=ie.target.value,x})},children:[e.jsx("option",{value:"",children:"Link to section"}),(D[(o==null?void 0:o.uic)||""]||[]).map(ie=>e.jsx("option",{value:ie,children:ie},ie))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>bt(n),children:"Remove"})]})]},n)}),$e.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:Ct,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:T,onChange:n=>L(n.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:lt,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[et.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>ft(n),children:"Remove"})]},n)),et.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:gt,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:Q,onChange:n=>f(n.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Rt,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Qe.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>It(n),children:"Remove"})]},n)),Qe.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),Z==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),De&&e.jsxs("div",{className:"mb-4 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:[e.jsx("strong",{children:"Error loading users:"})," ",De]}),we&&e.jsx("div",{className:"mb-4 p-3 border border-blue-200 bg-blue-50 text-blue-800 rounded",children:"Loading users..."}),!we&&!De&&Ze>0&&st.length===0&&e.jsxs("div",{className:"mb-4 p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:[e.jsx("strong",{children:"Note:"})," ",Ze," user(s) found in database, but none match your unit (",(o==null?void 0:o.unitName)||"No unit selected",", UIC: ",(o==null?void 0:o.uic)||"N/A",").",e.jsx("br",{}),e.jsx("span",{className:"text-sm",children:"Users may be assigned to different units."})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[ht.map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[n.lastName,", ",n.firstName,n.mi?` ${n.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:n.email}),e.jsx("td",{className:"py-2 px-3",children:n.edipi}),e.jsx("td",{className:"py-2 px-3",children:n.service}),e.jsx("td",{className:"py-2 px-3",children:n.rank}),e.jsx("td",{className:"py-2 px-3",children:n.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const u=ze.find(ie=>ie.uic===n.unitUic),$=u?u.unitName:n.unit;if(n.isUnitAdmin||n.role==="COMMANDER")return $||"â€”";if(n.role==="COMPANY_REVIEWER")return n.company&&n.company!=="N/A"?n.company:"â€”";if(n.role==="PLATOON_REVIEWER"){const ie=n.company&&n.company!=="N/A"?n.company:"",r=n.platoon&&n.platoon!=="N/A"?n.platoon:"",h=[ie,r].filter(Boolean);return h.length?h.join(" / "):"â€”"}return"â€”"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>K(n),children:"View"}),((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{Me("admin"),Y(n),I(n.role??"MEMBER"),Se(n.company!=="N/A"?n.company:void 0),ye(n.company!=="N/A"?n.company:void 0),fe(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),P(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),j(typeof n.commandOrder=="number"?String(n.commandOrder):""),V(!!n.isUnitAdmin),ue(!!n.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{g(u=>u.filter($=>$.id!==n.id));try{localStorage.removeItem(`fs/users/${n.id}.json`)}catch(u){console.error("Failed to remove user from localStorage",u)}},children:"Delete"})]})})]},n.id)),ht.length===0&&!we&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:De?"Failed to load users - check console for details":Ze===0?"No users found in database":k?"No users match your search":"No users in this unit"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:S,type:"text",placeholder:"Filter users...",value:k,onChange:n=>G(n.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var n;return(n=S.current)==null?void 0:n.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:Re,children:"Export All"})]})]}),U&&e.jsx(ua,{user:U,onClose:()=>K(null)}),y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>Y(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>Y(null),children:"âœ•"})]}),pe==="profile"&&t&&y&&t.edipi===y.edipi&&e.jsx(ps,{mode:"edit",initial:y,readOnly:!1,onSaved:n=>{g(u=>u.map($=>$.edipi===n.edipi?n:$)),Y(null),F({type:"success",message:"Profile updated."})}}),pe==="admin"&&((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:oe,onChange:n=>{const u=n.target.value;I(u),u==="COMMANDER"&&(Se(void 0),fe(void 0))},className:"w-full px-3 py-2 border rounded",children:xa.map(n=>e.jsx("option",{value:n,children:n},n))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:se||"",onChange:n=>me(n.target.value||void 0),disabled:!oe.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:xt.length?"Select company":"No companies configured"}),xt.map(n=>e.jsx("option",{value:n,children:n},n))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:le||"",onChange:n=>Ie(n.target.value||void 0),disabled:!oe.includes("REVIEW")||!se,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:pt.length?"Select platoon":"No platoons configured"}),pt.map(n=>e.jsx("option",{value:n,children:n},n))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:l,onChange:n=>V(n.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:te,disabled:oe==="COMMANDER",onChange:async n=>{const u=n.target.checked;ue(u);try{if(y&&!(await Ke({id:y.id,email:y.email,rank:y.rank,firstName:y.firstName,lastName:y.lastName,mi:y.mi,service:y.service,role:y.role,unitUic:y.unitUic,unit:y.unit,company:y.company,isUnitAdmin:!!y.isUnitAdmin,isCommandStaff:u,edipi:y.edipi,passwordHash:y.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})]}),xe.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:xe.map((n,u)=>e.jsx("div",{className:"text-sm",children:n},u))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{Y(null),de.current=!1,p([]),i(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${A?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":A,disabled:A,onClick:async()=>{var ie;if(!y)return;const n=[];if(oe==="COMPANY_REVIEWER"&&!ge&&n.push("Company is required for Company Reviewer."),oe==="PLATOON_REVIEWER"&&(!ge||!Ce)&&n.push("Company and Platoon are required for Platoon Reviewer."),p(n),n.length)return;i(!0);const u=((ie=ze.find(r=>r.uic===y.unitUic))==null?void 0:ie.unitName)||"N/A",$={...y,role:oe,isUnitAdmin:l,isCommandStaff:oe==="COMMANDER"?!1:te,company:Ae||"N/A",unit:u,platoon:v||"N/A",roleCompany:oe.includes("REVIEW")?se||"N/A":void 0,rolePlatoon:oe.includes("REVIEW")?le||"N/A":void 0};try{localStorage.setItem(`fs/users/${$.edipi}.json`,JSON.stringify($))}catch{}try{if(!(await Ke({id:$.id,email:$.email,rank:$.rank,firstName:$.firstName,lastName:$.lastName,mi:$.mi,service:$.service,role:$.role,unitUic:$.unitUic,unit:$.unit,company:$.company,isUnitAdmin:!!$.isUnitAdmin,isCommandStaff:!!$.isCommandStaff,edipi:$.edipi,passwordHash:$.passwordHash,roleCompany:$.roleCompany,rolePlatoon:$.rolePlatoon,platoon:$.platoon})).ok)throw new Error("persist_failed")}catch{i(!1),F({type:"error",message:"Failed to save administrative changes."});return}g(r=>r.map(h=>h.edipi===$.edipi?$:h));try{t&&t.edipi===$.edipi&&(localStorage.setItem("currentUser",JSON.stringify($)),a($))}catch{}Y(null),de.current=!1,i(!1),F({type:"success",message:"Administrative changes saved."})},children:[A&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),M&&e.jsx("div",{className:`p-3 rounded-lg border ${M.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:M.message})]})};function ha(){const[t,a]=s.useState([]),[o,N]=s.useState(null),[d,E]=s.useState({}),[D,C]=s.useState({}),[_,q]=s.useState([]),[W,X]=s.useState("unit"),[w,J]=s.useState("assigned"),[z,B]=s.useState([]),[c,ee]=s.useState(""),[T,L]=s.useState([]),[Q,f]=s.useState(""),H=()=>{ot().then(p=>a(p)).catch(()=>a([]))},g=()=>{Nt().then(p=>q(p)).catch(()=>q([]))},M=()=>{N(null),H(),g()};s.useEffect(()=>{M(),ds().then(p=>B(p)),rs().then(p=>L(p))},[W,w]);const F=s.useMemo(()=>{const p={};for(const A of t)A.isUnitAdmin&&A.unitUic&&(p[A.unitUic]=A);return p},[t]),k=s.useMemo(()=>{const p=new Set;return ze.filter(A=>p.has(A.uic)?!1:(p.add(A.uic),!0))},[]),G=s.useMemo(()=>{const p={};for(const A of t)if(A.isInstallationAdmin&&A.installationId){const i=A.installationId;p[i]=p[i]||[],p[i].push(A)}return p},[t]),S=p=>t.filter(A=>A.unitUic===p.uic||!A.unitUic&&A.unit===p.unitName),y=async p=>{const A=d[p.uic];if(!A)return;const i=t.find(V=>V.id===A);if(!i)return;const l={...i,isUnitAdmin:!0,unitUic:p.uic,unit:p.unitName,company:"N/A"};try{if(!(await Ke({id:l.id,email:l.email,rank:l.rank,firstName:l.firstName,lastName:l.lastName,mi:l.mi,service:l.service,role:l.role,unitUic:l.unitUic,unit:l.unit,company:l.company,isUnitAdmin:!!l.isUnitAdmin,isInstallationAdmin:!!l.isInstallationAdmin,isCommandStaff:!!l.isCommandStaff,edipi:l.edipi})).ok){N({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}a(V=>V.map(te=>te.id===l.id?l:te)),N({type:"success",message:`Assigned ${l.rank} ${l.lastName} as admin for ${p.unitName}.`})},Y=s.useMemo(()=>k.filter(p=>!!F[p.uic]),[k,F]);s.useMemo(()=>(Array.isArray(t)?t:[]).filter(p=>!!p.isHqmcAdmin),[t]);const U=s.useMemo(()=>k.filter(p=>!F[p.uic]),[k,F]),K=s.useMemo(()=>(Array.isArray(z)?z:[]).filter(p=>{var A;return(A=G[p.id])==null?void 0:A.length}),[z,G]),oe=s.useMemo(()=>(Array.isArray(z)?z:[]).filter(p=>{var A;return!((A=G[p.id])!=null&&A.length)}),[z,G]),I=s.useMemo(()=>{const p={};for(const A of Array.isArray(t)?t:[])if(A.isHqmcAdmin&&A.hqmcDivision){const i=A.hqmcDivision;p[i]=p[i]||[],p[i].push(A)}return p},[t]),ge=s.useMemo(()=>(Array.isArray(T)?T:[]).filter(p=>{var A;return(A=I[p.code])==null?void 0:A.length}),[T,I]);s.useMemo(()=>{const p=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return(Array.isArray(_)?_:[]).filter(A=>p.includes(String(A.currentStage||"")))},[_]);const[Se,Ce]=s.useState(1),[fe,Ae]=s.useState(10),ye=Y.length,v=Math.max(1,Math.ceil(ye/(fe||1))),P=Math.min(Se,v),se=ye===0?0:(P-1)*fe+1,me=ye===0?0:Math.min(se+fe-1,ye),le=Y.slice((P-1)*fe,(P-1)*fe+fe),[Ie,ke]=s.useState(1),[Ne,Oe]=s.useState(10),Ee=U.length,m=Math.max(1,Math.ceil(Ee/(Ne||1))),j=Math.min(Ie,m),Z=Ee===0?0:(j-1)*Ne+1,re=Ee===0?0:Math.min(Z+Ne-1,Ee),xe=U.slice((j-1)*Ne,(j-1)*Ne+Ne);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${W==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{X("unit"),J("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${W==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{X("installation"),J("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${W==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{X("hqmc"),J("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${w==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>J("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${w==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>J("missing"),children:"Missing"})]}),W==="installation"&&w==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[K.map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.name}),e.jsx("td",{className:"py-2 px-3",children:(G[p.id]||[]).map(A=>`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`).join(" â€¢ ")})]},p.id)),K.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),W==="installation"&&w==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[oe.map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:D[p.id]||"",onChange:A=>C(i=>({...i,[p.id]:A.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(A=>e.jsx("option",{value:A.id,children:`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`},A.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!D[p.id],onClick:async()=>{const A=D[p.id],i=t.find(V=>V.id===A);if(!i)return;const l={...i,isInstallationAdmin:!0,installationId:p.id};try{if(!(await Ke({id:l.id,email:l.email,rank:l.rank,firstName:l.firstName,lastName:l.lastName,mi:l.mi,service:l.service,role:l.role,unitUic:l.unitUic,unit:l.unit,company:l.company,isUnitAdmin:!!l.isUnitAdmin,isInstallationAdmin:!!l.isInstallationAdmin,isCommandStaff:!!l.isCommandStaff,edipi:l.edipi,installationId:l.installationId})).ok){N({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}a(V=>V.map(te=>te.id===l.id?l:te)),N({type:"success",message:`Assigned ${l.rank} ${l.lastName} as installation admin.`})},children:"Assign"})})]},p.id)),oe.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),W==="unit"&&w==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[le.map(p=>{const A=F[p.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.unitName}),e.jsx("td",{className:"py-2 px-3",children:p.uic}),e.jsx("td",{className:"py-2 px-3",children:`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`})]},p.uic)}),Y.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(Lt,{currentPage:P,totalPages:v,totalItems:ye,pageSize:fe,startIndex:se,endIndex:me,onPageChange:p=>Ce(p),onPageSizeChange:p=>{Ae(p),Ce(1)},onNext:()=>Ce(Math.min(P+1,v)),onPrevious:()=>Ce(Math.max(P-1,1)),onFirst:()=>Ce(1),onLast:()=>Ce(v),canGoNext:P<v,canGoPrevious:P>1,pageSizeOptions:[5,10,25,50]})})]}),W==="unit"&&w==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[xe.map(p=>{const A=S(p);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:p.unitName}),e.jsx("td",{className:"py-2 px-3",children:p.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:d[p.uic]||"",onChange:i=>E(l=>({...l,[p.uic]:i.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:A.length?"Select user":"No eligible users"}),A.map(i=>e.jsx("option",{value:i.id,children:`${i.rank} ${i.lastName}, ${i.firstName}${i.mi?` ${i.mi}`:""}`},i.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!d[p.uic],onClick:()=>y(p),children:"Assign"})})]},p.uic)}),U.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(Lt,{currentPage:j,totalPages:m,totalItems:Ee,pageSize:Ne,startIndex:Z,endIndex:re,onPageChange:p=>ke(p),onPageSizeChange:p=>{Oe(p),ke(1)},onNext:()=>ke(Math.min(j+1,m)),onPrevious:()=>ke(Math.max(j-1,1)),onFirst:()=>ke(1),onLast:()=>ke(m),canGoNext:j<m,canGoPrevious:j>1,pageSizeOptions:[5,10,25,50]})})]}),W==="hqmc"&&w==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[ge.map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[p.code," â€” ",p.name]}),e.jsx("td",{className:"py-2 px-3",children:(I[p.code]||[]).map(A=>`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`).join(" â€¢ ")})]},p.code)),ge.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),W==="hqmc"&&w==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[T.filter(p=>{var A;return!((A=I[p.code])!=null&&A.length)}).map(p=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[p.code," â€” ",p.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:D[`hqmc_${p.code}`]||"",onChange:A=>C(i=>({...i,[`hqmc_${p.code}`]:A.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(A=>e.jsx("option",{value:A.id,children:`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`},A.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!D[`hqmc_${p.code}`],onClick:async()=>{const A=D[`hqmc_${p.code}`],i=t.find(V=>V.id===A);if(!i)return;const l={...i,isHqmcAdmin:!0,hqmcDivision:p.code};try{if(!(await Ke({id:l.id,email:l.email,rank:l.rank,firstName:l.firstName,lastName:l.lastName,mi:l.mi,service:l.service,role:l.role,unitUic:l.unitUic,unit:l.unit,company:l.company,isUnitAdmin:!!l.isUnitAdmin,isInstallationAdmin:!!l.isInstallationAdmin,isCommandStaff:!!l.isCommandStaff,isHqmcAdmin:!!l.isHqmcAdmin,hqmcDivision:l.hqmcDivision,edipi:l.edipi})).ok){N({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}a(V=>V.map(te=>te.id===l.id?l:te)),N({type:"success",message:`Assigned ${l.rank} ${l.lastName} as HQMC admin for ${p.code}.`})},children:"Assign"})})]},p.code)),T.filter(p=>{var A;return!((A=I[p.code])!=null&&A.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),o&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${o.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:o.message})]})})}const ss=!0,ga=({onLoggedIn:t,onCreateAccount:a})=>{const[o,N]=s.useState(""),[d,E]=s.useState(""),[D,C]=s.useState(null),[_,q]=s.useState(!0),[W,X]=s.useState(!0);js.useEffect(()=>{},[]);const w=async J=>{J.preventDefault(),C(null);try{const z=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,B=/^[0-9]{10}$/.test(o),c=ss?z.test(o.trim().toLowerCase())||B:z.test(o.trim().toLowerCase()),ee=d.length>=6;if(q(c),X(ee),!c){C({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!ee){C({type:"error",message:"Password must be at least 6 characters."});return}let T=null,L=null,Q=o.trim().toLowerCase();if(ss&&B){const{user:G,error:S}=await Ot(String(o));T=G,L=S,Q=String((T==null?void 0:T.email)||"")}else if(z.test(Q)){const{user:G,error:S}=await zt(Q);T=G,L=S}else{C({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(L){C({type:"error",message:`Database Error: ${L}`});return}if(!T||!Q){C({type:"error",message:"Account not found."});return}const f=String(T.passwordHash||T.password_hash||"").trim();if(!f){C({type:"error",message:"No password set for this user."});return}const H=await qt(d);if(!(/^[0-9a-f]{64}$/i.test(f)?f.toLowerCase()===H.toLowerCase():f===d)){C({type:"error",message:"Invalid credentials."});return}const{user:F,error:k}=await zt(Q);if(k){C({type:"error",message:`Profile Error: ${k}`});return}if(!F){console.error("[Login] User profile not found after successful password verification",{emailForLogin:Q}),C({type:"error",message:"User profile not found."});return}C({type:"success",message:"Logged in."}),t(F)}catch(z){console.error("[Login] Login failed:",z),C({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:w,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:o,onChange:J=>N(J.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${_?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!_}),!_&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:d,onChange:J=>E(J.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${W?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!W}),!W&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),D&&e.jsx("div",{className:`p-3 rounded-lg border ${D.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:D.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:a,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!_||!W,children:"Login"})]})]})]})},as=""+new URL("logo-DLcHofKE.png",import.meta.url).href,ba=({currentUser:t,hasSectionDashboard:a,hasCommandDashboard:o,hasInstallationSectionDashboard:N=!1,hasInstallationCommandDashboard:d=!1,hasHQMCSectionDashboard:E=!1,hasHQMCApproverDashboard:D=!1,onManageProfile:C,onLogout:_,onNavigate:q,isLogin:W=!1})=>{const[X,w]=s.useState(!1),[J,z]=s.useState(!1),B=s.useRef(null);return s.useEffect(()=>{const c=T=>{if(!X)return;const L=B.current;L&&T.target&&!L.contains(T.target)&&w(!1)},ee=T=>{T.key==="Escape"&&w(!1)};return document.addEventListener("mousedown",c),document.addEventListener("touchstart",c,{passive:!0}),document.addEventListener("keydown",ee),()=>{document.removeEventListener("mousedown",c),document.removeEventListener("touchstart",c),document.removeEventListener("keydown",ee)}},[X]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:W?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:as,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:as,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:t?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[t.rank," ",t.lastName,t.lastName?",":""," ",t.firstName,t.mi?` ${t.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[t.service," â€¢ ",t.role,(()=>{const c={PLATOON_REVIEWER:t.role_platoon,COMPANY_REVIEWER:t.role_company}[t.role];return c?` - ${c}`:null})()]}),(()=>{var Q;const c=((Q=ze.find(f=>f.uic===((t==null?void 0:t.unitUic)||"")))==null?void 0:Q.unitName)||(t==null?void 0:t.unit)||"",ee=t!=null&&t.company&&t.company!=="N/A"?t.company:t!=null&&t.user_company&&t.user_company!=="N/A"?t.user_company:null,T=t!=null&&t.platoon&&t.platoon!=="N/A"?t.platoon:t!=null&&t.user_platoon&&t.user_platoon!=="N/A"?t.user_platoon:null,L=[c||null,ee,T].filter(Boolean);return L.length?e.jsx("div",{className:"text-xs text-white/70",children:L.join(" â€¢ ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:C,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:_,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),t&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>z(!J),children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),J&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{C(),z(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{_(),z(!1)},children:"Logout"})]})]}),!t&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>q("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:B,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":X,onClick:()=>w(c=>!c),children:"Dashboards"}),e.jsxs("div",{className:`${X?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:t&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{q("dashboard"),w(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(t==null?void 0:t.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{q("admin"),w(!1)},children:"Unit Admin"}),t&&!!t.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{q("appadmin"),w(!1)},children:"App Admin"}),t&&!!t.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{q("hqmc-admin"),w(!1)},children:"HQMC Admin"}),t&&!!t.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{q("installation"),w(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[t&&a&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{q("section"),w(!1)},children:"Unit Section Dashboard"}),o&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{q("command"),w(!1)},children:"Unit Command Dashboard"}),String((t==null?void 0:t.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{q("review"),w(!1)},children:"Unit Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[t&&N&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{q("installation-section"),w(!1)},children:"Installation Section Dashboard"}),t&&d&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{q("installation-command"),w(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[t&&(E||!!t.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{q("hqmc-section"),w(!1)},children:"HQMC Section Dashboard"}),t&&D&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{q("hqmc-approver"),w(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})},Be={SECTION:"perm_section",COMMAND:"perm_command",INST_SECTION:"perm_inst_section",INST_COMMAND:"perm_inst_command",HQMC_SECTION:"perm_hqmc_section",HQMC_APPROVER:"perm_hqmc_approver"},it=t=>{try{return localStorage.getItem(t)==="true"}catch(a){return console.error(`Failed to read from localStorage for key "${t}":`,a),!1}};function fa(){const[t,a]=s.useState(null),[o,N]=s.useState("login"),[d,E]=s.useState(()=>{try{const g=localStorage.getItem("currentUser");return g?JSON.parse(g):null}catch(g){return console.error("Failed to parse user from localStorage:",g),null}}),[D,C]=s.useState("create"),[_,q]=s.useState(!1),[W,X]=s.useState(()=>it(Be.SECTION)),[w,J]=s.useState(()=>it(Be.COMMAND)),[z,B]=s.useState(()=>it(Be.INST_SECTION)),[c,ee]=s.useState(()=>it(Be.INST_COMMAND)),[T,L]=s.useState(()=>it(Be.HQMC_SECTION)),[Q,f]=s.useState(()=>it(Be.HQMC_APPROVER)),H=ws();return s.useEffect(()=>{try{const M=new URLSearchParams(window.location.search).get("view");if(M==="admin"||M==="profile"||M==="dashboard"||M==="login"||M==="appadmin"||M==="hqmc-admin"||M==="hqmc-section"||M==="hqmc-approver"||M==="review"||M==="section"||M==="command"||M==="installation"||M==="installation-section"||M==="installation-command"||M==="documents"||M==="document-viewer"||M==="upload")N(M);else{const F=localStorage.getItem("currentView"),k=localStorage.getItem("currentUser");N(F&&k?F:"login")}}catch{N("login")}},[]),s.useEffect(()=>{d?localStorage.setItem("currentUser",JSON.stringify(d)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"),Object.values(Be).forEach(g=>{try{localStorage.removeItem(g)}catch(M){console.error(`Failed to remove item from localStorage for key "${g}":`,M)}}))},[d]),s.useEffect(()=>{if(!d)return;const g={[Be.SECTION]:W,[Be.COMMAND]:w,[Be.INST_SECTION]:z,[Be.INST_COMMAND]:c,[Be.HQMC_SECTION]:T,[Be.HQMC_APPROVER]:Q};for(const[M,F]of Object.entries(g))try{localStorage.setItem(M,String(F))}catch(k){console.error(`Failed to set item in localStorage for key "${M}":`,k)}},[d,W,w,z,c,T,Q]),s.useEffect(()=>{let g=!1;return(async()=>{try{const M=(d==null?void 0:d.id)||"";if(!M)return;const F=await cs(M);if(F&&!g){const k=(y,Y)=>y===!0||y===!1?y:Y||!1,G=(y,Y)=>y!=null?y||void 0:Y,S={...F,isAppAdmin:k(F.isAppAdmin,d==null?void 0:d.isAppAdmin),isUnitAdmin:k(F.isUnitAdmin,d==null?void 0:d.isUnitAdmin),isInstallationAdmin:k(F.isInstallationAdmin,d==null?void 0:d.isInstallationAdmin),isHqmcAdmin:k(F.isHqmcAdmin,d==null?void 0:d.isHqmcAdmin),isCommandStaff:k(F.isCommandStaff,d==null?void 0:d.isCommandStaff),installationId:G(F.installationId,d==null?void 0:d.installationId),hqmcDivision:G(F.hqmcDivision,d==null?void 0:d.hqmcDivision)};E(S),localStorage.setItem("currentUser",JSON.stringify(S))}}catch{}})(),()=>{g=!0}},[]),s.useEffect(()=>{o!=="login"&&d&&localStorage.setItem("currentView",o)},[o,d]),s.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const M=await wt();localStorage.setItem("unit_structure",JSON.stringify(M))}catch(g){console.error("Failed to load unit structure:",g)}})()},[]),s.useEffect(()=>{var g,M,F;if(d){try{const k=localStorage.getItem("unit_structure");if(k){const G=JSON.parse(k),S=(d==null?void 0:d.unitUic)||"",y=d!=null&&d.company&&d.company!=="N/A"?d.company:"",Y=d!=null&&d.platoon&&d.platoon!=="N/A"?d.platoon:"",U=((F=(M=(g=G==null?void 0:G[S])==null?void 0:g._platoonSectionMap)==null?void 0:M[y])==null?void 0:F[Y])||"";X(!!U)}}catch(k){console.error("Failed to parse unit structure for section dashboard check",k)}J(!!(d!=null&&d.isCommandStaff)),(async()=>{try{const k=(d==null?void 0:d.installationId)||"";if(!k){B(!1),ee(!1);return}const G=await ds();try{localStorage.setItem("installations_cache",JSON.stringify(G))}catch{}const S=G==null?void 0:G.find(K=>K.id===k),y=(d==null?void 0:d.id)||"",Y=!!(S&&S.sectionAssignments&&Object.values(S.sectionAssignments).some(K=>Array.isArray(K)&&K.includes(y))),U=!!(S&&(S.commandSectionAssignments&&Object.values(S.commandSectionAssignments).some(K=>Array.isArray(K)&&K.includes(y))||S.commanderUserId&&String(S.commanderUserId)===y));B(Y),ee(U)}catch{}})(),(async()=>{try{const k=String((d==null?void 0:d.hqmcDivision)||""),G=String((d==null?void 0:d.id)||"");if(!k||!G){L(!!(d!=null&&d.isHqmcAdmin)),f(!1);return}const{listHQMCSectionAssignmentsLegacy:S}=await Ss(async()=>{const{listHQMCSectionAssignmentsLegacy:K}=await import("./db-CdX_sRVb.js").then(oe=>oe.A);return{listHQMCSectionAssignmentsLegacy:K}},__vite__mapDeps([0,1,2]),import.meta.url),y=await S(),Y=y.some(K=>K.division_code===k&&((K.reviewers||[]).includes(G)||(K.approvers||[]).includes(G))),U=y.some(K=>K.division_code===k&&(K.approvers||[]).includes(G));L(Y||!!(d!=null&&d.isHqmcAdmin)),f(U)}catch{d!=null&&d.isHqmcAdmin&&L(!0)}})()}},[d]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(ba,{currentUser:d,hasSectionDashboard:W,hasCommandDashboard:w,hasInstallationSectionDashboard:z,hasInstallationCommandDashboard:c,hasHQMCSectionDashboard:T,hasHQMCApproverDashboard:Q,onManageProfile:()=>{C("edit"),N("profile"),H("/?view=profile")},onLogout:()=>{E(null),N("login"),H("/?view=login")},onNavigate:g=>{N(g),H(`/?view=${g}`)},isLogin:o==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:o==="profile"?e.jsx(ps,{mode:D,initial:D==="edit"?d||{}:{},onSaved:g=>{E(g),N("dashboard"),H("/?view=dashboard")}}):o==="admin"?e.jsx(pa,{}):o==="appadmin"?e.jsx(ha,{}):o==="login"?e.jsx(ga,{onLoggedIn:g=>{E(g),N("dashboard"),H("/?view=dashboard")},onCreateAccount:()=>{C("create"),N("profile"),H("/?view=profile")}}):o==="review"?e.jsx(na,{}):o==="section"?e.jsx(qs,{}):o==="command"?e.jsx(Fs,{}):o==="installation"?e.jsx(Ms,{}):o==="hqmc-admin"?e.jsx(ra,{}):o==="installation-section"?e.jsx(Bs,{}):o==="installation-command"?e.jsx(Vs,{}):o==="hqmc-section"?e.jsx(oa,{}):o==="hqmc-approver"?e.jsx(ca,{}):e.jsx(Ks,{selectedUnit:t,currentUser:d})})]})}function Ma(){return e.jsx(fa,{})}export{Ma as default};
