const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-CsqImcOP.js","./index-CCWMmcgp.js","./index-DOJlyb3T.css"])))=>i.map(i=>d[i]);
import{r as s,j as e,s as Dt,v as Jt,l as dt,M as jt,a as Yt,u as Kt,R as Xt,b as Zt,_ as es}from"./index-CCWMmcgp.js";import{s as Re,d as ts,a as ss,b as as,l as ft,c as lt,e as Ke,u as Te,f as ut,g as yt,h as Qe,i as ns,j as rs,k as $t,m as vt,n as _t,o as pt,p as is,q as os,r as Lt,t as qt,v as xt,w as Tt,x as St}from"./db-CsqImcOP.js";import{P as ht,I as cs}from"./InstallationAdmin-COwM7gJo.js";import{f as Bt,R as Ye,S as ze,o as wt,c as ls,a as ds}from"./RequestTable-3_gJoXZp.js";import{c as ms,F as us,D as Vt,a as tt}from"./DocumentListItem-BnEwgyAe.js";import{l as Nt}from"./unitStructure-QC5qYuxv.js";import ps from"./SectionDashboard-GwK8RbED.js";import xs from"./CommandDashboard-gqwOeg9S.js";import hs from"./InstallationSectionDashboard-C-H-AyPr.js";import gs from"./InstallationCommandDashboard-Dlfz90qP.js";import{U as We}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-BQggzHpc.js";import"./utils-CLmukD0c.js";const bs={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},fs=({filters:t,onFiltersChange:a,statusOptions:i=[],originatorOptions:h=[],searchPlaceholder:c="Search requests...",showAdvanced:S=!0,className:w=""})=>{var B;const[y,P]=s.useState(!1),O=s.useRef(null),_=s.useMemo(()=>Array.isArray(t.status)?t.status:[],[t.status]),Z=s.useMemo(()=>{let g=0;return _.length>0&&g++,t.dateFrom&&g++,t.dateTo&&g++,t.originatorId&&g++,g},[_,t.dateFrom,t.dateTo,t.originatorId]),j=s.useCallback(g=>{a({...t,search:g.target.value})},[t,a]),U=s.useCallback(g=>{const V=_.includes(g)?_.filter(m=>m!==g):[..._,g];a({...t,status:V})},[t,_,a]),H=s.useCallback(g=>{a({...t,dateFrom:g.target.value})},[t,a]),L=s.useCallback(g=>{a({...t,dateTo:g.target.value})},[t,a]),l=s.useCallback(g=>{a({...t,originatorId:g.target.value})},[t,a]),se=s.useCallback(()=>{var g;a(bs),(g=O.current)==null||g.focus()},[a]),T=s.useCallback(()=>{var g;a({...t,search:""}),(g=O.current)==null||g.focus()},[t,a]);s.useEffect(()=>{const g=V=>{var m;(V.metaKey||V.ctrlKey)&&V.key==="k"&&(V.preventDefault(),(m=O.current)==null||m.focus())};return document.addEventListener("keydown",g),()=>document.removeEventListener("keydown",g)},[]);const R=t.search||Z>0;return e.jsxs("div",{className:`space-y-3 ${w}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{ref:O,type:"text",value:t.search,onChange:j,placeholder:c,className:"block w-full pl-10 pr-10 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold bg-[var(--surface)] text-[var(--text)]","aria-label":"Search"}),t.search&&e.jsx("button",{onClick:T,className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600","aria-label":"Clear search",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute inset-y-0 right-8 flex items-center pointer-events-none text-xs text-gray-400",children:e.jsx("kbd",{className:"hidden sm:inline-block px-1.5 py-0.5 bg-gray-100 rounded border border-gray-200 font-mono",children:"⌘K"})})]}),S&&e.jsxs("button",{onClick:()=>P(!y),className:`
              flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors
              ${y||Z>0?"bg-brand-gold/10 border-brand-gold text-brand-navy":"border-brand-navy/30 text-[var(--text)] hover:bg-brand-cream/50"}
            `,"aria-expanded":y,"aria-controls":"filter-panel",children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"})}),e.jsx("span",{className:"hidden sm:inline",children:"Filters"}),Z>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-brand-navy rounded-full",children:Z})]}),R&&e.jsxs("button",{onClick:se,className:"flex items-center gap-1 px-3 py-2 text-sm text-brand-red hover:text-brand-red-2 hover:bg-red-50 rounded-lg transition-colors","aria-label":"Clear all filters",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),S&&y&&e.jsxs("div",{id:"filter-panel",className:"p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[i.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Status"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:i.map(g=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-white/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:_.includes(g.value),onChange:()=>U(g.value),className:"h-4 w-4 text-brand-navy border-gray-300 rounded focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-[var(--text)]",children:g.label})]},g.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Date Range"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"From date"}),e.jsx("input",{type:"date",value:t.dateFrom,onChange:H,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"From date"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"To date"}),e.jsx("input",{type:"date",value:t.dateTo,onChange:L,min:t.dateFrom,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"To date"})]})]})]}),h.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Originator"}),e.jsxs("select",{value:t.originatorId,onChange:l,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"Filter by originator",children:[e.jsx("option",{value:"",children:"All originators"}),h.map(g=>e.jsx("option",{value:g.value,children:g.label},g.value))]})]})]}),Z>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 pt-2 border-t border-brand-navy/10",children:[e.jsx("span",{className:"text-sm text-[var(--muted)]",children:"Active filters:"}),_.map(g=>{const V=i.find(m=>m.value===g);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[(V==null?void 0:V.label)||g,e.jsx("button",{onClick:()=>U(g),className:"hover:text-brand-red","aria-label":`Remove ${(V==null?void 0:V.label)||g} filter`,children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},g)}),t.dateFrom&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["From: ",t.dateFrom,e.jsx("button",{onClick:()=>a({...t,dateFrom:""}),className:"hover:text-brand-red","aria-label":"Remove from date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.dateTo&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["To: ",t.dateTo,e.jsx("button",{onClick:()=>a({...t,dateTo:""}),className:"hover:text-brand-red","aria-label":"Remove to date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.originatorId&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[((B=h.find(g=>g.value===t.originatorId))==null?void 0:B.label)||"Originator",e.jsx("button",{onClick:()=>a({...t,originatorId:""}),className:"hover:text-brand-red","aria-label":"Remove originator filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]})]})};function ys(t,a){return s.useMemo(()=>{let i=Array.isArray(a.items)?a.items:[];const h=Array.isArray(t.status)?t.status:[];if(t.search){const c=t.search.toLowerCase();i=i.filter(S=>a.getSearchText(S).toLowerCase().includes(c))}return h.length>0&&a.getStatus&&(i=i.filter(c=>h.includes(a.getStatus(c)))),(t.dateFrom||t.dateTo)&&a.getDate&&(i=i.filter(c=>{const S=a.getDate(c);if(!S)return!1;const w=new Date(S);if(isNaN(w.getTime()))return!1;if(t.dateFrom){const y=new Date(t.dateFrom);if(w<y)return!1}if(t.dateTo){const y=new Date(t.dateTo);if(y.setHours(23,59,59,999),w>y)return!1}return!0})),t.originatorId&&a.getOriginatorId&&(i=i.filter(c=>a.getOriginatorId(c)===t.originatorId)),i},[t,a])}function Ct(t){if(t==null)return"";const a=String(t);return a.includes('"')||a.includes(",")||a.includes(`
`)||a.includes("\r")?`"${a.replace(/"/g,'""')}"`:a}function vs(t,a){const h=a.map(S=>Ct(S.header)).join(","),c=t.map(S=>a.map(w=>{const y=w.getValue(S),P=w.format?w.format(y):y;return Ct(P)}).join(","));return[h,...c].join(`\r
`)}function Ns(t,a){const i=t.map(h=>{const c={};return a.forEach(S=>{const w=S.getValue(h);c[S.header]=S.format?S.format(w):w}),c});return JSON.stringify(i,null,2)}function At(t,a,i){const h=new Blob([t],{type:`${i};charset=utf-8;`}),c=URL.createObjectURL(h),S=document.createElement("a");S.href=c,S.download=a,document.body.appendChild(S),S.click(),document.body.removeChild(S),URL.revokeObjectURL(c)}function js({items:t,columns:a,filename:i="export",label:h="Export",variant:c="secondary",className:S="",disabled:w=!1,showCount:y=!0,formats:P=["csv"]}){const[O,_]=s.useState(!1),[Z,j]=s.useState(!1),U=s.useRef(null),H=s.useCallback(se=>{j(!0),_(!1),setTimeout(()=>{try{const T=new Date().toISOString().slice(0,10),R=`${i}_${T}`;if(se==="csv"){const B=vs(t,a);At(B,`${R}.csv`,"text/csv")}else{const B=Ns(t,a);At(B,`${R}.json`,"application/json")}}catch(T){console.error("Export failed:",T)}finally{j(!1)}},100)},[t,a,i]);s.useEffect(()=>{const se=T=>{U.current&&!U.current.contains(T.target)&&_(!1)};return O&&document.addEventListener("mousedown",se),()=>{document.removeEventListener("mousedown",se)}},[O]),s.useEffect(()=>{const se=T=>{T.key==="Escape"&&_(!1)};return O&&document.addEventListener("keydown",se),()=>{document.removeEventListener("keydown",se)}},[O]);const L={primary:"bg-brand-navy text-brand-cream hover:bg-brand-navy/90",secondary:"bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold/10",text:"text-brand-navy hover:bg-brand-cream/50"},l=w||t.length===0||Z;return P.length===1?e.jsxs("button",{onClick:()=>H(P[0]),disabled:l,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${L[c]}
          ${S}
        `,children:[Z?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:h}),y&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]})]}):e.jsxs("div",{className:"relative",ref:U,children:[e.jsxs("button",{onClick:()=>_(!O),disabled:l,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${L[c]}
          ${S}
        `,"aria-expanded":O,"aria-haspopup":"menu",children:[Z?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:h}),y&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${O?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),O&&e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-[var(--surface)] border border-brand-navy/20 rounded-lg shadow-lg z-50",role:"menu",children:[P.includes("csv")&&e.jsxs("button",{onClick:()=>H("csv"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 first:rounded-t-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export as CSV"]}),P.includes("json")&&e.jsxs("button",{onClick:()=>H("json"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 last:rounded-b-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})}),"Export as JSON"]})]})]})}const Et=t=>{if(!t)return"";const a=new Date(t);return isNaN(a.getTime())?"":a.toLocaleDateString()};function gt(t,a={}){const{pageSize:i=25,initialPage:h=1}=a,[c,S]=s.useState(h),[w,y]=s.useState(i),P=t.length,O=Math.ceil(P/w),_=(c-1)*w,Z=Math.min(_+w,P);return{currentData:s.useMemo(()=>t.slice(_,Z),[t,_,Z]),currentPage:c,pageSize:w,totalPages:O,totalItems:P,goToPage:R=>{const B=Math.max(1,Math.min(R,O));S(B)},nextPage:()=>{c<O&&S(c+1)},previousPage:()=>{c>1&&S(c-1)},goToFirstPage:()=>{S(1)},goToLastPage:()=>{S(O)},setPageSize:R=>{y(R),S(1)},canGoNext:c<O,canGoPrevious:c>1,startIndex:_+1,endIndex:Z}}const at="edms-docs";function Ss(){return{uploadFile:async(S,w)=>{if(!Re)return{url:"",error:"Supabase not configured"};try{const{error:y}=await Re.storage.from(at).upload(w,S,{upsert:!0});if(y)return{url:"",error:y.message};const{data:P}=Re.storage.from(at).getPublicUrl(w);return{url:(P==null?void 0:P.publicUrl)||""}}catch(y){return{url:"",error:y instanceof Error?y.message:"Upload failed"}}},deleteFile:async S=>{if(!Re||!S)return!1;try{return await Re.storage.from(at).remove([S]),!0}catch{return!1}},deleteFolder:async S=>{if(!Re)return!1;try{const{data:w}=await Re.storage.from(at).list(S.replace(/\/$/,""));if(w&&w.length>0){const y=w.map(P=>`${S.replace(/\/$/,"")}/${P.name}`);await Re.storage.from(at).remove(y)}return!0}catch{return!1}},extractStoragePath:S=>{if(!S)return null;try{const w=S.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(w!=null&&w[1])return decodeURIComponent(w[1])}catch{}return null},buildStoragePath:(S,w,y,P)=>{const O=Date.now();return`${S||"N-A"}/${w}/${O}-${P}-${Dt(y)}`}}}const Je=t=>{const a=String(t||"").trim();return a&&a!=="N/A"?a:""},rt=(t,a,i)=>t.some(h=>String(h.role||"")!==a||Je(h.roleCompany||h.company)!==i.company||a==="PLATOON_REVIEWER"&&Je(h.rolePlatoon||h.platoon)!==(i.platoon||"")?!1:String(h.unitUic||"")===String(i.uic||""));function Ft(t){if(t===0)return"0 Bytes";const a=1024,i=["Bytes","KB","MB","GB"],h=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,h)).toFixed(2))+" "+i[h]}const kt=s.memo(function({doc:a,onView:i,onDelete:h}){const[c,S]=s.useState(!1),w=a.fileUrl&&ms(a.type,a.name);return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:"flex items-center justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors","aria-label":`Document: ${a.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(us,{type:a.type,fileName:a.name,size:"md"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-[var(--text)]",children:a.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)]",children:[a.name," • ",Ft(a.size)," • ",new Date(a.uploadedAt).toLocaleDateString()]}),a.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(a.dueDate).toLocaleDateString()]}),a.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Notes: ",a.notes]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",role:"group","aria-label":"Document actions",children:[a.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Bt({currentStage:a.currentStage})}),w&&e.jsx("button",{type:"button",onClick:y=>{y.stopPropagation(),S(!0)},className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Preview document ${a.name}`,children:"Preview"}),a.fileUrl&&e.jsx("a",{href:a.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${a.name} in new tab`,children:"Open"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:y=>{y.stopPropagation(),i(a)},"aria-label":`View or edit document ${a.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:y=>{y.stopPropagation(),h(a)},"aria-label":`Delete document ${a.subject}`,children:"Delete"})]})]}),a.fileUrl&&e.jsx(Vt,{url:a.fileUrl,fileName:a.name,mimeType:a.type,fileSize:a.size,isOpen:c,onClose:()=>S(!1)})]})}),Ue="edms-docs",ws=({selectedUnit:t,currentUser:a})=>{const[i,h]=s.useState([]),[c,S]=s.useState(!1),[w,y]=s.useState(""),[P,O]=s.useState(""),[_,Z]=s.useState(""),[j,U]=s.useState([]),[H,L]=s.useState(null),[l,se]=s.useState(null),[T,R]=s.useState([]),[B,g]=s.useState(!1),[V,m]=s.useState(null),[E,D]=s.useState(""),[C,W]=s.useState(""),[b,f]=s.useState(""),[K,F]=s.useState([]),[z,ce]=s.useState([]),[q,ye]=s.useState(null),[we,Se]=s.useState(""),[v,te]=s.useState(""),[ae,ne]=s.useState(""),[Q,ge]=s.useState([]),[N,G]=s.useState(!1),[me,oe]=s.useState({}),[le,Ce]=s.useState(""),[je,Ae]=s.useState("Pending"),Oe=Ss(),Me=u=>{const M=u.target.files?Array.from(u.target.files):[];if(M.length===0)return;if(j.length+M.length>jt){L({type:"error",message:`Cannot add ${M.length} file(s). Maximum ${jt} files allowed per request.`});try{u.target.value=""}catch{}return}const A=[],X=[];for(const ee of M){const xe=Yt(ee);xe.valid?A.push(ee):X.push(...xe.errors)}A.length>0&&U(ee=>[...ee,...A]),X.length>0&&L({type:"error",message:X.slice(0,3).join(" ")+(X.length>3?` (+${X.length-3} more errors)`:"")});try{u.target.value=""}catch{}},qe=async()=>{if(!q||!(l!=null&&l.id)||q.uploadedById!==l.id)return;const u={actor:`${l.rank} ${l.lastName}, ${l.firstName}${l.mi?` ${l.mi}`:""}`,timestamp:new Date().toISOString(),action:"Archived by Originator",comment:(ae||"").trim()},M={...q,currentStage:ze.ARCHIVED,finalStatus:"Archived",activity:Array.isArray(q.activity)?[...q.activity,u]:[u]};try{const A=await Te(M);if(!A.ok)throw new Error($(A,"request_upsert_failed"));ce(X=>X.map(ee=>ee.id===M.id?M:ee)),ye(M),L({type:"success",message:"Request archived."})}catch(A){L({type:"error",message:`Failed to archive: ${String((A==null?void 0:A.message)||A)}`})}},o=async()=>{if(!q||!(l!=null&&l.id)||q.uploadedById!==l.id)return;const u=T.find(ue=>ue.id===q.uploadedById),M=q.unitUic||(u==null?void 0:u.unitUic)||"",A=Je(u==null?void 0:u.company),X=Je(u==null?void 0:u.platoon),ee=rt(T,"PLATOON_REVIEWER",{company:A,platoon:X,uic:M}),xe=rt(T,"COMPANY_REVIEWER",{company:A,uic:M}),he=ee?ze.PLATOON_REVIEW:xe?ze.COMPANY_REVIEW:ze.BATTALION_REVIEW,pe={actor:`${l.rank} ${l.lastName}, ${l.firstName}${l.mi?` ${l.mi}`:""}`,actorRole:"Member",timestamp:new Date().toISOString(),action:"Resubmitted request",comment:(ae||"").trim()},Ie={...q,currentStage:he,routeSection:"",activity:[...q.activity||[],pe]};try{const ue=await Te(Ie);if(!ue.ok)throw new Error($(ue,"request_upsert_failed"));ce(De=>De.map($e=>$e.id===Ie.id?Ie:$e)),ye(Ie),ne(""),L({type:"success",message:"Request resubmitted for review."})}catch(ue){L({type:"error",message:`Failed to resubmit: ${String((ue==null?void 0:ue.message)||ue)}`})}},r=async u=>{u.preventDefault(),L(null);const M=w.trim();if(!M){L({type:"error",message:"Subject is required."});return}if(M.length>500){L({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(_.length>5e3){L({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(l!=null&&l.id)){L({type:"error",message:"Create a profile before submitting."});return}if(j.length>0){const ue=Jt(j);if(!ue.valid){L({type:"error",message:ue.errors[0]});return}}S(!0);const A=Date.now(),X=le||l.id,ee=T.find(ue=>ue.id===X),xe=t?t.uic:(ee==null?void 0:ee.unitUic)||"N/A",he=`req-${A}`;let pe=[];async function Ie(ue,De){if(!Re)throw new Error("Supabase not configured");const{error:$e}=await Re.storage.from(Ue).upload(De,ue,{upsert:!0});if($e)throw new Error($e.message);const{data:Be}=Re.storage.from(Ue).getPublicUrl(De);return(Be==null?void 0:Be.publicUrl)||""}if(j&&j.length>0){const ue=[];for(let De=0;De<j.length;De++){const $e=j[De],Be=`${xe}/${he}/${A}-${De}-${Dt($e.name)}`;try{const Ve=await Ie($e,Be);ue.push(Ve)}catch(Ve){S(!1),L({type:"error",message:`Failed to upload ${$e.name}: ${String((Ve==null?void 0:Ve.message)||Ve)}`});return}}pe=j.map((De,$e)=>({id:`${A}-${$e}`,name:De.name,type:De.type,size:De.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:xe,subject:w.trim(),dueDate:P||void 0,notes:_.trim()||void 0,uploadedById:X,currentStage:"PLATOON_REVIEW",fileUrl:ue[$e]}))}pe=pe.map(ue=>({...ue,requestId:he})),h(ue=>[...ue,...pe]),U([]),y(""),O(""),Z("");try{const ue=l?`${l.rank} ${l.lastName}, ${l.firstName}${l.mi?` ${l.mi}`:""}`:"Unknown",De="Member",$e=xe,Be=Je(ee==null?void 0:ee.company),Ve=Je(ee==null?void 0:ee.platoon),n=rt(T,"PLATOON_REVIEWER",{company:Be,platoon:Ve,uic:$e}),d=rt(T,"COMPANY_REVIEWER",{company:Be,uic:$e}),k={id:he,subject:w.trim(),dueDate:P||void 0,notes:_.trim()||void 0,unitUic:xe,uploadedById:X,submitForUserId:X,documentIds:pe.map(Y=>Y.id),createdAt:new Date().toISOString(),currentStage:n?ze.PLATOON_REVIEW:d?ze.COMPANY_REVIEW:ze.BATTALION_REVIEW,activity:[{actor:ue,actorRole:De,timestamp:new Date().toISOString(),action:"Submitted request",comment:(_||"").trim()}]};try{const Y=await Te(k);if(!Y.ok)throw new Error($(Y,"request_upsert_failed"));const be=await ut(pe);if(!be.ok)throw new Error($(be,"document_upsert_failed"))}catch(Y){S(!1);try{dt("request_persist_failed",{requestId:he,error:String((Y==null?void 0:Y.message)||Y)},"error")}catch{}L({type:"error",message:`Failed to persist submission: ${String((Y==null?void 0:Y.message)||Y)}`});return}ce(Y=>Y.some(fe=>fe.id===k.id)?Y.map(fe=>fe.id===k.id?k:fe):[...Y,k]),S(!1),L({type:"success",message:"Submission successful."}),g(!1)}catch{S(!1);try{dt("request_persist_failed",{requestId:he},"error")}catch{}L({type:"error",message:"Failed to persist submission."})}},p=s.useCallback(u=>{m(u),D(u.subject||""),W(u.dueDate||""),f(u.notes||"");try{const M=localStorage.getItem(`fs/requests/${u.requestId}.json`);if(M){const A=JSON.parse(M);F(Array.isArray(A.activity)?A.activity:[])}else{const ee=Object.values(Object.assign({})).map(xe=>(xe==null?void 0:xe.default)??xe).find(xe=>xe&&xe.id===u.requestId);F(ee&&Array.isArray(ee.activity)?ee.activity:[])}}catch{F([])}},[]),$=(u,M)=>{var A;return String(((A=u.error)==null?void 0:A.message)||u.error||M)},I=async()=>{if(!V)return;const u=i.map(M=>M.id===V.id?{...M,subject:E.trim()||M.subject,dueDate:C||void 0,notes:b.trim()||void 0}:M);h(u);try{const X={actor:l?`${l.rank} ${l.lastName}, ${l.firstName}${l.mi?` ${l.mi}`:""}`:"Unknown",actorRole:"Member",timestamp:new Date().toISOString(),action:"Updated document",comment:(b||"").trim()},ee=V.requestId?z.find(xe=>xe.id===V.requestId):null;if(ee){const xe={...ee,activity:Array.isArray(ee.activity)?[...ee.activity,X]:[X]};try{const he=await Te(xe);if(!he.ok)throw new Error($(he,"request_upsert_failed"))}catch(he){console.error("Failed to save document edits:",he),L({type:"error",message:`Failed to save document edits: ${he.message}`});return}F(he=>[...he,X])}}catch{}f(""),m(null)};i.filter(u=>!(!(l!=null&&l.id)||l.role==="MEMBER"&&u.uploadedById!==l.id||u.type==="request"));const re=u=>{var X;if(!u.activity||!u.activity.length)return!1;let M=-1,A=-1;for(let ee=0;ee<u.activity.length;ee++){const xe=String(((X=u.activity[ee])==null?void 0:X.action)||"").toLowerCase();/returned/i.test(xe)&&(M=ee),/resubmitted|submitted request/i.test(xe)&&(A=ee)}return M>A},Ne=()=>String((l==null?void 0:l.role)||"").includes("REVIEW"),Ee=()=>{if(!Ne())return[];const u=String((l==null?void 0:l.role)||"");return T.filter(M=>{if(M.id===(l==null?void 0:l.id))return!1;if(u.includes("PLATOON")){const A=M.company&&M.company!=="N/A"?M.company:"",X=M.unit&&M.unit!=="N/A"?M.unit:"",ee=l!=null&&l.company&&l.company!=="N/A"?l.company:"",xe=l!=null&&l.unit&&l.unit!=="N/A"?l.unit:"";return A===ee&&X===xe}if(u.includes("COMPANY")){const A=M.company&&M.company!=="N/A"?M.company:"",X=l!=null&&l.company&&l.company!=="N/A"?l.company:"";return A===X}return u.includes("COMMANDER")?(M.unitUic||"")===((l==null?void 0:l.unitUic)||""):!1})},de=s.useCallback(async u=>{const M=Oe.extractStoragePath(u.fileUrl);try{M&&Re&&await Re.storage.from(Ue).remove([M])}catch{}try{await ts(u.id),h(A=>A.filter(X=>X.id!==u.id)),u.requestId&&ce(A=>A.map(X=>X.id===u.requestId?{...X,documentIds:(X.documentIds||[]).filter(ee=>ee!==u.id)}:X)),L({type:"success",message:"Document deleted."})}catch(A){L({type:"error",message:`Failed to delete: ${String((A==null?void 0:A.message)||A)}`})}},[]),ke=s.useCallback(async u=>{const M=`${u.unitUic||"N-A"}/${u.id}/`;try{if(Re){const{data:A}=await Re.storage.from(Ue).list(M.slice(0,-1));if(A&&A.length>0){const X=A.map(ee=>`${M.slice(0,-1)}/${ee.name}`);await Re.storage.from(Ue).remove(X)}}}catch{}try{await ss(u.id),await as(u.id),h(A=>A.filter(X=>X.requestId!==u.id)),ce(A=>A.filter(X=>X.id!==u.id)),ye(null),L({type:"success",message:"Request and files deleted."})}catch(A){L({type:"error",message:`Failed to delete request: ${String((A==null?void 0:A.message)||A)}`})}},[]),_e=async()=>{if(!q||!(l!=null&&l.id)||q.uploadedById!==l.id){L({type:"error",message:"Only the requester can edit this."});return}const u=Date.now(),M=he=>he.replace(/[^A-Za-z0-9._-]/g,"-");async function A(he,pe){if(!Re)throw new Error("Supabase not configured");const{error:Ie}=await Re.storage.from(Ue).upload(pe,he,{upsert:!0});if(Ie)throw new Error(Ie.message);const{data:ue}=Re.storage.from(Ue).getPublicUrl(pe);return(ue==null?void 0:ue.publicUrl)||""}const X=[];for(let he=0;he<Q.length;he++){const pe=Q[he],Ie=`${q.unitUic||"N-A"}/${q.id}/${u}-${he}-${M(pe.name)}`;try{const ue=await A(pe,Ie);X.push(ue)}catch(ue){L({type:"error",message:`Failed to upload ${pe.name}: ${String((ue==null?void 0:ue.message)||ue)}`});return}}const ee=Q.map((he,pe)=>({id:`${u}-${pe}`,name:he.name,type:he.type,size:he.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:q.unitUic||"N/A",subject:we.trim()||q.subject,dueDate:v||void 0,notes:ae.trim()||void 0,uploadedById:l.id,currentStage:q.currentStage||"PLATOON_REVIEW",requestId:q.id,fileUrl:X[pe]})),xe={...q,subject:we.trim()||q.subject,dueDate:v||void 0,notes:ae.trim()||void 0,documentIds:[...q.documentIds||[],...ee.map(he=>he.id)],activity:[...q.activity||[],{actor:`${l.rank} ${l.lastName}, ${l.firstName}${l.mi?` ${l.mi}`:""}`,timestamp:new Date().toISOString(),action:ee.length?`Updated request and added ${ee.length} document(s)`:"Updated request",comment:(ae||"").trim()}]};try{if(!(l&&ds(q,String(l.id||"")))){L({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const pe=await ut(ee);if(!pe.ok)throw new Error($(pe,"document_upsert_failed"));const Ie=await Te(xe);if(!Ie.ok)throw new Error($(Ie,"request_upsert_failed"))}catch(pe){try{dt("request_update_failed",{requestId:xe.id,error:String((pe==null?void 0:pe.message)||pe)},"error")}catch{}L({type:"error",message:`Failed to persist documents: ${String((pe==null?void 0:pe.message)||pe)}`});return}h(pe=>[...pe,...ee]),ce(pe=>pe.map(Ie=>Ie.id===xe.id?xe:Ie)),ye(xe),ge([]),ne(""),L({type:"success",message:ee.length?"Files added and request updated.":"Request updated."})}catch{L({type:"error",message:"Failed to update request."})}},[He,Xe]=s.useState(!0),[Ge,Ze]=s.useState(!0);s.useEffect(()=>{ft().then(u=>{h(u)}).catch(()=>h([])).finally(()=>Xe(!1))},[]),s.useEffect(()=>{q&&(Se(q.subject||""),te(q.dueDate||""),ne(q.notes||""),ge([]))},[q]),s.useEffect(()=>{},[i]),s.useEffect(()=>{lt().then(u=>{ce(u)}).catch(()=>ce([])).finally(()=>Ze(!1))},[]),s.useEffect(()=>{se(a||null)},[a]),s.useEffect(()=>{Ke().then(u=>{R(u)}).catch(()=>R([]))},[]);const x=s.useMemo(()=>{if(!(l!=null&&l.id))return[];const u=z.filter(M=>M.uploadedById===l.id);return je==="Pending"?u.filter(M=>M.currentStage!=="ARCHIVED"):u.filter(M=>M.currentStage==="ARCHIVED")},[z,l,je]),J=gt(x,{pageSize:10}),ve=s.useMemo(()=>T.reduce((u,M)=>({...u,[M.id]:M}),{}),[T]),Pe=s.useCallback(u=>{const M=Je(u.currentStage||"PLATOON_REVIEW"),A=T.find(X=>X.id===u.uploadedById);switch(M){case"ORIGINATOR_REVIEW":return{level:"Member",scope:""};case"PLATOON_REVIEW":{const X=A!=null&&A.company&&A.company!=="N/A"?A.company:"",ee=A!=null&&A.platoon&&A.platoon!=="N/A"?A.platoon:"";return X&&ee?{level:"Platoon",scope:`(${X}-${ee})`}:X?{level:"Platoon",scope:`(${X})`}:{level:"Platoon",scope:""}}case"COMPANY_REVIEW":{const X=A!=null&&A.company&&A.company!=="N/A"?A.company:"";return{level:"Company",scope:X?`(${X})`:""}}case"BATTALION_REVIEW":return{level:"Battalion",scope:u.routeSection?`(${u.routeSection})`:""};case"COMMANDER_REVIEW":return{level:"Commander",scope:u.routeSection?`(${u.routeSection})`:""};case"ARCHIVED":return{level:"Archived",scope:""};default:return{level:Bt(u),scope:""}}},[T]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>g(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),B&&e.jsxs("form",{onSubmit:r,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:w,onChange:u=>y(u.target.value),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${w.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:P,onChange:u=>O(u.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),String((l==null?void 0:l.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:le,onChange:u=>Ce(u.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),Ee().map(u=>e.jsxs("option",{value:u.id,children:[u.rank," ",u.lastName,", ",u.firstName,u.mi?` ${u.mi}`:""]},u.id))]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:_,onChange:u=>Z(u.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:Me,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:j.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:j.map((u,M)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:u.name,children:u.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>U(A=>A.filter((X,ee)=>ee!==M)),children:"Delete"})]},M))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{g(!1),U([]),y(""),O(""),Z(""),L(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!w.trim(),children:"Submit"})]})]}),H&&e.jsx("div",{className:`p-3 rounded-lg border ${H.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:H.message})]})]}),e.jsxs("div",{className:"p-6",children:[l&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>Ae("Pending"),className:`${je==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>Ae("Archived"),className:`${je==="Archived"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Archived"})]})}),e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:J.totalItems>0?`${J.startIndex}–${J.endIndex} of ${J.totalItems}`:""}),Ge&&e.jsx("div",{className:"animate-pulse",children:"Loading requests…"})]}),e.jsx(Ye,{title:"Your Requests",requests:Ge?Array.from({length:5}).map((u,M)=>({id:`s-${M}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:ze.PLATOON_REVIEW})):J.currentData,users:ve,onRowClick:u=>ye(u),expandedRows:me,children:u=>e.jsxs("div",{id:`req-docs-${u.id}`,children:[He?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):i.filter(M=>M.requestId===u.id&&M.type!=="request").map(M=>e.jsx(kt,{doc:M,onView:p,onDelete:de},M.id)),!He&&i.filter(M=>M.requestId===u.id&&M.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),J.totalItems>0&&e.jsx(ht,{currentPage:J.currentPage,totalPages:J.totalPages,totalItems:J.totalItems,pageSize:J.pageSize,startIndex:J.startIndex,endIndex:J.endIndex,onPageChange:J.goToPage,onPageSizeChange:J.setPageSize,onNext:J.nextPage,onPrevious:J.previousPage,onFirst:J.goToFirstPage,onLast:J.goToLastPage,canGoNext:J.canGoNext,canGoPrevious:J.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),c&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),V&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>m(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:E,onChange:u=>D(u.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:C,onChange:u=>W(u.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:V.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:b,onChange:u=>f(u.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[V.name," • ",Ft(V.size)," • ",new Date(V.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:K.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):K.map((u,M)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[u.actor,u.actorRole?` • ${u.actorRole}`:""," • ",new Date(u.timestamp).toLocaleString()," • ",u.action]}),u.comment&&e.jsx("div",{className:"text-gray-600",children:u.comment})]},M))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>m(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:I,children:"Save"})]})]})}),q&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>ye(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:u=>u.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>ye(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:we,onChange:u=>Se(u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(q.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:v,onChange:u=>te(u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),q.currentStage&&(()=>{const{level:u,scope:M}=Pe(q);return e.jsxs("span",{className:"inline-flex flex-col items-center px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-lg border border-brand-navy/30 leading-tight",children:[e.jsx("span",{children:u}),M&&e.jsx("span",{className:"text-[10px]",children:M})]})})(),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:3,value:ae,onChange:u=>ne(u.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:q.activity&&q.activity.length?q.activity.map((u,M)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[u.actor,u.actorRole?` • ${u.actorRole}`:""," • ",new Date(u.timestamp).toLocaleString()," • ",u.action]}),u.comment&&e.jsx("div",{className:"text-gray-600",children:u.comment})]},M)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Documents"}),e.jsxs("button",{className:"mt-2 px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-expanded":N,"aria-controls":"docs-panel",onClick:()=>G(u=>!u),children:[N?"Hide":"Show"," Documents"]}),e.jsx("div",{id:"docs-panel",className:N?"mt-3 space-y-2":"hidden",children:i.filter(u=>u.requestId===q.id&&u.type!=="request").map(u=>e.jsx(kt,{doc:u,onView:p,onDelete:de},u.id))}),!wt(q,String((l==null?void 0:l.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:u=>{const M=u.target.files?Array.from(u.target.files):[];ge(A=>[...A,...M]);try{u.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:Q.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):Q.map((u,M)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:u.name,children:u.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>ge(A=>A.filter((X,ee)=>ee!==M)),children:"Delete"})]},M))})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>ye(null),children:"Close"}),wt(q,String((l==null?void 0:l.id)||""))?e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-gold text-brand-charcoal hover:brightness-110",onClick:qe,children:"Archive"}):e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:_e,disabled:!l||l.id!==((q==null?void 0:q.uploadedById)||""),children:"Save Changes"}),l&&re(q)&&l.id===q.uploadedById&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700",onClick:o,children:"Resubmit"}),l&&ls(q,String((l==null?void 0:l.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>ke(q),children:"Delete Request"})]})]})})]})},Cs=({currentUser:t,onClose:a})=>{const[i,h]=s.useState([]),[c,S]=s.useState(""),[w,y]=s.useState(!1),[P,O]=s.useState(""),[_,Z]=s.useState(!1),[j,U]=s.useState("");s.useEffect(()=>{yt().then(R=>{h(R.data||[])}).catch(()=>h([]))},[]);const H=s.useMemo(()=>String(t.role||"")!=="MEMBER",[t]),L=s.useMemo(()=>{const R=B=>{const g=t.unitUic||"",V=String(t.role||"");if(V.includes("PLATOON")){const m=B.company&&B.company!=="N/A"?B.company:"",E=B.platoon&&B.platoon!=="N/A"?B.platoon:"",D=t.company&&t.company!=="N/A"?t.company:"",C=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return m===D&&E===C}if(V.includes("COMPANY")){const m=B.company&&B.company!=="N/A"?B.company:"",E=t.company&&t.company!=="N/A"?t.company:"";return m===E}return V.includes("COMMANDER")?(B.unitUic||"")===g:!1};return i.filter(B=>B.id!==t.id&&R(B))},[i,t]),l=s.useMemo(()=>{const R=String(t.role||""),B=g=>{const V=t.unitUic||"";if(R.includes("PLATOON")){const m=g.company&&g.company!=="N/A"?g.company:"",E=g.platoon&&g.platoon!=="N/A"?g.platoon:"",D=t.company&&t.company!=="N/A"?t.company:"",C=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return m===D&&E===C}if(R.includes("COMPANY")){const m=g.company&&g.company!=="N/A"?g.company:"",E=t.company&&t.company!=="N/A"?t.company:"";return m===E}return R.includes("COMMANDER")?(g.unitUic||"")===V:!1};return i.filter(g=>g.id!==t.id&&B(g)&&String(g.role||"")===R)},[i,t]),se=async()=>{try{y(!0),O("");const R=i.find(m=>m.id===c);if(!H||!R){y(!1);return}const B=String(t.role||""),g={...R};if(g.role=B,B.includes("PLATOON")){g.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A";const m=t.platoon&&t.platoon!=="N/A"?t.platoon:"N/A";g.rolePlatoon=m}else B.includes("COMPANY")?(g.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A",g.rolePlatoon="N/A"):B.includes("COMMANDER")&&(g.roleCompany="N/A",g.rolePlatoon="N/A");try{if(!(await Qe({id:g.id,email:g.email,rank:g.rank,firstName:g.firstName,lastName:g.lastName,mi:g.mi,service:g.service,role:g.role,unitUic:g.unitUic,unit:g.unit,company:g.company,isUnitAdmin:!!g.isUnitAdmin,isCommandStaff:!!g.isCommandStaff,edipi:g.edipi,passwordHash:g.passwordHash,roleCompany:g.roleCompany,rolePlatoon:g.rolePlatoon})).ok)throw new Error("persist_failed")}catch{O("Failed to persist user changes")}const V={actorId:t.id,actorRole:t.role,targetId:g.id,grantedRole:g.role,timestamp:new Date().toISOString(),scope:{unitUic:t.unitUic||"",company:t.company,unit:t.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(V)})}catch{}h(m=>m.map(E=>E.id===g.id?g:E)),S(""),Z(!1),y(!1)}catch{y(!1),O("Operation failed")}},T=async R=>{try{y(!0),O("");const B=i.find(D=>D.id===R);if(!B){y(!1);return}const g=String(t.role||"");if(!l.some(D=>D.id===R)){y(!1),O("Target not in scope");return}const m={...B};m.role="MEMBER",m.company="N/A",m.unit="N/A",m.isCommandStaff=!1,m.roleCompany="N/A",m.rolePlatoon="N/A";try{if(!(await Qe({id:m.id,email:m.email,rank:m.rank,firstName:m.firstName,lastName:m.lastName,mi:m.mi,service:m.service,role:m.role,unitUic:m.unitUic,unit:m.unit,company:m.company,isUnitAdmin:!!m.isUnitAdmin,isCommandStaff:!!m.isCommandStaff,edipi:m.edipi,passwordHash:m.passwordHash,roleCompany:m.roleCompany,rolePlatoon:m.rolePlatoon})).ok)throw new Error("persist_failed")}catch{O("Failed to persist user changes")}const E={actorId:t.id,actorRole:t.role,targetId:m.id,action:"Revoked",previousRole:g,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(E)})}catch{}h(D=>D.map(C=>C.id===m.id?m:C)),U(""),y(!1)}catch{y(!1),O("Operation failed")}};return H?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:a,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:R=>R.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:a,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:c,onChange:R=>S(R.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),L.map(R=>e.jsxs("option",{value:R.id,children:[R.rank," ",R.lastName,", ",R.firstName,R.mi?` ${R.mi}`:""," • ",R.email]},R.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[l.map(R=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[R.rank," ",R.lastName,", ",R.firstName,R.mi?` ${R.mi}`:""," • ",R.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>U(R.id),children:"Remove Access"})]},R.id)),l.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),P&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:P})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!c||w,onClick:()=>Z(!0),children:"Grant Equivalent Permission"})}),_&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>Z(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:w,onClick:se,children:"Confirm"})]})]}),j&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>U(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:w,onClick:()=>T(j),children:"Remove"})]})]})]})}):null},It="ORIGINATOR_REVIEW",Fe=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],As=[{value:"PLATOON_REVIEW",label:"Platoon Review"},{value:"COMPANY_REVIEW",label:"Company Review"},{value:"BATTALION_REVIEW",label:"Battalion Review"},{value:"COMMANDER_REVIEW",label:"Commander Review"},{value:"ARCHIVED",label:"Archived"}],Es={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},ks=t=>{const a=Fe.indexOf(t||Fe[0]);return a>=0&&a<Fe.length-1?Fe[a+1]:Fe[a]||Fe[0]},Rt=t=>{const a=Fe.indexOf(t||Fe[0]);return a>0?Fe[a-1]:Fe[0]},ct=(t,a)=>{var i;return((i=t.activity)==null?void 0:i.some(h=>a.test(String(h.action||""))))||!1},Is=t=>ct(t,/(approved by commander|commander.*approved)/i)&&!ct(t,/installation commander/i),Rs=t=>ct(t,/(endorsed by commander|commander.*endorsed)/i)&&!ct(t,/installation commander/i),mt=t=>{if(!t)return"MEMBER";const a=String(t.role||"MEMBER"),i=(t.roleCompany||t.company||"").trim(),h=(t.rolePlatoon||t.platoon||"").trim();switch(a){case"PLATOON_REVIEWER":if(i&&h)return`Platoon (${i}-${h})`;break;case"COMPANY_REVIEWER":if(i)return`Company (${i})`;break;case"BATTALION_REVIEWER":return"Battalion";case"COMMANDER_REVIEWER":return"Commander"}return a};function Ms(){const t=Kt(),[a,i]=s.useState(()=>{try{const o=localStorage.getItem("currentUser");return o?JSON.parse(o):null}catch(o){return console.error("Failed to parse user from localStorage:",o),null}}),[h,c]=s.useState([]),[S,w]=s.useState([]),[y,P]=s.useState({}),[O,_]=s.useState({}),[Z,j]=s.useState({}),[U,H]=s.useState({}),[L,l]=s.useState({}),[se,T]=s.useState({}),[R,B]=s.useState({}),[g,V]=s.useState(!1),[m,E]=s.useState({}),[D,C]=s.useState({}),[W,b]=s.useState(!1),[f,K]=s.useState({}),[F,z]=s.useState(null),ce=s.useRef(null),[q,ye]=s.useState("Pending"),[we,Se]=s.useState(Es),[v,te]=s.useState(null);s.useEffect(()=>{const o=p=>{F&&ce.current&&!ce.current.contains(p.target)&&(K($=>({...$,[F]:!1})),z(null))},r=p=>{p.key==="Escape"&&F&&(K($=>({...$,[F]:!1})),z(null))};return document.addEventListener("mousedown",o),document.addEventListener("keydown",r),()=>{document.removeEventListener("mousedown",o),document.removeEventListener("keydown",r)}},[F]),s.useEffect(()=>{ns().then(o=>{c(o.data||[])}).catch(()=>c([]))},[]),s.useEffect(()=>{rs().then(o=>{w(o.data||[])}).catch(()=>w([]))},[]),s.useEffect(()=>{yt().then(o=>{const r={},p=o.data||[];for(const $ of p)$!=null&&$.id&&(r[$.id]=$);_(r)}).catch(()=>_({}))},[]),s.useEffect(()=>{try{const o=localStorage.getItem("unit_structure"),r={},p={};if(o){const $=JSON.parse(o);for(const I of Object.keys($||{})){const re=$[I];re&&Array.isArray(re._sections)&&(r[I]=re._sections),re&&re._platoonSectionMap&&typeof re._platoonSectionMap=="object"&&(p[I]=re._platoonSectionMap)}}else(async()=>{try{const $=await Nt();for(const I of Object.keys($||{})){const re=$[I];re&&Array.isArray(re._sections)&&(r[I]=re._sections),re&&re._platoonSectionMap&&typeof re._platoonSectionMap=="object"&&(p[I]=re._platoonSectionMap)}}catch{}})();T(r),B(p)}catch{}},[]);const ae=s.useMemo(()=>{const o=String((a==null?void 0:a.role)||"");return o.includes("PLATOON")?"PLATOON_REVIEW":o.includes("COMPANY")?"COMPANY_REVIEW":o.includes("BATTALION")?"BATTALION_REVIEW":o.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[a]),ne=o=>O[o.uploadedById]||null,Q=o=>o&&o!=="N/A"?o.trim():"",ge=o=>{var Ne,Ee;const r=ne(o),p=o.unitUic||(r==null?void 0:r.unitUic)||"",$=String((a==null?void 0:a.role)||""),I=(a==null?void 0:a.unitUic)||"",re=(Q(a==null?void 0:a.roleCompany)||Q(a==null?void 0:a.company)).toUpperCase();if($.includes("PLATOON")){if(!I||p!==I)return!1;const de=r?Q(r.company).toUpperCase():"",ke=r?Q(r.platoon).toUpperCase():"",_e=(Q(a==null?void 0:a.rolePlatoon)||Q(a==null?void 0:a.platoon)).toUpperCase();return!re||!_e||!de||!ke?!1:de===re&&ke===_e}if($.includes("COMPANY")){if(!I||p!==I)return!1;const de=r?Q(r.company).toUpperCase():"";return!re||!de?!1:de===re}if($.includes("BATTALION")){if(!I||p!==I)return!1;const de=Q(a==null?void 0:a.company),ke=Q(a==null?void 0:a.platoon),_e=((Ee=(Ne=R[I])==null?void 0:Ne[de])==null?void 0:Ee[ke])||"";return o.routeSection&&_e?o.routeSection===_e:!0}return $.includes("COMMANDER")?!!I&&p===I:!0},N=s.useMemo(()=>(Array.isArray(h)?h:[]).filter(ge),[h,a,O,R]),G=s.useMemo(()=>{const o=new Map;for(const r of N){const p=ne(r);if(p&&p.id&&!o.has(p.id)){const $=`${p.rank||""} ${p.lastName||""}, ${p.firstName||""}`.trim();o.set(p.id,{value:p.id,label:$||p.id})}}return Array.from(o.values()).sort((r,p)=>r.label.localeCompare(p.label))},[N,O]),me=ys(we,{items:N,getSearchText:o=>`${o.subject||""} ${o.id||""} ${o.routeSection||""}`,getStatus:o=>o.currentStage||"PLATOON_REVIEW",getDate:o=>o.createdAt,getOriginatorId:o=>o.uploadedById}),oe=s.useMemo(()=>me.filter(o=>(o.currentStage||"PLATOON_REVIEW")===ae),[me,ae]),le=s.useMemo(()=>me.filter(o=>(o.currentStage||"PLATOON_REVIEW")!==ae),[me,ae]),Ce=gt(oe,{pageSize:25}),je=gt(le,{pageSize:25}),Ae=o=>S.filter(r=>r.requestId===o),Oe=s.useMemo(()=>[{header:"Request ID",getValue:o=>o.id},{header:"Subject",getValue:o=>o.subject},{header:"Stage",getValue:o=>o.currentStage||""},{header:"Route Section",getValue:o=>o.routeSection||""},{header:"Originator",getValue:o=>{const r=ne(o);return r?`${r.rank||""} ${r.lastName||""}, ${r.firstName||""}${r.mi?` ${r.mi}`:""}`.trim():""}},{header:"Unit UIC",getValue:o=>o.unitUic||""},{header:"Created At",getValue:o=>o.createdAt,format:Et},{header:"Due Date",getValue:o=>o.dueDate||"",format:Et},{header:"Documents",getValue:o=>Ae(o.id).map(r=>r.name).join(" | ")}],[O,S]),Me=async(o,r,p)=>{const $=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",I=mt(a),re={actor:$,actorRole:I,timestamp:new Date().toISOString(),action:p,comment:(y[o.id]||"").trim()},Ne={...o,currentStage:r,routeSection:r==="BATTALION_REVIEW"&&L[o.id]?L[o.id]:o.routeSection,activity:Array.isArray(o.activity)?[...o.activity,re]:[re]};try{await Te(Ne),p.toLowerCase().includes("approved")?t.success("Request approved",{message:`"${o.subject}" advanced to next stage`}):p.toLowerCase().includes("return")?t.warning("Request returned",{message:`"${o.subject}" sent back for revision`}):p.toLowerCase().includes("archive")?t.info("Request archived",{message:`"${o.subject}" has been archived`}):t.success(p,{message:`Request "${o.subject}" updated`}),c(Ee=>Ee.map(de=>de.id===Ne.id?Ne:de)),P(Ee=>({...Ee,[o.id]:""}))}catch(Ee){t.error("Failed to update request",{message:String(Ee)})}},qe=async o=>{const r=U[o.id]||[];if(!r.length||!(a!=null&&a.id))return;const p=Date.now(),$=r.map((de,ke)=>({id:`${p}-${ke}`,name:de.name,type:de.type,size:de.size,uploadedAt:new Date().toISOString(),subject:o.subject,requestId:o.id,fileUrl:URL.createObjectURL(de)})),I=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",re=mt(a),Ne={actor:I,actorRole:re,timestamp:new Date().toISOString(),action:`Reviewer added ${$.length} document(s)`,comment:(y[o.id]||"").trim()},Ee={...o,documentIds:[...o.documentIds||[],...$.map(de=>de.id)],activity:Array.isArray(o.activity)?[...o.activity,Ne]:[Ne]};try{await ut($),await Te(Ee),t.success(`${$.length} file${$.length!==1?"s":""} added`,{message:`Documents added to "${o.subject}"`})}catch(de){t.error("Failed to add files",{message:String(de)})}w(de=>[...de,...$]),c(de=>de.map(ke=>ke.id===Ee.id?Ee:ke)),H(de=>({...de,[o.id]:[]})),P(de=>({...de,[o.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:mt(a)}),e.jsx(js,{items:[...oe,...le],columns:Oe,filename:"review_requests",label:"Export",className:"hidden md:inline-flex"})]})]}),a&&String(a.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>V(!0),children:"Manage Permissions"})})]}),e.jsx(fs,{filters:we,onFiltersChange:Se,statusOptions:As,originatorOptions:G,searchPlaceholder:"Search requests by subject, ID, or section...",className:"mb-4"}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>ye("Pending"),className:`${q==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>ye("In Scope"),className:`${q==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[q==="Pending"&&e.jsx(Ye,{title:"Pending",requests:Ce.currentData,users:O,onRowClick:o=>E(r=>({...r,[o.id]:!r[o.id]})),expandedRows:m,platoonSectionMap:R,children:o=>e.jsxs("div",{id:`details-rev-${o.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!f[o.id],"aria-controls":`docs-rev-${o.id}`,onClick:()=>{K(r=>({...r,[o.id]:!r[o.id]})),z(r=>f[o.id]?null:o.id)},onKeyDown:r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),K(p=>({...p,[o.id]:!p[o.id]})),z(p=>f[o.id]?null:o.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${f[o.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${o.id}`,ref:f[o.id]?ce:void 0,className:`${f[o.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:Ae(o.id).map(r=>({...r,fileUrl:r.fileUrl})),showIcons:!0,onPreview:r=>te(Ae(o.id).find(p=>p.id===r.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>j(r=>({...r,[o.id]:!r[o.id]})),"aria-expanded":!!Z[o.id],"aria-controls":`logs-${o.id}`,children:[Z[o.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${o.id}`,className:Z[o.id]?"mt-2 space-y-2":"hidden",children:o.activity&&o.activity.length?o.activity.map((r,p)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[r.actor,r.actorRole?` • ${r.actorRole}`:""," • ",new Date(r.timestamp).toLocaleString()," • ",r.action]}),r.comment&&e.jsx("div",{className:"text-gray-600",children:r.comment})]},p)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:y[o.id]||"",onChange:r=>P(p=>({...p,[o.id]:r.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:r=>H(p=>({...p,[o.id]:r.target.files?Array.from(r.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(U[o.id]||[]).length?`${(U[o.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>qe(o),disabled:!U[o.id]||!(U[o.id]||[]).length,children:"Save Files"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[String((a==null?void 0:a.role)||"").includes("COMPANY")&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:L[o.id]||"",onChange:r=>l(p=>({...p,[o.id]:r.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(se[(a==null?void 0:a.unitUic)||""]||[]).map(r=>e.jsx("option",{value:r,children:r},r))]})]}),(()=>{const r=Is(o),p=Rs(o);return r||p?e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Me(o,o.currentStage==="PLATOON_REVIEW"?It:Rt(o.currentStage),"Returned to previous stage"),children:"Return to Previous"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(String((a==null?void 0:a.role)||"").includes("COMPANY")){if(!L[o.id])return;Me(o,"BATTALION_REVIEW",`Approved and routed to ${L[o.id]}`)}else Me(o,ks(o.currentStage),"Approved")},disabled:String((a==null?void 0:a.role)||"").includes("COMPANY")&&!L[o.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Me(o,o.currentStage==="PLATOON_REVIEW"?It:Rt(o.currentStage),o.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),q==="In Scope"&&e.jsx(Ye,{title:"In Scope",requests:je.currentData,users:O,onRowClick:o=>E(r=>({...r,[o.id]:!r[o.id]})),expandedRows:m,platoonSectionMap:R,children:o=>e.jsxs("div",{id:`details-rev-${o.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!f[o.id],"aria-controls":`docs-rev-${o.id}`,onClick:()=>{K(r=>({...r,[o.id]:!r[o.id]})),z(r=>f[o.id]?null:o.id)},onKeyDown:r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),K(p=>({...p,[o.id]:!p[o.id]})),z(p=>f[o.id]?null:o.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${f[o.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${o.id}`,ref:f[o.id]?ce:void 0,className:`${f[o.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:Ae(o.id).map(r=>({...r,fileUrl:r.fileUrl})),showIcons:!0,onPreview:r=>te(Ae(o.id).find(p=>p.id===r.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>j(r=>({...r,[o.id]:!r[o.id]})),"aria-expanded":!!Z[o.id],"aria-controls":`logs-${o.id}`,children:[Z[o.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${o.id}`,className:Z[o.id]?"mt-2 space-y-2":"hidden",children:o.activity&&o.activity.length?o.activity.map((r,p)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[r.actor,r.actorRole?` • ${r.actorRole}`:""," • ",new Date(r.timestamp).toLocaleString()," • ",r.action]}),r.comment&&e.jsx("div",{className:"text-gray-600",children:r.comment})]},p)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),g&&a&&e.jsx(Cs,{currentUser:a,onClose:()=>V(!1)}),v&&v.fileUrl&&e.jsx(Vt,{url:v.fileUrl,fileName:v.name,mimeType:v.type,fileSize:v.size,isOpen:!!v,onClose:()=>te(null)})]})}const Wt="MM",Ht="Manpower Management",zt="MMEA",Qt="Enlisted Personnel Assignments (General oversight)",Ps={division_code:Wt,division_name:Ht,branch:zt,description:Qt},Os=Object.freeze(Object.defineProperty({__proto__:null,branch:zt,default:Ps,description:Qt,division_code:Wt,division_name:Ht},Symbol.toStringTag,{value:"Module"}));async function Ds(){try{const t=Object.assign({"../hqmc-structure/MM__manpower-management__mmea.json":Os}),a=[];for(const i of Object.values(t)){const h=(i==null?void 0:i.default)??i;if(h&&typeof h=="object"){const c=String(h.division_code||""),S=String(h.division_name||""),w=String(h.branch||""),y=h.description?String(h.description):void 0;c&&w&&a.push({division_code:c,division_name:S,branch:w,description:y})}}return a}catch{return[]}}function $s(){var D;const[t,a]=s.useState(null),[i,h]=s.useState([]),[c,S]=s.useState([]),[w,y]=s.useState(""),[P,O]=s.useState(""),[_,Z]=s.useState([]),[j,U]=s.useState(null),[H,L]=s.useState("structure"),[l,se]=s.useState({}),[T,R]=s.useState({}),[B,g]=s.useState({});s.useEffect(()=>{try{const C=localStorage.getItem("currentUser");C&&a(JSON.parse(C))}catch{}$t().then(C=>{try{h(C.map(W=>({code:String(W.code||""),name:String(W.name||"")})))}catch{h([])}}),Ds().then(C=>{S(C)}),Ke().then(C=>Z(C)).catch(()=>Z([])),vt().then(C=>{const W={};for(const b of C){const f=`${b.division_code}::${b.branch}`;W[f]={reviewers:b.reviewers||[],approvers:b.approvers||[]}}se(W)})},[]);const V=(t==null?void 0:t.hqmcDivision)||((D=i[0])==null?void 0:D.code)||"",m=s.useMemo(()=>i.find(C=>C.code===V),[i,V]),E=s.useMemo(()=>(Array.isArray(c)?c:[]).filter(C=>String(C.division_code||"")===V),[c,V]);return s.useMemo(()=>(Array.isArray(_)?_:[]).filter(C=>!!C.isHqmcAdmin&&String(C.hqmcDivision||"")===V),[_,V]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(t!=null&&t.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",m?`${m.code} — ${m.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>L("structure"),className:`${H==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>L("permissions"),className:`${H==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),H==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"})]})}),e.jsxs("tbody",{children:[E.map(C=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:C.branch}),e.jsx("td",{className:"py-2 px-3",children:C.description||""})]},C.branch)),E.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:w,onChange:C=>y(C.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:P,onChange:C=>O(C.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!w.trim(),onClick:async()=>{var C;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:V,division_name:((C=i.find(b=>b.code===V))==null?void 0:C.name)||"",branch:w.trim(),description:P.trim()})});const W=await fetch("/api/hqmc-structure").then(b=>b.json());S(W),y(""),O("")}catch{}},children:"Add"})]})]})]}),H==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const C of E){const W=`${V}::${C.branch}`,b=l[W]||{reviewers:[],approvers:[]};await _t({division_code:V,branch:C.branch,reviewers:b.reviewers,approvers:b.approvers})}U({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:E.map(C=>{const W=`${V}::${C.branch}`,b=l[W]||{reviewers:[],approvers:[]},f=K=>`${K.rank||""} ${K.lastName||""}, ${K.firstName||""}${K.mi?" "+K.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:C.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:T[W]||"",onChange:K=>R(F=>({...F,[W]:K.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!T[W],onClick:async()=>{const K=(T[W]||"").trim();if(!K)return;const{user:F}=await pt(K);if(!(F!=null&&F.id)){U({type:"error",message:`No user found for EDIPI ${K}`});return}se(z=>({...z,[W]:{...b,reviewers:Array.from(new Set([...b.reviewers||[],F.id]))}})),R(z=>({...z,[W]:""})),U({type:"success",message:`Added reviewer ${F.lastName||""}, ${F.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(b.reviewers||[]).map(K=>{const F=_.find(z=>z.id===K);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:F?f(F):K}),e.jsx("button",{className:"text-red-600",onClick:()=>se(z=>({...z,[W]:{...b,reviewers:(b.reviewers||[]).filter(ce=>ce!==K)}})),children:"✕"})]},K)}),(b.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:B[W]||"",onChange:K=>g(F=>({...F,[W]:K.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!B[W],onClick:async()=>{const K=(B[W]||"").trim();if(!K)return;const{user:F}=await pt(K);if(!(F!=null&&F.id)){U({type:"error",message:`No user found for EDIPI ${K}`});return}se(z=>({...z,[W]:{...b,approvers:Array.from(new Set([...b.approvers||[],F.id]))}})),g(z=>({...z,[W]:""})),U({type:"success",message:`Added approver ${F.lastName||""}, ${F.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(b.approvers||[]).map(K=>{const F=_.find(z=>z.id===K);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:F?f(F):K}),e.jsx("button",{className:"text-red-600",onClick:()=>se(z=>({...z,[W]:{...b,approvers:(b.approvers||[]).filter(ce=>ce!==K)}})),children:"✕"})]},K)}),(b.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},W)})})]})})]}),j&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${j.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:j.message})]})}const nt=(t,a)=>`${t}::${a}`;function _s({currentUser:t,divisionCode:a,branches:i,assignments:h,onClose:c}){const[S,w]=s.useState([]),[y,P]=s.useState(""),[O,_]=s.useState(""),[Z,j]=s.useState("reviewer"),[U,H]=s.useState(!1);s.useEffect(()=>{yt().then(m=>w(m)).catch(()=>w([]))},[]);const L=s.useMemo(()=>{const m={};for(const E of h)m[nt(E.division_code,E.branch)]={reviewers:E.reviewers||[],approvers:E.approvers||[]};return m},[h]),l=String(t.id||""),se=s.useMemo(()=>{if(!y)return!1;const m=L[nt(a,y)]||{reviewers:[],approvers:[]};return(m.reviewers||[]).includes(l)||(m.approvers||[]).includes(l)||!!t.isHqmcAdmin},[y,L,l,t]),T=s.useMemo(()=>S.filter(m=>String(m.hqmcDivision||"")===String(a||"")&&String(m.id||"")!==l),[S,a,l]),R=s.useMemo(()=>{if(!y)return[];const m=L[nt(a,y)]||{reviewers:[],approvers:[]};return Array.from(new Set([...m.reviewers||[],...m.approvers||[]])).map(D=>T.find(C=>C.id===D)).filter(Boolean)},[y,L,T,a]),B=async m=>{H(!0);try{await _t({division_code:a,branch:y,reviewers:m.reviewers,approvers:m.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:t.id,scope:{hqmcDivision:a,branch:y},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{H(!1)}},g=async()=>{if(!se||!y||!O)return;const m=L[nt(a,y)]||{reviewers:[],approvers:[]},E={reviewers:Array.from(new Set(m.reviewers||[])),approvers:Array.from(new Set(m.approvers||[]))};Z==="reviewer"?E.reviewers=Array.from(new Set([...E.reviewers,O])):E.approvers=Array.from(new Set([...E.approvers,O])),await B(E),_("")},V=async m=>{if(!se||!y)return;const E=L[nt(a,y)]||{reviewers:[],approvers:[]},D={reviewers:(E.reviewers||[]).filter(C=>C!==m),approvers:(E.approvers||[]).filter(C=>C!==m)};await B(D)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:c,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:c,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:y,onChange:m=>P(m.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),i.map(m=>e.jsx("option",{value:m,children:m},m))]})]}),y&&!se&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),y&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:O,onChange:m=>_(m.target.value),disabled:!se,children:[e.jsx("option",{value:"",children:"Choose user"}),T.map(m=>e.jsxs("option",{value:m.id,children:[m.rank," ",m.lastName,", ",m.firstName,m.mi?` ${m.mi}`:""," • ",m.email]},m.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:Z,onChange:m=>j(m.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!se||!O||U,onClick:g,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[R.map(m=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[m.rank," ",m.lastName,", ",m.firstName,m.mi?` ${m.mi}`:""," • ",m.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!se||U,onClick:()=>V(m.id),children:"Remove"})]},m.id)),R.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}const it=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Ls=t=>{const a=it.indexOf(t||it[0]);return a>0?it[a-1]:it[0]};function qs(){const[t,a]=s.useState(()=>{try{const N=localStorage.getItem("currentUser");return N?JSON.parse(N):null}catch{return null}}),[i,h]=s.useState([]),[c,S]=s.useState([]),[w,y]=s.useState({}),[P,O]=s.useState({}),[_,Z]=s.useState({}),[j,U]=s.useState({}),[H,L]=s.useState(null),l=s.useRef(null),[se,T]=s.useState([]),[R,B]=s.useState("Pending"),[g,V]=s.useState([]),[m,E]=s.useState({}),[D,C]=s.useState(!1);s.useEffect(()=>{const N=me=>{H&&l.current&&!l.current.contains(me.target)&&(U(oe=>({...oe,[H]:!1})),L(null))},G=me=>{me.key==="Escape"&&H&&(U(oe=>({...oe,[H]:!1})),L(null))};return document.addEventListener("mousedown",N),document.addEventListener("keydown",G),()=>{document.removeEventListener("mousedown",N),document.removeEventListener("keydown",G)}},[H]),s.useEffect(()=>{lt().then(N=>h(N)).catch(()=>h([]))},[]),s.useEffect(()=>{ft().then(N=>S(N)).catch(()=>S([]))},[]),s.useEffect(()=>{Ke().then(N=>{const G={};for(const me of N)me!=null&&me.id&&(G[me.id]=me);O(G)}).catch(()=>O({}))},[]),s.useEffect(()=>{vt().then(T).catch(()=>T([]))},[]),s.useEffect(()=>{is().then(V).catch(()=>V([]))},[]);const W=(t==null?void 0:t.id)||"",b=String((t==null?void 0:t.hqmcDivision)||""),f=s.useMemo(()=>se.filter(N=>N.division_code===b&&((N.reviewers||[]).includes(W)||(N.approvers||[]).includes(W))).map(N=>N.branch),[se,b,W]),K=N=>P[N.uploadedById]||null,F=N=>{if(!b||!W)return!1;const G=String(N.routeSection||"");return f.includes(G)},z=s.useMemo(()=>(Array.isArray(i)?i:[]).filter(F),[i,f]),ce=s.useMemo(()=>z.filter(N=>(N.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[z]),q=s.useMemo(()=>z.filter(N=>(N.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[z]),ye=N=>c.filter(G=>G.requestId===N),we=N=>`"${String(N??"").replace(/"/g,'""')}"`,Se=N=>{const me=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const oe of N){const le=K(oe),Ce=le?`${le.rank} ${le.lastName}, ${le.firstName}${le.mi?` ${le.mi}`:""}`:"",je=ye(oe.id).map(Ae=>Ae.name).join(" | ");me.push([oe.id,oe.subject,oe.currentStage||"",oe.routeSection||"",Ce,oe.unitUic||"",new Date(oe.createdAt).toLocaleString(),je])}return me.map(oe=>oe.map(we).join(",")).join(`\r
`)},v=(N,G)=>{const me=new Blob([G],{type:"text/csv;charset=utf-8;"}),oe=URL.createObjectURL(me),le=document.createElement("a");le.href=oe,le.download=N,document.body.appendChild(le),le.click(),document.body.removeChild(le),URL.revokeObjectURL(oe)},te=()=>v("hqmc_pending.csv",Se(ce)),ae=()=>v("hqmc_in_scope.csv",Se(q)),ne=()=>v("hqmc_all.csv",Se([...ce,...q])),Q=async N=>{const G=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",me=String(m[N.id]||"").trim();if(!me){alert("Select an HQMC section to route to approver");return}const oe={actor:G,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${me}`,comment:(w[N.id]||"").trim()},le={...N,routeSection:me,activity:Array.isArray(N.activity)?[...N.activity,oe]:[oe]};try{await Te(le)}catch{}h(Ce=>Ce.map(je=>je.id===le.id?le:je)),y(Ce=>({...Ce,[N.id]:""}))},ge=async N=>{const me={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC",comment:(w[N.id]||"").trim()},oe={...N,currentStage:Ls(N.currentStage),activity:Array.isArray(N.activity)?[...N.activity,me]:[me]};try{await Te(oe)}catch{}h(le=>le.map(Ce=>Ce.id===oe.id?oe:Ce)),y(le=>({...le,[N.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:b||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ne,children:"Export All"}),f.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>C(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>B("Pending"),className:`${R==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>B("In Scope"),className:`${R==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[R==="Pending"&&e.jsx(Ye,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:te,children:"Export Pending"}),requests:ce,users:P,onRowClick:N=>Z(G=>({...G,[N.id]:!G[N.id]})),expandedRows:_,children:N=>e.jsxs("div",{id:`details-hq-${N.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[N.id],"aria-controls":`docs-hq-${N.id}`,onClick:()=>{U(G=>({...G,[N.id]:!G[N.id]})),L(G=>j[N.id]?null:N.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[N.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${N.id}`,ref:j[N.id]?l:void 0,className:`${j[N.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:ye(N.id).map(G=>({...G,fileUrl:G.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:w[N.id]||"",onChange:G=>y(me=>({...me,[N.id]:G.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:m[N.id]||"",onChange:G=>E(me=>({...me,[N.id]:G.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),g.filter(G=>String(G.division_code||"")===b).map(G=>e.jsx("option",{value:G.branch,children:G.branch},G.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Q(N),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>ge(N),children:"Return"})]})]})]})}),R==="In Scope"&&e.jsx(Ye,{title:"In Scope",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ae,children:"Export In Scope"}),requests:q,users:P,onRowClick:N=>Z(G=>({...G,[N.id]:!G[N.id]})),expandedRows:_,children:N=>e.jsxs("div",{id:`details-hq-${N.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[N.id],"aria-controls":`docs-hq-${N.id}`,onClick:()=>{U(G=>({...G,[N.id]:!G[N.id]})),L(G=>j[N.id]?null:N.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[N.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${N.id}`,ref:j[N.id]?l:void 0,className:`${j[N.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:ye(N.id).map(G=>({...G,fileUrl:G.fileUrl}))})})]})})]})]}),D&&t&&e.jsx(_s,{currentUser:t,divisionCode:b,branches:g.filter(N=>String(N.division_code||"")===b).map(N=>N.branch),assignments:se,onClose:()=>C(!1)})]})}const ot=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Ts=t=>{const a=ot.indexOf(t||ot[0]);return a>0?ot[a-1]:ot[0]};function Bs(){const[t,a]=s.useState(()=>{try{const v=localStorage.getItem("currentUser");return v?JSON.parse(v):null}catch{return null}}),[i,h]=s.useState([]),[c,S]=s.useState([]),[w,y]=s.useState({}),[P,O]=s.useState({}),[_,Z]=s.useState({}),[j,U]=s.useState({}),[H,L]=s.useState(null),l=s.useRef(null),[se,T]=s.useState([]),[R,B]=s.useState("Pending");s.useEffect(()=>{const v=ae=>{H&&l.current&&!l.current.contains(ae.target)&&(U(ne=>({...ne,[H]:!1})),L(null))},te=ae=>{ae.key==="Escape"&&H&&(U(ne=>({...ne,[H]:!1})),L(null))};return document.addEventListener("mousedown",v),document.addEventListener("keydown",te),()=>{document.removeEventListener("mousedown",v),document.removeEventListener("keydown",te)}},[H]),s.useEffect(()=>{lt().then(v=>h(v)).catch(()=>h([]))},[]),s.useEffect(()=>{ft().then(v=>S(v)).catch(()=>S([]))},[]),s.useEffect(()=>{Ke().then(v=>{const te={};for(const ae of v)ae!=null&&ae.id&&(te[ae.id]=ae);O(te)}).catch(()=>O({}))},[]),s.useEffect(()=>{vt().then(T).catch(()=>T([]))},[]);const g=(t==null?void 0:t.id)||"",V=String((t==null?void 0:t.hqmcDivision)||""),m=s.useMemo(()=>se.filter(v=>v.division_code===V&&(v.approvers||[]).includes(g)).map(v=>v.branch),[se,V,g]),E=v=>P[v.uploadedById]||null,D=v=>{if(!V||!g)return!1;const te=String(v.routeSection||"");return m.includes(te)},C=s.useMemo(()=>(Array.isArray(i)?i:[]).filter(D),[i,m]),W=s.useMemo(()=>C.filter(v=>(v.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[C]),b=s.useMemo(()=>C.filter(v=>(v.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[C]),f=v=>c.filter(te=>te.requestId===v),K=v=>`"${String(v??"").replace(/"/g,'""')}"`,F=v=>{const ae=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const ne of v){const Q=E(ne),ge=Q?`${Q.rank} ${Q.lastName}, ${Q.firstName}${Q.mi?` ${Q.mi}`:""}`:"",N=f(ne.id).map(G=>G.name).join(" | ");ae.push([ne.id,ne.subject,ne.currentStage||"",ne.routeSection||"",ge,ne.unitUic||"",new Date(ne.createdAt).toLocaleString(),N])}return ae.map(ne=>ne.map(K).join(",")).join(`\r
`)},z=(v,te)=>{const ae=new Blob([te],{type:"text/csv;charset=utf-8;"}),ne=URL.createObjectURL(ae),Q=document.createElement("a");Q.href=ne,Q.download=v,document.body.appendChild(Q),Q.click(),document.body.removeChild(Q),URL.revokeObjectURL(ne)},ce=()=>z("hqmc_approver_pending.csv",F(W)),q=()=>z("hqmc_approver_approved.csv",F(b)),ye=()=>z("hqmc_approver_all.csv",F([...W,...b])),we=async v=>{const ae={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved",comment:(w[v.id]||"").trim()},ne={...v,currentStage:"ARCHIVED",activity:Array.isArray(v.activity)?[...v.activity,ae]:[ae]};try{await Te(ne)}catch{}h(Q=>Q.map(ge=>ge.id===ne.id?ne:ge)),y(Q=>({...Q,[v.id]:""}))},Se=async v=>{const ae={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver",comment:(w[v.id]||"").trim()},ne={...v,currentStage:Ts(v.currentStage),activity:Array.isArray(v.activity)?[...v.activity,ae]:[ae]};try{await Te(ne)}catch{}h(Q=>Q.map(ge=>ge.id===ne.id?ne:ge)),y(Q=>({...Q,[v.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((t==null?void 0:t.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ye,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>B("Pending"),className:`${R==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>B("Approved"),className:`${R==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"})]})}),e.jsxs("div",{className:"mt-4",children:[R==="Pending"&&e.jsx(Ye,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ce,children:"Export Pending"}),requests:W,users:P,onRowClick:v=>Z(te=>({...te,[v.id]:!te[v.id]})),expandedRows:_,children:v=>e.jsxs("div",{id:`details-hqa-${v.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[v.id],"aria-controls":`docs-hqa-${v.id}`,onClick:()=>{U(te=>({...te,[v.id]:!te[v.id]})),L(te=>j[v.id]?null:v.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[v.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${v.id}`,ref:j[v.id]?l:void 0,className:`${j[v.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:f(v.id).map(te=>({...te,fileUrl:te.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:w[v.id]||"",onChange:te=>y(ae=>({...ae,[v.id]:te.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>we(v),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>Se(v),children:"Return"})]})]})}),R==="Approved"&&e.jsx(Ye,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:q,children:"Export Approved"}),requests:b,users:P,onRowClick:v=>Z(te=>({...te,[v.id]:!te[v.id]})),expandedRows:_,children:v=>e.jsxs("div",{id:`details-hqa-${v.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[v.id],"aria-controls":`docs-hqa-${v.id}`,onClick:()=>{U(te=>({...te,[v.id]:!te[v.id]})),L(te=>j[v.id]?null:v.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[v.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${v.id}`,ref:j[v.id]?l:void 0,className:`${j[v.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(tt,{documents:f(v.id).map(te=>({...te,fileUrl:te.fileUrl}))})})]})})]})]})})}const Vs=({onUnitSelect:t,selectedUnit:a})=>{const[i,h]=s.useState(""),[c,S]=s.useState(!1),w=We.filter(P=>P.unitName.toLowerCase().startsWith(i.toLowerCase())||P.uic.toLowerCase().startsWith(i.toLowerCase())||P.ruc.toLowerCase().startsWith(i.toLowerCase())),y=P=>{t(P),S(!1),h("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>S(!c),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[a?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",a.uic," | RUC: ",a.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),c&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:i,onChange:P=>h(P.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:w.map(P=>e.jsxs("button",{type:"button",onClick:()=>y(P),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:P.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",P.uic," | RUC: ",P.ruc," | MCC: ",P.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[P.streetAddress,", ",P.cityState," ",P.zip]})]},P.uic))})]})]})]})},bt=async t=>{const i=new TextEncoder().encode(t),h=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(h)).map(c=>c.toString(16).padStart(2,"0")).join("")};async function Fs(t,a){const i=os();return i!=null&&i.auth?await i.auth.signUp({email:t,password:a}):{data:null,error:new Error("supabase_not_initialized")}}const Mt={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},Ws=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Gt=({onSaved:t,initial:a={},mode:i="create",readOnly:h=!1,canEditRole:c=!1,canEditAdmin:S=!1})=>{const[w,y]=s.useState(""),[P,O]=s.useState(""),[_,Z]=s.useState(""),[j,U]=s.useState(a.email||""),[H,L]=s.useState(a.edipi||""),[l,se]=s.useState(a.service||""),[T,R]=s.useState(a.rank||""),[B,g]=s.useState(a.role||"MEMBER"),[V,m]=s.useState(!!a.isUnitAdmin),[E,D]=s.useState(a.company||""),[C,W]=s.useState(a.platoon||""),[b,f]=s.useState(void 0),[K,F]=s.useState(null),[z,ce]=s.useState({}),[q,ye]=s.useState(""),[we,Se]=s.useState(""),[v,te]=s.useState([]),[ae,ne]=s.useState(!1),[Q,ge]=s.useState(a.roleCompany||""),[N,G]=s.useState(a.rolePlatoon||""),[me,oe]=s.useState(!1),[le,Ce]=s.useState([]),[je,Ae]=s.useState([]),[Oe,Me]=s.useState([]),[qe,o]=s.useState([]);s.useEffect(()=>{if(a.firstName&&y(String(a.firstName)),a.lastName&&O(String(a.lastName)),a.mi&&Z(String(a.mi)),a.company&&D(String(a.company)),a.platoon&&W(String(a.platoon)),a.roleCompany&&ge(String(a.roleCompany)),a.rolePlatoon&&G(String(a.rolePlatoon)),a.unitUic){const x=We.find(J=>J.uic===a.unitUic);x&&f(x)}},[a]);const r=s.useMemo(()=>Mt[l]||[],[l]),p=s.useMemo(()=>{if(!b)return[];const x=le;if(x&&x.length)return x;const J=z[b.uic]||{};return Object.keys(J).filter(ve=>!ve.startsWith("_")&&Array.isArray(J[ve]))},[b,z,le]),$=s.useMemo(()=>{var x;return b&&E?((x=z[b.uic])==null?void 0:x[E])||[]:[]},[b,E,z]),I=s.useMemo(()=>{if(!b||!E)return[];const x=je;return x&&x.length?x:$},[b,E,je,$]),re=s.useMemo(()=>{if(!b)return[];const x=Oe;if(x&&x.length)return x;const J=z[b.uic]||{};return Object.keys(J).filter(ve=>!ve.startsWith("_")&&Array.isArray(J[ve]))},[b,z,Oe]),Ne=s.useMemo(()=>{var x;return b&&Q?((x=z[b.uic])==null?void 0:x[Q])||[]:[]},[b,Q,z]),Ee=s.useMemo(()=>{if(!b||!Q)return[];const x=qe;return x&&x.length?x:Ne},[b,Q,qe,Ne]),de=s.useMemo(()=>{const x=p.slice(),J=E||a.company||a.user_company||"";return J&&!x.includes(J)?[J,...x]:x},[p,E,a]),ke=s.useMemo(()=>{const x=I.slice(),J=C||a.platoon||a.user_platoon||"";return J&&!x.includes(J)?[J,...x]:x},[I,C,a]),_e=s.useMemo(()=>{const x=re.slice(),J=Q||a.roleCompany||"",ve=J&&!x.includes(J)?[J,...x]:x;return Array.from(new Set(ve))},[re,Q,a]),He=s.useMemo(()=>{const x=Ee.slice(),J=N||a.rolePlatoon||"";return J&&!x.includes(J)?[J,...x]:x},[Ee,N,a]);s.useEffect(()=>{(async()=>{try{if(i==="edit"&&a.id){const x=await Lt(String(a.id));x&&(x.company&&!E&&D(String(x.company)),x.platoon&&!C&&W(String(x.platoon)),x.roleCompany&&!Q&&ge(String(x.roleCompany)),x.rolePlatoon&&!N&&G(String(x.rolePlatoon)))}}catch{}})()},[i,a.id]),s.useEffect(()=>{r.includes(T)||R("")},[r]),s.useEffect(()=>{W("")},[E]),s.useEffect(()=>{G("")},[Q]),s.useEffect(()=>{try{const x=localStorage.getItem("unit_structure");x&&ce(JSON.parse(x))}catch{}},[b]),s.useEffect(()=>{const x=(b==null?void 0:b.uic)||"";if(!x){Ce([]),Me([]);return}qt(x).then(J=>{Ce(J||[]),Me(J||[])}).catch(()=>{Ce([]),Me([])})},[b]),s.useEffect(()=>{const x=(b==null?void 0:b.uic)||"",J=E||"";if(!x||!J){Ae([]);return}xt(x,J).then(ve=>Ae(ve||[])).catch(()=>Ae([]))},[b,E]),s.useEffect(()=>{const x=(b==null?void 0:b.uic)||"",J=Q||"";if(!x||!J){o([]);return}xt(x,J).then(ve=>o(ve||[])).catch(()=>o([]))},[b,Q]),s.useEffect(()=>{Ke().then(x=>{te(x)}).catch(()=>te([]))},[]),s.useEffect(()=>{const x=(b==null?void 0:b.uic)||"";if(!x){ne(!1);return}const J=v.some(ve=>!!ve.isUnitAdmin&&(ve.unitUic||"")===x);ne(J)},[b,v]),s.useEffect(()=>{if(b){!E&&a.company&&de.includes(a.company)&&D(String(a.company));const x=a.platoon;!C&&x&&ke.includes(x)&&W(String(x))}},[b,de,ke,E,C,a]);const Xe=x=>/^[0-9]{10}$/.test(x),Ge=(x,J)=>{try{return v.some(ve=>String(ve.edipi)===String(x)&&String(ve.id)!==String(J||""))}catch{return!1}},Ze=async x=>{var u,M;if(x.preventDefault(),F(null),h)return;if(!w.trim())return F({type:"error",message:"First name is required."});if(!P.trim())return F({type:"error",message:"Last name is required."});if(_&&!/^[A-Za-z]$/.test(_))return F({type:"error",message:"MI must be a single letter."});if(!j.trim())return F({type:"error",message:"Email is required."});if(!Xe(String(H)))return F({type:"error",message:"EDIPI must be 10 digits."});if(!l)return F({type:"error",message:"Service is required."});if(!T)return F({type:"error",message:"Rank is required."});if(Ge(String(H),a.id?String(a.id):void 0))return F({type:"error",message:"EDIPI already exists."});if(B==="COMPANY_REVIEWER"&&!Q)return F({type:"error",message:"Role Company is required for Company Reviewer."});if(B==="PLATOON_REVIEWER"&&(!Q||!N))return F({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${w.trim()}`,_&&""+_.trim().toUpperCase(),`${P.trim()}`;let J=a.id?String(a.id):`usr-${Date.now()}`,ve=a.passwordHash||"";if(i==="create"){if(!q||q.length<8)return F({type:"error",message:"Password must be at least 8 characters."});if(q!==we)return F({type:"error",message:"Passwords do not match."});try{const{data:A,error:X}=await Fs(j.trim(),q);if(X){F({type:"error",message:`Failed to create auth user: ${String(X.message||X)}`});return}const ee=(u=A==null?void 0:A.user)!=null&&u.id?String(A.user.id):"";if(!ee){F({type:"error",message:"Auth user ID missing after sign up."});return}J=ee}catch(A){F({type:"error",message:`Failed to create auth user: ${String((A==null?void 0:A.message)||A)}`});return}ve=await bt(q)}else if(i==="edit"&&q){if(q.length<8)return F({type:"error",message:"Password must be at least 8 characters."});if(q!==we)return F({type:"error",message:"Passwords do not match."});ve=await bt(q)}const Pe={id:J,firstName:w.trim(),lastName:P.trim(),mi:_?_.trim().toUpperCase():void 0,email:j.trim(),edipi:H,service:l,rank:T,role:B,company:E||"N/A",unit:(b==null?void 0:b.unitName)||"N/A",unitUic:b==null?void 0:b.uic,passwordHash:ve,isUnitAdmin:i==="create"&&b&&!ae?!0:V,roleCompany:Q||void 0,rolePlatoon:N||void 0,platoon:C||"N/A"};try{const A=await Qe({id:Pe.id,email:Pe.email,rank:Pe.rank,firstName:Pe.firstName,lastName:Pe.lastName,mi:Pe.mi,service:Pe.service,role:Pe.role,unitUic:Pe.unitUic,unit:(b==null?void 0:b.unitName)||"N/A",company:Pe.company,isUnitAdmin:!!Pe.isUnitAdmin,edipi:String(Pe.edipi),passwordHash:ve,platoon:C||"N/A",roleCompany:Q||void 0,rolePlatoon:N||void 0});if(!A.ok){F({type:"error",message:`Failed to save profile: ${String(((M=A==null?void 0:A.error)==null?void 0:M.message)||(A==null?void 0:A.error)||"unknown")}`});return}F({type:"success",message:a.id?"Profile updated.":b&&!ae?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),t==null||t(Pe)}catch{F({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:i==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:Ze,className:"space-y-6",children:[i==="create"&&b&&!ae&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:b.unitName})," (UIC ",b.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:P,onChange:x=>O(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:w,onChange:x=>y(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:_,maxLength:1,onChange:x=>Z(x.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:j,onChange:x=>U(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:H,onChange:x=>L(x.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:l,onChange:x=>se(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(Mt).map(x=>e.jsx("option",{value:x,children:x},x))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:T,onChange:x=>R(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),r.map(x=>e.jsx("option",{value:x,children:x},x))]})]}),i==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:q,onChange:x=>ye(x.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:we,onChange:x=>Se(x.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]})]}):e.jsx(e.Fragment,{})]})]}),me&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:q,onChange:x=>ye(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:we,onChange:x=>Se(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>oe(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>oe(!1),children:"Save"})]})]})}),i==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:B,onChange:x=>g(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:Ws.map(x=>e.jsx("option",{value:x,children:x},x))})}),e.jsx("div",{children:e.jsxs("select",{value:Q||String(a.roleCompany||""),onChange:x=>ge(x.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:_e.length?"Select company":"No companies configured"}),_e.map(x=>e.jsx("option",{value:x,children:x},x))]})}),e.jsx("div",{children:e.jsxs("select",{value:N||String(a.rolePlatoon||""),onChange:x=>G(x.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:He.length?"Select platoon":"No platoons configured"}),He.map(x=>e.jsx("option",{value:x,children:x},x))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:V,onChange:x=>m(x.target.checked),disabled:h||!S}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(a==null?void 0:a.isCommandStaff)||B==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Command Sections Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(Vs,{onUnitSelect:x=>f(x),selectedUnit:b})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:E||String(a.company||""),onChange:x=>D(x.target.value),disabled:h||!b||de.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:de.length?"Select company":"No companies configured"}),de.map(x=>e.jsx("option",{value:x,children:x},x))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:C||String(a.platoon||""),onChange:x=>W(x.target.value),disabled:h||!b||!E||ke.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:ke.length?"Select platoon":"No platoons configured"}),ke.map(x=>e.jsx("option",{value:x,children:x},x))]})]})]})})]}),K&&e.jsx("div",{className:`p-3 rounded-lg border ${K.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:K.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[i==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>oe(!0),disabled:h,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:h,children:i==="edit"?"Save":"Create Profile"})]})]})]})},Hs=s.memo(function({user:a,onClose:i}){const h=()=>{const c=We.find(w=>w.uic===a.unitUic),S=c?c.unitName:a.unit;if(a.isUnitAdmin||a.role==="COMMANDER")return S||"—";if(a.role==="COMPANY_REVIEWER")return a.company&&a.company!=="N/A"?a.company:"—";if(a.role==="PLATOON_REVIEWER"){const w=a.company&&a.company!=="N/A"?a.company:"",y=a.platoon&&a.platoon!=="N/A"?a.platoon:"",P=[w,y].filter(Boolean);return P.length?P.join(" / "):"—"}return"—"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:i,children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:a.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:a.edipi||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:a.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:a.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:h()})]}),a.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),a.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:i,children:"Close"})})]})})}),zs=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Qs=()=>{const[t,a]=s.useState(null),[i,h]=s.useState(void 0),[c,S]=s.useState({}),[w,y]=s.useState({}),[P,O]=s.useState({}),[_,Z]=s.useState({}),[j,U]=s.useState(""),[H,L]=s.useState(""),[l,se]=s.useState(""),[T,R]=s.useState(""),[B,g]=s.useState(""),[V,m]=s.useState([]),[E,D]=s.useState(null),[C,W]=s.useState(""),b=s.useRef(null),[f,K]=s.useState(null),[F,z]=s.useState(null),[ce,q]=s.useState(""),[ye,we]=s.useState(void 0),[Se,v]=s.useState(void 0),[te,ae]=s.useState(void 0),[ne,Q]=s.useState(void 0),[ge,N]=s.useState(void 0),[G,me]=s.useState(void 0),[oe,le]=s.useState([]),[Ce,je]=s.useState([]),[Ae,Oe]=s.useState(""),[Me,qe]=s.useState("unit"),[o,r]=s.useState([]),[p,$]=s.useState(!1),[I,re]=s.useState(!1),[Ne,Ee]=s.useState(!1),[de,ke]=s.useState("admin"),_e=s.useRef(!1);s.useEffect(()=>{f&&de==="admin"&&!_e.current&&(!ye&&f.company&&f.company!=="N/A"&&(we(f.company),ae(f.company)),!Se&&f.platoon&&f.platoon!=="N/A"&&(v(f.platoon),Q(f.platoon)),!ge&&f.roleCompany&&f.roleCompany!=="N/A"&&N(f.roleCompany),!G&&f.rolePlatoon&&f.rolePlatoon!=="N/A"&&me(f.rolePlatoon),_e.current=!0)},[f,de]),s.useEffect(()=>{try{const n=localStorage.getItem("unit_structure");n&&S(JSON.parse(n))}catch{}try{const n=localStorage.getItem("unit_structure"),d={},k={},Y={};if(n){const be=JSON.parse(n);for(const fe of Object.keys(be||{})){const ie=be[fe];ie&&Array.isArray(ie._sections)&&(d[fe]=ie._sections),ie&&Array.isArray(ie._commandSections)&&(k[fe]=ie._commandSections),ie&&ie._platoonSectionMap&&typeof ie._platoonSectionMap=="object"&&(Y[fe]=ie._platoonSectionMap)}}else(async()=>{try{const be=await Nt();for(const fe of Object.keys(be||{})){const ie=be[fe];ie&&Array.isArray(ie._sections)&&(d[fe]=ie._sections),ie&&Array.isArray(ie._commandSections)&&(k[fe]=ie._commandSections),ie&&ie._platoonSectionMap&&typeof ie._platoonSectionMap=="object"&&(Y[fe]=ie._platoonSectionMap)}S(be)}catch{}})();y(d),O(k),Z(Y)}catch{}Ke().then(n=>{m(n)}).catch(()=>m([]));try{const n=localStorage.getItem("currentUser");if(n){const d=JSON.parse(n);if(a(d),d.unitUic){const k=We.find(Y=>Y.uic===d.unitUic);k&&h(k)}}}catch{}},[]),s.useEffect(()=>{try{if(!i){const n=Object.keys(c||{});if(n.length){const d=n[0],k=c[d]||{},be=We.find(fe=>fe.uic===d)||{ruc:String(k._ruc||""),mcc:String(k._mcc||""),uic:d,unitName:String(k._unitName||d),streetAddress:String(k._streetAddress||"")};h(be)}}}catch{}},[c]),s.useEffect(()=>{const n=(f==null?void 0:f.unitUic)||"";if(!n){le([]);return}qt(n).then(d=>le(d||[])).catch(()=>le([]))},[f]),s.useEffect(()=>{const n=(f==null?void 0:f.unitUic)||"",d=ge||"";if(!n||!d){je([]);return}xt(n,d).then(k=>je(k||[])).catch(()=>je([]))},[f,ge]);const He=s.useMemo(()=>{const n=(i==null?void 0:i.uic)||"";if(!n)return[];const d=c[n]||{};return Object.keys(d).filter(k=>!k.startsWith("_")&&Array.isArray(d[k]))},[i,c]),Xe=s.useMemo(()=>{var k;const n=(i==null?void 0:i.uic)||"";if(!n||!j)return[];const d=(k=c[n])==null?void 0:k[j];return Array.isArray(d)?d:[]},[i,j,c]),Ge=s.useMemo(()=>{const n=(i==null?void 0:i.uic)||"";return n?w[n]||[]:[]},[i,w]),Ze=s.useMemo(()=>{const n=(i==null?void 0:i.uic)||"";return n?P[n]||[]:[]},[i,P]),x=s.useMemo(()=>{const n=(f==null?void 0:f.unitUic)||"";if(!n)return[];const d=oe;if(d&&d.length)return d;const k=c[n]||{};return Object.keys(k).filter(Y=>!Y.startsWith("_")&&Array.isArray(k[Y]))},[f,c,oe]),J=s.useMemo(()=>{var Y;const n=(f==null?void 0:f.unitUic)||"",d=te||"";if(!n||!d)return[];const k=(Y=c[n])==null?void 0:Y[d];return Array.isArray(k)?k:[]},[f,te,c]),ve=s.useMemo(()=>{var be,fe;const n=(f==null?void 0:f.unitUic)||"",d=ge||"";if(!d)return[];const k=Ce;if(k&&k.length>0)return k;if(n){const ie=(be=c[n])==null?void 0:be[d];if(Array.isArray(ie)&&ie.length>0)return ie}const Y=(i==null?void 0:i.uic)||"";if(Y&&Y!==n){const ie=(fe=c[Y])==null?void 0:fe[d];if(Array.isArray(ie))return ie}return[]},[f,ge,c,Ce,i]),Pe=s.useMemo(()=>{const n=x.slice(),d=ye||(f&&f.company!=="N/A"?f.company:"");return d&&!n.includes(d)?[d,...n]:n},[x,ye,f]);s.useMemo(()=>{const n=J.slice(),d=ne||(f&&f.platoon&&f.platoon!=="N/A"?f.platoon:"");return d&&!n.includes(d)?[d,...n]:n},[J,ne,f]);const u=s.useMemo(()=>{const n=ve.slice(),d=G||(f&&f.rolePlatoon&&f.rolePlatoon!=="N/A"?f.rolePlatoon:"");return d&&!n.includes(d)?[d,...n]:n},[ve,G,f]),M=()=>{try{if(i){const n=i.uic,d={...c};d[n]=d[n]||{},d[n]._mcc=i.mcc||d[n]._mcc||"",d[n]._unitName=i.unitName||d[n]._unitName||"",S(d),localStorage.setItem("unit_structure",JSON.stringify(d)),(async()=>{try{if(navigator.sendBeacon){const Y=new Blob([JSON.stringify(d)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",Y),D({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d),keepalive:!0})).ok)throw new Error("persist_failed");D({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{D({type:"error",message:"Failed to persist unit structure."})}})()}else{const n=JSON.stringify(c);localStorage.setItem("unit_structure",n),(async()=>{try{if(navigator.sendBeacon){const k=new Blob([n],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",k),D({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:n,keepalive:!0})).ok)throw new Error("persist_failed");D({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{D({type:"error",message:"Failed to persist unit structure."})}})()}}catch{D({type:"error",message:"Failed to save unit structure."})}},A=()=>{try{if(!i)return;const n=i.uic,d={...c};d[n]=d[n]||{},d[n]._sections=w[n]||[],d[n]._mcc=i.mcc||d[n]._mcc||"",d[n]._unitName=i.unitName||d[n]._unitName||"",S(d),localStorage.setItem("unit_structure",JSON.stringify(d)),(async()=>{try{if(navigator.sendBeacon){const Y=new Blob([JSON.stringify(d)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",Y),D({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d),keepalive:!0})).ok)throw new Error("persist_failed");D({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{D({type:"error",message:"Failed to persist unit sections."})}})()}catch{D({type:"error",message:"Failed to save unit sections."})}},X=()=>{try{if(!i)return;const n=i.uic,d={...c};d[n]=d[n]||{},d[n]._commandSections=P[n]||[],d[n]._mcc=i.mcc||d[n]._mcc||"",d[n]._unitName=i.unitName||d[n]._unitName||"",S(d),localStorage.setItem("unit_structure",JSON.stringify(d)),(async()=>{try{if(navigator.sendBeacon){const Y=new Blob([JSON.stringify(d)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",Y),D({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d),keepalive:!0})).ok)throw new Error("persist_failed");D({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{D({type:"error",message:"Failed to persist command sections."})}})()}catch{D({type:"error",message:"Failed to save command sections."})}},ee=()=>{try{if(!i)return;const n=i.uic,d={...c};d[n]=d[n]||{},d[n]._platoonSectionMap=_[n]||{},d[n]._mcc=i.mcc||d[n]._mcc||"",d[n]._unitName=i.unitName||d[n]._unitName||"",S(d),localStorage.setItem("unit_structure",JSON.stringify(d)),(async()=>{try{if(navigator.sendBeacon){const Y=new Blob([JSON.stringify(d)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",Y),D({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d),keepalive:!0})).ok)throw new Error("persist_failed");D({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{D({type:"error",message:"Failed to persist links."})}})()}catch{D({type:"error",message:"Failed to save links."})}},xe=()=>{if(!i||!H.trim())return;const n=i.uic,d={...c};d[n]=d[n]||{},d[n][H.trim()]||(d[n][H.trim()]=[],S(d),U(H.trim()),L(""))},he=n=>{if(!i)return;const d=i.uic,k={...c};k[d]&&(delete k[d][n],S(k),j===n&&U(""))},pe=()=>{if(!i||!j||!l.trim())return;const n=i.uic,d={...c};d[n]=d[n]||{},d[n][j]=d[n][j]||[],d[n][j].includes(l.trim())||(d[n][j]=[...d[n][j],l.trim()],S(d),se(""))},Ie=n=>{if(!i||!j)return;const d=i.uic,k={...c};k[d][j]=(k[d][j]||[]).filter(Y=>Y!==n),S(k)},ue=()=>{if(!i||!T.trim())return;const n=i.uic,d={...w};d[n]=d[n]||[],d[n].includes(T.trim())||(d[n]=[...d[n],T.trim()],y(d),R(""))},De=n=>{if(!i)return;const d=i.uic,k={...w};k[d]=(k[d]||[]).filter(Y=>Y!==n),y(k)},$e=()=>{if(!i||!B.trim())return;const n=i.uic,d={...P};d[n]=d[n]||[],d[n].includes(B.trim())||(d[n]=[...d[n],B.trim()],O(d),g(""))},Be=n=>{if(!i)return;const d=i.uic,k={...P};k[d]=(k[d]||[]).filter(Y=>Y!==n),O(k)},Ve=()=>{const n=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],d=V.map(ie=>[ie.firstName,ie.mi||"",ie.lastName,ie.email,ie.edipi,ie.service,ie.rank,ie.role,ie.company,ie.unit,ie.unitUic||""].map(Ut=>{const st=String(Ut??"");return st.includes(",")||st.includes('"')||st.includes(`
`)?'"'+st.replace(/"/g,'""')+'"':st}).join(",")),k="\uFEFF"+[n.join(","),...d].join(`
`),Y=new Blob([k],{type:"text/csv;charset=utf-8"}),be=URL.createObjectURL(Y),fe=document.createElement("a");fe.href=be,fe.download="users-export.csv",fe.click(),URL.revokeObjectURL(be)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${Me==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>qe("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${Me==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>qe("users"),children:"User Administration"})]})})}),Me==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:i?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",i.uic," | RUC: ",i.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:M,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:H,onChange:n=>L(n.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:xe,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[He.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>U(n),children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>he(n),children:"Remove"})]},n)),He.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",j?`• ${j}`:""]}),i&&j&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ee,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:l,onChange:n=>se(n.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!j}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:pe,disabled:!j,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Xe.map(n=>{var d,k;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:n})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:((k=(d=_[(i==null?void 0:i.uic)||""])==null?void 0:d[j])==null?void 0:k[n])||"",onChange:Y=>{const be=(i==null?void 0:i.uic)||"";Z(fe=>{const ie={...fe};return ie[be]=ie[be]||{},ie[be][j]=ie[be][j]||{},ie[be][j][n]=Y.target.value,ie})},children:[e.jsx("option",{value:"",children:"Link to section"}),(w[(i==null?void 0:i.uic)||""]||[]).map(Y=>e.jsx("option",{value:Y,children:Y},Y))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Ie(n),children:"Remove"})]})]},n)}),Xe.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:A,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:T,onChange:n=>R(n.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:ue,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Ge.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>De(n),children:"Remove"})]},n)),Ge.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:X,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:B,onChange:n=>g(n.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:$e,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Ze.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Be(n),children:"Remove"})]},n)),Ze.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),Me==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[V.filter(n=>{const d=!C||(n.email??"").toLowerCase().includes(C.toLowerCase())||(n.lastName??"").toLowerCase().includes(C.toLowerCase()),k=i?n.unitUic===i.uic||n.unit&&n.unit===i.unitName:!0;return d&&k}).map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[n.lastName,", ",n.firstName,n.mi?` ${n.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:n.email}),e.jsx("td",{className:"py-2 px-3",children:n.edipi}),e.jsx("td",{className:"py-2 px-3",children:n.service}),e.jsx("td",{className:"py-2 px-3",children:n.rank}),e.jsx("td",{className:"py-2 px-3",children:n.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const d=We.find(Y=>Y.uic===n.unitUic),k=d?d.unitName:n.unit;if(n.isUnitAdmin||n.role==="COMMANDER")return k||"—";if(n.role==="COMPANY_REVIEWER")return n.company&&n.company!=="N/A"?n.company:"—";if(n.role==="PLATOON_REVIEWER"){const Y=n.company&&n.company!=="N/A"?n.company:"",be=n.platoon&&n.platoon!=="N/A"?n.platoon:"",fe=[Y,be].filter(Boolean);return fe.length?fe.join(" / "):"—"}return"—"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>z(n),children:"View"}),((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{ke("admin"),K(n),q(n.role??"MEMBER"),we(n.company!=="N/A"?n.company:void 0),ae(n.company!=="N/A"?n.company:void 0),v(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),Q(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),Oe(typeof n.commandOrder=="number"?String(n.commandOrder):""),re(!!n.isUnitAdmin),Ee(!!n.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{m(d=>d.filter(k=>k.id!==n.id));try{localStorage.removeItem(`fs/users/${n.id}.json`)}catch(d){console.error("Failed to remove user from localStorage",d)}},children:"Delete"})]})})]},n.id)),V.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:"No users"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:b,type:"text",placeholder:"Filter users...",value:C,onChange:n=>W(n.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var n;return(n=b.current)==null?void 0:n.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:Ve,children:"Export All"})]})]}),F&&e.jsx(Hs,{user:F,onClose:()=>z(null)}),f&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>K(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>K(null),children:"✕"})]}),de==="profile"&&t&&f&&t.edipi===f.edipi&&e.jsx(Gt,{mode:"edit",initial:f,readOnly:!1,onSaved:n=>{m(d=>d.map(k=>k.edipi===n.edipi?n:k)),K(null),D({type:"success",message:"Profile updated."})}}),de==="admin"&&((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:ce,onChange:n=>{const d=n.target.value;q(d),d==="COMMANDER"&&(we(void 0),v(void 0))},className:"w-full px-3 py-2 border rounded",children:zs.map(n=>e.jsx("option",{value:n,children:n},n))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:ge||"",onChange:n=>N(n.target.value||void 0),disabled:!ce.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Pe.length?"Select company":"No companies configured"}),Pe.map(n=>e.jsx("option",{value:n,children:n},n))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:G||"",onChange:n=>me(n.target.value||void 0),disabled:!ce.includes("REVIEW")||!ge,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:u.length?"Select platoon":"No platoons configured"}),u.map(n=>e.jsx("option",{value:n,children:n},n))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:I,onChange:n=>re(n.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:Ne,disabled:ce==="COMMANDER",onChange:async n=>{const d=n.target.checked;Ee(d);try{if(f&&!(await Qe({id:f.id,email:f.email,rank:f.rank,firstName:f.firstName,lastName:f.lastName,mi:f.mi,service:f.service,role:f.role,unitUic:f.unitUic,unit:f.unit,company:f.company,isUnitAdmin:!!f.isUnitAdmin,isCommandStaff:d,edipi:f.edipi,passwordHash:f.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Command Sections Dashboard"})]})]}),o.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:o.map((n,d)=>e.jsx("div",{className:"text-sm",children:n},d))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{K(null),_e.current=!1,r([]),$(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${p?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":p,disabled:p,onClick:async()=>{var Y;if(!f)return;const n=[];if(ce==="COMPANY_REVIEWER"&&!ye&&n.push("Company is required for Company Reviewer."),ce==="PLATOON_REVIEWER"&&(!ye||!Se)&&n.push("Company and Platoon are required for Platoon Reviewer."),r(n),n.length)return;$(!0);const d=((Y=We.find(be=>be.uic===f.unitUic))==null?void 0:Y.unitName)||"N/A",k={...f,role:ce,isUnitAdmin:I,isCommandStaff:ce==="COMMANDER"?!1:Ne,company:te||"N/A",unit:d,platoon:ne||"N/A",roleCompany:ce.includes("REVIEW")?ge||"N/A":void 0,rolePlatoon:ce.includes("REVIEW")?G||"N/A":void 0};try{localStorage.setItem(`fs/users/${k.edipi}.json`,JSON.stringify(k))}catch{}try{if(!(await Qe({id:k.id,email:k.email,rank:k.rank,firstName:k.firstName,lastName:k.lastName,mi:k.mi,service:k.service,role:k.role,unitUic:k.unitUic,unit:k.unit,company:k.company,isUnitAdmin:!!k.isUnitAdmin,isCommandStaff:!!k.isCommandStaff,edipi:k.edipi,passwordHash:k.passwordHash,roleCompany:k.roleCompany,rolePlatoon:k.rolePlatoon,platoon:k.platoon})).ok)throw new Error("persist_failed")}catch{$(!1),D({type:"error",message:"Failed to save administrative changes."});return}m(be=>be.map(fe=>fe.edipi===k.edipi?k:fe));try{t&&t.edipi===k.edipi&&(localStorage.setItem("currentUser",JSON.stringify(k)),a(k))}catch{}K(null),_e.current=!1,$(!1),D({type:"success",message:"Administrative changes saved."})},children:[p&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),E&&e.jsx("div",{className:`p-3 rounded-lg border ${E.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:E.message})]})};function Gs(){const[t,a]=s.useState([]),[i,h]=s.useState(null),[c,S]=s.useState({}),[w,y]=s.useState({}),[P,O]=s.useState([]),[_,Z]=s.useState("unit"),[j,U]=s.useState("assigned"),[H,L]=s.useState([]),[l,se]=s.useState(""),[T,R]=s.useState([]),[B,g]=s.useState(""),V=()=>{Ke().then(r=>a(r)).catch(()=>a([]))},m=()=>{lt().then(r=>O(r)).catch(()=>O([]))},E=()=>{h(null),V(),m()};s.useEffect(()=>{E(),Tt().then(r=>L(r)),$t().then(r=>R(r))},[_,j]);const D=s.useMemo(()=>{const r={};for(const p of t)p.isUnitAdmin&&p.unitUic&&(r[p.unitUic]=p);return r},[t]),C=s.useMemo(()=>{const r=new Set;return We.filter(p=>r.has(p.uic)?!1:(r.add(p.uic),!0))},[]),W=s.useMemo(()=>{const r={};for(const p of t)if(p.isInstallationAdmin&&p.installationId){const $=p.installationId;r[$]=r[$]||[],r[$].push(p)}return r},[t]),b=r=>t.filter(p=>p.unitUic===r.uic||!p.unitUic&&p.unit===r.unitName),f=async r=>{const p=c[r.uic];if(!p)return;const $=t.find(re=>re.id===p);if(!$)return;const I={...$,isUnitAdmin:!0,unitUic:r.uic,unit:r.unitName,company:"N/A"};try{if(!(await Qe({id:I.id,email:I.email,rank:I.rank,firstName:I.firstName,lastName:I.lastName,mi:I.mi,service:I.service,role:I.role,unitUic:I.unitUic,unit:I.unit,company:I.company,isUnitAdmin:!!I.isUnitAdmin,isInstallationAdmin:!!I.isInstallationAdmin,isCommandStaff:!!I.isCommandStaff,edipi:I.edipi})).ok){h({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}a(re=>re.map(Ne=>Ne.id===I.id?I:Ne)),h({type:"success",message:`Assigned ${I.rank} ${I.lastName} as admin for ${r.unitName}.`})},K=s.useMemo(()=>C.filter(r=>!!D[r.uic]),[C,D]);s.useMemo(()=>(Array.isArray(t)?t:[]).filter(r=>!!r.isHqmcAdmin),[t]);const F=s.useMemo(()=>C.filter(r=>!D[r.uic]),[C,D]),z=s.useMemo(()=>(Array.isArray(H)?H:[]).filter(r=>{var p;return(p=W[r.id])==null?void 0:p.length}),[H,W]),ce=s.useMemo(()=>(Array.isArray(H)?H:[]).filter(r=>{var p;return!((p=W[r.id])!=null&&p.length)}),[H,W]),q=s.useMemo(()=>{const r={};for(const p of Array.isArray(t)?t:[])if(p.isHqmcAdmin&&p.hqmcDivision){const $=p.hqmcDivision;r[$]=r[$]||[],r[$].push(p)}return r},[t]),ye=s.useMemo(()=>(Array.isArray(T)?T:[]).filter(r=>{var p;return(p=q[r.code])==null?void 0:p.length}),[T,q]);s.useMemo(()=>{const r=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return(Array.isArray(P)?P:[]).filter(p=>r.includes(String(p.currentStage||"")))},[P]);const[we,Se]=s.useState(1),[v,te]=s.useState(10),ae=K.length,ne=Math.max(1,Math.ceil(ae/(v||1))),Q=Math.min(we,ne),ge=ae===0?0:(Q-1)*v+1,N=ae===0?0:Math.min(ge+v-1,ae),G=K.slice((Q-1)*v,(Q-1)*v+v),[me,oe]=s.useState(1),[le,Ce]=s.useState(10),je=F.length,Ae=Math.max(1,Math.ceil(je/(le||1))),Oe=Math.min(me,Ae),Me=je===0?0:(Oe-1)*le+1,qe=je===0?0:Math.min(Me+le-1,je),o=F.slice((Oe-1)*le,(Oe-1)*le+le);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${_==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Z("unit"),U("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${_==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Z("installation"),U("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${_==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Z("hqmc"),U("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${j==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>U("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${j==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>U("missing"),children:"Missing"})]}),_==="installation"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[z.map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:r.name}),e.jsx("td",{className:"py-2 px-3",children:(W[r.id]||[]).map(p=>`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`).join(" • ")})]},r.id)),z.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),_==="installation"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[ce.map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:r.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:w[r.id]||"",onChange:p=>y($=>({...$,[r.id]:p.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(p=>e.jsx("option",{value:p.id,children:`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`},p.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!w[r.id],onClick:async()=>{const p=w[r.id],$=t.find(re=>re.id===p);if(!$)return;const I={...$,isInstallationAdmin:!0,installationId:r.id};try{if(!(await Qe({id:I.id,email:I.email,rank:I.rank,firstName:I.firstName,lastName:I.lastName,mi:I.mi,service:I.service,role:I.role,unitUic:I.unitUic,unit:I.unit,company:I.company,isUnitAdmin:!!I.isUnitAdmin,isInstallationAdmin:!!I.isInstallationAdmin,isCommandStaff:!!I.isCommandStaff,edipi:I.edipi,installationId:I.installationId})).ok){h({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}a(re=>re.map(Ne=>Ne.id===I.id?I:Ne)),h({type:"success",message:`Assigned ${I.rank} ${I.lastName} as installation admin.`})},children:"Assign"})})]},r.id)),ce.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),_==="unit"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[G.map(r=>{const p=D[r.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:r.unitName}),e.jsx("td",{className:"py-2 px-3",children:r.uic}),e.jsx("td",{className:"py-2 px-3",children:`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`})]},r.uic)}),K.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(ht,{currentPage:Q,totalPages:ne,totalItems:ae,pageSize:v,startIndex:ge,endIndex:N,onPageChange:r=>Se(r),onPageSizeChange:r=>{te(r),Se(1)},onNext:()=>Se(Math.min(Q+1,ne)),onPrevious:()=>Se(Math.max(Q-1,1)),onFirst:()=>Se(1),onLast:()=>Se(ne),canGoNext:Q<ne,canGoPrevious:Q>1,pageSizeOptions:[5,10,25,50]})})]}),_==="unit"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[o.map(r=>{const p=b(r);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:r.unitName}),e.jsx("td",{className:"py-2 px-3",children:r.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:c[r.uic]||"",onChange:$=>S(I=>({...I,[r.uic]:$.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:p.length?"Select user":"No eligible users"}),p.map($=>e.jsx("option",{value:$.id,children:`${$.rank} ${$.lastName}, ${$.firstName}${$.mi?` ${$.mi}`:""}`},$.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!c[r.uic],onClick:()=>f(r),children:"Assign"})})]},r.uic)}),F.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(ht,{currentPage:Oe,totalPages:Ae,totalItems:je,pageSize:le,startIndex:Me,endIndex:qe,onPageChange:r=>oe(r),onPageSizeChange:r=>{Ce(r),oe(1)},onNext:()=>oe(Math.min(Oe+1,Ae)),onPrevious:()=>oe(Math.max(Oe-1,1)),onFirst:()=>oe(1),onLast:()=>oe(Ae),canGoNext:Oe<Ae,canGoPrevious:Oe>1,pageSizeOptions:[5,10,25,50]})})]}),_==="hqmc"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[ye.map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[r.code," — ",r.name]}),e.jsx("td",{className:"py-2 px-3",children:(q[r.code]||[]).map(p=>`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`).join(" • ")})]},r.code)),ye.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),_==="hqmc"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[T.filter(r=>{var p;return!((p=q[r.code])!=null&&p.length)}).map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[r.code," — ",r.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:w[`hqmc_${r.code}`]||"",onChange:p=>y($=>({...$,[`hqmc_${r.code}`]:p.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(p=>e.jsx("option",{value:p.id,children:`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`},p.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!w[`hqmc_${r.code}`],onClick:async()=>{const p=w[`hqmc_${r.code}`],$=t.find(re=>re.id===p);if(!$)return;const I={...$,isHqmcAdmin:!0,hqmcDivision:r.code};try{if(!(await Qe({id:I.id,email:I.email,rank:I.rank,firstName:I.firstName,lastName:I.lastName,mi:I.mi,service:I.service,role:I.role,unitUic:I.unitUic,unit:I.unit,company:I.company,isUnitAdmin:!!I.isUnitAdmin,isInstallationAdmin:!!I.isInstallationAdmin,isCommandStaff:!!I.isCommandStaff,isHqmcAdmin:!!I.isHqmcAdmin,hqmcDivision:I.hqmcDivision,edipi:I.edipi})).ok){h({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}a(re=>re.map(Ne=>Ne.id===I.id?I:Ne)),h({type:"success",message:`Assigned ${I.rank} ${I.lastName} as HQMC admin for ${r.code}.`})},children:"Assign"})})]},r.code)),T.filter(r=>{var p;return!((p=q[r.code])!=null&&p.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),i&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${i.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:i.message})]})})}const Pt=!0,Us=({onLoggedIn:t,onCreateAccount:a})=>{const[i,h]=s.useState(""),[c,S]=s.useState(""),[w,y]=s.useState(null),[P,O]=s.useState(!0),[_,Z]=s.useState(!0);Xt.useEffect(()=>{},[]);const j=async U=>{U.preventDefault(),y(null);try{const H=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,L=/^[0-9]{10}$/.test(i),l=Pt?H.test(i.trim().toLowerCase())||L:H.test(i.trim().toLowerCase()),se=c.length>=6;if(O(l),Z(se),!l){y({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!se){y({type:"error",message:"Password must be at least 6 characters."});return}let T=null,R=null,B=i.trim().toLowerCase();if(Pt&&L){const{user:W,error:b}=await pt(String(i));T=W,R=b,B=String((T==null?void 0:T.email)||"")}else if(H.test(B)){const{user:W,error:b}=await St(B);T=W,R=b}else{y({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(R){y({type:"error",message:`Database Error: ${R}`});return}if(!T||!B){y({type:"error",message:"Account not found."});return}const g=String(T.passwordHash||T.password_hash||"").trim();if(!g){y({type:"error",message:"No password set for this user."});return}const V=await bt(c);if(!(/^[0-9a-f]{64}$/i.test(g)?g.toLowerCase()===V.toLowerCase():g===c)){y({type:"error",message:"Invalid credentials."});return}const{user:D,error:C}=await St(B);if(C){y({type:"error",message:`Profile Error: ${C}`});return}if(!D){console.error("[Login] User profile not found after successful password verification",{emailForLogin:B}),y({type:"error",message:"User profile not found."});return}y({type:"success",message:"Logged in."}),t(D)}catch(H){console.error("[Login] Login failed:",H),y({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:j,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:i,onChange:U=>h(U.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${P?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!P}),!P&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:c,onChange:U=>S(U.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${_?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!_}),!_&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),w&&e.jsx("div",{className:`p-3 rounded-lg border ${w.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:w.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:a,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!P||!_,children:"Login"})]})]})]})},Ot=""+new URL("logo-DLcHofKE.png",import.meta.url).href,Js=({currentUser:t,hasSectionDashboard:a,hasCommandDashboard:i,hasInstallationSectionDashboard:h=!1,hasInstallationCommandDashboard:c=!1,hasHQMCSectionDashboard:S=!1,hasHQMCApproverDashboard:w=!1,onManageProfile:y,onLogout:P,onNavigate:O,isLogin:_=!1})=>{const[Z,j]=s.useState(!1),[U,H]=s.useState(!1),L=s.useRef(null);return s.useEffect(()=>{const l=T=>{if(!Z)return;const R=L.current;R&&T.target&&!R.contains(T.target)&&j(!1)},se=T=>{T.key==="Escape"&&j(!1)};return document.addEventListener("mousedown",l),document.addEventListener("touchstart",l,{passive:!0}),document.addEventListener("keydown",se),()=>{document.removeEventListener("mousedown",l),document.removeEventListener("touchstart",l),document.removeEventListener("keydown",se)}},[Z]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:_?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:Ot,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:Ot,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:t?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[t.rank," ",t.lastName,t.lastName?",":""," ",t.firstName,t.mi?` ${t.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[t.service," • ",t.role,(()=>{const l={PLATOON_REVIEWER:t.role_platoon,COMPANY_REVIEWER:t.role_company}[t.role];return l?` - ${l}`:null})()]}),(()=>{var B;const l=((B=We.find(g=>g.uic===((t==null?void 0:t.unitUic)||"")))==null?void 0:B.unitName)||(t==null?void 0:t.unit)||"",se=t!=null&&t.company&&t.company!=="N/A"?t.company:t!=null&&t.user_company&&t.user_company!=="N/A"?t.user_company:null,T=t!=null&&t.platoon&&t.platoon!=="N/A"?t.platoon:t!=null&&t.user_platoon&&t.user_platoon!=="N/A"?t.user_platoon:null,R=[l||null,se,T].filter(Boolean);return R.length?e.jsx("div",{className:"text-xs text-white/70",children:R.join(" • ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:y,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:P,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),t&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>H(!U),children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),U&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{y(),H(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{P(),H(!1)},children:"Logout"})]})]}),!t&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>O("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:L,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":Z,onClick:()=>j(l=>!l),children:"Dashboards"}),e.jsxs("div",{className:`${Z?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:t&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("dashboard"),j(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(t==null?void 0:t.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("admin"),j(!1)},children:"Admin"}),t&&!!t.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("appadmin"),j(!1)},children:"App Admin"}),t&&!!t.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("hqmc-admin"),j(!1)},children:"HQMC Admin"}),t&&!!t.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("installation"),j(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[t&&a&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("section"),j(!1)},children:"Battalion Section Dashboard"}),i&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("command"),j(!1)},children:"Command Sections Dashboard"}),String((t==null?void 0:t.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("review"),j(!1)},children:"Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[t&&h&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("installation-section"),j(!1)},children:"Installation Section Dashboard"}),t&&c&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("installation-command"),j(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[t&&(S||!!t.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("hqmc-section"),j(!1)},children:"HQMC Section Dashboard"}),t&&w&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{O("hqmc-approver"),j(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})},Le={SECTION:"perm_section",COMMAND:"perm_command",INST_SECTION:"perm_inst_section",INST_COMMAND:"perm_inst_command",HQMC_SECTION:"perm_hqmc_section",HQMC_APPROVER:"perm_hqmc_approver"},et=t=>{try{return localStorage.getItem(t)==="true"}catch(a){return console.error(`Failed to read from localStorage for key "${t}":`,a),!1}};function Ys(){const[t,a]=s.useState(null),[i,h]=s.useState("login"),[c,S]=s.useState(()=>{try{const m=localStorage.getItem("currentUser");return m?JSON.parse(m):null}catch(m){return console.error("Failed to parse user from localStorage:",m),null}}),[w,y]=s.useState("create"),[P,O]=s.useState(!1),[_,Z]=s.useState(()=>et(Le.SECTION)),[j,U]=s.useState(()=>et(Le.COMMAND)),[H,L]=s.useState(()=>et(Le.INST_SECTION)),[l,se]=s.useState(()=>et(Le.INST_COMMAND)),[T,R]=s.useState(()=>et(Le.HQMC_SECTION)),[B,g]=s.useState(()=>et(Le.HQMC_APPROVER)),V=Zt();return s.useEffect(()=>{try{const E=new URLSearchParams(window.location.search).get("view");if(E==="admin"||E==="profile"||E==="dashboard"||E==="login"||E==="appadmin"||E==="hqmc-admin"||E==="hqmc-section"||E==="hqmc-approver"||E==="review"||E==="section"||E==="command"||E==="installation"||E==="installation-section"||E==="installation-command"||E==="documents"||E==="document-viewer"||E==="upload")h(E);else{const D=localStorage.getItem("currentView"),C=localStorage.getItem("currentUser");h(D&&C?D:"login")}}catch{h("login")}},[]),s.useEffect(()=>{c?localStorage.setItem("currentUser",JSON.stringify(c)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"),Object.values(Le).forEach(m=>{try{localStorage.removeItem(m)}catch(E){console.error(`Failed to remove item from localStorage for key "${m}":`,E)}}))},[c]),s.useEffect(()=>{if(!c)return;const m={[Le.SECTION]:_,[Le.COMMAND]:j,[Le.INST_SECTION]:H,[Le.INST_COMMAND]:l,[Le.HQMC_SECTION]:T,[Le.HQMC_APPROVER]:B};for(const[E,D]of Object.entries(m))try{localStorage.setItem(E,String(D))}catch(C){console.error(`Failed to set item in localStorage for key "${E}":`,C)}},[c,_,j,H,l,T,B]),s.useEffect(()=>{let m=!1;return(async()=>{try{const E=(c==null?void 0:c.id)||"";if(!E)return;const D=await Lt(E);if(D&&!m){const C={...D,isAppAdmin:D.isAppAdmin||(c==null?void 0:c.isAppAdmin)||!1,isUnitAdmin:D.isUnitAdmin||(c==null?void 0:c.isUnitAdmin)||!1,isInstallationAdmin:D.isInstallationAdmin||(c==null?void 0:c.isInstallationAdmin)||!1,isHqmcAdmin:D.isHqmcAdmin||(c==null?void 0:c.isHqmcAdmin)||!1,isCommandStaff:D.isCommandStaff||(c==null?void 0:c.isCommandStaff)||!1,installationId:D.installationId||(c==null?void 0:c.installationId),hqmcDivision:D.hqmcDivision||(c==null?void 0:c.hqmcDivision)};S(C),localStorage.setItem("currentUser",JSON.stringify(C))}}catch{}})(),()=>{m=!0}},[]),s.useEffect(()=>{i!=="login"&&c&&localStorage.setItem("currentView",i)},[i,c]),s.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const E=await Nt();localStorage.setItem("unit_structure",JSON.stringify(E))}catch(m){console.error("Failed to load unit structure:",m)}})()},[]),s.useEffect(()=>{var m,E,D;if(c){try{const C=localStorage.getItem("unit_structure");if(C){const W=JSON.parse(C),b=(c==null?void 0:c.unitUic)||"",f=c!=null&&c.company&&c.company!=="N/A"?c.company:"",K=c!=null&&c.platoon&&c.platoon!=="N/A"?c.platoon:"";(((D=(E=(m=W==null?void 0:W[b])==null?void 0:m._platoonSectionMap)==null?void 0:E[f])==null?void 0:D[K])||"")&&Z(!0)}}catch(C){console.error("Failed to parse unit structure for section dashboard check",C)}c!=null&&c.isCommandStaff&&U(!0),(async()=>{try{const C=(c==null?void 0:c.installationId)||"";if(!C)return;const W=await Tt();try{localStorage.setItem("installations_cache",JSON.stringify(W))}catch{}const b=W==null?void 0:W.find(z=>z.id===C),f=(c==null?void 0:c.id)||"",K=!!(b&&b.sectionAssignments&&Object.values(b.sectionAssignments).some(z=>Array.isArray(z)&&z.includes(f))),F=!!(b&&(b.commandSectionAssignments&&Object.values(b.commandSectionAssignments).some(z=>Array.isArray(z)&&z.includes(f))||b.commanderUserId&&String(b.commanderUserId)===f));K&&L(!0),F&&se(!0)}catch{}})(),(async()=>{try{const C=String((c==null?void 0:c.hqmcDivision)||""),W=String((c==null?void 0:c.id)||"");if(c!=null&&c.isHqmcAdmin&&R(!0),!C||!W)return;const{listHQMCSectionAssignmentsLegacy:b}=await es(async()=>{const{listHQMCSectionAssignmentsLegacy:z}=await import("./db-CsqImcOP.js").then(ce=>ce.z);return{listHQMCSectionAssignmentsLegacy:z}},__vite__mapDeps([0,1,2]),import.meta.url),f=await b(),K=f.some(z=>z.division_code===C&&((z.reviewers||[]).includes(W)||(z.approvers||[]).includes(W))),F=f.some(z=>z.division_code===C&&(z.approvers||[]).includes(W));K&&R(!0),F&&g(!0)}catch{c!=null&&c.isHqmcAdmin&&R(!0)}})()}},[c]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(Js,{currentUser:c,hasSectionDashboard:_,hasCommandDashboard:j,hasInstallationSectionDashboard:H,hasInstallationCommandDashboard:l,hasHQMCSectionDashboard:T,hasHQMCApproverDashboard:B,onManageProfile:()=>{y("edit"),h("profile"),V("/?view=profile")},onLogout:()=>{S(null),h("login"),V("/?view=login")},onNavigate:m=>{h(m),V(`/?view=${m}`)},isLogin:i==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:i==="profile"?e.jsx(Gt,{mode:w,initial:w==="edit"?c||{}:{},onSaved:m=>{S(m),h("dashboard"),V("/?view=dashboard")}}):i==="admin"?e.jsx(Qs,{}):i==="appadmin"?e.jsx(Gs,{}):i==="login"?e.jsx(Us,{onLoggedIn:m=>{S(m),h("dashboard"),V("/?view=dashboard")},onCreateAccount:()=>{y("create"),h("profile"),V("/?view=profile")}}):i==="review"?e.jsx(Ms,{}):i==="section"?e.jsx(ps,{}):i==="command"?e.jsx(xs,{}):i==="installation"?e.jsx(cs,{}):i==="hqmc-admin"?e.jsx($s,{}):i==="installation-section"?e.jsx(hs,{}):i==="installation-command"?e.jsx(gs,{}):i==="hqmc-section"?e.jsx(qs,{}):i==="hqmc-approver"?e.jsx(Bs,{}):e.jsx(ws,{selectedUnit:t,currentUser:c})})]})}function da(){return e.jsx(Ys,{})}export{da as default};
