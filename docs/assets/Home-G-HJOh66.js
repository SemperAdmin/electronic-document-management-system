const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-CER12hrx.js","./index-CR3981p1.js","./index-DOJlyb3T.css"])))=>i.map(i=>d[i]);
import{r as s,j as e,s as Dt,v as Jt,l as lt,M as St,a as Yt,u as Kt,R as Xt,b as Zt,_ as es}from"./index-CR3981p1.js";import{s as Re,d as ts,a as ss,b as as,l as yt,c as it,e as Ue,u as Fe,f as pt,g as vt,h as He,i as ns,j as rs,k as $t,m as Nt,n as _t,o as xt,p as is,q as os,r as Lt,t as qt,v as ht,w as Tt,x as wt}from"./db-CER12hrx.js";import{P as gt,I as cs}from"./InstallationAdmin-DV9Tbh5j.js";import{f as Bt,R as Qe,S as Ze,o as Ct,c as ls,a as ds}from"./RequestTable-CRQVPGYQ.js";import{c as ms,F as us,D as Ft,a as Ke}from"./DocumentListItem-QSC__g1-.js";import{l as jt}from"./unitStructure-QC5qYuxv.js";import ps from"./SectionDashboard-DXwaIozJ.js";import xs from"./CommandDashboard-Z3mEk4ns.js";import hs from"./InstallationSectionDashboard-BZtlI3Tu.js";import gs from"./InstallationCommandDashboard-BO3V6Jbp.js";import{U as Ve}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-Dk6WQW1U.js";import"./utils-CLmukD0c.js";const bs={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},fs=({filters:t,onFiltersChange:a,statusOptions:i=[],originatorOptions:h=[],searchPlaceholder:m="Search requests...",showAdvanced:S=!0,className:w=""})=>{var _;const[y,R]=s.useState(!1),P=s.useRef(null),D=s.useMemo(()=>Array.isArray(t.status)?t.status:[],[t.status]),Y=s.useMemo(()=>{let g=0;return D.length>0&&g++,t.dateFrom&&g++,t.dateTo&&g++,t.originatorId&&g++,g},[D,t.dateFrom,t.dateTo,t.originatorId]),j=s.useCallback(g=>{a({...t,search:g.target.value})},[t,a]),J=s.useCallback(g=>{const T=D.includes(g)?D.filter(u=>u!==g):[...D,g];a({...t,status:T})},[t,D,a]),H=s.useCallback(g=>{a({...t,dateFrom:g.target.value})},[t,a]),$=s.useCallback(g=>{a({...t,dateTo:g.target.value})},[t,a]),p=s.useCallback(g=>{a({...t,originatorId:g.target.value})},[t,a]),ee=s.useCallback(()=>{var g;a(bs),(g=P.current)==null||g.focus()},[a]),B=s.useCallback(()=>{var g;a({...t,search:""}),(g=P.current)==null||g.focus()},[t,a]);s.useEffect(()=>{const g=T=>{var u;(T.metaKey||T.ctrlKey)&&T.key==="k"&&(T.preventDefault(),(u=P.current)==null||u.focus())};return document.addEventListener("keydown",g),()=>document.removeEventListener("keydown",g)},[]);const I=t.search||Y>0;return e.jsxs("div",{className:`space-y-3 ${w}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{ref:P,type:"text",value:t.search,onChange:j,placeholder:m,className:"block w-full pl-10 pr-10 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold bg-[var(--surface)] text-[var(--text)]","aria-label":"Search"}),t.search&&e.jsx("button",{onClick:B,className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600","aria-label":"Clear search",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute inset-y-0 right-8 flex items-center pointer-events-none text-xs text-gray-400",children:e.jsx("kbd",{className:"hidden sm:inline-block px-1.5 py-0.5 bg-gray-100 rounded border border-gray-200 font-mono",children:"⌘K"})})]}),S&&e.jsxs("button",{onClick:()=>R(!y),className:`
              flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors
              ${y||Y>0?"bg-brand-gold/10 border-brand-gold text-brand-navy":"border-brand-navy/30 text-[var(--text)] hover:bg-brand-cream/50"}
            `,"aria-expanded":y,"aria-controls":"filter-panel",children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"})}),e.jsx("span",{className:"hidden sm:inline",children:"Filters"}),Y>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-brand-navy rounded-full",children:Y})]}),I&&e.jsxs("button",{onClick:ee,className:"flex items-center gap-1 px-3 py-2 text-sm text-brand-red hover:text-brand-red-2 hover:bg-red-50 rounded-lg transition-colors","aria-label":"Clear all filters",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),S&&y&&e.jsxs("div",{id:"filter-panel",className:"p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[i.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Status"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:i.map(g=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-white/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:D.includes(g.value),onChange:()=>J(g.value),className:"h-4 w-4 text-brand-navy border-gray-300 rounded focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-[var(--text)]",children:g.label})]},g.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Date Range"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"From date"}),e.jsx("input",{type:"date",value:t.dateFrom,onChange:H,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"From date"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"To date"}),e.jsx("input",{type:"date",value:t.dateTo,onChange:$,min:t.dateFrom,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"To date"})]})]})]}),h.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Originator"}),e.jsxs("select",{value:t.originatorId,onChange:p,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"Filter by originator",children:[e.jsx("option",{value:"",children:"All originators"}),h.map(g=>e.jsx("option",{value:g.value,children:g.label},g.value))]})]})]}),Y>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 pt-2 border-t border-brand-navy/10",children:[e.jsx("span",{className:"text-sm text-[var(--muted)]",children:"Active filters:"}),D.map(g=>{const T=i.find(u=>u.value===g);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[(T==null?void 0:T.label)||g,e.jsx("button",{onClick:()=>J(g),className:"hover:text-brand-red","aria-label":`Remove ${(T==null?void 0:T.label)||g} filter`,children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},g)}),t.dateFrom&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["From: ",t.dateFrom,e.jsx("button",{onClick:()=>a({...t,dateFrom:""}),className:"hover:text-brand-red","aria-label":"Remove from date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.dateTo&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["To: ",t.dateTo,e.jsx("button",{onClick:()=>a({...t,dateTo:""}),className:"hover:text-brand-red","aria-label":"Remove to date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.originatorId&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[((_=h.find(g=>g.value===t.originatorId))==null?void 0:_.label)||"Originator",e.jsx("button",{onClick:()=>a({...t,originatorId:""}),className:"hover:text-brand-red","aria-label":"Remove originator filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]})]})};function ys(t,a){return s.useMemo(()=>{let i=Array.isArray(a.items)?a.items:[];const h=Array.isArray(t.status)?t.status:[];if(t.search){const m=t.search.toLowerCase();i=i.filter(S=>a.getSearchText(S).toLowerCase().includes(m))}return h.length>0&&a.getStatus&&(i=i.filter(m=>h.includes(a.getStatus(m)))),(t.dateFrom||t.dateTo)&&a.getDate&&(i=i.filter(m=>{const S=a.getDate(m);if(!S)return!1;const w=new Date(S);if(isNaN(w.getTime()))return!1;if(t.dateFrom){const y=new Date(t.dateFrom);if(w<y)return!1}if(t.dateTo){const y=new Date(t.dateTo);if(y.setHours(23,59,59,999),w>y)return!1}return!0})),t.originatorId&&a.getOriginatorId&&(i=i.filter(m=>a.getOriginatorId(m)===t.originatorId)),i},[t,a])}function At(t){if(t==null)return"";const a=String(t);return a.includes('"')||a.includes(",")||a.includes(`
`)||a.includes("\r")?`"${a.replace(/"/g,'""')}"`:a}function vs(t,a){const h=a.map(S=>At(S.header)).join(","),m=t.map(S=>a.map(w=>{const y=w.getValue(S),R=w.format?w.format(y):y;return At(R)}).join(","));return[h,...m].join(`\r
`)}function Ns(t,a){const i=t.map(h=>{const m={};return a.forEach(S=>{const w=S.getValue(h);m[S.header]=S.format?S.format(w):w}),m});return JSON.stringify(i,null,2)}function Et(t,a,i){const h=new Blob([t],{type:`${i};charset=utf-8;`}),m=URL.createObjectURL(h),S=document.createElement("a");S.href=m,S.download=a,document.body.appendChild(S),S.click(),document.body.removeChild(S),URL.revokeObjectURL(m)}function js({items:t,columns:a,filename:i="export",label:h="Export",variant:m="secondary",className:S="",disabled:w=!1,showCount:y=!0,formats:R=["csv"]}){const[P,D]=s.useState(!1),[Y,j]=s.useState(!1),J=s.useRef(null),H=s.useCallback(ee=>{j(!0),D(!1),setTimeout(()=>{try{const B=new Date().toISOString().slice(0,10),I=`${i}_${B}`;if(ee==="csv"){const _=vs(t,a);Et(_,`${I}.csv`,"text/csv")}else{const _=Ns(t,a);Et(_,`${I}.json`,"application/json")}}catch(B){console.error("Export failed:",B)}finally{j(!1)}},100)},[t,a,i]);s.useEffect(()=>{const ee=B=>{J.current&&!J.current.contains(B.target)&&D(!1)};return P&&document.addEventListener("mousedown",ee),()=>{document.removeEventListener("mousedown",ee)}},[P]),s.useEffect(()=>{const ee=B=>{B.key==="Escape"&&D(!1)};return P&&document.addEventListener("keydown",ee),()=>{document.removeEventListener("keydown",ee)}},[P]);const $={primary:"bg-brand-navy text-brand-cream hover:bg-brand-navy/90",secondary:"bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold/10",text:"text-brand-navy hover:bg-brand-cream/50"},p=w||t.length===0||Y;return R.length===1?e.jsxs("button",{onClick:()=>H(R[0]),disabled:p,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${$[m]}
          ${S}
        `,children:[Y?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:h}),y&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]})]}):e.jsxs("div",{className:"relative",ref:J,children:[e.jsxs("button",{onClick:()=>D(!P),disabled:p,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${$[m]}
          ${S}
        `,"aria-expanded":P,"aria-haspopup":"menu",children:[Y?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:h}),y&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${P?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),P&&e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-[var(--surface)] border border-brand-navy/20 rounded-lg shadow-lg z-50",role:"menu",children:[R.includes("csv")&&e.jsxs("button",{onClick:()=>H("csv"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 first:rounded-t-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export as CSV"]}),R.includes("json")&&e.jsxs("button",{onClick:()=>H("json"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 last:rounded-b-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})}),"Export as JSON"]})]})]})}const kt=t=>{if(!t)return"";const a=new Date(t);return isNaN(a.getTime())?"":a.toLocaleDateString()};function bt(t,a={}){const{pageSize:i=25,initialPage:h=1}=a,[m,S]=s.useState(h),[w,y]=s.useState(i),R=t.length,P=Math.ceil(R/w),D=(m-1)*w,Y=Math.min(D+w,R);return{currentData:s.useMemo(()=>t.slice(D,Y),[t,D,Y]),currentPage:m,pageSize:w,totalPages:P,totalItems:R,goToPage:I=>{const _=Math.max(1,Math.min(I,P));S(_)},nextPage:()=>{m<P&&S(m+1)},previousPage:()=>{m>1&&S(m-1)},goToFirstPage:()=>{S(1)},goToLastPage:()=>{S(P)},setPageSize:I=>{y(I),S(1)},canGoNext:m<P,canGoPrevious:m>1,startIndex:D+1,endIndex:Y}}const et="edms-docs";function Ss(){return{uploadFile:async(S,w)=>{if(!Re)return{url:"",error:"Supabase not configured"};try{const{error:y}=await Re.storage.from(et).upload(w,S,{upsert:!0});if(y)return{url:"",error:y.message};const{data:R}=Re.storage.from(et).getPublicUrl(w);return{url:(R==null?void 0:R.publicUrl)||""}}catch(y){return{url:"",error:y instanceof Error?y.message:"Upload failed"}}},deleteFile:async S=>{if(!Re||!S)return!1;try{return await Re.storage.from(et).remove([S]),!0}catch{return!1}},deleteFolder:async S=>{if(!Re)return!1;try{const{data:w}=await Re.storage.from(et).list(S.replace(/\/$/,""));if(w&&w.length>0){const y=w.map(R=>`${S.replace(/\/$/,"")}/${R.name}`);await Re.storage.from(et).remove(y)}return!0}catch{return!1}},extractStoragePath:S=>{if(!S)return null;try{const w=S.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(w!=null&&w[1])return decodeURIComponent(w[1])}catch{}return null},buildStoragePath:(S,w,y,R)=>{const P=Date.now();return`${S||"N-A"}/${w}/${P}-${R}-${Dt(y)}`}}}const st=t=>{const a=String(t||"").trim();return a&&a!=="N/A"?a:""},It=(t,a,i)=>t.some(h=>String(h.role||"")!==a||st(h.roleCompany||h.company)!==i.company||a==="PLATOON_REVIEWER"&&st(h.rolePlatoon||h.platoon)!==(i.platoon||"")?!1:String(h.unitUic||"")===String(i.uic||""));function Vt(t){if(t===0)return"0 Bytes";const a=1024,i=["Bytes","KB","MB","GB"],h=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,h)).toFixed(2))+" "+i[h]}const Rt=s.memo(function({doc:a,onView:i,onDelete:h}){const[m,S]=s.useState(!1),w=a.fileUrl&&ms(a.type,a.name);return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:"flex items-center justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors","aria-label":`Document: ${a.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(us,{type:a.type,fileName:a.name,size:"md"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-[var(--text)]",children:a.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)]",children:[a.name," • ",Vt(a.size)," • ",new Date(a.uploadedAt).toLocaleDateString()]}),a.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(a.dueDate).toLocaleDateString()]}),a.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Notes: ",a.notes]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",role:"group","aria-label":"Document actions",children:[a.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Bt({currentStage:a.currentStage})}),w&&e.jsx("button",{type:"button",onClick:y=>{y.stopPropagation(),S(!0)},className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Preview document ${a.name}`,children:"Preview"}),a.fileUrl&&e.jsx("a",{href:a.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${a.name} in new tab`,children:"Open"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:y=>{y.stopPropagation(),i(a)},"aria-label":`View or edit document ${a.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:y=>{y.stopPropagation(),h(a)},"aria-label":`Delete document ${a.subject}`,children:"Delete"})]})]}),a.fileUrl&&e.jsx(Ft,{url:a.fileUrl,fileName:a.name,mimeType:a.type,fileSize:a.size,isOpen:m,onClose:()=>S(!1)})]})}),ze="edms-docs",ws=({selectedUnit:t,currentUser:a})=>{const[i,h]=s.useState([]),[m,S]=s.useState(!1),[w,y]=s.useState(""),[R,P]=s.useState(""),[D,Y]=s.useState(""),[j,J]=s.useState([]),[H,$]=s.useState(null),[p,ee]=s.useState(null),[B,I]=s.useState([]),[_,g]=s.useState(!1),[T,u]=s.useState(null),[C,L]=s.useState(""),[M,W]=s.useState(""),[f,b]=s.useState(""),[U,q]=s.useState([]),[K,X]=s.useState([]),[V,ge]=s.useState(null),[we,Se]=s.useState(""),[v,Z]=s.useState(""),[ae,ne]=s.useState(""),[z,he]=s.useState([]),[N,G]=s.useState(!1),[de,ce]=s.useState({}),[le,Ce]=s.useState(""),[je,Ae]=s.useState("Pending"),Me=Ss(),Ie=l=>{const A=l.target.files?Array.from(l.target.files):[];if(A.length===0)return;if(j.length+A.length>St){$({type:"error",message:`Cannot add ${A.length} file(s). Maximum ${St} files allowed per request.`});try{l.target.value=""}catch{}return}const O=[],te=[];for(const Q of A){const xe=Yt(Q);xe.valid?O.push(Q):te.push(...xe.errors)}O.length>0&&J(Q=>[...Q,...O]),te.length>0&&$({type:"error",message:te.slice(0,3).join(" ")+(te.length>3?` (+${te.length-3} more errors)`:"")});try{l.target.value=""}catch{}},Le=async()=>{if(!V||!(p!=null&&p.id)||V.uploadedById!==p.id)return;const l={actor:`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`,timestamp:new Date().toISOString(),action:"Archived by Originator",comment:(ae||"").trim()},A={...V,currentStage:Ze.ARCHIVED,finalStatus:"Archived",activity:Array.isArray(V.activity)?[...V.activity,l]:[l]};try{const O=await Fe(A);if(!O.ok)throw new Error(d(O,"request_upsert_failed"));X(te=>te.map(Q=>Q.id===A.id?A:Q)),ge(A),$({type:"success",message:"Request archived."})}catch(O){$({type:"error",message:`Failed to archive: ${String((O==null?void 0:O.message)||O)}`})}},o=async l=>{l.preventDefault(),$(null);const A=w.trim();if(!A){$({type:"error",message:"Subject is required."});return}if(A.length>500){$({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(D.length>5e3){$({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(p!=null&&p.id)){$({type:"error",message:"Create a profile before submitting."});return}if(j.length>0){const be=Jt(j);if(!be.valid){$({type:"error",message:be.errors[0]});return}}S(!0);const O=Date.now(),te=le||p.id,Q=B.find(be=>be.id===te),xe=t?t.uic:(Q==null?void 0:Q.unitUic)||"N/A",ue=`req-${O}`;let pe=[];async function De(be,Oe){if(!Re)throw new Error("Supabase not configured");const{error:$e}=await Re.storage.from(ze).upload(Oe,be,{upsert:!0});if($e)throw new Error($e.message);const{data:qe}=Re.storage.from(ze).getPublicUrl(Oe);return(qe==null?void 0:qe.publicUrl)||""}if(j&&j.length>0){const be=[];for(let Oe=0;Oe<j.length;Oe++){const $e=j[Oe],qe=`${xe}/${ue}/${O}-${Oe}-${Dt($e.name)}`;try{const Te=await De($e,qe);be.push(Te)}catch(Te){S(!1),$({type:"error",message:`Failed to upload ${$e.name}: ${String((Te==null?void 0:Te.message)||Te)}`});return}}pe=j.map((Oe,$e)=>({id:`${O}-${$e}`,name:Oe.name,type:Oe.type,size:Oe.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:xe,subject:w.trim(),dueDate:R||void 0,notes:D.trim()||void 0,uploadedById:te,currentStage:"PLATOON_REVIEW",fileUrl:be[$e]}))}pe=pe.map(be=>({...be,requestId:ue})),h(be=>[...be,...pe]),J([]),y(""),P(""),Y("");try{const be=p?`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`:"Unknown",Oe="Member",$e=xe,qe=st(Q==null?void 0:Q.company),Te=st(Q==null?void 0:Q.platoon),ot=It(B,"PLATOON_REVIEWER",{company:qe,platoon:Te,uic:$e}),ct=It(B,"COMPANY_REVIEWER",{company:qe,uic:$e}),n={id:ue,subject:w.trim(),dueDate:R||void 0,notes:D.trim()||void 0,unitUic:xe,uploadedById:te,submitForUserId:te,documentIds:pe.map(c=>c.id),createdAt:new Date().toISOString(),currentStage:ot?Ze.PLATOON_REVIEW:ct?Ze.COMPANY_REVIEW:Ze.BATTALION_REVIEW,activity:[{actor:be,actorRole:Oe,timestamp:new Date().toISOString(),action:"Submitted request",comment:(D||"").trim()}]};try{const c=await Fe(n);if(!c.ok)throw new Error(d(c,"request_upsert_failed"));const E=await pt(pe);if(!E.ok)throw new Error(d(E,"document_upsert_failed"))}catch(c){S(!1);try{lt("request_persist_failed",{requestId:ue,error:String((c==null?void 0:c.message)||c)},"error")}catch{}$({type:"error",message:`Failed to persist submission: ${String((c==null?void 0:c.message)||c)}`});return}X(c=>c.some(se=>se.id===n.id)?c.map(se=>se.id===n.id?n:se):[...c,n]),S(!1),$({type:"success",message:"Submission successful."}),g(!1)}catch{S(!1);try{lt("request_persist_failed",{requestId:ue},"error")}catch{}$({type:"error",message:"Failed to persist submission."})}},r=s.useCallback(l=>{u(l),L(l.subject||""),W(l.dueDate||""),b(l.notes||"");try{const A=localStorage.getItem(`fs/requests/${l.requestId}.json`);if(A){const O=JSON.parse(A);q(Array.isArray(O.activity)?O.activity:[])}else{const Q=Object.values(Object.assign({})).map(xe=>(xe==null?void 0:xe.default)??xe).find(xe=>xe&&xe.id===l.requestId);q(Q&&Array.isArray(Q.activity)?Q.activity:[])}}catch{q([])}},[]),d=(l,A)=>{var O;return String(((O=l.error)==null?void 0:O.message)||l.error||A)},F=async()=>{if(!T)return;const l=i.map(A=>A.id===T.id?{...A,subject:C.trim()||A.subject,dueDate:M||void 0,notes:f.trim()||void 0}:A);h(l);try{const te={actor:p?`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`:"Unknown",actorRole:"Member",timestamp:new Date().toISOString(),action:"Updated document",comment:(f||"").trim()},Q=T.requestId?K.find(xe=>xe.id===T.requestId):null;if(Q){const xe={...Q,activity:Array.isArray(Q.activity)?[...Q.activity,te]:[te]};try{const ue=await Fe(xe);if(!ue.ok)throw new Error(d(ue,"request_upsert_failed"))}catch(ue){console.error("Failed to save document edits:",ue),$({type:"error",message:`Failed to save document edits: ${ue.message}`});return}q(ue=>[...ue,te])}}catch{}b(""),u(null)};i.filter(l=>!(!(p!=null&&p.id)||p.role==="MEMBER"&&l.uploadedById!==p.id||l.type==="request"));const k=()=>String((p==null?void 0:p.role)||"").includes("REVIEW"),re=()=>{if(!k())return[];const l=String((p==null?void 0:p.role)||"");return B.filter(A=>{if(A.id===(p==null?void 0:p.id))return!1;if(l.includes("PLATOON")){const O=A.company&&A.company!=="N/A"?A.company:"",te=A.unit&&A.unit!=="N/A"?A.unit:"",Q=p!=null&&p.company&&p.company!=="N/A"?p.company:"",xe=p!=null&&p.unit&&p.unit!=="N/A"?p.unit:"";return O===Q&&te===xe}if(l.includes("COMPANY")){const O=A.company&&A.company!=="N/A"?A.company:"",te=p!=null&&p.company&&p.company!=="N/A"?p.company:"";return O===te}return l.includes("COMMANDER")?(A.unitUic||"")===((p==null?void 0:p.unitUic)||""):!1})},ye=s.useCallback(async l=>{const A=Me.extractStoragePath(l.fileUrl);try{A&&Re&&await Re.storage.from(ze).remove([A])}catch{}try{await ts(l.id),h(O=>O.filter(te=>te.id!==l.id)),l.requestId&&X(O=>O.map(te=>te.id===l.requestId?{...te,documentIds:(te.documentIds||[]).filter(Q=>Q!==l.id)}:te)),$({type:"success",message:"Document deleted."})}catch(O){$({type:"error",message:`Failed to delete: ${String((O==null?void 0:O.message)||O)}`})}},[]),Ee=s.useCallback(async l=>{const A=`${l.unitUic||"N-A"}/${l.id}/`;try{if(Re){const{data:O}=await Re.storage.from(ze).list(A.slice(0,-1));if(O&&O.length>0){const te=O.map(Q=>`${A.slice(0,-1)}/${Q.name}`);await Re.storage.from(ze).remove(te)}}}catch{}try{await ss(l.id),await as(l.id),h(O=>O.filter(te=>te.requestId!==l.id)),X(O=>O.filter(te=>te.id!==l.id)),ge(null),$({type:"success",message:"Request and files deleted."})}catch(O){$({type:"error",message:`Failed to delete request: ${String((O==null?void 0:O.message)||O)}`})}},[]),me=async()=>{if(!V||!(p!=null&&p.id)||V.uploadedById!==p.id){$({type:"error",message:"Only the requester can edit this."});return}const l=Date.now(),A=ue=>ue.replace(/[^A-Za-z0-9._-]/g,"-");async function O(ue,pe){if(!Re)throw new Error("Supabase not configured");const{error:De}=await Re.storage.from(ze).upload(pe,ue,{upsert:!0});if(De)throw new Error(De.message);const{data:be}=Re.storage.from(ze).getPublicUrl(pe);return(be==null?void 0:be.publicUrl)||""}const te=[];for(let ue=0;ue<z.length;ue++){const pe=z[ue],De=`${V.unitUic||"N-A"}/${V.id}/${l}-${ue}-${A(pe.name)}`;try{const be=await O(pe,De);te.push(be)}catch(be){$({type:"error",message:`Failed to upload ${pe.name}: ${String((be==null?void 0:be.message)||be)}`});return}}const Q=z.map((ue,pe)=>({id:`${l}-${pe}`,name:ue.name,type:ue.type,size:ue.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:V.unitUic||"N/A",subject:we.trim()||V.subject,dueDate:v||void 0,notes:ae.trim()||void 0,uploadedById:p.id,currentStage:V.currentStage||"PLATOON_REVIEW",requestId:V.id,fileUrl:te[pe]})),xe={...V,subject:we.trim()||V.subject,dueDate:v||void 0,notes:ae.trim()||void 0,documentIds:[...V.documentIds||[],...Q.map(ue=>ue.id)],activity:[...V.activity||[],{actor:`${p.rank} ${p.lastName}, ${p.firstName}${p.mi?` ${p.mi}`:""}`,timestamp:new Date().toISOString(),action:Q.length?`Updated request and added ${Q.length} document(s)`:"Updated request",comment:(ae||"").trim()}]};try{if(!(p&&ds(V,String(p.id||"")))){$({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const pe=await pt(Q);if(!pe.ok)throw new Error(d(pe,"document_upsert_failed"));const De=await Fe(xe);if(!De.ok)throw new Error(d(De,"request_upsert_failed"))}catch(pe){try{lt("request_update_failed",{requestId:xe.id,error:String((pe==null?void 0:pe.message)||pe)},"error")}catch{}$({type:"error",message:`Failed to persist documents: ${String((pe==null?void 0:pe.message)||pe)}`});return}h(pe=>[...pe,...Q]),X(pe=>pe.map(De=>De.id===xe.id?xe:De)),ge(xe),he([]),ne(""),$({type:"success",message:Q.length?"Files added and request updated.":"Request updated."})}catch{$({type:"error",message:"Failed to update request."})}},[ke,Pe]=s.useState(!0),[We,Ge]=s.useState(!0);s.useEffect(()=>{yt().then(l=>{h(l)}).catch(()=>h([])).finally(()=>Pe(!1))},[]),s.useEffect(()=>{V&&(Se(V.subject||""),Z(V.dueDate||""),ne(V.notes||""),he([]))},[V]),s.useEffect(()=>{},[i]),s.useEffect(()=>{it().then(l=>{X(l)}).catch(()=>X([])).finally(()=>Ge(!1))},[]),s.useEffect(()=>{ee(a||null)},[a]),s.useEffect(()=>{Ue().then(l=>{I(l)}).catch(()=>I([]))},[]);const Je=s.useMemo(()=>{if(!(p!=null&&p.id))return[];const l=K.filter(A=>A.uploadedById===p.id);return je==="Pending"?l.filter(A=>A.currentStage!=="ARCHIVED"):l.filter(A=>A.currentStage==="ARCHIVED")},[K,p,je]),Ne=bt(Je,{pageSize:10}),x=s.useMemo(()=>B.reduce((l,A)=>({...l,[A.id]:A}),{}),[B]),oe=s.useCallback(l=>{const A=st(l.currentStage||"PLATOON_REVIEW"),O=B.find(te=>te.id===l.uploadedById);switch(A){case"ORIGINATOR_REVIEW":return{level:"Member",scope:""};case"PLATOON_REVIEW":{const te=O!=null&&O.company&&O.company!=="N/A"?O.company:"",Q=O!=null&&O.platoon&&O.platoon!=="N/A"?O.platoon:"";return te&&Q?{level:"Platoon",scope:`(${te}-${Q})`}:te?{level:"Platoon",scope:`(${te})`}:{level:"Platoon",scope:""}}case"COMPANY_REVIEW":{const te=O!=null&&O.company&&O.company!=="N/A"?O.company:"";return{level:"Company",scope:te?`(${te})`:""}}case"BATTALION_REVIEW":return{level:"Battalion",scope:l.routeSection?`(${l.routeSection})`:""};case"COMMANDER_REVIEW":return{level:"Commander",scope:l.routeSection?`(${l.routeSection})`:""};case"ARCHIVED":return{level:"Archived",scope:""};default:return{level:Bt(l),scope:""}}},[B]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>g(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),_&&e.jsxs("form",{onSubmit:o,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:w,onChange:l=>y(l.target.value),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${w.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:R,onChange:l=>P(l.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),String((p==null?void 0:p.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:le,onChange:l=>Ce(l.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),re().map(l=>e.jsxs("option",{value:l.id,children:[l.rank," ",l.lastName,", ",l.firstName,l.mi?` ${l.mi}`:""]},l.id))]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:D,onChange:l=>Y(l.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:Ie,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:j.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:j.map((l,A)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:l.name,children:l.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>J(O=>O.filter((te,Q)=>Q!==A)),children:"Delete"})]},A))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{g(!1),J([]),y(""),P(""),Y(""),$(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!w.trim(),children:"Submit"})]})]}),H&&e.jsx("div",{className:`p-3 rounded-lg border ${H.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:H.message})]})]}),e.jsxs("div",{className:"p-6",children:[p&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>Ae("Pending"),className:`${je==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>Ae("Archived"),className:`${je==="Archived"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Archived"})]})}),e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:Ne.totalItems>0?`${Ne.startIndex}–${Ne.endIndex} of ${Ne.totalItems}`:""}),We&&e.jsx("div",{className:"animate-pulse",children:"Loading requests…"})]}),e.jsx(Qe,{title:"Your Requests",requests:We?Array.from({length:5}).map((l,A)=>({id:`s-${A}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:Ze.PLATOON_REVIEW})):Ne.currentData,users:x,onRowClick:l=>ge(l),expandedRows:de,children:l=>e.jsxs("div",{id:`req-docs-${l.id}`,children:[ke?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):i.filter(A=>A.requestId===l.id&&A.type!=="request").map(A=>e.jsx(Rt,{doc:A,onView:r,onDelete:ye},A.id)),!ke&&i.filter(A=>A.requestId===l.id&&A.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),Ne.totalItems>0&&e.jsx(gt,{currentPage:Ne.currentPage,totalPages:Ne.totalPages,totalItems:Ne.totalItems,pageSize:Ne.pageSize,startIndex:Ne.startIndex,endIndex:Ne.endIndex,onPageChange:Ne.goToPage,onPageSizeChange:Ne.setPageSize,onNext:Ne.nextPage,onPrevious:Ne.previousPage,onFirst:Ne.goToFirstPage,onLast:Ne.goToLastPage,canGoNext:Ne.canGoNext,canGoPrevious:Ne.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),m&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),T&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>u(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:C,onChange:l=>L(l.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:M,onChange:l=>W(l.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:T.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:f,onChange:l=>b(l.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[T.name," • ",Vt(T.size)," • ",new Date(T.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:U.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):U.map((l,A)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[l.actor,l.actorRole?` • ${l.actorRole}`:""," • ",new Date(l.timestamp).toLocaleString()," • ",l.action]}),l.comment&&e.jsx("div",{className:"text-gray-600",children:l.comment})]},A))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>u(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:F,children:"Save"})]})]})}),V&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>ge(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:l=>l.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>ge(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:we,onChange:l=>Se(l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(V.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:v,onChange:l=>Z(l.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),V.currentStage&&(()=>{const{level:l,scope:A}=oe(V);return e.jsxs("span",{className:"inline-flex flex-col items-center px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-lg border border-brand-navy/30 leading-tight",children:[e.jsx("span",{children:l}),A&&e.jsx("span",{className:"text-[10px]",children:A})]})})(),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:3,value:ae,onChange:l=>ne(l.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:V.activity&&V.activity.length?V.activity.map((l,A)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[l.actor,l.actorRole?` • ${l.actorRole}`:""," • ",new Date(l.timestamp).toLocaleString()," • ",l.action]}),l.comment&&e.jsx("div",{className:"text-gray-600",children:l.comment})]},A)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Documents"}),e.jsxs("button",{className:"mt-2 px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-expanded":N,"aria-controls":"docs-panel",onClick:()=>G(l=>!l),children:[N?"Hide":"Show"," Documents"]}),e.jsx("div",{id:"docs-panel",className:N?"mt-3 space-y-2":"hidden",children:i.filter(l=>l.requestId===V.id&&l.type!=="request").map(l=>e.jsx(Rt,{doc:l,onView:r,onDelete:ye},l.id))}),!Ct(V,String((p==null?void 0:p.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:l=>{const A=l.target.files?Array.from(l.target.files):[];he(O=>[...O,...A]);try{l.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:z.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):z.map((l,A)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:l.name,children:l.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>he(O=>O.filter((te,Q)=>Q!==A)),children:"Delete"})]},A))})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>ge(null),children:"Close"}),Ct(V,String((p==null?void 0:p.id)||""))?e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-gold text-brand-charcoal hover:brightness-110",onClick:Le,children:"Archive"}):e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:me,disabled:!p||p.id!==((V==null?void 0:V.uploadedById)||""),children:"Save Changes"}),p&&ls(V,String((p==null?void 0:p.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>Ee(V),children:"Delete Request"})]})]})})]})},Cs=({currentUser:t,onClose:a})=>{const[i,h]=s.useState([]),[m,S]=s.useState(""),[w,y]=s.useState(!1),[R,P]=s.useState(""),[D,Y]=s.useState(!1),[j,J]=s.useState("");s.useEffect(()=>{vt().then(I=>{h(I.data||[])}).catch(()=>h([]))},[]);const H=s.useMemo(()=>String(t.role||"")!=="MEMBER",[t]),$=s.useMemo(()=>{const I=_=>{const g=t.unitUic||"",T=String(t.role||"");if(T.includes("PLATOON")){const u=_.company&&_.company!=="N/A"?_.company:"",C=_.platoon&&_.platoon!=="N/A"?_.platoon:"",L=t.company&&t.company!=="N/A"?t.company:"",M=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return u===L&&C===M}if(T.includes("COMPANY")){const u=_.company&&_.company!=="N/A"?_.company:"",C=t.company&&t.company!=="N/A"?t.company:"";return u===C}return T.includes("COMMANDER")?(_.unitUic||"")===g:!1};return i.filter(_=>_.id!==t.id&&I(_))},[i,t]),p=s.useMemo(()=>{const I=String(t.role||""),_=g=>{const T=t.unitUic||"";if(I.includes("PLATOON")){const u=g.company&&g.company!=="N/A"?g.company:"",C=g.platoon&&g.platoon!=="N/A"?g.platoon:"",L=t.company&&t.company!=="N/A"?t.company:"",M=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return u===L&&C===M}if(I.includes("COMPANY")){const u=g.company&&g.company!=="N/A"?g.company:"",C=t.company&&t.company!=="N/A"?t.company:"";return u===C}return I.includes("COMMANDER")?(g.unitUic||"")===T:!1};return i.filter(g=>g.id!==t.id&&_(g)&&String(g.role||"")===I)},[i,t]),ee=async()=>{try{y(!0),P("");const I=i.find(u=>u.id===m);if(!H||!I){y(!1);return}const _=String(t.role||""),g={...I};if(g.role=_,_.includes("PLATOON")){g.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A";const u=t.platoon&&t.platoon!=="N/A"?t.platoon:"N/A";g.rolePlatoon=u}else _.includes("COMPANY")?(g.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A",g.rolePlatoon="N/A"):_.includes("COMMANDER")&&(g.roleCompany="N/A",g.rolePlatoon="N/A");try{if(!(await He({id:g.id,email:g.email,rank:g.rank,firstName:g.firstName,lastName:g.lastName,mi:g.mi,service:g.service,role:g.role,unitUic:g.unitUic,unit:g.unit,company:g.company,isUnitAdmin:!!g.isUnitAdmin,isCommandStaff:!!g.isCommandStaff,edipi:g.edipi,passwordHash:g.passwordHash,roleCompany:g.roleCompany,rolePlatoon:g.rolePlatoon})).ok)throw new Error("persist_failed")}catch{P("Failed to persist user changes")}const T={actorId:t.id,actorRole:t.role,targetId:g.id,grantedRole:g.role,timestamp:new Date().toISOString(),scope:{unitUic:t.unitUic||"",company:t.company,unit:t.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)})}catch{}h(u=>u.map(C=>C.id===g.id?g:C)),S(""),Y(!1),y(!1)}catch{y(!1),P("Operation failed")}},B=async I=>{try{y(!0),P("");const _=i.find(L=>L.id===I);if(!_){y(!1);return}const g=String(t.role||"");if(!p.some(L=>L.id===I)){y(!1),P("Target not in scope");return}const u={..._};u.role="MEMBER",u.company="N/A",u.unit="N/A",u.isCommandStaff=!1,u.roleCompany="N/A",u.rolePlatoon="N/A";try{if(!(await He({id:u.id,email:u.email,rank:u.rank,firstName:u.firstName,lastName:u.lastName,mi:u.mi,service:u.service,role:u.role,unitUic:u.unitUic,unit:u.unit,company:u.company,isUnitAdmin:!!u.isUnitAdmin,isCommandStaff:!!u.isCommandStaff,edipi:u.edipi,passwordHash:u.passwordHash,roleCompany:u.roleCompany,rolePlatoon:u.rolePlatoon})).ok)throw new Error("persist_failed")}catch{P("Failed to persist user changes")}const C={actorId:t.id,actorRole:t.role,targetId:u.id,action:"Revoked",previousRole:g,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(C)})}catch{}h(L=>L.map(M=>M.id===u.id?u:M)),J(""),y(!1)}catch{y(!1),P("Operation failed")}};return H?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:a,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:I=>I.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:a,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:m,onChange:I=>S(I.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),$.map(I=>e.jsxs("option",{value:I.id,children:[I.rank," ",I.lastName,", ",I.firstName,I.mi?` ${I.mi}`:""," • ",I.email]},I.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[p.map(I=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[I.rank," ",I.lastName,", ",I.firstName,I.mi?` ${I.mi}`:""," • ",I.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>J(I.id),children:"Remove Access"})]},I.id)),p.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),R&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:R})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!m||w,onClick:()=>Y(!0),children:"Grant Equivalent Permission"})}),D&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>Y(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:w,onClick:ee,children:"Confirm"})]})]}),j&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>J(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:w,onClick:()=>B(j),children:"Remove"})]})]})]})}):null},dt="ORIGINATOR_REVIEW",Be=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],As=[{value:"PLATOON_REVIEW",label:"Platoon Review"},{value:"COMPANY_REVIEW",label:"Company Review"},{value:"BATTALION_REVIEW",label:"Battalion Review"},{value:"COMMANDER_REVIEW",label:"Commander Review"},{value:"ARCHIVED",label:"Archived"}],Es={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},ks=t=>{const a=Be.indexOf(t||Be[0]);return a>=0&&a<Be.length-1?Be[a+1]:Be[a]||Be[0]},mt=t=>{const a=Be.indexOf(t||Be[0]);return a>0?Be[a-1]:Be[0]},Is=t=>{const a=t.activity&&t.activity.length?t.activity[t.activity.length-1]:null;return!!a&&/returned/i.test(String(a.action||""))},rt=(t,a)=>{var i;return((i=t.activity)==null?void 0:i.some(h=>a.test(String(h.action||""))))||!1},Rs=t=>rt(t,/(approved by commander|commander.*approved)/i)&&!rt(t,/installation commander/i),Ms=t=>rt(t,/(endorsed by commander|commander.*endorsed)/i)&&!rt(t,/installation commander/i),ut=t=>{if(!t)return"MEMBER";const a=String(t.role||"MEMBER"),i=(t.roleCompany||t.company||"").trim(),h=(t.rolePlatoon||t.platoon||"").trim();switch(a){case"PLATOON_REVIEWER":if(i&&h)return`Platoon (${i}-${h})`;break;case"COMPANY_REVIEWER":if(i)return`Company (${i})`;break;case"BATTALION_REVIEWER":return"Battalion";case"COMMANDER_REVIEWER":return"Commander"}return a};function Ps(){const t=Kt(),[a,i]=s.useState(()=>{try{const o=localStorage.getItem("currentUser");return o?JSON.parse(o):null}catch(o){return console.error("Failed to parse user from localStorage:",o),null}}),[h,m]=s.useState([]),[S,w]=s.useState([]),[y,R]=s.useState({}),[P,D]=s.useState({}),[Y,j]=s.useState({}),[J,H]=s.useState({}),[$,p]=s.useState({}),[ee,B]=s.useState({}),[I,_]=s.useState({}),[g,T]=s.useState(!1),[u,C]=s.useState({}),[L,M]=s.useState({}),[W,f]=s.useState(!1),[b,U]=s.useState({}),[q,K]=s.useState(null),X=s.useRef(null),[V,ge]=s.useState("Pending"),[we,Se]=s.useState(Es),[v,Z]=s.useState(null);s.useEffect(()=>{const o=d=>{q&&X.current&&!X.current.contains(d.target)&&(U(F=>({...F,[q]:!1})),K(null))},r=d=>{d.key==="Escape"&&q&&(U(F=>({...F,[q]:!1})),K(null))};return document.addEventListener("mousedown",o),document.addEventListener("keydown",r),()=>{document.removeEventListener("mousedown",o),document.removeEventListener("keydown",r)}},[q]),s.useEffect(()=>{ns().then(o=>{m(o.data||[])}).catch(()=>m([]))},[]),s.useEffect(()=>{rs().then(o=>{w(o.data||[])}).catch(()=>w([]))},[]),s.useEffect(()=>{vt().then(o=>{const r={},d=o.data||[];for(const F of d)F!=null&&F.id&&(r[F.id]=F);D(r)}).catch(()=>D({}))},[]),s.useEffect(()=>{try{const o=localStorage.getItem("unit_structure"),r={},d={};if(o){const F=JSON.parse(o);for(const k of Object.keys(F||{})){const re=F[k];re&&Array.isArray(re._sections)&&(r[k]=re._sections),re&&re._platoonSectionMap&&typeof re._platoonSectionMap=="object"&&(d[k]=re._platoonSectionMap)}}else(async()=>{try{const F=await jt();for(const k of Object.keys(F||{})){const re=F[k];re&&Array.isArray(re._sections)&&(r[k]=re._sections),re&&re._platoonSectionMap&&typeof re._platoonSectionMap=="object"&&(d[k]=re._platoonSectionMap)}}catch{}})();B(r),_(d)}catch{}},[]);const ae=s.useMemo(()=>{const o=String((a==null?void 0:a.role)||"");return o.includes("PLATOON")?"PLATOON_REVIEW":o.includes("COMPANY")?"COMPANY_REVIEW":o.includes("BATTALION")?"BATTALION_REVIEW":o.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[a]),ne=o=>P[o.uploadedById]||null,z=o=>o&&o!=="N/A"?o.trim():"",he=o=>{var ye,Ee;const r=ne(o),d=o.unitUic||(r==null?void 0:r.unitUic)||"",F=String((a==null?void 0:a.role)||""),k=(a==null?void 0:a.unitUic)||"",re=(z(a==null?void 0:a.roleCompany)||z(a==null?void 0:a.company)).toUpperCase();if(F.includes("PLATOON")){if(!k||d!==k)return!1;const me=r?z(r.company).toUpperCase():"",ke=r?z(r.platoon).toUpperCase():"",Pe=(z(a==null?void 0:a.rolePlatoon)||z(a==null?void 0:a.platoon)).toUpperCase();return!re||!Pe||!me||!ke?!1:me===re&&ke===Pe}if(F.includes("COMPANY")){if(!k||d!==k)return!1;const me=r?z(r.company).toUpperCase():"";return!re||!me?!1:me===re}if(F.includes("BATTALION")){if(!k||d!==k)return!1;const me=z(a==null?void 0:a.company),ke=z(a==null?void 0:a.platoon),Pe=((Ee=(ye=I[k])==null?void 0:ye[me])==null?void 0:Ee[ke])||"";return o.routeSection&&Pe?o.routeSection===Pe:!0}return F.includes("COMMANDER")?!!k&&d===k:!0},N=s.useMemo(()=>(Array.isArray(h)?h:[]).filter(he),[h,a,P,I]),G=s.useMemo(()=>{const o=new Map;for(const r of N){const d=ne(r);if(d&&d.id&&!o.has(d.id)){const F=`${d.rank||""} ${d.lastName||""}, ${d.firstName||""}`.trim();o.set(d.id,{value:d.id,label:F||d.id})}}return Array.from(o.values()).sort((r,d)=>r.label.localeCompare(d.label))},[N,P]),de=ys(we,{items:N,getSearchText:o=>`${o.subject||""} ${o.id||""} ${o.routeSection||""}`,getStatus:o=>o.currentStage||"PLATOON_REVIEW",getDate:o=>o.createdAt,getOriginatorId:o=>o.uploadedById}),ce=s.useMemo(()=>de.filter(o=>(o.currentStage||"PLATOON_REVIEW")===ae),[de,ae]),le=s.useMemo(()=>de.filter(o=>(o.currentStage||"PLATOON_REVIEW")!==ae),[de,ae]),Ce=bt(ce,{pageSize:25}),je=bt(le,{pageSize:25}),Ae=o=>S.filter(r=>r.requestId===o),Me=s.useMemo(()=>[{header:"Request ID",getValue:o=>o.id},{header:"Subject",getValue:o=>o.subject},{header:"Stage",getValue:o=>o.currentStage||""},{header:"Route Section",getValue:o=>o.routeSection||""},{header:"Originator",getValue:o=>{const r=ne(o);return r?`${r.rank||""} ${r.lastName||""}, ${r.firstName||""}${r.mi?` ${r.mi}`:""}`.trim():""}},{header:"Unit UIC",getValue:o=>o.unitUic||""},{header:"Created At",getValue:o=>o.createdAt,format:kt},{header:"Due Date",getValue:o=>o.dueDate||"",format:kt},{header:"Documents",getValue:o=>Ae(o.id).map(r=>r.name).join(" | ")}],[P,S]),Ie=async(o,r,d)=>{const F=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",k=ut(a),re={actor:F,actorRole:k,timestamp:new Date().toISOString(),action:d,comment:(y[o.id]||"").trim()},ye={...o,currentStage:r,routeSection:r==="BATTALION_REVIEW"&&$[o.id]?$[o.id]:o.routeSection,activity:Array.isArray(o.activity)?[...o.activity,re]:[re]};try{await Fe(ye),d.toLowerCase().includes("approved")?t.success("Request approved",{message:`"${o.subject}" advanced to next stage`}):d.toLowerCase().includes("return")?t.warning("Request returned",{message:`"${o.subject}" sent back for revision`}):d.toLowerCase().includes("archive")?t.info("Request archived",{message:`"${o.subject}" has been archived`}):t.success(d,{message:`Request "${o.subject}" updated`}),m(Ee=>Ee.map(me=>me.id===ye.id?ye:me)),R(Ee=>({...Ee,[o.id]:""}))}catch(Ee){t.error("Failed to update request",{message:String(Ee)})}},Le=async o=>{const r=J[o.id]||[];if(!r.length||!(a!=null&&a.id))return;const d=Date.now(),F=r.map((me,ke)=>({id:`${d}-${ke}`,name:me.name,type:me.type,size:me.size,uploadedAt:new Date().toISOString(),subject:o.subject,requestId:o.id,fileUrl:URL.createObjectURL(me)})),k=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",re=ut(a),ye={actor:k,actorRole:re,timestamp:new Date().toISOString(),action:`Reviewer added ${F.length} document(s)`,comment:(y[o.id]||"").trim()},Ee={...o,documentIds:[...o.documentIds||[],...F.map(me=>me.id)],activity:Array.isArray(o.activity)?[...o.activity,ye]:[ye]};try{await pt(F),await Fe(Ee),t.success(`${F.length} file${F.length!==1?"s":""} added`,{message:`Documents added to "${o.subject}"`})}catch(me){t.error("Failed to add files",{message:String(me)})}w(me=>[...me,...F]),m(me=>me.map(ke=>ke.id===Ee.id?Ee:ke)),H(me=>({...me,[o.id]:[]})),R(me=>({...me,[o.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:ut(a)}),e.jsx(js,{items:[...ce,...le],columns:Me,filename:"review_requests",label:"Export",className:"hidden md:inline-flex"})]})]}),a&&String(a.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>T(!0),children:"Manage Permissions"})})]}),e.jsx(fs,{filters:we,onFiltersChange:Se,statusOptions:As,originatorOptions:G,searchPlaceholder:"Search requests by subject, ID, or section...",className:"mb-4"}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>ge("Pending"),className:`${V==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>ge("In Scope"),className:`${V==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[V==="Pending"&&e.jsx(Qe,{title:"Pending",requests:Ce.currentData,users:P,onRowClick:o=>C(r=>({...r,[o.id]:!r[o.id]})),expandedRows:u,platoonSectionMap:I,children:o=>e.jsxs("div",{id:`details-rev-${o.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!b[o.id],"aria-controls":`docs-rev-${o.id}`,onClick:()=>{U(r=>({...r,[o.id]:!r[o.id]})),K(r=>b[o.id]?null:o.id)},onKeyDown:r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),U(d=>({...d,[o.id]:!d[o.id]})),K(d=>b[o.id]?null:o.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${b[o.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${o.id}`,ref:b[o.id]?X:void 0,className:`${b[o.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(Ke,{documents:Ae(o.id).map(r=>({...r,fileUrl:r.fileUrl})),showIcons:!0,onPreview:r=>Z(Ae(o.id).find(d=>d.id===r.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>j(r=>({...r,[o.id]:!r[o.id]})),"aria-expanded":!!Y[o.id],"aria-controls":`logs-${o.id}`,children:[Y[o.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${o.id}`,className:Y[o.id]?"mt-2 space-y-2":"hidden",children:o.activity&&o.activity.length?o.activity.map((r,d)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[r.actor,r.actorRole?` • ${r.actorRole}`:""," • ",new Date(r.timestamp).toLocaleString()," • ",r.action]}),r.comment&&e.jsx("div",{className:"text-gray-600",children:r.comment})]},d)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:y[o.id]||"",onChange:r=>R(d=>({...d,[o.id]:r.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:r=>H(d=>({...d,[o.id]:r.target.files?Array.from(r.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(J[o.id]||[]).length?`${(J[o.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>Le(o),disabled:!J[o.id]||!(J[o.id]||[]).length,children:"Save Files"}),Is(o)&&e.jsx("div",{className:"ml-auto flex items-center gap-2",children:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Ie(o,o.currentStage==="PLATOON_REVIEW"?dt:mt(o.currentStage),"Returned to previous stage"),children:"Return to Previous"})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[String((a==null?void 0:a.role)||"").includes("COMPANY")&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:$[o.id]||"",onChange:r=>p(d=>({...d,[o.id]:r.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(ee[(a==null?void 0:a.unitUic)||""]||[]).map(r=>e.jsx("option",{value:r,children:r},r))]})]}),(()=>{const r=Rs(o),d=Ms(o);return r||d?e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Ie(o,o.currentStage==="PLATOON_REVIEW"?dt:mt(o.currentStage),"Returned to previous stage"),children:"Return to Previous"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(String((a==null?void 0:a.role)||"").includes("COMPANY")){if(!$[o.id])return;Ie(o,"BATTALION_REVIEW",`Approved and routed to ${$[o.id]}`)}else Ie(o,ks(o.currentStage),"Approved")},disabled:String((a==null?void 0:a.role)||"").includes("COMPANY")&&!$[o.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Ie(o,o.currentStage==="PLATOON_REVIEW"?dt:mt(o.currentStage),o.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),V==="In Scope"&&e.jsx(Qe,{title:"In Scope",requests:je.currentData,users:P,onRowClick:o=>C(r=>({...r,[o.id]:!r[o.id]})),expandedRows:u,platoonSectionMap:I,children:o=>e.jsxs("div",{id:`details-rev-${o.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!b[o.id],"aria-controls":`docs-rev-${o.id}`,onClick:()=>{U(r=>({...r,[o.id]:!r[o.id]})),K(r=>b[o.id]?null:o.id)},onKeyDown:r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),U(d=>({...d,[o.id]:!d[o.id]})),K(d=>b[o.id]?null:o.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${b[o.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${o.id}`,ref:b[o.id]?X:void 0,className:`${b[o.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(Ke,{documents:Ae(o.id).map(r=>({...r,fileUrl:r.fileUrl})),showIcons:!0,onPreview:r=>Z(Ae(o.id).find(d=>d.id===r.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>j(r=>({...r,[o.id]:!r[o.id]})),"aria-expanded":!!Y[o.id],"aria-controls":`logs-${o.id}`,children:[Y[o.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${o.id}`,className:Y[o.id]?"mt-2 space-y-2":"hidden",children:o.activity&&o.activity.length?o.activity.map((r,d)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[r.actor,r.actorRole?` • ${r.actorRole}`:""," • ",new Date(r.timestamp).toLocaleString()," • ",r.action]}),r.comment&&e.jsx("div",{className:"text-gray-600",children:r.comment})]},d)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),g&&a&&e.jsx(Cs,{currentUser:a,onClose:()=>T(!1)}),v&&v.fileUrl&&e.jsx(Ft,{url:v.fileUrl,fileName:v.name,mimeType:v.type,fileSize:v.size,isOpen:!!v,onClose:()=>Z(null)})]})}const Wt="MM",Ht="Manpower Management",zt="MMEA",Qt="Enlisted Personnel Assignments (General oversight)",Os={division_code:Wt,division_name:Ht,branch:zt,description:Qt},Ds=Object.freeze(Object.defineProperty({__proto__:null,branch:zt,default:Os,description:Qt,division_code:Wt,division_name:Ht},Symbol.toStringTag,{value:"Module"}));async function $s(){try{const t=Object.assign({"../hqmc-structure/MM__manpower-management__mmea.json":Ds}),a=[];for(const i of Object.values(t)){const h=(i==null?void 0:i.default)??i;if(h&&typeof h=="object"){const m=String(h.division_code||""),S=String(h.division_name||""),w=String(h.branch||""),y=h.description?String(h.description):void 0;m&&w&&a.push({division_code:m,division_name:S,branch:w,description:y})}}return a}catch{return[]}}function _s(){var L;const[t,a]=s.useState(null),[i,h]=s.useState([]),[m,S]=s.useState([]),[w,y]=s.useState(""),[R,P]=s.useState(""),[D,Y]=s.useState([]),[j,J]=s.useState(null),[H,$]=s.useState("structure"),[p,ee]=s.useState({}),[B,I]=s.useState({}),[_,g]=s.useState({});s.useEffect(()=>{try{const M=localStorage.getItem("currentUser");M&&a(JSON.parse(M))}catch{}$t().then(M=>{try{h(M.map(W=>({code:String(W.code||""),name:String(W.name||"")})))}catch{h([])}}),$s().then(M=>{S(M)}),Ue().then(M=>Y(M)).catch(()=>Y([])),Nt().then(M=>{const W={};for(const f of M){const b=`${f.division_code}::${f.branch}`;W[b]={reviewers:f.reviewers||[],approvers:f.approvers||[]}}ee(W)})},[]);const T=(t==null?void 0:t.hqmcDivision)||((L=i[0])==null?void 0:L.code)||"",u=s.useMemo(()=>i.find(M=>M.code===T),[i,T]),C=s.useMemo(()=>(Array.isArray(m)?m:[]).filter(M=>String(M.division_code||"")===T),[m,T]);return s.useMemo(()=>(Array.isArray(D)?D:[]).filter(M=>!!M.isHqmcAdmin&&String(M.hqmcDivision||"")===T),[D,T]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(t!=null&&t.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",u?`${u.code} — ${u.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>$("structure"),className:`${H==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>$("permissions"),className:`${H==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),H==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"})]})}),e.jsxs("tbody",{children:[C.map(M=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:M.branch}),e.jsx("td",{className:"py-2 px-3",children:M.description||""})]},M.branch)),C.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:w,onChange:M=>y(M.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:R,onChange:M=>P(M.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!w.trim(),onClick:async()=>{var M;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:T,division_name:((M=i.find(f=>f.code===T))==null?void 0:M.name)||"",branch:w.trim(),description:R.trim()})});const W=await fetch("/api/hqmc-structure").then(f=>f.json());S(W),y(""),P("")}catch{}},children:"Add"})]})]})]}),H==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const M of C){const W=`${T}::${M.branch}`,f=p[W]||{reviewers:[],approvers:[]};await _t({division_code:T,branch:M.branch,reviewers:f.reviewers,approvers:f.approvers})}J({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:C.map(M=>{const W=`${T}::${M.branch}`,f=p[W]||{reviewers:[],approvers:[]},b=U=>`${U.rank||""} ${U.lastName||""}, ${U.firstName||""}${U.mi?" "+U.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:M.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:B[W]||"",onChange:U=>I(q=>({...q,[W]:U.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!B[W],onClick:async()=>{const U=(B[W]||"").trim();if(!U)return;const{user:q}=await xt(U);if(!(q!=null&&q.id)){J({type:"error",message:`No user found for EDIPI ${U}`});return}ee(K=>({...K,[W]:{...f,reviewers:Array.from(new Set([...f.reviewers||[],q.id]))}})),I(K=>({...K,[W]:""})),J({type:"success",message:`Added reviewer ${q.lastName||""}, ${q.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(f.reviewers||[]).map(U=>{const q=D.find(K=>K.id===U);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:q?b(q):U}),e.jsx("button",{className:"text-red-600",onClick:()=>ee(K=>({...K,[W]:{...f,reviewers:(f.reviewers||[]).filter(X=>X!==U)}})),children:"✕"})]},U)}),(f.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:_[W]||"",onChange:U=>g(q=>({...q,[W]:U.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!_[W],onClick:async()=>{const U=(_[W]||"").trim();if(!U)return;const{user:q}=await xt(U);if(!(q!=null&&q.id)){J({type:"error",message:`No user found for EDIPI ${U}`});return}ee(K=>({...K,[W]:{...f,approvers:Array.from(new Set([...f.approvers||[],q.id]))}})),g(K=>({...K,[W]:""})),J({type:"success",message:`Added approver ${q.lastName||""}, ${q.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(f.approvers||[]).map(U=>{const q=D.find(K=>K.id===U);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:q?b(q):U}),e.jsx("button",{className:"text-red-600",onClick:()=>ee(K=>({...K,[W]:{...f,approvers:(f.approvers||[]).filter(X=>X!==U)}})),children:"✕"})]},U)}),(f.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},W)})})]})})]}),j&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${j.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:j.message})]})}const tt=(t,a)=>`${t}::${a}`;function Ls({currentUser:t,divisionCode:a,branches:i,assignments:h,onClose:m}){const[S,w]=s.useState([]),[y,R]=s.useState(""),[P,D]=s.useState(""),[Y,j]=s.useState("reviewer"),[J,H]=s.useState(!1);s.useEffect(()=>{vt().then(u=>w(u)).catch(()=>w([]))},[]);const $=s.useMemo(()=>{const u={};for(const C of h)u[tt(C.division_code,C.branch)]={reviewers:C.reviewers||[],approvers:C.approvers||[]};return u},[h]),p=String(t.id||""),ee=s.useMemo(()=>{if(!y)return!1;const u=$[tt(a,y)]||{reviewers:[],approvers:[]};return(u.reviewers||[]).includes(p)||(u.approvers||[]).includes(p)||!!t.isHqmcAdmin},[y,$,p,t]),B=s.useMemo(()=>S.filter(u=>String(u.hqmcDivision||"")===String(a||"")&&String(u.id||"")!==p),[S,a,p]),I=s.useMemo(()=>{if(!y)return[];const u=$[tt(a,y)]||{reviewers:[],approvers:[]};return Array.from(new Set([...u.reviewers||[],...u.approvers||[]])).map(L=>B.find(M=>M.id===L)).filter(Boolean)},[y,$,B,a]),_=async u=>{H(!0);try{await _t({division_code:a,branch:y,reviewers:u.reviewers,approvers:u.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:t.id,scope:{hqmcDivision:a,branch:y},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{H(!1)}},g=async()=>{if(!ee||!y||!P)return;const u=$[tt(a,y)]||{reviewers:[],approvers:[]},C={reviewers:Array.from(new Set(u.reviewers||[])),approvers:Array.from(new Set(u.approvers||[]))};Y==="reviewer"?C.reviewers=Array.from(new Set([...C.reviewers,P])):C.approvers=Array.from(new Set([...C.approvers,P])),await _(C),D("")},T=async u=>{if(!ee||!y)return;const C=$[tt(a,y)]||{reviewers:[],approvers:[]},L={reviewers:(C.reviewers||[]).filter(M=>M!==u),approvers:(C.approvers||[]).filter(M=>M!==u)};await _(L)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:m,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:u=>u.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:m,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:y,onChange:u=>R(u.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),i.map(u=>e.jsx("option",{value:u,children:u},u))]})]}),y&&!ee&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),y&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:P,onChange:u=>D(u.target.value),disabled:!ee,children:[e.jsx("option",{value:"",children:"Choose user"}),B.map(u=>e.jsxs("option",{value:u.id,children:[u.rank," ",u.lastName,", ",u.firstName,u.mi?` ${u.mi}`:""," • ",u.email]},u.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:Y,onChange:u=>j(u.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!ee||!P||J,onClick:g,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[I.map(u=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[u.rank," ",u.lastName,", ",u.firstName,u.mi?` ${u.mi}`:""," • ",u.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!ee||J,onClick:()=>T(u.id),children:"Remove"})]},u.id)),I.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}const at=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],qs=t=>{const a=at.indexOf(t||at[0]);return a>0?at[a-1]:at[0]};function Ts(){const[t,a]=s.useState(()=>{try{const N=localStorage.getItem("currentUser");return N?JSON.parse(N):null}catch{return null}}),[i,h]=s.useState([]),[m,S]=s.useState([]),[w,y]=s.useState({}),[R,P]=s.useState({}),[D,Y]=s.useState({}),[j,J]=s.useState({}),[H,$]=s.useState(null),p=s.useRef(null),[ee,B]=s.useState([]),[I,_]=s.useState("Pending"),[g,T]=s.useState([]),[u,C]=s.useState({}),[L,M]=s.useState(!1);s.useEffect(()=>{const N=de=>{H&&p.current&&!p.current.contains(de.target)&&(J(ce=>({...ce,[H]:!1})),$(null))},G=de=>{de.key==="Escape"&&H&&(J(ce=>({...ce,[H]:!1})),$(null))};return document.addEventListener("mousedown",N),document.addEventListener("keydown",G),()=>{document.removeEventListener("mousedown",N),document.removeEventListener("keydown",G)}},[H]),s.useEffect(()=>{it().then(N=>h(N)).catch(()=>h([]))},[]),s.useEffect(()=>{yt().then(N=>S(N)).catch(()=>S([]))},[]),s.useEffect(()=>{Ue().then(N=>{const G={};for(const de of N)de!=null&&de.id&&(G[de.id]=de);P(G)}).catch(()=>P({}))},[]),s.useEffect(()=>{Nt().then(B).catch(()=>B([]))},[]),s.useEffect(()=>{is().then(T).catch(()=>T([]))},[]);const W=(t==null?void 0:t.id)||"",f=String((t==null?void 0:t.hqmcDivision)||""),b=s.useMemo(()=>ee.filter(N=>N.division_code===f&&((N.reviewers||[]).includes(W)||(N.approvers||[]).includes(W))).map(N=>N.branch),[ee,f,W]),U=N=>R[N.uploadedById]||null,q=N=>{if(!f||!W)return!1;const G=String(N.routeSection||"");return b.includes(G)},K=s.useMemo(()=>(Array.isArray(i)?i:[]).filter(q),[i,b]),X=s.useMemo(()=>K.filter(N=>(N.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[K]),V=s.useMemo(()=>K.filter(N=>(N.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[K]),ge=N=>m.filter(G=>G.requestId===N),we=N=>`"${String(N??"").replace(/"/g,'""')}"`,Se=N=>{const de=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const ce of N){const le=U(ce),Ce=le?`${le.rank} ${le.lastName}, ${le.firstName}${le.mi?` ${le.mi}`:""}`:"",je=ge(ce.id).map(Ae=>Ae.name).join(" | ");de.push([ce.id,ce.subject,ce.currentStage||"",ce.routeSection||"",Ce,ce.unitUic||"",new Date(ce.createdAt).toLocaleString(),je])}return de.map(ce=>ce.map(we).join(",")).join(`\r
`)},v=(N,G)=>{const de=new Blob([G],{type:"text/csv;charset=utf-8;"}),ce=URL.createObjectURL(de),le=document.createElement("a");le.href=ce,le.download=N,document.body.appendChild(le),le.click(),document.body.removeChild(le),URL.revokeObjectURL(ce)},Z=()=>v("hqmc_pending.csv",Se(X)),ae=()=>v("hqmc_in_scope.csv",Se(V)),ne=()=>v("hqmc_all.csv",Se([...X,...V])),z=async N=>{const G=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",de=String(u[N.id]||"").trim();if(!de){alert("Select an HQMC section to route to approver");return}const ce={actor:G,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${de}`,comment:(w[N.id]||"").trim()},le={...N,routeSection:de,activity:Array.isArray(N.activity)?[...N.activity,ce]:[ce]};try{await Fe(le)}catch{}h(Ce=>Ce.map(je=>je.id===le.id?le:je)),y(Ce=>({...Ce,[N.id]:""}))},he=async N=>{const de={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC",comment:(w[N.id]||"").trim()},ce={...N,currentStage:qs(N.currentStage),activity:Array.isArray(N.activity)?[...N.activity,de]:[de]};try{await Fe(ce)}catch{}h(le=>le.map(Ce=>Ce.id===ce.id?ce:Ce)),y(le=>({...le,[N.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:f||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ne,children:"Export All"}),b.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>M(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>_("Pending"),className:`${I==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>_("In Scope"),className:`${I==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[I==="Pending"&&e.jsx(Qe,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Z,children:"Export Pending"}),requests:X,users:R,onRowClick:N=>Y(G=>({...G,[N.id]:!G[N.id]})),expandedRows:D,children:N=>e.jsxs("div",{id:`details-hq-${N.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[N.id],"aria-controls":`docs-hq-${N.id}`,onClick:()=>{J(G=>({...G,[N.id]:!G[N.id]})),$(G=>j[N.id]?null:N.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[N.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${N.id}`,ref:j[N.id]?p:void 0,className:`${j[N.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(Ke,{documents:ge(N.id).map(G=>({...G,fileUrl:G.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:w[N.id]||"",onChange:G=>y(de=>({...de,[N.id]:G.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:u[N.id]||"",onChange:G=>C(de=>({...de,[N.id]:G.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),g.filter(G=>String(G.division_code||"")===f).map(G=>e.jsx("option",{value:G.branch,children:G.branch},G.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>z(N),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>he(N),children:"Return"})]})]})]})}),I==="In Scope"&&e.jsx(Qe,{title:"In Scope",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ae,children:"Export In Scope"}),requests:V,users:R,onRowClick:N=>Y(G=>({...G,[N.id]:!G[N.id]})),expandedRows:D,children:N=>e.jsxs("div",{id:`details-hq-${N.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[N.id],"aria-controls":`docs-hq-${N.id}`,onClick:()=>{J(G=>({...G,[N.id]:!G[N.id]})),$(G=>j[N.id]?null:N.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[N.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${N.id}`,ref:j[N.id]?p:void 0,className:`${j[N.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(Ke,{documents:ge(N.id).map(G=>({...G,fileUrl:G.fileUrl}))})})]})})]})]}),L&&t&&e.jsx(Ls,{currentUser:t,divisionCode:f,branches:g.filter(N=>String(N.division_code||"")===f).map(N=>N.branch),assignments:ee,onClose:()=>M(!1)})]})}const nt=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Bs=t=>{const a=nt.indexOf(t||nt[0]);return a>0?nt[a-1]:nt[0]};function Fs(){const[t,a]=s.useState(()=>{try{const v=localStorage.getItem("currentUser");return v?JSON.parse(v):null}catch{return null}}),[i,h]=s.useState([]),[m,S]=s.useState([]),[w,y]=s.useState({}),[R,P]=s.useState({}),[D,Y]=s.useState({}),[j,J]=s.useState({}),[H,$]=s.useState(null),p=s.useRef(null),[ee,B]=s.useState([]),[I,_]=s.useState("Pending");s.useEffect(()=>{const v=ae=>{H&&p.current&&!p.current.contains(ae.target)&&(J(ne=>({...ne,[H]:!1})),$(null))},Z=ae=>{ae.key==="Escape"&&H&&(J(ne=>({...ne,[H]:!1})),$(null))};return document.addEventListener("mousedown",v),document.addEventListener("keydown",Z),()=>{document.removeEventListener("mousedown",v),document.removeEventListener("keydown",Z)}},[H]),s.useEffect(()=>{it().then(v=>h(v)).catch(()=>h([]))},[]),s.useEffect(()=>{yt().then(v=>S(v)).catch(()=>S([]))},[]),s.useEffect(()=>{Ue().then(v=>{const Z={};for(const ae of v)ae!=null&&ae.id&&(Z[ae.id]=ae);P(Z)}).catch(()=>P({}))},[]),s.useEffect(()=>{Nt().then(B).catch(()=>B([]))},[]);const g=(t==null?void 0:t.id)||"",T=String((t==null?void 0:t.hqmcDivision)||""),u=s.useMemo(()=>ee.filter(v=>v.division_code===T&&(v.approvers||[]).includes(g)).map(v=>v.branch),[ee,T,g]),C=v=>R[v.uploadedById]||null,L=v=>{if(!T||!g)return!1;const Z=String(v.routeSection||"");return u.includes(Z)},M=s.useMemo(()=>(Array.isArray(i)?i:[]).filter(L),[i,u]),W=s.useMemo(()=>M.filter(v=>(v.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[M]),f=s.useMemo(()=>M.filter(v=>(v.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[M]),b=v=>m.filter(Z=>Z.requestId===v),U=v=>`"${String(v??"").replace(/"/g,'""')}"`,q=v=>{const ae=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const ne of v){const z=C(ne),he=z?`${z.rank} ${z.lastName}, ${z.firstName}${z.mi?` ${z.mi}`:""}`:"",N=b(ne.id).map(G=>G.name).join(" | ");ae.push([ne.id,ne.subject,ne.currentStage||"",ne.routeSection||"",he,ne.unitUic||"",new Date(ne.createdAt).toLocaleString(),N])}return ae.map(ne=>ne.map(U).join(",")).join(`\r
`)},K=(v,Z)=>{const ae=new Blob([Z],{type:"text/csv;charset=utf-8;"}),ne=URL.createObjectURL(ae),z=document.createElement("a");z.href=ne,z.download=v,document.body.appendChild(z),z.click(),document.body.removeChild(z),URL.revokeObjectURL(ne)},X=()=>K("hqmc_approver_pending.csv",q(W)),V=()=>K("hqmc_approver_approved.csv",q(f)),ge=()=>K("hqmc_approver_all.csv",q([...W,...f])),we=async v=>{const ae={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved",comment:(w[v.id]||"").trim()},ne={...v,currentStage:"ARCHIVED",activity:Array.isArray(v.activity)?[...v.activity,ae]:[ae]};try{await Fe(ne)}catch{}h(z=>z.map(he=>he.id===ne.id?ne:he)),y(z=>({...z,[v.id]:""}))},Se=async v=>{const ae={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver",comment:(w[v.id]||"").trim()},ne={...v,currentStage:Bs(v.currentStage),activity:Array.isArray(v.activity)?[...v.activity,ae]:[ae]};try{await Fe(ne)}catch{}h(z=>z.map(he=>he.id===ne.id?ne:he)),y(z=>({...z,[v.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((t==null?void 0:t.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ge,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>_("Pending"),className:`${I==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>_("Approved"),className:`${I==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"})]})}),e.jsxs("div",{className:"mt-4",children:[I==="Pending"&&e.jsx(Qe,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:X,children:"Export Pending"}),requests:W,users:R,onRowClick:v=>Y(Z=>({...Z,[v.id]:!Z[v.id]})),expandedRows:D,children:v=>e.jsxs("div",{id:`details-hqa-${v.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[v.id],"aria-controls":`docs-hqa-${v.id}`,onClick:()=>{J(Z=>({...Z,[v.id]:!Z[v.id]})),$(Z=>j[v.id]?null:v.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[v.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${v.id}`,ref:j[v.id]?p:void 0,className:`${j[v.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(Ke,{documents:b(v.id).map(Z=>({...Z,fileUrl:Z.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:w[v.id]||"",onChange:Z=>y(ae=>({...ae,[v.id]:Z.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>we(v),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>Se(v),children:"Return"})]})]})}),I==="Approved"&&e.jsx(Qe,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:V,children:"Export Approved"}),requests:f,users:R,onRowClick:v=>Y(Z=>({...Z,[v.id]:!Z[v.id]})),expandedRows:D,children:v=>e.jsxs("div",{id:`details-hqa-${v.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[v.id],"aria-controls":`docs-hqa-${v.id}`,onClick:()=>{J(Z=>({...Z,[v.id]:!Z[v.id]})),$(Z=>j[v.id]?null:v.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[v.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${v.id}`,ref:j[v.id]?p:void 0,className:`${j[v.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(Ke,{documents:b(v.id).map(Z=>({...Z,fileUrl:Z.fileUrl}))})})]})})]})]})})}const Vs=({onUnitSelect:t,selectedUnit:a})=>{const[i,h]=s.useState(""),[m,S]=s.useState(!1),w=Ve.filter(R=>R.unitName.toLowerCase().startsWith(i.toLowerCase())||R.uic.toLowerCase().startsWith(i.toLowerCase())||R.ruc.toLowerCase().startsWith(i.toLowerCase())),y=R=>{t(R),S(!1),h("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>S(!m),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[a?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",a.uic," | RUC: ",a.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),m&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:i,onChange:R=>h(R.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:w.map(R=>e.jsxs("button",{type:"button",onClick:()=>y(R),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:R.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",R.uic," | RUC: ",R.ruc," | MCC: ",R.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[R.streetAddress,", ",R.cityState," ",R.zip]})]},R.uic))})]})]})]})},ft=async t=>{const i=new TextEncoder().encode(t),h=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(h)).map(m=>m.toString(16).padStart(2,"0")).join("")};async function Ws(t,a){const i=os();return i!=null&&i.auth?await i.auth.signUp({email:t,password:a}):{data:null,error:new Error("supabase_not_initialized")}}const Mt={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},Hs=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Ut=({onSaved:t,initial:a={},mode:i="create",readOnly:h=!1,canEditRole:m=!1,canEditAdmin:S=!1})=>{const[w,y]=s.useState(""),[R,P]=s.useState(""),[D,Y]=s.useState(""),[j,J]=s.useState(a.email||""),[H,$]=s.useState(a.edipi||""),[p,ee]=s.useState(a.service||""),[B,I]=s.useState(a.rank||""),[_,g]=s.useState(a.role||"MEMBER"),[T,u]=s.useState(!!a.isUnitAdmin),[C,L]=s.useState(a.company||""),[M,W]=s.useState(a.platoon||""),[f,b]=s.useState(void 0),[U,q]=s.useState(null),[K,X]=s.useState({}),[V,ge]=s.useState(""),[we,Se]=s.useState(""),[v,Z]=s.useState([]),[ae,ne]=s.useState(!1),[z,he]=s.useState(a.roleCompany||""),[N,G]=s.useState(a.rolePlatoon||""),[de,ce]=s.useState(!1),[le,Ce]=s.useState([]),[je,Ae]=s.useState([]),[Me,Ie]=s.useState([]),[Le,o]=s.useState([]);s.useEffect(()=>{if(a.firstName&&y(String(a.firstName)),a.lastName&&P(String(a.lastName)),a.mi&&Y(String(a.mi)),a.company&&L(String(a.company)),a.platoon&&W(String(a.platoon)),a.roleCompany&&he(String(a.roleCompany)),a.rolePlatoon&&G(String(a.rolePlatoon)),a.unitUic){const x=Ve.find(oe=>oe.uic===a.unitUic);x&&b(x)}},[a]);const r=s.useMemo(()=>Mt[p]||[],[p]),d=s.useMemo(()=>{if(!f)return[];const x=le;if(x&&x.length)return x;const oe=K[f.uic]||{};return Object.keys(oe).filter(l=>!l.startsWith("_")&&Array.isArray(oe[l]))},[f,K,le]),F=s.useMemo(()=>{var x;return f&&C?((x=K[f.uic])==null?void 0:x[C])||[]:[]},[f,C,K]),k=s.useMemo(()=>{if(!f||!C)return[];const x=je;return x&&x.length?x:F},[f,C,je,F]),re=s.useMemo(()=>{if(!f)return[];const x=Me;if(x&&x.length)return x;const oe=K[f.uic]||{};return Object.keys(oe).filter(l=>!l.startsWith("_")&&Array.isArray(oe[l]))},[f,K,Me]),ye=s.useMemo(()=>{var x;return f&&z?((x=K[f.uic])==null?void 0:x[z])||[]:[]},[f,z,K]),Ee=s.useMemo(()=>{if(!f||!z)return[];const x=Le;return x&&x.length?x:ye},[f,z,Le,ye]),me=s.useMemo(()=>{const x=d.slice(),oe=C||a.company||a.user_company||"";return oe&&!x.includes(oe)?[oe,...x]:x},[d,C,a]),ke=s.useMemo(()=>{const x=k.slice(),oe=M||a.platoon||a.user_platoon||"";return oe&&!x.includes(oe)?[oe,...x]:x},[k,M,a]),Pe=s.useMemo(()=>{const x=re.slice(),oe=z||a.roleCompany||"",l=oe&&!x.includes(oe)?[oe,...x]:x;return Array.from(new Set(l))},[re,z,a]),We=s.useMemo(()=>{const x=Ee.slice(),oe=N||a.rolePlatoon||"";return oe&&!x.includes(oe)?[oe,...x]:x},[Ee,N,a]);s.useEffect(()=>{(async()=>{try{if(i==="edit"&&a.id){const x=await Lt(String(a.id));x&&(x.company&&!C&&L(String(x.company)),x.platoon&&!M&&W(String(x.platoon)),x.roleCompany&&!z&&he(String(x.roleCompany)),x.rolePlatoon&&!N&&G(String(x.rolePlatoon)))}}catch{}})()},[i,a.id]),s.useEffect(()=>{r.includes(B)||I("")},[r]),s.useEffect(()=>{W("")},[C]),s.useEffect(()=>{G("")},[z]),s.useEffect(()=>{try{const x=localStorage.getItem("unit_structure");x&&X(JSON.parse(x))}catch{}},[f]),s.useEffect(()=>{const x=(f==null?void 0:f.uic)||"";if(!x){Ce([]),Ie([]);return}qt(x).then(oe=>{Ce(oe||[]),Ie(oe||[])}).catch(()=>{Ce([]),Ie([])})},[f]),s.useEffect(()=>{const x=(f==null?void 0:f.uic)||"",oe=C||"";if(!x||!oe){Ae([]);return}ht(x,oe).then(l=>Ae(l||[])).catch(()=>Ae([]))},[f,C]),s.useEffect(()=>{const x=(f==null?void 0:f.uic)||"",oe=z||"";if(!x||!oe){o([]);return}ht(x,oe).then(l=>o(l||[])).catch(()=>o([]))},[f,z]),s.useEffect(()=>{Ue().then(x=>{Z(x)}).catch(()=>Z([]))},[]),s.useEffect(()=>{const x=(f==null?void 0:f.uic)||"";if(!x){ne(!1);return}const oe=v.some(l=>!!l.isUnitAdmin&&(l.unitUic||"")===x);ne(oe)},[f,v]),s.useEffect(()=>{if(f){!C&&a.company&&me.includes(a.company)&&L(String(a.company));const x=a.platoon;!M&&x&&ke.includes(x)&&W(String(x))}},[f,me,ke,C,M,a]);const Ge=x=>/^[0-9]{10}$/.test(x),Je=(x,oe)=>{try{return v.some(l=>String(l.edipi)===String(x)&&String(l.id)!==String(oe||""))}catch{return!1}},Ne=async x=>{var O,te;if(x.preventDefault(),q(null),h)return;if(!w.trim())return q({type:"error",message:"First name is required."});if(!R.trim())return q({type:"error",message:"Last name is required."});if(D&&!/^[A-Za-z]$/.test(D))return q({type:"error",message:"MI must be a single letter."});if(!j.trim())return q({type:"error",message:"Email is required."});if(!Ge(String(H)))return q({type:"error",message:"EDIPI must be 10 digits."});if(!p)return q({type:"error",message:"Service is required."});if(!B)return q({type:"error",message:"Rank is required."});if(Je(String(H),a.id?String(a.id):void 0))return q({type:"error",message:"EDIPI already exists."});if(_==="COMPANY_REVIEWER"&&!z)return q({type:"error",message:"Role Company is required for Company Reviewer."});if(_==="PLATOON_REVIEWER"&&(!z||!N))return q({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${w.trim()}`,D&&""+D.trim().toUpperCase(),`${R.trim()}`;let oe=a.id?String(a.id):`usr-${Date.now()}`,l=a.passwordHash||"";if(i==="create"){if(!V||V.length<8)return q({type:"error",message:"Password must be at least 8 characters."});if(V!==we)return q({type:"error",message:"Passwords do not match."});try{const{data:Q,error:xe}=await Ws(j.trim(),V);if(xe){q({type:"error",message:`Failed to create auth user: ${String(xe.message||xe)}`});return}const ue=(O=Q==null?void 0:Q.user)!=null&&O.id?String(Q.user.id):"";if(!ue){q({type:"error",message:"Auth user ID missing after sign up."});return}oe=ue}catch(Q){q({type:"error",message:`Failed to create auth user: ${String((Q==null?void 0:Q.message)||Q)}`});return}l=await ft(V)}else if(i==="edit"&&V){if(V.length<8)return q({type:"error",message:"Password must be at least 8 characters."});if(V!==we)return q({type:"error",message:"Passwords do not match."});l=await ft(V)}const A={id:oe,firstName:w.trim(),lastName:R.trim(),mi:D?D.trim().toUpperCase():void 0,email:j.trim(),edipi:H,service:p,rank:B,role:_,company:C||"N/A",unit:(f==null?void 0:f.unitName)||"N/A",unitUic:f==null?void 0:f.uic,passwordHash:l,isUnitAdmin:i==="create"&&f&&!ae?!0:T,roleCompany:z||void 0,rolePlatoon:N||void 0,platoon:M||"N/A"};try{const Q=await He({id:A.id,email:A.email,rank:A.rank,firstName:A.firstName,lastName:A.lastName,mi:A.mi,service:A.service,role:A.role,unitUic:A.unitUic,unit:(f==null?void 0:f.unitName)||"N/A",company:A.company,isUnitAdmin:!!A.isUnitAdmin,edipi:String(A.edipi),passwordHash:l,platoon:M||"N/A",roleCompany:z||void 0,rolePlatoon:N||void 0});if(!Q.ok){q({type:"error",message:`Failed to save profile: ${String(((te=Q==null?void 0:Q.error)==null?void 0:te.message)||(Q==null?void 0:Q.error)||"unknown")}`});return}q({type:"success",message:a.id?"Profile updated.":f&&!ae?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),t==null||t(A)}catch{q({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:i==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:Ne,className:"space-y-6",children:[i==="create"&&f&&!ae&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:f.unitName})," (UIC ",f.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:R,onChange:x=>P(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:w,onChange:x=>y(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:D,maxLength:1,onChange:x=>Y(x.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:j,onChange:x=>J(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:H,onChange:x=>$(x.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:p,onChange:x=>ee(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(Mt).map(x=>e.jsx("option",{value:x,children:x},x))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:B,onChange:x=>I(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),r.map(x=>e.jsx("option",{value:x,children:x},x))]})]}),i==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:V,onChange:x=>ge(x.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:we,onChange:x=>Se(x.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]})]}):e.jsx(e.Fragment,{})]})]}),de&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:V,onChange:x=>ge(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:we,onChange:x=>Se(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:h})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>ce(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>ce(!1),children:"Save"})]})]})}),i==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:_,onChange:x=>g(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:Hs.map(x=>e.jsx("option",{value:x,children:x},x))})}),e.jsx("div",{children:e.jsxs("select",{value:z||String(a.roleCompany||""),onChange:x=>he(x.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Pe.length?"Select company":"No companies configured"}),Pe.map(x=>e.jsx("option",{value:x,children:x},x))]})}),e.jsx("div",{children:e.jsxs("select",{value:N||String(a.rolePlatoon||""),onChange:x=>G(x.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:We.length?"Select platoon":"No platoons configured"}),We.map(x=>e.jsx("option",{value:x,children:x},x))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:T,onChange:x=>u(x.target.checked),disabled:h||!S}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(a==null?void 0:a.isCommandStaff)||_==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Command Sections Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(Vs,{onUnitSelect:x=>b(x),selectedUnit:f})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:C||String(a.company||""),onChange:x=>L(x.target.value),disabled:h||!f||me.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:me.length?"Select company":"No companies configured"}),me.map(x=>e.jsx("option",{value:x,children:x},x))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:M||String(a.platoon||""),onChange:x=>W(x.target.value),disabled:h||!f||!C||ke.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:ke.length?"Select platoon":"No platoons configured"}),ke.map(x=>e.jsx("option",{value:x,children:x},x))]})]})]})})]}),U&&e.jsx("div",{className:`p-3 rounded-lg border ${U.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:U.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[i==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>ce(!0),disabled:h,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:h,children:i==="edit"?"Save":"Create Profile"})]})]})]})},zs=s.memo(function({user:a,onClose:i}){const h=()=>{const m=Ve.find(w=>w.uic===a.unitUic),S=m?m.unitName:a.unit;if(a.isUnitAdmin||a.role==="COMMANDER")return S||"—";if(a.role==="COMPANY_REVIEWER")return a.company&&a.company!=="N/A"?a.company:"—";if(a.role==="PLATOON_REVIEWER"){const w=a.company&&a.company!=="N/A"?a.company:"",y=a.platoon&&a.platoon!=="N/A"?a.platoon:"",R=[w,y].filter(Boolean);return R.length?R.join(" / "):"—"}return"—"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:i,children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:a.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:a.edipi||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:a.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:a.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:h()})]}),a.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),a.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:i,children:"Close"})})]})})}),Qs=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Us=()=>{const[t,a]=s.useState(null),[i,h]=s.useState(void 0),[m,S]=s.useState({}),[w,y]=s.useState({}),[R,P]=s.useState({}),[D,Y]=s.useState({}),[j,J]=s.useState(""),[H,$]=s.useState(""),[p,ee]=s.useState(""),[B,I]=s.useState(""),[_,g]=s.useState(""),[T,u]=s.useState([]),[C,L]=s.useState(null),[M,W]=s.useState(""),f=s.useRef(null),[b,U]=s.useState(null),[q,K]=s.useState(null),[X,V]=s.useState(""),[ge,we]=s.useState(void 0),[Se,v]=s.useState(void 0),[Z,ae]=s.useState(void 0),[ne,z]=s.useState(void 0),[he,N]=s.useState(void 0),[G,de]=s.useState(void 0),[ce,le]=s.useState([]),[Ce,je]=s.useState([]),[Ae,Me]=s.useState(""),[Ie,Le]=s.useState("unit"),[o,r]=s.useState([]),[d,F]=s.useState(!1),[k,re]=s.useState(!1),[ye,Ee]=s.useState(!1),[me,ke]=s.useState("admin"),Pe=s.useRef(!1);s.useEffect(()=>{b&&me==="admin"&&!Pe.current&&(!ge&&b.company&&b.company!=="N/A"&&(we(b.company),ae(b.company)),!Se&&b.platoon&&b.platoon!=="N/A"&&(v(b.platoon),z(b.platoon)),!he&&b.roleCompany&&b.roleCompany!=="N/A"&&N(b.roleCompany),!G&&b.rolePlatoon&&b.rolePlatoon!=="N/A"&&de(b.rolePlatoon),Pe.current=!0)},[b,me]),s.useEffect(()=>{try{const n=localStorage.getItem("unit_structure");n&&S(JSON.parse(n))}catch{}try{const n=localStorage.getItem("unit_structure"),c={},E={},se={};if(n){const fe=JSON.parse(n);for(const ve of Object.keys(fe||{})){const ie=fe[ve];ie&&Array.isArray(ie._sections)&&(c[ve]=ie._sections),ie&&Array.isArray(ie._commandSections)&&(E[ve]=ie._commandSections),ie&&ie._platoonSectionMap&&typeof ie._platoonSectionMap=="object"&&(se[ve]=ie._platoonSectionMap)}}else(async()=>{try{const fe=await jt();for(const ve of Object.keys(fe||{})){const ie=fe[ve];ie&&Array.isArray(ie._sections)&&(c[ve]=ie._sections),ie&&Array.isArray(ie._commandSections)&&(E[ve]=ie._commandSections),ie&&ie._platoonSectionMap&&typeof ie._platoonSectionMap=="object"&&(se[ve]=ie._platoonSectionMap)}S(fe)}catch{}})();y(c),P(E),Y(se)}catch{}Ue().then(n=>{u(n)}).catch(()=>u([]));try{const n=localStorage.getItem("currentUser");if(n){const c=JSON.parse(n);if(a(c),c.unitUic){const E=Ve.find(se=>se.uic===c.unitUic);E&&h(E)}}}catch{}},[]),s.useEffect(()=>{try{if(!i){const n=Object.keys(m||{});if(n.length){const c=n[0],E=m[c]||{},fe=Ve.find(ve=>ve.uic===c)||{ruc:String(E._ruc||""),mcc:String(E._mcc||""),uic:c,unitName:String(E._unitName||c),streetAddress:String(E._streetAddress||"")};h(fe)}}}catch{}},[m]),s.useEffect(()=>{const n=(b==null?void 0:b.unitUic)||"";if(!n){le([]);return}qt(n).then(c=>le(c||[])).catch(()=>le([]))},[b]),s.useEffect(()=>{const n=(b==null?void 0:b.unitUic)||"",c=he||"";if(!n||!c){je([]);return}ht(n,c).then(E=>je(E||[])).catch(()=>je([]))},[b,he]);const We=s.useMemo(()=>{const n=(i==null?void 0:i.uic)||"";if(!n)return[];const c=m[n]||{};return Object.keys(c).filter(E=>!E.startsWith("_")&&Array.isArray(c[E]))},[i,m]),Ge=s.useMemo(()=>{var E;const n=(i==null?void 0:i.uic)||"";if(!n||!j)return[];const c=(E=m[n])==null?void 0:E[j];return Array.isArray(c)?c:[]},[i,j,m]),Je=s.useMemo(()=>{const n=(i==null?void 0:i.uic)||"";return n?w[n]||[]:[]},[i,w]),Ne=s.useMemo(()=>{const n=(i==null?void 0:i.uic)||"";return n?R[n]||[]:[]},[i,R]),x=s.useMemo(()=>{const n=(b==null?void 0:b.unitUic)||"";if(!n)return[];const c=ce;if(c&&c.length)return c;const E=m[n]||{};return Object.keys(E).filter(se=>!se.startsWith("_")&&Array.isArray(E[se]))},[b,m,ce]),oe=s.useMemo(()=>{var se;const n=(b==null?void 0:b.unitUic)||"",c=Z||"";if(!n||!c)return[];const E=(se=m[n])==null?void 0:se[c];return Array.isArray(E)?E:[]},[b,Z,m]),l=s.useMemo(()=>{var fe,ve;const n=(b==null?void 0:b.unitUic)||"",c=he||"";if(!c)return[];const E=Ce;if(E&&E.length>0)return E;if(n){const ie=(fe=m[n])==null?void 0:fe[c];if(Array.isArray(ie)&&ie.length>0)return ie}const se=(i==null?void 0:i.uic)||"";if(se&&se!==n){const ie=(ve=m[se])==null?void 0:ve[c];if(Array.isArray(ie))return ie}return[]},[b,he,m,Ce,i]),A=s.useMemo(()=>{const n=x.slice(),c=ge||(b&&b.company!=="N/A"?b.company:"");return c&&!n.includes(c)?[c,...n]:n},[x,ge,b]);s.useMemo(()=>{const n=oe.slice(),c=ne||(b&&b.platoon&&b.platoon!=="N/A"?b.platoon:"");return c&&!n.includes(c)?[c,...n]:n},[oe,ne,b]);const O=s.useMemo(()=>{const n=l.slice(),c=G||(b&&b.rolePlatoon&&b.rolePlatoon!=="N/A"?b.rolePlatoon:"");return c&&!n.includes(c)?[c,...n]:n},[l,G,b]),te=()=>{try{if(i){const n=i.uic,c={...m};c[n]=c[n]||{},c[n]._mcc=i.mcc||c[n]._mcc||"",c[n]._unitName=i.unitName||c[n]._unitName||"",S(c),localStorage.setItem("unit_structure",JSON.stringify(c)),(async()=>{try{if(navigator.sendBeacon){const se=new Blob([JSON.stringify(c)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",se),L({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),keepalive:!0})).ok)throw new Error("persist_failed");L({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{L({type:"error",message:"Failed to persist unit structure."})}})()}else{const n=JSON.stringify(m);localStorage.setItem("unit_structure",n),(async()=>{try{if(navigator.sendBeacon){const E=new Blob([n],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",E),L({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:n,keepalive:!0})).ok)throw new Error("persist_failed");L({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{L({type:"error",message:"Failed to persist unit structure."})}})()}}catch{L({type:"error",message:"Failed to save unit structure."})}},Q=()=>{try{if(!i)return;const n=i.uic,c={...m};c[n]=c[n]||{},c[n]._sections=w[n]||[],c[n]._mcc=i.mcc||c[n]._mcc||"",c[n]._unitName=i.unitName||c[n]._unitName||"",S(c),localStorage.setItem("unit_structure",JSON.stringify(c)),(async()=>{try{if(navigator.sendBeacon){const se=new Blob([JSON.stringify(c)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",se),L({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),keepalive:!0})).ok)throw new Error("persist_failed");L({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{L({type:"error",message:"Failed to persist unit sections."})}})()}catch{L({type:"error",message:"Failed to save unit sections."})}},xe=()=>{try{if(!i)return;const n=i.uic,c={...m};c[n]=c[n]||{},c[n]._commandSections=R[n]||[],c[n]._mcc=i.mcc||c[n]._mcc||"",c[n]._unitName=i.unitName||c[n]._unitName||"",S(c),localStorage.setItem("unit_structure",JSON.stringify(c)),(async()=>{try{if(navigator.sendBeacon){const se=new Blob([JSON.stringify(c)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",se),L({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),keepalive:!0})).ok)throw new Error("persist_failed");L({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{L({type:"error",message:"Failed to persist command sections."})}})()}catch{L({type:"error",message:"Failed to save command sections."})}},ue=()=>{try{if(!i)return;const n=i.uic,c={...m};c[n]=c[n]||{},c[n]._platoonSectionMap=D[n]||{},c[n]._mcc=i.mcc||c[n]._mcc||"",c[n]._unitName=i.unitName||c[n]._unitName||"",S(c),localStorage.setItem("unit_structure",JSON.stringify(c)),(async()=>{try{if(navigator.sendBeacon){const se=new Blob([JSON.stringify(c)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",se),L({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),keepalive:!0})).ok)throw new Error("persist_failed");L({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{L({type:"error",message:"Failed to persist links."})}})()}catch{L({type:"error",message:"Failed to save links."})}},pe=()=>{if(!i||!H.trim())return;const n=i.uic,c={...m};c[n]=c[n]||{},c[n][H.trim()]||(c[n][H.trim()]=[],S(c),J(H.trim()),$(""))},De=n=>{if(!i)return;const c=i.uic,E={...m};E[c]&&(delete E[c][n],S(E),j===n&&J(""))},be=()=>{if(!i||!j||!p.trim())return;const n=i.uic,c={...m};c[n]=c[n]||{},c[n][j]=c[n][j]||[],c[n][j].includes(p.trim())||(c[n][j]=[...c[n][j],p.trim()],S(c),ee(""))},Oe=n=>{if(!i||!j)return;const c=i.uic,E={...m};E[c][j]=(E[c][j]||[]).filter(se=>se!==n),S(E)},$e=()=>{if(!i||!B.trim())return;const n=i.uic,c={...w};c[n]=c[n]||[],c[n].includes(B.trim())||(c[n]=[...c[n],B.trim()],y(c),I(""))},qe=n=>{if(!i)return;const c=i.uic,E={...w};E[c]=(E[c]||[]).filter(se=>se!==n),y(E)},Te=()=>{if(!i||!_.trim())return;const n=i.uic,c={...R};c[n]=c[n]||[],c[n].includes(_.trim())||(c[n]=[...c[n],_.trim()],P(c),g(""))},ot=n=>{if(!i)return;const c=i.uic,E={...R};E[c]=(E[c]||[]).filter(se=>se!==n),P(E)},ct=()=>{const n=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],c=T.map(ie=>[ie.firstName,ie.mi||"",ie.lastName,ie.email,ie.edipi,ie.service,ie.rank,ie.role,ie.company,ie.unit,ie.unitUic||""].map(Gt=>{const Xe=String(Gt??"");return Xe.includes(",")||Xe.includes('"')||Xe.includes(`
`)?'"'+Xe.replace(/"/g,'""')+'"':Xe}).join(",")),E="\uFEFF"+[n.join(","),...c].join(`
`),se=new Blob([E],{type:"text/csv;charset=utf-8"}),fe=URL.createObjectURL(se),ve=document.createElement("a");ve.href=fe,ve.download="users-export.csv",ve.click(),URL.revokeObjectURL(fe)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${Ie==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>Le("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${Ie==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>Le("users"),children:"User Administration"})]})})}),Ie==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:i?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",i.uic," | RUC: ",i.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:te,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:H,onChange:n=>$(n.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:pe,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[We.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>J(n),children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>De(n),children:"Remove"})]},n)),We.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",j?`• ${j}`:""]}),i&&j&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ue,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:p,onChange:n=>ee(n.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!j}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:be,disabled:!j,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Ge.map(n=>{var c,E;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:n})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:((E=(c=D[(i==null?void 0:i.uic)||""])==null?void 0:c[j])==null?void 0:E[n])||"",onChange:se=>{const fe=(i==null?void 0:i.uic)||"";Y(ve=>{const ie={...ve};return ie[fe]=ie[fe]||{},ie[fe][j]=ie[fe][j]||{},ie[fe][j][n]=se.target.value,ie})},children:[e.jsx("option",{value:"",children:"Link to section"}),(w[(i==null?void 0:i.uic)||""]||[]).map(se=>e.jsx("option",{value:se,children:se},se))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Oe(n),children:"Remove"})]})]},n)}),Ge.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:Q,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:B,onChange:n=>I(n.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:$e,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Je.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>qe(n),children:"Remove"})]},n)),Je.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:xe,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:_,onChange:n=>g(n.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Te,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Ne.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>ot(n),children:"Remove"})]},n)),Ne.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),Ie==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[T.filter(n=>{const c=!M||(n.email??"").toLowerCase().includes(M.toLowerCase())||(n.lastName??"").toLowerCase().includes(M.toLowerCase()),E=i?n.unitUic===i.uic||n.unit&&n.unit===i.unitName:!0;return c&&E}).map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[n.lastName,", ",n.firstName,n.mi?` ${n.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:n.email}),e.jsx("td",{className:"py-2 px-3",children:n.edipi}),e.jsx("td",{className:"py-2 px-3",children:n.service}),e.jsx("td",{className:"py-2 px-3",children:n.rank}),e.jsx("td",{className:"py-2 px-3",children:n.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const c=Ve.find(se=>se.uic===n.unitUic),E=c?c.unitName:n.unit;if(n.isUnitAdmin||n.role==="COMMANDER")return E||"—";if(n.role==="COMPANY_REVIEWER")return n.company&&n.company!=="N/A"?n.company:"—";if(n.role==="PLATOON_REVIEWER"){const se=n.company&&n.company!=="N/A"?n.company:"",fe=n.platoon&&n.platoon!=="N/A"?n.platoon:"",ve=[se,fe].filter(Boolean);return ve.length?ve.join(" / "):"—"}return"—"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>K(n),children:"View"}),((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{ke("admin"),U(n),V(n.role??"MEMBER"),we(n.company!=="N/A"?n.company:void 0),ae(n.company!=="N/A"?n.company:void 0),v(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),z(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),Me(typeof n.commandOrder=="number"?String(n.commandOrder):""),re(!!n.isUnitAdmin),Ee(!!n.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{u(c=>c.filter(E=>E.id!==n.id));try{localStorage.removeItem(`fs/users/${n.id}.json`)}catch(c){console.error("Failed to remove user from localStorage",c)}},children:"Delete"})]})})]},n.id)),T.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:"No users"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:f,type:"text",placeholder:"Filter users...",value:M,onChange:n=>W(n.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var n;return(n=f.current)==null?void 0:n.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:ct,children:"Export All"})]})]}),q&&e.jsx(zs,{user:q,onClose:()=>K(null)}),b&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>U(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>U(null),children:"✕"})]}),me==="profile"&&t&&b&&t.edipi===b.edipi&&e.jsx(Ut,{mode:"edit",initial:b,readOnly:!1,onSaved:n=>{u(c=>c.map(E=>E.edipi===n.edipi?n:E)),U(null),L({type:"success",message:"Profile updated."})}}),me==="admin"&&((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:X,onChange:n=>{const c=n.target.value;V(c),c==="COMMANDER"&&(we(void 0),v(void 0))},className:"w-full px-3 py-2 border rounded",children:Qs.map(n=>e.jsx("option",{value:n,children:n},n))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:he||"",onChange:n=>N(n.target.value||void 0),disabled:!X.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:A.length?"Select company":"No companies configured"}),A.map(n=>e.jsx("option",{value:n,children:n},n))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:G||"",onChange:n=>de(n.target.value||void 0),disabled:!X.includes("REVIEW")||!he,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:O.length?"Select platoon":"No platoons configured"}),O.map(n=>e.jsx("option",{value:n,children:n},n))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:k,onChange:n=>re(n.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:ye,disabled:X==="COMMANDER",onChange:async n=>{const c=n.target.checked;Ee(c);try{if(b&&!(await He({id:b.id,email:b.email,rank:b.rank,firstName:b.firstName,lastName:b.lastName,mi:b.mi,service:b.service,role:b.role,unitUic:b.unitUic,unit:b.unit,company:b.company,isUnitAdmin:!!b.isUnitAdmin,isCommandStaff:c,edipi:b.edipi,passwordHash:b.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Command Sections Dashboard"})]})]}),o.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:o.map((n,c)=>e.jsx("div",{className:"text-sm",children:n},c))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{U(null),Pe.current=!1,r([]),F(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${d?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":d,disabled:d,onClick:async()=>{var se;if(!b)return;const n=[];if(X==="COMPANY_REVIEWER"&&!ge&&n.push("Company is required for Company Reviewer."),X==="PLATOON_REVIEWER"&&(!ge||!Se)&&n.push("Company and Platoon are required for Platoon Reviewer."),r(n),n.length)return;F(!0);const c=((se=Ve.find(fe=>fe.uic===b.unitUic))==null?void 0:se.unitName)||"N/A",E={...b,role:X,isUnitAdmin:k,isCommandStaff:X==="COMMANDER"?!1:ye,company:Z||"N/A",unit:c,platoon:ne||"N/A",roleCompany:X.includes("REVIEW")?he||"N/A":void 0,rolePlatoon:X.includes("REVIEW")?G||"N/A":void 0};try{localStorage.setItem(`fs/users/${E.edipi}.json`,JSON.stringify(E))}catch{}try{if(!(await He({id:E.id,email:E.email,rank:E.rank,firstName:E.firstName,lastName:E.lastName,mi:E.mi,service:E.service,role:E.role,unitUic:E.unitUic,unit:E.unit,company:E.company,isUnitAdmin:!!E.isUnitAdmin,isCommandStaff:!!E.isCommandStaff,edipi:E.edipi,passwordHash:E.passwordHash,roleCompany:E.roleCompany,rolePlatoon:E.rolePlatoon,platoon:E.platoon})).ok)throw new Error("persist_failed")}catch{F(!1),L({type:"error",message:"Failed to save administrative changes."});return}u(fe=>fe.map(ve=>ve.edipi===E.edipi?E:ve));try{t&&t.edipi===E.edipi&&(localStorage.setItem("currentUser",JSON.stringify(E)),a(E))}catch{}U(null),Pe.current=!1,F(!1),L({type:"success",message:"Administrative changes saved."})},children:[d&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),C&&e.jsx("div",{className:`p-3 rounded-lg border ${C.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:C.message})]})};function Gs(){const[t,a]=s.useState([]),[i,h]=s.useState(null),[m,S]=s.useState({}),[w,y]=s.useState({}),[R,P]=s.useState([]),[D,Y]=s.useState("unit"),[j,J]=s.useState("assigned"),[H,$]=s.useState([]),[p,ee]=s.useState(""),[B,I]=s.useState([]),[_,g]=s.useState(""),T=()=>{Ue().then(r=>a(r)).catch(()=>a([]))},u=()=>{it().then(r=>P(r)).catch(()=>P([]))},C=()=>{h(null),T(),u()};s.useEffect(()=>{C(),Tt().then(r=>$(r)),$t().then(r=>I(r))},[D,j]);const L=s.useMemo(()=>{const r={};for(const d of t)d.isUnitAdmin&&d.unitUic&&(r[d.unitUic]=d);return r},[t]),M=s.useMemo(()=>{const r=new Set;return Ve.filter(d=>r.has(d.uic)?!1:(r.add(d.uic),!0))},[]),W=s.useMemo(()=>{const r={};for(const d of t)if(d.isInstallationAdmin&&d.installationId){const F=d.installationId;r[F]=r[F]||[],r[F].push(d)}return r},[t]),f=r=>t.filter(d=>d.unitUic===r.uic||!d.unitUic&&d.unit===r.unitName),b=async r=>{const d=m[r.uic];if(!d)return;const F=t.find(re=>re.id===d);if(!F)return;const k={...F,isUnitAdmin:!0,unitUic:r.uic,unit:r.unitName,company:"N/A"};try{if(!(await He({id:k.id,email:k.email,rank:k.rank,firstName:k.firstName,lastName:k.lastName,mi:k.mi,service:k.service,role:k.role,unitUic:k.unitUic,unit:k.unit,company:k.company,isUnitAdmin:!!k.isUnitAdmin,isInstallationAdmin:!!k.isInstallationAdmin,isCommandStaff:!!k.isCommandStaff,edipi:k.edipi})).ok){h({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}a(re=>re.map(ye=>ye.id===k.id?k:ye)),h({type:"success",message:`Assigned ${k.rank} ${k.lastName} as admin for ${r.unitName}.`})},U=s.useMemo(()=>M.filter(r=>!!L[r.uic]),[M,L]);s.useMemo(()=>(Array.isArray(t)?t:[]).filter(r=>!!r.isHqmcAdmin),[t]);const q=s.useMemo(()=>M.filter(r=>!L[r.uic]),[M,L]),K=s.useMemo(()=>(Array.isArray(H)?H:[]).filter(r=>{var d;return(d=W[r.id])==null?void 0:d.length}),[H,W]),X=s.useMemo(()=>(Array.isArray(H)?H:[]).filter(r=>{var d;return!((d=W[r.id])!=null&&d.length)}),[H,W]),V=s.useMemo(()=>{const r={};for(const d of Array.isArray(t)?t:[])if(d.isHqmcAdmin&&d.hqmcDivision){const F=d.hqmcDivision;r[F]=r[F]||[],r[F].push(d)}return r},[t]),ge=s.useMemo(()=>(Array.isArray(B)?B:[]).filter(r=>{var d;return(d=V[r.code])==null?void 0:d.length}),[B,V]);s.useMemo(()=>{const r=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return(Array.isArray(R)?R:[]).filter(d=>r.includes(String(d.currentStage||"")))},[R]);const[we,Se]=s.useState(1),[v,Z]=s.useState(10),ae=U.length,ne=Math.max(1,Math.ceil(ae/(v||1))),z=Math.min(we,ne),he=ae===0?0:(z-1)*v+1,N=ae===0?0:Math.min(he+v-1,ae),G=U.slice((z-1)*v,(z-1)*v+v),[de,ce]=s.useState(1),[le,Ce]=s.useState(10),je=q.length,Ae=Math.max(1,Math.ceil(je/(le||1))),Me=Math.min(de,Ae),Ie=je===0?0:(Me-1)*le+1,Le=je===0?0:Math.min(Ie+le-1,je),o=q.slice((Me-1)*le,(Me-1)*le+le);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${D==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Y("unit"),J("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${D==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Y("installation"),J("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${D==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Y("hqmc"),J("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${j==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>J("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${j==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>J("missing"),children:"Missing"})]}),D==="installation"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[K.map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:r.name}),e.jsx("td",{className:"py-2 px-3",children:(W[r.id]||[]).map(d=>`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`).join(" • ")})]},r.id)),K.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),D==="installation"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[X.map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:r.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:w[r.id]||"",onChange:d=>y(F=>({...F,[r.id]:d.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(d=>e.jsx("option",{value:d.id,children:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`},d.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!w[r.id],onClick:async()=>{const d=w[r.id],F=t.find(re=>re.id===d);if(!F)return;const k={...F,isInstallationAdmin:!0,installationId:r.id};try{if(!(await He({id:k.id,email:k.email,rank:k.rank,firstName:k.firstName,lastName:k.lastName,mi:k.mi,service:k.service,role:k.role,unitUic:k.unitUic,unit:k.unit,company:k.company,isUnitAdmin:!!k.isUnitAdmin,isInstallationAdmin:!!k.isInstallationAdmin,isCommandStaff:!!k.isCommandStaff,edipi:k.edipi,installationId:k.installationId})).ok){h({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}a(re=>re.map(ye=>ye.id===k.id?k:ye)),h({type:"success",message:`Assigned ${k.rank} ${k.lastName} as installation admin.`})},children:"Assign"})})]},r.id)),X.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),D==="unit"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[G.map(r=>{const d=L[r.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:r.unitName}),e.jsx("td",{className:"py-2 px-3",children:r.uic}),e.jsx("td",{className:"py-2 px-3",children:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`})]},r.uic)}),U.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(gt,{currentPage:z,totalPages:ne,totalItems:ae,pageSize:v,startIndex:he,endIndex:N,onPageChange:r=>Se(r),onPageSizeChange:r=>{Z(r),Se(1)},onNext:()=>Se(Math.min(z+1,ne)),onPrevious:()=>Se(Math.max(z-1,1)),onFirst:()=>Se(1),onLast:()=>Se(ne),canGoNext:z<ne,canGoPrevious:z>1,pageSizeOptions:[5,10,25,50]})})]}),D==="unit"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[o.map(r=>{const d=f(r);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:r.unitName}),e.jsx("td",{className:"py-2 px-3",children:r.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:m[r.uic]||"",onChange:F=>S(k=>({...k,[r.uic]:F.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:d.length?"Select user":"No eligible users"}),d.map(F=>e.jsx("option",{value:F.id,children:`${F.rank} ${F.lastName}, ${F.firstName}${F.mi?` ${F.mi}`:""}`},F.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!m[r.uic],onClick:()=>b(r),children:"Assign"})})]},r.uic)}),q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(gt,{currentPage:Me,totalPages:Ae,totalItems:je,pageSize:le,startIndex:Ie,endIndex:Le,onPageChange:r=>ce(r),onPageSizeChange:r=>{Ce(r),ce(1)},onNext:()=>ce(Math.min(Me+1,Ae)),onPrevious:()=>ce(Math.max(Me-1,1)),onFirst:()=>ce(1),onLast:()=>ce(Ae),canGoNext:Me<Ae,canGoPrevious:Me>1,pageSizeOptions:[5,10,25,50]})})]}),D==="hqmc"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[ge.map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[r.code," — ",r.name]}),e.jsx("td",{className:"py-2 px-3",children:(V[r.code]||[]).map(d=>`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`).join(" • ")})]},r.code)),ge.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),D==="hqmc"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[B.filter(r=>{var d;return!((d=V[r.code])!=null&&d.length)}).map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[r.code," — ",r.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:w[`hqmc_${r.code}`]||"",onChange:d=>y(F=>({...F,[`hqmc_${r.code}`]:d.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(d=>e.jsx("option",{value:d.id,children:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`},d.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!w[`hqmc_${r.code}`],onClick:async()=>{const d=w[`hqmc_${r.code}`],F=t.find(re=>re.id===d);if(!F)return;const k={...F,isHqmcAdmin:!0,hqmcDivision:r.code};try{if(!(await He({id:k.id,email:k.email,rank:k.rank,firstName:k.firstName,lastName:k.lastName,mi:k.mi,service:k.service,role:k.role,unitUic:k.unitUic,unit:k.unit,company:k.company,isUnitAdmin:!!k.isUnitAdmin,isInstallationAdmin:!!k.isInstallationAdmin,isCommandStaff:!!k.isCommandStaff,isHqmcAdmin:!!k.isHqmcAdmin,hqmcDivision:k.hqmcDivision,edipi:k.edipi})).ok){h({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}a(re=>re.map(ye=>ye.id===k.id?k:ye)),h({type:"success",message:`Assigned ${k.rank} ${k.lastName} as HQMC admin for ${r.code}.`})},children:"Assign"})})]},r.code)),B.filter(r=>{var d;return!((d=V[r.code])!=null&&d.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),i&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${i.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:i.message})]})})}const Pt=!0,Js=({onLoggedIn:t,onCreateAccount:a})=>{const[i,h]=s.useState(""),[m,S]=s.useState(""),[w,y]=s.useState(null),[R,P]=s.useState(!0),[D,Y]=s.useState(!0);Xt.useEffect(()=>{},[]);const j=async J=>{J.preventDefault(),y(null);try{const H=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,$=/^[0-9]{10}$/.test(i),p=Pt?H.test(i.trim().toLowerCase())||$:H.test(i.trim().toLowerCase()),ee=m.length>=6;if(P(p),Y(ee),!p){y({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!ee){y({type:"error",message:"Password must be at least 6 characters."});return}let B=null,I=null,_=i.trim().toLowerCase();if(Pt&&$){const{user:W,error:f}=await xt(String(i));B=W,I=f,_=String((B==null?void 0:B.email)||"")}else if(H.test(_)){const{user:W,error:f}=await wt(_);B=W,I=f}else{y({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(I){y({type:"error",message:`Database Error: ${I}`});return}if(!B||!_){y({type:"error",message:"Account not found."});return}const g=String(B.passwordHash||B.password_hash||"").trim();if(!g){y({type:"error",message:"No password set for this user."});return}const T=await ft(m);if(!(/^[0-9a-f]{64}$/i.test(g)?g.toLowerCase()===T.toLowerCase():g===m)){y({type:"error",message:"Invalid credentials."});return}const{user:L,error:M}=await wt(_);if(M){y({type:"error",message:`Profile Error: ${M}`});return}if(!L){console.error("[Login] User profile not found after successful password verification",{emailForLogin:_}),y({type:"error",message:"User profile not found."});return}y({type:"success",message:"Logged in."}),t(L)}catch(H){console.error("[Login] Login failed:",H),y({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:j,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:i,onChange:J=>h(J.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${R?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!R}),!R&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:m,onChange:J=>S(J.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${D?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!D}),!D&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),w&&e.jsx("div",{className:`p-3 rounded-lg border ${w.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:w.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:a,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!R||!D,children:"Login"})]})]})]})},Ot=""+new URL("logo-DLcHofKE.png",import.meta.url).href,Ys=({currentUser:t,hasSectionDashboard:a,hasCommandDashboard:i,hasInstallationSectionDashboard:h=!1,hasInstallationCommandDashboard:m=!1,hasHQMCSectionDashboard:S=!1,hasHQMCApproverDashboard:w=!1,onManageProfile:y,onLogout:R,onNavigate:P,isLogin:D=!1})=>{const[Y,j]=s.useState(!1),[J,H]=s.useState(!1),$=s.useRef(null);return s.useEffect(()=>{const p=B=>{if(!Y)return;const I=$.current;I&&B.target&&!I.contains(B.target)&&j(!1)},ee=B=>{B.key==="Escape"&&j(!1)};return document.addEventListener("mousedown",p),document.addEventListener("touchstart",p,{passive:!0}),document.addEventListener("keydown",ee),()=>{document.removeEventListener("mousedown",p),document.removeEventListener("touchstart",p),document.removeEventListener("keydown",ee)}},[Y]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:D?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:Ot,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:Ot,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:t?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[t.rank," ",t.lastName,t.lastName?",":""," ",t.firstName,t.mi?` ${t.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[t.service," • ",t.role,(()=>{const p={PLATOON_REVIEWER:t.role_platoon,COMPANY_REVIEWER:t.role_company}[t.role];return p?` - ${p}`:null})()]}),(()=>{var _;const p=((_=Ve.find(g=>g.uic===((t==null?void 0:t.unitUic)||"")))==null?void 0:_.unitName)||(t==null?void 0:t.unit)||"",ee=t!=null&&t.company&&t.company!=="N/A"?t.company:t!=null&&t.user_company&&t.user_company!=="N/A"?t.user_company:null,B=t!=null&&t.platoon&&t.platoon!=="N/A"?t.platoon:t!=null&&t.user_platoon&&t.user_platoon!=="N/A"?t.user_platoon:null,I=[p||null,ee,B].filter(Boolean);return I.length?e.jsx("div",{className:"text-xs text-white/70",children:I.join(" • ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:y,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:R,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),t&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>H(!J),children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),J&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{y(),H(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{R(),H(!1)},children:"Logout"})]})]}),!t&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>P("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:$,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":Y,onClick:()=>j(p=>!p),children:"Dashboards"}),e.jsxs("div",{className:`${Y?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:t&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("dashboard"),j(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(t==null?void 0:t.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("admin"),j(!1)},children:"Admin"}),t&&!!t.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("appadmin"),j(!1)},children:"App Admin"}),t&&!!t.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("hqmc-admin"),j(!1)},children:"HQMC Admin"}),t&&!!t.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("installation"),j(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[t&&a&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("section"),j(!1)},children:"Battalion Section Dashboard"}),i&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("command"),j(!1)},children:"Command Sections Dashboard"}),String((t==null?void 0:t.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("review"),j(!1)},children:"Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[t&&h&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("installation-section"),j(!1)},children:"Installation Section Dashboard"}),t&&m&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("installation-command"),j(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[t&&(S||!!t.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("hqmc-section"),j(!1)},children:"HQMC Section Dashboard"}),t&&w&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("hqmc-approver"),j(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})},_e={SECTION:"perm_section",COMMAND:"perm_command",INST_SECTION:"perm_inst_section",INST_COMMAND:"perm_inst_command",HQMC_SECTION:"perm_hqmc_section",HQMC_APPROVER:"perm_hqmc_approver"},Ye=t=>{try{return localStorage.getItem(t)==="true"}catch(a){return console.error(`Failed to read from localStorage for key "${t}":`,a),!1}};function Ks(){const[t,a]=s.useState(null),[i,h]=s.useState("login"),[m,S]=s.useState(()=>{try{const u=localStorage.getItem("currentUser");return u?JSON.parse(u):null}catch(u){return console.error("Failed to parse user from localStorage:",u),null}}),[w,y]=s.useState("create"),[R,P]=s.useState(!1),[D,Y]=s.useState(()=>Ye(_e.SECTION)),[j,J]=s.useState(()=>Ye(_e.COMMAND)),[H,$]=s.useState(()=>Ye(_e.INST_SECTION)),[p,ee]=s.useState(()=>Ye(_e.INST_COMMAND)),[B,I]=s.useState(()=>Ye(_e.HQMC_SECTION)),[_,g]=s.useState(()=>Ye(_e.HQMC_APPROVER)),T=Zt();return s.useEffect(()=>{try{const C=new URLSearchParams(window.location.search).get("view");if(C==="admin"||C==="profile"||C==="dashboard"||C==="login"||C==="appadmin"||C==="hqmc-admin"||C==="hqmc-section"||C==="hqmc-approver"||C==="review"||C==="section"||C==="command"||C==="installation"||C==="installation-section"||C==="installation-command"||C==="documents"||C==="document-viewer"||C==="upload")h(C);else{const L=localStorage.getItem("currentView"),M=localStorage.getItem("currentUser");h(L&&M?L:"login")}}catch{h("login")}},[]),s.useEffect(()=>{m?localStorage.setItem("currentUser",JSON.stringify(m)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"),Object.values(_e).forEach(u=>{try{localStorage.removeItem(u)}catch(C){console.error(`Failed to remove item from localStorage for key "${u}":`,C)}}))},[m]),s.useEffect(()=>{if(!m)return;const u={[_e.SECTION]:D,[_e.COMMAND]:j,[_e.INST_SECTION]:H,[_e.INST_COMMAND]:p,[_e.HQMC_SECTION]:B,[_e.HQMC_APPROVER]:_};for(const[C,L]of Object.entries(u))try{localStorage.setItem(C,String(L))}catch(M){console.error(`Failed to set item in localStorage for key "${C}":`,M)}},[m,D,j,H,p,B,_]),s.useEffect(()=>{let u=!1;return(async()=>{try{const C=(m==null?void 0:m.id)||"";if(!C)return;const L=await Lt(C);L&&!u&&(S(L),localStorage.setItem("currentUser",JSON.stringify(L)))}catch{}})(),()=>{u=!0}},[]),s.useEffect(()=>{i!=="login"&&m&&localStorage.setItem("currentView",i)},[i,m]),s.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const C=await jt();localStorage.setItem("unit_structure",JSON.stringify(C))}catch(u){console.error("Failed to load unit structure:",u)}})()},[]),s.useEffect(()=>{var C,L,M;try{const W=localStorage.getItem("unit_structure");if(!m||!W){Y(!1);return}const f=JSON.parse(W),b=(m==null?void 0:m.unitUic)||"",U=m!=null&&m.company&&m.company!=="N/A"?m.company:"",q=m!=null&&m.platoon&&m.platoon!=="N/A"?m.platoon:"",K=((M=(L=(C=f==null?void 0:f[b])==null?void 0:C._platoonSectionMap)==null?void 0:L[U])==null?void 0:M[q])||"";Y(!!K)}catch(W){console.error("Failed to parse unit structure for section dashboard check",W),Y(!1)}const u=m==null?void 0:m.isCommandStaff;J(!!u),(async()=>{try{const W=(m==null?void 0:m.installationId)||"";if(!W){$(!1),ee(!1);return}const f=await Tt();try{localStorage.setItem("installations_cache",JSON.stringify(f))}catch{}const b=f==null?void 0:f.find(X=>X.id===W),U=(m==null?void 0:m.id)||"",q=!!(b&&b.sectionAssignments&&Object.values(b.sectionAssignments).some(X=>Array.isArray(X)&&X.includes(U))),K=!!(b&&(b.commandSectionAssignments&&Object.values(b.commandSectionAssignments).some(X=>Array.isArray(X)&&X.includes(U))||b.commanderUserId&&String(b.commanderUserId)===U));$(q),ee(K)}catch{$(!1),ee(!1)}})(),(async()=>{try{const W=String((m==null?void 0:m.hqmcDivision)||""),f=String((m==null?void 0:m.id)||"");if(!W||!f){I(!!(m!=null&&m.isHqmcAdmin));return}const{listHQMCSectionAssignmentsLegacy:b}=await es(async()=>{const{listHQMCSectionAssignmentsLegacy:X}=await import("./db-CER12hrx.js").then(V=>V.z);return{listHQMCSectionAssignmentsLegacy:X}},__vite__mapDeps([0,1,2]),import.meta.url),U=await b(),q=U.some(X=>X.division_code===W&&((X.reviewers||[]).includes(f)||(X.approvers||[]).includes(f)));I(q||!!(m!=null&&m.isHqmcAdmin));const K=U.some(X=>X.division_code===W&&(X.approvers||[]).includes(f));g(K)}catch{I(!!(m!=null&&m.isHqmcAdmin))}})()},[m]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(Ys,{currentUser:m,hasSectionDashboard:D,hasCommandDashboard:j,hasInstallationSectionDashboard:H,hasInstallationCommandDashboard:p,hasHQMCSectionDashboard:B,hasHQMCApproverDashboard:_,onManageProfile:()=>{y("edit"),h("profile"),T("/?view=profile")},onLogout:()=>{S(null),h("login"),T("/?view=login")},onNavigate:u=>{h(u),T(`/?view=${u}`)},isLogin:i==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:i==="profile"?e.jsx(Ut,{mode:w,initial:w==="edit"?m||{}:{},onSaved:u=>{S(u),h("dashboard"),T("/?view=dashboard")}}):i==="admin"?e.jsx(Us,{}):i==="appadmin"?e.jsx(Gs,{}):i==="login"?e.jsx(Js,{onLoggedIn:u=>{S(u),h("dashboard"),T("/?view=dashboard")},onCreateAccount:()=>{y("create"),h("profile"),T("/?view=profile")}}):i==="review"?e.jsx(Ps,{}):i==="section"?e.jsx(ps,{}):i==="command"?e.jsx(xs,{}):i==="installation"?e.jsx(cs,{}):i==="hqmc-admin"?e.jsx(_s,{}):i==="installation-section"?e.jsx(hs,{}):i==="installation-command"?e.jsx(gs,{}):i==="hqmc-section"?e.jsx(Ts,{}):i==="hqmc-approver"?e.jsx(Fs,{}):e.jsx(ws,{selectedUnit:t,currentUser:m})})]})}function ma(){return e.jsx(Ks,{})}export{ma as default};
