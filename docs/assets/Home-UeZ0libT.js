const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-BMYSV76n.js","./index-BNHuU7e9.js","./index-DOJlyb3T.css"])))=>i.map(i=>d[i]);
import{r as s,j as e,s as Ft,v as Xt,l as ft,M as kt,a as Zt,u as es,R as ts,b as ss,_ as as}from"./index-BNHuU7e9.js";import{s as $e,d as ns,a as is,b as rs,l as At,c as ht,e as ot,u as He,f as vt,g as gt,h as Ze,i as os,j as cs,k as Bt,m as Vt,n as Et,o as ls,p as Wt,q as Nt,r as ds,t as Ht,v as zt,w as jt,x as Ut,y as It}from"./db-BMYSV76n.js";import{P as St,I as ms}from"./InstallationAdmin-Bcd2x1nw.js";import{f as Qt,R as nt,S as Xe,o as Rt,c as us,a as ps}from"./RequestTable-BfGvNA5g.js";import{c as xs,F as hs,D as Gt,a as rt}from"./DocumentListItem-BpJnWafb.js";import{l as bt}from"./unitStructure-QC5qYuxv.js";import gs from"./SectionDashboard-Bx3OMOjd.js";import bs from"./CommandDashboard-B9LFTVnf.js";import fs from"./InstallationSectionDashboard-B7n6wmo4.js";import ys from"./InstallationCommandDashboard-Bj3-6deo.js";import{U as Je}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-DSLqYxoq.js";import"./utils-CLmukD0c.js";const vs={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},Ns=({filters:t,onFiltersChange:a,statusOptions:r=[],originatorOptions:f=[],searchPlaceholder:c="Search requests...",showAdvanced:C=!0,className:k=""})=>{var H;const[N,P]=s.useState(!1),D=s.useRef(null),T=s.useMemo(()=>Array.isArray(t.status)?t.status:[],[t.status]),Z=s.useMemo(()=>{let h=0;return T.length>0&&h++,t.dateFrom&&h++,t.dateTo&&h++,t.originatorId&&h++,h},[T,t.dateFrom,t.dateTo,t.originatorId]),j=s.useCallback(h=>{a({...t,search:h.target.value})},[t,a]),G=s.useCallback(h=>{const V=T.includes(h)?T.filter(u=>u!==h):[...T,h];a({...t,status:V})},[t,T,a]),Q=s.useCallback(h=>{a({...t,dateFrom:h.target.value})},[t,a]),W=s.useCallback(h=>{a({...t,dateTo:h.target.value})},[t,a]),d=s.useCallback(h=>{a({...t,originatorId:h.target.value})},[t,a]),ee=s.useCallback(()=>{var h;a(vs),(h=D.current)==null||h.focus()},[a]),O=s.useCallback(()=>{var h;a({...t,search:""}),(h=D.current)==null||h.focus()},[t,a]);s.useEffect(()=>{const h=V=>{var u;(V.metaKey||V.ctrlKey)&&V.key==="k"&&(V.preventDefault(),(u=D.current)==null||u.focus())};return document.addEventListener("keydown",h),()=>document.removeEventListener("keydown",h)},[]);const M=t.search||Z>0;return e.jsxs("div",{className:`space-y-3 ${k}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{ref:D,type:"text",value:t.search,onChange:j,placeholder:c,className:"block w-full pl-10 pr-10 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold bg-[var(--surface)] text-[var(--text)]","aria-label":"Search"}),t.search&&e.jsx("button",{onClick:O,className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600","aria-label":"Clear search",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute inset-y-0 right-8 flex items-center pointer-events-none text-xs text-gray-400",children:e.jsx("kbd",{className:"hidden sm:inline-block px-1.5 py-0.5 bg-gray-100 rounded border border-gray-200 font-mono",children:"⌘K"})})]}),C&&e.jsxs("button",{onClick:()=>P(!N),className:`
              flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors
              ${N||Z>0?"bg-brand-gold/10 border-brand-gold text-brand-navy":"border-brand-navy/30 text-[var(--text)] hover:bg-brand-cream/50"}
            `,"aria-expanded":N,"aria-controls":"filter-panel",children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"})}),e.jsx("span",{className:"hidden sm:inline",children:"Filters"}),Z>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-brand-navy rounded-full",children:Z})]}),M&&e.jsxs("button",{onClick:ee,className:"flex items-center gap-1 px-3 py-2 text-sm text-brand-red hover:text-brand-red-2 hover:bg-red-50 rounded-lg transition-colors","aria-label":"Clear all filters",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),C&&N&&e.jsxs("div",{id:"filter-panel",className:"p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[r.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Status"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:r.map(h=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-white/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:T.includes(h.value),onChange:()=>G(h.value),className:"h-4 w-4 text-brand-navy border-gray-300 rounded focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-[var(--text)]",children:h.label})]},h.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Date Range"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"From date"}),e.jsx("input",{type:"date",value:t.dateFrom,onChange:Q,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"From date"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"To date"}),e.jsx("input",{type:"date",value:t.dateTo,onChange:W,min:t.dateFrom,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"To date"})]})]})]}),f.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Originator"}),e.jsxs("select",{value:t.originatorId,onChange:d,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"Filter by originator",children:[e.jsx("option",{value:"",children:"All originators"}),f.map(h=>e.jsx("option",{value:h.value,children:h.label},h.value))]})]})]}),Z>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 pt-2 border-t border-brand-navy/10",children:[e.jsx("span",{className:"text-sm text-[var(--muted)]",children:"Active filters:"}),T.map(h=>{const V=r.find(u=>u.value===h);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[(V==null?void 0:V.label)||h,e.jsx("button",{onClick:()=>G(h),className:"hover:text-brand-red","aria-label":`Remove ${(V==null?void 0:V.label)||h} filter`,children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},h)}),t.dateFrom&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["From: ",t.dateFrom,e.jsx("button",{onClick:()=>a({...t,dateFrom:""}),className:"hover:text-brand-red","aria-label":"Remove from date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.dateTo&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["To: ",t.dateTo,e.jsx("button",{onClick:()=>a({...t,dateTo:""}),className:"hover:text-brand-red","aria-label":"Remove to date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.originatorId&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[((H=f.find(h=>h.value===t.originatorId))==null?void 0:H.label)||"Originator",e.jsx("button",{onClick:()=>a({...t,originatorId:""}),className:"hover:text-brand-red","aria-label":"Remove originator filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]})]})};function js(t,a){return s.useMemo(()=>{let r=Array.isArray(a.items)?a.items:[];const f=Array.isArray(t.status)?t.status:[];if(t.search){const c=t.search.toLowerCase();r=r.filter(C=>a.getSearchText(C).toLowerCase().includes(c))}return f.length>0&&a.getStatus&&(r=r.filter(c=>f.includes(a.getStatus(c)))),(t.dateFrom||t.dateTo)&&a.getDate&&(r=r.filter(c=>{const C=a.getDate(c);if(!C)return!1;const k=new Date(C);if(isNaN(k.getTime()))return!1;if(t.dateFrom){const N=new Date(t.dateFrom);if(k<N)return!1}if(t.dateTo){const N=new Date(t.dateTo);if(N.setHours(23,59,59,999),k>N)return!1}return!0})),t.originatorId&&a.getOriginatorId&&(r=r.filter(c=>a.getOriginatorId(c)===t.originatorId)),r},[t,a])}function Mt(t){if(t==null)return"";const a=String(t);return a.includes('"')||a.includes(",")||a.includes(`
`)||a.includes("\r")?`"${a.replace(/"/g,'""')}"`:a}function Ss(t,a){const f=a.map(C=>Mt(C.header)).join(","),c=t.map(C=>a.map(k=>{const N=k.getValue(C),P=k.format?k.format(N):N;return Mt(P)}).join(","));return[f,...c].join(`\r
`)}function ws(t,a){const r=t.map(f=>{const c={};return a.forEach(C=>{const k=C.getValue(f);c[C.header]=C.format?C.format(k):k}),c});return JSON.stringify(r,null,2)}function Pt(t,a,r){const f=new Blob([t],{type:`${r};charset=utf-8;`}),c=URL.createObjectURL(f),C=document.createElement("a");C.href=c,C.download=a,document.body.appendChild(C),C.click(),document.body.removeChild(C),URL.revokeObjectURL(c)}function Cs({items:t,columns:a,filename:r="export",label:f="Export",variant:c="secondary",className:C="",disabled:k=!1,showCount:N=!0,formats:P=["csv"]}){const[D,T]=s.useState(!1),[Z,j]=s.useState(!1),G=s.useRef(null),Q=s.useCallback(ee=>{j(!0),T(!1),setTimeout(()=>{try{const O=new Date().toISOString().slice(0,10),M=`${r}_${O}`;if(ee==="csv"){const H=Ss(t,a);Pt(H,`${M}.csv`,"text/csv")}else{const H=ws(t,a);Pt(H,`${M}.json`,"application/json")}}catch(O){console.error("Export failed:",O)}finally{j(!1)}},100)},[t,a,r]);s.useEffect(()=>{const ee=O=>{G.current&&!G.current.contains(O.target)&&T(!1)};return D&&document.addEventListener("mousedown",ee),()=>{document.removeEventListener("mousedown",ee)}},[D]),s.useEffect(()=>{const ee=O=>{O.key==="Escape"&&T(!1)};return D&&document.addEventListener("keydown",ee),()=>{document.removeEventListener("keydown",ee)}},[D]);const W={primary:"bg-brand-navy text-brand-cream hover:bg-brand-navy/90",secondary:"bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold/10",text:"text-brand-navy hover:bg-brand-cream/50"},d=k||t.length===0||Z;return P.length===1?e.jsxs("button",{onClick:()=>Q(P[0]),disabled:d,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${W[c]}
          ${C}
        `,children:[Z?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:f}),N&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]})]}):e.jsxs("div",{className:"relative",ref:G,children:[e.jsxs("button",{onClick:()=>T(!D),disabled:d,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${W[c]}
          ${C}
        `,"aria-expanded":D,"aria-haspopup":"menu",children:[Z?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:f}),N&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${D?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),D&&e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-[var(--surface)] border border-brand-navy/20 rounded-lg shadow-lg z-50",role:"menu",children:[P.includes("csv")&&e.jsxs("button",{onClick:()=>Q("csv"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 first:rounded-t-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export as CSV"]}),P.includes("json")&&e.jsxs("button",{onClick:()=>Q("json"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 last:rounded-b-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})}),"Export as JSON"]})]})]})}const Ot=t=>{if(!t)return"";const a=new Date(t);return isNaN(a.getTime())?"":a.toLocaleDateString()};function wt(t,a={}){const{pageSize:r=25,initialPage:f=1}=a,[c,C]=s.useState(f),[k,N]=s.useState(r),P=t.length,D=Math.ceil(P/k),T=(c-1)*k,Z=Math.min(T+k,P);return{currentData:s.useMemo(()=>t.slice(T,Z),[t,T,Z]),currentPage:c,pageSize:k,totalPages:D,totalItems:P,goToPage:M=>{const H=Math.max(1,Math.min(M,D));C(H)},nextPage:()=>{c<D&&C(c+1)},previousPage:()=>{c>1&&C(c-1)},goToFirstPage:()=>{C(1)},goToLastPage:()=>{C(D)},setPageSize:M=>{N(M),C(1)},canGoNext:c<D,canGoPrevious:c>1,startIndex:T+1,endIndex:Z}}const lt="edms-docs";function As(){return{uploadFile:async(C,k)=>{if(!$e)return{url:"",error:"Supabase not configured"};try{const{error:N}=await $e.storage.from(lt).upload(k,C,{upsert:!0});if(N)return{url:"",error:N.message};const{data:P}=$e.storage.from(lt).getPublicUrl(k);return{url:(P==null?void 0:P.publicUrl)||""}}catch(N){return{url:"",error:N instanceof Error?N.message:"Upload failed"}}},deleteFile:async C=>{if(!$e||!C)return!1;try{return await $e.storage.from(lt).remove([C]),!0}catch{return!1}},deleteFolder:async C=>{if(!$e)return!1;try{const{data:k}=await $e.storage.from(lt).list(C.replace(/\/$/,""));if(k&&k.length>0){const N=k.map(P=>`${C.replace(/\/$/,"")}/${P.name}`);await $e.storage.from(lt).remove(N)}return!0}catch{return!1}},extractStoragePath:C=>{if(!C)return null;try{const k=C.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(k!=null&&k[1])return decodeURIComponent(k[1])}catch{}return null},buildStoragePath:(C,k,N,P)=>{const D=Date.now();return`${C||"N-A"}/${k}/${D}-${P}-${Ft(N)}`}}}const Qe=t=>{const a=String(t||"").trim();return a&&a!=="N/A"?a:""},at=(t,a,r)=>t.some(f=>String(f.role||"")!==a||Qe(f.roleCompany||f.company)!==r.company||a==="PLATOON_REVIEWER"&&Qe(f.rolePlatoon||f.platoon)!==(r.platoon||"")?!1:String(f.unitUic||"")===String(r.uic||""));function Jt(t){if(t===0)return"0 Bytes";const a=1024,r=["Bytes","KB","MB","GB"],f=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,f)).toFixed(2))+" "+r[f]}const Dt=s.memo(function({doc:a,onView:r,onDelete:f}){const[c,C]=s.useState(!1),k=a.fileUrl&&xs(a.type,a.name);return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:"flex items-center justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors","aria-label":`Document: ${a.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(hs,{type:a.type,fileName:a.name,size:"md"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-[var(--text)]",children:a.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)]",children:[a.name," • ",Jt(a.size)," • ",new Date(a.uploadedAt).toLocaleDateString()]}),a.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(a.dueDate).toLocaleDateString()]}),a.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Notes: ",a.notes]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",role:"group","aria-label":"Document actions",children:[a.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Qt({currentStage:a.currentStage})}),k&&e.jsx("button",{type:"button",onClick:N=>{N.stopPropagation(),C(!0)},className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Preview document ${a.name}`,children:"Preview"}),a.fileUrl&&e.jsx("a",{href:a.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${a.name} in new tab`,children:"Open"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:N=>{N.stopPropagation(),r(a)},"aria-label":`View or edit document ${a.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:N=>{N.stopPropagation(),f(a)},"aria-label":`Delete document ${a.subject}`,children:"Delete"})]})]}),a.fileUrl&&e.jsx(Gt,{url:a.fileUrl,fileName:a.name,mimeType:a.type,fileSize:a.size,isOpen:c,onClose:()=>C(!1)})]})}),st="edms-docs",Es=({selectedUnit:t,currentUser:a})=>{const[r,f]=s.useState([]),[c,C]=s.useState(!1),[k,N]=s.useState(""),[P,D]=s.useState(""),[T,Z]=s.useState(""),[j,G]=s.useState([]),[Q,W]=s.useState(null),[d,ee]=s.useState(null),[O,M]=s.useState([]),[H,h]=s.useState(!1),[V,u]=s.useState(null),[E,_]=s.useState(""),[A,U]=s.useState(""),[y,g]=s.useState(""),[z,F]=s.useState([]),[K,ie]=s.useState([]),[q,Ne]=s.useState(null),[Ae,Ee]=s.useState(""),[ve,Re]=s.useState(""),[x,B]=s.useState(""),[J,ae]=s.useState([]),[ce,fe]=s.useState(!1),[b,$]=s.useState({}),[te,de]=s.useState(""),[le,Ce]=s.useState("Pending"),[ke,_e]=s.useState({}),[Le,Be]=s.useState(""),v=As(),I=m=>{const w=m.target.files?Array.from(m.target.files):[];if(w.length===0)return;if(j.length+w.length>kt){W({type:"error",message:`Cannot add ${w.length} file(s). Maximum ${kt} files allowed per request.`});try{m.target.value=""}catch{}return}const R=[],Y=[];for(const X of w){const ye=Zt(X);ye.valid?R.push(X):Y.push(...ye.errors)}R.length>0&&G(X=>[...X,...R]),Y.length>0&&W({type:"error",message:Y.slice(0,3).join(" ")+(Y.length>3?` (+${Y.length-3} more errors)`:"")});try{m.target.value=""}catch{}},i=async()=>{if(!q||!(d!=null&&d.id)||q.uploadedById!==d.id)return;const m={actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,timestamp:new Date().toISOString(),action:"Archived by Originator",comment:(x||"").trim()},w={...q,currentStage:Xe.ARCHIVED,finalStatus:"Archived",activity:Array.isArray(q.activity)?[...q.activity,m]:[m]};try{const R=await He(w);if(!R.ok)throw new Error(xe(R,"request_upsert_failed"));ie(Y=>Y.map(X=>X.id===w.id?w:X)),Ne(w),W({type:"success",message:"Request archived."})}catch(R){W({type:"error",message:`Failed to archive: ${String((R==null?void 0:R.message)||R)}`})}},o=async()=>{if(!q||!(d!=null&&d.id)||q.uploadedById!==d.id)return;const m=O.find(pe=>pe.id===q.uploadedById),w=q.unitUic||(m==null?void 0:m.unitUic)||"",R=Qe(m==null?void 0:m.company),Y=Qe(m==null?void 0:m.platoon),X=at(O,"PLATOON_REVIEWER",{company:R,platoon:Y,uic:w}),ye=at(O,"COMPANY_REVIEWER",{company:R,uic:w}),ge=X?Xe.PLATOON_REVIEW:ye?Xe.COMPANY_REVIEW:Xe.BATTALION_REVIEW,ue={actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,actorRole:"Member",timestamp:new Date().toISOString(),action:"Resubmitted request",comment:(x||"").trim()},De={...q,currentStage:ge,routeSection:"",activity:[...q.activity||[],ue]};try{const pe=await He(De);if(!pe.ok)throw new Error(xe(pe,"request_upsert_failed"));ie(Te=>Te.map(Fe=>Fe.id===De.id?De:Fe)),Ne(De),B(""),W({type:"success",message:"Request resubmitted for review."})}catch(pe){W({type:"error",message:`Failed to resubmit: ${String((pe==null?void 0:pe.message)||pe)}`})}},L=async m=>{m.preventDefault(),W(null);const w=k.trim();if(!w){W({type:"error",message:"Subject is required."});return}if(w.length>500){W({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(T.length>5e3){W({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(d!=null&&d.id)){W({type:"error",message:"Create a profile before submitting."});return}if(j.length>0){const pe=Xt(j);if(!pe.valid){W({type:"error",message:pe.errors[0]});return}}C(!0);const R=Date.now(),Y=te||d.id,X=O.find(pe=>pe.id===Y),ye=t?t.uic:(X==null?void 0:X.unitUic)||"N/A",ge=`req-${R}`;let ue=[];async function De(pe,Te){if(!$e)throw new Error("Supabase not configured");const{error:Fe}=await $e.storage.from(st).upload(Te,pe,{upsert:!0});if(Fe)throw new Error(Fe.message);const{data:ze}=$e.storage.from(st).getPublicUrl(Te);return(ze==null?void 0:ze.publicUrl)||""}if(j&&j.length>0){const pe=[];for(let Te=0;Te<j.length;Te++){const Fe=j[Te],ze=`${ye}/${ge}/${R}-${Te}-${Ft(Fe.name)}`;try{const Ue=await De(Fe,ze);pe.push(Ue)}catch(Ue){C(!1),W({type:"error",message:`Failed to upload ${Fe.name}: ${String((Ue==null?void 0:Ue.message)||Ue)}`});return}}ue=j.map((Te,Fe)=>({id:`${R}-${Fe}`,name:Te.name,type:Te.type,size:Te.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:ye,subject:k.trim(),dueDate:P||void 0,notes:T.trim()||void 0,uploadedById:Y,currentStage:"PLATOON_REVIEW",fileUrl:pe[Fe]}))}ue=ue.map(pe=>({...pe,requestId:ge})),f(pe=>[...pe,...ue]),G([]),N(""),D(""),Z("");try{const pe=d?`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`:"Unknown",Te="Member",Fe=ye,ze=Qe(X==null?void 0:X.company),Ue=Qe(X==null?void 0:X.platoon),ut=at(O,"PLATOON_REVIEWER",{company:ze,platoon:Ue,uic:Fe}),pt=at(O,"COMPANY_REVIEWER",{company:ze,uic:Fe}),n=!ut&&!pt,l={id:ge,subject:k.trim(),dueDate:P||void 0,notes:T.trim()||void 0,unitUic:ye,uploadedById:Y,submitForUserId:Y,documentIds:ue.map(S=>S.id),createdAt:new Date().toISOString(),currentStage:ut?Xe.PLATOON_REVIEW:pt?Xe.COMPANY_REVIEW:Xe.BATTALION_REVIEW,routeSection:n&&Le?Le:void 0,activity:[{actor:pe,actorRole:Te,timestamp:new Date().toISOString(),action:"Submitted request",comment:(T||"").trim()}]};try{const S=await He(l);if(!S.ok)throw new Error(xe(S,"request_upsert_failed"));const ne=await vt(ue);if(!ne.ok)throw new Error(xe(ne,"document_upsert_failed"))}catch(S){C(!1);try{ft("request_persist_failed",{requestId:ge,error:String((S==null?void 0:S.message)||S)},"error")}catch{}W({type:"error",message:`Failed to persist submission: ${String((S==null?void 0:S.message)||S)}`});return}ie(S=>S.some(be=>be.id===l.id)?S.map(be=>be.id===l.id?l:be):[...S,l]),C(!1),W({type:"success",message:"Submission successful."}),h(!1),Be("")}catch{C(!1);try{ft("request_persist_failed",{requestId:ge},"error")}catch{}W({type:"error",message:"Failed to persist submission."})}},se=s.useCallback(m=>{u(m),_(m.subject||""),U(m.dueDate||""),g(m.notes||"");try{const w=localStorage.getItem(`fs/requests/${m.requestId}.json`);if(w){const R=JSON.parse(w);F(Array.isArray(R.activity)?R.activity:[])}else{const X=Object.values(Object.assign({})).map(ye=>(ye==null?void 0:ye.default)??ye).find(ye=>ye&&ye.id===m.requestId);F(X&&Array.isArray(X.activity)?X.activity:[])}}catch{F([])}},[]),xe=(m,w)=>{var R;return String(((R=m.error)==null?void 0:R.message)||m.error||w)},me=async()=>{if(!V)return;const m=r.map(w=>w.id===V.id?{...w,subject:E.trim()||w.subject,dueDate:A||void 0,notes:y.trim()||void 0}:w);f(m);try{const Y={actor:d?`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`:"Unknown",actorRole:"Member",timestamp:new Date().toISOString(),action:"Updated document",comment:(y||"").trim()},X=V.requestId?K.find(ye=>ye.id===V.requestId):null;if(X){const ye={...X,activity:Array.isArray(X.activity)?[...X.activity,Y]:[Y]};try{const ge=await He(ye);if(!ge.ok)throw new Error(xe(ge,"request_upsert_failed"))}catch(ge){console.error("Failed to save document edits:",ge),W({type:"error",message:`Failed to save document edits: ${ge.message}`});return}F(ge=>[...ge,Y])}}catch{}g(""),u(null)};r.filter(m=>!(!(d!=null&&d.id)||d.role==="MEMBER"&&m.uploadedById!==d.id||m.type==="request"));const Pe=m=>m.currentStage==="ORIGINATOR_REVIEW",Me=()=>String((d==null?void 0:d.role)||"").includes("REVIEW"),he=()=>{if(!Me())return[];const m=String((d==null?void 0:d.role)||"");return O.filter(w=>{if(w.id===(d==null?void 0:d.id))return!1;if(m.includes("PLATOON")){const R=w.company&&w.company!=="N/A"?w.company:"",Y=w.unit&&w.unit!=="N/A"?w.unit:"",X=d!=null&&d.company&&d.company!=="N/A"?d.company:"",ye=d!=null&&d.unit&&d.unit!=="N/A"?d.unit:"";return R===X&&Y===ye}if(m.includes("COMPANY")){const R=w.company&&w.company!=="N/A"?w.company:"",Y=d!=null&&d.company&&d.company!=="N/A"?d.company:"";return R===Y}return m.includes("COMMANDER")?(w.unitUic||"")===((d==null?void 0:d.unitUic)||""):!1})},Oe=s.useCallback(async m=>{const w=v.extractStoragePath(m.fileUrl);try{w&&$e&&await $e.storage.from(st).remove([w])}catch{}try{await ns(m.id),f(R=>R.filter(Y=>Y.id!==m.id)),m.requestId&&ie(R=>R.map(Y=>Y.id===m.requestId?{...Y,documentIds:(Y.documentIds||[]).filter(X=>X!==m.id)}:Y)),W({type:"success",message:"Document deleted."})}catch(R){W({type:"error",message:`Failed to delete: ${String((R==null?void 0:R.message)||R)}`})}},[]),We=s.useCallback(async m=>{const w=`${m.unitUic||"N-A"}/${m.id}/`;try{if($e){const{data:R}=await $e.storage.from(st).list(w.slice(0,-1));if(R&&R.length>0){const Y=R.map(X=>`${w.slice(0,-1)}/${X.name}`);await $e.storage.from(st).remove(Y)}}}catch{}try{await is(m.id),await rs(m.id),f(R=>R.filter(Y=>Y.requestId!==m.id)),ie(R=>R.filter(Y=>Y.id!==m.id)),Ne(null),W({type:"success",message:"Request and files deleted."})}catch(R){W({type:"error",message:`Failed to delete request: ${String((R==null?void 0:R.message)||R)}`})}},[]),et=async()=>{if(!q||!(d!=null&&d.id)||q.uploadedById!==d.id){W({type:"error",message:"Only the requester can edit this."});return}const m=Date.now(),w=ge=>ge.replace(/[^A-Za-z0-9._-]/g,"-");async function R(ge,ue){if(!$e)throw new Error("Supabase not configured");const{error:De}=await $e.storage.from(st).upload(ue,ge,{upsert:!0});if(De)throw new Error(De.message);const{data:pe}=$e.storage.from(st).getPublicUrl(ue);return(pe==null?void 0:pe.publicUrl)||""}const Y=[];for(let ge=0;ge<J.length;ge++){const ue=J[ge],De=`${q.unitUic||"N-A"}/${q.id}/${m}-${ge}-${w(ue.name)}`;try{const pe=await R(ue,De);Y.push(pe)}catch(pe){W({type:"error",message:`Failed to upload ${ue.name}: ${String((pe==null?void 0:pe.message)||pe)}`});return}}const X=J.map((ge,ue)=>({id:`${m}-${ue}`,name:ge.name,type:ge.type,size:ge.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:q.unitUic||"N/A",subject:Ae.trim()||q.subject,dueDate:ve||void 0,notes:x.trim()||void 0,uploadedById:d.id,currentStage:q.currentStage||"PLATOON_REVIEW",requestId:q.id,fileUrl:Y[ue]})),ye={...q,subject:Ae.trim()||q.subject,dueDate:ve||void 0,notes:x.trim()||void 0,documentIds:[...q.documentIds||[],...X.map(ge=>ge.id)],activity:[...q.activity||[],{actor:`${d.rank} ${d.lastName}, ${d.firstName}${d.mi?` ${d.mi}`:""}`,timestamp:new Date().toISOString(),action:X.length?`Updated request and added ${X.length} document(s)`:"Updated request",comment:(x||"").trim()}]};try{if(!(d&&ps(q,String(d.id||"")))){W({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const ue=await vt(X);if(!ue.ok)throw new Error(xe(ue,"document_upsert_failed"));const De=await He(ye);if(!De.ok)throw new Error(xe(De,"request_upsert_failed"))}catch(ue){try{ft("request_update_failed",{requestId:ye.id,error:String((ue==null?void 0:ue.message)||ue)},"error")}catch{}W({type:"error",message:`Failed to persist documents: ${String((ue==null?void 0:ue.message)||ue)}`});return}f(ue=>[...ue,...X]),ie(ue=>ue.map(De=>De.id===ye.id?ye:De)),Ne(ye),ae([]),B(""),W({type:"success",message:X.length?"Files added and request updated.":"Request updated."})}catch{W({type:"error",message:"Failed to update request."})}},[p,oe]=s.useState(!0),[je,qe]=s.useState(!0);s.useEffect(()=>{At().then(m=>{f(m)}).catch(()=>f([])).finally(()=>oe(!1))},[]),s.useEffect(()=>{q&&(Ee(q.subject||""),Re(q.dueDate||""),B(q.notes||""),ae([]))},[q]),s.useEffect(()=>{},[r]),s.useEffect(()=>{ht().then(m=>{ie(m)}).catch(()=>ie([])).finally(()=>qe(!1))},[]),s.useEffect(()=>{ee(a||null)},[a]),s.useEffect(()=>{ot().then(m=>{M(m)}).catch(()=>M([]))},[]),s.useEffect(()=>{try{const m=localStorage.getItem("unit_structure"),w={};if(m){const R=JSON.parse(m);for(const Y of Object.keys(R||{})){const X=R[Y];X&&Array.isArray(X._sections)&&(w[Y]=X._sections)}_e(w)}else(async()=>{try{const R=await bt();for(const Y of Object.keys(R||{})){const X=R[Y];X&&Array.isArray(X._sections)&&(w[Y]=X._sections)}_e(w)}catch{}})()}catch{}},[]);const tt=s.useMemo(()=>{if(!(d!=null&&d.id))return[];const m=K.filter(w=>w.uploadedById===d.id);return le==="Pending"?m.filter(w=>w.currentStage!=="ARCHIVED"):m.filter(w=>w.currentStage==="ARCHIVED")},[K,d,le]),Se=wt(tt,{pageSize:10}),Ie=s.useMemo(()=>O.reduce((m,w)=>({...m,[w.id]:w}),{}),[O]),Ye=s.useMemo(()=>{const m=te||(d==null?void 0:d.id),w=O.find(ue=>ue.id===m),R=t?t.uic:(w==null?void 0:w.unitUic)||"",Y=Qe(w==null?void 0:w.company),X=Qe(w==null?void 0:w.platoon);if(!R)return!1;const ye=at(O,"PLATOON_REVIEWER",{company:Y,platoon:X,uic:R}),ge=at(O,"COMPANY_REVIEWER",{company:Y,uic:R});return!ye&&!ge},[O,d,te,t]),Ke=s.useMemo(()=>{const m=te||(d==null?void 0:d.id),w=O.find(Y=>Y.id===m),R=t?t.uic:(w==null?void 0:w.unitUic)||"";return ke[R]||[]},[ke,O,d,te,t]),mt=s.useCallback(m=>{const w=Qe(m.currentStage||"PLATOON_REVIEW"),R=O.find(Y=>Y.id===m.uploadedById);switch(w){case"ORIGINATOR_REVIEW":return{level:"Member",scope:""};case"PLATOON_REVIEW":{const Y=R!=null&&R.company&&R.company!=="N/A"?R.company:"",X=R!=null&&R.platoon&&R.platoon!=="N/A"?R.platoon:"";return Y&&X?{level:"Platoon",scope:`(${Y}-${X})`}:Y?{level:"Platoon",scope:`(${Y})`}:{level:"Platoon",scope:""}}case"COMPANY_REVIEW":{const Y=R!=null&&R.company&&R.company!=="N/A"?R.company:"";return{level:"Company",scope:Y?`(${Y})`:""}}case"BATTALION_REVIEW":return{level:"Battalion",scope:m.routeSection?`(${m.routeSection})`:""};case"COMMANDER_REVIEW":return{level:"Commander",scope:m.routeSection?`(${m.routeSection})`:""};case"ARCHIVED":return{level:"Archived",scope:""};default:return{level:Qt(m),scope:""}}},[O]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>h(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),H&&e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:k,onChange:m=>N(m.target.value),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${k.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:P,onChange:m=>D(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),String((d==null?void 0:d.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:te,onChange:m=>de(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),he().map(m=>e.jsxs("option",{value:m.id,children:[m.rank," ",m.lastName,", ",m.firstName,m.mi?` ${m.mi}`:""]},m.id))]})]})}),Ye&&Ke.length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Battalion Section"}),e.jsxs("select",{value:Le,onChange:m=>Be(m.target.value),className:`w-full px-3 py-2 border ${Le?"border-brand-navy/30":"border-brand-gold"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`,children:[e.jsx("option",{value:"",children:"Select section"}),Ke.map(m=>e.jsx("option",{value:m,children:m},m))]}),e.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"No platoon/company reviewer available. Select a section for routing."})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:T,onChange:m=>Z(m.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:I,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:j.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:j.map((m,w)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:m.name,children:m.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>G(R=>R.filter((Y,X)=>X!==w)),children:"Delete"})]},w))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{h(!1),G([]),N(""),D(""),Z(""),Be(""),W(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!k.trim(),children:"Submit"})]})]}),Q&&e.jsx("div",{className:`p-3 rounded-lg border ${Q.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:Q.message})]})]}),e.jsxs("div",{className:"p-6",children:[d&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>Ce("Pending"),className:`${le==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>Ce("Archived"),className:`${le==="Archived"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Archived"})]})}),e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:Se.totalItems>0?`${Se.startIndex}–${Se.endIndex} of ${Se.totalItems}`:""}),je&&e.jsx("div",{className:"animate-pulse",children:"Loading requests…"})]}),e.jsx(nt,{title:"Your Requests",requests:je?Array.from({length:5}).map((m,w)=>({id:`s-${w}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:Xe.PLATOON_REVIEW})):Se.currentData,users:Ie,onRowClick:m=>Ne(m),expandedRows:b,children:m=>e.jsxs("div",{id:`req-docs-${m.id}`,children:[p?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):r.filter(w=>w.requestId===m.id&&w.type!=="request").map(w=>e.jsx(Dt,{doc:w,onView:se,onDelete:Oe},w.id)),!p&&r.filter(w=>w.requestId===m.id&&w.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),Se.totalItems>0&&e.jsx(St,{currentPage:Se.currentPage,totalPages:Se.totalPages,totalItems:Se.totalItems,pageSize:Se.pageSize,startIndex:Se.startIndex,endIndex:Se.endIndex,onPageChange:Se.goToPage,onPageSizeChange:Se.setPageSize,onNext:Se.nextPage,onPrevious:Se.previousPage,onFirst:Se.goToFirstPage,onLast:Se.goToLastPage,canGoNext:Se.canGoNext,canGoPrevious:Se.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),c&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),V&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>u(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:E,onChange:m=>_(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:A,onChange:m=>U(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:V.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:y,onChange:m=>g(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[V.name," • ",Jt(V.size)," • ",new Date(V.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:z.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):z.map((m,w)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[m.actor,m.actorRole?` • ${m.actorRole}`:""," • ",new Date(m.timestamp).toLocaleString()," • ",m.action]}),m.comment&&e.jsx("div",{className:"text-gray-600",children:m.comment})]},w))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>u(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:me,children:"Save"})]})]})}),q&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>Ne(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>Ne(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:Ae,onChange:m=>Ee(m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(q.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:ve,onChange:m=>Re(m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),q.currentStage&&(()=>{const{level:m,scope:w}=mt(q);return e.jsxs("span",{className:"inline-flex flex-col items-center px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-lg border border-brand-navy/30 leading-tight",children:[e.jsx("span",{children:m}),w&&e.jsx("span",{className:"text-[10px]",children:w})]})})(),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:3,value:x,onChange:m=>B(m.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:q.activity&&q.activity.length?q.activity.map((m,w)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[m.actor,m.actorRole?` • ${m.actorRole}`:""," • ",new Date(m.timestamp).toLocaleString()," • ",m.action]}),m.comment&&e.jsx("div",{className:"text-gray-600",children:m.comment})]},w)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Documents"}),e.jsxs("button",{className:"mt-2 px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-expanded":ce,"aria-controls":"docs-panel",onClick:()=>fe(m=>!m),children:[ce?"Hide":"Show"," Documents"]}),e.jsx("div",{id:"docs-panel",className:ce?"mt-3 space-y-2":"hidden",children:r.filter(m=>m.requestId===q.id&&m.type!=="request").map(m=>e.jsx(Dt,{doc:m,onView:se,onDelete:Oe},m.id))}),!Rt(q,String((d==null?void 0:d.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:m=>{const w=m.target.files?Array.from(m.target.files):[];ae(R=>[...R,...w]);try{m.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:J.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):J.map((m,w)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:m.name,children:m.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>ae(R=>R.filter((Y,X)=>X!==w)),children:"Delete"})]},w))})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>Ne(null),children:"Close"}),Rt(q,String((d==null?void 0:d.id)||""))?e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-gold text-brand-charcoal hover:brightness-110",onClick:i,children:"Archive"}):e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:et,disabled:!d||d.id!==((q==null?void 0:q.uploadedById)||""),children:"Save Changes"}),d&&Pe(q)&&d.id===q.uploadedById&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700",onClick:o,children:"Resubmit"}),d&&us(q,String((d==null?void 0:d.id)||""))&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>We(q),children:"Delete Request"})]})]})})]})},ks=({currentUser:t,onClose:a})=>{const[r,f]=s.useState([]),[c,C]=s.useState(""),[k,N]=s.useState(!1),[P,D]=s.useState(""),[T,Z]=s.useState(!1),[j,G]=s.useState("");s.useEffect(()=>{gt().then(M=>{f(M.data||[])}).catch(()=>f([]))},[]);const Q=s.useMemo(()=>String(t.role||"")!=="MEMBER",[t]),W=s.useMemo(()=>{const M=H=>{const h=t.unitUic||"",V=String(t.role||"");if(V.includes("PLATOON")){const u=H.company&&H.company!=="N/A"?H.company:"",E=H.platoon&&H.platoon!=="N/A"?H.platoon:"",_=t.company&&t.company!=="N/A"?t.company:"",A=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return u===_&&E===A}if(V.includes("COMPANY")){const u=H.company&&H.company!=="N/A"?H.company:"",E=t.company&&t.company!=="N/A"?t.company:"";return u===E}return V.includes("COMMANDER")?(H.unitUic||"")===h:!1};return r.filter(H=>H.id!==t.id&&M(H))},[r,t]),d=s.useMemo(()=>{const M=String(t.role||""),H=h=>{const V=t.unitUic||"";if(M.includes("PLATOON")){const u=h.company&&h.company!=="N/A"?h.company:"",E=h.platoon&&h.platoon!=="N/A"?h.platoon:"",_=t.company&&t.company!=="N/A"?t.company:"",A=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return u===_&&E===A}if(M.includes("COMPANY")){const u=h.company&&h.company!=="N/A"?h.company:"",E=t.company&&t.company!=="N/A"?t.company:"";return u===E}return M.includes("COMMANDER")?(h.unitUic||"")===V:!1};return r.filter(h=>h.id!==t.id&&H(h)&&String(h.role||"")===M)},[r,t]),ee=async()=>{try{N(!0),D("");const M=r.find(u=>u.id===c);if(!Q||!M){N(!1);return}const H=String(t.role||""),h={...M};if(h.role=H,H.includes("PLATOON")){h.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A";const u=t.platoon&&t.platoon!=="N/A"?t.platoon:"N/A";h.rolePlatoon=u}else H.includes("COMPANY")?(h.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A",h.rolePlatoon="N/A"):H.includes("COMMANDER")&&(h.roleCompany="N/A",h.rolePlatoon="N/A");try{if(!(await Ze({id:h.id,email:h.email,rank:h.rank,firstName:h.firstName,lastName:h.lastName,mi:h.mi,service:h.service,role:h.role,unitUic:h.unitUic,unit:h.unit,company:h.company,isUnitAdmin:!!h.isUnitAdmin,isCommandStaff:!!h.isCommandStaff,edipi:h.edipi,passwordHash:h.passwordHash,roleCompany:h.roleCompany,rolePlatoon:h.rolePlatoon})).ok)throw new Error("persist_failed")}catch{D("Failed to persist user changes")}const V={actorId:t.id,actorRole:t.role,targetId:h.id,grantedRole:h.role,timestamp:new Date().toISOString(),scope:{unitUic:t.unitUic||"",company:t.company,unit:t.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(V)})}catch{}f(u=>u.map(E=>E.id===h.id?h:E)),C(""),Z(!1),N(!1)}catch{N(!1),D("Operation failed")}},O=async M=>{try{N(!0),D("");const H=r.find(_=>_.id===M);if(!H){N(!1);return}const h=String(t.role||"");if(!d.some(_=>_.id===M)){N(!1),D("Target not in scope");return}const u={...H};u.role="MEMBER",u.company="N/A",u.unit="N/A",u.isCommandStaff=!1,u.roleCompany="N/A",u.rolePlatoon="N/A";try{if(!(await Ze({id:u.id,email:u.email,rank:u.rank,firstName:u.firstName,lastName:u.lastName,mi:u.mi,service:u.service,role:u.role,unitUic:u.unitUic,unit:u.unit,company:u.company,isUnitAdmin:!!u.isUnitAdmin,isCommandStaff:!!u.isCommandStaff,edipi:u.edipi,passwordHash:u.passwordHash,roleCompany:u.roleCompany,rolePlatoon:u.rolePlatoon})).ok)throw new Error("persist_failed")}catch{D("Failed to persist user changes")}const E={actorId:t.id,actorRole:t.role,targetId:u.id,action:"Revoked",previousRole:h,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(E)})}catch{}f(_=>_.map(A=>A.id===u.id?u:A)),G(""),N(!1)}catch{N(!1),D("Operation failed")}};return Q?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:a,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:M=>M.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:a,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:c,onChange:M=>C(M.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),W.map(M=>e.jsxs("option",{value:M.id,children:[M.rank," ",M.lastName,", ",M.firstName,M.mi?` ${M.mi}`:""," • ",M.email]},M.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[d.map(M=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[M.rank," ",M.lastName,", ",M.firstName,M.mi?` ${M.mi}`:""," • ",M.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>G(M.id),children:"Remove Access"})]},M.id)),d.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),P&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:P})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!c||k,onClick:()=>Z(!0),children:"Grant Equivalent Permission"})}),T&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>Z(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:k,onClick:ee,children:"Confirm"})]})]}),j&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>G(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:k,onClick:()=>O(j),children:"Remove"})]})]})]})}):null},$t="ORIGINATOR_REVIEW",Ge=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Is=[{value:"PLATOON_REVIEW",label:"Platoon Review"},{value:"COMPANY_REVIEW",label:"Company Review"},{value:"BATTALION_REVIEW",label:"Battalion Review"},{value:"COMMANDER_REVIEW",label:"Commander Review"},{value:"ARCHIVED",label:"Archived"}],Rs={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},Ms=t=>{const a=Ge.indexOf(t||Ge[0]);return a>=0&&a<Ge.length-1?Ge[a+1]:Ge[a]||Ge[0]},_t=t=>{const a=Ge.indexOf(t||Ge[0]);return a>0?Ge[a-1]:Ge[0]},xt=(t,a)=>{var r;return((r=t.activity)==null?void 0:r.some(f=>a.test(String(f.action||""))))||!1},Ps=t=>xt(t,/(approved by commander|commander.*approved)/i)&&!xt(t,/installation commander/i),Os=t=>xt(t,/(endorsed by commander|commander.*endorsed)/i)&&!xt(t,/installation commander/i),yt=t=>{if(!t)return"MEMBER";const a=String(t.role||"MEMBER"),r=(t.roleCompany||t.company||"").trim(),f=(t.rolePlatoon||t.platoon||"").trim();switch(a){case"PLATOON_REVIEWER":if(r&&f)return`Platoon (${r}-${f})`;break;case"COMPANY_REVIEWER":if(r)return`Company (${r})`;break;case"BATTALION_REVIEWER":return"Battalion";case"COMMANDER_REVIEWER":return"Commander"}return a};function Ds(){const t=es(),[a,r]=s.useState(()=>{try{const i=localStorage.getItem("currentUser");return i?JSON.parse(i):null}catch(i){return console.error("Failed to parse user from localStorage:",i),null}}),[f,c]=s.useState([]),[C,k]=s.useState([]),[N,P]=s.useState({}),[D,T]=s.useState({}),[Z,j]=s.useState({}),[G,Q]=s.useState({}),[W,d]=s.useState({}),[ee,O]=s.useState({}),[M,H]=s.useState({}),[h,V]=s.useState(!1),[u,E]=s.useState({}),[_,A]=s.useState({}),[U,y]=s.useState(!1),[g,z]=s.useState({}),[F,K]=s.useState(null),ie=s.useRef(null),[q,Ne]=s.useState("Pending"),[Ae,Ee]=s.useState(Rs),[ve,Re]=s.useState(null);s.useEffect(()=>{const i=L=>{F&&ie.current&&!ie.current.contains(L.target)&&(z(se=>({...se,[F]:!1})),K(null))},o=L=>{L.key==="Escape"&&F&&(z(se=>({...se,[F]:!1})),K(null))};return document.addEventListener("mousedown",i),document.addEventListener("keydown",o),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("keydown",o)}},[F]),s.useEffect(()=>{os().then(i=>{c(i.data||[])}).catch(()=>c([]))},[]),s.useEffect(()=>{cs().then(i=>{k(i.data||[])}).catch(()=>k([]))},[]),s.useEffect(()=>{gt().then(i=>{const o={},L=i.data||[];for(const se of L)se!=null&&se.id&&(o[se.id]=se);T(o)}).catch(()=>T({}))},[]),s.useEffect(()=>{try{const i=localStorage.getItem("unit_structure"),o={},L={};if(i){const se=JSON.parse(i);for(const xe of Object.keys(se||{})){const me=se[xe];me&&Array.isArray(me._sections)&&(o[xe]=me._sections),me&&me._platoonSectionMap&&typeof me._platoonSectionMap=="object"&&(L[xe]=me._platoonSectionMap)}}else(async()=>{try{const se=await bt();for(const xe of Object.keys(se||{})){const me=se[xe];me&&Array.isArray(me._sections)&&(o[xe]=me._sections),me&&me._platoonSectionMap&&typeof me._platoonSectionMap=="object"&&(L[xe]=me._platoonSectionMap)}}catch{}})();O(o),H(L)}catch{}},[]);const x=s.useMemo(()=>{const i=String((a==null?void 0:a.role)||"");return i.includes("PLATOON")?"PLATOON_REVIEW":i.includes("COMPANY")?"COMPANY_REVIEW":i.includes("BATTALION")?"BATTALION_REVIEW":i.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[a]),B=s.useMemo(()=>Object.values(D),[D]),J=i=>{const o=D[i.uploadedById];if(!o)return!1;const L=Qe(o.company),se=i.unitUic||o.unitUic||"";return at(B,"COMPANY_REVIEWER",{company:L,uic:se})},ae=i=>String((a==null?void 0:a.role)||"").includes("PLATOON")?!J(i):!1,ce=i=>D[i.uploadedById]||null,fe=i=>i&&i!=="N/A"?i.trim():"",b=i=>{var Pe,Me;const o=ce(i),L=i.unitUic||(o==null?void 0:o.unitUic)||"",se=String((a==null?void 0:a.role)||""),xe=(a==null?void 0:a.unitUic)||"",me=(fe(a==null?void 0:a.roleCompany)||fe(a==null?void 0:a.company)).toUpperCase();if(se.includes("PLATOON")){if(!xe||L!==xe)return!1;const he=o?fe(o.company).toUpperCase():"",Oe=o?fe(o.platoon).toUpperCase():"",We=(fe(a==null?void 0:a.rolePlatoon)||fe(a==null?void 0:a.platoon)).toUpperCase();return!me||!We||!he||!Oe?!1:he===me&&Oe===We}if(se.includes("COMPANY")){if(!xe||L!==xe)return!1;const he=o?fe(o.company).toUpperCase():"";return!me||!he?!1:he===me}if(se.includes("BATTALION")){if(!xe||L!==xe)return!1;const he=fe(a==null?void 0:a.company),Oe=fe(a==null?void 0:a.platoon),We=((Me=(Pe=M[xe])==null?void 0:Pe[he])==null?void 0:Me[Oe])||"";return i.routeSection&&We?i.routeSection===We:!0}return se.includes("COMMANDER")?!!xe&&L===xe:!0},$=s.useMemo(()=>(Array.isArray(f)?f:[]).filter(b),[f,a,D,M]),te=s.useMemo(()=>{const i=new Map;for(const o of $){const L=ce(o);if(L&&L.id&&!i.has(L.id)){const se=`${L.rank||""} ${L.lastName||""}, ${L.firstName||""}`.trim();i.set(L.id,{value:L.id,label:se||L.id})}}return Array.from(i.values()).sort((o,L)=>o.label.localeCompare(L.label))},[$,D]),de=js(Ae,{items:$,getSearchText:i=>`${i.subject||""} ${i.id||""} ${i.routeSection||""}`,getStatus:i=>i.currentStage||"PLATOON_REVIEW",getDate:i=>i.createdAt,getOriginatorId:i=>i.uploadedById}),le=s.useMemo(()=>de.filter(i=>(i.currentStage||"PLATOON_REVIEW")===x),[de,x]),Ce=s.useMemo(()=>de.filter(i=>(i.currentStage||"PLATOON_REVIEW")!==x),[de,x]),ke=wt(le,{pageSize:25}),_e=wt(Ce,{pageSize:25}),Le=i=>C.filter(o=>o.requestId===i),Be=s.useMemo(()=>[{header:"Request ID",getValue:i=>i.id},{header:"Subject",getValue:i=>i.subject},{header:"Stage",getValue:i=>i.currentStage||""},{header:"Route Section",getValue:i=>i.routeSection||""},{header:"Originator",getValue:i=>{const o=ce(i);return o?`${o.rank||""} ${o.lastName||""}, ${o.firstName||""}${o.mi?` ${o.mi}`:""}`.trim():""}},{header:"Unit UIC",getValue:i=>i.unitUic||""},{header:"Created At",getValue:i=>i.createdAt,format:Ot},{header:"Due Date",getValue:i=>i.dueDate||"",format:Ot},{header:"Documents",getValue:i=>Le(i.id).map(o=>o.name).join(" | ")}],[D,C]),v=async(i,o,L)=>{const se=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",xe=yt(a),me={actor:se,actorRole:xe,timestamp:new Date().toISOString(),action:L,comment:(N[i.id]||"").trim()},Pe={...i,currentStage:o,routeSection:o==="BATTALION_REVIEW"&&W[i.id]?W[i.id]:i.routeSection,activity:Array.isArray(i.activity)?[...i.activity,me]:[me]};try{await He(Pe),L.toLowerCase().includes("approved")?t.success("Request approved",{message:`"${i.subject}" advanced to next stage`}):L.toLowerCase().includes("return")?t.warning("Request returned",{message:`"${i.subject}" sent back for revision`}):L.toLowerCase().includes("archive")?t.info("Request archived",{message:`"${i.subject}" has been archived`}):t.success(L,{message:`Request "${i.subject}" updated`}),c(Me=>Me.map(he=>he.id===Pe.id?Pe:he)),P(Me=>({...Me,[i.id]:""}))}catch(Me){t.error("Failed to update request",{message:String(Me)})}},I=async i=>{const o=G[i.id]||[];if(!o.length||!(a!=null&&a.id))return;const L=Date.now(),se=o.map((he,Oe)=>({id:`${L}-${Oe}`,name:he.name,type:he.type,size:he.size,uploadedAt:new Date().toISOString(),subject:i.subject,requestId:i.id,fileUrl:URL.createObjectURL(he)})),xe=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",me=yt(a),Pe={actor:xe,actorRole:me,timestamp:new Date().toISOString(),action:`Reviewer added ${se.length} document(s)`,comment:(N[i.id]||"").trim()},Me={...i,documentIds:[...i.documentIds||[],...se.map(he=>he.id)],activity:Array.isArray(i.activity)?[...i.activity,Pe]:[Pe]};try{await vt(se),await He(Me),t.success(`${se.length} file${se.length!==1?"s":""} added`,{message:`Documents added to "${i.subject}"`})}catch(he){t.error("Failed to add files",{message:String(he)})}k(he=>[...he,...se]),c(he=>he.map(Oe=>Oe.id===Me.id?Me:Oe)),Q(he=>({...he,[i.id]:[]})),P(he=>({...he,[i.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Unit Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:yt(a)}),e.jsx(Cs,{items:[...le,...Ce],columns:Be,filename:"review_requests",label:"Export",className:"hidden md:inline-flex"})]})]}),a&&String(a.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>V(!0),children:"Manage Permissions"})})]}),e.jsx(Ns,{filters:Ae,onFiltersChange:Ee,statusOptions:Is,originatorOptions:te,searchPlaceholder:"Search requests by subject, ID, or section...",className:"mb-4"}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>Ne("Pending"),className:`${q==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>Ne("In Scope"),className:`${q==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[q==="Pending"&&e.jsx(nt,{title:"Pending",requests:ke.currentData,users:D,onRowClick:i=>E(o=>({...o,[i.id]:!o[i.id]})),expandedRows:u,platoonSectionMap:M,children:i=>e.jsxs("div",{id:`details-rev-${i.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!g[i.id],"aria-controls":`docs-rev-${i.id}`,onClick:()=>{z(o=>({...o,[i.id]:!o[i.id]})),K(o=>g[i.id]?null:i.id)},onKeyDown:o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),z(L=>({...L,[i.id]:!L[i.id]})),K(L=>g[i.id]?null:i.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${g[i.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${i.id}`,ref:g[i.id]?ie:void 0,className:`${g[i.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:Le(i.id).map(o=>({...o,fileUrl:o.fileUrl})),showIcons:!0,onPreview:o=>Re(Le(i.id).find(L=>L.id===o.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>j(o=>({...o,[i.id]:!o[i.id]})),"aria-expanded":!!Z[i.id],"aria-controls":`logs-${i.id}`,children:[Z[i.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${i.id}`,className:Z[i.id]?"mt-2 space-y-2":"hidden",children:i.activity&&i.activity.length?i.activity.map((o,L)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[o.actor,o.actorRole?` • ${o.actorRole}`:""," • ",new Date(o.timestamp).toLocaleString()," • ",o.action]}),o.comment&&e.jsx("div",{className:"text-gray-600",children:o.comment})]},L)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:N[i.id]||"",onChange:o=>P(L=>({...L,[i.id]:o.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:o=>Q(L=>({...L,[i.id]:o.target.files?Array.from(o.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(G[i.id]||[]).length?`${(G[i.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>I(i),disabled:!G[i.id]||!(G[i.id]||[]).length,children:"Save Files"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[(String((a==null?void 0:a.role)||"").includes("COMPANY")||ae(i))&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:W[i.id]||"",onChange:o=>d(L=>({...L,[i.id]:o.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(ee[(a==null?void 0:a.unitUic)||""]||[]).map(o=>e.jsx("option",{value:o,children:o},o))]}),ae(i)&&e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No company reviewer"})]}),(()=>{const o=Ps(i),L=Os(i),se=String((a==null?void 0:a.role)||"").includes("COMPANY")||ae(i);return o||L?e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>v(i,i.currentStage==="PLATOON_REVIEW"?$t:_t(i.currentStage),"Returned to previous stage"),children:"Return to Previous"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(se){if(!W[i.id])return;v(i,"BATTALION_REVIEW",`Approved and routed to ${W[i.id]}`)}else v(i,Ms(i.currentStage),"Approved")},disabled:se&&!W[i.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>v(i,i.currentStage==="PLATOON_REVIEW"?$t:_t(i.currentStage),i.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),q==="In Scope"&&e.jsx(nt,{title:"In Scope",requests:_e.currentData,users:D,onRowClick:i=>E(o=>({...o,[i.id]:!o[i.id]})),expandedRows:u,platoonSectionMap:M,children:i=>e.jsxs("div",{id:`details-rev-${i.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!g[i.id],"aria-controls":`docs-rev-${i.id}`,onClick:()=>{z(o=>({...o,[i.id]:!o[i.id]})),K(o=>g[i.id]?null:i.id)},onKeyDown:o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),z(L=>({...L,[i.id]:!L[i.id]})),K(L=>g[i.id]?null:i.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${g[i.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-rev-${i.id}`,ref:g[i.id]?ie:void 0,className:`${g[i.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:Le(i.id).map(o=>({...o,fileUrl:o.fileUrl})),showIcons:!0,onPreview:o=>Re(Le(i.id).find(L=>L.id===o.id)||null)})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>j(o=>({...o,[i.id]:!o[i.id]})),"aria-expanded":!!Z[i.id],"aria-controls":`logs-${i.id}`,children:[Z[i.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${i.id}`,className:Z[i.id]?"mt-2 space-y-2":"hidden",children:i.activity&&i.activity.length?i.activity.map((o,L)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[o.actor,o.actorRole?` • ${o.actorRole}`:""," • ",new Date(o.timestamp).toLocaleString()," • ",o.action]}),o.comment&&e.jsx("div",{className:"text-gray-600",children:o.comment})]},L)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),h&&a&&e.jsx(ks,{currentUser:a,onClose:()=>V(!1)}),ve&&ve.fileUrl&&e.jsx(Gt,{url:ve.fileUrl,fileName:ve.name,mimeType:ve.type,fileSize:ve.size,isOpen:!!ve,onClose:()=>Re(null)})]})}function $s(){var _;const[t,a]=s.useState(null),[r,f]=s.useState([]),[c,C]=s.useState([]),[k,N]=s.useState(""),[P,D]=s.useState(""),[T,Z]=s.useState([]),[j,G]=s.useState(null),[Q,W]=s.useState("structure"),[d,ee]=s.useState({}),[O,M]=s.useState({}),[H,h]=s.useState({});s.useEffect(()=>{try{const A=localStorage.getItem("currentUser");A&&a(JSON.parse(A))}catch{}Bt().then(A=>{try{f(A.map(U=>({code:String(U.code||""),name:String(U.name||"")})))}catch{f([])}}),Vt().then(A=>{C(A)}).catch(()=>C([])),ot().then(A=>Z(A)).catch(()=>Z([])),Et().then(A=>{const U={};for(const y of A){const g=`${y.division_code}::${y.branch}`;U[g]={reviewers:y.reviewers||[],approvers:y.approvers||[]}}ee(U)})},[]);const V=(t==null?void 0:t.hqmcDivision)||((_=r[0])==null?void 0:_.code)||"",u=s.useMemo(()=>r.find(A=>A.code===V),[r,V]),E=s.useMemo(()=>(Array.isArray(c)?c:[]).filter(A=>String(A.division_code||"")===V),[c,V]);return s.useMemo(()=>(Array.isArray(T)?T:[]).filter(A=>!!A.isHqmcAdmin&&String(A.hqmcDivision||"")===V),[T,V]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(t!=null&&t.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",u?`${u.code} — ${u.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>W("structure"),className:`${Q==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>W("permissions"),className:`${Q==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),Q==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[E.map(A=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:A.branch}),e.jsx("td",{className:"py-2 px-3",children:A.description||""}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700",onClick:async()=>{if(!confirm(`Delete branch "${A.branch}"?`))return;const U=await ls(V,A.branch);U.ok?(C(y=>y.filter(g=>!(g.division_code===V&&g.branch===A.branch))),G({type:"success",message:`Deleted branch "${A.branch}"`})):G({type:"error",message:`Failed to delete: ${U.error}`})},children:"Delete"})})]},A.branch)),E.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:k,onChange:A=>N(A.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:P,onChange:A=>D(A.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!k.trim(),onClick:async()=>{var A;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:V,division_name:((A=r.find(y=>y.code===V))==null?void 0:A.name)||"",branch:k.trim(),description:P.trim()})});const U=await fetch("/api/hqmc-structure").then(y=>y.json());C(U),N(""),D("")}catch{}},children:"Add"})]})]})]}),Q==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const A of E){const U=`${V}::${A.branch}`,y=d[U]||{reviewers:[],approvers:[]};await Wt({division_code:V,branch:A.branch,reviewers:y.reviewers,approvers:y.approvers})}G({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:E.map(A=>{const U=`${V}::${A.branch}`,y=d[U]||{reviewers:[],approvers:[]},g=z=>`${z.rank||""} ${z.lastName||""}, ${z.firstName||""}${z.mi?" "+z.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:A.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:O[U]||"",onChange:z=>M(F=>({...F,[U]:z.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!O[U],onClick:async()=>{const z=(O[U]||"").trim();if(!z)return;const{user:F,error:K}=await Nt(z);if(K){G({type:"error",message:`Database error: ${K}`});return}if(!(F!=null&&F.id)){G({type:"error",message:`No user found for EDIPI ${z}`});return}ee(ie=>({...ie,[U]:{...y,reviewers:Array.from(new Set([...y.reviewers||[],F.id]))}})),M(ie=>({...ie,[U]:""})),G({type:"success",message:`Added reviewer ${F.lastName||""}, ${F.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(y.reviewers||[]).map(z=>{const F=T.find(K=>K.id===z);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:F?g(F):z}),e.jsx("button",{className:"text-red-600",onClick:()=>ee(K=>({...K,[U]:{...y,reviewers:(y.reviewers||[]).filter(ie=>ie!==z)}})),children:"✕"})]},z)}),(y.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:H[U]||"",onChange:z=>h(F=>({...F,[U]:z.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!H[U],onClick:async()=>{const z=(H[U]||"").trim();if(!z)return;const{user:F,error:K}=await Nt(z);if(K){G({type:"error",message:`Database error: ${K}`});return}if(!(F!=null&&F.id)){G({type:"error",message:`No user found for EDIPI ${z}`});return}ee(ie=>({...ie,[U]:{...y,approvers:Array.from(new Set([...y.approvers||[],F.id]))}})),h(ie=>({...ie,[U]:""})),G({type:"success",message:`Added approver ${F.lastName||""}, ${F.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(y.approvers||[]).map(z=>{const F=T.find(K=>K.id===z);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:F?g(F):z}),e.jsx("button",{className:"text-red-600",onClick:()=>ee(K=>({...K,[U]:{...y,approvers:(y.approvers||[]).filter(ie=>ie!==z)}})),children:"✕"})]},z)}),(y.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},U)})})]})})]}),j&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${j.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:j.message})]})}const dt=(t,a)=>`${t}::${a}`;function _s({currentUser:t,divisionCode:a,branches:r,assignments:f,onClose:c}){const[C,k]=s.useState([]),[N,P]=s.useState(""),[D,T]=s.useState(""),[Z,j]=s.useState("reviewer"),[G,Q]=s.useState(!1);s.useEffect(()=>{gt().then(u=>k(u)).catch(()=>k([]))},[]);const W=s.useMemo(()=>{const u={};for(const E of f)u[dt(E.division_code,E.branch)]={reviewers:E.reviewers||[],approvers:E.approvers||[]};return u},[f]),d=String(t.id||""),ee=s.useMemo(()=>{if(!N)return!1;const u=W[dt(a,N)]||{reviewers:[],approvers:[]};return(u.reviewers||[]).includes(d)||(u.approvers||[]).includes(d)||!!t.isHqmcAdmin},[N,W,d,t]),O=s.useMemo(()=>C.filter(u=>String(u.hqmcDivision||"")===String(a||"")&&String(u.id||"")!==d),[C,a,d]),M=s.useMemo(()=>{if(!N)return[];const u=W[dt(a,N)]||{reviewers:[],approvers:[]};return Array.from(new Set([...u.reviewers||[],...u.approvers||[]])).map(_=>O.find(A=>A.id===_)).filter(Boolean)},[N,W,O,a]),H=async u=>{Q(!0);try{await Wt({division_code:a,branch:N,reviewers:u.reviewers,approvers:u.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:t.id,scope:{hqmcDivision:a,branch:N},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{Q(!1)}},h=async()=>{if(!ee||!N||!D)return;const u=W[dt(a,N)]||{reviewers:[],approvers:[]},E={reviewers:Array.from(new Set(u.reviewers||[])),approvers:Array.from(new Set(u.approvers||[]))};Z==="reviewer"?E.reviewers=Array.from(new Set([...E.reviewers,D])):E.approvers=Array.from(new Set([...E.approvers,D])),await H(E),T("")},V=async u=>{if(!ee||!N)return;const E=W[dt(a,N)]||{reviewers:[],approvers:[]},_={reviewers:(E.reviewers||[]).filter(A=>A!==u),approvers:(E.approvers||[]).filter(A=>A!==u)};await H(_)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:c,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:u=>u.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:c,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:N,onChange:u=>P(u.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),r.map(u=>e.jsx("option",{value:u,children:u},u))]})]}),N&&!ee&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),N&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:D,onChange:u=>T(u.target.value),disabled:!ee,children:[e.jsx("option",{value:"",children:"Choose user"}),O.map(u=>e.jsxs("option",{value:u.id,children:[u.rank," ",u.lastName,", ",u.firstName,u.mi?` ${u.mi}`:""," • ",u.email]},u.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:Z,onChange:u=>j(u.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!ee||!D||G,onClick:h,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[M.map(u=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[u.rank," ",u.lastName,", ",u.firstName,u.mi?` ${u.mi}`:""," • ",u.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!ee||G,onClick:()=>V(u.id),children:"Remove"})]},u.id)),M.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}function Ls(){const[t,a]=s.useState(()=>{try{const b=localStorage.getItem("currentUser");return b?JSON.parse(b):null}catch{return null}}),[r,f]=s.useState([]),[c,C]=s.useState([]),[k,N]=s.useState({}),[P,D]=s.useState({}),[T,Z]=s.useState({}),[j,G]=s.useState({}),[Q,W]=s.useState({}),[d,ee]=s.useState(null),O=s.useRef(null),[M,H]=s.useState([]),[h,V]=s.useState("Pending"),[u,E]=s.useState([]),[_,A]=s.useState({}),[U,y]=s.useState(!1);s.useEffect(()=>{const b=te=>{d&&O.current&&!O.current.contains(te.target)&&(G(de=>({...de,[d]:!1})),ee(null))},$=te=>{te.key==="Escape"&&d&&(G(de=>({...de,[d]:!1})),ee(null))};return document.addEventListener("mousedown",b),document.addEventListener("keydown",$),()=>{document.removeEventListener("mousedown",b),document.removeEventListener("keydown",$)}},[d]),s.useEffect(()=>{ht().then(b=>f(b)).catch(()=>f([]))},[]),s.useEffect(()=>{At().then(b=>C(b)).catch(()=>C([]))},[]),s.useEffect(()=>{ot().then(b=>{const $={};for(const te of b)te!=null&&te.id&&($[te.id]=te);D($)}).catch(()=>D({}))},[]),s.useEffect(()=>{Et().then(H).catch(()=>H([]))},[]),s.useEffect(()=>{Vt().then(E).catch(()=>E([]))},[]);const g=(t==null?void 0:t.id)||"",z=String((t==null?void 0:t.hqmcDivision)||""),F=s.useMemo(()=>M.filter(b=>b.division_code===z&&((b.reviewers||[]).includes(g)||(b.approvers||[]).includes(g))).map(b=>b.branch),[M,z,g]),K=b=>P[b.uploadedById]||null,ie=b=>{if(!z||!g)return!1;const $=String(b.routeSection||"");return F.includes($)},q=s.useMemo(()=>(Array.isArray(r)?r:[]).filter(ie),[r,F]),Ne=s.useMemo(()=>q.filter(b=>(b.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[q]),Ae=s.useMemo(()=>q.filter(b=>(b.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[q]),Ee=b=>c.filter($=>$.requestId===b),ve=b=>`"${String(b??"").replace(/"/g,'""')}"`,Re=b=>{const te=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const de of b){const le=K(de),Ce=le?`${le.rank} ${le.lastName}, ${le.firstName}${le.mi?` ${le.mi}`:""}`:"",ke=Ee(de.id).map(_e=>_e.name).join(" | ");te.push([de.id,de.subject,de.currentStage||"",de.routeSection||"",Ce,de.unitUic||"",new Date(de.createdAt).toLocaleString(),ke])}return te.map(de=>de.map(ve).join(",")).join(`\r
`)},x=(b,$)=>{const te=new Blob([$],{type:"text/csv;charset=utf-8;"}),de=URL.createObjectURL(te),le=document.createElement("a");le.href=de,le.download=b,document.body.appendChild(le),le.click(),document.body.removeChild(le),URL.revokeObjectURL(de)},B=()=>x("hqmc_pending.csv",Re(Ne)),J=()=>x("hqmc_in_scope.csv",Re(Ae)),ae=()=>x("hqmc_all.csv",Re([...Ne,...Ae])),ce=async b=>{const $=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",te=String(_[b.id]||"").trim();if(!te){alert("Select an HQMC section to route to approver");return}const de={actor:$,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${te}`,comment:(k[b.id]||"").trim()},le={...b,routeSection:te,activity:Array.isArray(b.activity)?[...b.activity,de]:[de]};try{await He(le)}catch{}f(Ce=>Ce.map(ke=>ke.id===le.id?le:ke)),N(Ce=>({...Ce,[b.id]:""}))},fe=async b=>{const te={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC to Installation",comment:(k[b.id]||"").trim()},de={...b,currentStage:"INSTALLATION_REVIEW",activity:Array.isArray(b.activity)?[...b.activity,te]:[te]};try{await He(de)}catch{}f(le=>le.map(Ce=>Ce.id===de.id?de:Ce)),N(le=>({...le,[b.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:z||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ae,children:"Export All"}),F.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>y(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>V("Pending"),className:`${h==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>V("In Scope"),className:`${h==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[h==="Pending"&&e.jsx(nt,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:B,children:"Export Pending"}),requests:Ne,users:P,onRowClick:b=>Z($=>({...$,[b.id]:!$[b.id]})),expandedRows:T,children:b=>e.jsxs("div",{id:`details-hq-${b.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[b.id],"aria-controls":`docs-hq-${b.id}`,onClick:()=>{G($=>({...$,[b.id]:!$[b.id]})),ee($=>j[b.id]?null:b.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[b.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${b.id}`,ref:j[b.id]?O:void 0,className:`${j[b.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:Ee(b.id).map($=>({...$,fileUrl:$.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!Q[b.id],"aria-controls":`logs-hq-${b.id}`,onClick:()=>W($=>({...$,[b.id]:!$[b.id]})),children:[Q[b.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hq-${b.id}`,className:Q[b.id]?"mt-2 space-y-2":"hidden",children:b.activity&&b.activity.length?b.activity.map(($,te)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[$.actor," • ",new Date($.timestamp).toLocaleString()," • ",$.action]}),$.comment&&e.jsx("div",{className:"text-gray-600",children:$.comment})]},te)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:k[b.id]||"",onChange:$=>N(te=>({...te,[b.id]:$.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:_[b.id]||"",onChange:$=>A(te=>({...te,[b.id]:$.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),u.filter($=>String($.division_code||"")===z).map($=>e.jsx("option",{value:$.branch,children:$.branch},$.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>ce(b),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>fe(b),children:"Return"})]})]})]})}),h==="In Scope"&&e.jsx(nt,{title:"In Scope",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:J,children:"Export In Scope"}),requests:Ae,users:P,onRowClick:b=>Z($=>({...$,[b.id]:!$[b.id]})),expandedRows:T,children:b=>e.jsxs("div",{id:`details-hq-${b.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[b.id],"aria-controls":`docs-hq-${b.id}`,onClick:()=>{G($=>({...$,[b.id]:!$[b.id]})),ee($=>j[b.id]?null:b.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[b.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hq-${b.id}`,ref:j[b.id]?O:void 0,className:`${j[b.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:Ee(b.id).map($=>({...$,fileUrl:$.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!Q[b.id],"aria-controls":`logs-hqs-${b.id}`,onClick:()=>W($=>({...$,[b.id]:!$[b.id]})),children:[Q[b.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqs-${b.id}`,className:Q[b.id]?"mt-2 space-y-2":"hidden",children:b.activity&&b.activity.length?b.activity.map(($,te)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[$.actor," • ",new Date($.timestamp).toLocaleString()," • ",$.action]}),$.comment&&e.jsx("div",{className:"text-gray-600",children:$.comment})]},te)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),U&&t&&e.jsx(_s,{currentUser:t,divisionCode:z,branches:u.filter(b=>String(b.division_code||"")===z).map(b=>b.branch),assignments:M,onClose:()=>y(!1)})]})}function qs(){const[t,a]=s.useState(()=>{try{const x=localStorage.getItem("currentUser");return x?JSON.parse(x):null}catch{return null}}),[r,f]=s.useState([]),[c,C]=s.useState([]),[k,N]=s.useState({}),[P,D]=s.useState({}),[T,Z]=s.useState({}),[j,G]=s.useState({}),[Q,W]=s.useState({}),[d,ee]=s.useState(null),O=s.useRef(null),[M,H]=s.useState([]),[h,V]=s.useState("Pending");s.useEffect(()=>{const x=J=>{d&&O.current&&!O.current.contains(J.target)&&(G(ae=>({...ae,[d]:!1})),ee(null))},B=J=>{J.key==="Escape"&&d&&(G(ae=>({...ae,[d]:!1})),ee(null))};return document.addEventListener("mousedown",x),document.addEventListener("keydown",B),()=>{document.removeEventListener("mousedown",x),document.removeEventListener("keydown",B)}},[d]),s.useEffect(()=>{ht().then(x=>f(x)).catch(()=>f([]))},[]),s.useEffect(()=>{At().then(x=>C(x)).catch(()=>C([]))},[]),s.useEffect(()=>{ot().then(x=>{const B={};for(const J of x)J!=null&&J.id&&(B[J.id]=J);D(B)}).catch(()=>D({}))},[]),s.useEffect(()=>{Et().then(H).catch(()=>H([]))},[]);const u=(t==null?void 0:t.id)||"",E=String((t==null?void 0:t.hqmcDivision)||""),_=s.useMemo(()=>M.filter(x=>x.division_code===E&&(x.approvers||[]).includes(u)).map(x=>x.branch),[M,E,u]),A=x=>P[x.uploadedById]||null,U=x=>{if(!E||!u)return!1;const B=String(x.routeSection||"");return _.includes(B)},y=s.useMemo(()=>(Array.isArray(r)?r:[]).filter(U),[r,_]),g=s.useMemo(()=>y.filter(x=>(x.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[y]),z=s.useMemo(()=>y.filter(x=>(x.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[y]),F=x=>c.filter(B=>B.requestId===x),K=x=>`"${String(x??"").replace(/"/g,'""')}"`,ie=x=>{const J=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const ae of x){const ce=A(ae),fe=ce?`${ce.rank} ${ce.lastName}, ${ce.firstName}${ce.mi?` ${ce.mi}`:""}`:"",b=F(ae.id).map($=>$.name).join(" | ");J.push([ae.id,ae.subject,ae.currentStage||"",ae.routeSection||"",fe,ae.unitUic||"",new Date(ae.createdAt).toLocaleString(),b])}return J.map(ae=>ae.map(K).join(",")).join(`\r
`)},q=(x,B)=>{const J=new Blob([B],{type:"text/csv;charset=utf-8;"}),ae=URL.createObjectURL(J),ce=document.createElement("a");ce.href=ae,ce.download=x,document.body.appendChild(ce),ce.click(),document.body.removeChild(ce),URL.revokeObjectURL(ae)},Ne=()=>q("hqmc_approver_pending.csv",ie(g)),Ae=()=>q("hqmc_approver_approved.csv",ie(z)),Ee=()=>q("hqmc_approver_all.csv",ie([...g,...z])),ve=async x=>{const J={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved",comment:(k[x.id]||"").trim()},ae={...x,currentStage:"ARCHIVED",activity:Array.isArray(x.activity)?[...x.activity,J]:[J]};try{await He(ae)}catch{}f(ce=>ce.map(fe=>fe.id===ae.id?ae:fe)),N(ce=>({...ce,[x.id]:""}))},Re=async x=>{const J={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver to Installation",comment:(k[x.id]||"").trim()},ae={...x,currentStage:"INSTALLATION_REVIEW",activity:Array.isArray(x.activity)?[...x.activity,J]:[J]};try{await He(ae)}catch{}f(ce=>ce.map(fe=>fe.id===ae.id?ae:fe)),N(ce=>({...ce,[x.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((t==null?void 0:t.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ee,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>V("Pending"),className:`${h==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>V("Approved"),className:`${h==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"})]})}),e.jsxs("div",{className:"mt-4",children:[h==="Pending"&&e.jsx(nt,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ne,children:"Export Pending"}),requests:g,users:P,onRowClick:x=>Z(B=>({...B,[x.id]:!B[x.id]})),expandedRows:T,children:x=>e.jsxs("div",{id:`details-hqa-${x.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[x.id],"aria-controls":`docs-hqa-${x.id}`,onClick:()=>{G(B=>({...B,[x.id]:!B[x.id]})),ee(B=>j[x.id]?null:x.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[x.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${x.id}`,ref:j[x.id]?O:void 0,className:`${j[x.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:F(x.id).map(B=>({...B,fileUrl:B.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!Q[x.id],"aria-controls":`logs-hqa-${x.id}`,onClick:()=>W(B=>({...B,[x.id]:!B[x.id]})),children:[Q[x.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqa-${x.id}`,className:Q[x.id]?"mt-2 space-y-2":"hidden",children:x.activity&&x.activity.length?x.activity.map((B,J)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[B.actor," • ",new Date(B.timestamp).toLocaleString()," • ",B.action]}),B.comment&&e.jsx("div",{className:"text-gray-600",children:B.comment})]},J)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:k[x.id]||"",onChange:B=>N(J=>({...J,[x.id]:B.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>ve(x),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>Re(x),children:"Return"})]})]})}),h==="Approved"&&e.jsx(nt,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ae,children:"Export Approved"}),requests:z,users:P,onRowClick:x=>Z(B=>({...B,[x.id]:!B[x.id]})),expandedRows:T,children:x=>e.jsxs("div",{id:`details-hqa-${x.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[x.id],"aria-controls":`docs-hqa-${x.id}`,onClick:()=>{G(B=>({...B,[x.id]:!B[x.id]})),ee(B=>j[x.id]?null:x.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[x.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsx("div",{id:`docs-hqa-${x.id}`,ref:j[x.id]?O:void 0,className:`${j[x.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:e.jsx(rt,{documents:F(x.id).map(B=>({...B,fileUrl:B.fileUrl}))})}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!Q[x.id],"aria-controls":`logs-hqaa-${x.id}`,onClick:()=>W(B=>({...B,[x.id]:!B[x.id]})),children:[Q[x.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-hqaa-${x.id}`,className:Q[x.id]?"mt-2 space-y-2":"hidden",children:x.activity&&x.activity.length?x.activity.map((B,J)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[B.actor," • ",new Date(B.timestamp).toLocaleString()," • ",B.action]}),B.comment&&e.jsx("div",{className:"text-gray-600",children:B.comment})]},J)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]})})}const Ts=({onUnitSelect:t,selectedUnit:a})=>{const[r,f]=s.useState(""),[c,C]=s.useState(!1),k=Je.filter(P=>P.unitName.toLowerCase().startsWith(r.toLowerCase())||P.uic.toLowerCase().startsWith(r.toLowerCase())||P.ruc.toLowerCase().startsWith(r.toLowerCase())),N=P=>{t(P),C(!1),f("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>C(!c),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[a?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",a.uic," | RUC: ",a.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),c&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:r,onChange:P=>f(P.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:k.map(P=>e.jsxs("button",{type:"button",onClick:()=>N(P),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:P.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",P.uic," | RUC: ",P.ruc," | MCC: ",P.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[P.streetAddress,", ",P.cityState," ",P.zip]})]},P.uic))})]})]})]})},Ct=async t=>{const r=new TextEncoder().encode(t),f=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(f)).map(c=>c.toString(16).padStart(2,"0")).join("")};async function Fs(t,a){const r=ds();return r!=null&&r.auth?await r.auth.signUp({email:t,password:a}):{data:null,error:new Error("supabase_not_initialized")}}const Lt={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},Bs=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Yt=({onSaved:t,initial:a={},mode:r="create",readOnly:f=!1,canEditRole:c=!1,canEditAdmin:C=!1})=>{const[k,N]=s.useState(""),[P,D]=s.useState(""),[T,Z]=s.useState(""),[j,G]=s.useState(a.email||""),[Q,W]=s.useState(a.edipi||""),[d,ee]=s.useState(a.service||""),[O,M]=s.useState(a.rank||""),[H,h]=s.useState(a.role||"MEMBER"),[V,u]=s.useState(!!a.isUnitAdmin),[E,_]=s.useState(a.company||""),[A,U]=s.useState(a.platoon||""),[y,g]=s.useState(void 0),[z,F]=s.useState(null),[K,ie]=s.useState({}),[q,Ne]=s.useState(""),[Ae,Ee]=s.useState(""),[ve,Re]=s.useState([]),[x,B]=s.useState(!1),[J,ae]=s.useState(a.roleCompany||""),[ce,fe]=s.useState(a.rolePlatoon||""),[b,$]=s.useState(!1),[te,de]=s.useState([]),[le,Ce]=s.useState([]),[ke,_e]=s.useState([]),[Le,Be]=s.useState([]);s.useEffect(()=>{if(a.firstName&&N(String(a.firstName)),a.lastName&&D(String(a.lastName)),a.mi&&Z(String(a.mi)),a.company&&_(String(a.company)),a.platoon&&U(String(a.platoon)),a.roleCompany&&ae(String(a.roleCompany)),a.rolePlatoon&&fe(String(a.rolePlatoon)),a.unitUic){const p=Je.find(oe=>oe.uic===a.unitUic);p&&g(p)}},[a]);const v=s.useMemo(()=>Lt[d]||[],[d]),I=s.useMemo(()=>{if(!y)return[];const p=te;if(p&&p.length)return p;const oe=K[y.uic]||{};return Object.keys(oe).filter(je=>!je.startsWith("_")&&Array.isArray(oe[je]))},[y,K,te]),i=s.useMemo(()=>{var p;return y&&E?((p=K[y.uic])==null?void 0:p[E])||[]:[]},[y,E,K]),o=s.useMemo(()=>{if(!y||!E)return[];const p=le;return p&&p.length?p:i},[y,E,le,i]),L=s.useMemo(()=>{if(!y)return[];const p=ke;if(p&&p.length)return p;const oe=K[y.uic]||{};return Object.keys(oe).filter(je=>!je.startsWith("_")&&Array.isArray(oe[je]))},[y,K,ke]),se=s.useMemo(()=>{var p;return y&&J?((p=K[y.uic])==null?void 0:p[J])||[]:[]},[y,J,K]),xe=s.useMemo(()=>{if(!y||!J)return[];const p=Le;return p&&p.length?p:se},[y,J,Le,se]),me=s.useMemo(()=>{const p=I.slice(),oe=E||a.company||a.user_company||"";return oe&&!p.includes(oe)?[oe,...p]:p},[I,E,a]),Pe=s.useMemo(()=>{const p=o.slice(),oe=A||a.platoon||a.user_platoon||"";return oe&&!p.includes(oe)?[oe,...p]:p},[o,A,a]),Me=s.useMemo(()=>{const p=L.slice(),oe=J||a.roleCompany||"",je=oe&&!p.includes(oe)?[oe,...p]:p;return Array.from(new Set(je))},[L,J,a]),he=s.useMemo(()=>{const p=xe.slice(),oe=ce||a.rolePlatoon||"";return oe&&!p.includes(oe)?[oe,...p]:p},[xe,ce,a]);s.useEffect(()=>{(async()=>{try{if(r==="edit"&&a.id){const p=await Ht(String(a.id));p&&(p.company&&!E&&_(String(p.company)),p.platoon&&!A&&U(String(p.platoon)),p.roleCompany&&!J&&ae(String(p.roleCompany)),p.rolePlatoon&&!ce&&fe(String(p.rolePlatoon)))}}catch{}})()},[r,a.id]),s.useEffect(()=>{v.includes(O)||M("")},[v]),s.useEffect(()=>{U("")},[E]),s.useEffect(()=>{fe("")},[J]),s.useEffect(()=>{try{const p=localStorage.getItem("unit_structure");p&&ie(JSON.parse(p))}catch{}},[y]),s.useEffect(()=>{const p=(y==null?void 0:y.uic)||"";if(!p){de([]),_e([]);return}zt(p).then(oe=>{de(oe||[]),_e(oe||[])}).catch(()=>{de([]),_e([])})},[y]),s.useEffect(()=>{const p=(y==null?void 0:y.uic)||"",oe=E||"";if(!p||!oe){Ce([]);return}jt(p,oe).then(je=>Ce(je||[])).catch(()=>Ce([]))},[y,E]),s.useEffect(()=>{const p=(y==null?void 0:y.uic)||"",oe=J||"";if(!p||!oe){Be([]);return}jt(p,oe).then(je=>Be(je||[])).catch(()=>Be([]))},[y,J]),s.useEffect(()=>{ot().then(p=>{Re(p)}).catch(()=>Re([]))},[]),s.useEffect(()=>{const p=(y==null?void 0:y.uic)||"";if(!p){B(!1);return}const oe=ve.some(je=>!!je.isUnitAdmin&&(je.unitUic||"")===p);B(oe)},[y,ve]),s.useEffect(()=>{if(y){!E&&a.company&&me.includes(a.company)&&_(String(a.company));const p=a.platoon;!A&&p&&Pe.includes(p)&&U(String(p))}},[y,me,Pe,E,A,a]);const Oe=p=>/^[0-9]{10}$/.test(p),We=(p,oe)=>{try{return ve.some(je=>String(je.edipi)===String(p)&&String(je.id)!==String(oe||""))}catch{return!1}},et=async p=>{var tt,Se;if(p.preventDefault(),F(null),f)return;if(!k.trim())return F({type:"error",message:"First name is required."});if(!P.trim())return F({type:"error",message:"Last name is required."});if(T&&!/^[A-Za-z]$/.test(T))return F({type:"error",message:"MI must be a single letter."});if(!j.trim())return F({type:"error",message:"Email is required."});if(!Oe(String(Q)))return F({type:"error",message:"EDIPI must be 10 digits."});if(!d)return F({type:"error",message:"Service is required."});if(!O)return F({type:"error",message:"Rank is required."});if(We(String(Q),a.id?String(a.id):void 0))return F({type:"error",message:"EDIPI already exists."});if(H==="COMPANY_REVIEWER"&&!J)return F({type:"error",message:"Role Company is required for Company Reviewer."});if(H==="PLATOON_REVIEWER"&&(!J||!ce))return F({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${k.trim()}`,T&&""+T.trim().toUpperCase(),`${P.trim()}`;let oe=a.id?String(a.id):`usr-${Date.now()}`,je=a.passwordHash||"";if(r==="create"){if(!q||q.length<8)return F({type:"error",message:"Password must be at least 8 characters."});if(q!==Ae)return F({type:"error",message:"Passwords do not match."});try{const{data:Ie,error:Ye}=await Fs(j.trim(),q);if(Ye){F({type:"error",message:`Failed to create auth user: ${String(Ye.message||Ye)}`});return}const Ke=(tt=Ie==null?void 0:Ie.user)!=null&&tt.id?String(Ie.user.id):"";if(!Ke){F({type:"error",message:"Auth user ID missing after sign up."});return}oe=Ke}catch(Ie){F({type:"error",message:`Failed to create auth user: ${String((Ie==null?void 0:Ie.message)||Ie)}`});return}je=await Ct(q)}else if(r==="edit"&&q){if(q.length<8)return F({type:"error",message:"Password must be at least 8 characters."});if(q!==Ae)return F({type:"error",message:"Passwords do not match."});je=await Ct(q)}const qe={id:oe,firstName:k.trim(),lastName:P.trim(),mi:T?T.trim().toUpperCase():void 0,email:j.trim(),edipi:Q,service:d,rank:O,role:H,company:E||"N/A",unit:(y==null?void 0:y.unitName)||"N/A",unitUic:y==null?void 0:y.uic,passwordHash:je,isUnitAdmin:r==="create"&&y&&!x?!0:V,roleCompany:J||void 0,rolePlatoon:ce||void 0,platoon:A||"N/A"};try{const Ie=await Ze({id:qe.id,email:qe.email,rank:qe.rank,firstName:qe.firstName,lastName:qe.lastName,mi:qe.mi,service:qe.service,role:qe.role,unitUic:qe.unitUic,unit:(y==null?void 0:y.unitName)||"N/A",company:qe.company,isUnitAdmin:!!qe.isUnitAdmin,edipi:String(qe.edipi),passwordHash:je,platoon:A||"N/A",roleCompany:J||void 0,rolePlatoon:ce||void 0});if(!Ie.ok){F({type:"error",message:`Failed to save profile: ${String(((Se=Ie==null?void 0:Ie.error)==null?void 0:Se.message)||(Ie==null?void 0:Ie.error)||"unknown")}`});return}F({type:"success",message:a.id?"Profile updated.":y&&!x?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),t==null||t(qe)}catch{F({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:r==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:et,className:"space-y-6",children:[r==="create"&&y&&!x&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:y.unitName})," (UIC ",y.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:P,onChange:p=>D(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:k,onChange:p=>N(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:T,maxLength:1,onChange:p=>Z(p.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:j,onChange:p=>G(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:Q,onChange:p=>W(p.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:d,onChange:p=>ee(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(Lt).map(p=>e.jsx("option",{value:p,children:p},p))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:O,onChange:p=>M(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),v.map(p=>e.jsx("option",{value:p,children:p},p))]})]}),r==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:q,onChange:p=>Ne(p.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:Ae,onChange:p=>Ee(p.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f})]})]}):e.jsx(e.Fragment,{})]})]}),b&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:q,onChange:p=>Ne(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:Ae,onChange:p=>Ee(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:f})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>$(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>$(!1),children:"Save"})]})]})}),r==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:H,onChange:p=>h(p.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:Bs.map(p=>e.jsx("option",{value:p,children:p},p))})}),e.jsx("div",{children:e.jsxs("select",{value:J||String(a.roleCompany||""),onChange:p=>ae(p.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Me.length?"Select company":"No companies configured"}),Me.map(p=>e.jsx("option",{value:p,children:p},p))]})}),e.jsx("div",{children:e.jsxs("select",{value:ce||String(a.rolePlatoon||""),onChange:p=>fe(p.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:he.length?"Select platoon":"No platoons configured"}),he.map(p=>e.jsx("option",{value:p,children:p},p))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:V,onChange:p=>u(p.target.checked),disabled:f||!C}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(a==null?void 0:a.isCommandStaff)||H==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(Ts,{onUnitSelect:p=>g(p),selectedUnit:y})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:E||String(a.company||""),onChange:p=>_(p.target.value),disabled:f||!y||me.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:me.length?"Select company":"No companies configured"}),me.map(p=>e.jsx("option",{value:p,children:p},p))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:A||String(a.platoon||""),onChange:p=>U(p.target.value),disabled:f||!y||!E||Pe.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Pe.length?"Select platoon":"No platoons configured"}),Pe.map(p=>e.jsx("option",{value:p,children:p},p))]})]})]})})]}),z&&e.jsx("div",{className:`p-3 rounded-lg border ${z.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:z.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[r==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>$(!0),disabled:f,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:f,children:r==="edit"?"Save":"Create Profile"})]})]})]})},Vs=s.memo(function({user:a,onClose:r}){const f=()=>{const c=Je.find(k=>k.uic===a.unitUic),C=c?c.unitName:a.unit;if(a.isUnitAdmin||a.role==="COMMANDER")return C||"—";if(a.role==="COMPANY_REVIEWER")return a.company&&a.company!=="N/A"?a.company:"—";if(a.role==="PLATOON_REVIEWER"){const k=a.company&&a.company!=="N/A"?a.company:"",N=a.platoon&&a.platoon!=="N/A"?a.platoon:"",P=[k,N].filter(Boolean);return P.length?P.join(" / "):"—"}return"—"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:r,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:r,children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:a.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:a.edipi||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:a.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:a.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:f()})]}),a.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),a.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:r,children:"Close"})})]})})}),Ws=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Hs=()=>{const[t,a]=s.useState(null),[r,f]=s.useState(void 0),[c,C]=s.useState({}),[k,N]=s.useState({}),[P,D]=s.useState({}),[T,Z]=s.useState({}),[j,G]=s.useState(""),[Q,W]=s.useState(""),[d,ee]=s.useState(""),[O,M]=s.useState(""),[H,h]=s.useState(""),[V,u]=s.useState([]),[E,_]=s.useState(null),[A,U]=s.useState(""),y=s.useRef(null),[g,z]=s.useState(null),[F,K]=s.useState(null),[ie,q]=s.useState(""),[Ne,Ae]=s.useState(void 0),[Ee,ve]=s.useState(void 0),[Re,x]=s.useState(void 0),[B,J]=s.useState(void 0),[ae,ce]=s.useState(void 0),[fe,b]=s.useState(void 0),[$,te]=s.useState([]),[de,le]=s.useState([]),[Ce,ke]=s.useState(""),[_e,Le]=s.useState("unit"),[Be,v]=s.useState([]),[I,i]=s.useState(!1),[o,L]=s.useState(!1),[se,xe]=s.useState(!1),[me,Pe]=s.useState("admin"),[Me,he]=s.useState(!0),[Oe,We]=s.useState(null),[et,p]=s.useState(0),oe=s.useRef(!1);s.useEffect(()=>{g&&me==="admin"&&!oe.current&&(!Ne&&g.company&&g.company!=="N/A"&&(Ae(g.company),x(g.company)),!Ee&&g.platoon&&g.platoon!=="N/A"&&(ve(g.platoon),J(g.platoon)),!ae&&g.roleCompany&&g.roleCompany!=="N/A"&&ce(g.roleCompany),!fe&&g.rolePlatoon&&g.rolePlatoon!=="N/A"&&b(g.rolePlatoon),oe.current=!0)},[g,me]),s.useEffect(()=>{try{const n=localStorage.getItem("unit_structure");n&&C(JSON.parse(n))}catch{}try{const n=localStorage.getItem("unit_structure"),l={},S={},ne={};if(n){const be=JSON.parse(n);for(const we of Object.keys(be||{})){const re=be[we];re&&Array.isArray(re._sections)&&(l[we]=re._sections),re&&Array.isArray(re._commandSections)&&(S[we]=re._commandSections),re&&re._platoonSectionMap&&typeof re._platoonSectionMap=="object"&&(ne[we]=re._platoonSectionMap)}}else(async()=>{try{const be=await bt();for(const we of Object.keys(be||{})){const re=be[we];re&&Array.isArray(re._sections)&&(l[we]=re._sections),re&&Array.isArray(re._commandSections)&&(S[we]=re._commandSections),re&&re._platoonSectionMap&&typeof re._platoonSectionMap=="object"&&(ne[we]=re._platoonSectionMap)}C(be)}catch{}})();N(l),D(S),Z(ne)}catch{}(async()=>{he(!0),We(null);try{const n=await gt();if(n.error)throw new Error(n.error);u(n.data),p(n.data.length)}catch(n){const l=(n==null?void 0:n.message)||"Unknown error fetching users";console.error("[AdminPanel] Failed to fetch users:",l),We(l),u([]),p(0)}finally{he(!1)}})();try{const n=localStorage.getItem("currentUser");if(n){const l=JSON.parse(n);if(a(l),l.unitUic){const S=Je.find(ne=>ne.uic===l.unitUic);S&&f(S)}}}catch{}},[]),s.useEffect(()=>{try{if(!r){const n=Object.keys(c||{});if(n.length){const l=n[0],S=c[l]||{},be=Je.find(we=>we.uic===l)||{ruc:String(S._ruc||""),mcc:String(S._mcc||""),uic:l,unitName:String(S._unitName||l),streetAddress:String(S._streetAddress||"")};f(be)}}}catch{}},[c]),s.useEffect(()=>{const n=(g==null?void 0:g.unitUic)||"";if(!n){te([]);return}zt(n).then(l=>te(l||[])).catch(()=>te([]))},[g]),s.useEffect(()=>{const n=(g==null?void 0:g.unitUic)||"",l=ae||"";if(!n||!l){le([]);return}jt(n,l).then(S=>le(S||[])).catch(()=>le([]))},[g,ae]);const je=s.useMemo(()=>{const n=(r==null?void 0:r.uic)||"";if(!n)return[];const l=c[n]||{};return Object.keys(l).filter(S=>!S.startsWith("_")&&Array.isArray(l[S]))},[r,c]),qe=s.useMemo(()=>{var S;const n=(r==null?void 0:r.uic)||"";if(!n||!j)return[];const l=(S=c[n])==null?void 0:S[j];return Array.isArray(l)?l:[]},[r,j,c]),tt=s.useMemo(()=>{const n=(r==null?void 0:r.uic)||"";return n?k[n]||[]:[]},[r,k]),Se=s.useMemo(()=>{const n=(r==null?void 0:r.uic)||"";return n?P[n]||[]:[]},[r,P]),Ie=s.useMemo(()=>{const n=(g==null?void 0:g.unitUic)||"";if(!n)return[];const l=$;if(l&&l.length)return l;const S=c[n]||{};return Object.keys(S).filter(ne=>!ne.startsWith("_")&&Array.isArray(S[ne]))},[g,c,$]),Ye=s.useMemo(()=>{var ne;const n=(g==null?void 0:g.unitUic)||"",l=Re||"";if(!n||!l)return[];const S=(ne=c[n])==null?void 0:ne[l];return Array.isArray(S)?S:[]},[g,Re,c]),Ke=s.useMemo(()=>{var be,we;const n=(g==null?void 0:g.unitUic)||"",l=ae||"";if(!l)return[];const S=de;if(S&&S.length>0)return S;if(n){const re=(be=c[n])==null?void 0:be[l];if(Array.isArray(re)&&re.length>0)return re}const ne=(r==null?void 0:r.uic)||"";if(ne&&ne!==n){const re=(we=c[ne])==null?void 0:we[l];if(Array.isArray(re))return re}return[]},[g,ae,c,de,r]),mt=s.useMemo(()=>{const n=Ie.slice(),l=Ne||(g&&g.company!=="N/A"?g.company:"");return l&&!n.includes(l)?[l,...n]:n},[Ie,Ne,g]);s.useMemo(()=>{const n=Ye.slice(),l=B||(g&&g.platoon&&g.platoon!=="N/A"?g.platoon:"");return l&&!n.includes(l)?[l,...n]:n},[Ye,B,g]);const m=s.useMemo(()=>{const n=Ke.slice(),l=fe||(g&&g.rolePlatoon&&g.rolePlatoon!=="N/A"?g.rolePlatoon:"");return l&&!n.includes(l)?[l,...n]:n},[Ke,fe,g]),w=s.useMemo(()=>r?V.filter(n=>{const l=String(n.unitUic||"").trim().toUpperCase(),S=String(r.uic||"").trim().toUpperCase(),ne=String(n.unit||"").trim().toLowerCase(),be=String(r.unitName||"").trim().toLowerCase();return l&&l===S||ne&&ne===be}):V,[V,r]),R=s.useMemo(()=>{if(!A)return w;const n=A.toLowerCase();return w.filter(l=>(l.email??"").toLowerCase().includes(n)||(l.lastName??"").toLowerCase().includes(n))},[w,A]),Y=()=>{try{if(r){const n=r.uic,l={...c};l[n]=l[n]||{},l[n]._mcc=r.mcc||l[n]._mcc||"",l[n]._unitName=r.unitName||l[n]._unitName||"",C(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const ne=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",ne),_({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");_({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{_({type:"error",message:"Failed to persist unit structure."})}})()}else{const n=JSON.stringify(c);localStorage.setItem("unit_structure",n),(async()=>{try{if(navigator.sendBeacon){const S=new Blob([n],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",S),_({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:n,keepalive:!0})).ok)throw new Error("persist_failed");_({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{_({type:"error",message:"Failed to persist unit structure."})}})()}}catch{_({type:"error",message:"Failed to save unit structure."})}},X=()=>{try{if(!r)return;const n=r.uic,l={...c};l[n]=l[n]||{},l[n]._sections=k[n]||[],l[n]._mcc=r.mcc||l[n]._mcc||"",l[n]._unitName=r.unitName||l[n]._unitName||"",C(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const ne=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",ne),_({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");_({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{_({type:"error",message:"Failed to persist unit sections."})}})()}catch{_({type:"error",message:"Failed to save unit sections."})}},ye=()=>{try{if(!r)return;const n=r.uic,l={...c};l[n]=l[n]||{},l[n]._commandSections=P[n]||[],l[n]._mcc=r.mcc||l[n]._mcc||"",l[n]._unitName=r.unitName||l[n]._unitName||"",C(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const ne=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",ne),_({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");_({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{_({type:"error",message:"Failed to persist command sections."})}})()}catch{_({type:"error",message:"Failed to save command sections."})}},ge=()=>{try{if(!r)return;const n=r.uic,l={...c};l[n]=l[n]||{},l[n]._platoonSectionMap=T[n]||{},l[n]._mcc=r.mcc||l[n]._mcc||"",l[n]._unitName=r.unitName||l[n]._unitName||"",C(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const ne=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",ne),_({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");_({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{_({type:"error",message:"Failed to persist links."})}})()}catch{_({type:"error",message:"Failed to save links."})}},ue=()=>{if(!r||!Q.trim())return;const n=r.uic,l={...c};l[n]=l[n]||{},l[n][Q.trim()]||(l[n][Q.trim()]=[],C(l),G(Q.trim()),W(""))},De=n=>{if(!r)return;const l=r.uic,S={...c};S[l]&&(delete S[l][n],C(S),j===n&&G(""))},pe=()=>{if(!r||!j||!d.trim())return;const n=r.uic,l={...c};l[n]=l[n]||{},l[n][j]=l[n][j]||[],l[n][j].includes(d.trim())||(l[n][j]=[...l[n][j],d.trim()],C(l),ee(""))},Te=n=>{if(!r||!j)return;const l=r.uic,S={...c};S[l][j]=(S[l][j]||[]).filter(ne=>ne!==n),C(S)},Fe=()=>{if(!r||!O.trim())return;const n=r.uic,l={...k};l[n]=l[n]||[],l[n].includes(O.trim())||(l[n]=[...l[n],O.trim()],N(l),M(""))},ze=n=>{if(!r)return;const l=r.uic,S={...k};S[l]=(S[l]||[]).filter(ne=>ne!==n),N(S)},Ue=()=>{if(!r||!H.trim())return;const n=r.uic,l={...P};l[n]=l[n]||[],l[n].includes(H.trim())||(l[n]=[...l[n],H.trim()],D(l),h(""))},ut=n=>{if(!r)return;const l=r.uic,S={...P};S[l]=(S[l]||[]).filter(ne=>ne!==n),D(S)},pt=()=>{const n=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],l=V.map(re=>[re.firstName,re.mi||"",re.lastName,re.email,re.edipi,re.service,re.rank,re.role,re.company,re.unit,re.unitUic||""].map(Kt=>{const ct=String(Kt??"");return ct.includes(",")||ct.includes('"')||ct.includes(`
`)?'"'+ct.replace(/"/g,'""')+'"':ct}).join(",")),S="\uFEFF"+[n.join(","),...l].join(`
`),ne=new Blob([S],{type:"text/csv;charset=utf-8"}),be=URL.createObjectURL(ne),we=document.createElement("a");we.href=be,we.download="users-export.csv",we.click(),URL.revokeObjectURL(be)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${_e==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>Le("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${_e==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>Le("users"),children:"User Administration"})]})})}),_e==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:r?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:r.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",r.uic," | RUC: ",r.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:Y,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:Q,onChange:n=>W(n.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:ue,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[je.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>G(n),children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>De(n),children:"Remove"})]},n)),je.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",j?`• ${j}`:""]}),r&&j&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ge,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:d,onChange:n=>ee(n.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!j}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:pe,disabled:!j,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[qe.map(n=>{var l,S;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:n})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:((S=(l=T[(r==null?void 0:r.uic)||""])==null?void 0:l[j])==null?void 0:S[n])||"",onChange:ne=>{const be=(r==null?void 0:r.uic)||"";Z(we=>{const re={...we};return re[be]=re[be]||{},re[be][j]=re[be][j]||{},re[be][j][n]=ne.target.value,re})},children:[e.jsx("option",{value:"",children:"Link to section"}),(k[(r==null?void 0:r.uic)||""]||[]).map(ne=>e.jsx("option",{value:ne,children:ne},ne))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Te(n),children:"Remove"})]})]},n)}),qe.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:X,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:O,onChange:n=>M(n.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Fe,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[tt.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>ze(n),children:"Remove"})]},n)),tt.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ye,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:H,onChange:n=>h(n.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:Ue,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Se.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:n}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>ut(n),children:"Remove"})]},n)),Se.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),_e==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),Oe&&e.jsxs("div",{className:"mb-4 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:[e.jsx("strong",{children:"Error loading users:"})," ",Oe]}),Me&&e.jsx("div",{className:"mb-4 p-3 border border-blue-200 bg-blue-50 text-blue-800 rounded",children:"Loading users..."}),!Me&&!Oe&&et>0&&w.length===0&&e.jsxs("div",{className:"mb-4 p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:[e.jsx("strong",{children:"Note:"})," ",et," user(s) found in database, but none match your unit (",(r==null?void 0:r.unitName)||"No unit selected",", UIC: ",(r==null?void 0:r.uic)||"N/A",").",e.jsx("br",{}),e.jsx("span",{className:"text-sm",children:"Users may be assigned to different units."})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[R.map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[n.lastName,", ",n.firstName,n.mi?` ${n.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:n.email}),e.jsx("td",{className:"py-2 px-3",children:n.edipi}),e.jsx("td",{className:"py-2 px-3",children:n.service}),e.jsx("td",{className:"py-2 px-3",children:n.rank}),e.jsx("td",{className:"py-2 px-3",children:n.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const l=Je.find(ne=>ne.uic===n.unitUic),S=l?l.unitName:n.unit;if(n.isUnitAdmin||n.role==="COMMANDER")return S||"—";if(n.role==="COMPANY_REVIEWER")return n.company&&n.company!=="N/A"?n.company:"—";if(n.role==="PLATOON_REVIEWER"){const ne=n.company&&n.company!=="N/A"?n.company:"",be=n.platoon&&n.platoon!=="N/A"?n.platoon:"",we=[ne,be].filter(Boolean);return we.length?we.join(" / "):"—"}return"—"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>K(n),children:"View"}),((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{Pe("admin"),z(n),q(n.role??"MEMBER"),Ae(n.company!=="N/A"?n.company:void 0),x(n.company!=="N/A"?n.company:void 0),ve(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),J(n.platoon&&n.platoon!=="N/A"?n.platoon:void 0),ke(typeof n.commandOrder=="number"?String(n.commandOrder):""),L(!!n.isUnitAdmin),xe(!!n.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{u(l=>l.filter(S=>S.id!==n.id));try{localStorage.removeItem(`fs/users/${n.id}.json`)}catch(l){console.error("Failed to remove user from localStorage",l)}},children:"Delete"})]})})]},n.id)),R.length===0&&!Me&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:Oe?"Failed to load users - check console for details":et===0?"No users found in database":A?"No users match your search":"No users in this unit"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:y,type:"text",placeholder:"Filter users...",value:A,onChange:n=>U(n.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var n;return(n=y.current)==null?void 0:n.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:pt,children:"Export All"})]})]}),F&&e.jsx(Vs,{user:F,onClose:()=>K(null)}),g&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>z(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>z(null),children:"✕"})]}),me==="profile"&&t&&g&&t.edipi===g.edipi&&e.jsx(Yt,{mode:"edit",initial:g,readOnly:!1,onSaved:n=>{u(l=>l.map(S=>S.edipi===n.edipi?n:S)),z(null),_({type:"success",message:"Profile updated."})}}),me==="admin"&&((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:ie,onChange:n=>{const l=n.target.value;q(l),l==="COMMANDER"&&(Ae(void 0),ve(void 0))},className:"w-full px-3 py-2 border rounded",children:Ws.map(n=>e.jsx("option",{value:n,children:n},n))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:ae||"",onChange:n=>ce(n.target.value||void 0),disabled:!ie.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:mt.length?"Select company":"No companies configured"}),mt.map(n=>e.jsx("option",{value:n,children:n},n))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:fe||"",onChange:n=>b(n.target.value||void 0),disabled:!ie.includes("REVIEW")||!ae,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:m.length?"Select platoon":"No platoons configured"}),m.map(n=>e.jsx("option",{value:n,children:n},n))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:o,onChange:n=>L(n.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:se,disabled:ie==="COMMANDER",onChange:async n=>{const l=n.target.checked;xe(l);try{if(g&&!(await Ze({id:g.id,email:g.email,rank:g.rank,firstName:g.firstName,lastName:g.lastName,mi:g.mi,service:g.service,role:g.role,unitUic:g.unitUic,unit:g.unit,company:g.company,isUnitAdmin:!!g.isUnitAdmin,isCommandStaff:l,edipi:g.edipi,passwordHash:g.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Unit Command Dashboard"})]})]}),Be.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:Be.map((n,l)=>e.jsx("div",{className:"text-sm",children:n},l))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{z(null),oe.current=!1,v([]),i(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${I?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":I,disabled:I,onClick:async()=>{var ne;if(!g)return;const n=[];if(ie==="COMPANY_REVIEWER"&&!Ne&&n.push("Company is required for Company Reviewer."),ie==="PLATOON_REVIEWER"&&(!Ne||!Ee)&&n.push("Company and Platoon are required for Platoon Reviewer."),v(n),n.length)return;i(!0);const l=((ne=Je.find(be=>be.uic===g.unitUic))==null?void 0:ne.unitName)||"N/A",S={...g,role:ie,isUnitAdmin:o,isCommandStaff:ie==="COMMANDER"?!1:se,company:Re||"N/A",unit:l,platoon:B||"N/A",roleCompany:ie.includes("REVIEW")?ae||"N/A":void 0,rolePlatoon:ie.includes("REVIEW")?fe||"N/A":void 0};try{localStorage.setItem(`fs/users/${S.edipi}.json`,JSON.stringify(S))}catch{}try{if(!(await Ze({id:S.id,email:S.email,rank:S.rank,firstName:S.firstName,lastName:S.lastName,mi:S.mi,service:S.service,role:S.role,unitUic:S.unitUic,unit:S.unit,company:S.company,isUnitAdmin:!!S.isUnitAdmin,isCommandStaff:!!S.isCommandStaff,edipi:S.edipi,passwordHash:S.passwordHash,roleCompany:S.roleCompany,rolePlatoon:S.rolePlatoon,platoon:S.platoon})).ok)throw new Error("persist_failed")}catch{i(!1),_({type:"error",message:"Failed to save administrative changes."});return}u(be=>be.map(we=>we.edipi===S.edipi?S:we));try{t&&t.edipi===S.edipi&&(localStorage.setItem("currentUser",JSON.stringify(S)),a(S))}catch{}z(null),oe.current=!1,i(!1),_({type:"success",message:"Administrative changes saved."})},children:[I&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),E&&e.jsx("div",{className:`p-3 rounded-lg border ${E.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:E.message})]})};function zs(){const[t,a]=s.useState([]),[r,f]=s.useState(null),[c,C]=s.useState({}),[k,N]=s.useState({}),[P,D]=s.useState([]),[T,Z]=s.useState("unit"),[j,G]=s.useState("assigned"),[Q,W]=s.useState([]),[d,ee]=s.useState(""),[O,M]=s.useState([]),[H,h]=s.useState(""),V=()=>{ot().then(v=>a(v)).catch(()=>a([]))},u=()=>{ht().then(v=>D(v)).catch(()=>D([]))},E=()=>{f(null),V(),u()};s.useEffect(()=>{E(),Ut().then(v=>W(v)),Bt().then(v=>M(v))},[T,j]);const _=s.useMemo(()=>{const v={};for(const I of t)I.isUnitAdmin&&I.unitUic&&(v[I.unitUic]=I);return v},[t]),A=s.useMemo(()=>{const v=new Set;return Je.filter(I=>v.has(I.uic)?!1:(v.add(I.uic),!0))},[]),U=s.useMemo(()=>{const v={};for(const I of t)if(I.isInstallationAdmin&&I.installationId){const i=I.installationId;v[i]=v[i]||[],v[i].push(I)}return v},[t]),y=v=>t.filter(I=>I.unitUic===v.uic||!I.unitUic&&I.unit===v.unitName),g=async v=>{const I=c[v.uic];if(!I)return;const i=t.find(L=>L.id===I);if(!i)return;const o={...i,isUnitAdmin:!0,unitUic:v.uic,unit:v.unitName,company:"N/A"};try{if(!(await Ze({id:o.id,email:o.email,rank:o.rank,firstName:o.firstName,lastName:o.lastName,mi:o.mi,service:o.service,role:o.role,unitUic:o.unitUic,unit:o.unit,company:o.company,isUnitAdmin:!!o.isUnitAdmin,isInstallationAdmin:!!o.isInstallationAdmin,isCommandStaff:!!o.isCommandStaff,edipi:o.edipi})).ok){f({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}a(L=>L.map(se=>se.id===o.id?o:se)),f({type:"success",message:`Assigned ${o.rank} ${o.lastName} as admin for ${v.unitName}.`})},z=s.useMemo(()=>A.filter(v=>!!_[v.uic]),[A,_]);s.useMemo(()=>(Array.isArray(t)?t:[]).filter(v=>!!v.isHqmcAdmin),[t]);const F=s.useMemo(()=>A.filter(v=>!_[v.uic]),[A,_]),K=s.useMemo(()=>(Array.isArray(Q)?Q:[]).filter(v=>{var I;return(I=U[v.id])==null?void 0:I.length}),[Q,U]),ie=s.useMemo(()=>(Array.isArray(Q)?Q:[]).filter(v=>{var I;return!((I=U[v.id])!=null&&I.length)}),[Q,U]),q=s.useMemo(()=>{const v={};for(const I of Array.isArray(t)?t:[])if(I.isHqmcAdmin&&I.hqmcDivision){const i=I.hqmcDivision;v[i]=v[i]||[],v[i].push(I)}return v},[t]),Ne=s.useMemo(()=>(Array.isArray(O)?O:[]).filter(v=>{var I;return(I=q[v.code])==null?void 0:I.length}),[O,q]);s.useMemo(()=>{const v=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return(Array.isArray(P)?P:[]).filter(I=>v.includes(String(I.currentStage||"")))},[P]);const[Ae,Ee]=s.useState(1),[ve,Re]=s.useState(10),x=z.length,B=Math.max(1,Math.ceil(x/(ve||1))),J=Math.min(Ae,B),ae=x===0?0:(J-1)*ve+1,ce=x===0?0:Math.min(ae+ve-1,x),fe=z.slice((J-1)*ve,(J-1)*ve+ve),[b,$]=s.useState(1),[te,de]=s.useState(10),le=F.length,Ce=Math.max(1,Math.ceil(le/(te||1))),ke=Math.min(b,Ce),_e=le===0?0:(ke-1)*te+1,Le=le===0?0:Math.min(_e+te-1,le),Be=F.slice((ke-1)*te,(ke-1)*te+te);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${T==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Z("unit"),G("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${T==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Z("installation"),G("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${T==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{Z("hqmc"),G("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${j==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>G("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${j==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>G("missing"),children:"Missing"})]}),T==="installation"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[K.map(v=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:v.name}),e.jsx("td",{className:"py-2 px-3",children:(U[v.id]||[]).map(I=>`${I.rank} ${I.lastName}, ${I.firstName}${I.mi?` ${I.mi}`:""}`).join(" • ")})]},v.id)),K.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),T==="installation"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[ie.map(v=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:v.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:k[v.id]||"",onChange:I=>N(i=>({...i,[v.id]:I.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(I=>e.jsx("option",{value:I.id,children:`${I.rank} ${I.lastName}, ${I.firstName}${I.mi?` ${I.mi}`:""}`},I.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!k[v.id],onClick:async()=>{const I=k[v.id],i=t.find(L=>L.id===I);if(!i)return;const o={...i,isInstallationAdmin:!0,installationId:v.id};try{if(!(await Ze({id:o.id,email:o.email,rank:o.rank,firstName:o.firstName,lastName:o.lastName,mi:o.mi,service:o.service,role:o.role,unitUic:o.unitUic,unit:o.unit,company:o.company,isUnitAdmin:!!o.isUnitAdmin,isInstallationAdmin:!!o.isInstallationAdmin,isCommandStaff:!!o.isCommandStaff,edipi:o.edipi,installationId:o.installationId})).ok){f({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}a(L=>L.map(se=>se.id===o.id?o:se)),f({type:"success",message:`Assigned ${o.rank} ${o.lastName} as installation admin.`})},children:"Assign"})})]},v.id)),ie.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),T==="unit"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[fe.map(v=>{const I=_[v.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:v.unitName}),e.jsx("td",{className:"py-2 px-3",children:v.uic}),e.jsx("td",{className:"py-2 px-3",children:`${I.rank} ${I.lastName}, ${I.firstName}${I.mi?` ${I.mi}`:""}`})]},v.uic)}),z.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(St,{currentPage:J,totalPages:B,totalItems:x,pageSize:ve,startIndex:ae,endIndex:ce,onPageChange:v=>Ee(v),onPageSizeChange:v=>{Re(v),Ee(1)},onNext:()=>Ee(Math.min(J+1,B)),onPrevious:()=>Ee(Math.max(J-1,1)),onFirst:()=>Ee(1),onLast:()=>Ee(B),canGoNext:J<B,canGoPrevious:J>1,pageSizeOptions:[5,10,25,50]})})]}),T==="unit"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[Be.map(v=>{const I=y(v);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:v.unitName}),e.jsx("td",{className:"py-2 px-3",children:v.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:c[v.uic]||"",onChange:i=>C(o=>({...o,[v.uic]:i.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:I.length?"Select user":"No eligible users"}),I.map(i=>e.jsx("option",{value:i.id,children:`${i.rank} ${i.lastName}, ${i.firstName}${i.mi?` ${i.mi}`:""}`},i.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!c[v.uic],onClick:()=>g(v),children:"Assign"})})]},v.uic)}),F.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(St,{currentPage:ke,totalPages:Ce,totalItems:le,pageSize:te,startIndex:_e,endIndex:Le,onPageChange:v=>$(v),onPageSizeChange:v=>{de(v),$(1)},onNext:()=>$(Math.min(ke+1,Ce)),onPrevious:()=>$(Math.max(ke-1,1)),onFirst:()=>$(1),onLast:()=>$(Ce),canGoNext:ke<Ce,canGoPrevious:ke>1,pageSizeOptions:[5,10,25,50]})})]}),T==="hqmc"&&j==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[Ne.map(v=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[v.code," — ",v.name]}),e.jsx("td",{className:"py-2 px-3",children:(q[v.code]||[]).map(I=>`${I.rank} ${I.lastName}, ${I.firstName}${I.mi?` ${I.mi}`:""}`).join(" • ")})]},v.code)),Ne.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),T==="hqmc"&&j==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[O.filter(v=>{var I;return!((I=q[v.code])!=null&&I.length)}).map(v=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[v.code," — ",v.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:k[`hqmc_${v.code}`]||"",onChange:I=>N(i=>({...i,[`hqmc_${v.code}`]:I.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(I=>e.jsx("option",{value:I.id,children:`${I.rank} ${I.lastName}, ${I.firstName}${I.mi?` ${I.mi}`:""}`},I.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!k[`hqmc_${v.code}`],onClick:async()=>{const I=k[`hqmc_${v.code}`],i=t.find(L=>L.id===I);if(!i)return;const o={...i,isHqmcAdmin:!0,hqmcDivision:v.code};try{if(!(await Ze({id:o.id,email:o.email,rank:o.rank,firstName:o.firstName,lastName:o.lastName,mi:o.mi,service:o.service,role:o.role,unitUic:o.unitUic,unit:o.unit,company:o.company,isUnitAdmin:!!o.isUnitAdmin,isInstallationAdmin:!!o.isInstallationAdmin,isCommandStaff:!!o.isCommandStaff,isHqmcAdmin:!!o.isHqmcAdmin,hqmcDivision:o.hqmcDivision,edipi:o.edipi})).ok){f({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}a(L=>L.map(se=>se.id===o.id?o:se)),f({type:"success",message:`Assigned ${o.rank} ${o.lastName} as HQMC admin for ${v.code}.`})},children:"Assign"})})]},v.code)),O.filter(v=>{var I;return!((I=q[v.code])!=null&&I.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),r&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${r.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:r.message})]})})}const qt=!0,Us=({onLoggedIn:t,onCreateAccount:a})=>{const[r,f]=s.useState(""),[c,C]=s.useState(""),[k,N]=s.useState(null),[P,D]=s.useState(!0),[T,Z]=s.useState(!0);ts.useEffect(()=>{},[]);const j=async G=>{G.preventDefault(),N(null);try{const Q=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,W=/^[0-9]{10}$/.test(r),d=qt?Q.test(r.trim().toLowerCase())||W:Q.test(r.trim().toLowerCase()),ee=c.length>=6;if(D(d),Z(ee),!d){N({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!ee){N({type:"error",message:"Password must be at least 6 characters."});return}let O=null,M=null,H=r.trim().toLowerCase();if(qt&&W){const{user:U,error:y}=await Nt(String(r));O=U,M=y,H=String((O==null?void 0:O.email)||"")}else if(Q.test(H)){const{user:U,error:y}=await It(H);O=U,M=y}else{N({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(M){N({type:"error",message:`Database Error: ${M}`});return}if(!O||!H){N({type:"error",message:"Account not found."});return}const h=String(O.passwordHash||O.password_hash||"").trim();if(!h){N({type:"error",message:"No password set for this user."});return}const V=await Ct(c);if(!(/^[0-9a-f]{64}$/i.test(h)?h.toLowerCase()===V.toLowerCase():h===c)){N({type:"error",message:"Invalid credentials."});return}const{user:_,error:A}=await It(H);if(A){N({type:"error",message:`Profile Error: ${A}`});return}if(!_){console.error("[Login] User profile not found after successful password verification",{emailForLogin:H}),N({type:"error",message:"User profile not found."});return}N({type:"success",message:"Logged in."}),t(_)}catch(Q){console.error("[Login] Login failed:",Q),N({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:j,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:r,onChange:G=>f(G.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${P?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!P}),!P&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:c,onChange:G=>C(G.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${T?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!T}),!T&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),k&&e.jsx("div",{className:`p-3 rounded-lg border ${k.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:k.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:a,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!P||!T,children:"Login"})]})]})]})},Tt=""+new URL("logo-DLcHofKE.png",import.meta.url).href,Qs=({currentUser:t,hasSectionDashboard:a,hasCommandDashboard:r,hasInstallationSectionDashboard:f=!1,hasInstallationCommandDashboard:c=!1,hasHQMCSectionDashboard:C=!1,hasHQMCApproverDashboard:k=!1,onManageProfile:N,onLogout:P,onNavigate:D,isLogin:T=!1})=>{const[Z,j]=s.useState(!1),[G,Q]=s.useState(!1),W=s.useRef(null);return s.useEffect(()=>{const d=O=>{if(!Z)return;const M=W.current;M&&O.target&&!M.contains(O.target)&&j(!1)},ee=O=>{O.key==="Escape"&&j(!1)};return document.addEventListener("mousedown",d),document.addEventListener("touchstart",d,{passive:!0}),document.addEventListener("keydown",ee),()=>{document.removeEventListener("mousedown",d),document.removeEventListener("touchstart",d),document.removeEventListener("keydown",ee)}},[Z]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:T?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:Tt,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:Tt,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:t?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[t.rank," ",t.lastName,t.lastName?",":""," ",t.firstName,t.mi?` ${t.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[t.service," • ",t.role,(()=>{const d={PLATOON_REVIEWER:t.role_platoon,COMPANY_REVIEWER:t.role_company}[t.role];return d?` - ${d}`:null})()]}),(()=>{var H;const d=((H=Je.find(h=>h.uic===((t==null?void 0:t.unitUic)||"")))==null?void 0:H.unitName)||(t==null?void 0:t.unit)||"",ee=t!=null&&t.company&&t.company!=="N/A"?t.company:t!=null&&t.user_company&&t.user_company!=="N/A"?t.user_company:null,O=t!=null&&t.platoon&&t.platoon!=="N/A"?t.platoon:t!=null&&t.user_platoon&&t.user_platoon!=="N/A"?t.user_platoon:null,M=[d||null,ee,O].filter(Boolean);return M.length?e.jsx("div",{className:"text-xs text-white/70",children:M.join(" • ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:N,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:P,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),t&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>Q(!G),children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),G&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{N(),Q(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{P(),Q(!1)},children:"Logout"})]})]}),!t&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>D("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:W,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":Z,onClick:()=>j(d=>!d),children:"Dashboards"}),e.jsxs("div",{className:`${Z?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:t&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{D("dashboard"),j(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(t==null?void 0:t.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{D("admin"),j(!1)},children:"Unit Admin"}),t&&!!t.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{D("appadmin"),j(!1)},children:"App Admin"}),t&&!!t.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{D("hqmc-admin"),j(!1)},children:"HQMC Admin"}),t&&!!t.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{D("installation"),j(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[t&&a&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{D("section"),j(!1)},children:"Unit Section Dashboard"}),r&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{D("command"),j(!1)},children:"Unit Command Dashboard"}),String((t==null?void 0:t.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{D("review"),j(!1)},children:"Unit Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[t&&f&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{D("installation-section"),j(!1)},children:"Installation Section Dashboard"}),t&&c&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{D("installation-command"),j(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[t&&(C||!!t.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{D("hqmc-section"),j(!1)},children:"HQMC Section Dashboard"}),t&&k&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{D("hqmc-approver"),j(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})},Ve={SECTION:"perm_section",COMMAND:"perm_command",INST_SECTION:"perm_inst_section",INST_COMMAND:"perm_inst_command",HQMC_SECTION:"perm_hqmc_section",HQMC_APPROVER:"perm_hqmc_approver"},it=t=>{try{return localStorage.getItem(t)==="true"}catch(a){return console.error(`Failed to read from localStorage for key "${t}":`,a),!1}};function Gs(){const[t,a]=s.useState(null),[r,f]=s.useState("login"),[c,C]=s.useState(()=>{try{const u=localStorage.getItem("currentUser");return u?JSON.parse(u):null}catch(u){return console.error("Failed to parse user from localStorage:",u),null}}),[k,N]=s.useState("create"),[P,D]=s.useState(!1),[T,Z]=s.useState(()=>it(Ve.SECTION)),[j,G]=s.useState(()=>it(Ve.COMMAND)),[Q,W]=s.useState(()=>it(Ve.INST_SECTION)),[d,ee]=s.useState(()=>it(Ve.INST_COMMAND)),[O,M]=s.useState(()=>it(Ve.HQMC_SECTION)),[H,h]=s.useState(()=>it(Ve.HQMC_APPROVER)),V=ss();return s.useEffect(()=>{try{const E=new URLSearchParams(window.location.search).get("view");if(E==="admin"||E==="profile"||E==="dashboard"||E==="login"||E==="appadmin"||E==="hqmc-admin"||E==="hqmc-section"||E==="hqmc-approver"||E==="review"||E==="section"||E==="command"||E==="installation"||E==="installation-section"||E==="installation-command"||E==="documents"||E==="document-viewer"||E==="upload")f(E);else{const _=localStorage.getItem("currentView"),A=localStorage.getItem("currentUser");f(_&&A?_:"login")}}catch{f("login")}},[]),s.useEffect(()=>{c?localStorage.setItem("currentUser",JSON.stringify(c)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"),Object.values(Ve).forEach(u=>{try{localStorage.removeItem(u)}catch(E){console.error(`Failed to remove item from localStorage for key "${u}":`,E)}}))},[c]),s.useEffect(()=>{if(!c)return;const u={[Ve.SECTION]:T,[Ve.COMMAND]:j,[Ve.INST_SECTION]:Q,[Ve.INST_COMMAND]:d,[Ve.HQMC_SECTION]:O,[Ve.HQMC_APPROVER]:H};for(const[E,_]of Object.entries(u))try{localStorage.setItem(E,String(_))}catch(A){console.error(`Failed to set item in localStorage for key "${E}":`,A)}},[c,T,j,Q,d,O,H]),s.useEffect(()=>{let u=!1;return(async()=>{try{const E=(c==null?void 0:c.id)||"";if(!E)return;const _=await Ht(E);if(_&&!u){const A=(g,z)=>g===!0||g===!1?g:z||!1,U=(g,z)=>g!=null?g||void 0:z,y={..._,isAppAdmin:A(_.isAppAdmin,c==null?void 0:c.isAppAdmin),isUnitAdmin:A(_.isUnitAdmin,c==null?void 0:c.isUnitAdmin),isInstallationAdmin:A(_.isInstallationAdmin,c==null?void 0:c.isInstallationAdmin),isHqmcAdmin:A(_.isHqmcAdmin,c==null?void 0:c.isHqmcAdmin),isCommandStaff:A(_.isCommandStaff,c==null?void 0:c.isCommandStaff),installationId:U(_.installationId,c==null?void 0:c.installationId),hqmcDivision:U(_.hqmcDivision,c==null?void 0:c.hqmcDivision)};C(y),localStorage.setItem("currentUser",JSON.stringify(y))}}catch{}})(),()=>{u=!0}},[]),s.useEffect(()=>{r!=="login"&&c&&localStorage.setItem("currentView",r)},[r,c]),s.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const E=await bt();localStorage.setItem("unit_structure",JSON.stringify(E))}catch(u){console.error("Failed to load unit structure:",u)}})()},[]),s.useEffect(()=>{var u,E,_;if(c){try{const A=localStorage.getItem("unit_structure");if(A){const U=JSON.parse(A),y=(c==null?void 0:c.unitUic)||"",g=c!=null&&c.company&&c.company!=="N/A"?c.company:"",z=c!=null&&c.platoon&&c.platoon!=="N/A"?c.platoon:"",F=((_=(E=(u=U==null?void 0:U[y])==null?void 0:u._platoonSectionMap)==null?void 0:E[g])==null?void 0:_[z])||"";Z(!!F)}}catch(A){console.error("Failed to parse unit structure for section dashboard check",A)}G(!!(c!=null&&c.isCommandStaff)),(async()=>{try{const A=(c==null?void 0:c.installationId)||"";if(!A){W(!1),ee(!1);return}const U=await Ut();try{localStorage.setItem("installations_cache",JSON.stringify(U))}catch{}const y=U==null?void 0:U.find(K=>K.id===A),g=(c==null?void 0:c.id)||"",z=!!(y&&y.sectionAssignments&&Object.values(y.sectionAssignments).some(K=>Array.isArray(K)&&K.includes(g))),F=!!(y&&(y.commandSectionAssignments&&Object.values(y.commandSectionAssignments).some(K=>Array.isArray(K)&&K.includes(g))||y.commanderUserId&&String(y.commanderUserId)===g));W(z),ee(F)}catch{}})(),(async()=>{try{const A=String((c==null?void 0:c.hqmcDivision)||""),U=String((c==null?void 0:c.id)||"");if(!A||!U){M(!!(c!=null&&c.isHqmcAdmin)),h(!1);return}const{listHQMCSectionAssignmentsLegacy:y}=await as(async()=>{const{listHQMCSectionAssignmentsLegacy:K}=await import("./db-BMYSV76n.js").then(ie=>ie.A);return{listHQMCSectionAssignmentsLegacy:K}},__vite__mapDeps([0,1,2]),import.meta.url),g=await y(),z=g.some(K=>K.division_code===A&&((K.reviewers||[]).includes(U)||(K.approvers||[]).includes(U))),F=g.some(K=>K.division_code===A&&(K.approvers||[]).includes(U));M(z||!!(c!=null&&c.isHqmcAdmin)),h(F)}catch{c!=null&&c.isHqmcAdmin&&M(!0)}})()}},[c]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(Qs,{currentUser:c,hasSectionDashboard:T,hasCommandDashboard:j,hasInstallationSectionDashboard:Q,hasInstallationCommandDashboard:d,hasHQMCSectionDashboard:O,hasHQMCApproverDashboard:H,onManageProfile:()=>{N("edit"),f("profile"),V("/?view=profile")},onLogout:()=>{C(null),f("login"),V("/?view=login")},onNavigate:u=>{f(u),V(`/?view=${u}`)},isLogin:r==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:r==="profile"?e.jsx(Yt,{mode:k,initial:k==="edit"?c||{}:{},onSaved:u=>{C(u),f("dashboard"),V("/?view=dashboard")}}):r==="admin"?e.jsx(Hs,{}):r==="appadmin"?e.jsx(zs,{}):r==="login"?e.jsx(Us,{onLoggedIn:u=>{C(u),f("dashboard"),V("/?view=dashboard")},onCreateAccount:()=>{N("create"),f("profile"),V("/?view=profile")}}):r==="review"?e.jsx(Ds,{}):r==="section"?e.jsx(gs,{}):r==="command"?e.jsx(bs,{}):r==="installation"?e.jsx(ms,{}):r==="hqmc-admin"?e.jsx($s,{}):r==="installation-section"?e.jsx(fs,{}):r==="installation-command"?e.jsx(ys,{}):r==="hqmc-section"?e.jsx(Ls,{}):r==="hqmc-approver"?e.jsx(qs,{}):e.jsx(Es,{selectedUnit:t,currentUser:c})})]})}function ca(){return e.jsx(Gs,{})}export{ca as default};
