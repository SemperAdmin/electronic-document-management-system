const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./db-LFYbNZmQ.js","./index-DD-gkEsk.js","./index-DsXcz87g.css"])))=>i.map(i=>d[i]);
import{j as e,r as s,a as Jt,s as Dt,v as Yt,l as lt,M as wt,b as Kt,u as Zt,R as Xt,c as es,_ as ts}from"./index-DD-gkEsk.js";import{s as Ie,d as ss,a as as,b as ns,l as ft,c as rt,e as Ue,u as Be,f as ut,g as vt,h as Ve,i as rs,j as is,k as $t,m as yt,n as Lt,o as xt,p as os,q as ls,r as _t,t as qt,v as pt,w as Tt,x as St}from"./db-LFYbNZmQ.js";import{P as ht,I as cs}from"./InstallationAdmin-ChdoSGmZ.js";import{f as Bt,R as ze,S as Ye,o as Ct,c as ds}from"./RequestTable-jNATZvuO.js";import{l as jt}from"./unitStructure-QC5qYuxv.js";import ms from"./SectionDashboard-2nbYUIE-.js";import us from"./CommandDashboard-EvoNKbXs.js";import xs from"./InstallationSectionDashboard-D6R7XH_G.js";import ps from"./InstallationCommandDashboard-of-waCKR.js";import{U as We}from"./units-CaNgy_2U.js";import"./SearchableUnitSelector-BWezIby-.js";const hs={pdf:"bg-red-100 text-red-700 border-red-200",doc:"bg-blue-100 text-blue-700 border-blue-200",xls:"bg-green-100 text-green-700 border-green-200",img:"bg-purple-100 text-purple-700 border-purple-200",txt:"bg-gray-100 text-gray-700 border-gray-200",file:"bg-gray-100 text-gray-700 border-gray-200"},gs={pdf:"PDF",doc:"DOC",xls:"XLS",img:"IMG",txt:"TXT",file:"FILE"};function Nt(t,a){const i=t.toLowerCase(),p=(a||"").toLowerCase();return i.includes("pdf")||p.endsWith(".pdf")?"pdf":i.includes("excel")||i.includes("spreadsheet")||p.endsWith(".xls")||p.endsWith(".xlsx")?"xls":i.includes("word")||i.includes("wordprocessingml")||p.endsWith(".doc")||p.endsWith(".docx")?"doc":i.includes("image")||/\.(jpg|jpeg|png|gif|webp|svg|bmp)$/i.test(p)?"img":i.includes("text")||p.endsWith(".txt")?"txt":"file"}function at(t,a){const i=Nt(t,a);return i==="pdf"||i==="img"}const et=({type:t,fileName:a,size:i="md",className:p=""})=>{const d=Nt(t,a),N=hs[d],S=gs[d],b={sm:"w-8 h-8 text-xs",md:"w-10 h-10 text-xs",lg:"w-12 h-12 text-sm"};return e.jsx("div",{className:`
        ${b[i]}
        ${N}
        rounded border flex items-center justify-center font-bold
        ${p}
      `,role:"img","aria-label":`${S} file`,children:S})},Wt=({url:t,fileName:a,mimeType:i,fileSize:p,isOpen:d,onClose:N,onDownload:S})=>{const[b,I]=s.useState(!0),[P,D]=s.useState(null),[z,v]=s.useState(100),V=Nt(i,a),H=at(i,a);s.useEffect(()=>{I(!0),D(null),v(100)},[t]);const O=s.useCallback(()=>{I(!1)},[]),u=s.useCallback(()=>{I(!1),D("Failed to load document preview")},[]),K=s.useCallback(j=>{j.key==="Escape"?N():j.key==="+"||j.key==="="?v(L=>Math.min(L+25,200)):j.key==="-"?v(L=>Math.max(L-25,50)):j.key==="0"&&v(100)},[N]);s.useEffect(()=>(d&&(document.addEventListener("keydown",K),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",K),document.body.style.overflow=""}),[d,K]);const T=j=>j?j<1024?`${j} B`:j<1024*1024?`${(j/1024).toFixed(1)} KB`:`${(j/(1024*1024)).toFixed(1)} MB`:"";return!d||typeof window>"u"?null:Jt.createPortal(e.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-[9999]",onClick:N,role:"dialog","aria-modal":"true","aria-labelledby":"preview-title",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow-2xl w-full max-w-5xl max-h-[90vh] mx-4 flex flex-col overflow-hidden",onClick:j=>j.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx(et,{type:i,fileName:a,size:"md"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{id:"preview-title",className:"font-medium text-[var(--text)] truncate",children:a}),p&&e.jsx("p",{className:"text-sm text-[var(--muted)]",children:T(p)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[V==="img"&&e.jsxs("div",{className:"flex items-center gap-1 mr-2",children:[e.jsx("button",{onClick:()=>v(j=>Math.max(j-25,50)),className:"p-1.5 rounded hover:bg-gray-200 text-gray-600","aria-label":"Zoom out",disabled:z<=50,children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),e.jsxs("span",{className:"text-sm text-gray-600 w-12 text-center",children:[z,"%"]}),e.jsx("button",{onClick:()=>v(j=>Math.min(j+25,200)),className:"p-1.5 rounded hover:bg-gray-200 text-gray-600","aria-label":"Zoom in",disabled:z>=200,children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})}),e.jsx("button",{onClick:()=>v(100),className:"p-1.5 rounded hover:bg-gray-200 text-gray-600 text-xs","aria-label":"Reset zoom",children:"Reset"})]}),S?e.jsxs("button",{onClick:S,className:"flex items-center gap-1.5 px-3 py-1.5 bg-brand-navy text-brand-cream rounded-lg hover:bg-brand-navy/90 text-sm",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Download"]}):e.jsxs("a",{href:t,download:a,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-1.5 px-3 py-1.5 bg-brand-navy text-brand-cream rounded-lg hover:bg-brand-navy/90 text-sm",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Download"]}),e.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"p-1.5 rounded hover:bg-gray-200 text-gray-600","aria-label":"Open in new tab",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})})}),e.jsx("button",{onClick:N,className:"p-1.5 rounded hover:bg-gray-200 text-gray-600","aria-label":"Close preview",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),e.jsxs("div",{className:"flex-1 overflow-auto bg-gray-100 relative min-h-[400px]",children:[b&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 border-4 border-brand-navy/20 border-t-brand-navy rounded-full animate-spin"}),e.jsx("p",{className:"text-sm text-[var(--muted)]",children:"Loading preview..."})]})}),P&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-8 h-8 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsx("p",{className:"text-[var(--text)] font-medium mb-1",children:P}),e.jsx("p",{className:"text-sm text-[var(--muted)]",children:"Try downloading the file instead"})]})}),H?V==="pdf"?e.jsx("iframe",{src:`${t}#toolbar=1&navpanes=0`,className:"w-full h-full min-h-[500px]",title:`Preview of ${a}`,onLoad:O,onError:u}):V==="img"?e.jsx("div",{className:"flex items-center justify-center p-4 min-h-[400px]",children:e.jsx("img",{src:t,alt:a,className:"max-w-full max-h-full object-contain transition-transform duration-200",style:{transform:`scale(${z/100})`},onLoad:O,onError:u})}):null:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx(et,{type:i,fileName:a,size:"lg",className:"mx-auto mb-4"}),e.jsx("p",{className:"text-[var(--text)] font-medium mb-1",children:"Preview not available"}),e.jsx("p",{className:"text-sm text-[var(--muted)] mb-4",children:"This file type cannot be previewed in the browser"}),e.jsxs("a",{href:t,download:a,className:"inline-flex items-center gap-2 px-4 py-2 bg-brand-navy text-brand-cream rounded-lg hover:bg-brand-navy/90",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Download File"]})]})})]}),e.jsxs("div",{className:"px-4 py-2 border-t border-gray-200 bg-gray-50 text-xs text-[var(--muted)] flex items-center justify-between",children:[e.jsx("span",{children:"Press ESC to close"}),V==="img"&&e.jsx("span",{children:"+/- to zoom, 0 to reset"})]})]})}),document.body)},bs={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},fs=({filters:t,onFiltersChange:a,statusOptions:i=[],originatorOptions:p=[],searchPlaceholder:d="Search requests...",showAdvanced:N=!0,className:S=""})=>{var L;const[b,I]=s.useState(!1),P=s.useRef(null),D=s.useMemo(()=>Array.isArray(t.status)?t.status:[],[t.status]),z=s.useMemo(()=>{let h=0;return D.length>0&&h++,t.dateFrom&&h++,t.dateTo&&h++,t.originatorId&&h++,h},[D,t.dateFrom,t.dateTo,t.originatorId]),v=s.useCallback(h=>{a({...t,search:h.target.value})},[t,a]),V=s.useCallback(h=>{const _=D.includes(h)?D.filter(m=>m!==h):[...D,h];a({...t,status:_})},[t,D,a]),H=s.useCallback(h=>{a({...t,dateFrom:h.target.value})},[t,a]),O=s.useCallback(h=>{a({...t,dateTo:h.target.value})},[t,a]),u=s.useCallback(h=>{a({...t,originatorId:h.target.value})},[t,a]),K=s.useCallback(()=>{var h;a(bs),(h=P.current)==null||h.focus()},[a]),T=s.useCallback(()=>{var h;a({...t,search:""}),(h=P.current)==null||h.focus()},[t,a]);s.useEffect(()=>{const h=_=>{var m;(_.metaKey||_.ctrlKey)&&_.key==="k"&&(_.preventDefault(),(m=P.current)==null||m.focus())};return document.addEventListener("keydown",h),()=>document.removeEventListener("keydown",h)},[]);const j=t.search||z>0;return e.jsxs("div",{className:`space-y-3 ${S}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{ref:P,type:"text",value:t.search,onChange:v,placeholder:d,className:"block w-full pl-10 pr-10 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold bg-[var(--surface)] text-[var(--text)]","aria-label":"Search"}),t.search&&e.jsx("button",{onClick:T,className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600","aria-label":"Clear search",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"absolute inset-y-0 right-8 flex items-center pointer-events-none text-xs text-gray-400",children:e.jsx("kbd",{className:"hidden sm:inline-block px-1.5 py-0.5 bg-gray-100 rounded border border-gray-200 font-mono",children:"⌘K"})})]}),N&&e.jsxs("button",{onClick:()=>I(!b),className:`
              flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors
              ${b||z>0?"bg-brand-gold/10 border-brand-gold text-brand-navy":"border-brand-navy/30 text-[var(--text)] hover:bg-brand-cream/50"}
            `,"aria-expanded":b,"aria-controls":"filter-panel",children:[e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"})}),e.jsx("span",{className:"hidden sm:inline",children:"Filters"}),z>0&&e.jsx("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-brand-navy rounded-full",children:z})]}),j&&e.jsxs("button",{onClick:K,className:"flex items-center gap-1 px-3 py-2 text-sm text-brand-red hover:text-brand-red-2 hover:bg-red-50 rounded-lg transition-colors","aria-label":"Clear all filters",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),N&&b&&e.jsxs("div",{id:"filter-panel",className:"p-4 bg-brand-cream/30 border border-brand-navy/10 rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[i.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Status"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:i.map(h=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-white/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:D.includes(h.value),onChange:()=>V(h.value),className:"h-4 w-4 text-brand-navy border-gray-300 rounded focus:ring-brand-gold"}),e.jsx("span",{className:"text-sm text-[var(--text)]",children:h.label})]},h.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Date Range"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"From date"}),e.jsx("input",{type:"date",value:t.dateFrom,onChange:H,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"From date"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"sr-only",children:"To date"}),e.jsx("input",{type:"date",value:t.dateTo,onChange:O,min:t.dateFrom,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"To date"})]})]})]}),p.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Originator"}),e.jsxs("select",{value:t.originatorId,onChange:u,className:"block w-full px-3 py-2 border border-brand-navy/30 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-gold","aria-label":"Filter by originator",children:[e.jsx("option",{value:"",children:"All originators"}),p.map(h=>e.jsx("option",{value:h.value,children:h.label},h.value))]})]})]}),z>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 pt-2 border-t border-brand-navy/10",children:[e.jsx("span",{className:"text-sm text-[var(--muted)]",children:"Active filters:"}),D.map(h=>{const _=i.find(m=>m.value===h);return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[(_==null?void 0:_.label)||h,e.jsx("button",{onClick:()=>V(h),className:"hover:text-brand-red","aria-label":`Remove ${(_==null?void 0:_.label)||h} filter`,children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},h)}),t.dateFrom&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["From: ",t.dateFrom,e.jsx("button",{onClick:()=>a({...t,dateFrom:""}),className:"hover:text-brand-red","aria-label":"Remove from date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.dateTo&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:["To: ",t.dateTo,e.jsx("button",{onClick:()=>a({...t,dateTo:""}),className:"hover:text-brand-red","aria-label":"Remove to date filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.originatorId&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-brand-navy/10 text-brand-navy rounded-full text-xs",children:[((L=p.find(h=>h.value===t.originatorId))==null?void 0:L.label)||"Originator",e.jsx("button",{onClick:()=>a({...t,originatorId:""}),className:"hover:text-brand-red","aria-label":"Remove originator filter",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]})]})};function vs(t,a){return s.useMemo(()=>{let i=Array.isArray(a.items)?a.items:[];const p=Array.isArray(t.status)?t.status:[];if(t.search){const d=t.search.toLowerCase();i=i.filter(N=>a.getSearchText(N).toLowerCase().includes(d))}return p.length>0&&a.getStatus&&(i=i.filter(d=>p.includes(a.getStatus(d)))),(t.dateFrom||t.dateTo)&&a.getDate&&(i=i.filter(d=>{const N=a.getDate(d);if(!N)return!1;const S=new Date(N);if(isNaN(S.getTime()))return!1;if(t.dateFrom){const b=new Date(t.dateFrom);if(S<b)return!1}if(t.dateTo){const b=new Date(t.dateTo);if(b.setHours(23,59,59,999),S>b)return!1}return!0})),t.originatorId&&a.getOriginatorId&&(i=i.filter(d=>a.getOriginatorId(d)===t.originatorId)),i},[t,a])}function At(t){if(t==null)return"";const a=String(t);return a.includes('"')||a.includes(",")||a.includes(`
`)||a.includes("\r")?`"${a.replace(/"/g,'""')}"`:a}function ys(t,a){const p=a.map(N=>At(N.header)).join(","),d=t.map(N=>a.map(S=>{const b=S.getValue(N),I=S.format?S.format(b):b;return At(I)}).join(","));return[p,...d].join(`\r
`)}function js(t,a){const i=t.map(p=>{const d={};return a.forEach(N=>{const S=N.getValue(p);d[N.header]=N.format?N.format(S):S}),d});return JSON.stringify(i,null,2)}function kt(t,a,i){const p=new Blob([t],{type:`${i};charset=utf-8;`}),d=URL.createObjectURL(p),N=document.createElement("a");N.href=d,N.download=a,document.body.appendChild(N),N.click(),document.body.removeChild(N),URL.revokeObjectURL(d)}function Ns({items:t,columns:a,filename:i="export",label:p="Export",variant:d="secondary",className:N="",disabled:S=!1,showCount:b=!0,formats:I=["csv"]}){const[P,D]=s.useState(!1),[z,v]=s.useState(!1),V=s.useRef(null),H=s.useCallback(K=>{v(!0),D(!1),setTimeout(()=>{try{const T=new Date().toISOString().slice(0,10),j=`${i}_${T}`;if(K==="csv"){const L=ys(t,a);kt(L,`${j}.csv`,"text/csv")}else{const L=js(t,a);kt(L,`${j}.json`,"application/json")}}catch(T){console.error("Export failed:",T)}finally{v(!1)}},100)},[t,a,i]);s.useEffect(()=>{const K=T=>{V.current&&!V.current.contains(T.target)&&D(!1)};return P&&document.addEventListener("mousedown",K),()=>{document.removeEventListener("mousedown",K)}},[P]),s.useEffect(()=>{const K=T=>{T.key==="Escape"&&D(!1)};return P&&document.addEventListener("keydown",K),()=>{document.removeEventListener("keydown",K)}},[P]);const O={primary:"bg-brand-navy text-brand-cream hover:bg-brand-navy/90",secondary:"bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold/10",text:"text-brand-navy hover:bg-brand-cream/50"},u=S||t.length===0||z;return I.length===1?e.jsxs("button",{onClick:()=>H(I[0]),disabled:u,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${O[d]}
          ${N}
        `,children:[z?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:p}),b&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]})]}):e.jsxs("div",{className:"relative",ref:V,children:[e.jsxs("button",{onClick:()=>D(!P),disabled:u,className:`
          inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
          transition-colors focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2
          disabled:opacity-50 disabled:cursor-not-allowed
          ${O[d]}
          ${N}
        `,"aria-expanded":P,"aria-haspopup":"menu",children:[z?e.jsxs("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),e.jsx("span",{children:p}),b&&t.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:["(",t.length,")"]}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${P?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),P&&e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-[var(--surface)] border border-brand-navy/20 rounded-lg shadow-lg z-50",role:"menu",children:[I.includes("csv")&&e.jsxs("button",{onClick:()=>H("csv"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 first:rounded-t-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export as CSV"]}),I.includes("json")&&e.jsxs("button",{onClick:()=>H("json"),className:"w-full flex items-center gap-2 px-4 py-2 text-sm text-[var(--text)] hover:bg-brand-cream/50 last:rounded-b-lg",role:"menuitem",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})}),"Export as JSON"]})]})]})}const Et=t=>{if(!t)return"";const a=new Date(t);return isNaN(a.getTime())?"":a.toLocaleDateString()};function gt(t,a={}){const{pageSize:i=25,initialPage:p=1}=a,[d,N]=s.useState(p),[S,b]=s.useState(i),I=t.length,P=Math.ceil(I/S),D=(d-1)*S,z=Math.min(D+S,I);return{currentData:s.useMemo(()=>t.slice(D,z),[t,D,z]),currentPage:d,pageSize:S,totalPages:P,totalItems:I,goToPage:j=>{const L=Math.max(1,Math.min(j,P));N(L)},nextPage:()=>{d<P&&N(d+1)},previousPage:()=>{d>1&&N(d-1)},goToFirstPage:()=>{N(1)},goToLastPage:()=>{N(P)},setPageSize:j=>{b(j),N(1)},canGoNext:d<P,canGoPrevious:d>1,startIndex:D+1,endIndex:z}}const Ke="edms-docs";function ws(){return{uploadFile:async(N,S)=>{if(!Ie)return{url:"",error:"Supabase not configured"};try{const{error:b}=await Ie.storage.from(Ke).upload(S,N,{upsert:!0});if(b)return{url:"",error:b.message};const{data:I}=Ie.storage.from(Ke).getPublicUrl(S);return{url:(I==null?void 0:I.publicUrl)||""}}catch(b){return{url:"",error:b instanceof Error?b.message:"Upload failed"}}},deleteFile:async N=>{if(!Ie||!N)return!1;try{return await Ie.storage.from(Ke).remove([N]),!0}catch{return!1}},deleteFolder:async N=>{if(!Ie)return!1;try{const{data:S}=await Ie.storage.from(Ke).list(N.replace(/\/$/,""));if(S&&S.length>0){const b=S.map(I=>`${N.replace(/\/$/,"")}/${I.name}`);await Ie.storage.from(Ke).remove(b)}return!0}catch{return!1}},extractStoragePath:N=>{if(!N)return null;try{const S=N.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)$/);if(S!=null&&S[1])return decodeURIComponent(S[1])}catch{}return null},buildStoragePath:(N,S,b,I)=>{const P=Date.now();return`${N||"N-A"}/${S}/${P}-${I}-${Dt(b)}`}}}const Xe=t=>{const a=String(t||"").trim();return a&&a!=="N/A"?a:""},It=(t,a,i)=>t.some(p=>String(p.role||"")!==a||Xe(p.roleCompany||p.company)!==i.company||a==="PLATOON_REVIEWER"&&Xe(p.rolePlatoon||p.platoon)!==(i.platoon||"")?!1:String(p.unitUic||"")===String(i.uic||""));function Ft(t){if(t===0)return"0 Bytes";const a=1024,i=["Bytes","KB","MB","GB"],p=Math.floor(Math.log(t)/Math.log(a));return parseFloat((t/Math.pow(a,p)).toFixed(2))+" "+i[p]}const Rt=s.memo(function({doc:a,onView:i,onDelete:p}){const[d,N]=s.useState(!1),S=a.fileUrl&&at(a.type,a.name);return e.jsxs(e.Fragment,{children:[e.jsxs("article",{className:"flex items-center justify-between p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] hover:bg-brand-cream/50 transition-colors","aria-label":`Document: ${a.subject}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(et,{type:a.type,fileName:a.name,size:"md"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-[var(--text)]",children:a.subject}),e.jsxs("p",{className:"text-sm text-[var(--muted)]",children:[a.name," • ",Ft(a.size)," • ",new Date(a.uploadedAt).toLocaleDateString()]}),a.dueDate&&e.jsxs("p",{className:"text-xs text-[var(--muted)]",children:["Due ",new Date(a.dueDate).toLocaleDateString()]}),a.notes&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Notes: ",a.notes]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",role:"group","aria-label":"Document actions",children:[a.currentStage&&e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:Bt({currentStage:a.currentStage})}),S&&e.jsx("button",{type:"button",onClick:b=>{b.stopPropagation(),N(!0)},className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold","aria-label":`Preview document ${a.name}`,children:"Preview"}),a.fileUrl&&e.jsx("a",{href:a.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-label":`Open document ${a.name} in new tab`,children:"Open"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:brightness-105 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2",onClick:b=>{b.stopPropagation(),i(a)},"aria-label":`View or edit document ${a.subject}`,children:"View/Edit"}),e.jsx("button",{type:"button",className:"px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-white",onClick:b=>{b.stopPropagation(),p(a)},"aria-label":`Delete document ${a.subject}`,children:"Delete"})]})]}),a.fileUrl&&e.jsx(Wt,{url:a.fileUrl,fileName:a.name,mimeType:a.type,fileSize:a.size,isOpen:d,onClose:()=>N(!1)})]})}),He="edms-docs",Ss=({selectedUnit:t,currentUser:a})=>{const[i,p]=s.useState([]),[d,N]=s.useState(!1),[S,b]=s.useState(""),[I,P]=s.useState(""),[D,z]=s.useState(""),[v,V]=s.useState([]),[H,O]=s.useState(null),[u,K]=s.useState(null),[T,j]=s.useState([]),[L,h]=s.useState(!1),[_,m]=s.useState(null),[R,B]=s.useState(""),[M,G]=s.useState(""),[f,g]=s.useState(""),[Q,q]=s.useState([]),[X,Z]=s.useState([]),[W,ge]=s.useState(null),[ve,we]=s.useState(""),[w,J]=s.useState(""),[ae,te]=s.useState(""),[Y,he]=s.useState([]),[y,F]=s.useState(!1),[re,le]=s.useState({}),[me,je]=s.useState(""),[Se,Ce]=s.useState("Pending"),$e=ws(),Ae=c=>{const k=c.target.files?Array.from(c.target.files):[];if(k.length===0)return;if(v.length+k.length>wt){O({type:"error",message:`Cannot add ${k.length} file(s). Maximum ${wt} files allowed per request.`});try{c.target.value=""}catch{}return}const $=[],ee=[];for(const U of k){const pe=Kt(U);pe.valid?$.push(U):ee.push(...pe.errors)}$.length>0&&V(U=>[...U,...$]),ee.length>0&&O({type:"error",message:ee.slice(0,3).join(" ")+(ee.length>3?` (+${ee.length-3} more errors)`:"")});try{c.target.value=""}catch{}},Le=async()=>{if(!W||!(u!=null&&u.id)||W.uploadedById!==u.id)return;const c={actor:`${u.rank} ${u.lastName}, ${u.firstName}${u.mi?` ${u.mi}`:""}`,timestamp:new Date().toISOString(),action:"Archived by Originator",comment:(ae||"").trim()},k={...W,currentStage:Ye.ARCHIVED,finalStatus:"Archived",activity:Array.isArray(W.activity)?[...W.activity,c]:[c]};try{const $=await Be(k);if(!$.ok)throw new Error(A($,"request_upsert_failed"));Z(ee=>ee.map(U=>U.id===k.id?k:U)),ge(k),O({type:"success",message:"Request archived."})}catch($){O({type:"error",message:`Failed to archive: ${String(($==null?void 0:$.message)||$)}`})}},n=async c=>{c.preventDefault(),O(null);const k=S.trim();if(!k){O({type:"error",message:"Subject is required."});return}if(k.length>500){O({type:"error",message:"Subject is too long (maximum 500 characters)."});return}if(D.length>5e3){O({type:"error",message:"Notes are too long (maximum 5000 characters)."});return}if(!(u!=null&&u.id)){O({type:"error",message:"Create a profile before submitting."});return}if(v.length>0){const be=Yt(v);if(!be.valid){O({type:"error",message:be.errors[0]});return}}N(!0);const $=Date.now(),ee=me||u.id,U=T.find(be=>be.id===ee),pe=t?t.uic:(U==null?void 0:U.unitUic)||"N/A",ue=`req-${$}`;let xe=[];async function Oe(be,Pe){if(!Ie)throw new Error("Supabase not configured");const{error:De}=await Ie.storage.from(He).upload(Pe,be,{upsert:!0});if(De)throw new Error(De.message);const{data:_e}=Ie.storage.from(He).getPublicUrl(Pe);return(_e==null?void 0:_e.publicUrl)||""}if(v&&v.length>0){const be=[];for(let Pe=0;Pe<v.length;Pe++){const De=v[Pe],_e=`${pe}/${ue}/${$}-${Pe}-${Dt(De.name)}`;try{const qe=await Oe(De,_e);be.push(qe)}catch(qe){N(!1),O({type:"error",message:`Failed to upload ${De.name}: ${String((qe==null?void 0:qe.message)||qe)}`});return}}xe=v.map((Pe,De)=>({id:`${$}-${De}`,name:Pe.name,type:Pe.type,size:Pe.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:pe,subject:S.trim(),dueDate:I||void 0,notes:D.trim()||void 0,uploadedById:ee,currentStage:"PLATOON_REVIEW",fileUrl:be[De]}))}xe=xe.map(be=>({...be,requestId:ue})),p(be=>[...be,...xe]),V([]),b(""),P(""),z("");try{const be=u?`${u.rank} ${u.lastName}, ${u.firstName}${u.mi?` ${u.mi}`:""}`:"Unknown",Pe="Member",De=pe,_e=Xe(U==null?void 0:U.company),qe=Xe(U==null?void 0:U.platoon),it=It(T,"PLATOON_REVIEWER",{company:_e,platoon:qe,uic:De}),ot=It(T,"COMPANY_REVIEWER",{company:_e,uic:De}),r={id:ue,subject:S.trim(),dueDate:I||void 0,notes:D.trim()||void 0,unitUic:pe,uploadedById:ee,submitForUserId:ee,documentIds:xe.map(l=>l.id),createdAt:new Date().toISOString(),currentStage:it?Ye.PLATOON_REVIEW:ot?Ye.COMPANY_REVIEW:Ye.BATTALION_REVIEW,activity:[{actor:be,actorRole:Pe,timestamp:new Date().toISOString(),action:"Submitted request",comment:(D||"").trim()}]};try{const l=await Be(r);if(!l.ok)throw new Error(A(l,"request_upsert_failed"));const E=await ut(xe);if(!E.ok)throw new Error(A(E,"document_upsert_failed"))}catch(l){N(!1);try{lt("request_persist_failed",{requestId:ue,error:String((l==null?void 0:l.message)||l)},"error")}catch{}O({type:"error",message:`Failed to persist submission: ${String((l==null?void 0:l.message)||l)}`});return}Z(l=>l.some(se=>se.id===r.id)?l.map(se=>se.id===r.id?r:se):[...l,r]),N(!1),O({type:"success",message:"Submission successful."}),h(!1)}catch{N(!1);try{lt("request_persist_failed",{requestId:ue},"error")}catch{}O({type:"error",message:"Failed to persist submission."})}},o=s.useCallback(c=>{m(c),B(c.subject||""),G(c.dueDate||""),g(c.notes||"");try{const k=localStorage.getItem(`fs/requests/${c.requestId}.json`);if(k){const $=JSON.parse(k);q(Array.isArray($.activity)?$.activity:[])}else{const U=Object.values(Object.assign({})).map(pe=>(pe==null?void 0:pe.default)??pe).find(pe=>pe&&pe.id===c.requestId);q(U&&Array.isArray(U.activity)?U.activity:[])}}catch{q([])}},[]),A=(c,k)=>{var $;return String((($=c.error)==null?void 0:$.message)||c.error||k)},C=async()=>{if(!_)return;const c=i.map(k=>k.id===_.id?{...k,subject:R.trim()||k.subject,dueDate:M||void 0,notes:f.trim()||void 0}:k);p(c);try{const ee={actor:u?`${u.rank} ${u.lastName}, ${u.firstName}${u.mi?` ${u.mi}`:""}`:"Unknown",actorRole:"Member",timestamp:new Date().toISOString(),action:"Updated document",comment:(f||"").trim()},U=_.requestId?X.find(pe=>pe.id===_.requestId):null;if(U){const pe={...U,activity:Array.isArray(U.activity)?[...U.activity,ee]:[ee]};try{const ue=await Be(pe);if(!ue.ok)throw new Error(A(ue,"request_upsert_failed"))}catch(ue){console.error("Failed to save document edits:",ue),O({type:"error",message:`Failed to save document edits: ${ue.message}`});return}q(ue=>[...ue,ee])}}catch{}g(""),m(null)};i.filter(c=>!(!(u!=null&&u.id)||u.role==="MEMBER"&&c.uploadedById!==u.id||c.type==="request"));const ie=()=>String((u==null?void 0:u.role)||"").includes("REVIEW"),ce=()=>{if(!ie())return[];const c=String((u==null?void 0:u.role)||"");return T.filter(k=>{if(k.id===(u==null?void 0:u.id))return!1;if(c.includes("PLATOON")){const $=k.company&&k.company!=="N/A"?k.company:"",ee=k.unit&&k.unit!=="N/A"?k.unit:"",U=u!=null&&u.company&&u.company!=="N/A"?u.company:"",pe=u!=null&&u.unit&&u.unit!=="N/A"?u.unit:"";return $===U&&ee===pe}if(c.includes("COMPANY")){const $=k.company&&k.company!=="N/A"?k.company:"",ee=u!=null&&u.company&&u.company!=="N/A"?u.company:"";return $===ee}return c.includes("COMMANDER")?(k.unitUic||"")===((u==null?void 0:u.unitUic)||""):!1})},Re=s.useCallback(async c=>{const k=$e.extractStoragePath(c.fileUrl);try{k&&Ie&&await Ie.storage.from(He).remove([k])}catch{}try{await ss(c.id),p($=>$.filter(ee=>ee.id!==c.id)),c.requestId&&Z($=>$.map(ee=>ee.id===c.requestId?{...ee,documentIds:(ee.documentIds||[]).filter(U=>U!==c.id)}:ee)),O({type:"success",message:"Document deleted."})}catch($){O({type:"error",message:`Failed to delete: ${String(($==null?void 0:$.message)||$)}`})}},[]),ke=s.useCallback(async c=>{const k=`${c.unitUic||"N-A"}/${c.id}/`;try{if(Ie){const{data:$}=await Ie.storage.from(He).list(k.slice(0,-1));if($&&$.length>0){const ee=$.map(U=>`${k.slice(0,-1)}/${U.name}`);await Ie.storage.from(He).remove(ee)}}}catch{}try{await as(c.id),await ns(c.id),p($=>$.filter(ee=>ee.requestId!==c.id)),Z($=>$.filter(ee=>ee.id!==c.id)),ge(null),O({type:"success",message:"Request and files deleted."})}catch($){O({type:"error",message:`Failed to delete request: ${String(($==null?void 0:$.message)||$)}`})}},[]),de=async()=>{if(!W||!(u!=null&&u.id)||W.uploadedById!==u.id){O({type:"error",message:"Only the requester can edit this."});return}const c=Date.now(),k=ue=>ue.replace(/[^A-Za-z0-9._-]/g,"-");async function $(ue,xe){if(!Ie)throw new Error("Supabase not configured");const{error:Oe}=await Ie.storage.from(He).upload(xe,ue,{upsert:!0});if(Oe)throw new Error(Oe.message);const{data:be}=Ie.storage.from(He).getPublicUrl(xe);return(be==null?void 0:be.publicUrl)||""}const ee=[];for(let ue=0;ue<Y.length;ue++){const xe=Y[ue],Oe=`${W.unitUic||"N-A"}/${W.id}/${c}-${ue}-${k(xe.name)}`;try{const be=await $(xe,Oe);ee.push(be)}catch(be){O({type:"error",message:`Failed to upload ${xe.name}: ${String((be==null?void 0:be.message)||be)}`});return}}const U=Y.map((ue,xe)=>({id:`${c}-${xe}`,name:ue.name,type:ue.type,size:ue.size,uploadedAt:new Date,category:"administration",tags:[],unitUic:W.unitUic||"N/A",subject:ve.trim()||W.subject,dueDate:w||void 0,notes:ae.trim()||void 0,uploadedById:u.id,currentStage:W.currentStage||"PLATOON_REVIEW",requestId:W.id,fileUrl:ee[xe]})),pe={...W,subject:ve.trim()||W.subject,dueDate:w||void 0,notes:ae.trim()||void 0,documentIds:[...W.documentIds||[],...U.map(ue=>ue.id)],activity:[...W.activity||[],{actor:`${u.rank} ${u.lastName}, ${u.firstName}${u.mi?` ${u.mi}`:""}`,timestamp:new Date().toISOString(),action:U.length?`Updated request and added ${U.length} document(s)`:"Updated request",comment:(ae||"").trim()}]};try{if(!(u&&ds(W,String(u.id||"")))){O({type:"error",message:"Editing is not allowed at the current stage unless returned."});return}try{const xe=await ut(U);if(!xe.ok)throw new Error(A(xe,"document_upsert_failed"));const Oe=await Be(pe);if(!Oe.ok)throw new Error(A(Oe,"request_upsert_failed"))}catch(xe){try{lt("request_update_failed",{requestId:pe.id,error:String((xe==null?void 0:xe.message)||xe)},"error")}catch{}O({type:"error",message:`Failed to persist documents: ${String((xe==null?void 0:xe.message)||xe)}`});return}p(xe=>[...xe,...U]),Z(xe=>xe.map(Oe=>Oe.id===pe.id?pe:Oe)),ge(pe),he([]),te(""),O({type:"success",message:U.length?"Files added and request updated.":"Request updated."})}catch{O({type:"error",message:"Failed to update request."})}},[Ee,Me]=s.useState(!0),[Fe,Ge]=s.useState(!0);s.useEffect(()=>{ft().then(c=>{p(c)}).catch(()=>p([])).finally(()=>Me(!1))},[]),s.useEffect(()=>{W&&(we(W.subject||""),J(W.dueDate||""),te(W.notes||""),he([]))},[W]),s.useEffect(()=>{},[i]),s.useEffect(()=>{rt().then(c=>{Z(c)}).catch(()=>Z([])).finally(()=>Ge(!1))},[]),s.useEffect(()=>{K(a||null)},[a]),s.useEffect(()=>{Ue().then(c=>{j(c)}).catch(()=>j([]))},[]);const Qe=s.useMemo(()=>{if(!(u!=null&&u.id))return[];const c=X.filter(k=>k.uploadedById===u.id);return Se==="Pending"?c.filter(k=>k.currentStage!=="ARCHIVED"):c.filter(k=>k.currentStage==="ARCHIVED")},[X,u,Se]),Ne=gt(Qe,{pageSize:10}),x=s.useMemo(()=>T.reduce((c,k)=>({...c,[k.id]:k}),{}),[T]),oe=s.useCallback(c=>{const k=Xe(c.currentStage||"PLATOON_REVIEW"),$=T.find(ee=>ee.id===c.uploadedById);switch(k){case"ORIGINATOR_REVIEW":return{level:"Member",scope:""};case"PLATOON_REVIEW":{const ee=$!=null&&$.company&&$.company!=="N/A"?$.company:"",U=$!=null&&$.platoon&&$.platoon!=="N/A"?$.platoon:"";return ee&&U?{level:"Platoon",scope:`(${ee}-${U})`}:ee?{level:"Platoon",scope:`(${ee})`}:{level:"Platoon",scope:""}}case"COMPANY_REVIEW":{const ee=$!=null&&$.company&&$.company!=="N/A"?$.company:"";return{level:"Company",scope:ee?`(${ee})`:""}}case"BATTALION_REVIEW":return{level:"Battalion",scope:c.routeSection?`(${c.routeSection})`:""};case"COMMANDER_REVIEW":return{level:"Commander",scope:c.routeSection?`(${c.routeSection})`:""};case"ARCHIVED":return{level:"Archived",scope:""};default:return{level:Bt(c),scope:""}}},[T]);return e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Documents"}),e.jsx("button",{type:"button",onClick:()=>h(!0),className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-4",children:"New Request"})]}),L&&e.jsxs("form",{onSubmit:n,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:S,onChange:c=>b(c.target.value),placeholder:"Document subject/title",className:`w-full px-3 py-2 border ${S.trim()?"border-brand-navy/30":"border-brand-red"} rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date (optional)"}),e.jsx("input",{type:"date",value:I,onChange:c=>P(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]})]}),String((u==null?void 0:u.role)||"").includes("REVIEW")&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Submit For (optional)"}),e.jsxs("select",{value:me,onChange:c=>je(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Myself"}),ce().map(c=>e.jsxs("option",{value:c.id,children:[c.rank," ",c.lastName,", ",c.firstName,c.mi?` ${c.mi}`:""]},c.id))]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes (optional)"}),e.jsx("textarea",{value:D,onChange:c=>z(c.target.value),rows:4,placeholder:"Additional context for reviewers",className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-4 py-2 rounded-lg hover:bg-brand-red-2 cursor-pointer transition-colors inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:Ae,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Attach Files"]}),e.jsx("div",{className:"flex-1",children:v.length>0?e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:v.map((c,k)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:c.name,children:c.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>V($=>$.filter((ee,U)=>U!==k)),children:"Delete"})]},k))}):e.jsx("span",{className:"ml-2 text-xs text-[var(--muted)]",children:"No files selected"})}),e.jsxs("div",{className:"md:ml-auto flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{h(!1),V([]),b(""),P(""),z(""),O(null)},className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",children:"Cancel"}),e.jsx("button",{type:"submit",className:"bg-brand-gold text-brand-charcoal px-4 py-2 rounded-lg hover:bg-brand-gold-2 transition-colors disabled:opacity-60",disabled:!S.trim(),children:"Submit"})]})]}),H&&e.jsx("div",{className:`p-3 rounded-lg border ${H.type==="success"?"bg-brand-cream border-brand-gold text-brand-navy":"bg-brand-cream border-brand-red text-brand-red"}`,children:H.message})]})]}),e.jsxs("div",{className:"p-6",children:[u&&e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>Ce("Pending"),className:`${Se==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>Ce("Archived"),className:`${Se==="Archived"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Archived"})]})}),e.jsxs("div",{className:"flex items-center justify-between py-2 text-sm text-[var(--muted)]",children:[e.jsx("div",{children:Ne.totalItems>0?`${Ne.startIndex}–${Ne.endIndex} of ${Ne.totalItems}`:""}),Fe&&e.jsx("div",{className:"animate-pulse",children:"Loading requests…"})]}),e.jsx(ze,{title:"Your Requests",requests:Fe?Array.from({length:5}).map((c,k)=>({id:`s-${k}`,subject:"",uploadedById:"",documentIds:[],createdAt:new Date().toISOString(),currentStage:Ye.PLATOON_REVIEW})):Ne.currentData,users:x,onRowClick:c=>ge(c),expandedRows:re,children:c=>e.jsxs("div",{id:`req-docs-${c.id}`,children:[Ee?e.jsx("div",{className:"h-16 rounded bg-gray-100 animate-pulse"}):i.filter(k=>k.requestId===c.id&&k.type!=="request").map(k=>e.jsx(Rt,{doc:k,onView:o,onDelete:Re},k.id)),!Ee&&i.filter(k=>k.requestId===c.id&&k.type!=="request").length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})}),Ne.totalItems>0&&e.jsx(ht,{currentPage:Ne.currentPage,totalPages:Ne.totalPages,totalItems:Ne.totalItems,pageSize:Ne.pageSize,startIndex:Ne.startIndex,endIndex:Ne.endIndex,onPageChange:Ne.goToPage,onPageSizeChange:Ne.setPageSize,onNext:Ne.nextPage,onPrevious:Ne.previousPage,onFirst:Ne.goToFirstPage,onLast:Ne.goToLastPage,canGoNext:Ne.canGoNext,canGoPrevious:Ne.canGoPrevious,pageSizeOptions:[5,10,25,50]})]}),d&&e.jsx("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"}),e.jsx("span",{className:"text-blue-800",children:"Uploading documents..."})]})})]}),_&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request Details"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>m(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:R,onChange:c=>B(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:M,onChange:c=>G(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stage"}),e.jsx("input",{type:"text",value:_.currentStage||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:4,value:f,onChange:c=>g(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[_.name," • ",Ft(_.size)," • ",new Date(_.uploadedAt).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)] mt-4",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:Q.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"}):Q.map((c,k)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[c.actor,c.actorRole?` • ${c.actorRole}`:""," • ",new Date(c.timestamp).toLocaleString()," • ",c.action]}),c.comment&&e.jsx("div",{className:"text-gray-600",children:c.comment})]},k))})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>m(null),children:"Close"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:C,children:"Save"})]})]})}),W&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>ge(null),children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Request"}),e.jsx("button",{className:"text-brand-navy",onClick:()=>ge(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:ve,onChange:c=>we(c.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(W.createdAt).toLocaleString()]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:w,onChange:c=>J(c.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),W.currentStage&&(()=>{const{level:c,scope:k}=oe(W);return e.jsxs("span",{className:"inline-flex flex-col items-center px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-lg border border-brand-navy/30 leading-tight",children:[e.jsx("span",{children:c}),k&&e.jsx("span",{className:"text-[10px]",children:k})]})})(),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Notes"}),e.jsx("textarea",{rows:3,value:ae,onChange:c=>te(c.target.value),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Action Log"}),e.jsx("div",{className:"mt-2 space-y-2",children:W.activity&&W.activity.length?W.activity.map((c,k)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[c.actor,c.actorRole?` • ${c.actorRole}`:""," • ",new Date(c.timestamp).toLocaleString()," • ",c.action]}),c.comment&&e.jsx("div",{className:"text-gray-600",children:c.comment})]},k)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-[var(--text)]",children:"Documents"}),e.jsxs("button",{className:"mt-2 px-3 py-1 rounded bg-brand-navy text-brand-cream hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold underline decoration-brand-red-2 underline-offset-2","aria-expanded":y,"aria-controls":"docs-panel",onClick:()=>F(c=>!c),children:[y?"Hide":"Show"," Documents"]}),e.jsx("div",{id:"docs-panel",className:y?"mt-3 space-y-2":"hidden",children:i.filter(c=>c.requestId===W.id&&c.type!=="request").map(c=>e.jsx(Rt,{doc:c,onView:o,onDelete:Re},c.id))}),!Ct(W,String((u==null?void 0:u.id)||""))&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded-lg hover:brightness-110 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:c=>{const k=c.target.files?Array.from(c.target.files):[];he($=>[...$,...k]);try{c.target.value=""}catch{}},className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("div",{className:"ml-2 flex flex-wrap gap-2",children:Y.length===0?e.jsx("span",{className:"text-xs text-[var(--muted)]",children:"No files selected"}):Y.map((c,k)=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded border border-brand-navy/20",children:[e.jsx("span",{className:"max-w-[240px] truncate",title:c.name,children:c.name}),e.jsx("button",{type:"button",className:"text-brand-red-2 hover:underline",onClick:()=>he($=>$.filter((ee,U)=>U!==k)),children:"Delete"})]},k))})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border border-brand-navy/30 text-brand-navy hover:bg-brand-cream",onClick:()=>ge(null),children:"Close"}),Ct(W,String((u==null?void 0:u.id)||""))?e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-gold text-brand-charcoal hover:brightness-110",onClick:Le,children:"Archive"}):e.jsx("button",{className:"px-4 py-2 rounded-lg bg-brand-navy text-brand-cream hover:brightness-110",onClick:de,disabled:!u||u.id!==((W==null?void 0:W.uploadedById)||""),children:"Save Changes"}),u&&u.id===((W==null?void 0:W.uploadedById)||"")&&e.jsx("button",{className:"px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700",onClick:()=>ke(W),children:"Delete Request"})]})]})})]})},Cs=({currentUser:t,onClose:a})=>{const[i,p]=s.useState([]),[d,N]=s.useState(""),[S,b]=s.useState(!1),[I,P]=s.useState(""),[D,z]=s.useState(!1),[v,V]=s.useState("");s.useEffect(()=>{vt().then(j=>{p(j.data||[])}).catch(()=>p([]))},[]);const H=s.useMemo(()=>String(t.role||"")!=="MEMBER",[t]),O=s.useMemo(()=>{const j=L=>{const h=t.unitUic||"",_=String(t.role||"");if(_.includes("PLATOON")){const m=L.company&&L.company!=="N/A"?L.company:"",R=L.platoon&&L.platoon!=="N/A"?L.platoon:"",B=t.company&&t.company!=="N/A"?t.company:"",M=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return m===B&&R===M}if(_.includes("COMPANY")){const m=L.company&&L.company!=="N/A"?L.company:"",R=t.company&&t.company!=="N/A"?t.company:"";return m===R}return _.includes("COMMANDER")?(L.unitUic||"")===h:!1};return i.filter(L=>L.id!==t.id&&j(L))},[i,t]),u=s.useMemo(()=>{const j=String(t.role||""),L=h=>{const _=t.unitUic||"";if(j.includes("PLATOON")){const m=h.company&&h.company!=="N/A"?h.company:"",R=h.platoon&&h.platoon!=="N/A"?h.platoon:"",B=t.company&&t.company!=="N/A"?t.company:"",M=t.platoon&&t.platoon!=="N/A"?t.platoon:"";return m===B&&R===M}if(j.includes("COMPANY")){const m=h.company&&h.company!=="N/A"?h.company:"",R=t.company&&t.company!=="N/A"?t.company:"";return m===R}return j.includes("COMMANDER")?(h.unitUic||"")===_:!1};return i.filter(h=>h.id!==t.id&&L(h)&&String(h.role||"")===j)},[i,t]),K=async()=>{try{b(!0),P("");const j=i.find(m=>m.id===d);if(!H||!j){b(!1);return}const L=String(t.role||""),h={...j};if(h.role=L,L.includes("PLATOON")){h.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A";const m=t.platoon&&t.platoon!=="N/A"?t.platoon:"N/A";h.rolePlatoon=m}else L.includes("COMPANY")?(h.roleCompany=t.company&&t.company!=="N/A"?t.company:"N/A",h.rolePlatoon="N/A"):L.includes("COMMANDER")&&(h.roleCompany="N/A",h.rolePlatoon="N/A");try{if(!(await Ve({id:h.id,email:h.email,rank:h.rank,firstName:h.firstName,lastName:h.lastName,mi:h.mi,service:h.service,role:h.role,unitUic:h.unitUic,unit:h.unit,company:h.company,isUnitAdmin:!!h.isUnitAdmin,isCommandStaff:!!h.isCommandStaff,edipi:h.edipi,passwordHash:h.passwordHash,roleCompany:h.roleCompany,rolePlatoon:h.rolePlatoon})).ok)throw new Error("persist_failed")}catch{P("Failed to persist user changes")}const _={actorId:t.id,actorRole:t.role,targetId:h.id,grantedRole:h.role,timestamp:new Date().toISOString(),scope:{unitUic:t.unitUic||"",company:t.company,unit:t.unit}};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(_)})}catch{}p(m=>m.map(R=>R.id===h.id?h:R)),N(""),z(!1),b(!1)}catch{b(!1),P("Operation failed")}},T=async j=>{try{b(!0),P("");const L=i.find(B=>B.id===j);if(!L){b(!1);return}const h=String(t.role||"");if(!u.some(B=>B.id===j)){b(!1),P("Target not in scope");return}const m={...L};m.role="MEMBER",m.company="N/A",m.unit="N/A",m.isCommandStaff=!1,m.roleCompany="N/A",m.rolePlatoon="N/A";try{if(!(await Ve({id:m.id,email:m.email,rank:m.rank,firstName:m.firstName,lastName:m.lastName,mi:m.mi,service:m.service,role:m.role,unitUic:m.unitUic,unit:m.unit,company:m.company,isUnitAdmin:!!m.isUnitAdmin,isCommandStaff:!!m.isCommandStaff,edipi:m.edipi,passwordHash:m.passwordHash,roleCompany:m.roleCompany,rolePlatoon:m.rolePlatoon})).ok)throw new Error("persist_failed")}catch{P("Failed to persist user changes")}const R={actorId:t.id,actorRole:t.role,targetId:m.id,action:"Revoked",previousRole:h,timestamp:new Date().toISOString()};try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(R)})}catch{}p(B=>B.map(M=>M.id===m.id?m:M)),V(""),b(!1)}catch{b(!1),P("Operation failed")}};return H?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:a,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:j=>j.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Permissions"}),e.jsx("button",{className:"text-gray-500",onClick:a,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Grant your current permission level to users in your scope."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:d,onChange:j=>N(j.target.value),children:[e.jsx("option",{value:"",children:"Choose user"}),O.map(j=>e.jsxs("option",{value:j.id,children:[j.rank," ",j.lastName,", ",j.firstName,j.mi?` ${j.mi}`:""," • ",j.email]},j.id))]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Access"}),e.jsxs("div",{className:"space-y-2",children:[u.map(j=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[j.rank," ",j.lastName,", ",j.firstName,j.mi?` ${j.mi}`:""," • ",j.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>V(j.id),children:"Remove Access"})]},j.id)),u.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users currently have this access in your scope."})]})]}),I&&e.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:I})]}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!d||S,onClick:()=>z(!0),children:"Grant Equivalent Permission"})}),D&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm granting your permission level to the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>z(!1),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50",disabled:S,onClick:K,children:"Confirm"})]})]}),v&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm",children:"Confirm removing access for the selected user?"}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>V(""),children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 rounded bg-red-600 text-white disabled:opacity-50",disabled:S,onClick:()=>T(v),children:"Remove"})]})]})]})}):null},ct="ORIGINATOR_REVIEW",Te=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],As=[{value:"PLATOON_REVIEW",label:"Platoon Review"},{value:"COMPANY_REVIEW",label:"Company Review"},{value:"BATTALION_REVIEW",label:"Battalion Review"},{value:"COMMANDER_REVIEW",label:"Commander Review"},{value:"ARCHIVED",label:"Archived"}],ks={search:"",status:[],dateFrom:"",dateTo:"",originatorId:""},Es=t=>{const a=Te.indexOf(t||Te[0]);return a>=0&&a<Te.length-1?Te[a+1]:Te[a]||Te[0]},dt=t=>{const a=Te.indexOf(t||Te[0]);return a>0?Te[a-1]:Te[0]},Is=t=>{const a=t.activity&&t.activity.length?t.activity[t.activity.length-1]:null;return!!a&&/returned/i.test(String(a.action||""))},nt=(t,a)=>{var i;return((i=t.activity)==null?void 0:i.some(p=>a.test(String(p.action||""))))||!1},Rs=t=>nt(t,/(approved by commander|commander.*approved)/i)&&!nt(t,/installation commander/i),Ms=t=>nt(t,/(endorsed by commander|commander.*endorsed)/i)&&!nt(t,/installation commander/i),mt=t=>{if(!t)return"MEMBER";const a=String(t.role||"MEMBER"),i=(t.roleCompany||t.company||"").trim(),p=(t.rolePlatoon||t.platoon||"").trim();switch(a){case"PLATOON_REVIEWER":if(i&&p)return`Platoon (${i}-${p})`;break;case"COMPANY_REVIEWER":if(i)return`Company (${i})`;break;case"BATTALION_REVIEWER":return"Battalion";case"COMMANDER_REVIEWER":return"Commander"}return a};function Ps(){const t=Zt(),[a,i]=s.useState(()=>{try{const n=localStorage.getItem("currentUser");return n?JSON.parse(n):null}catch(n){return console.error("Failed to parse user from localStorage:",n),null}}),[p,d]=s.useState([]),[N,S]=s.useState([]),[b,I]=s.useState({}),[P,D]=s.useState({}),[z,v]=s.useState({}),[V,H]=s.useState({}),[O,u]=s.useState({}),[K,T]=s.useState({}),[j,L]=s.useState({}),[h,_]=s.useState(!1),[m,R]=s.useState({}),[B,M]=s.useState({}),[G,f]=s.useState(!1),[g,Q]=s.useState({}),[q,X]=s.useState(null),Z=s.useRef(null),[W,ge]=s.useState("Pending"),[ve,we]=s.useState(ks),[w,J]=s.useState(null);s.useEffect(()=>{const n=A=>{q&&Z.current&&!Z.current.contains(A.target)&&(Q(C=>({...C,[q]:!1})),X(null))},o=A=>{A.key==="Escape"&&q&&(Q(C=>({...C,[q]:!1})),X(null))};return document.addEventListener("mousedown",n),document.addEventListener("keydown",o),()=>{document.removeEventListener("mousedown",n),document.removeEventListener("keydown",o)}},[q]),s.useEffect(()=>{rs().then(n=>{d(n.data||[])}).catch(()=>d([]))},[]),s.useEffect(()=>{is().then(n=>{S(n.data||[])}).catch(()=>S([]))},[]),s.useEffect(()=>{vt().then(n=>{const o={},A=n.data||[];for(const C of A)C!=null&&C.id&&(o[C.id]=C);D(o)}).catch(()=>D({}))},[]),s.useEffect(()=>{try{const n=localStorage.getItem("unit_structure"),o={},A={};if(n){const C=JSON.parse(n);for(const ie of Object.keys(C||{})){const ce=C[ie];ce&&Array.isArray(ce._sections)&&(o[ie]=ce._sections),ce&&ce._platoonSectionMap&&typeof ce._platoonSectionMap=="object"&&(A[ie]=ce._platoonSectionMap)}}else(async()=>{try{const C=await jt();for(const ie of Object.keys(C||{})){const ce=C[ie];ce&&Array.isArray(ce._sections)&&(o[ie]=ce._sections),ce&&ce._platoonSectionMap&&typeof ce._platoonSectionMap=="object"&&(A[ie]=ce._platoonSectionMap)}}catch{}})();T(o),L(A)}catch{}},[]);const ae=s.useMemo(()=>{const n=String((a==null?void 0:a.role)||"");return n.includes("PLATOON")?"PLATOON_REVIEW":n.includes("COMPANY")?"COMPANY_REVIEW":n.includes("BATTALION")?"BATTALION_REVIEW":n.includes("COMMANDER")?"COMMANDER_REVIEW":"PLATOON_REVIEW"},[a]),te=n=>P[n.uploadedById]||null,Y=n=>n&&n!=="N/A"?n.trim():"",he=n=>{var Re,ke;const o=te(n),A=n.unitUic||(o==null?void 0:o.unitUic)||"",C=String((a==null?void 0:a.role)||""),ie=(a==null?void 0:a.unitUic)||"",ce=(Y(a==null?void 0:a.roleCompany)||Y(a==null?void 0:a.company)).toUpperCase();if(C.includes("PLATOON")){if(!ie||A!==ie)return!1;const de=o?Y(o.company).toUpperCase():"",Ee=o?Y(o.platoon).toUpperCase():"",Me=(Y(a==null?void 0:a.rolePlatoon)||Y(a==null?void 0:a.platoon)).toUpperCase();return!ce||!Me||!de||!Ee?!1:de===ce&&Ee===Me}if(C.includes("COMPANY")){if(!ie||A!==ie)return!1;const de=o?Y(o.company).toUpperCase():"";return!ce||!de?!1:de===ce}if(C.includes("BATTALION")){if(!ie||A!==ie)return!1;const de=Y(a==null?void 0:a.company),Ee=Y(a==null?void 0:a.platoon),Me=((ke=(Re=j[ie])==null?void 0:Re[de])==null?void 0:ke[Ee])||"";return n.routeSection&&Me?n.routeSection===Me:!0}return C.includes("COMMANDER")?!!ie&&A===ie:!0},y=s.useMemo(()=>(Array.isArray(p)?p:[]).filter(he),[p,a,P,j]),F=s.useMemo(()=>{const n=new Map;for(const o of y){const A=te(o);if(A&&A.id&&!n.has(A.id)){const C=`${A.rank||""} ${A.lastName||""}, ${A.firstName||""}`.trim();n.set(A.id,{value:A.id,label:C||A.id})}}return Array.from(n.values()).sort((o,A)=>o.label.localeCompare(A.label))},[y,P]),re=vs(ve,{items:y,getSearchText:n=>`${n.subject||""} ${n.id||""} ${n.routeSection||""}`,getStatus:n=>n.currentStage||"PLATOON_REVIEW",getDate:n=>n.createdAt,getOriginatorId:n=>n.uploadedById}),le=s.useMemo(()=>re.filter(n=>(n.currentStage||"PLATOON_REVIEW")===ae),[re,ae]),me=s.useMemo(()=>re.filter(n=>(n.currentStage||"PLATOON_REVIEW")!==ae),[re,ae]),je=gt(le,{pageSize:25}),Se=gt(me,{pageSize:25}),Ce=n=>N.filter(o=>o.requestId===n),$e=s.useMemo(()=>[{header:"Request ID",getValue:n=>n.id},{header:"Subject",getValue:n=>n.subject},{header:"Stage",getValue:n=>n.currentStage||""},{header:"Route Section",getValue:n=>n.routeSection||""},{header:"Originator",getValue:n=>{const o=te(n);return o?`${o.rank||""} ${o.lastName||""}, ${o.firstName||""}${o.mi?` ${o.mi}`:""}`.trim():""}},{header:"Unit UIC",getValue:n=>n.unitUic||""},{header:"Created At",getValue:n=>n.createdAt,format:Et},{header:"Due Date",getValue:n=>n.dueDate||"",format:Et},{header:"Documents",getValue:n=>Ce(n.id).map(o=>o.name).join(" | ")}],[P,N]),Ae=async(n,o,A)=>{const C=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",ie=mt(a),ce={actor:C,actorRole:ie,timestamp:new Date().toISOString(),action:A,comment:(b[n.id]||"").trim()},Re={...n,currentStage:o,routeSection:o==="BATTALION_REVIEW"&&O[n.id]?O[n.id]:n.routeSection,activity:Array.isArray(n.activity)?[...n.activity,ce]:[ce]};try{await Be(Re),A.toLowerCase().includes("approved")?t.success("Request approved",{message:`"${n.subject}" advanced to next stage`}):A.toLowerCase().includes("return")?t.warning("Request returned",{message:`"${n.subject}" sent back for revision`}):A.toLowerCase().includes("archive")?t.info("Request archived",{message:`"${n.subject}" has been archived`}):t.success(A,{message:`Request "${n.subject}" updated`}),d(ke=>ke.map(de=>de.id===Re.id?Re:de)),I(ke=>({...ke,[n.id]:""}))}catch(ke){t.error("Failed to update request",{message:String(ke)})}},Le=async n=>{const o=V[n.id]||[];if(!o.length||!(a!=null&&a.id))return;const A=Date.now(),C=o.map((de,Ee)=>({id:`${A}-${Ee}`,name:de.name,type:de.type,size:de.size,uploadedAt:new Date().toISOString(),subject:n.subject,requestId:n.id,fileUrl:URL.createObjectURL(de)})),ie=a?`${a.rank} ${a.lastName}, ${a.firstName}${a.mi?` ${a.mi}`:""}`:"Reviewer",ce=mt(a),Re={actor:ie,actorRole:ce,timestamp:new Date().toISOString(),action:`Reviewer added ${C.length} document(s)`,comment:(b[n.id]||"").trim()},ke={...n,documentIds:[...n.documentIds||[],...C.map(de=>de.id)],activity:Array.isArray(n.activity)?[...n.activity,Re]:[Re]};try{await ut(C),await Be(ke),t.success(`${C.length} file${C.length!==1?"s":""} added`,{message:`Documents added to "${n.subject}"`})}catch(de){t.error("Failed to add files",{message:String(de)})}S(de=>[...de,...C]),d(de=>de.map(Ee=>Ee.id===ke.id?ke:Ee)),H(de=>({...de,[n.id]:[]})),I(de=>({...de,[n.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Review Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:mt(a)}),e.jsx(Ns,{items:[...le,...me],columns:$e,filename:"review_requests",label:"Export",className:"hidden md:inline-flex"})]})]}),a&&String(a.role||"")!=="MEMBER"&&e.jsx("div",{className:"flex-shrink-0 hidden md:block",children:e.jsx("button",{className:"px-4 py-2 rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>_(!0),children:"Manage Permissions"})})]}),e.jsx(fs,{filters:ve,onFiltersChange:we,statusOptions:As,originatorOptions:F,searchPlaceholder:"Search requests by subject, ID, or section...",className:"mb-4"}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>ge("Pending"),className:`${W==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>ge("In Scope"),className:`${W==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[W==="Pending"&&e.jsx(ze,{title:"Pending",requests:je.currentData,users:P,onRowClick:n=>R(o=>({...o,[n.id]:!o[n.id]})),expandedRows:m,platoonSectionMap:j,children:n=>e.jsxs("div",{id:`details-rev-${n.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!g[n.id],"aria-controls":`docs-rev-${n.id}`,onClick:()=>{Q(o=>({...o,[n.id]:!o[n.id]})),X(o=>g[n.id]?null:n.id)},onKeyDown:o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),Q(A=>({...A,[n.id]:!A[n.id]})),X(A=>g[n.id]?null:n.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${g[n.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-rev-${n.id}`,ref:g[n.id]?Z:void 0,className:`${g[n.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[Ce(n.id).map(o=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(et,{type:o.type,fileName:o.name,size:"md"}),e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:o.name}),e.jsx("div",{children:new Date(o.uploadedAt).toLocaleDateString()})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[o.fileUrl&&at(o.type,o.name)&&e.jsx("button",{onClick:()=>J(o),className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",children:"Preview"}),o.fileUrl?e.jsx("a",{href:o.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})]})]},o.id)),Ce(n.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>v(o=>({...o,[n.id]:!o[n.id]})),"aria-expanded":!!z[n.id],"aria-controls":`logs-${n.id}`,children:[z[n.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${n.id}`,className:z[n.id]?"mt-2 space-y-2":"hidden",children:n.activity&&n.activity.length?n.activity.map((o,A)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[o.actor,o.actorRole?` • ${o.actorRole}`:""," • ",new Date(o.timestamp).toLocaleString()," • ",o.action]}),o.comment&&e.jsx("div",{className:"text-gray-600",children:o.comment})]},A)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),e.jsx("textarea",{rows:2,value:b[n.id]||"",onChange:o=>I(A=>({...A,[n.id]:o.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[e.jsx("input",{type:"file",multiple:!0,onChange:o=>H(A=>({...A,[n.id]:o.target.files?Array.from(o.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),e.jsx("span",{className:"text-xs text-[var(--muted)]",children:(V[n.id]||[]).length?`${(V[n.id]||[]).length} file(s) selected`:"No files selected"}),e.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>Le(n),disabled:!V[n.id]||!(V[n.id]||[]).length,children:"Save Files"}),Is(n)&&e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Ae(n,n.currentStage==="PLATOON_REVIEW"?ct:dt(n.currentStage),"Returned to previous stage"),children:"Return to Previous"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>Ae(n,"ARCHIVED","Archived by Reviewer"),children:"Archive"})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[String((a==null?void 0:a.role)||"").includes("COMPANY")&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsx("label",{className:"sr-only",children:"Battalion Section"}),e.jsxs("select",{"aria-label":"Battalion Section",value:O[n.id]||"",onChange:o=>u(A=>({...A,[n.id]:o.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[e.jsx("option",{value:"",children:"Select section"}),(K[(a==null?void 0:a.unitUic)||""]||[]).map(o=>e.jsx("option",{value:o,children:o},o))]})]}),(()=>{const o=Rs(n),A=Ms(n);return o||A?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Ae(n,n.currentStage==="PLATOON_REVIEW"?ct:dt(n.currentStage),"Returned to previous stage"),children:"Return to Previous"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Ae(n,"ARCHIVED","Archived by Reviewer"),children:"Archive"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>{if(String((a==null?void 0:a.role)||"").includes("COMPANY")){if(!O[n.id])return;Ae(n,"BATTALION_REVIEW",`Approved and routed to ${O[n.id]}`)}else Ae(n,Es(n.currentStage),"Approved")},disabled:String((a==null?void 0:a.role)||"").includes("COMPANY")&&!O[n.id],children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Ae(n,n.currentStage==="PLATOON_REVIEW"?ct:dt(n.currentStage),n.currentStage==="PLATOON_REVIEW"?"Returned to Originator for revision":"Returned to previous stage"),children:"Return"})]})})()]})]})}),W==="In Scope"&&e.jsx(ze,{title:"In Scope",requests:Se.currentData,users:P,onRowClick:n=>R(o=>({...o,[n.id]:!o[n.id]})),expandedRows:m,platoonSectionMap:j,children:n=>e.jsxs("div",{id:`details-rev-${n.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!g[n.id],"aria-controls":`docs-rev-${n.id}`,onClick:()=>{Q(o=>({...o,[n.id]:!o[n.id]})),X(o=>g[n.id]?null:n.id)},onKeyDown:o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),Q(A=>({...A,[n.id]:!A[n.id]})),X(A=>g[n.id]?null:n.id))},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${g[n.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-rev-${n.id}`,ref:g[n.id]?Z:void 0,className:`${g[n.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[Ce(n.id).map(o=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(et,{type:o.type,fileName:o.name,size:"md"}),e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:o.name}),e.jsx("div",{children:new Date(o.uploadedAt).toLocaleDateString()})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[o.fileUrl&&at(o.type,o.name)&&e.jsx("button",{onClick:()=>J(o),className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",children:"Preview"}),o.fileUrl?e.jsx("a",{href:o.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})]})]},o.id)),Ce(n.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>v(o=>({...o,[n.id]:!o[n.id]})),"aria-expanded":!!z[n.id],"aria-controls":`logs-${n.id}`,children:[z[n.id]?"Hide":"Show"," Activity Log"]}),e.jsx("div",{id:`logs-${n.id}`,className:z[n.id]?"mt-2 space-y-2":"hidden",children:n.activity&&n.activity.length?n.activity.map((o,A)=>e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"font-medium",children:[o.actor,o.actorRole?` • ${o.actorRole}`:""," • ",new Date(o.timestamp).toLocaleString()," • ",o.action]}),o.comment&&e.jsx("div",{className:"text-gray-600",children:o.comment})]},A)):e.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]})]})})]})]}),h&&a&&e.jsx(Cs,{currentUser:a,onClose:()=>_(!1)}),w&&w.fileUrl&&e.jsx(Wt,{url:w.fileUrl,fileName:w.name,mimeType:w.type,fileSize:w.size,isOpen:!!w,onClose:()=>J(null)})]})}const Vt="MM",Ht="Manpower Management",zt="MMEA",Ut="Enlisted Personnel Assignments (General oversight)",Os={division_code:Vt,division_name:Ht,branch:zt,description:Ut},Ds=Object.freeze(Object.defineProperty({__proto__:null,branch:zt,default:Os,description:Ut,division_code:Vt,division_name:Ht},Symbol.toStringTag,{value:"Module"}));async function $s(){try{const t=Object.assign({"../hqmc-structure/MM__manpower-management__mmea.json":Ds}),a=[];for(const i of Object.values(t)){const p=(i==null?void 0:i.default)??i;if(p&&typeof p=="object"){const d=String(p.division_code||""),N=String(p.division_name||""),S=String(p.branch||""),b=p.description?String(p.description):void 0;d&&S&&a.push({division_code:d,division_name:N,branch:S,description:b})}}return a}catch{return[]}}function Ls(){var B;const[t,a]=s.useState(null),[i,p]=s.useState([]),[d,N]=s.useState([]),[S,b]=s.useState(""),[I,P]=s.useState(""),[D,z]=s.useState([]),[v,V]=s.useState(null),[H,O]=s.useState("structure"),[u,K]=s.useState({}),[T,j]=s.useState({}),[L,h]=s.useState({});s.useEffect(()=>{try{const M=localStorage.getItem("currentUser");M&&a(JSON.parse(M))}catch{}$t().then(M=>{try{p(M.map(G=>({code:String(G.code||""),name:String(G.name||"")})))}catch{p([])}}),$s().then(M=>{N(M)}),Ue().then(M=>z(M)).catch(()=>z([])),yt().then(M=>{const G={};for(const f of M){const g=`${f.division_code}::${f.branch}`;G[g]={reviewers:f.reviewers||[],approvers:f.approvers||[]}}K(G)})},[]);const _=(t==null?void 0:t.hqmcDivision)||((B=i[0])==null?void 0:B.code)||"",m=s.useMemo(()=>i.find(M=>M.code===_),[i,_]),R=s.useMemo(()=>(Array.isArray(d)?d:[]).filter(M=>String(M.division_code||"")===_),[d,_]);return s.useMemo(()=>(Array.isArray(D)?D:[]).filter(M=>!!M.isHqmcAdmin&&String(M.hqmcDivision||"")===_),[D,_]),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"HQMC Administration"}),!(t!=null&&t.isHqmcAdmin)&&e.jsx("div",{className:"text-center text-gray-500",children:e.jsx("p",{children:"You are not an HQMC admin."})}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 text-sm text-gray-600",children:["Division: ",m?`${m.code} — ${m.name}`:"None assigned"]}),e.jsx("div",{className:"border-b border-gray-200 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>O("structure"),className:`${H==="structure"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Structure"}),e.jsx("button",{onClick:()=>O("permissions"),className:`${H==="permissions"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Permissions"})]})}),H==="structure"&&e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Branch/Section"}),e.jsx("th",{className:"py-2 px-3",children:"Description"})]})}),e.jsxs("tbody",{children:[R.map(M=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:M.branch}),e.jsx("td",{className:"py-2 px-3",children:M.description||""})]},M.branch)),R.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No structure entries for your division."})})]})]}),(t==null?void 0:t.isHqmcAdmin)&&e.jsxs("div",{className:"mt-4 p-3 border rounded",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Add Branch/Section"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:S,onChange:M=>b(M.target.value),placeholder:"Branch",className:"px-2 py-1 border rounded"}),e.jsx("input",{value:I,onChange:M=>P(M.target.value),placeholder:"Description",className:"px-2 py-1 border rounded w-64"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!S.trim(),onClick:async()=>{var M;try{await fetch("/api/hqmc-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({division_code:_,division_name:((M=i.find(f=>f.code===_))==null?void 0:M.name)||"",branch:S.trim(),description:I.trim()})});const G=await fetch("/api/hqmc-structure").then(f=>f.json());N(G),b(""),P("")}catch{}},children:"Add"})]})]})]}),H==="permissions"&&e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"md:col-span-2 p-4 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Section Reviewers & Approvers"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:async()=>{for(const M of R){const G=`${_}::${M.branch}`,f=u[G]||{reviewers:[],approvers:[]};await Lt({division_code:_,branch:M.branch,reviewers:f.reviewers,approvers:f.approvers})}V({type:"success",message:"HQMC section permissions saved."})},children:"Save"})]}),e.jsx("div",{className:"space-y-4",children:R.map(M=>{const G=`${_}::${M.branch}`,f=u[G]||{reviewers:[],approvers:[]},g=Q=>`${Q.rank||""} ${Q.lastName||""}, ${Q.firstName||""}${Q.mi?" "+Q.mi:""}`.trim();return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:M.branch}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:T[G]||"",onChange:Q=>j(q=>({...q,[G]:Q.target.value})),placeholder:"Enter EDIPI to add reviewer",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!T[G],onClick:async()=>{const Q=(T[G]||"").trim();if(!Q)return;const{user:q}=await xt(Q);if(!(q!=null&&q.id)){V({type:"error",message:`No user found for EDIPI ${Q}`});return}K(X=>({...X,[G]:{...f,reviewers:Array.from(new Set([...f.reviewers||[],q.id]))}})),j(X=>({...X,[G]:""})),V({type:"success",message:`Added reviewer ${q.lastName||""}, ${q.firstName||""}`})},children:"Add Reviewer"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(f.reviewers||[]).map(Q=>{const q=D.find(X=>X.id===Q);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:q?g(q):Q}),e.jsx("button",{className:"text-red-600",onClick:()=>K(X=>({...X,[G]:{...f,reviewers:(f.reviewers||[]).filter(Z=>Z!==Q)}})),children:"✕"})]},Q)}),(f.reviewers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No reviewers assigned"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:L[G]||"",onChange:Q=>h(q=>({...q,[G]:Q.target.value})),placeholder:"Enter EDIPI to add approver",className:"px-2 py-1 border rounded w-56"}),e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!L[G],onClick:async()=>{const Q=(L[G]||"").trim();if(!Q)return;const{user:q}=await xt(Q);if(!(q!=null&&q.id)){V({type:"error",message:`No user found for EDIPI ${Q}`});return}K(X=>({...X,[G]:{...f,approvers:Array.from(new Set([...f.approvers||[],q.id]))}})),h(X=>({...X,[G]:""})),V({type:"success",message:`Added approver ${q.lastName||""}, ${q.firstName||""}`})},children:"Add Approver"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(f.approvers||[]).map(Q=>{const q=D.find(X=>X.id===Q);return e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 text-xs bg-gray-100 rounded border",children:[e.jsx("span",{children:q?g(q):Q}),e.jsx("button",{className:"text-red-600",onClick:()=>K(X=>({...X,[G]:{...f,approvers:(f.approvers||[]).filter(Z=>Z!==Q)}})),children:"✕"})]},Q)}),(f.approvers||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No approvers assigned"})]})]})]})]},G)})})]})})]}),v&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${v.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:v.message})]})}const Ze=(t,a)=>`${t}::${a}`;function _s({currentUser:t,divisionCode:a,branches:i,assignments:p,onClose:d}){const[N,S]=s.useState([]),[b,I]=s.useState(""),[P,D]=s.useState(""),[z,v]=s.useState("reviewer"),[V,H]=s.useState(!1);s.useEffect(()=>{vt().then(m=>S(m)).catch(()=>S([]))},[]);const O=s.useMemo(()=>{const m={};for(const R of p)m[Ze(R.division_code,R.branch)]={reviewers:R.reviewers||[],approvers:R.approvers||[]};return m},[p]),u=String(t.id||""),K=s.useMemo(()=>{if(!b)return!1;const m=O[Ze(a,b)]||{reviewers:[],approvers:[]};return(m.reviewers||[]).includes(u)||(m.approvers||[]).includes(u)||!!t.isHqmcAdmin},[b,O,u,t]),T=s.useMemo(()=>N.filter(m=>String(m.hqmcDivision||"")===String(a||"")&&String(m.id||"")!==u),[N,a,u]),j=s.useMemo(()=>{if(!b)return[];const m=O[Ze(a,b)]||{reviewers:[],approvers:[]};return Array.from(new Set([...m.reviewers||[],...m.approvers||[]])).map(B=>T.find(M=>M.id===B)).filter(Boolean)},[b,O,T,a]),L=async m=>{H(!0);try{await Lt({division_code:a,branch:b,reviewers:m.reviewers,approvers:m.approvers});try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:t.id,scope:{hqmcDivision:a,branch:b},event:"hqmc_section_assignments_updated",timestamp:new Date().toISOString()})})}catch{}}finally{H(!1)}},h=async()=>{if(!K||!b||!P)return;const m=O[Ze(a,b)]||{reviewers:[],approvers:[]},R={reviewers:Array.from(new Set(m.reviewers||[])),approvers:Array.from(new Set(m.approvers||[]))};z==="reviewer"?R.reviewers=Array.from(new Set([...R.reviewers,P])):R.approvers=Array.from(new Set([...R.approvers,P])),await L(R),D("")},_=async m=>{if(!K||!b)return;const R=O[Ze(a,b)]||{reviewers:[],approvers:[]},B={reviewers:(R.reviewers||[]).filter(M=>M!==m),approvers:(R.approvers||[]).filter(M=>M!==m)};await L(B)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:d,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage HQMC Section Access"}),e.jsx("button",{className:"text-gray-500",onClick:d,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:b,onChange:m=>I(m.target.value),children:[e.jsx("option",{value:"",children:"Select section"}),i.map(m=>e.jsx("option",{value:m,children:m},m))]})]}),b&&!K&&e.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You are not assigned to this section. Only assigned reviewers/approvers or HQMC admins can manage access."}),b&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:P,onChange:m=>D(m.target.value),disabled:!K,children:[e.jsx("option",{value:"",children:"Choose user"}),T.map(m=>e.jsxs("option",{value:m.id,children:[m.rank," ",m.lastName,", ",m.firstName,m.mi?` ${m.mi}`:""," • ",m.email]},m.id))]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("label",{className:"text-xs",children:"Role"}),e.jsxs("select",{className:"px-2 py-1 border rounded text-xs",value:z,onChange:m=>v(m.target.value),children:[e.jsx("option",{value:"reviewer",children:"Reviewer"}),e.jsx("option",{value:"approver",children:"Approver"})]}),e.jsx("button",{className:"ml-auto px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!K||!P||V,onClick:h,children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 mb-1",children:"Current Members"}),e.jsxs("div",{className:"space-y-2",children:[j.map(m=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[m.rank," ",m.lastName,", ",m.firstName,m.mi?` ${m.mi}`:""," • ",m.email]}),e.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!K||V,onClick:()=>_(m.id),children:"Remove"})]},m.id)),j.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]})]})})]})]})})}const tt=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],qs=t=>{const a=tt.indexOf(t||tt[0]);return a>0?tt[a-1]:tt[0]};function Ts(){const[t,a]=s.useState(()=>{try{const y=localStorage.getItem("currentUser");return y?JSON.parse(y):null}catch{return null}}),[i,p]=s.useState([]),[d,N]=s.useState([]),[S,b]=s.useState({}),[I,P]=s.useState({}),[D,z]=s.useState({}),[v,V]=s.useState({}),[H,O]=s.useState(null),u=s.useRef(null),[K,T]=s.useState([]),[j,L]=s.useState("Pending"),[h,_]=s.useState([]),[m,R]=s.useState({}),[B,M]=s.useState(!1);s.useEffect(()=>{const y=re=>{H&&u.current&&!u.current.contains(re.target)&&(V(le=>({...le,[H]:!1})),O(null))},F=re=>{re.key==="Escape"&&H&&(V(le=>({...le,[H]:!1})),O(null))};return document.addEventListener("mousedown",y),document.addEventListener("keydown",F),()=>{document.removeEventListener("mousedown",y),document.removeEventListener("keydown",F)}},[H]),s.useEffect(()=>{rt().then(y=>p(y)).catch(()=>p([]))},[]),s.useEffect(()=>{ft().then(y=>N(y)).catch(()=>N([]))},[]),s.useEffect(()=>{Ue().then(y=>{const F={};for(const re of y)re!=null&&re.id&&(F[re.id]=re);P(F)}).catch(()=>P({}))},[]),s.useEffect(()=>{yt().then(T).catch(()=>T([]))},[]),s.useEffect(()=>{os().then(_).catch(()=>_([]))},[]);const G=(t==null?void 0:t.id)||"",f=String((t==null?void 0:t.hqmcDivision)||""),g=s.useMemo(()=>K.filter(y=>y.division_code===f&&((y.reviewers||[]).includes(G)||(y.approvers||[]).includes(G))).map(y=>y.branch),[K,f,G]),Q=y=>I[y.uploadedById]||null,q=y=>{if(!f||!G)return!1;const F=String(y.routeSection||"");return g.includes(F)},X=s.useMemo(()=>(Array.isArray(i)?i:[]).filter(q),[i,g]),Z=s.useMemo(()=>X.filter(y=>(y.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[X]),W=s.useMemo(()=>X.filter(y=>(y.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[X]),ge=y=>d.filter(F=>F.requestId===y),ve=y=>`"${String(y??"").replace(/"/g,'""')}"`,we=y=>{const re=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const le of y){const me=Q(le),je=me?`${me.rank} ${me.lastName}, ${me.firstName}${me.mi?` ${me.mi}`:""}`:"",Se=ge(le.id).map(Ce=>Ce.name).join(" | ");re.push([le.id,le.subject,le.currentStage||"",le.routeSection||"",je,le.unitUic||"",new Date(le.createdAt).toLocaleString(),Se])}return re.map(le=>le.map(ve).join(",")).join(`\r
`)},w=(y,F)=>{const re=new Blob([F],{type:"text/csv;charset=utf-8;"}),le=URL.createObjectURL(re),me=document.createElement("a");me.href=le,me.download=y,document.body.appendChild(me),me.click(),document.body.removeChild(me),URL.revokeObjectURL(le)},J=()=>w("hqmc_pending.csv",we(Z)),ae=()=>w("hqmc_in_scope.csv",we(W)),te=()=>w("hqmc_all.csv",we([...Z,...W])),Y=async y=>{const F=t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",re=String(m[y.id]||"").trim();if(!re){alert("Select an HQMC section to route to approver");return}const le={actor:F,timestamp:new Date().toISOString(),action:`Routed to HQMC section: ${re}`,comment:(S[y.id]||"").trim()},me={...y,routeSection:re,activity:Array.isArray(y.activity)?[...y.activity,le]:[le]};try{await Be(me)}catch{}p(je=>je.map(Se=>Se.id===me.id?me:Se)),b(je=>({...je,[y.id]:""}))},he=async y=>{const re={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Reviewer",timestamp:new Date().toISOString(),action:"Returned by HQMC",comment:(S[y.id]||"").trim()},le={...y,currentStage:qs(y.currentStage),activity:Array.isArray(y.activity)?[...y.activity,re]:[re]};try{await Be(le)}catch{}p(me=>me.map(je=>je.id===le.id?le:je)),b(me=>({...me,[y.id]:""}))};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Section Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:f||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:te,children:"Export All"}),g.length>0&&e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>M(!0),children:"Manage Section Access"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>L("Pending"),className:`${j==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>L("In Scope"),className:`${j==="In Scope"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"In Scope"})]})}),e.jsxs("div",{className:"mt-4",children:[j==="Pending"&&e.jsx(ze,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:J,children:"Export Pending"}),requests:Z,users:I,onRowClick:y=>z(F=>({...F,[y.id]:!F[y.id]})),expandedRows:D,children:y=>e.jsxs("div",{id:`details-hq-${y.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!v[y.id],"aria-controls":`docs-hq-${y.id}`,onClick:()=>{V(F=>({...F,[y.id]:!F[y.id]})),O(F=>v[y.id]?null:y.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${v[y.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-hq-${y.id}`,ref:v[y.id]?u:void 0,className:`${v[y.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[ge(y.id).map(F=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:F.name}),e.jsx("div",{children:new Date(F.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:F.fileUrl?e.jsx("a",{href:F.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},F.id)),ge(y.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:S[y.id]||"",onChange:F=>b(re=>({...re,[y.id]:F.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-[var(--text)]",children:"Route to HQMC Section"}),e.jsxs("select",{value:m[y.id]||"",onChange:F=>R(re=>({...re,[y.id]:F.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Select section"}),h.filter(F=>String(F.division_code||"")===f).map(F=>e.jsx("option",{value:F.branch,children:F.branch},F.branch))]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Y(y),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>he(y),children:"Return"})]})]})]})}),j==="In Scope"&&e.jsx(ze,{title:"In Scope",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ae,children:"Export In Scope"}),requests:W,users:I,onRowClick:y=>z(F=>({...F,[y.id]:!F[y.id]})),expandedRows:D,children:y=>e.jsxs("div",{id:`details-hq-${y.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!v[y.id],"aria-controls":`docs-hq-${y.id}`,onClick:()=>{V(F=>({...F,[y.id]:!F[y.id]})),O(F=>v[y.id]?null:y.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${v[y.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-hq-${y.id}`,ref:v[y.id]?u:void 0,className:`${v[y.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[ge(y.id).map(F=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:F.name}),e.jsx("div",{children:new Date(F.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:F.fileUrl?e.jsx("a",{href:F.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},F.id)),ge(y.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})]})})]})]}),B&&t&&e.jsx(_s,{currentUser:t,divisionCode:f,branches:h.filter(y=>String(y.division_code||"")===f).map(y=>y.branch),assignments:K,onClose:()=>M(!1)})]})}const st=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW","ARCHIVED"],Bs=t=>{const a=st.indexOf(t||st[0]);return a>0?st[a-1]:st[0]};function Ws(){const[t,a]=s.useState(()=>{try{const w=localStorage.getItem("currentUser");return w?JSON.parse(w):null}catch{return null}}),[i,p]=s.useState([]),[d,N]=s.useState([]),[S,b]=s.useState({}),[I,P]=s.useState({}),[D,z]=s.useState({}),[v,V]=s.useState({}),[H,O]=s.useState(null),u=s.useRef(null),[K,T]=s.useState([]),[j,L]=s.useState("Pending");s.useEffect(()=>{const w=ae=>{H&&u.current&&!u.current.contains(ae.target)&&(V(te=>({...te,[H]:!1})),O(null))},J=ae=>{ae.key==="Escape"&&H&&(V(te=>({...te,[H]:!1})),O(null))};return document.addEventListener("mousedown",w),document.addEventListener("keydown",J),()=>{document.removeEventListener("mousedown",w),document.removeEventListener("keydown",J)}},[H]),s.useEffect(()=>{rt().then(w=>p(w)).catch(()=>p([]))},[]),s.useEffect(()=>{ft().then(w=>N(w)).catch(()=>N([]))},[]),s.useEffect(()=>{Ue().then(w=>{const J={};for(const ae of w)ae!=null&&ae.id&&(J[ae.id]=ae);P(J)}).catch(()=>P({}))},[]),s.useEffect(()=>{yt().then(T).catch(()=>T([]))},[]);const h=(t==null?void 0:t.id)||"",_=String((t==null?void 0:t.hqmcDivision)||""),m=s.useMemo(()=>K.filter(w=>w.division_code===_&&(w.approvers||[]).includes(h)).map(w=>w.branch),[K,_,h]),R=w=>I[w.uploadedById]||null,B=w=>{if(!_||!h)return!1;const J=String(w.routeSection||"");return m.includes(J)},M=s.useMemo(()=>(Array.isArray(i)?i:[]).filter(B),[i,m]),G=s.useMemo(()=>M.filter(w=>(w.currentStage||"PLATOON_REVIEW")!=="ARCHIVED"),[M]),f=s.useMemo(()=>M.filter(w=>(w.currentStage||"PLATOON_REVIEW")==="ARCHIVED"),[M]),g=w=>d.filter(J=>J.requestId===w),Q=w=>`"${String(w??"").replace(/"/g,'""')}"`,q=w=>{const ae=[["Request ID","Subject","Stage","HQMC Section","Originator","Unit UIC","Created At","Documents"]];for(const te of w){const Y=R(te),he=Y?`${Y.rank} ${Y.lastName}, ${Y.firstName}${Y.mi?` ${Y.mi}`:""}`:"",y=g(te.id).map(F=>F.name).join(" | ");ae.push([te.id,te.subject,te.currentStage||"",te.routeSection||"",he,te.unitUic||"",new Date(te.createdAt).toLocaleString(),y])}return ae.map(te=>te.map(Q).join(",")).join(`\r
`)},X=(w,J)=>{const ae=new Blob([J],{type:"text/csv;charset=utf-8;"}),te=URL.createObjectURL(ae),Y=document.createElement("a");Y.href=te,Y.download=w,document.body.appendChild(Y),Y.click(),document.body.removeChild(Y),URL.revokeObjectURL(te)},Z=()=>X("hqmc_approver_pending.csv",q(G)),W=()=>X("hqmc_approver_approved.csv",q(f)),ge=()=>X("hqmc_approver_all.csv",q([...G,...f])),ve=async w=>{const ae={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"HQMC Approver Approved",comment:(S[w.id]||"").trim()},te={...w,currentStage:"ARCHIVED",activity:Array.isArray(w.activity)?[...w.activity,ae]:[ae]};try{await Be(te)}catch{}p(Y=>Y.map(he=>he.id===te.id?te:he)),b(Y=>({...Y,[w.id]:""}))},we=async w=>{const ae={actor:t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}`.trim():"HQMC Approver",timestamp:new Date().toISOString(),action:"Returned by HQMC Approver",comment:(S[w.id]||"").trim()},te={...w,currentStage:Bs(w.currentStage),activity:Array.isArray(w.activity)?[...w.activity,ae]:[ae]};try{await Be(te)}catch{}p(Y=>Y.map(he=>he.id===te.id?te:he)),b(Y=>({...Y,[w.id]:""}))};return e.jsx("div",{className:"max-w-7xl mx-auto p-6",children:e.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"HQMC Approver Dashboard"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:String((t==null?void 0:t.hqmcDivision)||"")||"N/A"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ge,children:"Export All"})]})]})}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>L("Pending"),className:`${j==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),e.jsx("button",{onClick:()=>L("Approved"),className:`${j==="Approved"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Approved"})]})}),e.jsxs("div",{className:"mt-4",children:[j==="Pending"&&e.jsx(ze,{title:"Pending",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Z,children:"Export Pending"}),requests:G,users:I,onRowClick:w=>z(J=>({...J,[w.id]:!J[w.id]})),expandedRows:D,children:w=>e.jsxs("div",{id:`details-hqa-${w.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!v[w.id],"aria-controls":`docs-hqa-${w.id}`,onClick:()=>{V(J=>({...J,[w.id]:!J[w.id]})),O(J=>v[w.id]?null:w.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${v[w.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-hqa-${w.id}`,ref:v[w.id]?u:void 0,className:`${v[w.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[g(w.id).map(J=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:J.name}),e.jsx("div",{children:new Date(J.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:J.fileUrl?e.jsx("a",{href:J.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},J.id)),g(w.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"HQMC Comment"}),e.jsx("textarea",{rows:2,value:S[w.id]||"",onChange:J=>b(ae=>({...ae,[w.id]:J.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg",placeholder:"Optional notes"})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>ve(w),children:"Approve"}),e.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>we(w),children:"Return"})]})]})}),j==="Approved"&&e.jsx(ze,{title:"Approved",titleActions:e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:W,children:"Export Approved"}),requests:f,users:I,onRowClick:w=>z(J=>({...J,[w.id]:!J[w.id]})),expandedRows:D,children:w=>e.jsxs("div",{id:`details-hqa-${w.id}`,children:[e.jsx("div",{className:"mt-3",children:e.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!v[w.id],"aria-controls":`docs-hqa-${w.id}`,onClick:()=>{V(J=>({...J,[w.id]:!J[w.id]})),O(J=>v[w.id]?null:w.id)},children:[e.jsx("span",{children:"Show Documents"}),e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${v[w.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:e.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),e.jsxs("div",{id:`docs-hqa-${w.id}`,ref:v[w.id]?u:void 0,className:`${v[w.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[g(w.id).map(J=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[e.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[e.jsx("div",{className:"font-medium text-[var(--text)]",children:J.name}),e.jsx("div",{children:new Date(J.uploadedAt).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-2",children:J.fileUrl?e.jsx("a",{href:J.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2",children:"Open"}):e.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},J.id)),g(w.id).length===0&&e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})]})})]})]})})}const Fs=({onUnitSelect:t,selectedUnit:a})=>{const[i,p]=s.useState(""),[d,N]=s.useState(!1),S=We.filter(I=>I.unitName.toLowerCase().startsWith(i.toLowerCase())||I.uic.toLowerCase().startsWith(i.toLowerCase())||I.ruc.toLowerCase().startsWith(i.toLowerCase())),b=I=>{t(I),N(!1),p("")};return e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Unit"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>N(!d),className:"w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[a?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",a.uic," | RUC: ",a.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"Choose a unit..."}),e.jsx("svg",{className:"w-5 h-5 absolute right-3 top-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),d&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",children:[e.jsx("div",{className:"p-2",children:e.jsx("input",{type:"text",placeholder:"Search units...",value:i,onChange:I=>p(I.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:S.map(I=>e.jsxs("button",{type:"button",onClick:()=>b(I),className:"w-full px-4 py-3 text-left hover:bg-gray-50 focus:outline-none focus:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-sm",children:I.unitName}),e.jsxs("div",{className:"text-xs text-gray-500",children:["UIC: ",I.uic," | RUC: ",I.ruc," | MCC: ",I.mcc]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[I.streetAddress,", ",I.cityState," ",I.zip]})]},I.uic))})]})]})]})},bt=async t=>{const i=new TextEncoder().encode(t),p=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(p)).map(d=>d.toString(16).padStart(2,"0")).join("")};async function Vs(t,a){const i=ls();return i!=null&&i.auth?await i.auth.signUp({email:t,password:a}):{data:null,error:new Error("supabase_not_initialized")}}const Mt={"Marine Corps":["Pvt","PFC","LCpl","Cpl","Sgt","SSgt","GySgt","MSgt","1stSgt","SgtMaj","MGySgt","WO","CWO2","CWO3","CWO4","CWO5","2ndLt","1stLt","Capt","Maj","LtCol","Col","BGen","MajGen","LtGen","Gen"],Army:["PV1","PV2","PFC","SPC","CPL","SGT","SSG","SFC","MSG","1SG","SGM","WO1","CW2","CW3","CW4","CW5","2LT","1LT","CPT","MAJ","LTC","COL","BG","MG","LTG","GEN"],Navy:["SR","SA","SN","PO3","PO2","PO1","CPO","SCPO","MCPO","CWO2","CWO3","CWO4","CWO5","ENS","LTJG","LT","LCDR","CDR","CAPT","RDML","RADM","VADM","ADM"],"Air Force":["AB","Amn","A1C","SrA","SSgt","TSgt","MSgt","SMSgt","CMSgt","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"],"Space Force":["Spc1","Spc2","Spc3","Spc4","Spc5","Spc6","Spc7","Spc8","Spc9","2d Lt","1st Lt","Capt","Maj","Lt Col","Col","Brig Gen","Maj Gen","Lt Gen","Gen"]},Hs=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Gt=({onSaved:t,initial:a={},mode:i="create",readOnly:p=!1,canEditRole:d=!1,canEditAdmin:N=!1})=>{const[S,b]=s.useState(""),[I,P]=s.useState(""),[D,z]=s.useState(""),[v,V]=s.useState(a.email||""),[H,O]=s.useState(a.edipi||""),[u,K]=s.useState(a.service||""),[T,j]=s.useState(a.rank||""),[L,h]=s.useState(a.role||"MEMBER"),[_,m]=s.useState(!!a.isUnitAdmin),[R,B]=s.useState(a.company||""),[M,G]=s.useState(a.platoon||""),[f,g]=s.useState(void 0),[Q,q]=s.useState(null),[X,Z]=s.useState({}),[W,ge]=s.useState(""),[ve,we]=s.useState(""),[w,J]=s.useState([]),[ae,te]=s.useState(!1),[Y,he]=s.useState(a.roleCompany||""),[y,F]=s.useState(a.rolePlatoon||""),[re,le]=s.useState(!1),[me,je]=s.useState([]),[Se,Ce]=s.useState([]),[$e,Ae]=s.useState([]),[Le,n]=s.useState([]);s.useEffect(()=>{if(a.firstName&&b(String(a.firstName)),a.lastName&&P(String(a.lastName)),a.mi&&z(String(a.mi)),a.company&&B(String(a.company)),a.platoon&&G(String(a.platoon)),a.roleCompany&&he(String(a.roleCompany)),a.rolePlatoon&&F(String(a.rolePlatoon)),a.unitUic){const x=We.find(oe=>oe.uic===a.unitUic);x&&g(x)}},[a]);const o=s.useMemo(()=>Mt[u]||[],[u]),A=s.useMemo(()=>{if(!f)return[];const x=me;if(x&&x.length)return x;const oe=X[f.uic]||{};return Object.keys(oe).filter(c=>!c.startsWith("_")&&Array.isArray(oe[c]))},[f,X,me]),C=s.useMemo(()=>{var x;return f&&R?((x=X[f.uic])==null?void 0:x[R])||[]:[]},[f,R,X]),ie=s.useMemo(()=>{if(!f||!R)return[];const x=Se;return x&&x.length?x:C},[f,R,Se,C]),ce=s.useMemo(()=>{if(!f)return[];const x=$e;if(x&&x.length)return x;const oe=X[f.uic]||{};return Object.keys(oe).filter(c=>!c.startsWith("_")&&Array.isArray(oe[c]))},[f,X,$e]),Re=s.useMemo(()=>{var x;return f&&Y?((x=X[f.uic])==null?void 0:x[Y])||[]:[]},[f,Y,X]),ke=s.useMemo(()=>{if(!f||!Y)return[];const x=Le;return x&&x.length?x:Re},[f,Y,Le,Re]),de=s.useMemo(()=>{const x=A.slice(),oe=R||a.company||a.user_company||"";return oe&&!x.includes(oe)?[oe,...x]:x},[A,R,a]),Ee=s.useMemo(()=>{const x=ie.slice(),oe=M||a.platoon||a.user_platoon||"";return oe&&!x.includes(oe)?[oe,...x]:x},[ie,M,a]),Me=s.useMemo(()=>{const x=ce.slice(),oe=Y||a.roleCompany||"",c=oe&&!x.includes(oe)?[oe,...x]:x;return Array.from(new Set(c))},[ce,Y,a]),Fe=s.useMemo(()=>{const x=ke.slice(),oe=y||a.rolePlatoon||"";return oe&&!x.includes(oe)?[oe,...x]:x},[ke,y,a]);s.useEffect(()=>{(async()=>{try{if(i==="edit"&&a.id){const x=await _t(String(a.id));x&&(x.company&&!R&&B(String(x.company)),x.platoon&&!M&&G(String(x.platoon)),x.roleCompany&&!Y&&he(String(x.roleCompany)),x.rolePlatoon&&!y&&F(String(x.rolePlatoon)))}}catch{}})()},[i,a.id]),s.useEffect(()=>{o.includes(T)||j("")},[o]),s.useEffect(()=>{G("")},[R]),s.useEffect(()=>{F("")},[Y]),s.useEffect(()=>{try{const x=localStorage.getItem("unit_structure");x&&Z(JSON.parse(x))}catch{}},[f]),s.useEffect(()=>{const x=(f==null?void 0:f.uic)||"";if(!x){je([]),Ae([]);return}qt(x).then(oe=>{je(oe||[]),Ae(oe||[])}).catch(()=>{je([]),Ae([])})},[f]),s.useEffect(()=>{const x=(f==null?void 0:f.uic)||"",oe=R||"";if(!x||!oe){Ce([]);return}pt(x,oe).then(c=>Ce(c||[])).catch(()=>Ce([]))},[f,R]),s.useEffect(()=>{const x=(f==null?void 0:f.uic)||"",oe=Y||"";if(!x||!oe){n([]);return}pt(x,oe).then(c=>n(c||[])).catch(()=>n([]))},[f,Y]),s.useEffect(()=>{Ue().then(x=>{J(x)}).catch(()=>J([]))},[]),s.useEffect(()=>{const x=(f==null?void 0:f.uic)||"";if(!x){te(!1);return}const oe=w.some(c=>!!c.isUnitAdmin&&(c.unitUic||"")===x);te(oe)},[f,w]),s.useEffect(()=>{if(f){!R&&a.company&&de.includes(a.company)&&B(String(a.company));const x=a.platoon;!M&&x&&Ee.includes(x)&&G(String(x))}},[f,de,Ee,R,M,a]);const Ge=x=>/^[0-9]{10}$/.test(x),Qe=(x,oe)=>{try{return w.some(c=>String(c.edipi)===String(x)&&String(c.id)!==String(oe||""))}catch{return!1}},Ne=async x=>{var $,ee;if(x.preventDefault(),q(null),p)return;if(!S.trim())return q({type:"error",message:"First name is required."});if(!I.trim())return q({type:"error",message:"Last name is required."});if(D&&!/^[A-Za-z]$/.test(D))return q({type:"error",message:"MI must be a single letter."});if(!v.trim())return q({type:"error",message:"Email is required."});if(!Ge(String(H)))return q({type:"error",message:"EDIPI must be 10 digits."});if(!u)return q({type:"error",message:"Service is required."});if(!T)return q({type:"error",message:"Rank is required."});if(Qe(String(H),a.id?String(a.id):void 0))return q({type:"error",message:"EDIPI already exists."});if(L==="COMPANY_REVIEWER"&&!Y)return q({type:"error",message:"Role Company is required for Company Reviewer."});if(L==="PLATOON_REVIEWER"&&(!Y||!y))return q({type:"error",message:"Role Company and Role Platoon are required for Platoon Reviewer."});`${S.trim()}`,D&&""+D.trim().toUpperCase(),`${I.trim()}`;let oe=a.id?String(a.id):`usr-${Date.now()}`,c=a.passwordHash||"";if(i==="create"){if(!W||W.length<8)return q({type:"error",message:"Password must be at least 8 characters."});if(W!==ve)return q({type:"error",message:"Passwords do not match."});try{const{data:U,error:pe}=await Vs(v.trim(),W);if(pe){q({type:"error",message:`Failed to create auth user: ${String(pe.message||pe)}`});return}const ue=($=U==null?void 0:U.user)!=null&&$.id?String(U.user.id):"";if(!ue){q({type:"error",message:"Auth user ID missing after sign up."});return}oe=ue}catch(U){q({type:"error",message:`Failed to create auth user: ${String((U==null?void 0:U.message)||U)}`});return}c=await bt(W)}else if(i==="edit"&&W){if(W.length<8)return q({type:"error",message:"Password must be at least 8 characters."});if(W!==ve)return q({type:"error",message:"Passwords do not match."});c=await bt(W)}const k={id:oe,firstName:S.trim(),lastName:I.trim(),mi:D?D.trim().toUpperCase():void 0,email:v.trim(),edipi:H,service:u,rank:T,role:L,company:R||"N/A",unit:(f==null?void 0:f.unitName)||"N/A",unitUic:f==null?void 0:f.uic,passwordHash:c,isUnitAdmin:i==="create"&&f&&!ae?!0:_,roleCompany:Y||void 0,rolePlatoon:y||void 0,platoon:M||"N/A"};try{const U=await Ve({id:k.id,email:k.email,rank:k.rank,firstName:k.firstName,lastName:k.lastName,mi:k.mi,service:k.service,role:k.role,unitUic:k.unitUic,unit:(f==null?void 0:f.unitName)||"N/A",company:k.company,isUnitAdmin:!!k.isUnitAdmin,edipi:String(k.edipi),passwordHash:c,platoon:M||"N/A",roleCompany:Y||void 0,rolePlatoon:y||void 0});if(!U.ok){q({type:"error",message:`Failed to save profile: ${String(((ee=U==null?void 0:U.error)==null?void 0:ee.message)||(U==null?void 0:U.error)||"unknown")}`});return}q({type:"success",message:a.id?"Profile updated.":f&&!ae?"Profile created. You have been assigned Unit Admin for this unit.":"Profile created."}),t==null||t(k)}catch{q({type:"error",message:"Failed to save profile."})}};return e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:i==="edit"?"Manage Profile":"Create Profile"}),e.jsxs("form",{onSubmit:Ne,className:"space-y-6",children:[i==="create"&&f&&!ae&&e.jsxs("div",{className:"p-3 border border-yellow-200 bg-yellow-50 text-yellow-800 rounded",children:["No Unit Admin is currently assigned for ",e.jsx("span",{className:"font-medium",children:f.unitName})," (UIC ",f.uic,"). You will be assigned Unit Admin for this unit when you create your account."]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Personal Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{type:"text",value:I,onChange:x=>P(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{type:"text",value:S,onChange:x=>b(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"MI"}),e.jsx("input",{type:"text",value:D,maxLength:1,onChange:x=>z(x.target.value.toUpperCase()),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:v,onChange:x=>V(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"EDIPI"}),e.jsx("input",{type:"text",value:H,onChange:x=>O(x.target.value),placeholder:"10 digits",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be exactly 10 digits"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text sm font-medium text-gray-700 mb-1",children:"Service"}),e.jsxs("select",{value:u,onChange:x=>K(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p,children:[e.jsx("option",{value:"",disabled:!0,children:"Select service"}),Object.keys(Mt).map(x=>e.jsx("option",{value:x,children:x},x))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rank"}),e.jsxs("select",{value:T,onChange:x=>j(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p,children:[e.jsx("option",{value:"",disabled:!0,children:"Select rank"}),o.map(x=>e.jsx("option",{value:x,children:x},x))]})]}),i==="create"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:W,onChange:x=>ge(x.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm Password"}),e.jsx("input",{type:"password",value:ve,onChange:x=>we(x.target.value),autoComplete:"new-password",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p})]})]}):e.jsx(e.Fragment,{})]})]}),re&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 w-full max-w-md",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Update Password"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),e.jsx("input",{type:"password",value:W,onChange:x=>ge(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Minimum 8 characters"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Confirm New Password"}),e.jsx("input",{type:"password",value:ve,onChange:x=>we(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:p})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-100 text-gray-800 rounded border border-gray-300",onClick:()=>le(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:()=>le(!1),children:"Save"})]})]})}),i==="edit"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Roles (View Only)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{children:e.jsx("select",{value:L,onChange:x=>h(x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!0,children:Hs.map(x=>e.jsx("option",{value:x,children:x},x))})}),e.jsx("div",{children:e.jsxs("select",{value:Y||String(a.roleCompany||""),onChange:x=>he(x.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Me.length?"Select company":"No companies configured"}),Me.map(x=>e.jsx("option",{value:x,children:x},x))]})}),e.jsx("div",{children:e.jsxs("select",{value:y||String(a.rolePlatoon||""),onChange:x=>F(x.target.value),disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Fe.length?"Select platoon":"No platoons configured"}),Fe.map(x=>e.jsx("option",{value:x,children:x},x))]})})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"pf-is-unit-admin",type:"checkbox",checked:_,onChange:x=>m(x.target.checked),disabled:p||!N}),e.jsx("label",{htmlFor:"pf-is-unit-admin",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(a==null?void 0:a.isCommandStaff)||L==="COMMANDER",disabled:!0}),e.jsx("span",{className:"text-sm text-gray-700",children:"Allow access to Command Sections Dashboard"})]})})]})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 text-center",children:"Unit Assignment"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(Fs,{onUnitSelect:x=>g(x),selectedUnit:f})}),e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company"}),e.jsxs("select",{value:R||String(a.company||""),onChange:x=>B(x.target.value),disabled:p||!f||de.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:de.length?"Select company":"No companies configured"}),de.map(x=>e.jsx("option",{value:x,children:x},x))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Platoon"}),e.jsxs("select",{value:M||String(a.platoon||""),onChange:x=>G(x.target.value),disabled:p||!f||!R||Ee.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:Ee.length?"Select platoon":"No platoons configured"}),Ee.map(x=>e.jsx("option",{value:x,children:x},x))]})]})]})})]}),Q&&e.jsx("div",{className:`p-3 rounded-lg border ${Q.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:Q.message}),e.jsxs("div",{className:"flex items-center justify-between",children:[i==="edit"&&e.jsx("button",{type:"button",className:"px-4 py-2 bg-brand-cream text-brand-navy rounded border border-gray-300 hover:brightness-105",onClick:()=>le(!0),disabled:p,children:"Update Password"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50",disabled:p,children:i==="edit"?"Save":"Create Profile"})]})]})]})},zs=s.memo(function({user:a,onClose:i}){const p=()=>{const d=We.find(S=>S.uic===a.unitUic),N=d?d.unitName:a.unit;if(a.isUnitAdmin||a.role==="COMMANDER")return N||"—";if(a.role==="COMPANY_REVIEWER")return a.company&&a.company!=="N/A"?a.company:"—";if(a.role==="PLATOON_REVIEWER"){const S=a.company&&a.company!=="N/A"?a.company:"",b=a.platoon&&a.platoon!=="N/A"?a.platoon:"",I=[S,b].filter(Boolean);return I.length?I.join(" / "):"—"}return"—"};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-xl p-6",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Profile"}),e.jsx("button",{className:"text-gray-500",onClick:i,children:"✕"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Name"}),e.jsxs("div",{className:"font-medium",children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium",children:a.email})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"EDIPI"}),e.jsx("div",{className:"font-medium",children:a.edipi||"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Service"}),e.jsx("div",{className:"font-medium",children:a.service})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Role"}),e.jsx("div",{className:"font-medium",children:a.role})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Scope"}),e.jsx("div",{className:"font-medium",children:p()})]}),a.isUnitAdmin&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Permissions"}),e.jsx("div",{className:"font-medium text-purple-600",children:"Unit Admin"})]}),a.isCommandStaff&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Access"}),e.jsx("div",{className:"font-medium text-blue-600",children:"Command Staff"})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",onClick:i,children:"Close"})})]})})}),Us=["MEMBER","PLATOON_REVIEWER","COMPANY_REVIEWER","COMMANDER"],Gs=()=>{const[t,a]=s.useState(null),[i,p]=s.useState(void 0),[d,N]=s.useState({}),[S,b]=s.useState({}),[I,P]=s.useState({}),[D,z]=s.useState({}),[v,V]=s.useState(""),[H,O]=s.useState(""),[u,K]=s.useState(""),[T,j]=s.useState(""),[L,h]=s.useState(""),[_,m]=s.useState([]),[R,B]=s.useState(null),[M,G]=s.useState(""),f=s.useRef(null),[g,Q]=s.useState(null),[q,X]=s.useState(null),[Z,W]=s.useState(""),[ge,ve]=s.useState(void 0),[we,w]=s.useState(void 0),[J,ae]=s.useState(void 0),[te,Y]=s.useState(void 0),[he,y]=s.useState(void 0),[F,re]=s.useState(void 0),[le,me]=s.useState([]),[je,Se]=s.useState([]),[Ce,$e]=s.useState(""),[Ae,Le]=s.useState("unit"),[n,o]=s.useState([]),[A,C]=s.useState(!1),[ie,ce]=s.useState(!1),[Re,ke]=s.useState(!1),[de,Ee]=s.useState("admin"),Me=s.useRef(!1);s.useEffect(()=>{g&&de==="admin"&&!Me.current&&(!ge&&g.company&&g.company!=="N/A"&&(ve(g.company),ae(g.company)),!we&&g.platoon&&g.platoon!=="N/A"&&(w(g.platoon),Y(g.platoon)),!he&&g.roleCompany&&g.roleCompany!=="N/A"&&y(g.roleCompany),!F&&g.rolePlatoon&&g.rolePlatoon!=="N/A"&&re(g.rolePlatoon),Me.current=!0)},[g,de]),s.useEffect(()=>{try{const r=localStorage.getItem("unit_structure");r&&N(JSON.parse(r))}catch{}try{const r=localStorage.getItem("unit_structure"),l={},E={},se={};if(r){const fe=JSON.parse(r);for(const ye of Object.keys(fe||{})){const ne=fe[ye];ne&&Array.isArray(ne._sections)&&(l[ye]=ne._sections),ne&&Array.isArray(ne._commandSections)&&(E[ye]=ne._commandSections),ne&&ne._platoonSectionMap&&typeof ne._platoonSectionMap=="object"&&(se[ye]=ne._platoonSectionMap)}}else(async()=>{try{const fe=await jt();for(const ye of Object.keys(fe||{})){const ne=fe[ye];ne&&Array.isArray(ne._sections)&&(l[ye]=ne._sections),ne&&Array.isArray(ne._commandSections)&&(E[ye]=ne._commandSections),ne&&ne._platoonSectionMap&&typeof ne._platoonSectionMap=="object"&&(se[ye]=ne._platoonSectionMap)}N(fe)}catch{}})();b(l),P(E),z(se)}catch{}Ue().then(r=>{m(r)}).catch(()=>m([]));try{const r=localStorage.getItem("currentUser");if(r){const l=JSON.parse(r);if(a(l),l.unitUic){const E=We.find(se=>se.uic===l.unitUic);E&&p(E)}}}catch{}},[]),s.useEffect(()=>{try{if(!i){const r=Object.keys(d||{});if(r.length){const l=r[0],E=d[l]||{},fe=We.find(ye=>ye.uic===l)||{ruc:String(E._ruc||""),mcc:String(E._mcc||""),uic:l,unitName:String(E._unitName||l),streetAddress:String(E._streetAddress||"")};p(fe)}}}catch{}},[d]),s.useEffect(()=>{const r=(g==null?void 0:g.unitUic)||"";if(!r){me([]);return}qt(r).then(l=>me(l||[])).catch(()=>me([]))},[g]),s.useEffect(()=>{const r=(g==null?void 0:g.unitUic)||"",l=he||"";if(!r||!l){Se([]);return}pt(r,l).then(E=>Se(E||[])).catch(()=>Se([]))},[g,he]);const Fe=s.useMemo(()=>{const r=(i==null?void 0:i.uic)||"";if(!r)return[];const l=d[r]||{};return Object.keys(l).filter(E=>!E.startsWith("_")&&Array.isArray(l[E]))},[i,d]),Ge=s.useMemo(()=>{var E;const r=(i==null?void 0:i.uic)||"";if(!r||!v)return[];const l=(E=d[r])==null?void 0:E[v];return Array.isArray(l)?l:[]},[i,v,d]),Qe=s.useMemo(()=>{const r=(i==null?void 0:i.uic)||"";return r?S[r]||[]:[]},[i,S]),Ne=s.useMemo(()=>{const r=(i==null?void 0:i.uic)||"";return r?I[r]||[]:[]},[i,I]),x=s.useMemo(()=>{const r=(g==null?void 0:g.unitUic)||"";if(!r)return[];const l=le;if(l&&l.length)return l;const E=d[r]||{};return Object.keys(E).filter(se=>!se.startsWith("_")&&Array.isArray(E[se]))},[g,d,le]),oe=s.useMemo(()=>{var se;const r=(g==null?void 0:g.unitUic)||"",l=J||"";if(!r||!l)return[];const E=(se=d[r])==null?void 0:se[l];return Array.isArray(E)?E:[]},[g,J,d]),c=s.useMemo(()=>{var fe,ye;const r=(g==null?void 0:g.unitUic)||"",l=he||"";if(!l)return[];const E=je;if(E&&E.length>0)return E;if(r){const ne=(fe=d[r])==null?void 0:fe[l];if(Array.isArray(ne)&&ne.length>0)return ne}const se=(i==null?void 0:i.uic)||"";if(se&&se!==r){const ne=(ye=d[se])==null?void 0:ye[l];if(Array.isArray(ne))return ne}return[]},[g,he,d,je,i]),k=s.useMemo(()=>{const r=x.slice(),l=ge||(g&&g.company!=="N/A"?g.company:"");return l&&!r.includes(l)?[l,...r]:r},[x,ge,g]);s.useMemo(()=>{const r=oe.slice(),l=te||(g&&g.platoon&&g.platoon!=="N/A"?g.platoon:"");return l&&!r.includes(l)?[l,...r]:r},[oe,te,g]);const $=s.useMemo(()=>{const r=c.slice(),l=F||(g&&g.rolePlatoon&&g.rolePlatoon!=="N/A"?g.rolePlatoon:"");return l&&!r.includes(l)?[l,...r]:r},[c,F,g]),ee=()=>{try{if(i){const r=i.uic,l={...d};l[r]=l[r]||{},l[r]._mcc=i.mcc||l[r]._mcc||"",l[r]._unitName=i.unitName||l[r]._unitName||"",N(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const se=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",se),B({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");B({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{B({type:"error",message:"Failed to persist unit structure."})}})()}else{const r=JSON.stringify(d);localStorage.setItem("unit_structure",r),(async()=>{try{if(navigator.sendBeacon){const E=new Blob([r],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",E),B({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:r,keepalive:!0})).ok)throw new Error("persist_failed");B({type:"success",message:"Unit structure saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{B({type:"error",message:"Failed to persist unit structure."})}})()}}catch{B({type:"error",message:"Failed to save unit structure."})}},U=()=>{try{if(!i)return;const r=i.uic,l={...d};l[r]=l[r]||{},l[r]._sections=S[r]||[],l[r]._mcc=i.mcc||l[r]._mcc||"",l[r]._unitName=i.unitName||l[r]._unitName||"",N(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const se=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",se),B({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");B({type:"success",message:"Unit sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{B({type:"error",message:"Failed to persist unit sections."})}})()}catch{B({type:"error",message:"Failed to save unit sections."})}},pe=()=>{try{if(!i)return;const r=i.uic,l={...d};l[r]=l[r]||{},l[r]._commandSections=I[r]||[],l[r]._mcc=i.mcc||l[r]._mcc||"",l[r]._unitName=i.unitName||l[r]._unitName||"",N(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const se=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",se),B({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");B({type:"success",message:"Command sections saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{B({type:"error",message:"Failed to persist command sections."})}})()}catch{B({type:"error",message:"Failed to save command sections."})}},ue=()=>{try{if(!i)return;const r=i.uic,l={...d};l[r]=l[r]||{},l[r]._platoonSectionMap=D[r]||{},l[r]._mcc=i.mcc||l[r]._mcc||"",l[r]._unitName=i.unitName||l[r]._unitName||"",N(l),localStorage.setItem("unit_structure",JSON.stringify(l)),(async()=>{try{if(navigator.sendBeacon){const se=new Blob([JSON.stringify(l)],{type:"application/json"});navigator.sendBeacon("/api/unit-structure/save",se),B({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}return}if(!(await fetch("/api/unit-structure/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0})).ok)throw new Error("persist_failed");B({type:"success",message:"Platoon-section links saved."});try{window.dispatchEvent(new CustomEvent("unit_structure_updated"))}catch{}}catch{B({type:"error",message:"Failed to persist links."})}})()}catch{B({type:"error",message:"Failed to save links."})}},xe=()=>{if(!i||!H.trim())return;const r=i.uic,l={...d};l[r]=l[r]||{},l[r][H.trim()]||(l[r][H.trim()]=[],N(l),V(H.trim()),O(""))},Oe=r=>{if(!i)return;const l=i.uic,E={...d};E[l]&&(delete E[l][r],N(E),v===r&&V(""))},be=()=>{if(!i||!v||!u.trim())return;const r=i.uic,l={...d};l[r]=l[r]||{},l[r][v]=l[r][v]||[],l[r][v].includes(u.trim())||(l[r][v]=[...l[r][v],u.trim()],N(l),K(""))},Pe=r=>{if(!i||!v)return;const l=i.uic,E={...d};E[l][v]=(E[l][v]||[]).filter(se=>se!==r),N(E)},De=()=>{if(!i||!T.trim())return;const r=i.uic,l={...S};l[r]=l[r]||[],l[r].includes(T.trim())||(l[r]=[...l[r],T.trim()],b(l),j(""))},_e=r=>{if(!i)return;const l=i.uic,E={...S};E[l]=(E[l]||[]).filter(se=>se!==r),b(E)},qe=()=>{if(!i||!L.trim())return;const r=i.uic,l={...I};l[r]=l[r]||[],l[r].includes(L.trim())||(l[r]=[...l[r],L.trim()],P(l),h(""))},it=r=>{if(!i)return;const l=i.uic,E={...I};E[l]=(E[l]||[]).filter(se=>se!==r),P(E)},ot=()=>{const r=["firstName","mi","lastName","email","edipi","service","rank","role","company","unit","unitUic"],l=_.map(ne=>[ne.firstName,ne.mi||"",ne.lastName,ne.email,ne.edipi,ne.service,ne.rank,ne.role,ne.company,ne.unit,ne.unitUic||""].map(Qt=>{const Je=String(Qt??"");return Je.includes(",")||Je.includes('"')||Je.includes(`
`)?'"'+Je.replace(/"/g,'""')+'"':Je}).join(",")),E="\uFEFF"+[r.join(","),...l].join(`
`),se=new Blob([E],{type:"text/csv;charset=utf-8"}),fe=URL.createObjectURL(se),ye=document.createElement("a");ye.href=fe,ye.download="users-export.csv",ye.click(),URL.revokeObjectURL(fe)};return e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"border-b bg-white",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{className:`px-4 py-2 rounded-t ${Ae==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>Le("unit"),children:"Unit Administration"}),e.jsx("button",{className:`px-4 py-2 rounded-t ${Ae==="users"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>Le("users"),children:"User Administration"})]})})}),Ae==="unit"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Unit Administration"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Unit"}),e.jsx("div",{className:"w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2",children:i?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.unitName}),e.jsxs("div",{className:"text-sm text-gray-500",children:["UIC: ",i.uic," | RUC: ",i.ruc]})]}):e.jsx("span",{className:"text-gray-500",children:"No unit assigned"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Companies"}),e.jsx("button",{type:"button",className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ee,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:H,onChange:r=>O(r.target.value),placeholder:"Add company",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"button",className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:xe,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Fe.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("button",{className:"text-left flex-1",onClick:()=>V(r),children:r}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Oe(r),children:"Remove"})]},r)),Fe.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No companies configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:["Platoons ",v?`• ${v}`:""]}),i&&v&&e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:ue,children:"Save Links"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:u,onChange:r=>K(r.target.value),placeholder:"Add platoon",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:!v}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",onClick:be,disabled:!v,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Ge.map(r=>{var l,E;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"mr-3",children:r})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{className:"px-2 py-1 border rounded",value:((E=(l=D[(i==null?void 0:i.uic)||""])==null?void 0:l[v])==null?void 0:E[r])||"",onChange:se=>{const fe=(i==null?void 0:i.uic)||"";z(ye=>{const ne={...ye};return ne[fe]=ne[fe]||{},ne[fe][v]=ne[fe][v]||{},ne[fe][v][r]=se.target.value,ne})},children:[e.jsx("option",{value:"",children:"Link to section"}),(S[(i==null?void 0:i.uic)||""]||[]).map(se=>e.jsx("option",{value:se,children:se},se))]}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>Pe(r),children:"Remove"})]})]},r)}),Ge.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No platoons configured"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Battalion Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:U,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:T,onChange:r=>j(r.target.value),placeholder:"Add section (e.g., S-1)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:De,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Qe.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:r}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>_e(r),children:"Remove"})]},r)),Qe.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No battalion sections configured"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Command Sections"}),e.jsx("button",{className:"text-sm px-2 py-1 bg-gray-100 rounded",onClick:pe,children:"Save"})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",value:L,onChange:r=>h(r.target.value),placeholder:"Add command section (e.g., SgtMaj, XO)",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:qe,children:"Add"})]}),e.jsxs("div",{className:"space-y-2",children:[Ne.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:r}),e.jsx("button",{className:"text-red-600 text-sm",onClick:()=>it(r),children:"Remove"})]},r)),Ne.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No command sections configured"})]})]})]})]}),Ae==="users"&&e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"User Administration"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"EDIPI"}),e.jsx("th",{className:"py-2 px-3",children:"Service"}),e.jsx("th",{className:"py-2 px-3",children:"Rank"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3",children:"Scope"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[_.filter(r=>{const l=!M||(r.email??"").toLowerCase().includes(M.toLowerCase())||(r.lastName??"").toLowerCase().includes(M.toLowerCase()),E=i?r.unitUic===i.uic||r.unit&&r.unit===i.unitName:!0;return l&&E}).map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[r.lastName,", ",r.firstName,r.mi?` ${r.mi}`:""]}),e.jsx("td",{className:"py-2 px-3",children:r.email}),e.jsx("td",{className:"py-2 px-3",children:r.edipi}),e.jsx("td",{className:"py-2 px-3",children:r.service}),e.jsx("td",{className:"py-2 px-3",children:r.rank}),e.jsx("td",{className:"py-2 px-3",children:r.role}),e.jsx("td",{className:"py-2 px-3",children:(()=>{const l=We.find(se=>se.uic===r.unitUic),E=l?l.unitName:r.unit;if(r.isUnitAdmin||r.role==="COMMANDER")return E||"—";if(r.role==="COMPANY_REVIEWER")return r.company&&r.company!=="N/A"?r.company:"—";if(r.role==="PLATOON_REVIEWER"){const se=r.company&&r.company!=="N/A"?r.company:"",fe=r.platoon&&r.platoon!=="N/A"?r.platoon:"",ye=[se,fe].filter(Boolean);return ye.length?ye.join(" / "):"—"}return"—"})()}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 text-xs bg-gray-100 rounded",onClick:()=>X(r),children:"View"}),((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsx("button",{className:"px-2 py-1 text-xs bg-purple-700 text-white rounded",onClick:()=>{Ee("admin"),Q(r),W(r.role??"MEMBER"),ve(r.company!=="N/A"?r.company:void 0),ae(r.company!=="N/A"?r.company:void 0),w(r.platoon&&r.platoon!=="N/A"?r.platoon:void 0),Y(r.platoon&&r.platoon!=="N/A"?r.platoon:void 0),$e(typeof r.commandOrder=="number"?String(r.commandOrder):""),ce(!!r.isUnitAdmin),ke(!!r.isCommandStaff)},children:"Admin Edit"}),e.jsx("button",{className:"px-2 py-1 text-xs bg-red-600 text-white rounded",onClick:()=>{m(l=>l.filter(E=>E.id!==r.id));try{localStorage.removeItem(`fs/users/${r.id}.json`)}catch(l){console.error("Failed to remove user from localStorage",l)}},children:"Delete"})]})})]},r.id)),_.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-3 px-3 text-gray-500",children:"No users"})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("input",{ref:f,type:"text",placeholder:"Filter users...",value:M,onChange:r=>G(r.target.value),className:"px-3 py-2 border rounded"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-lg",onClick:()=>{var r;return(r=f.current)==null?void 0:r.focus()},children:"Search"}),e.jsx("button",{className:"px-3 py-2 bg-gray-200 rounded",onClick:ot,children:"Export All"})]})]}),q&&e.jsx(zs,{user:q,onClose:()=>X(null)}),g&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:()=>Q(null),children:e.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Profile"}),e.jsx("button",{className:"text-gray-500",onClick:()=>Q(null),children:"✕"})]}),de==="profile"&&t&&g&&t.edipi===g.edipi&&e.jsx(Gt,{mode:"edit",initial:g,readOnly:!1,onSaved:r=>{m(l=>l.map(E=>E.edipi===r.edipi?r:E)),Q(null),B({type:"success",message:"Profile updated."})}}),de==="admin"&&((t==null?void 0:t.isUnitAdmin)||(t==null?void 0:t.role)==="COMMANDER")&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Administrative"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-role",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsx("select",{id:"admin-role","aria-label":"Role",value:Z,onChange:r=>{const l=r.target.value;W(l),l==="COMMANDER"&&(ve(void 0),w(void 0))},className:"w-full px-3 py-2 border rounded",children:Us.map(r=>e.jsx("option",{value:r,children:r},r))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-company",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Company (Reviewer Scope)"}),e.jsxs("select",{id:"admin-company",value:he||"",onChange:r=>y(r.target.value||void 0),disabled:!Z.includes("REVIEW"),className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:k.length?"Select company":"No companies configured"}),k.map(r=>e.jsx("option",{value:r,children:r},r))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"admin-platoon",className:"block text-sm font-medium text-gray-700 mb-1",children:"Role Platoon (Reviewer Scope)"}),e.jsxs("select",{id:"admin-platoon",value:F||"",onChange:r=>re(r.target.value||void 0),disabled:!Z.includes("REVIEW")||!he,className:"w-full px-3 py-2 border rounded disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:$.length?"Select platoon":"No platoons configured"}),$.map(r=>e.jsx("option",{value:r,children:r},r))]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-unit",type:"checkbox",checked:ie,onChange:r=>ce(r.target.checked)}),e.jsx("label",{htmlFor:"admin-is-unit",className:"text-sm text-gray-700",children:"Grant Unit Admin privileges"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"admin-is-command",type:"checkbox",checked:Re,disabled:Z==="COMMANDER",onChange:async r=>{const l=r.target.checked;ke(l);try{if(g&&!(await Ve({id:g.id,email:g.email,rank:g.rank,firstName:g.firstName,lastName:g.lastName,mi:g.mi,service:g.service,role:g.role,unitUic:g.unitUic,unit:g.unit,company:g.company,isUnitAdmin:!!g.isUnitAdmin,isCommandStaff:l,edipi:g.edipi,passwordHash:g.passwordHash})).ok)throw new Error("persist_failed")}catch{}}}),e.jsx("label",{htmlFor:"admin-is-command",className:"text-sm text-gray-700",children:"Allow access to Command Sections Dashboard"})]})]}),n.length>0&&e.jsx("div",{className:"mt-3 p-3 border border-red-200 bg-red-50 text-red-800 rounded",children:n.map((r,l)=>e.jsx("div",{className:"text-sm",children:r},l))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",onClick:()=>{Q(null),Me.current=!1,o([]),C(!1)},children:"Cancel"}),e.jsxs("button",{className:`px-4 py-2 rounded ${A?"bg-blue-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} text-white flex items-center gap-2`,"aria-busy":A,disabled:A,onClick:async()=>{var se;if(!g)return;const r=[];if(Z==="COMPANY_REVIEWER"&&!ge&&r.push("Company is required for Company Reviewer."),Z==="PLATOON_REVIEWER"&&(!ge||!we)&&r.push("Company and Platoon are required for Platoon Reviewer."),o(r),r.length)return;C(!0);const l=((se=We.find(fe=>fe.uic===g.unitUic))==null?void 0:se.unitName)||"N/A",E={...g,role:Z,isUnitAdmin:ie,isCommandStaff:Z==="COMMANDER"?!1:Re,company:J||"N/A",unit:l,platoon:te||"N/A",roleCompany:Z.includes("REVIEW")?he||"N/A":void 0,rolePlatoon:Z.includes("REVIEW")?F||"N/A":void 0};try{localStorage.setItem(`fs/users/${E.edipi}.json`,JSON.stringify(E))}catch{}try{if(!(await Ve({id:E.id,email:E.email,rank:E.rank,firstName:E.firstName,lastName:E.lastName,mi:E.mi,service:E.service,role:E.role,unitUic:E.unitUic,unit:E.unit,company:E.company,isUnitAdmin:!!E.isUnitAdmin,isCommandStaff:!!E.isCommandStaff,edipi:E.edipi,passwordHash:E.passwordHash,roleCompany:E.roleCompany,rolePlatoon:E.rolePlatoon,platoon:E.platoon})).ok)throw new Error("persist_failed")}catch{C(!1),B({type:"error",message:"Failed to save administrative changes."});return}m(fe=>fe.map(ye=>ye.edipi===E.edipi?E:ye));try{t&&t.edipi===E.edipi&&(localStorage.setItem("currentUser",JSON.stringify(E)),a(E))}catch{}Q(null),Me.current=!1,C(!1),B({type:"success",message:"Administrative changes saved."})},children:[A&&e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Save Changes"})]})]})]})]})}),R&&e.jsx("div",{className:`p-3 rounded-lg border ${R.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:R.message})]})};function Qs(){const[t,a]=s.useState([]),[i,p]=s.useState(null),[d,N]=s.useState({}),[S,b]=s.useState({}),[I,P]=s.useState([]),[D,z]=s.useState("unit"),[v,V]=s.useState("assigned"),[H,O]=s.useState([]),[u,K]=s.useState(""),[T,j]=s.useState([]),[L,h]=s.useState(""),_=()=>{Ue().then(n=>a(n)).catch(()=>a([]))},m=()=>{rt().then(n=>P(n)).catch(()=>P([]))},R=()=>{p(null),_(),m()};s.useEffect(()=>{R(),Tt().then(n=>O(n)),$t().then(n=>j(n))},[D,v]);const B=s.useMemo(()=>{const n={};for(const o of t)o.isUnitAdmin&&o.unitUic&&(n[o.unitUic]=o);return n},[t]),M=s.useMemo(()=>{const n={};for(const o of t)if(o.isInstallationAdmin&&o.installationId){const A=o.installationId;n[A]=n[A]||[],n[A].push(o)}return n},[t]),G=n=>t.filter(o=>o.unitUic===n.uic||!o.unitUic&&o.unit===n.unitName),f=async n=>{const o=d[n.uic];if(!o)return;const A=t.find(ie=>ie.id===o);if(!A)return;const C={...A,isUnitAdmin:!0,unitUic:n.uic,unit:n.unitName,company:"N/A"};try{if(!(await Ve({id:C.id,email:C.email,rank:C.rank,firstName:C.firstName,lastName:C.lastName,mi:C.mi,service:C.service,role:C.role,unitUic:C.unitUic,unit:C.unit,company:C.company,isUnitAdmin:!!C.isUnitAdmin,isInstallationAdmin:!!C.isInstallationAdmin,isCommandStaff:!!C.isCommandStaff,edipi:C.edipi})).ok){p({type:"error",message:"Failed to assign admin (DB error)."});return}}catch{}a(ie=>ie.map(ce=>ce.id===C.id?C:ce)),p({type:"success",message:`Assigned ${C.rank} ${C.lastName} as admin for ${n.unitName}.`})},g=s.useMemo(()=>We.filter(n=>!!B[n.uic]),[B]);s.useMemo(()=>(Array.isArray(t)?t:[]).filter(n=>!!n.isHqmcAdmin),[t]);const Q=s.useMemo(()=>We.filter(n=>!B[n.uic]),[B]),q=s.useMemo(()=>(Array.isArray(H)?H:[]).filter(n=>{var o;return(o=M[n.id])==null?void 0:o.length}),[H,M]),X=s.useMemo(()=>(Array.isArray(H)?H:[]).filter(n=>{var o;return!((o=M[n.id])!=null&&o.length)}),[H,M]),Z=s.useMemo(()=>{const n={};for(const o of Array.isArray(t)?t:[])if(o.isHqmcAdmin&&o.hqmcDivision){const A=o.hqmcDivision;n[A]=n[A]||[],n[A].push(o)}return n},[t]),W=s.useMemo(()=>(Array.isArray(T)?T:[]).filter(n=>{var o;return(o=Z[n.code])==null?void 0:o.length}),[T,Z]);s.useMemo(()=>{const n=["PLATOON_REVIEW","COMPANY_REVIEW","BATTALION_REVIEW","COMMANDER_REVIEW"];return(Array.isArray(I)?I:[]).filter(o=>n.includes(String(o.currentStage||"")))},[I]);const[ge,ve]=s.useState(1),[we,w]=s.useState(10),J=g.length,ae=Math.max(1,Math.ceil(J/(we||1))),te=Math.min(ge,ae),Y=J===0?0:(te-1)*we+1,he=J===0?0:Math.min(Y+we-1,J),y=g.slice((te-1)*we,(te-1)*we+we),[F,re]=s.useState(1),[le,me]=s.useState(10),je=Q.length,Se=Math.max(1,Math.ceil(je/(le||1))),Ce=Math.min(F,Se),$e=je===0?0:(Ce-1)*le+1,Ae=je===0?0:Math.min($e+le-1,je),Le=Q.slice((Ce-1)*le,(Ce-1)*le+le);return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"App Administration"}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${D==="unit"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{z("unit"),V("assigned")},children:"Unit Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${D==="installation"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{z("installation"),V("assigned")},children:"Installation Admin"}),e.jsx("button",{className:`px-4 py-2 rounded ${D==="hqmc"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>{z("hqmc"),V("assigned")},children:"HQMC Admin"})]}),e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx("button",{className:`px-4 py-2 rounded ${v==="assigned"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>V("assigned"),children:"Assigned"}),e.jsx("button",{className:`px-4 py-2 rounded ${v==="missing"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,onClick:()=>V("missing"),children:"Missing"})]}),D==="installation"&&v==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[q.map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:n.name}),e.jsx("td",{className:"py-2 px-3",children:(M[n.id]||[]).map(o=>`${o.rank} ${o.lastName}, ${o.firstName}${o.mi?` ${o.mi}`:""}`).join(" • ")})]},n.id)),q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No installations have admins assigned."})})]})]})})]}),D==="installation"&&v==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Installation Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Installation"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[X.map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:n.name}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:S[n.id]||"",onChange:o=>b(A=>({...A,[n.id]:o.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(o=>e.jsx("option",{value:o.id,children:`${o.rank} ${o.lastName}, ${o.firstName}${o.mi?` ${o.mi}`:""}`},o.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!S[n.id],onClick:async()=>{const o=S[n.id],A=t.find(ie=>ie.id===o);if(!A)return;const C={...A,isInstallationAdmin:!0,installationId:n.id};try{if(!(await Ve({id:C.id,email:C.email,rank:C.rank,firstName:C.firstName,lastName:C.lastName,mi:C.mi,service:C.service,role:C.role,unitUic:C.unitUic,unit:C.unit,company:C.company,isUnitAdmin:!!C.isUnitAdmin,isInstallationAdmin:!!C.isInstallationAdmin,isCommandStaff:!!C.isCommandStaff,edipi:C.edipi,installationId:C.installationId})).ok){p({type:"error",message:"Failed to assign installation admin (DB error)."});return}}catch{}a(ie=>ie.map(ce=>ce.id===C.id?C:ce)),p({type:"success",message:`Assigned ${C.rank} ${C.lastName} as installation admin.`})},children:"Assign"})})]},n.id)),X.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All installations have admins assigned."})})]})]})})]}),D==="unit"&&v==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin"})]})}),e.jsxs("tbody",{children:[y.map(n=>{const o=B[n.uic];return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:n.unitName}),e.jsx("td",{className:"py-2 px-3",children:n.uic}),e.jsx("td",{className:"py-2 px-3",children:`${o.rank} ${o.lastName}, ${o.firstName}${o.mi?` ${o.mi}`:""}`})]},n.uic)}),g.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"No units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(ht,{currentPage:te,totalPages:ae,totalItems:J,pageSize:we,startIndex:Y,endIndex:he,onPageChange:n=>ve(n),onPageSizeChange:n=>{w(n),ve(1)},onNext:()=>ve(Math.min(te+1,ae)),onPrevious:()=>ve(Math.max(te-1,1)),onFirst:()=>ve(1),onLast:()=>ve(ae),canGoNext:te<ae,canGoPrevious:te>1,pageSizeOptions:[5,10,25,50]})})]}),D==="unit"&&v==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Unit Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Unit"}),e.jsx("th",{className:"py-2 px-3",children:"UIC"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[Le.map(n=>{const o=G(n);return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:n.unitName}),e.jsx("td",{className:"py-2 px-3",children:n.uic}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:d[n.uic]||"",onChange:A=>N(C=>({...C,[n.uic]:A.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:o.length?"Select user":"No eligible users"}),o.map(A=>e.jsx("option",{value:A.id,children:`${A.rank} ${A.lastName}, ${A.firstName}${A.mi?` ${A.mi}`:""}`},A.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!d[n.uic],onClick:()=>f(n),children:"Assign"})})]},n.uic)}),Q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-3 px-3 text-gray-500",children:"All units have admins assigned."})})]})]})}),e.jsx("div",{className:"mt-4",children:e.jsx(ht,{currentPage:Ce,totalPages:Se,totalItems:je,pageSize:le,startIndex:$e,endIndex:Ae,onPageChange:n=>re(n),onPageSizeChange:n=>{me(n),re(1)},onNext:()=>re(Math.min(Ce+1,Se)),onPrevious:()=>re(Math.max(Ce-1,1)),onFirst:()=>re(1),onLast:()=>re(Se),canGoNext:Ce<Se,canGoPrevious:Ce>1,pageSizeOptions:[5,10,25,50]})})]}),D==="hqmc"&&v==="assigned"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Assigned"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Current Admin(s)"})]})}),e.jsxs("tbody",{children:[W.map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[n.code," — ",n.name]}),e.jsx("td",{className:"py-2 px-3",children:(Z[n.code]||[]).map(o=>`${o.rank} ${o.lastName}, ${o.firstName}${o.mi?` ${o.mi}`:""}`).join(" • ")})]},n.code)),W.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-3 px-3 text-gray-500",children:"No HQMC divisions have admins assigned."})})]})]})})]}),D==="hqmc"&&v==="missing"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"HQMC Admin Missing"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Division"}),e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Action"})]})}),e.jsxs("tbody",{children:[T.filter(n=>{var o;return!((o=Z[n.code])!=null&&o.length)}).map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"py-2 px-3",children:[n.code," — ",n.name]}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("select",{value:S[`hqmc_${n.code}`]||"",onChange:o=>b(A=>({...A,[`hqmc_${n.code}`]:o.target.value})),className:"px-2 py-1 border rounded",children:[e.jsx("option",{value:"",children:"Select user"}),t.map(o=>e.jsx("option",{value:o.id,children:`${o.rank} ${o.lastName}, ${o.firstName}${o.mi?` ${o.mi}`:""}`},o.id))]})}),e.jsx("td",{className:"py-2 px-3",children:e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50",disabled:!S[`hqmc_${n.code}`],onClick:async()=>{const o=S[`hqmc_${n.code}`],A=t.find(ie=>ie.id===o);if(!A)return;const C={...A,isHqmcAdmin:!0,hqmcDivision:n.code};try{if(!(await Ve({id:C.id,email:C.email,rank:C.rank,firstName:C.firstName,lastName:C.lastName,mi:C.mi,service:C.service,role:C.role,unitUic:C.unitUic,unit:C.unit,company:C.company,isUnitAdmin:!!C.isUnitAdmin,isInstallationAdmin:!!C.isInstallationAdmin,isCommandStaff:!!C.isCommandStaff,isHqmcAdmin:!!C.isHqmcAdmin,hqmcDivision:C.hqmcDivision,edipi:C.edipi})).ok){p({type:"error",message:"Failed to assign HQMC admin (DB error)."});return}}catch{}a(ie=>ie.map(ce=>ce.id===C.id?C:ce)),p({type:"success",message:`Assigned ${C.rank} ${C.lastName} as HQMC admin for ${n.code}.`})},children:"Assign"})})]},n.code)),T.filter(n=>{var o;return!((o=Z[n.code])!=null&&o.length)}).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-3 px-3 text-gray-500",children:"All HQMC divisions have admins assigned."})})]})]})})]}),i&&e.jsx("div",{className:`mt-4 p-3 rounded-lg border ${i.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:i.message})]})})}const Pt=!0,Js=({onLoggedIn:t,onCreateAccount:a})=>{const[i,p]=s.useState(""),[d,N]=s.useState(""),[S,b]=s.useState(null),[I,P]=s.useState(!0),[D,z]=s.useState(!0);Xt.useEffect(()=>{},[]);const v=async V=>{V.preventDefault(),b(null);try{const H=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,O=/^[0-9]{10}$/.test(i),u=Pt?H.test(i.trim().toLowerCase())||O:H.test(i.trim().toLowerCase()),K=d.length>=6;if(P(u),z(K),!u){b({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(!K){b({type:"error",message:"Password must be at least 6 characters."});return}let T=null,j=null,L=i.trim().toLowerCase();if(Pt&&O){const{user:G,error:f}=await xt(String(i));T=G,j=f,L=String((T==null?void 0:T.email)||"")}else if(H.test(L)){const{user:G,error:f}=await St(L);T=G,j=f}else{b({type:"error",message:"Enter a valid email or 10-digit EDIPI."});return}if(j){b({type:"error",message:`Database Error: ${j}`});return}if(!T||!L){b({type:"error",message:"Account not found."});return}const h=String(T.passwordHash||T.password_hash||"").trim();if(!h){b({type:"error",message:"No password set for this user."});return}const _=await bt(d);if(!(/^[0-9a-f]{64}$/i.test(h)?h.toLowerCase()===_.toLowerCase():h===d)){b({type:"error",message:"Invalid credentials."});return}const{user:B,error:M}=await St(L);if(M){b({type:"error",message:`Profile Error: ${M}`});return}if(!B){console.error("[Login] User profile not found after successful password verification",{emailForLogin:L}),b({type:"error",message:"User profile not found."});return}b({type:"success",message:"Logged in."}),t(B)}catch(H){console.error("[Login] Login failed:",H),b({type:"error",message:"Login failed."})}};return e.jsxs("div",{className:"max-w-md mx-auto bg-[var(--surface)] rounded-lg shadow-lg border border-brand-navy/20 p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Login"}),e.jsxs("form",{onSubmit:v,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email or EDIPI"}),e.jsx("input",{type:"text",value:i,onChange:V=>p(V.target.value),autoComplete:"username",className:`w-full px-3 py-2 border ${I?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!I}),!I&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Enter a valid email or 10-digit EDIPI."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{type:"password",value:d,onChange:V=>N(V.target.value),autoComplete:"current-password",className:`w-full px-3 py-2 border ${D?"border-gray-300":"border-red-500"} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500`,"aria-invalid":!D}),!D&&e.jsx("div",{className:"mt-1 text-xs text-red-600",children:"Password must be at least 6 characters."})]}),S&&e.jsx("div",{className:`p-3 rounded-lg border ${S.type==="success"?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:S.message}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("button",{type:"button",onClick:a,className:"text-blue-600 hover:underline",children:"Create Account"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",disabled:!I||!D,children:"Login"})]})]})]})},Ot=""+new URL("logo-DLcHofKE.png",import.meta.url).href,Ys=({currentUser:t,hasSectionDashboard:a,hasCommandDashboard:i,hasInstallationSectionDashboard:p=!1,hasInstallationCommandDashboard:d=!1,hasHQMCSectionDashboard:N=!1,hasHQMCApproverDashboard:S=!1,onManageProfile:b,onLogout:I,onNavigate:P,isLogin:D=!1})=>{const[z,v]=s.useState(!1),[V,H]=s.useState(!1),O=s.useRef(null);return s.useEffect(()=>{const u=T=>{if(!z)return;const j=O.current;j&&T.target&&!j.contains(T.target)&&v(!1)},K=T=>{T.key==="Escape"&&v(!1)};return document.addEventListener("mousedown",u),document.addEventListener("touchstart",u,{passive:!0}),document.addEventListener("keydown",K),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("touchstart",u),document.removeEventListener("keydown",K)}},[z]),e.jsx("header",{className:"bg-brand-navy text-brand-cream shadow-sm border-b border-brand-navy/20",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex flex-row items-center justify-between gap-2 md:gap-8 py-4 md:py-6",children:D?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold text-brand-cream",children:"Welcome to the Electronic Document Management System"}),e.jsx("p",{className:"text-white/80 mt-1",children:"Secure, hierarchical workflow for military document submissions and reviews."}),e.jsx("p",{className:"text-white/70 text-sm mt-1",children:"EDMS enforces chain-of-command with role-based access and a linear review state machine from Platoon to Battalion to Commander."})]})}),e.jsx("div",{className:"w-full flex items-center justify-center",children:e.jsx("img",{src:Ot,alt:"Semper Admin Logo",className:"w-full h-full max-h-40 md:max-h-56 object-contain"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 h-10 md:h-14 flex-1",children:[e.jsx("img",{src:Ot,alt:"Semper Admin Logo",className:"h-full w-auto rounded object-contain"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-sm lg:text-3xl font-semibold leading-tight text-brand-cream",children:[e.jsx("span",{className:"hidden lg:inline text-3xl lg:text-4xl",children:"Electronic Document Management System"}),e.jsx("span",{className:"lg:hidden text-sm",children:"EDMS"})]}),e.jsx("a",{className:"text-xs lg:text-sm font-normal text-red-500 block",href:"https://linktr.ee/semperadmin",children:"by Semper Admin"}),e.jsx("p",{className:"text-xs md:text-sm font-light text-white/70 mt-0.5 hidden md:block",children:"Marine Corps Unit Document Management"})]})]}),e.jsxs("div",{className:"flex flex-row items-center gap-1 md:gap-4 flex-shrink-0",children:[e.jsx("div",{className:"text-sm text-[var(--muted)] hidden md:block",children:t?e.jsxs("div",{className:"relative flex items-center gap-3 group",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-brand-cream",children:[t.rank," ",t.lastName,t.lastName?",":""," ",t.firstName,t.mi?` ${t.mi}`:""]}),e.jsxs("div",{className:"text-xs text-white/80",children:[t.service," • ",t.role,(()=>{const u={PLATOON_REVIEWER:t.role_platoon,COMPANY_REVIEWER:t.role_company}[t.role];return u?` - ${u}`:null})()]}),(()=>{var L;const u=((L=We.find(h=>h.uic===((t==null?void 0:t.unitUic)||"")))==null?void 0:L.unitName)||(t==null?void 0:t.unit)||"",K=t!=null&&t.company&&t.company!=="N/A"?t.company:t!=null&&t.user_company&&t.user_company!=="N/A"?t.user_company:null,T=t!=null&&t.platoon&&t.platoon!=="N/A"?t.platoon:t!=null&&t.user_platoon&&t.user_platoon!=="N/A"?t.user_platoon:null,j=[u||null,K,T].filter(Boolean);return j.length?e.jsx("div",{className:"text-xs text-white/70",children:j.join(" • ")}):null})()]}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none",children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg opacity-0 invisible translate-y-1 transition-all duration-150 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-focus-within:opacity-100 group-focus-within:visible group-focus-within:translate-y-0",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:b,children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream","aria-label":"Logout",onClick:I,children:"Logout"})]})]}):e.jsx("div",{className:"text-xs text-[var(--muted)]",children:"Not signed in"})}),t&&e.jsxs("div",{className:"md:hidden relative",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-brand-cream text-brand-navy flex items-center justify-center text-xs font-semibold border border-white/30 select-none cursor-pointer",onClick:()=>H(!V),children:`${(t.lastName||"").charAt(0)}${(t.firstName||"").charAt(0)}`.toUpperCase()}),V&&e.jsxs("div",{className:"absolute right-0 top-full mt-2 min-w-40 bg-white text-brand-navy border border-brand-navy/20 rounded-md shadow-lg z-50",children:[e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{b(),H(!1)},children:"Manage Profile"}),e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-brand-cream",onClick:()=>{I(),H(!1)},children:"Logout"})]})]}),!t&&e.jsx("button",{className:"bg-brand-charcoal text-brand-cream px-2 md:px-3 py-1 md:py-2 text-sm md:text-base rounded-lg hover:brightness-110 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>P("login"),children:"Login"}),e.jsxs("div",{className:"relative inline-block",ref:O,children:[e.jsx("button",{className:"bg-brand-red text-brand-cream px-4 py-3 md:px-4 md:py-3 text-sm md:text-base rounded hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold whitespace-nowrap min-h-[44px]","aria-haspopup":"menu","aria-expanded":z,onClick:()=>v(u=>!u),children:"Dashboards"}),e.jsxs("div",{className:`${z?"block":"hidden"} absolute right-0 mt-2 w-60 bg-white border-2 border-brand-red-2 rounded-lg shadow-xl text-brand-navy z-50`,role:"menu","aria-label":"Dashboards",children:[e.jsx("div",{className:"px-4 py-2 bg-brand-red text-brand-cream rounded-t-lg text-sm font-medium",children:"Dashboards"}),e.jsx("div",{role:"group","aria-label":"My",children:t&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("dashboard"),v(!1)},children:"My Requests"})}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Administration",children:[(t==null?void 0:t.isUnitAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("admin"),v(!1)},children:"Admin"}),t&&!!t.isAppAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("appadmin"),v(!1)},children:"App Admin"}),t&&!!t.isHqmcAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("hqmc-admin"),v(!1)},children:"HQMC Admin"}),t&&!!t.isInstallationAdmin&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("installation"),v(!1)},children:"Installation Admin"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Battalion & Command",children:[t&&a&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("section"),v(!1)},children:"Battalion Section Dashboard"}),i&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("command"),v(!1)},children:"Command Sections Dashboard"}),String((t==null?void 0:t.role)||"").includes("REVIEW")&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("review"),v(!1)},children:"Review Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"Installation",children:[t&&p&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("installation-section"),v(!1)},children:"Installation Section Dashboard"}),t&&d&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("installation-command"),v(!1)},children:"Installation Command Dashboard"})]}),e.jsx("div",{className:"my-2 border-t border-brand-navy/20"}),e.jsxs("div",{role:"group","aria-label":"HQMC",children:[t&&(N||!!t.isHqmcAdmin)&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("hqmc-section"),v(!1)},children:"HQMC Section Dashboard"}),t&&S&&e.jsx("button",{className:"w-full text-left px-4 py-3 text-sm hover:bg-brand-cream text-brand-navy min-h-[44px]",role:"menuitem",onClick:()=>{P("hqmc-approver"),v(!1)},children:"HQMC Approver Dashboard"})]})]})]})]})]})})})})};function Ks(){const[t,a]=s.useState(null),[i,p]=s.useState("login"),[d,N]=s.useState(()=>{try{const m=localStorage.getItem("currentUser");return m?JSON.parse(m):null}catch(m){return console.error("Failed to parse user from localStorage:",m),null}}),[S,b]=s.useState("create"),[I,P]=s.useState(!1),[D,z]=s.useState(!1),[v,V]=s.useState(!1),[H,O]=s.useState(!1),[u,K]=s.useState(!1),[T,j]=s.useState(!1),[L,h]=s.useState(!1),_=es();return s.useEffect(()=>{try{const R=new URLSearchParams(window.location.search).get("view");if(R==="admin"||R==="profile"||R==="dashboard"||R==="login"||R==="appadmin"||R==="hqmc-admin"||R==="hqmc-section"||R==="hqmc-approver"||R==="review"||R==="section"||R==="command"||R==="installation"||R==="installation-section"||R==="installation-command"||R==="documents"||R==="document-viewer"||R==="upload")p(R);else{const B=localStorage.getItem("currentView"),M=localStorage.getItem("currentUser");p(B&&M?B:"login")}}catch{p("login")}},[]),s.useEffect(()=>{d?localStorage.setItem("currentUser",JSON.stringify(d)):(localStorage.removeItem("currentUser"),localStorage.removeItem("currentView"))},[d]),s.useEffect(()=>{let m=!1;return(async()=>{try{const R=(d==null?void 0:d.id)||"";if(!R)return;const B=await _t(R);B&&!m&&(N(B),localStorage.setItem("currentUser",JSON.stringify(B)))}catch{}})(),()=>{m=!0}},[]),s.useEffect(()=>{i!=="login"&&d&&localStorage.setItem("currentView",i)},[i,d]),s.useEffect(()=>{(async()=>{try{if(localStorage.getItem("unit_structure"))return;const R=await jt();localStorage.setItem("unit_structure",JSON.stringify(R))}catch(m){console.error("Failed to load unit structure:",m)}})()},[]),s.useEffect(()=>{var R,B,M;try{const G=localStorage.getItem("unit_structure");if(!d||!G){z(!1);return}const f=JSON.parse(G),g=(d==null?void 0:d.unitUic)||"",Q=d!=null&&d.company&&d.company!=="N/A"?d.company:"",q=d!=null&&d.platoon&&d.platoon!=="N/A"?d.platoon:"",X=((M=(B=(R=f==null?void 0:f[g])==null?void 0:R._platoonSectionMap)==null?void 0:B[Q])==null?void 0:M[q])||"";z(!!X)}catch(G){console.error("Failed to parse unit structure for section dashboard check",G),z(!1)}const m=d==null?void 0:d.isCommandStaff;V(!!m),(async()=>{try{const G=(d==null?void 0:d.installationId)||"";if(!G){O(!1),K(!1);return}const f=await Tt();try{localStorage.setItem("installations_cache",JSON.stringify(f))}catch{}const g=f==null?void 0:f.find(Z=>Z.id===G),Q=(d==null?void 0:d.id)||"",q=!!(g&&g.sectionAssignments&&Object.values(g.sectionAssignments).some(Z=>Array.isArray(Z)&&Z.includes(Q))),X=!!(g&&(g.commandSectionAssignments&&Object.values(g.commandSectionAssignments).some(Z=>Array.isArray(Z)&&Z.includes(Q))||g.commanderUserId&&String(g.commanderUserId)===Q));O(q),K(X)}catch{O(!1),K(!1)}})(),(async()=>{try{const G=String((d==null?void 0:d.hqmcDivision)||""),f=String((d==null?void 0:d.id)||"");if(!G||!f){j(!!(d!=null&&d.isHqmcAdmin));return}const{listHQMCSectionAssignmentsLegacy:g}=await ts(async()=>{const{listHQMCSectionAssignmentsLegacy:Z}=await import("./db-LFYbNZmQ.js").then(W=>W.z);return{listHQMCSectionAssignmentsLegacy:Z}},__vite__mapDeps([0,1,2]),import.meta.url),Q=await g(),q=Q.some(Z=>Z.division_code===G&&((Z.reviewers||[]).includes(f)||(Z.approvers||[]).includes(f)));j(q||!!(d!=null&&d.isHqmcAdmin));const X=Q.some(Z=>Z.division_code===G&&(Z.approvers||[]).includes(f));h(X)}catch{j(!!(d!=null&&d.isHqmcAdmin))}})()},[d]),e.jsxs("div",{className:"min-h-screen bg-[var(--bg)]",children:[e.jsx(Ys,{currentUser:d,hasSectionDashboard:D,hasCommandDashboard:v,hasInstallationSectionDashboard:H,hasInstallationCommandDashboard:u,hasHQMCSectionDashboard:T,hasHQMCApproverDashboard:L,onManageProfile:()=>{b("edit"),p("profile"),_("/?view=profile")},onLogout:()=>{N(null),p("login"),_("/?view=login")},onNavigate:m=>{p(m),_(`/?view=${m}`)},isLogin:i==="login"}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:i==="profile"?e.jsx(Gt,{mode:S,initial:S==="edit"?d||{}:{},onSaved:m=>{N(m),p("dashboard"),_("/?view=dashboard")}}):i==="admin"?e.jsx(Gs,{}):i==="appadmin"?e.jsx(Qs,{}):i==="login"?e.jsx(Js,{onLoggedIn:m=>{N(m),p("dashboard"),_("/?view=dashboard")},onCreateAccount:()=>{b("create"),p("profile"),_("/?view=profile")}}):i==="review"?e.jsx(Ps,{}):i==="section"?e.jsx(ms,{}):i==="command"?e.jsx(us,{}):i==="installation"?e.jsx(cs,{}):i==="hqmc-admin"?e.jsx(Ls,{}):i==="installation-section"?e.jsx(xs,{}):i==="installation-command"?e.jsx(ps,{}):i==="hqmc-section"?e.jsx(Ts,{}):i==="hqmc-approver"?e.jsx(Ws,{}):e.jsx(Ss,{selectedUnit:t,currentUser:d})})]})}function ca(){return e.jsx(Ks,{})}export{ca as default};
