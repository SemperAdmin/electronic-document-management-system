import{r as c,R as xe,u as be,j as n}from"./index-Cumadnec.js";import{c as ve,l as pe,w as ge,e as he,f as ye,u as C}from"./db-DQjs2vLx.js";import{R as T}from"./RequestTable-B-Ue682G.js";import{a as fe,D as Se}from"./DocumentListItem-DV1yJlB1.js";import{f as I}from"./utils-CLmukD0c.js";function De(){const[l,Y]=c.useState(null),[p,b]=c.useState([]),[A,D]=c.useState({}),[m,O]=c.useState(null),[F,P]=c.useState([]),[w,q]=c.useState("Pending"),[Z,$]=c.useState([]),[v,g]=c.useState({}),[u,k]=c.useState({}),[x,U]=c.useState({}),[h,_]=c.useState({}),[je,M]=c.useState(null),V=xe.useRef(null),[Ne,ee]=c.useState({}),[W,te]=c.useState({}),[L,B]=c.useState({}),[y,z]=c.useState(null),f=be();c.useEffect(()=>{try{const e=localStorage.getItem("currentUser");e&&Y(JSON.parse(e))}catch{}},[]),c.useEffect(()=>{ve().then(e=>b(e)).catch(()=>b([])),pe().then(e=>$(e)).catch(()=>$([]))},[]),c.useEffect(()=>{l!=null&&l.installationId&&(ge().then(e=>{const t=e.find(a=>a.id===l.installationId);O(t||null)}).catch(()=>O(null)),he().then(e=>P(e)).catch(()=>P([])))},[l]);const R=c.useMemo(()=>{const e={};for(const t of F)e[t.id]=t;return e},[F]),j=e=>Z.filter(t=>String(t.requestId||"")===String(e)),ne=e=>R[e.uploadedById],ae=e=>`"${String(e??"").replace(/"/g,'""')}"`,H=e=>{const a=[["Request ID","Subject","Stage","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const o of e){const s=ne(o),d=s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}${s.mi?` ${s.mi}`:""}`.trim():"",i=j(o.id).map(r=>r.name).join(" | ");a.push([o.id,o.subject,o.currentStage||"",o.routeSection||"",d,o.unitUic||"",new Date(o.createdAt).toLocaleString(),i])}return a.map(o=>o.map(ae).join(",")).join(`\r
`)},J=(e,t)=>{const a=new Blob([t],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(a),s=document.createElement("a");s.href=o,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o)},oe=()=>J("installation_commander.csv",H(Q)),ie=e=>J(`installation_${e}.csv`,H(K[e]||[])),G=async e=>{const t=u[e.id]||[];if(!t.length)return;const a=(l==null?void 0:l.id)||"",o=e.unitUic||"",s=t.map(i=>({id:`doc-${Date.now()}-${Math.random().toString(16).slice(2)}`,name:i.name,type:i.type||"application/octet-stream",size:i.size,uploadedAt:new Date,category:"ATTACHMENT",tags:[],unitUic:o,subject:e.subject,notes:v[e.id]||void 0,uploadedById:a,currentStage:e.currentStage,requestId:e.id,fileUrl:void 0})),{ok:d}=await ye(s);d?($(i=>[...s,...i]),k(i=>({...i,[e.id]:[]}))):f.error("Failed to save files")},se=async e=>{const t=I(l,"Installation Command Section"),a=e.routeSection||"",o={actor:t,timestamp:new Date().toISOString(),action:"Sent to Installation Commander",comment:(v[e.id]||"").trim(),fromSection:a||void 0,toSection:"Commander"},s={...e,routeSection:"",activity:[...e.activity||[],o]};try{await C(s),b(d=>d.map(i=>i.id===e.id?s:i)),g(d=>({...d,[e.id]:""}))}catch(d){console.error("Failed to send to installation commander:",d),f.error("Failed to send to installation commander")}},de=async e=>{const t=I(l,"Installation Command Section"),a=(e.activity||[]).slice().reverse().find(i=>/Routed to installation command section/i.test(String(i.action||"")));let o="";if(a){const i=String(a.action||"").match(/\(from\s+(.+?)\)/i);i&&(o=i[1])}const s={actor:t,timestamp:new Date().toISOString(),action:`Returned to installation section${o?`: ${o}`:""}`,comment:(v[e.id]||"").trim(),fromSection:e.routeSection||void 0,toSection:o||void 0},d={...e,routeSection:o,activity:[...e.activity||[],s]};try{await C(d),b(i=>i.map(r=>r.id===e.id?d:r)),g(i=>({...i,[e.id]:""}))}catch(i){console.error("Failed to return to installation section:",i),f.error("Failed to return to installation section")}},E=async(e,t)=>{const a=I(l,"Installation Commander"),o=t==="Approved"?"Approved by Installation Commander":t==="Endorsed"?"Endorsed by Installation Commander":"Rejected by Installation Commander — requires action",s=me(e);let d={...e};const i={actor:a,actorRole:"Installation Commander",timestamp:new Date().toISOString(),action:o,comment:(v[e.id]||"").trim(),fromSection:"Commander",toSection:s||void 0};if(t==="Rejected")d={...e,currentStage:"INSTALLATION_REVIEW",finalStatus:void 0,routeSection:s,activity:[...e.activity||[],i,{actor:a,actorRole:"Installation Commander",timestamp:new Date().toISOString(),action:s?`Returned to installation section: ${s}`:"Returned for review",fromSection:"Commander",toSection:s||void 0}]};else if(t==="Approved"){const r=s;d={...e,currentStage:"INSTALLATION_REVIEW",routeSection:r,activity:[...e.activity||[],i,{actor:a,actorRole:"Installation Commander",timestamp:new Date().toISOString(),action:r?`Sent to installation section: ${r}`:"Sent for further routing",fromSection:"Commander",toSection:r||void 0}]}}else d={...e,currentStage:"INSTALLATION_REVIEW",routeSection:s,activity:[...e.activity||[],i,{actor:a,actorRole:"Installation Commander",timestamp:new Date().toISOString(),action:s?`Sent to installation section: ${s}`:"Sent for further routing",fromSection:"Commander",toSection:s||void 0}]};try{await C(d),b(r=>r.map(X=>X.id===e.id?d:X)),g(r=>({...r,[e.id]:""})),ee(r=>({...r,[e.id]:""}))}catch(r){console.error("Failed to record installation commander decision:",r),f.error("Failed to record decision")}},ce=async e=>{const t=L[e.id]||"";if(!t.trim())return;const a=I(l,"Installation Command Section"),o=e.routeSection||"",s={actor:a,actorRole:"Installation Command Section",timestamp:new Date().toISOString(),action:`Reassigned to command section: ${t}${o?` (from ${o})`:""}`,comment:(v[e.id]||"").trim(),fromSection:o||void 0,toSection:t},d={...e,routeSection:t,activity:[...e.activity||[],s]};try{await C(d),b(i=>i.map(r=>r.id===e.id?d:r)),g(i=>({...i,[e.id]:""})),B(i=>({...i,[e.id]:""}))}catch(i){console.error("Failed to reassign to command section:",i),f.error("Failed to reassign to command section")}},N=c.useMemo(()=>Array.isArray(m==null?void 0:m.commandSections)?m.commandSections:[],[m]),S=(l==null?void 0:l.installationId)||"",K=c.useMemo(()=>{const e={},t=p.filter(a=>a.currentStage==="INSTALLATION_REVIEW"&&a.installationId===S);for(const a of N)e[a]=[];for(const a of t){const o=String(a.routeSection||"");o&&e.hasOwnProperty(o)&&e[o].push(a)}return e},[p,N,S]),Q=c.useMemo(()=>p.filter(e=>e.currentStage==="INSTALLATION_REVIEW"&&e.installationId===S&&(!e.routeSection||e.routeSection==="")),[p,S]),re=c.useMemo(()=>p.filter(e=>e.installationId===S&&e.currentStage!=="INSTALLATION_REVIEW"),[p,S]),le=e=>{const t=(e.activity||[]).slice().reverse();for(const a of t){const o=String(a.action||""),s=o.match(/Sent to installation section:\s*(.+)/i)||o.match(/Restored to installation section:\s*(.+)/i)||o.match(/Returned to installation section:\s*(.+)/i);if(s)return s[1].trim()}return""},me=e=>{const t=(e.activity||[]).slice().reverse();for(const a of t){const o=String(a.action||""),s=o.match(/Approved and routed to Installation Command:[^(]+\(from\s+([^)]+)\)/i);if(s)return s[1].trim();const d=o.match(/Reassigned to installation section:\s*([^\(]+)/i);if(d)return d[1].trim();const i=o.match(/Sent to command section:[^(]+\(from\s+([^)]+)\)/i);if(i)return i[1].trim()}for(const a of t){const o=String(a.action||""),s=o.match(/Routed to installation section:\s*(.+)/i);if(s)return s[1].trim();const d=o.match(/Sent to installation section:\s*(.+)/i);if(d)return d[1].trim();const i=o.match(/Restored to installation section:\s*(.+)/i);if(i)return i[1].trim()}return""},ue=async(e,t)=>{const a=I(l,"Installation Commander"),o=(t||"").trim()||le(e),s={actor:a,timestamp:new Date().toISOString(),action:`Restored to installation section${o?`: ${o}`:""}`},d={...e,currentStage:"INSTALLATION_REVIEW",finalStatus:void 0,routeSection:o,activity:[...e.activity||[],s]};try{await C(d),b(i=>i.map(r=>r.id===e.id?d:r))}catch(i){console.error("Failed to restore to installation section:",i),f.error("Failed to restore to installation section")}};return n.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[n.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Installation Command Dashboard"}),n.jsx("div",{className:"text-sm text-[var(--muted)]",children:(m==null?void 0:m.name)||""})]}),n.jsx("div",{className:"border-b border-gray-200 mb-4",children:n.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[n.jsx("button",{onClick:()=>q("Pending"),className:`${w==="Pending"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),n.jsx("button",{onClick:()=>q("Previously in Command Section"),className:`${w==="Previously in Command Section"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Previously in Command Section"})]})}),w==="Pending"&&n.jsxs("div",{className:"space-y-8",children:[n.jsx("div",{children:n.jsx(T,{title:"Pending in Commander",titleActions:n.jsx(n.Fragment,{children:n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:oe,children:"Export Commander"})}),requests:Q,users:R,variant:"installation",onRowClick:e=>D(t=>({...t,[e.id]:!t[e.id]})),expandedRows:A,children:e=>n.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[n.jsx("div",{className:"mt-2",children:n.jsx("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!x[e.id],"aria-controls":`docs-instcmd-comm-${e.id}`,onClick:()=>{U(t=>({...t,[e.id]:!t[e.id]})),M(t=>x[e.id]?null:e.id)},children:n.jsx("span",{children:"Show Documents"})})}),n.jsx("div",{id:`docs-instcmd-comm-${e.id}`,ref:x[e.id]?V:void 0,className:`${x[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:n.jsx(fe,{documents:j(e.id),showIcons:!0,onPreview:t=>z(j(e.id).find(a=>a.id===t.id)||null)})}),n.jsxs("div",{className:"mt-2",children:[n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>_(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!h[e.id],"aria-controls":`logs-instcmd-comm-${e.id}`,children:[h[e.id]?"Hide":"Show"," Activity Log"]}),n.jsx("div",{id:`logs-instcmd-comm-${e.id}`,className:h[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,a)=>n.jsxs("div",{className:"text-xs text-gray-700",children:[n.jsxs("div",{className:"font-medium",children:[t.actor," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&n.jsx("div",{className:"text-gray-600",children:t.comment})]},a)):n.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),n.jsxs("div",{className:"mt-2",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),n.jsx("textarea",{rows:2,value:v[e.id]||"",onChange:t=>g(a=>({...a,[e.id]:t.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),n.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[n.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[n.jsx("input",{type:"file",multiple:!0,onChange:t=>k(a=>({...a,[e.id]:t.target.files?Array.from(t.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),n.jsx("span",{className:"text-xs text-[var(--muted)]",children:(u[e.id]||[]).length?`${(u[e.id]||[]).length} file(s) selected`:"No files selected"}),n.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>G(e),disabled:!u[e.id]||!(u[e.id]||[]).length,children:"Save Files"})]}),n.jsx("div",{className:"mt-3"}),n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Final Decision"}),n.jsxs("div",{className:"flex items-center justify-end gap-2",children:[n.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>E(e,"Approved"),children:"Approved"}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>E(e,"Endorsed"),children:"Endorsed"}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>E(e,"Rejected"),children:"Rejected"})]})]})]})})}),N.map(e=>n.jsxs("div",{children:[n.jsx("div",{className:"flex items-center justify-between mb-3",children:n.jsxs("h3",{className:"text-lg font-semibold text-[var(--text)] flex items-center justify-between w-full",children:[e,n.jsx("span",{className:"inline-flex items-center gap-2 align-middle",children:n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:()=>ie(e),children:["Export ",e]})})]})}),n.jsx(T,{title:`Pending in ${e}`,requests:K[e]||[],users:R,variant:"installation",onRowClick:t=>D(a=>({...a,[t.id]:!a[t.id]})),expandedRows:A,children:t=>n.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[n.jsx("div",{className:"mt-2",children:n.jsx("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!x[t.id],"aria-controls":`docs-instcmd-${t.id}`,onClick:()=>{U(a=>({...a,[t.id]:!a[t.id]})),M(a=>x[t.id]?null:t.id)},children:n.jsx("span",{children:"Show Documents"})})}),n.jsxs("div",{id:`docs-instcmd-${t.id}`,ref:x[t.id]?V:void 0,className:`${x[t.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[j(t.id).map(a=>n.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[n.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[n.jsx("div",{className:"font-medium text-[var(--text)]",children:a.name}),n.jsx("div",{children:new Date(a.uploadedAt).toLocaleDateString()})]}),n.jsx("div",{className:"flex items-center gap-2",children:a.fileUrl?n.jsx("a",{href:a.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",children:"Open"}):n.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},a.id)),j(t.id).length===0&&n.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),n.jsxs("div",{className:"mt-2",children:[n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>_(a=>({...a,[t.id]:!a[t.id]})),"aria-expanded":!!h[t.id],"aria-controls":`logs-instcmd-${t.id}`,children:[h[t.id]?"Hide":"Show"," Activity Log"]}),n.jsx("div",{id:`logs-instcmd-${t.id}`,className:h[t.id]?"mt-2 space-y-2":"hidden",children:t.activity&&t.activity.length?t.activity.map((a,o)=>n.jsxs("div",{className:"text-xs text-gray-700",children:[n.jsxs("div",{className:"font-medium",children:[a.actor," • ",new Date(a.timestamp).toLocaleString()," • ",a.action]}),a.comment&&n.jsx("div",{className:"text-gray-600",children:a.comment})]},o)):n.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),n.jsxs("div",{className:"mt-2",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),n.jsx("textarea",{rows:2,value:v[t.id]||"",onChange:a=>g(o=>({...o,[t.id]:a.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),N.filter(a=>a!==e).length>0&&n.jsxs("div",{className:"mt-3 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Reassign to Another Command Section"}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg flex-1",value:L[t.id]||"",onChange:a=>B(o=>({...o,[t.id]:a.target.value})),children:[n.jsx("option",{value:"",children:"Select command section"}),N.filter(a=>a!==e).map(a=>n.jsx("option",{value:a,children:a},a))]}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>ce(t),disabled:!(L[t.id]||"").trim(),children:"Reassign"})]})]}),n.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[n.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[n.jsx("input",{type:"file",multiple:!0,onChange:a=>k(o=>({...o,[t.id]:a.target.files?Array.from(a.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),n.jsx("span",{className:"text-xs text-[var(--muted)]",children:(u[t.id]||[]).length?`${(u[t.id]||[]).length} file(s) selected`:"No files selected"}),n.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>G(t),disabled:!u[t.id]||!(u[t.id]||[]).length,children:"Save Files"})]}),n.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[n.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>se(t),children:"Send to Commander"}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>de(t),children:"Return to Section"})]})]})})]},e))]}),w==="Previously in Command Section"&&n.jsx(T,{title:"Previously in Command Section",requests:re,users:R,variant:"installation",onRowClick:e=>D(t=>({...t,[e.id]:!t[e.id]})),expandedRows:A,children:e=>n.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[n.jsxs("div",{className:"text-xs text-gray-600",children:["Last Status: ",new Date(e.activity&&e.activity.length?e.activity[e.activity.length-1].timestamp:e.createdAt).toLocaleString()]}),n.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg",value:W[e.id]||"",onChange:t=>te(a=>({...a,[e.id]:t.target.value})),children:[n.jsx("option",{value:"",children:"Select installation section"}),((m==null?void 0:m.sections)||[]).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>ue(e,W[e.id]),children:"Restore to Section"})]})]})})]}),y&&n.jsx(Se,{fileName:y.name,url:y.fileUrl||"",mimeType:y.type||"",fileSize:y.size||0,isOpen:!!y,onClose:()=>z(null)})]})}export{De as default};
