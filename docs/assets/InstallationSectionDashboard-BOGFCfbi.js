import{r as o,j as n,R as Pe,u as _e}from"./index-CGPtqgcS.js";import{w as ve,e as Se,y as He,c as qe,l as Be,k as Qe,p as Ve,f as We,u as A}from"./db-DABDFbdk.js";import{S as ze}from"./SearchableUnitSelector-BU3C-ndi.js";import{R as ge,b as Je}from"./RequestTable-Dld-QJBa.js";import{a as Ke,D as Xe}from"./DocumentListItem-DgwsfMll.js";import{f as R}from"./utils-CLmukD0c.js";import"./units-CaNgy_2U.js";const Ye=({currentUser:c,onClose:F})=>{const[x,g]=o.useState(null),[I,M]=o.useState([]),[l,P]=o.useState(""),[N,U]=o.useState(""),[k,$]=o.useState(!1),[_,E]=o.useState("");o.useEffect(()=>{ve().then(a=>{const m=a.find(j=>String(j.id)===String(c.installationId||""));g(m||null)}).catch(()=>g(null)),Se().then(a=>M(a)).catch(()=>M([]))},[]);const v=o.useMemo(()=>(x==null?void 0:x.sections)||[],[x]),h=o.useMemo(()=>(x==null?void 0:x.sectionAssignments)||{},[x]),C=String(c.id||""),y=o.useMemo(()=>{if(!x||!l)return!1;if(c.isInstallationAdmin)return!0;const a=h[l]||[];return Array.isArray(a)&&a.includes(C)},[x,l,h,C,c]),f=o.useMemo(()=>I.reduce((a,m)=>({...a,[m.id]:m}),{}),[I]),T=o.useMemo(()=>l?(h[l]||[]).map(m=>f[m]).filter(Boolean):[],[h,l,f]),w=o.useMemo(()=>{const a=Array.isArray(x==null?void 0:x.unitUics)?x.unitUics.map(String):[];return I.filter(m=>{if(m.id===c.id)return!1;const j=String(m.unitUic||"");return a.includes(j)})},[I,x,c]),O=async a=>{if(x){$(!0),E("");try{const m={...x,sectionAssignments:a};if(!(await He(m)).ok)throw new Error("persist_failed");g(m);try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:c.id,scope:{installationId:x.id,section:l},timestamp:new Date().toISOString(),event:"installation_section_assignments_updated"})})}catch{}}catch{E("Failed to persist installation assignments")}finally{$(!1)}}},ee=async()=>{if(!y||!l||!N)return;const a={...h},m=Array.isArray(a[l])?a[l]:[];m.includes(N)||m.push(N),a[l]=m,await O(a),U("")},H=async a=>{if(!y||!l||!a)return;const m={...h},j=Array.isArray(m[l])?m[l]:[];m[l]=j.filter(q=>q!==a),await O(m)};return n.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:F,children:n.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:a=>a.stopPropagation(),children:[n.jsxs("div",{className:"flex justify-between items-center mb-4",children:[n.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Installation Section Access"}),n.jsx("button",{className:"text-gray-500",onClick:F,children:"✕"})]}),n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),n.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:l,onChange:a=>P(a.target.value),children:[n.jsx("option",{value:"",children:"Select section"}),v.map(a=>n.jsx("option",{value:a,children:a},a))]})]}),l&&!y&&n.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You do not have permission to manage this section. Only installation admins or assigned section members can manage access."}),l&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User to Section"}),n.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:N,onChange:a=>U(a.target.value),disabled:!y,children:[n.jsx("option",{value:"",children:"Choose user"}),w.map(a=>n.jsxs("option",{value:a.id,children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""," • ",a.email]},a.id))]}),n.jsx("div",{className:"mt-2 flex justify-end",children:n.jsx("button",{className:"px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!y||!N||k,onClick:ee,children:"Add"})})]}),n.jsxs("div",{className:"mt-4",children:[n.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Members"}),n.jsxs("div",{className:"space-y-2",children:[T.map(a=>n.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[n.jsxs("div",{className:"text-sm text-gray-700",children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""," • ",a.email]}),n.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!y||k,onClick:()=>H(a.id),children:"Remove"})]},a.id)),T.length===0&&n.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]}),_&&n.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:_})]})]})]})})};function ct(){const[c,F]=o.useState(null),[x,g]=o.useState([]),[I,M]=o.useState({}),[l,P]=o.useState(null),[N,U]=o.useState([]),[k,$]=o.useState({}),[_,E]=o.useState([]),[v,h]=o.useState({}),[C,y]=o.useState({}),[f,T]=o.useState({}),[w,O]=o.useState({}),[ee,H]=o.useState(null),a=Pe.useRef(null),[m,j]=o.useState("Pending"),[q,ye]=o.useState({}),[V,te]=o.useState({}),[Ge,Ze]=o.useState({}),[W,z]=o.useState({}),[ne,J]=o.useState({}),[se,ie]=o.useState({}),[ae,B]=o.useState({}),[fe,oe]=o.useState([]),[je,ce]=o.useState([]),[L,de]=o.useState({}),[K,X]=o.useState({}),[Ne,re]=o.useState(!1),[D,le]=o.useState(null),[Y,me]=o.useState({}),S=_e();o.useEffect(()=>{try{const e=localStorage.getItem("currentUser");e&&F(JSON.parse(e))}catch{}},[]),o.useEffect(()=>{qe().then(e=>g(e)).catch(()=>g([])),Be().then(e=>E(e)).catch(()=>E([]))},[]),o.useEffect(()=>{c!=null&&c.installationId&&(ve().then(e=>{const t=e.find(s=>s.id===c.installationId);P(t||null)}).catch(()=>P(null)),Se().then(e=>U(e)).catch(()=>U([])))},[c]),o.useEffect(()=>{Qe().then(oe).catch(()=>oe([])),Ve().then(ce).catch(()=>ce([]))},[]);const G=o.useMemo(()=>{const e={};for(const t of N)e[t.id]=t;return e},[N]),Z=e=>_.filter(t=>String(t.requestId||"")===String(e)),we=e=>G[e.uploadedById],Ie=e=>{const t=we(e);return t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}${t.mi?` ${t.mi}`:""}`.trim():""},Ce=e=>`"${String(e??"").replace(/"/g,'""')}"`,ue=e=>{const s=[["Request ID","Subject","Stage","Installation Section","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const d of e){const i=Z(d.id).map(u=>u.name).join(" | ");s.push([d.id,d.subject,d.currentStage||"",d.routeSection||"",d.routeSection||"",Ie(d),d.unitUic||"",new Date(d.createdAt).toLocaleString(),i])}return s.map(d=>d.map(Ce).join(",")).join(`\r
`)},xe=(e,t)=>{const s=new Blob([t],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(s),i=document.createElement("a");i.href=d,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(d)},Ae=()=>xe("installation_section_pending.csv",ue(be)),Re=()=>xe("installation_section_previous.csv",ue(pe)),ke=async e=>{const t=C[e.id]||[];if(!t.length)return;const s=(c==null?void 0:c.id)||"",d=e.unitUic||"",i=t.map(r=>({id:`doc-${Date.now()}-${Math.random().toString(16).slice(2)}`,name:r.name,type:r.type||"application/octet-stream",size:r.size,uploadedAt:new Date,category:"ATTACHMENT",tags:[],unitUic:d,subject:e.subject,notes:v[e.id]||void 0,uploadedById:s,currentStage:e.currentStage,requestId:e.id,fileUrl:void 0})),{ok:u}=await We(i);u?(E(r=>[...i,...r]),y(r=>({...r,[e.id]:[]}))):S.error("Failed to save files")},Q=o.useMemo(()=>{if(!l||!(c!=null&&c.id))return[];const e=l.sectionAssignments||{};return Object.entries(e).filter(([,s])=>Array.isArray(s)&&s.includes(c.id)).map(([s])=>String(s))},[l,c]),Ee=o.useMemo(()=>{if(!l||!(c!=null&&c.id))return!1;if(c.isInstallationAdmin)return!0;const e=l.sectionAssignments||{};return Object.values(e).some(t=>Array.isArray(t)&&t.includes(c.id))},[l,c]),be=o.useMemo(()=>{const e=(c==null?void 0:c.installationId)||"",t=new Set(Q.map(s=>s.toUpperCase()));return x.filter(s=>s.currentStage==="INSTALLATION_REVIEW"&&s.installationId===e&&s.routeSection&&t.has(String(s.routeSection||"").toUpperCase()))},[x,c,Q]),pe=o.useMemo(()=>{const e=(c==null?void 0:c.installationId)||"",t=new Set(Q.map(s=>s.toUpperCase()));return x.filter(s=>s.installationId===e&&(s.currentStage!=="INSTALLATION_REVIEW"||!(s.routeSection&&t.has(String(s.routeSection||"").toUpperCase()))))},[x,c,Q]),De=async(e,t)=>{const s=R(c,"Installation Section"),d=(t||"").trim()||e.routeSection||"",i={actor:s,timestamp:new Date().toISOString(),action:`Restored to installation section${d?`: ${d}`:""}`},u={...e,currentStage:"INSTALLATION_REVIEW",finalStatus:void 0,routeSection:d,activity:[...e.activity||[],i]};try{await A(u),g(r=>r.map(b=>b.id===e.id?u:b))}catch(r){console.error("InstallationSectionDashboard - Failed to restore:",r),S.error("Failed to restore to section")}},Me=async e=>{const t=k[e.id]||"";if(!t.trim())return;const s=R(c,"Installation Section"),d=e.routeSection||"",i={actor:s,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Approved and routed to Installation Command: ${t}${d?` (from ${d})`:""}`,comment:(v[e.id]||"").trim(),fromSection:d||void 0,toSection:t},u={...e,routeSection:t,activity:[...e.activity||[],i]};try{await A(u),g(r=>r.map(b=>b.id===e.id?u:b)),h(r=>({...r,[e.id]:""})),$(r=>({...r,[e.id]:""}))}catch(r){console.error("Failed to route to installation command section:",r),S.error("Failed to route to installation command section")}},Ue=async e=>{const t=Y[e.id]||"";if(!t.trim())return;const s=R(c,"Installation Section"),d=e.routeSection||"",i={actor:s,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Reassigned to installation section: ${t}${d?` (from ${d})`:""}`,comment:(v[e.id]||"").trim(),fromSection:d||void 0,toSection:t},u={...e,routeSection:t,activity:[...e.activity||[],i]};try{await A(u),g(r=>r.map(b=>b.id===e.id?u:b)),h(r=>({...r,[e.id]:""})),me(r=>({...r,[e.id]:""}))}catch(r){console.error("Failed to reassign to installation section:",r),S.error("Failed to reassign to installation section")}},$e=async e=>{const t=R(c,"Installation Section"),s=e.routeSection||"",d={actor:t,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:"Returned to originating unit (Battalion)",comment:(v[e.id]||"").trim(),fromSection:s||void 0,toSection:"BATTALION_REVIEW"},i={...e,currentStage:"BATTALION_REVIEW",installationId:null,routeSection:"",activity:[...e.activity||[],d]};try{await A(i),g(u=>u.map(r=>r.id===e.id?i:r)),h(u=>({...u,[e.id]:""}))}catch(u){console.error("Failed to return to unit:",u),S.error("Failed to return to unit")}},Te=(e,t)=>{if(!t){z(i=>({...i,[e]:""})),J(i=>({...i,[e]:""})),ie(i=>({...i,[e]:[]})),B(i=>({...i,[e]:""}));return}const s=t.uic;z(i=>({...i,[e]:s})),J(i=>({...i,[e]:t.unitName}));let d=[];try{const i=localStorage.getItem("unit_structure");if(i){const r=JSON.parse(i)[s],b=r!=null&&r._sections&&Array.isArray(r._sections)?r._sections:[],p=r!=null&&r._commandSections&&Array.isArray(r._commandSections)?r._commandSections:[];d=[...b,...p]}}catch(i){console.error("InstallationSectionDashboard - Failed to load unit sections:",i)}ie(i=>({...i,[e]:d})),B(i=>({...i,[e]:""}))},Oe=async e=>{const t=R(c,"Installation Section"),s=W[e.id]||"",d=ne[e.id]||"",i=ae[e.id]||"";if(!s.trim()){S.warning("Please select an external unit");return}const u=e.routeSection||"",r={actor:t,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:i?`Sent to external unit: ${d} - ${i}`:`Sent to external unit: ${d}`,comment:(v[e.id]||"").trim(),fromSection:u||void 0,toSection:i||d},b={...e,currentStage:"EXTERNAL_REVIEW",externalPendingUnitName:d,externalPendingUnitUic:s,externalPendingStage:i||void 0,routeSection:i||"",activity:[...e.activity||[],r]};try{await A(b),g(p=>p.map(he=>he.id===e.id?b:he)),h(p=>({...p,[e.id]:""})),te(p=>({...p,[e.id]:!1})),z(p=>({...p,[e.id]:""})),J(p=>({...p,[e.id]:""})),B(p=>({...p,[e.id]:""}))}catch(p){console.error("Failed to send to external unit:",p),S.error("Failed to send to external unit")}},Le=async e=>{const t=R(c,"Installation Section"),s=L[e.id]||"",d=K[e.id]||"";if(!s||!d){S.warning("Select HQMC division and section");return}const i=e.routeSection||"",u={actor:t,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Submitted to HQMC: ${s} - ${d}`,comment:(v[e.id]||"").trim(),fromSection:i||void 0,toSection:d},r={...e,currentStage:"HQMC_REVIEW",routeSection:d,activity:[...e.activity||[],u]};try{await A(r),g(b=>b.map(p=>p.id===e.id?r:p)),h(b=>({...b,[e.id]:""})),de(b=>({...b,[e.id]:""})),X(b=>({...b,[e.id]:""}))}catch(b){console.error("Failed to submit to HQMC:",b),S.error("Failed to submit to HQMC")}},Fe=async e=>{const s={actor:R(c,"Installation Section"),actorRole:"Installation Section",timestamp:new Date().toISOString(),action:"Archived by Installation Section",comment:(v[e.id]||"").trim()},d={...e,currentStage:"ARCHIVED",finalStatus:"Archived",activity:[...e.activity||[],s]};try{await A(d),g(i=>i.map(u=>u.id===e.id?d:u)),h(i=>({...i,[e.id]:""}))}catch(i){console.error("Failed to archive request:",i),S.error("Failed to archive request")}};return n.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[n.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Installation Section Dashboard"}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"text-sm text-[var(--muted)]",children:(l==null?void 0:l.name)||""}),Ee&&n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>re(!0),children:"Manage Section Access"})]})]}),n.jsx("div",{className:"border-b border-gray-200 mb-4",children:n.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[n.jsx("button",{onClick:()=>j("Pending"),className:`${m==="Pending"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),n.jsx("button",{onClick:()=>j("Previously in Section"),className:`${m==="Previously in Section"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Previously in Section"})]})}),m==="Pending"&&n.jsx(ge,{title:"Assigned to My Sections",titleActions:n.jsx(n.Fragment,{children:n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ae,children:"Export Pending"})}),requests:be,users:G,variant:"installation",onRowClick:e=>M(t=>({...t,[e.id]:!t[e.id]})),expandedRows:I,children:e=>n.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[n.jsx("div",{className:"mt-3",children:n.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!f[e.id],"aria-controls":`docs-inst-${e.id}`,onClick:()=>{T(t=>({...t,[e.id]:!t[e.id]})),H(t=>f[e.id]?null:e.id)},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),T(s=>({...s,[e.id]:!s[e.id]})),H(s=>f[e.id]?null:e.id))},children:[n.jsx("span",{children:"Show Documents"}),n.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${f[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:n.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),n.jsx("div",{id:`docs-inst-${e.id}`,ref:f[e.id]?a:void 0,className:`${f[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:n.jsx(Ke,{documents:Z(e.id),showIcons:!0,onPreview:t=>le(Z(e.id).find(s=>s.id===t.id)||null)})}),n.jsxs("div",{className:"mt-3",children:[n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>O(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!w[e.id],"aria-controls":`logs-inst-${e.id}`,children:[w[e.id]?"Hide":"Show"," Activity Log"]}),n.jsx("div",{id:`logs-inst-${e.id}`,className:w[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,s)=>n.jsxs("div",{className:"text-xs text-gray-700",children:[n.jsxs("div",{className:"font-medium",children:[t.actor," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&n.jsx("div",{className:"text-gray-600",children:t.comment})]},s)):n.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),n.jsx("textarea",{rows:2,value:v[e.id]||"",onChange:t=>h(s=>({...s,[e.id]:t.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),n.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[n.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 text-sm rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[n.jsx("input",{type:"file",multiple:!0,onChange:t=>y(s=>({...s,[e.id]:t.target.files?Array.from(t.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),n.jsx("span",{className:"text-xs text-[var(--muted)]",children:(C[e.id]||[]).length?`${(C[e.id]||[]).length} file(s) selected`:"No files selected"}),(C[e.id]||[]).length>0&&n.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>ke(e),children:"Save Files"})]}),n.jsxs("div",{className:"mt-4 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-3",children:"Routing Options"}),n.jsxs("div",{className:"mb-3 pb-3 border-b border-brand-navy/10",children:[n.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Approve to Installation Command Section"}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[n.jsxs("select",{className:"flex-1 min-w-[200px] px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:k[e.id]||"",onChange:t=>$(s=>({...s,[e.id]:t.target.value})),children:[n.jsx("option",{value:"",children:"Select command section..."}),((l==null?void 0:l.commandSections)||[]).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>Me(e),disabled:!k[e.id],children:"Approve to Command"})]})]}),n.jsxs("div",{className:"mb-3 pb-3 border-b border-brand-navy/10",children:[n.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Reassign to Another Installation Section"}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[n.jsxs("select",{className:"flex-1 min-w-[200px] px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:Y[e.id]||"",onChange:t=>me(s=>({...s,[e.id]:t.target.value})),children:[n.jsx("option",{value:"",children:"Select installation section..."}),((l==null?void 0:l.sections)||[]).filter(t=>t.toUpperCase()!==(e.routeSection||"").toUpperCase()).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-4 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>Ue(e),disabled:!Y[e.id],children:"Reassign"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Return to Originating Unit"}),n.jsx("button",{className:"px-4 py-2 rounded bg-brand-navy text-brand-cream font-medium hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>$e(e),children:"Return to Battalion"}),n.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"Request will be returned to the originating unit's Battalion Section Dashboard"})]})]}),(e.activity||[]).some(t=>/Endorsed by Installation Commander/i.test(String(t.action||"")))&&n.jsxs("div",{className:"mt-3 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Send Options (Post-Endorsement)"}),n.jsxs("div",{className:"flex flex-col gap-3",children:[n.jsxs("div",{className:"pb-3 border-b border-brand-navy/10",children:[n.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer mb-2",children:[n.jsx("input",{type:"checkbox",id:`send-ext-inst-${e.id}`,checked:V[e.id]||!1,onChange:()=>{const t=!V[e.id];te(s=>({...s,[e.id]:t}))},className:"rounded border-brand-navy/30"}),n.jsx("span",{className:"text-sm font-medium",children:"Send to External Unit"})]}),V[e.id]&&n.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[n.jsx(ze,{onUnitSelect:t=>Te(e.id,t),selectedUnit:{uic:W[e.id]||"",unitName:ne[e.id]||""},placeholder:"Search by UIC, RUC, MCC, or Unit Name"}),n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:ae[e.id]||"",onChange:t=>B(s=>({...s,[e.id]:t.target.value})),disabled:!(se[e.id]||[]).length,children:[n.jsx("option",{value:"",children:"Select Section/Office (optional)"}),(se[e.id]||[]).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>Oe(e),disabled:!W[e.id],children:"Submit to External Unit"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--muted)] mb-2",children:"Submit to HQMC"}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:L[e.id]||"",onChange:t=>{de(s=>({...s,[e.id]:t.target.value})),X(s=>({...s,[e.id]:""}))},children:[n.jsx("option",{value:"",children:"Select HQMC Division"}),fe.map(t=>n.jsxs("option",{value:t.code,children:[t.code," — ",t.name]},t.code))]}),n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",value:K[e.id]||"",onChange:t=>X(s=>({...s,[e.id]:t.target.value})),disabled:!L[e.id],children:[n.jsx("option",{value:"",children:"Select HQMC Section"}),je.filter(t=>String(t.division_code||"")===String(L[e.id]||"")).map(t=>n.jsx("option",{value:t.branch,children:t.branch},t.branch))]})]}),n.jsx("div",{className:"mt-2",children:n.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Le(e),disabled:!(L[e.id]&&K[e.id]),children:"Submit to HQMC"})})]})]})]}),Je(e,{userLevel:"installation",userInstallationId:c==null?void 0:c.installationId})&&n.jsx("div",{className:"mt-3 flex items-center justify-end gap-2",children:n.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Fe(e),children:"Archive"})})]})}),m==="Previously in Section"&&n.jsx(ge,{title:"Previously in Section",titleActions:n.jsx(n.Fragment,{children:n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Re,children:"Export Previous"})}),requests:pe,users:G,variant:"installation",onRowClick:e=>M(t=>({...t,[e.id]:!t[e.id]})),expandedRows:I,children:e=>n.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[n.jsxs("div",{className:"text-xs text-gray-600",children:["Last Status: ",new Date(e.activity&&e.activity.length?e.activity[e.activity.length-1].timestamp:e.createdAt).toLocaleString()]}),n.jsxs("div",{className:"mt-2",children:[n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>O(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!w[e.id],"aria-controls":`logs-prev-inst-${e.id}`,children:[w[e.id]?"Hide":"Show"," Activity Log"]}),n.jsx("div",{id:`logs-prev-inst-${e.id}`,className:w[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,s)=>n.jsxs("div",{className:"text-xs text-gray-700",children:[n.jsxs("div",{className:"font-medium",children:[t.actor," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&n.jsx("div",{className:"text-gray-600",children:t.comment})]},s)):n.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),n.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg",value:q[e.id]||"",onChange:t=>ye(s=>({...s,[e.id]:t.target.value})),children:[n.jsx("option",{value:"",children:"Select installation section"}),((l==null?void 0:l.sections)||[]).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>De(e,q[e.id]),children:"Restore to Section"})]})]})})]}),Ne&&c&&n.jsx(Ye,{currentUser:c,onClose:()=>re(!1)}),D&&n.jsx(Xe,{fileName:D.name,url:D.fileUrl||"",mimeType:D.type||"",fileSize:D.size||0,isOpen:!!D,onClose:()=>le(null)})]})}export{ct as default};
