import{r,j as t,R as at,u as ot}from"./index-D4ZIvaps.js";import{x as Fe,e as Ee,z as rt,c as ct,l as lt,m as dt,n as mt,f as ut,u as F}from"./db-q312qQgr.js";import{S as xt}from"./SearchableUnitSelector-BtGC57GS.js";import{R as Re,h as bt}from"./RequestTable-BE0xOlwW.js";import{a as pt,D as gt}from"./DocumentListItem-BU921V7c.js";import{f as E}from"./utils-CLmukD0c.js";import"./units-CaNgy_2U.js";const ht=({currentUser:l,onClose:Y})=>{const[p,f]=r.useState(null),[A,$]=r.useState([]),[m,Q]=r.useState(""),[w,O]=r.useState(""),[M,P]=r.useState(!1),[V,L]=r.useState("");r.useEffect(()=>{Fe().then(d=>{const u=d.find(S=>String(S.id)===String(l.installationId||""));f(u||null)}).catch(()=>f(null)),Ee().then(d=>$(d)).catch(()=>$([]))},[]);const y=r.useMemo(()=>(p==null?void 0:p.sections)||[],[p]),h=r.useMemo(()=>(p==null?void 0:p.sectionAssignments)||{},[p]),D=String(l.id||""),j=r.useMemo(()=>{if(!p||!m)return!1;if(l.isInstallationAdmin)return!0;const d=h[m]||[];return Array.isArray(d)&&d.includes(D)},[p,m,h,D,l]),N=r.useMemo(()=>A.reduce((d,u)=>({...d,[u.id]:u}),{}),[A]),_=r.useMemo(()=>m?(h[m]||[]).map(u=>N[u]).filter(Boolean):[],[h,m,N]),C=r.useMemo(()=>{const d=Array.isArray(p==null?void 0:p.unitUics)?p.unitUics.map(String):[];return A.filter(u=>{if(u.id===l.id)return!1;const S=String(u.unitUic||"");return d.includes(S)})},[A,p,l]),H=async d=>{if(p){P(!0),L("");try{const u={...p,sectionAssignments:d};if(!(await rt(u)).ok)throw new Error("persist_failed");f(u);try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:l.id,scope:{installationId:p.id,section:m},timestamp:new Date().toISOString(),event:"installation_section_assignments_updated"})})}catch{}}catch{L("Failed to persist installation assignments")}finally{P(!1)}}},re=async()=>{if(!j||!m||!w)return;const d={...h},u=Array.isArray(d[m])?d[m]:[];u.includes(w)||u.push(w),d[m]=u,await H(d),O("")},z=async d=>{if(!j||!m||!d)return;const u={...h},S=Array.isArray(u[m])?u[m]:[];u[m]=S.filter(k=>k!==d),await H(u)};return t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:Y,children:t.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:d=>d.stopPropagation(),children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Installation Section Access"}),t.jsx("button",{className:"text-gray-500",onClick:Y,children:"✕"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),t.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:m,onChange:d=>Q(d.target.value),children:[t.jsx("option",{value:"",children:"Select section"}),y.map(d=>t.jsx("option",{value:d,children:d},d))]})]}),m&&!j&&t.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You do not have permission to manage this section. Only installation admins or assigned section members can manage access."}),m&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User to Section"}),t.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:w,onChange:d=>O(d.target.value),disabled:!j,children:[t.jsx("option",{value:"",children:"Choose user"}),C.map(d=>t.jsxs("option",{value:d.id,children:[d.rank," ",d.lastName,", ",d.firstName,d.mi?` ${d.mi}`:""," • ",d.email]},d.id))]}),t.jsx("div",{className:"mt-2 flex justify-end",children:t.jsx("button",{className:"px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!j||!w||M,onClick:re,children:"Add"})})]}),t.jsxs("div",{className:"mt-4",children:[t.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Members"}),t.jsxs("div",{className:"space-y-2",children:[_.map(d=>t.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[t.jsxs("div",{className:"text-sm text-gray-700",children:[d.rank," ",d.lastName,", ",d.firstName,d.mi?` ${d.mi}`:""," • ",d.email]}),t.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!j||M,onClick:()=>z(d.id),children:"Remove"})]},d.id)),_.length===0&&t.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]}),V&&t.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:V})]})]})]})})};function It(){const[l,Y]=r.useState(null),[p,f]=r.useState([]),[A,$]=r.useState({}),[m,Q]=r.useState(null),[w,O]=r.useState([]),[M,P]=r.useState({}),[V,L]=r.useState([]),[y,h]=r.useState({}),[D,j]=r.useState({}),[N,_]=r.useState({}),[C,H]=r.useState({}),[re,z]=r.useState(null),d=at.useRef(null),[u,S]=r.useState("Pending"),[k,ce]=r.useState(""),[Me,Le]=r.useState({}),[Te,Ue]=r.useState({}),[le,$e]=r.useState({}),[q,de]=r.useState({}),[ft,vt]=r.useState({}),[X,G]=r.useState({}),[me,Z]=r.useState({}),[ue,xe]=r.useState({}),[be,W]=r.useState({}),[Oe,pe]=r.useState([]),[ge,he]=r.useState([]),[fe,ve]=r.useState({}),[ee,te]=r.useState({}),[Pe,ye]=r.useState(!1),[T,Se]=r.useState(null),[se,je]=r.useState({}),[_e,ne]=r.useState(!1),[J,ie]=r.useState(null),[B,K]=r.useState(""),v=ot();r.useEffect(()=>{try{const e=localStorage.getItem("currentUser");e&&Y(JSON.parse(e))}catch{}},[]),r.useEffect(()=>{ct().then(e=>f(e)).catch(()=>f([])),lt().then(e=>L(e)).catch(()=>L([]))},[]),r.useEffect(()=>{l!=null&&l.installationId&&(Fe().then(e=>{const s=e.find(n=>n.id===l.installationId);Q(s||null)}).catch(()=>Q(null)),Ee().then(e=>O(e)).catch(()=>O([])))},[l]),r.useEffect(()=>{dt().then(pe).catch(()=>pe([])),mt().then(he).catch(()=>he([]))},[]);const ae=r.useMemo(()=>{const e={};for(const s of w)e[s.id]=s;return e},[w]),oe=e=>V.filter(s=>String(s.requestId||"")===String(e)),He=e=>ae[e.uploadedById],Be=e=>{const s=He(e);return s?`${s.rank||""} ${s.lastName||""}, ${s.firstName||""}${s.mi?` ${s.mi}`:""}`.trim():""},Ye=e=>`"${String(e??"").replace(/"/g,'""')}"`,Ne=e=>{const n=[["Request ID","Subject","Stage","Installation Section","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const i of e){const a=oe(i.id).map(c=>c.name).join(" | ");n.push([i.id,i.subject,i.currentStage||"",i.routeSection||"",i.routeSection||"",Be(i),i.unitUic||"",new Date(i.createdAt).toLocaleString(),a])}return n.map(i=>i.map(Ye).join(",")).join(`\r
`)},we=(e,s)=>{const n=new Blob([s],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(n),a=document.createElement("a");a.href=i,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)},Qe=()=>we("installation_section_pending.csv",Ne(Ce)),Ve=()=>we("installation_section_previous.csv",Ne(ke)),ze=async e=>{const s=D[e.id]||[];if(!s.length)return;const n=(l==null?void 0:l.id)||"",i=e.unitUic||"",a=s.map(o=>({id:`doc-${Date.now()}-${Math.random().toString(16).slice(2)}`,name:o.name,type:o.type||"application/octet-stream",size:o.size,uploadedAt:new Date,category:"ATTACHMENT",tags:[],unitUic:i,subject:e.subject,notes:y[e.id]||void 0,uploadedById:n,currentStage:e.currentStage,requestId:e.id,fileUrl:void 0})),{ok:c}=await ut(a);c?(L(o=>[...a,...o]),j(o=>({...o,[e.id]:[]}))):v.error("Failed to save files")},U=r.useMemo(()=>{if(!m||!(l!=null&&l.id))return[];const e=m.sectionAssignments||{};return Object.entries(e).filter(([,n])=>Array.isArray(n)&&n.includes(l.id)).map(([n])=>String(n))},[m,l]),We=r.useMemo(()=>{if(!m||!(l!=null&&l.id))return!1;if(l.isInstallationAdmin)return!0;const e=m.sectionAssignments||{};return Object.values(e).some(s=>Array.isArray(s)&&s.includes(l.id))},[m,l]),Ce=r.useMemo(()=>{const e=(l==null?void 0:l.installationId)||"",s=new Set(U.map(n=>n.toUpperCase()));return p.filter(n=>n.currentStage==="INSTALLATION_REVIEW"&&n.installationId===e&&n.routeSection&&s.has(String(n.routeSection||"").toUpperCase()))},[p,l,U]),ke=r.useMemo(()=>{const e=(l==null?void 0:l.installationId)||"",s=new Set(U.map(n=>n.toUpperCase()));return p.filter(n=>n.filedAt?!1:n.installationId===e&&(n.currentStage!=="INSTALLATION_REVIEW"||!(n.routeSection&&s.has(String(n.routeSection||"").toUpperCase()))))},[p,l,U]),Ie=r.useCallback(e=>{if(e.isPermanent)return"Permanent";if(!e.retentionValue||!e.cutoffTrigger||!e.filedAt)return"Unknown";const s=new Date(e.filedAt);let n;switch(e.cutoffTrigger){case"CALENDAR_YEAR":n=new Date(s.getFullYear(),11,31);break;case"FISCAL_YEAR":n=s.getMonth()>=9?new Date(s.getFullYear()+1,8,30):new Date(s.getFullYear(),8,30);break;default:n=s}const i=new Date(n),a=(e.retentionUnit||"").toLowerCase();return a==="years"?i.setFullYear(i.getFullYear()+e.retentionValue):a==="months"?i.setMonth(i.getMonth()+e.retentionValue):a==="days"&&i.setDate(i.getDate()+e.retentionValue),i.getFullYear().toString()},[]),Je=r.useCallback(e=>{if(!e.retentionValue||!e.cutoffTrigger||!e.filedAt)return"N/A";if(e.isPermanent)return"Permanent";const s=new Date(e.filedAt);let n;switch(e.cutoffTrigger){case"CALENDAR_YEAR":n=new Date(s.getFullYear(),11,31);break;case"FISCAL_YEAR":n=s.getMonth()>=9?new Date(s.getFullYear()+1,8,30):new Date(s.getFullYear(),8,30);break;default:n=s}const i=new Date(n),a=(e.retentionUnit||"").toLowerCase();return a==="years"?i.setFullYear(i.getFullYear()+e.retentionValue):a==="months"?i.setMonth(i.getMonth()+e.retentionValue):a==="days"&&i.setDate(i.getDate()+e.retentionValue),i.toLocaleDateString()},[]),R=r.useMemo(()=>{const e=(l==null?void 0:l.installationId)||"";let s=p.filter(i=>{var c;return!i.filedAt||i.installationId!==e?!1:(c=i.activity)==null?void 0:c.some(o=>{const b=String(o.action||"");return U.some(x=>b.includes(x)||b.includes(x.toUpperCase()))})});if(k.trim()){const i=k.toLowerCase().trim();s=s.filter(a=>{var c,o,b,x;return((c=a.subject)==null?void 0:c.toLowerCase().includes(i))||((o=a.ssic)==null?void 0:o.toLowerCase().includes(i))||((b=a.ssicNomenclature)==null?void 0:b.toLowerCase().includes(i))||((x=a.ssicBucketTitle)==null?void 0:x.toLowerCase().includes(i))})}const n={};for(const i of s){const a=Ie(i),c=i.ssicBucketTitle||i.ssicBucket||"Uncategorized";n[a]||(n[a]={}),n[a][c]||(n[a][c]=[]),n[a][c].push(i)}for(const i of Object.keys(n))for(const a of Object.keys(n[i]))n[i][a].sort((c,o)=>new Date(o.createdAt).getTime()-new Date(c.createdAt).getTime());return n},[p,l,U,k,Ie]),Ae=r.useMemo(()=>Object.keys(R).sort((s,n)=>s==="Permanent"?-1:n==="Permanent"||s==="Unknown"?1:n==="Unknown"?-1:parseInt(s)-parseInt(n)),[R]),Ke=r.useMemo(()=>Object.values(R).reduce((e,s)=>e+Object.values(s).reduce((n,i)=>n+i.length,0),0),[R]);r.useMemo(()=>{const e=[];for(const s of Object.values(R))for(const n of Object.values(s))e.push(...n);return e},[R]);const qe=async(e,s)=>{const n=E(l,"Installation Section"),i=(s||"").trim()||e.routeSection||"",a={actor:n,timestamp:new Date().toISOString(),action:`Restored to installation section${i?`: ${i}`:""}`},c={...e,currentStage:"INSTALLATION_REVIEW",finalStatus:void 0,routeSection:i,activity:[...e.activity||[],a]};try{await F(c),f(o=>o.map(b=>b.id===e.id?c:b))}catch(o){console.error("InstallationSectionDashboard - Failed to restore:",o),v.error("Failed to restore to section")}},Xe=async e=>{const s=M[e.id]||"";if(!s.trim())return;const n=E(l,"Installation Section"),i=e.routeSection||"",a={actor:n,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Approved and routed to Installation Command: ${s}${i?` (from ${i})`:""}`,comment:(y[e.id]||"").trim(),fromSection:i||void 0,toSection:s},c={...e,routeSection:s,activity:[...e.activity||[],a]};try{await F(c),f(o=>o.map(b=>b.id===e.id?c:b)),h(o=>({...o,[e.id]:""})),P(o=>({...o,[e.id]:""}))}catch(o){console.error("Failed to route to installation command section:",o),v.error("Failed to route to installation command section")}},Ge=async e=>{const s=se[e.id]||"";if(!s.trim())return;const n=E(l,"Installation Section"),i=e.routeSection||"",a={actor:n,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Reassigned to installation section: ${s}${i?` (from ${i})`:""}`,comment:(y[e.id]||"").trim(),fromSection:i||void 0,toSection:s},c={...e,routeSection:s,activity:[...e.activity||[],a]};try{await F(c),f(o=>o.map(b=>b.id===e.id?c:b)),h(o=>({...o,[e.id]:""})),je(o=>({...o,[e.id]:""}))}catch(o){console.error("Failed to reassign to installation section:",o),v.error("Failed to reassign to installation section")}},Ze=async e=>{const s=E(l,"Installation Section"),n=e.routeSection||"",i={actor:s,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:"Returned to originating unit (Battalion)",comment:(y[e.id]||"").trim(),fromSection:n||void 0,toSection:"BATTALION_REVIEW"},a={...e,currentStage:"BATTALION_REVIEW",installationId:null,routeSection:"",activity:[...e.activity||[],i]};try{await F(a),f(c=>c.map(o=>o.id===e.id?a:o)),h(c=>({...c,[e.id]:""}))}catch(c){console.error("Failed to return to unit:",c),v.error("Failed to return to unit")}},et=(e,s)=>{if(!s){G(a=>({...a,[e]:""})),Z(a=>({...a,[e]:""})),xe(a=>({...a,[e]:[]})),W(a=>({...a,[e]:""}));return}const n=s.uic;G(a=>({...a,[e]:n})),Z(a=>({...a,[e]:s.unitName}));let i=[];try{const a=localStorage.getItem("unit_structure");if(a){const o=JSON.parse(a)[n],b=o!=null&&o._sections&&Array.isArray(o._sections)?o._sections:[],x=o!=null&&o._commandSections&&Array.isArray(o._commandSections)?o._commandSections:[];i=[...b,...x]}}catch(a){console.error("InstallationSectionDashboard - Failed to load unit sections:",a)}xe(a=>({...a,[e]:i})),W(a=>({...a,[e]:""}))},tt=async e=>{const s=E(l,"Installation Section"),n=X[e.id]||"",i=me[e.id]||"",a=be[e.id]||"";if(!n.trim()){v.warning("Please select an external unit");return}const c=e.routeSection||"",o={actor:s,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:a?`Sent to external unit: ${i} - ${a}`:`Sent to external unit: ${i}`,comment:(y[e.id]||"").trim(),fromSection:c||void 0,toSection:a||i},b={...e,currentStage:"EXTERNAL_REVIEW",externalPendingUnitName:i,externalPendingUnitUic:n,externalPendingStage:a||void 0,routeSection:a||"",activity:[...e.activity||[],o]};try{await F(b),f(x=>x.map(I=>I.id===e.id?b:I)),h(x=>({...x,[e.id]:""})),de(x=>({...x,[e.id]:!1})),G(x=>({...x,[e.id]:""})),Z(x=>({...x,[e.id]:""})),W(x=>({...x,[e.id]:""}))}catch(x){console.error("Failed to send to external unit:",x),v.error("Failed to send to external unit")}},st=async e=>{const s=E(l,"Installation Section"),n=fe[e.id]||"",i=ee[e.id]||"";if(!n){v.warning("Select HQMC division");return}if(ge.some(g=>String(g.division_code||"")===n)&&!i){v.warning("Select HQMC section");return}const c=e.routeSection||"",o=i||n,b=i?`Submitted to HQMC: ${n} - ${i}`:`Submitted to HQMC: ${n}`,x={actor:s,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:b,comment:(y[e.id]||"").trim(),fromSection:c||void 0,toSection:o},I={...e,currentStage:"HQMC_REVIEW",routeSection:o,activity:[...e.activity||[],x]};try{await F(I),f(g=>g.map(De=>De.id===e.id?I:De)),h(g=>({...g,[e.id]:""})),ve(g=>({...g,[e.id]:""})),te(g=>({...g,[e.id]:""}))}catch(g){console.error("Failed to submit to HQMC:",g),v.error("Failed to submit to HQMC")}},nt=e=>{ie(e),K(new Date().toISOString().slice(0,10)),ne(!0)},it=async()=>{if(!J||!B)return;const e=J,n={actor:E(l,"Installation Section"),actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Filed by Installation Section (Date Finalized: ${B})`,comment:(y[e.id]||"").trim()},i={...e,filedAt:new Date(B).toISOString(),activity:[...e.activity||[],n]};try{await F(i),f(a=>a.map(c=>c.id===e.id?i:c)),h(a=>({...a,[e.id]:""})),ne(!1),ie(null),K(""),v.success("Request filed successfully")}catch(a){console.error("Failed to file request:",a),v.error("Failed to file request")}};return t.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[t.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Installation Section Dashboard"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"text-sm text-[var(--muted)]",children:(m==null?void 0:m.name)||""}),We&&t.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>ye(!0),children:"Manage Section Access"})]})]}),t.jsx("div",{className:"border-b border-gray-200 mb-4",children:t.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[t.jsx("button",{onClick:()=>S("Pending"),className:`${u==="Pending"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),t.jsx("button",{onClick:()=>S("Previously in Section"),className:`${u==="Previously in Section"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Previously in Section"}),t.jsxs("button",{onClick:()=>S("Files"),className:`${u==="Files"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:["Files (",Ke,")"]})]})}),u==="Pending"&&t.jsx(Re,{title:"Assigned to My Sections",titleActions:t.jsx(t.Fragment,{children:t.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Qe,children:"Export Pending"})}),requests:Ce,users:ae,variant:"installation",onRowClick:e=>$(s=>({...s,[e.id]:!s[e.id]})),expandedRows:A,children:e=>t.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[t.jsx("div",{className:"mt-3",children:t.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!N[e.id],"aria-controls":`docs-inst-${e.id}`,onClick:()=>{_(s=>({...s,[e.id]:!s[e.id]})),z(s=>N[e.id]?null:e.id)},onKeyDown:s=>{(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),_(n=>({...n,[e.id]:!n[e.id]})),z(n=>N[e.id]?null:e.id))},children:[t.jsx("span",{children:"Show Documents"}),t.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${N[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:t.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),t.jsx("div",{id:`docs-inst-${e.id}`,ref:N[e.id]?d:void 0,className:`${N[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:t.jsx(pt,{documents:oe(e.id),showIcons:!0,onPreview:s=>Se(oe(e.id).find(n=>n.id===s.id)||null)})}),t.jsxs("div",{className:"mt-3",children:[t.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>H(s=>({...s,[e.id]:!s[e.id]})),"aria-expanded":!!C[e.id],"aria-controls":`logs-inst-${e.id}`,children:[C[e.id]?"Hide":"Show"," Activity Log"]}),t.jsx("div",{id:`logs-inst-${e.id}`,className:C[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((s,n)=>t.jsxs("div",{className:"text-xs text-gray-700",children:[t.jsxs("div",{className:"font-medium",children:[s.actor," • ",new Date(s.timestamp).toLocaleString()," • ",s.action]}),s.comment&&t.jsx("div",{className:"text-gray-600",children:s.comment})]},n)):t.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),t.jsxs("div",{className:"mt-3",children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),t.jsx("textarea",{rows:2,value:y[e.id]||"",onChange:s=>h(n=>({...n,[e.id]:s.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),t.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[t.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 text-sm rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[t.jsx("input",{type:"file",multiple:!0,onChange:s=>j(n=>({...n,[e.id]:s.target.files?Array.from(s.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),t.jsx("span",{className:"text-xs text-[var(--muted)]",children:(D[e.id]||[]).length?`${(D[e.id]||[]).length} file(s) selected`:"No files selected"}),(D[e.id]||[]).length>0&&t.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>ze(e),children:"Save Files"})]}),t.jsxs("div",{className:"mt-4 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-3",children:"Routing Options"}),t.jsxs("div",{className:"mb-3 pb-3 border-b border-brand-navy/10",children:[t.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Approve to Installation Command Section"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsxs("select",{className:"flex-1 min-w-[200px] px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:M[e.id]||"",onChange:s=>P(n=>({...n,[e.id]:s.target.value})),children:[t.jsx("option",{value:"",children:"Select command section..."}),((m==null?void 0:m.commandSections)||[]).map(s=>t.jsx("option",{value:s,children:s},s))]}),t.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>Xe(e),disabled:!M[e.id],children:"Approve to Command"})]})]}),t.jsxs("div",{className:"mb-3 pb-3 border-b border-brand-navy/10",children:[t.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Reassign to Another Installation Section"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsxs("select",{className:"flex-1 min-w-[200px] px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:se[e.id]||"",onChange:s=>je(n=>({...n,[e.id]:s.target.value})),children:[t.jsx("option",{value:"",children:"Select installation section..."}),((m==null?void 0:m.sections)||[]).filter(s=>s.toUpperCase()!==(e.routeSection||"").toUpperCase()).map(s=>t.jsx("option",{value:s,children:s},s))]}),t.jsx("button",{className:"px-4 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>Ge(e),disabled:!se[e.id],children:"Reassign"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Return to Originating Unit"}),t.jsx("button",{className:"px-4 py-2 rounded bg-brand-navy text-brand-cream font-medium hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Ze(e),children:"Return to Battalion"}),t.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"Request will be returned to the originating unit's Unit Section Dashboard"})]})]}),(e.activity||[]).some(s=>/Endorsed by Installation Commander/i.test(String(s.action||"")))&&t.jsxs("div",{className:"mt-3 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Send Options (Post-Endorsement)"}),t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("div",{className:"pb-3 border-b border-brand-navy/10",children:[t.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer mb-2",children:[t.jsx("input",{type:"checkbox",id:`send-ext-inst-${e.id}`,checked:q[e.id]||!1,onChange:()=>{const s=!q[e.id];de(n=>({...n,[e.id]:s}))},className:"rounded border-brand-navy/30"}),t.jsx("span",{className:"text-sm font-medium",children:"Send to External Unit"})]}),q[e.id]&&t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[t.jsx(xt,{onUnitSelect:s=>et(e.id,s),selectedUnit:{uic:X[e.id]||"",unitName:me[e.id]||""},placeholder:"Search by UIC, RUC, MCC, or Unit Name"}),t.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:be[e.id]||"",onChange:s=>W(n=>({...n,[e.id]:s.target.value})),disabled:!(ue[e.id]||[]).length,children:[t.jsx("option",{value:"",children:"Select Section/Office (optional)"}),(ue[e.id]||[]).map(s=>t.jsx("option",{value:s,children:s},s))]}),t.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>tt(e),disabled:!X[e.id],children:"Submit to External Unit"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--muted)] mb-2",children:"Submit to HQMC"}),(()=>{const s=fe[e.id]||"",n=ge.filter(c=>String(c.division_code||"")===s),i=n.length>0,a=s&&(i?!!ee[e.id]:!0);return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[t.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:s,onChange:c=>{ve(o=>({...o,[e.id]:c.target.value})),te(o=>({...o,[e.id]:""}))},children:[t.jsx("option",{value:"",children:"Select HQMC Division"}),Oe.map(c=>t.jsxs("option",{value:c.code,children:[c.code," — ",c.name]},c.code))]}),i?t.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",value:ee[e.id]||"",onChange:c=>te(o=>({...o,[e.id]:c.target.value})),disabled:!s,children:[t.jsx("option",{value:"",children:"Select HQMC Section"}),n.map(c=>t.jsx("option",{value:c.branch,children:c.branch},c.branch))]}):s?t.jsx("div",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm bg-gray-100 text-gray-600 flex items-center",children:"No sections defined — submit to division"}):t.jsx("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",disabled:!0,children:t.jsx("option",{value:"",children:"Select HQMC Section"})})]}),t.jsx("div",{className:"mt-2",children:t.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>st(e),disabled:!a,children:"Submit to HQMC"})})]})})()]})]})]}),bt(e,{userLevel:"installation",userInstallationId:l==null?void 0:l.installationId})&&e.ssic&&!e.filedAt&&t.jsx("div",{className:"mt-3 flex items-center justify-end gap-2",children:t.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>nt(e),children:"File"})})]})}),u==="Previously in Section"&&t.jsx(Re,{title:"Previously in Section",titleActions:t.jsx(t.Fragment,{children:t.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ve,children:"Export Previous"})}),requests:ke,users:ae,variant:"installation",onRowClick:e=>$(s=>({...s,[e.id]:!s[e.id]})),expandedRows:A,children:e=>t.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[t.jsxs("div",{className:"text-xs text-gray-600",children:["Last Status: ",new Date(e.activity&&e.activity.length?e.activity[e.activity.length-1].timestamp:e.createdAt).toLocaleString()]}),t.jsxs("div",{className:"mt-2",children:[t.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>H(s=>({...s,[e.id]:!s[e.id]})),"aria-expanded":!!C[e.id],"aria-controls":`logs-prev-inst-${e.id}`,children:[C[e.id]?"Hide":"Show"," Activity Log"]}),t.jsx("div",{id:`logs-prev-inst-${e.id}`,className:C[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((s,n)=>t.jsxs("div",{className:"text-xs text-gray-700",children:[t.jsxs("div",{className:"font-medium",children:[s.actor," • ",new Date(s.timestamp).toLocaleString()," • ",s.action]}),s.comment&&t.jsx("div",{className:"text-gray-600",children:s.comment})]},n)):t.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),t.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[t.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg",value:le[e.id]||"",onChange:s=>$e(n=>({...n,[e.id]:s.target.value})),children:[t.jsx("option",{value:"",children:"Select installation section"}),((m==null?void 0:m.sections)||[]).map(s=>t.jsx("option",{value:s,children:s},s))]}),t.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>qe(e,le[e.id]),children:"Restore to Section"})]})]})}),u==="Files"&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"relative",children:[t.jsx("input",{type:"text",placeholder:"Search files by subject, SSIC, category...",value:k,onChange:e=>ce(e.target.value),className:"w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold focus:border-transparent"}),t.jsx("svg",{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),k&&t.jsx("button",{onClick:()=>ce(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),Ae.length===0?t.jsx("div",{className:"text-center py-8 text-gray-500",children:k?"No records match your search.":"No filed records in this installation section."}):t.jsx("div",{className:"space-y-2",children:Ae.map(e=>{const s=R[e],n=Object.keys(s).sort(),i=e==="Permanent",a=Object.values(s).reduce((o,b)=>o+b.length,0),c=Me[e]||!1;return t.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[t.jsxs("button",{onClick:()=>Le(o=>({...o,[e]:!o[e]})),className:`w-full ${i?"bg-blue-800 hover:bg-blue-700":"bg-brand-navy hover:bg-brand-navy/90"} text-brand-cream px-4 py-3 font-medium flex items-center justify-between transition-colors`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("svg",{className:`w-4 h-4 transition-transform flex-shrink-0 ${c?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),t.jsx("span",{className:"truncate",children:i?"Permanent Records":`Disposal Year: ${e}`})]}),t.jsxs("span",{className:"text-xs bg-white/20 px-2 py-0.5 rounded flex-shrink-0 ml-2",children:[a," record",a!==1?"s":""]})]}),c&&t.jsx("div",{className:"bg-gray-50 p-2 space-y-2",children:n.map(o=>{const b=s[o],x=`${e}-${o}`,I=Te[x]||!1;return t.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden bg-white",children:[t.jsxs("button",{onClick:()=>Ue(g=>({...g,[x]:!g[x]})),className:"w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 font-medium text-sm flex items-center justify-between transition-colors",children:[t.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.jsx("svg",{className:`w-3 h-3 transition-transform flex-shrink-0 ${I?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),t.jsx("span",{className:"truncate",children:o})]}),t.jsxs("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:[b.length," item",b.length!==1?"s":""]})]}),I&&t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"Name"}),t.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"SSIC"}),t.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"Retention"}),t.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm hidden sm:table-cell",children:"Disposal Date"})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:b.map(g=>t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsx("td",{className:"px-2 sm:px-3 py-2 font-medium text-brand-navy text-xs sm:text-sm max-w-[120px] sm:max-w-none truncate",children:g.subject}),t.jsx("td",{className:"px-2 sm:px-3 py-2 text-xs sm:text-sm",children:g.ssic}),t.jsx("td",{className:"px-2 sm:px-3 py-2",children:g.isPermanent?t.jsx("span",{className:"inline-flex px-1.5 sm:px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded whitespace-nowrap",children:"Perm"}):t.jsxs("span",{className:"inline-flex px-1.5 sm:px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded whitespace-nowrap",children:[g.retentionValue," ",(g.retentionUnit||"").replace("S","")]})}),t.jsx("td",{className:"px-2 sm:px-3 py-2 text-xs sm:text-sm hidden sm:table-cell",children:Je(g)})]},g.id))})]})})]},x)})})]},e)})})]})]}),Pe&&l&&t.jsx(ht,{currentUser:l,onClose:()=>ye(!1)}),T&&t.jsx(gt,{fileName:T.name,url:T.fileUrl||"",mimeType:T.type||"",fileSize:T.size||0,isOpen:!!T,onClose:()=>Se(null)}),_e&&J&&t.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"File Record"}),t.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Filing: ",t.jsx("strong",{children:J.subject})]}),t.jsxs("div",{className:"mb-4",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date Finalized"}),t.jsx("input",{type:"date",value:B,onChange:e=>K(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold"}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"This date will be used to calculate the disposal date based on the retention schedule."})]}),t.jsxs("div",{className:"flex justify-end gap-3",children:[t.jsx("button",{className:"px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300",onClick:()=>{ne(!1),ie(null),K("")},children:"Cancel"}),t.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:it,disabled:!B,children:"Confirm File"})]})]})})]})}export{It as default};
