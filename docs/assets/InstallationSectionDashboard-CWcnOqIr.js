import{r as d,j as t,R as _e,u as Qe}from"./index-Csn1811y.js";import{x as fe,e as je,z as qe,c as Be,l as Ve,k as We,m as ze,f as Je,u as R}from"./db-DtVXCuJW.js";import{S as Ke}from"./SearchableUnitSelector-DGOmzbFb.js";import{R as ye,h as Xe}from"./RequestTable-BqwdM0Wh.js";import{a as Ye,D as Ge}from"./DocumentListItem-BnMeNFT4.js";import{f as k}from"./utils-CLmukD0c.js";import"./units-CaNgy_2U.js";const Ze=({currentUser:r,onClose:H})=>{const[x,h]=d.useState(null),[I,U]=d.useState([]),[m,P]=d.useState(""),[w,$]=d.useState(""),[E,T]=d.useState(!1),[_,D]=d.useState("");d.useEffect(()=>{fe().then(o=>{const u=o.find(N=>String(N.id)===String(r.installationId||""));h(u||null)}).catch(()=>h(null)),je().then(o=>U(o)).catch(()=>U([]))},[]);const y=d.useMemo(()=>(x==null?void 0:x.sections)||[],[x]),g=d.useMemo(()=>(x==null?void 0:x.sectionAssignments)||{},[x]),A=String(r.id||""),f=d.useMemo(()=>{if(!x||!m)return!1;if(r.isInstallationAdmin)return!0;const o=g[m]||[];return Array.isArray(o)&&o.includes(A)},[x,m,g,A,r]),j=d.useMemo(()=>I.reduce((o,u)=>({...o,[u.id]:u}),{}),[I]),O=d.useMemo(()=>m?(g[m]||[]).map(u=>j[u]).filter(Boolean):[],[g,m,j]),C=d.useMemo(()=>{const o=Array.isArray(x==null?void 0:x.unitUics)?x.unitUics.map(String):[];return I.filter(u=>{if(u.id===r.id)return!1;const N=String(u.unitUic||"");return o.includes(N)})},[I,x,r]),L=async o=>{if(x){T(!0),D("");try{const u={...x,sectionAssignments:o};if(!(await qe(u)).ok)throw new Error("persist_failed");h(u);try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:r.id,scope:{installationId:x.id,section:m},timestamp:new Date().toISOString(),event:"installation_section_assignments_updated"})})}catch{}}catch{D("Failed to persist installation assignments")}finally{T(!1)}}},te=async()=>{if(!f||!m||!w)return;const o={...g},u=Array.isArray(o[m])?o[m]:[];u.includes(w)||u.push(w),o[m]=u,await L(o),$("")},Q=async o=>{if(!f||!m||!o)return;const u={...g},N=Array.isArray(u[m])?u[m]:[];u[m]=N.filter(q=>q!==o),await L(u)};return t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:H,children:t.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:o=>o.stopPropagation(),children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Installation Section Access"}),t.jsx("button",{className:"text-gray-500",onClick:H,children:"✕"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),t.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:m,onChange:o=>P(o.target.value),children:[t.jsx("option",{value:"",children:"Select section"}),y.map(o=>t.jsx("option",{value:o,children:o},o))]})]}),m&&!f&&t.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You do not have permission to manage this section. Only installation admins or assigned section members can manage access."}),m&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User to Section"}),t.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:w,onChange:o=>$(o.target.value),disabled:!f,children:[t.jsx("option",{value:"",children:"Choose user"}),C.map(o=>t.jsxs("option",{value:o.id,children:[o.rank," ",o.lastName,", ",o.firstName,o.mi?` ${o.mi}`:""," • ",o.email]},o.id))]}),t.jsx("div",{className:"mt-2 flex justify-end",children:t.jsx("button",{className:"px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!f||!w||E,onClick:te,children:"Add"})})]}),t.jsxs("div",{className:"mt-4",children:[t.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Members"}),t.jsxs("div",{className:"space-y-2",children:[O.map(o=>t.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[t.jsxs("div",{className:"text-sm text-gray-700",children:[o.rank," ",o.lastName,", ",o.firstName,o.mi?` ${o.mi}`:""," • ",o.email]}),t.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!f||E,onClick:()=>Q(o.id),children:"Remove"})]},o.id)),O.length===0&&t.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]}),_&&t.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:_})]})]})]})})};function rt(){const[r,H]=d.useState(null),[x,h]=d.useState([]),[I,U]=d.useState({}),[m,P]=d.useState(null),[w,$]=d.useState([]),[E,T]=d.useState({}),[_,D]=d.useState([]),[y,g]=d.useState({}),[A,f]=d.useState({}),[j,O]=d.useState({}),[C,L]=d.useState({}),[te,Q]=d.useState(null),o=_e.useRef(null),[u,N]=d.useState("Pending"),[q,Ne]=d.useState({}),[W,ne]=d.useState({}),[et,tt]=d.useState({}),[z,J]=d.useState({}),[se,K]=d.useState({}),[ie,ae]=d.useState({}),[oe,B]=d.useState({}),[we,ce]=d.useState([]),[de,re]=d.useState([]),[le,me]=d.useState({}),[X,Y]=d.useState({}),[Ce,ue]=d.useState(!1),[M,xe]=d.useState(null),[G,be]=d.useState({}),v=Qe();d.useEffect(()=>{try{const e=localStorage.getItem("currentUser");e&&H(JSON.parse(e))}catch{}},[]),d.useEffect(()=>{Be().then(e=>h(e)).catch(()=>h([])),Ve().then(e=>D(e)).catch(()=>D([]))},[]),d.useEffect(()=>{r!=null&&r.installationId&&(fe().then(e=>{const n=e.find(s=>s.id===r.installationId);P(n||null)}).catch(()=>P(null)),je().then(e=>$(e)).catch(()=>$([])))},[r]),d.useEffect(()=>{We().then(ce).catch(()=>ce([])),ze().then(re).catch(()=>re([]))},[]);const Z=d.useMemo(()=>{const e={};for(const n of w)e[n.id]=n;return e},[w]),ee=e=>_.filter(n=>String(n.requestId||"")===String(e)),Ie=e=>Z[e.uploadedById],Ae=e=>{const n=Ie(e);return n?`${n.rank||""} ${n.lastName||""}, ${n.firstName||""}${n.mi?` ${n.mi}`:""}`.trim():""},Re=e=>`"${String(e??"").replace(/"/g,'""')}"`,pe=e=>{const s=[["Request ID","Subject","Stage","Installation Section","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const c of e){const i=ee(c.id).map(l=>l.name).join(" | ");s.push([c.id,c.subject,c.currentStage||"",c.routeSection||"",c.routeSection||"",Ae(c),c.unitUic||"",new Date(c.createdAt).toLocaleString(),i])}return s.map(c=>c.map(Re).join(",")).join(`\r
`)},ge=(e,n)=>{const s=new Blob([n],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(s),i=document.createElement("a");i.href=c,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(c)},ke=()=>ge("installation_section_pending.csv",pe(he)),Ee=()=>ge("installation_section_previous.csv",pe(ve)),De=async e=>{const n=A[e.id]||[];if(!n.length)return;const s=(r==null?void 0:r.id)||"",c=e.unitUic||"",i=n.map(a=>({id:`doc-${Date.now()}-${Math.random().toString(16).slice(2)}`,name:a.name,type:a.type||"application/octet-stream",size:a.size,uploadedAt:new Date,category:"ATTACHMENT",tags:[],unitUic:c,subject:e.subject,notes:y[e.id]||void 0,uploadedById:s,currentStage:e.currentStage,requestId:e.id,fileUrl:void 0})),{ok:l}=await Je(i);l?(D(a=>[...i,...a]),f(a=>({...a,[e.id]:[]}))):v.error("Failed to save files")},V=d.useMemo(()=>{if(!m||!(r!=null&&r.id))return[];const e=m.sectionAssignments||{};return Object.entries(e).filter(([,s])=>Array.isArray(s)&&s.includes(r.id)).map(([s])=>String(s))},[m,r]),Me=d.useMemo(()=>{if(!m||!(r!=null&&r.id))return!1;if(r.isInstallationAdmin)return!0;const e=m.sectionAssignments||{};return Object.values(e).some(n=>Array.isArray(n)&&n.includes(r.id))},[m,r]),he=d.useMemo(()=>{const e=(r==null?void 0:r.installationId)||"",n=new Set(V.map(s=>s.toUpperCase()));return x.filter(s=>s.currentStage==="INSTALLATION_REVIEW"&&s.installationId===e&&s.routeSection&&n.has(String(s.routeSection||"").toUpperCase()))},[x,r,V]),ve=d.useMemo(()=>{const e=(r==null?void 0:r.installationId)||"",n=new Set(V.map(s=>s.toUpperCase()));return x.filter(s=>s.installationId===e&&(s.currentStage!=="INSTALLATION_REVIEW"||!(s.routeSection&&n.has(String(s.routeSection||"").toUpperCase()))))},[x,r,V]),Ue=async(e,n)=>{const s=k(r,"Installation Section"),c=(n||"").trim()||e.routeSection||"",i={actor:s,timestamp:new Date().toISOString(),action:`Restored to installation section${c?`: ${c}`:""}`},l={...e,currentStage:"INSTALLATION_REVIEW",finalStatus:void 0,routeSection:c,activity:[...e.activity||[],i]};try{await R(l),h(a=>a.map(p=>p.id===e.id?l:p))}catch(a){console.error("InstallationSectionDashboard - Failed to restore:",a),v.error("Failed to restore to section")}},$e=async e=>{const n=E[e.id]||"";if(!n.trim())return;const s=k(r,"Installation Section"),c=e.routeSection||"",i={actor:s,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Approved and routed to Installation Command: ${n}${c?` (from ${c})`:""}`,comment:(y[e.id]||"").trim(),fromSection:c||void 0,toSection:n},l={...e,routeSection:n,activity:[...e.activity||[],i]};try{await R(l),h(a=>a.map(p=>p.id===e.id?l:p)),g(a=>({...a,[e.id]:""})),T(a=>({...a,[e.id]:""}))}catch(a){console.error("Failed to route to installation command section:",a),v.error("Failed to route to installation command section")}},Te=async e=>{const n=G[e.id]||"";if(!n.trim())return;const s=k(r,"Installation Section"),c=e.routeSection||"",i={actor:s,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Reassigned to installation section: ${n}${c?` (from ${c})`:""}`,comment:(y[e.id]||"").trim(),fromSection:c||void 0,toSection:n},l={...e,routeSection:n,activity:[...e.activity||[],i]};try{await R(l),h(a=>a.map(p=>p.id===e.id?l:p)),g(a=>({...a,[e.id]:""})),be(a=>({...a,[e.id]:""}))}catch(a){console.error("Failed to reassign to installation section:",a),v.error("Failed to reassign to installation section")}},Oe=async e=>{const n=k(r,"Installation Section"),s=e.routeSection||"",c={actor:n,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:"Returned to originating unit (Battalion)",comment:(y[e.id]||"").trim(),fromSection:s||void 0,toSection:"BATTALION_REVIEW"},i={...e,currentStage:"BATTALION_REVIEW",installationId:null,routeSection:"",activity:[...e.activity||[],c]};try{await R(i),h(l=>l.map(a=>a.id===e.id?i:a)),g(l=>({...l,[e.id]:""}))}catch(l){console.error("Failed to return to unit:",l),v.error("Failed to return to unit")}},Le=(e,n)=>{if(!n){J(i=>({...i,[e]:""})),K(i=>({...i,[e]:""})),ae(i=>({...i,[e]:[]})),B(i=>({...i,[e]:""}));return}const s=n.uic;J(i=>({...i,[e]:s})),K(i=>({...i,[e]:n.unitName}));let c=[];try{const i=localStorage.getItem("unit_structure");if(i){const a=JSON.parse(i)[s],p=a!=null&&a._sections&&Array.isArray(a._sections)?a._sections:[],b=a!=null&&a._commandSections&&Array.isArray(a._commandSections)?a._commandSections:[];c=[...p,...b]}}catch(i){console.error("InstallationSectionDashboard - Failed to load unit sections:",i)}ae(i=>({...i,[e]:c})),B(i=>({...i,[e]:""}))},Fe=async e=>{const n=k(r,"Installation Section"),s=z[e.id]||"",c=se[e.id]||"",i=oe[e.id]||"";if(!s.trim()){v.warning("Please select an external unit");return}const l=e.routeSection||"",a={actor:n,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:i?`Sent to external unit: ${c} - ${i}`:`Sent to external unit: ${c}`,comment:(y[e.id]||"").trim(),fromSection:l||void 0,toSection:i||c},p={...e,currentStage:"EXTERNAL_REVIEW",externalPendingUnitName:c,externalPendingUnitUic:s,externalPendingStage:i||void 0,routeSection:i||"",activity:[...e.activity||[],a]};try{await R(p),h(b=>b.map(F=>F.id===e.id?p:F)),g(b=>({...b,[e.id]:""})),ne(b=>({...b,[e.id]:!1})),J(b=>({...b,[e.id]:""})),K(b=>({...b,[e.id]:""})),B(b=>({...b,[e.id]:""}))}catch(b){console.error("Failed to send to external unit:",b),v.error("Failed to send to external unit")}},He=async e=>{const n=k(r,"Installation Section"),s=le[e.id]||"",c=X[e.id]||"";if(!s){v.warning("Select HQMC division");return}if(de.some(S=>String(S.division_code||"")===s)&&!c){v.warning("Select HQMC section");return}const l=e.routeSection||"",a=c||s,p=c?`Submitted to HQMC: ${s} - ${c}`:`Submitted to HQMC: ${s}`,b={actor:n,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:p,comment:(y[e.id]||"").trim(),fromSection:l||void 0,toSection:a},F={...e,currentStage:"HQMC_REVIEW",routeSection:a,activity:[...e.activity||[],b]};try{await R(F),h(S=>S.map(Se=>Se.id===e.id?F:Se)),g(S=>({...S,[e.id]:""})),me(S=>({...S,[e.id]:""})),Y(S=>({...S,[e.id]:""}))}catch(S){console.error("Failed to submit to HQMC:",S),v.error("Failed to submit to HQMC")}},Pe=async e=>{const s={actor:k(r,"Installation Section"),actorRole:"Installation Section",timestamp:new Date().toISOString(),action:"Archived by Installation Section",comment:(y[e.id]||"").trim()},c={...e,currentStage:"ARCHIVED",finalStatus:"Archived",activity:[...e.activity||[],s]};try{await R(c),h(i=>i.map(l=>l.id===e.id?c:l)),g(i=>({...i,[e.id]:""}))}catch(i){console.error("Failed to archive request:",i),v.error("Failed to archive request")}};return t.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[t.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Installation Section Dashboard"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"text-sm text-[var(--muted)]",children:(m==null?void 0:m.name)||""}),Me&&t.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>ue(!0),children:"Manage Section Access"})]})]}),t.jsx("div",{className:"border-b border-gray-200 mb-4",children:t.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[t.jsx("button",{onClick:()=>N("Pending"),className:`${u==="Pending"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),t.jsx("button",{onClick:()=>N("Previously in Section"),className:`${u==="Previously in Section"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Previously in Section"})]})}),u==="Pending"&&t.jsx(ye,{title:"Assigned to My Sections",titleActions:t.jsx(t.Fragment,{children:t.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:ke,children:"Export Pending"})}),requests:he,users:Z,variant:"installation",onRowClick:e=>U(n=>({...n,[e.id]:!n[e.id]})),expandedRows:I,children:e=>t.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[t.jsx("div",{className:"mt-3",children:t.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!j[e.id],"aria-controls":`docs-inst-${e.id}`,onClick:()=>{O(n=>({...n,[e.id]:!n[e.id]})),Q(n=>j[e.id]?null:e.id)},onKeyDown:n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),O(s=>({...s,[e.id]:!s[e.id]})),Q(s=>j[e.id]?null:e.id))},children:[t.jsx("span",{children:"Show Documents"}),t.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${j[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:t.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),t.jsx("div",{id:`docs-inst-${e.id}`,ref:j[e.id]?o:void 0,className:`${j[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:t.jsx(Ye,{documents:ee(e.id),showIcons:!0,onPreview:n=>xe(ee(e.id).find(s=>s.id===n.id)||null)})}),t.jsxs("div",{className:"mt-3",children:[t.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>L(n=>({...n,[e.id]:!n[e.id]})),"aria-expanded":!!C[e.id],"aria-controls":`logs-inst-${e.id}`,children:[C[e.id]?"Hide":"Show"," Activity Log"]}),t.jsx("div",{id:`logs-inst-${e.id}`,className:C[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((n,s)=>t.jsxs("div",{className:"text-xs text-gray-700",children:[t.jsxs("div",{className:"font-medium",children:[n.actor," • ",new Date(n.timestamp).toLocaleString()," • ",n.action]}),n.comment&&t.jsx("div",{className:"text-gray-600",children:n.comment})]},s)):t.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),t.jsxs("div",{className:"mt-3",children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),t.jsx("textarea",{rows:2,value:y[e.id]||"",onChange:n=>g(s=>({...s,[e.id]:n.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),t.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[t.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 text-sm rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[t.jsx("input",{type:"file",multiple:!0,onChange:n=>f(s=>({...s,[e.id]:n.target.files?Array.from(n.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),t.jsx("span",{className:"text-xs text-[var(--muted)]",children:(A[e.id]||[]).length?`${(A[e.id]||[]).length} file(s) selected`:"No files selected"}),(A[e.id]||[]).length>0&&t.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>De(e),children:"Save Files"})]}),t.jsxs("div",{className:"mt-4 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-3",children:"Routing Options"}),t.jsxs("div",{className:"mb-3 pb-3 border-b border-brand-navy/10",children:[t.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Approve to Installation Command Section"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsxs("select",{className:"flex-1 min-w-[200px] px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:E[e.id]||"",onChange:n=>T(s=>({...s,[e.id]:n.target.value})),children:[t.jsx("option",{value:"",children:"Select command section..."}),((m==null?void 0:m.commandSections)||[]).map(n=>t.jsx("option",{value:n,children:n},n))]}),t.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>$e(e),disabled:!E[e.id],children:"Approve to Command"})]})]}),t.jsxs("div",{className:"mb-3 pb-3 border-b border-brand-navy/10",children:[t.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Reassign to Another Installation Section"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsxs("select",{className:"flex-1 min-w-[200px] px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:G[e.id]||"",onChange:n=>be(s=>({...s,[e.id]:n.target.value})),children:[t.jsx("option",{value:"",children:"Select installation section..."}),((m==null?void 0:m.sections)||[]).filter(n=>n.toUpperCase()!==(e.routeSection||"").toUpperCase()).map(n=>t.jsx("option",{value:n,children:n},n))]}),t.jsx("button",{className:"px-4 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>Te(e),disabled:!G[e.id],children:"Reassign"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Return to Originating Unit"}),t.jsx("button",{className:"px-4 py-2 rounded bg-brand-navy text-brand-cream font-medium hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Oe(e),children:"Return to Battalion"}),t.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"Request will be returned to the originating unit's Unit Section Dashboard"})]})]}),(e.activity||[]).some(n=>/Endorsed by Installation Commander/i.test(String(n.action||"")))&&t.jsxs("div",{className:"mt-3 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Send Options (Post-Endorsement)"}),t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("div",{className:"pb-3 border-b border-brand-navy/10",children:[t.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer mb-2",children:[t.jsx("input",{type:"checkbox",id:`send-ext-inst-${e.id}`,checked:W[e.id]||!1,onChange:()=>{const n=!W[e.id];ne(s=>({...s,[e.id]:n}))},className:"rounded border-brand-navy/30"}),t.jsx("span",{className:"text-sm font-medium",children:"Send to External Unit"})]}),W[e.id]&&t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[t.jsx(Ke,{onUnitSelect:n=>Le(e.id,n),selectedUnit:{uic:z[e.id]||"",unitName:se[e.id]||""},placeholder:"Search by UIC, RUC, MCC, or Unit Name"}),t.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:oe[e.id]||"",onChange:n=>B(s=>({...s,[e.id]:n.target.value})),disabled:!(ie[e.id]||[]).length,children:[t.jsx("option",{value:"",children:"Select Section/Office (optional)"}),(ie[e.id]||[]).map(n=>t.jsx("option",{value:n,children:n},n))]}),t.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>Fe(e),disabled:!z[e.id],children:"Submit to External Unit"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-[var(--muted)] mb-2",children:"Submit to HQMC"}),(()=>{const n=le[e.id]||"",s=de.filter(l=>String(l.division_code||"")===n),c=s.length>0,i=n&&(c?!!X[e.id]:!0);return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[t.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:n,onChange:l=>{me(a=>({...a,[e.id]:l.target.value})),Y(a=>({...a,[e.id]:""}))},children:[t.jsx("option",{value:"",children:"Select HQMC Division"}),we.map(l=>t.jsxs("option",{value:l.code,children:[l.code," — ",l.name]},l.code))]}),c?t.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",value:X[e.id]||"",onChange:l=>Y(a=>({...a,[e.id]:l.target.value})),disabled:!n,children:[t.jsx("option",{value:"",children:"Select HQMC Section"}),s.map(l=>t.jsx("option",{value:l.branch,children:l.branch},l.branch))]}):n?t.jsx("div",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm bg-gray-100 text-gray-600 flex items-center",children:"No sections defined — submit to division"}):t.jsx("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",disabled:!0,children:t.jsx("option",{value:"",children:"Select HQMC Section"})})]}),t.jsx("div",{className:"mt-2",children:t.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>He(e),disabled:!i,children:"Submit to HQMC"})})]})})()]})]})]}),Xe(e,{userLevel:"installation",userInstallationId:r==null?void 0:r.installationId})&&t.jsx("div",{className:"mt-3 flex items-center justify-end gap-2",children:t.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Pe(e),children:"Archive"})})]})}),u==="Previously in Section"&&t.jsx(ye,{title:"Previously in Section",titleActions:t.jsx(t.Fragment,{children:t.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ee,children:"Export Previous"})}),requests:ve,users:Z,variant:"installation",onRowClick:e=>U(n=>({...n,[e.id]:!n[e.id]})),expandedRows:I,children:e=>t.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[t.jsxs("div",{className:"text-xs text-gray-600",children:["Last Status: ",new Date(e.activity&&e.activity.length?e.activity[e.activity.length-1].timestamp:e.createdAt).toLocaleString()]}),t.jsxs("div",{className:"mt-2",children:[t.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>L(n=>({...n,[e.id]:!n[e.id]})),"aria-expanded":!!C[e.id],"aria-controls":`logs-prev-inst-${e.id}`,children:[C[e.id]?"Hide":"Show"," Activity Log"]}),t.jsx("div",{id:`logs-prev-inst-${e.id}`,className:C[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((n,s)=>t.jsxs("div",{className:"text-xs text-gray-700",children:[t.jsxs("div",{className:"font-medium",children:[n.actor," • ",new Date(n.timestamp).toLocaleString()," • ",n.action]}),n.comment&&t.jsx("div",{className:"text-gray-600",children:n.comment})]},s)):t.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),t.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[t.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg",value:q[e.id]||"",onChange:n=>Ne(s=>({...s,[e.id]:n.target.value})),children:[t.jsx("option",{value:"",children:"Select installation section"}),((m==null?void 0:m.sections)||[]).map(n=>t.jsx("option",{value:n,children:n},n))]}),t.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>Ue(e,q[e.id]),children:"Restore to Section"})]})]})})]}),Ce&&r&&t.jsx(Ze,{currentUser:r,onClose:()=>ue(!1)}),M&&t.jsx(Ge,{fileName:M.name,url:M.fileUrl||"",mimeType:M.type||"",fileSize:M.size||0,isOpen:!!M,onClose:()=>xe(null)})]})}export{rt as default};
