import{r as c,j as n,R as Le}from"./index-nO-g3VHb.js";import{w as he,e as ge,y as Fe,c as Pe,l as He,k as _e,p as qe,f as Be,u as I}from"./db-B3Hb90W4.js";import{S as Qe}from"./SearchableUnitSelector-t7BSnjg0.js";import{R as pe,b as Ve}from"./RequestTable-cCWR_lot.js";import{a as We,D as ze}from"./DocumentListItem-BddRxRkx.js";import{f as C}from"./utils-CLmukD0c.js";import"./units-CaNgy_2U.js";const Je=({currentUser:d,onClose:T})=>{const[b,h]=c.useState(null),[N,E]=c.useState([]),[r,L]=c.useState(""),[f,D]=c.useState(""),[A,M]=c.useState(!1),[F,R]=c.useState("");c.useEffect(()=>{he().then(a=>{const m=a.find(S=>String(S.id)===String(d.installationId||""));h(m||null)}).catch(()=>h(null)),ge().then(a=>E(a)).catch(()=>E([]))},[]);const g=c.useMemo(()=>(b==null?void 0:b.sections)||[],[b]),p=c.useMemo(()=>(b==null?void 0:b.sectionAssignments)||{},[b]),w=String(d.id||""),v=c.useMemo(()=>{if(!b||!r)return!1;if(d.isInstallationAdmin)return!0;const a=p[r]||[];return Array.isArray(a)&&a.includes(w)},[b,r,p,w,d]),y=c.useMemo(()=>N.reduce((a,m)=>({...a,[m.id]:m}),{}),[N]),U=c.useMemo(()=>r?(p[r]||[]).map(m=>y[m]).filter(Boolean):[],[p,r,y]),j=c.useMemo(()=>{const a=Array.isArray(b==null?void 0:b.unitUics)?b.unitUics.map(String):[];return N.filter(m=>{if(m.id===d.id)return!1;const S=String(m.unitUic||"");return a.includes(S)})},[N,b,d]),$=async a=>{if(b){M(!0),R("");try{const m={...b,sectionAssignments:a};if(!(await Fe(m)).ok)throw new Error("persist_failed");h(m);try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:d.id,scope:{installationId:b.id,section:r},timestamp:new Date().toISOString(),event:"installation_section_assignments_updated"})})}catch{}}catch{R("Failed to persist installation assignments")}finally{M(!1)}}},Z=async()=>{if(!v||!r||!f)return;const a={...p},m=Array.isArray(a[r])?a[r]:[];m.includes(f)||m.push(f),a[r]=m,await $(a),D("")},P=async a=>{if(!v||!r||!a)return;const m={...p},S=Array.isArray(m[r])?m[r]:[];m[r]=S.filter(H=>H!==a),await $(m)};return n.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:T,children:n.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:a=>a.stopPropagation(),children:[n.jsxs("div",{className:"flex justify-between items-center mb-4",children:[n.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Installation Section Access"}),n.jsx("button",{className:"text-gray-500",onClick:T,children:"✕"})]}),n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),n.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:r,onChange:a=>L(a.target.value),children:[n.jsx("option",{value:"",children:"Select section"}),g.map(a=>n.jsx("option",{value:a,children:a},a))]})]}),r&&!v&&n.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You do not have permission to manage this section. Only installation admins or assigned section members can manage access."}),r&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User to Section"}),n.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:f,onChange:a=>D(a.target.value),disabled:!v,children:[n.jsx("option",{value:"",children:"Choose user"}),j.map(a=>n.jsxs("option",{value:a.id,children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""," • ",a.email]},a.id))]}),n.jsx("div",{className:"mt-2 flex justify-end",children:n.jsx("button",{className:"px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!v||!f||A,onClick:Z,children:"Add"})})]}),n.jsxs("div",{className:"mt-4",children:[n.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Members"}),n.jsxs("div",{className:"space-y-2",children:[U.map(a=>n.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[n.jsxs("div",{className:"text-sm text-gray-700",children:[a.rank," ",a.lastName,", ",a.firstName,a.mi?` ${a.mi}`:""," • ",a.email]}),n.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!v||A,onClick:()=>P(a.id),children:"Remove"})]},a.id)),U.length===0&&n.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]}),F&&n.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:F})]})]})]})})};function it(){const[d,T]=c.useState(null),[b,h]=c.useState([]),[N,E]=c.useState({}),[r,L]=c.useState(null),[f,D]=c.useState([]),[A,M]=c.useState({}),[F,R]=c.useState([]),[g,p]=c.useState({}),[w,v]=c.useState({}),[y,U]=c.useState({}),[j,$]=c.useState({}),[Z,P]=c.useState(null),a=Le.useRef(null),[m,S]=c.useState("Pending"),[H,ve]=c.useState({}),[Q,ee]=c.useState({}),[Ke,Xe]=c.useState({}),[V,W]=c.useState({}),[te,z]=c.useState({}),[ne,se]=c.useState({}),[ie,_]=c.useState({}),[ye,ae]=c.useState([]),[Se,oe]=c.useState([]),[O,ce]=c.useState({}),[J,K]=c.useState({}),[fe,de]=c.useState(!1),[k,le]=c.useState(null),[X,re]=c.useState({});c.useEffect(()=>{try{const e=localStorage.getItem("currentUser");e&&T(JSON.parse(e))}catch{}},[]),c.useEffect(()=>{Pe().then(e=>h(e)).catch(()=>h([])),He().then(e=>R(e)).catch(()=>R([]))},[]),c.useEffect(()=>{d!=null&&d.installationId&&(he().then(e=>{const t=e.find(s=>s.id===d.installationId);L(t||null)}).catch(()=>L(null)),ge().then(e=>D(e)).catch(()=>D([])))},[d]),c.useEffect(()=>{_e().then(ae).catch(()=>ae([])),qe().then(oe).catch(()=>oe([]))},[]);const Y=c.useMemo(()=>{const e={};for(const t of f)e[t.id]=t;return e},[f]),G=e=>F.filter(t=>String(t.requestId||"")===String(e)),je=e=>Y[e.uploadedById],Ne=e=>{const t=je(e);return t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}${t.mi?` ${t.mi}`:""}`.trim():""},we=e=>`"${String(e??"").replace(/"/g,'""')}"`,me=e=>{const s=[["Request ID","Subject","Stage","Installation Section","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const l of e){const i=G(l.id).map(x=>x.name).join(" | ");s.push([l.id,l.subject,l.currentStage||"",l.routeSection||"",l.routeSection||"",Ne(l),l.unitUic||"",new Date(l.createdAt).toLocaleString(),i])}return s.map(l=>l.map(we).join(",")).join(`\r
`)},ue=(e,t)=>{const s=new Blob([t],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(s),i=document.createElement("a");i.href=l,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(l)},Ie=()=>ue("installation_section_pending.csv",me(xe)),Ce=()=>ue("installation_section_previous.csv",me(be)),Ae=async e=>{const t=w[e.id]||[];if(!t.length)return;const s=(d==null?void 0:d.id)||"",l=e.unitUic||"",i=t.map(o=>({id:`doc-${Date.now()}-${Math.random().toString(16).slice(2)}`,name:o.name,type:o.type||"application/octet-stream",size:o.size,uploadedAt:new Date,category:"ATTACHMENT",tags:[],unitUic:l,subject:e.subject,notes:g[e.id]||void 0,uploadedById:s,currentStage:e.currentStage,requestId:e.id,fileUrl:void 0})),{ok:x}=await Be(i);x?(R(o=>[...i,...o]),v(o=>({...o,[e.id]:[]}))):alert("Failed to save files")},q=c.useMemo(()=>{if(!r||!(d!=null&&d.id))return[];const e=r.sectionAssignments||{};return Object.entries(e).filter(([,s])=>Array.isArray(s)&&s.includes(d.id)).map(([s])=>String(s))},[r,d]),Re=c.useMemo(()=>{if(!r||!(d!=null&&d.id))return!1;if(d.isInstallationAdmin)return!0;const e=r.sectionAssignments||{};return Object.values(e).some(t=>Array.isArray(t)&&t.includes(d.id))},[r,d]),xe=c.useMemo(()=>{const e=(d==null?void 0:d.installationId)||"",t=new Set(q.map(s=>s.toUpperCase()));return b.filter(s=>s.currentStage==="INSTALLATION_REVIEW"&&s.installationId===e&&s.routeSection&&t.has(String(s.routeSection||"").toUpperCase()))},[b,d,q]),be=c.useMemo(()=>{const e=(d==null?void 0:d.installationId)||"",t=new Set(q.map(s=>s.toUpperCase()));return b.filter(s=>s.installationId===e&&(s.currentStage!=="INSTALLATION_REVIEW"||!(s.routeSection&&t.has(String(s.routeSection||"").toUpperCase()))))},[b,d,q]),ke=async(e,t)=>{const s=C(d,"Installation Section"),l=(t||"").trim()||e.routeSection||"",i={actor:s,timestamp:new Date().toISOString(),action:`Restored to installation section${l?`: ${l}`:""}`},x={...e,currentStage:"INSTALLATION_REVIEW",finalStatus:void 0,routeSection:l,activity:[...e.activity||[],i]};try{await I(x),h(o=>o.map(u=>u.id===e.id?x:u))}catch(o){console.error("InstallationSectionDashboard - Failed to restore:",o),alert("Failed to restore to section")}},Ee=async e=>{const t=A[e.id]||"";if(!t.trim())return;const s=C(d,"Installation Section"),l=e.routeSection||"",i={actor:s,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Approved and routed to Installation Command: ${t}${l?` (from ${l})`:""}`,comment:(g[e.id]||"").trim()},x={...e,routeSection:t,activity:[...e.activity||[],i]};try{await I(x),h(o=>o.map(u=>u.id===e.id?x:u)),p(o=>({...o,[e.id]:""})),M(o=>({...o,[e.id]:""}))}catch(o){console.error("Failed to route to installation command section:",o),alert("Failed to route to installation command section")}},De=async e=>{const t=X[e.id]||"";if(!t.trim())return;const s=C(d,"Installation Section"),l=e.routeSection||"",i={actor:s,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Reassigned to installation section: ${t}${l?` (from ${l})`:""}`,comment:(g[e.id]||"").trim()},x={...e,routeSection:t,activity:[...e.activity||[],i]};try{await I(x),h(o=>o.map(u=>u.id===e.id?x:u)),p(o=>({...o,[e.id]:""})),re(o=>({...o,[e.id]:""}))}catch(o){console.error("Failed to reassign to installation section:",o),alert("Failed to reassign to installation section")}},Me=async e=>{const s={actor:C(d,"Installation Section"),actorRole:"Installation Section",timestamp:new Date().toISOString(),action:"Returned to originating unit (Battalion)",comment:(g[e.id]||"").trim()},l={...e,currentStage:"BATTALION_REVIEW",installationId:null,routeSection:"",activity:[...e.activity||[],s]};try{await I(l),h(i=>i.map(x=>x.id===e.id?l:x)),p(i=>({...i,[e.id]:""}))}catch(i){console.error("Failed to return to unit:",i),alert("Failed to return to unit")}},Ue=(e,t)=>{if(!t){W(i=>({...i,[e]:""})),z(i=>({...i,[e]:""})),se(i=>({...i,[e]:[]})),_(i=>({...i,[e]:""}));return}const s=t.uic;W(i=>({...i,[e]:s})),z(i=>({...i,[e]:t.unitName}));let l=[];try{const i=localStorage.getItem("unit_structure");if(i){const o=JSON.parse(i)[s],u=o!=null&&o._sections&&Array.isArray(o._sections)?o._sections:[],B=o!=null&&o._commandSections&&Array.isArray(o._commandSections)?o._commandSections:[];l=[...u,...B]}}catch(i){console.error("InstallationSectionDashboard - Failed to load unit sections:",i)}se(i=>({...i,[e]:l})),_(i=>({...i,[e]:""}))},$e=async e=>{const t=C(d,"Installation Section"),s=V[e.id]||"",l=te[e.id]||"",i=ie[e.id]||"";if(!s.trim()){alert("Please select an external unit");return}const x={actor:t,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:i?`Sent to external unit: ${l} - ${i}`:`Sent to external unit: ${l}`,comment:(g[e.id]||"").trim()},o={...e,currentStage:"EXTERNAL_REVIEW",externalPendingUnitName:l,externalPendingUnitUic:s,externalPendingStage:i||void 0,routeSection:i||"",activity:[...e.activity||[],x]};try{await I(o),h(u=>u.map(B=>B.id===e.id?o:B)),p(u=>({...u,[e.id]:""})),ee(u=>({...u,[e.id]:!1})),W(u=>({...u,[e.id]:""})),z(u=>({...u,[e.id]:""})),_(u=>({...u,[e.id]:""}))}catch(u){console.error("Failed to send to external unit:",u),alert("Failed to send to external unit")}},Oe=async e=>{const t=C(d,"Installation Section"),s=O[e.id]||"",l=J[e.id]||"";if(!s||!l){alert("Select HQMC division and section");return}const i={actor:t,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Submitted to HQMC: ${s} - ${l}`,comment:(g[e.id]||"").trim()},x={...e,currentStage:"HQMC_REVIEW",routeSection:l,activity:[...e.activity||[],i]};try{await I(x),h(o=>o.map(u=>u.id===e.id?x:u)),p(o=>({...o,[e.id]:""})),ce(o=>({...o,[e.id]:""})),K(o=>({...o,[e.id]:""}))}catch(o){console.error("Failed to submit to HQMC:",o),alert("Failed to submit to HQMC")}},Te=async e=>{const s={actor:C(d,"Installation Section"),actorRole:"Installation Section",timestamp:new Date().toISOString(),action:"Archived by Installation Section",comment:(g[e.id]||"").trim()},l={...e,currentStage:"ARCHIVED",finalStatus:"Archived",activity:[...e.activity||[],s]};try{await I(l),h(i=>i.map(x=>x.id===e.id?l:x)),p(i=>({...i,[e.id]:""}))}catch(i){console.error("Failed to archive request:",i),alert("Failed to archive request")}};return n.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[n.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Installation Section Dashboard"}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"text-sm text-[var(--muted)]",children:(r==null?void 0:r.name)||""}),Re&&n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>de(!0),children:"Manage Section Access"})]})]}),n.jsx("div",{className:"border-b border-gray-200 mb-4",children:n.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[n.jsx("button",{onClick:()=>S("Pending"),className:`${m==="Pending"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),n.jsx("button",{onClick:()=>S("Previously in Section"),className:`${m==="Previously in Section"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Previously in Section"})]})}),m==="Pending"&&n.jsx(pe,{title:"Assigned to My Sections",titleActions:n.jsx(n.Fragment,{children:n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ie,children:"Export Pending"})}),requests:xe,users:Y,variant:"installation",onRowClick:e=>E(t=>({...t,[e.id]:!t[e.id]})),expandedRows:N,children:e=>n.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[n.jsx("div",{className:"mt-3",children:n.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!y[e.id],"aria-controls":`docs-inst-${e.id}`,onClick:()=>{U(t=>({...t,[e.id]:!t[e.id]})),P(t=>y[e.id]?null:e.id)},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),U(s=>({...s,[e.id]:!s[e.id]})),P(s=>y[e.id]?null:e.id))},children:[n.jsx("span",{children:"Show Documents"}),n.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${y[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:n.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),n.jsx("div",{id:`docs-inst-${e.id}`,ref:y[e.id]?a:void 0,className:`${y[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:n.jsx(We,{documents:G(e.id),showIcons:!0,onPreview:t=>le(G(e.id).find(s=>s.id===t.id)||null)})}),n.jsxs("div",{className:"mt-3",children:[n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>$(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!j[e.id],"aria-controls":`logs-inst-${e.id}`,children:[j[e.id]?"Hide":"Show"," Activity Log"]}),n.jsx("div",{id:`logs-inst-${e.id}`,className:j[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,s)=>n.jsxs("div",{className:"text-xs text-gray-700",children:[n.jsxs("div",{className:"font-medium",children:[t.actor," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&n.jsx("div",{className:"text-gray-600",children:t.comment})]},s)):n.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),n.jsx("textarea",{rows:2,value:g[e.id]||"",onChange:t=>p(s=>({...s,[e.id]:t.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),n.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[n.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 text-sm rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[n.jsx("input",{type:"file",multiple:!0,onChange:t=>v(s=>({...s,[e.id]:t.target.files?Array.from(t.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),n.jsx("span",{className:"text-xs text-[var(--muted)]",children:(w[e.id]||[]).length?`${(w[e.id]||[]).length} file(s) selected`:"No files selected"}),(w[e.id]||[]).length>0&&n.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>Ae(e),children:"Save Files"})]}),n.jsxs("div",{className:"mt-4 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-3",children:"Routing Options"}),n.jsxs("div",{className:"mb-3 pb-3 border-b border-brand-navy/10",children:[n.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Approve to Installation Command Section"}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[n.jsxs("select",{className:"flex-1 min-w-[200px] px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:A[e.id]||"",onChange:t=>M(s=>({...s,[e.id]:t.target.value})),children:[n.jsx("option",{value:"",children:"Select command section..."}),((r==null?void 0:r.commandSections)||[]).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>Ee(e),disabled:!A[e.id],children:"Approve to Command"})]})]}),n.jsxs("div",{className:"mb-3 pb-3 border-b border-brand-navy/10",children:[n.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Reassign to Another Installation Section"}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[n.jsxs("select",{className:"flex-1 min-w-[200px] px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:X[e.id]||"",onChange:t=>re(s=>({...s,[e.id]:t.target.value})),children:[n.jsx("option",{value:"",children:"Select installation section..."}),((r==null?void 0:r.sections)||[]).filter(t=>t.toUpperCase()!==(e.routeSection||"").toUpperCase()).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-4 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>De(e),disabled:!X[e.id],children:"Reassign"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Return to Originating Unit"}),n.jsx("button",{className:"px-4 py-2 rounded bg-brand-navy text-brand-cream font-medium hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Me(e),children:"Return to Battalion"}),n.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"Request will be returned to the originating unit's Battalion Section Dashboard"})]})]}),(e.activity||[]).some(t=>/Endorsed by Installation Commander/i.test(String(t.action||"")))&&n.jsxs("div",{className:"mt-3 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Send Options (Post-Endorsement)"}),n.jsxs("div",{className:"flex flex-col gap-3",children:[n.jsxs("div",{className:"pb-3 border-b border-brand-navy/10",children:[n.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer mb-2",children:[n.jsx("input",{type:"checkbox",id:`send-ext-inst-${e.id}`,checked:Q[e.id]||!1,onChange:()=>{const t=!Q[e.id];ee(s=>({...s,[e.id]:t}))},className:"rounded border-brand-navy/30"}),n.jsx("span",{className:"text-sm font-medium",children:"Send to External Unit"})]}),Q[e.id]&&n.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[n.jsx(Qe,{onUnitSelect:t=>Ue(e.id,t),selectedUnit:{uic:V[e.id]||"",unitName:te[e.id]||""},placeholder:"Search by UIC, RUC, MCC, or Unit Name"}),n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:ie[e.id]||"",onChange:t=>_(s=>({...s,[e.id]:t.target.value})),disabled:!(ne[e.id]||[]).length,children:[n.jsx("option",{value:"",children:"Select Section/Office (optional)"}),(ne[e.id]||[]).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>$e(e),disabled:!V[e.id],children:"Submit to External Unit"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--muted)] mb-2",children:"Submit to HQMC"}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:O[e.id]||"",onChange:t=>{ce(s=>({...s,[e.id]:t.target.value})),K(s=>({...s,[e.id]:""}))},children:[n.jsx("option",{value:"",children:"Select HQMC Division"}),ye.map(t=>n.jsxs("option",{value:t.code,children:[t.code," — ",t.name]},t.code))]}),n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",value:J[e.id]||"",onChange:t=>K(s=>({...s,[e.id]:t.target.value})),disabled:!O[e.id],children:[n.jsx("option",{value:"",children:"Select HQMC Section"}),Se.filter(t=>String(t.division_code||"")===String(O[e.id]||"")).map(t=>n.jsx("option",{value:t.branch,children:t.branch},t.branch))]})]}),n.jsx("div",{className:"mt-2",children:n.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Oe(e),disabled:!(O[e.id]&&J[e.id]),children:"Submit to HQMC"})})]})]})]}),Ve(e,{userLevel:"installation",userInstallationId:d==null?void 0:d.installationId})&&n.jsx("div",{className:"mt-3 flex items-center justify-end gap-2",children:n.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Te(e),children:"Archive"})})]})}),m==="Previously in Section"&&n.jsx(pe,{title:"Previously in Section",titleActions:n.jsx(n.Fragment,{children:n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ce,children:"Export Previous"})}),requests:be,users:Y,variant:"installation",onRowClick:e=>E(t=>({...t,[e.id]:!t[e.id]})),expandedRows:N,children:e=>n.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[n.jsxs("div",{className:"text-xs text-gray-600",children:["Last Status: ",new Date(e.activity&&e.activity.length?e.activity[e.activity.length-1].timestamp:e.createdAt).toLocaleString()]}),n.jsxs("div",{className:"mt-2",children:[n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>$(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!j[e.id],"aria-controls":`logs-prev-inst-${e.id}`,children:[j[e.id]?"Hide":"Show"," Activity Log"]}),n.jsx("div",{id:`logs-prev-inst-${e.id}`,className:j[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,s)=>n.jsxs("div",{className:"text-xs text-gray-700",children:[n.jsxs("div",{className:"font-medium",children:[t.actor," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&n.jsx("div",{className:"text-gray-600",children:t.comment})]},s)):n.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),n.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg",value:H[e.id]||"",onChange:t=>ve(s=>({...s,[e.id]:t.target.value})),children:[n.jsx("option",{value:"",children:"Select installation section"}),((r==null?void 0:r.sections)||[]).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>ke(e,H[e.id]),children:"Restore to Section"})]})]})})]}),fe&&d&&n.jsx(Je,{currentUser:d,onClose:()=>de(!1)}),k&&n.jsx(ze,{fileName:k.name,url:k.fileUrl||"",mimeType:k.type||"",fileSize:k.size||0,isOpen:!!k,onClose:()=>le(null)})]})}export{it as default};
