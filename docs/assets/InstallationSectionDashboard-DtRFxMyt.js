import{r as c,j as n,R as Qe}from"./index-CWnyyP5W.js";import{w as he,e as ge,y as Pe,c as _e,l as qe,k as Be,p as Ve,f as We,u as I}from"./db-CQ7ObEd-.js";import{S as ze}from"./SearchableUnitSelector-WSvyrwRr.js";import{R as pe,b as Je}from"./RequestTable-B1rDEPMu.js";import{a as Ke,D as Xe}from"./DocumentListItem-B77xmDTw.js";import{f as A}from"./utils-CLmukD0c.js";import"./units-CaNgy_2U.js";const Ye=({currentUser:d,onClose:T})=>{const[x,p]=c.useState(null),[C,$]=c.useState([]),[r,F]=c.useState(""),[f,U]=c.useState(""),[R,H]=c.useState(!1),[Q,k]=c.useState("");c.useEffect(()=>{he().then(o=>{const u=o.find(y=>String(y.id)===String(d.installationId||""));p(u||null)}).catch(()=>p(null)),ge().then(o=>$(o)).catch(()=>$([]))},[]);const h=c.useMemo(()=>(x==null?void 0:x.sections)||[],[x]),b=c.useMemo(()=>(x==null?void 0:x.sectionAssignments)||{},[x]),w=String(d.id||""),v=c.useMemo(()=>{if(!x||!r)return!1;if(d.isInstallationAdmin)return!0;const o=b[r]||[];return Array.isArray(o)&&o.includes(w)},[x,r,b,w,d]),S=c.useMemo(()=>C.reduce((o,u)=>({...o,[u.id]:u}),{}),[C]),O=c.useMemo(()=>r?(b[r]||[]).map(u=>S[u]).filter(Boolean):[],[b,r,S]),j=c.useMemo(()=>{const o=Array.isArray(x==null?void 0:x.unitUics)?x.unitUics.map(String):[];return C.filter(u=>{if(u.id===d.id)return!1;const y=String(u.unitUic||"");return o.includes(y)})},[C,x,d]),L=async o=>{if(x){H(!0),k("");try{const u={...x,sectionAssignments:o};if(!(await Pe(u)).ok)throw new Error("persist_failed");p(u);try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:d.id,scope:{installationId:x.id,section:r},timestamp:new Date().toISOString(),event:"installation_section_assignments_updated"})})}catch{}}catch{k("Failed to persist installation assignments")}finally{H(!1)}}},G=async()=>{if(!v||!r||!f)return;const o={...b},u=Array.isArray(o[r])?o[r]:[];u.includes(f)||u.push(f),o[r]=u,await L(o),U("")},P=async o=>{if(!v||!r||!o)return;const u={...b},y=Array.isArray(u[r])?u[r]:[];u[r]=y.filter(_=>_!==o),await L(u)};return n.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:T,children:n.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:o=>o.stopPropagation(),children:[n.jsxs("div",{className:"flex justify-between items-center mb-4",children:[n.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Installation Section Access"}),n.jsx("button",{className:"text-gray-500",onClick:T,children:"✕"})]}),n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),n.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:r,onChange:o=>F(o.target.value),children:[n.jsx("option",{value:"",children:"Select section"}),h.map(o=>n.jsx("option",{value:o,children:o},o))]})]}),r&&!v&&n.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You do not have permission to manage this section. Only installation admins or assigned section members can manage access."}),r&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User to Section"}),n.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:f,onChange:o=>U(o.target.value),disabled:!v,children:[n.jsx("option",{value:"",children:"Choose user"}),j.map(o=>n.jsxs("option",{value:o.id,children:[o.rank," ",o.lastName,", ",o.firstName,o.mi?` ${o.mi}`:""," • ",o.email]},o.id))]}),n.jsx("div",{className:"mt-2 flex justify-end",children:n.jsx("button",{className:"px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!v||!f||R,onClick:G,children:"Add"})})]}),n.jsxs("div",{className:"mt-4",children:[n.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Members"}),n.jsxs("div",{className:"space-y-2",children:[O.map(o=>n.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[n.jsxs("div",{className:"text-sm text-gray-700",children:[o.rank," ",o.lastName,", ",o.firstName,o.mi?` ${o.mi}`:""," • ",o.email]}),n.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!v||R,onClick:()=>P(o.id),children:"Remove"})]},o.id)),O.length===0&&n.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]}),Q&&n.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:Q})]})]})]})})};function ct(){const[d,T]=c.useState(null),[x,p]=c.useState([]),[C,$]=c.useState({}),[r,F]=c.useState(null),[f,U]=c.useState([]),[R,H]=c.useState({}),[Q,k]=c.useState([]),[h,b]=c.useState({}),[w,v]=c.useState({}),[S,O]=c.useState({}),[j,L]=c.useState({}),[G,P]=c.useState(null),o=Qe.useRef(null),[u,y]=c.useState("Pending"),[_,ve]=c.useState({}),[M,q]=c.useState({}),[Ge,Ze]=c.useState({}),[z,Z]=c.useState({}),[ee,te]=c.useState({}),[ne,se]=c.useState({}),[ie,J]=c.useState({}),[Se,ae]=c.useState([]),[ye,oe]=c.useState([]),[E,fe]=c.useState({}),[B,ce]=c.useState({}),[N,V]=c.useState({}),[je,de]=c.useState(!1),[D,le]=c.useState(null),[K,re]=c.useState({});c.useEffect(()=>{try{const e=localStorage.getItem("currentUser");e&&T(JSON.parse(e))}catch{}},[]),c.useEffect(()=>{_e().then(e=>p(e)).catch(()=>p([])),qe().then(e=>k(e)).catch(()=>k([]))},[]),c.useEffect(()=>{d!=null&&d.installationId&&(he().then(e=>{const t=e.find(s=>s.id===d.installationId);F(t||null)}).catch(()=>F(null)),ge().then(e=>U(e)).catch(()=>U([])))},[d]),c.useEffect(()=>{Be().then(ae).catch(()=>ae([])),Ve().then(oe).catch(()=>oe([]))},[]);const X=c.useMemo(()=>{const e={};for(const t of f)e[t.id]=t;return e},[f]),Y=e=>Q.filter(t=>String(t.requestId||"")===String(e)),Ne=e=>X[e.uploadedById],Ce=e=>{const t=Ne(e);return t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}${t.mi?` ${t.mi}`:""}`.trim():""},we=e=>`"${String(e??"").replace(/"/g,'""')}"`,me=e=>{const s=[["Request ID","Subject","Stage","Installation Section","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const i of e){const a=Y(i.id).map(m=>m.name).join(" | ");s.push([i.id,i.subject,i.currentStage||"",i.routeSection||"",i.routeSection||"",Ce(i),i.unitUic||"",new Date(i.createdAt).toLocaleString(),a])}return s.map(i=>i.map(we).join(",")).join(`\r
`)},ue=(e,t)=>{const s=new Blob([t],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(s),a=document.createElement("a");a.href=i,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)},Ie=()=>ue("installation_section_pending.csv",me(xe)),Ae=()=>ue("installation_section_previous.csv",me(be)),Re=async e=>{const t=w[e.id]||[];if(!t.length)return;const s=(d==null?void 0:d.id)||"",i=e.unitUic||"",a=t.map(l=>({id:`doc-${Date.now()}-${Math.random().toString(16).slice(2)}`,name:l.name,type:l.type||"application/octet-stream",size:l.size,uploadedAt:new Date,category:"ATTACHMENT",tags:[],unitUic:i,subject:e.subject,notes:h[e.id]||void 0,uploadedById:s,currentStage:e.currentStage,requestId:e.id,fileUrl:void 0})),{ok:m}=await We(a);m?(k(l=>[...a,...l]),v(l=>({...l,[e.id]:[]}))):alert("Failed to save files")},W=c.useMemo(()=>{if(!r||!(d!=null&&d.id))return[];const e=r.sectionAssignments||{};return Object.entries(e).filter(([,s])=>Array.isArray(s)&&s.includes(d.id)).map(([s])=>String(s))},[r,d]),ke=c.useMemo(()=>{if(!r||!(d!=null&&d.id))return!1;if(d.isInstallationAdmin)return!0;const e=r.sectionAssignments||{};return Object.values(e).some(t=>Array.isArray(t)&&t.includes(d.id))},[r,d]),xe=c.useMemo(()=>{const e=(d==null?void 0:d.installationId)||"",t=new Set(W.map(s=>s.toUpperCase()));return x.filter(s=>s.currentStage==="INSTALLATION_REVIEW"&&s.installationId===e&&s.routeSection&&t.has(String(s.routeSection||"").toUpperCase()))},[x,d,W]),be=c.useMemo(()=>{const e=(d==null?void 0:d.installationId)||"",t=new Set(W.map(s=>s.toUpperCase()));return x.filter(s=>s.installationId===e&&(s.currentStage!=="INSTALLATION_REVIEW"||!(s.routeSection&&t.has(String(s.routeSection||"").toUpperCase()))))},[x,d,W]),Me=async(e,t)=>{const s=A(d,"Installation Section"),i=(t||"").trim()||e.routeSection||"",a={actor:s,timestamp:new Date().toISOString(),action:`Restored to installation section${i?`: ${i}`:""}`},m={...e,currentStage:"INSTALLATION_REVIEW",finalStatus:void 0,routeSection:i,activity:[...e.activity||[],a]};try{await I(m),p(l=>l.map(g=>g.id===e.id?m:g))}catch(l){console.error("InstallationSectionDashboard - Failed to restore:",l),alert("Failed to restore to section")}},Ee=async e=>{const t=R[e.id]||"";if(!t.trim())return;const s=A(d,"Installation Section"),i=e.routeSection||"",a={actor:s,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Approved and routed to Installation Command: ${t}${i?` (from ${i})`:""}`,comment:(h[e.id]||"").trim()},m={...e,routeSection:t,activity:[...e.activity||[],a]};try{await I(m),p(l=>l.map(g=>g.id===e.id?m:g)),b(l=>({...l,[e.id]:""})),H(l=>({...l,[e.id]:""}))}catch(l){console.error("Failed to route to installation command section:",l),alert("Failed to route to installation command section")}},De=async e=>{const t=K[e.id]||"";if(!t.trim())return;const s=A(d,"Installation Section"),i=e.routeSection||"",a={actor:s,actorRole:"Installation Section",timestamp:new Date().toISOString(),action:`Reassigned to installation section: ${t}${i?` (from ${i})`:""}`,comment:(h[e.id]||"").trim()},m={...e,routeSection:t,activity:[...e.activity||[],a]};try{await I(m),p(l=>l.map(g=>g.id===e.id?m:g)),b(l=>({...l,[e.id]:""})),re(l=>({...l,[e.id]:""}))}catch(l){console.error("Failed to reassign to installation section:",l),alert("Failed to reassign to installation section")}},$e=async e=>{const s={actor:A(d,"Installation Section"),actorRole:"Installation Section",timestamp:new Date().toISOString(),action:"Returned to originating unit (Battalion)",comment:(h[e.id]||"").trim()},i={...e,currentStage:"BATTALION_REVIEW",installationId:null,routeSection:"",activity:[...e.activity||[],s]};try{await I(i),p(a=>a.map(m=>m.id===e.id?i:m)),b(a=>({...a,[e.id]:""}))}catch(a){console.error("Failed to return to unit:",a),alert("Failed to return to unit")}},Ue=(e,t)=>{if(!t){Z(a=>({...a,[e]:""})),te(a=>({...a,[e]:""})),se(a=>({...a,[e]:[]})),J(a=>({...a,[e]:""}));return}const s=t.uic;Z(a=>({...a,[e]:s})),te(a=>({...a,[e]:t.unitName}));let i=[];try{const a=localStorage.getItem("unit_structure");if(a){const l=JSON.parse(a)[s],g=l!=null&&l._sections&&Array.isArray(l._sections)?l._sections:[],Fe=l!=null&&l._commandSections&&Array.isArray(l._commandSections)?l._commandSections:[];i=[...g,...Fe]}}catch(a){console.error("InstallationSectionDashboard - Failed to load unit sections:",a)}se(a=>({...a,[e]:i})),J(a=>({...a,[e]:""}))},He=async e=>{const t=A(d,"Installation Section");let s={...e};if(N[e.id]){const i=E[e.id]||"",a=B[e.id]||"";if(!i||!a){alert("Select HQMC division and section");return}const m={actor:t,timestamp:new Date().toISOString(),action:`Sent to HQMC: ${i} - ${a}`,comment:(h[e.id]||"").trim()};s={...e,currentStage:"HQMC_REVIEW",routeSection:a,activity:[...e.activity||[],m]}}else if(M[e.id]){const i=z[e.id]||"",a=ee[e.id]||"",m=ie[e.id]||"";if(!i.trim()){alert("Please select an external unit");return}const l={actor:t,timestamp:new Date().toISOString(),action:m?`Sent to external unit: ${a} - ${m}`:`Sent to external unit: ${a}`,comment:(h[e.id]||"").trim()};s={...e,currentStage:"EXTERNAL_REVIEW",externalPendingUnitName:a,externalPendingUnitUic:i,externalPendingStage:m||void 0,routeSection:m||"",activity:[...e.activity||[],l]}}else{alert("Select an option: External Unit or Submit to HQMC");return}try{await I(s),p(i=>i.map(a=>a.id===e.id?s:a)),b(i=>({...i,[e.id]:""})),q(i=>({...i,[e.id]:!1})),V(i=>({...i,[e.id]:!1}))}catch(i){console.error("InstallationSectionDashboard - Failed to route:",i),alert("Failed to route")}},Oe=e=>{const t=(e.activity||[]).slice().reverse();for(const s of t){const i=String(s.action||""),a=i.match(/Sent to HQMC:\s*([^\-]+)\s*-\s*(.+)/i);if(a)return a[2].trim();const m=i.match(/Submitted to HQMC Approver:\s*([^\-]+)\s*-\s*(.+)/i);if(m)return m[2].trim();const l=i.match(/Routed to HQMC section:\s*(.+)/i);if(l)return l[1].trim()}return String(e.routeSection||"")},Le=async e=>{const s={actor:A(d,"Installation Section"),actorRole:"Installation Section",timestamp:new Date().toISOString(),action:"Archived by Installation Section",comment:(h[e.id]||"").trim()},i={...e,currentStage:"ARCHIVED",finalStatus:"Archived",activity:[...e.activity||[],s]};try{await I(i),p(a=>a.map(m=>m.id===e.id?i:m)),b(a=>({...a,[e.id]:""}))}catch(a){console.error("Failed to archive request:",a),alert("Failed to archive request")}},Te=async e=>{const t=A(d,"Installation Section");let s={...e};if(N[e.id]){const i=E[e.id]||"",a=B[e.id]||"";if(!i||!a){alert("Select HQMC division and section");return}const m={actor:t,timestamp:new Date().toISOString(),action:`Submitted to HQMC Approver: ${i} - ${a}`,comment:(h[e.id]||"").trim()};s={...e,currentStage:"HQMC_REVIEW",routeSection:a,activity:[...e.activity||[],m]}}else{const i=Oe(e),a={actor:t,timestamp:new Date().toISOString(),action:i?`Submitted to HQMC Approver: ${i}`:"Submitted to HQMC Approver",comment:(h[e.id]||"").trim()};s={...e,currentStage:"HQMC_REVIEW",routeSection:i||e.routeSection,activity:[...e.activity||[],a]}}try{await I(s),p(i=>i.map(a=>a.id===e.id?s:a)),b(i=>({...i,[e.id]:""})),q(i=>({...i,[e.id]:!1})),V(i=>({...i,[e.id]:!1}))}catch(i){console.error("InstallationSectionDashboard - Failed to approve to HQMC:",i),alert("Failed to submit to HQMC approver")}};return n.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[n.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Installation Section Dashboard"}),n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"text-sm text-[var(--muted)]",children:(r==null?void 0:r.name)||""}),ke&&n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>de(!0),children:"Manage Section Access"})]})]}),n.jsx("div",{className:"border-b border-gray-200 mb-4",children:n.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[n.jsx("button",{onClick:()=>y("Pending"),className:`${u==="Pending"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),n.jsx("button",{onClick:()=>y("Previously in Section"),className:`${u==="Previously in Section"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Previously in Section"})]})}),u==="Pending"&&n.jsx(pe,{title:"Assigned to My Sections",titleActions:n.jsx(n.Fragment,{children:n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ie,children:"Export Pending"})}),requests:xe,users:X,variant:"installation",onRowClick:e=>$(t=>({...t,[e.id]:!t[e.id]})),expandedRows:C,children:e=>n.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[n.jsx("div",{className:"mt-3",children:n.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!S[e.id],"aria-controls":`docs-inst-${e.id}`,onClick:()=>{O(t=>({...t,[e.id]:!t[e.id]})),P(t=>S[e.id]?null:e.id)},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),O(s=>({...s,[e.id]:!s[e.id]})),P(s=>S[e.id]?null:e.id))},children:[n.jsx("span",{children:"Show Documents"}),n.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${S[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:n.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),n.jsx("div",{id:`docs-inst-${e.id}`,ref:S[e.id]?o:void 0,className:`${S[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:n.jsx(Ke,{documents:Y(e.id),showIcons:!0,onPreview:t=>le(Y(e.id).find(s=>s.id===t.id)||null)})}),n.jsxs("div",{className:"mt-3",children:[n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>L(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!j[e.id],"aria-controls":`logs-inst-${e.id}`,children:[j[e.id]?"Hide":"Show"," Activity Log"]}),n.jsx("div",{id:`logs-inst-${e.id}`,className:j[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,s)=>n.jsxs("div",{className:"text-xs text-gray-700",children:[n.jsxs("div",{className:"font-medium",children:[t.actor," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&n.jsx("div",{className:"text-gray-600",children:t.comment})]},s)):n.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),n.jsx("textarea",{rows:2,value:h[e.id]||"",onChange:t=>b(s=>({...s,[e.id]:t.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),n.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-2",children:[n.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 text-sm rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[n.jsx("input",{type:"file",multiple:!0,onChange:t=>v(s=>({...s,[e.id]:t.target.files?Array.from(t.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),n.jsx("span",{className:"text-xs text-[var(--muted)]",children:(w[e.id]||[]).length?`${(w[e.id]||[]).length} file(s) selected`:"No files selected"}),(w[e.id]||[]).length>0&&n.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>Re(e),children:"Save Files"})]}),n.jsxs("div",{className:"mt-4 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-3",children:"Routing Options"}),n.jsxs("div",{className:"mb-3 pb-3 border-b border-brand-navy/10",children:[n.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Approve to Installation Command Section"}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[n.jsxs("select",{className:"flex-1 min-w-[200px] px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:R[e.id]||"",onChange:t=>H(s=>({...s,[e.id]:t.target.value})),children:[n.jsx("option",{value:"",children:"Select command section..."}),((r==null?void 0:r.commandSections)||[]).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>Ee(e),disabled:!R[e.id],children:"Approve to Command"})]})]}),n.jsxs("div",{className:"mb-3 pb-3 border-b border-brand-navy/10",children:[n.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Reassign to Another Installation Section"}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[n.jsxs("select",{className:"flex-1 min-w-[200px] px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:K[e.id]||"",onChange:t=>re(s=>({...s,[e.id]:t.target.value})),children:[n.jsx("option",{value:"",children:"Select installation section..."}),((r==null?void 0:r.sections)||[]).filter(t=>t.toUpperCase()!==(e.routeSection||"").toUpperCase()).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-4 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>De(e),disabled:!K[e.id],children:"Reassign"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"block text-xs font-medium text-[var(--muted)] mb-2",children:"Return to Originating Unit"}),n.jsx("button",{className:"px-4 py-2 rounded bg-brand-navy text-brand-cream font-medium hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>$e(e),children:"Return to Battalion"}),n.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"Request will be returned to the originating unit's Battalion Section Dashboard"})]})]}),(e.activity||[]).some(t=>/Endorsed by Installation Commander/i.test(String(t.action||"")))&&n.jsxs("div",{className:"mt-3 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Additional Send Options (Post-Endorsement)"}),n.jsxs("div",{className:"flex flex-col gap-2",children:[n.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[n.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",id:`send-ext-inst-${e.id}`,checked:M[e.id]||!1,onChange:()=>{const t=!M[e.id];q(s=>({...s,[e.id]:t})),t&&V(s=>({...s,[e.id]:!1}))},className:"rounded border-brand-navy/30"}),n.jsx("span",{className:"text-sm",children:"Send to External Unit"})]}),n.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer",children:[n.jsx("input",{type:"checkbox",id:`readdress-hqmc-inst-${e.id}`,checked:N[e.id]||!1,onChange:()=>{const t=!N[e.id];V(s=>({...s,[e.id]:t})),t&&q(s=>({...s,[e.id]:!1}))},className:"rounded border-brand-navy/30"}),n.jsx("span",{className:"text-sm",children:"Readdress to HQMC Section"})]})]}),M[e.id]&&n.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[n.jsx(ze,{onUnitSelect:t=>Ue(e.id,t),selectedUnit:{uic:z[e.id]||"",unitName:ee[e.id]||""},placeholder:"Search by UIC, RUC, MCC, or Unit Name"}),n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:ie[e.id]||"",onChange:t=>J(s=>({...s,[e.id]:t.target.value})),disabled:!(ne[e.id]||[]).length,children:[n.jsx("option",{value:"",children:"Select Section/Office (optional)"}),(ne[e.id]||[]).map(t=>n.jsx("option",{value:t,children:t},t))]})]}),N[e.id]&&n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 mt-2",children:[n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",value:E[e.id]||"",onChange:t=>{fe(s=>({...s,[e.id]:t.target.value})),ce(s=>({...s,[e.id]:""}))},children:[n.jsx("option",{value:"",children:"Select HQMC Division"}),Se.map(t=>n.jsxs("option",{value:t.code,children:[t.code," — ",t.name]},t.code))]}),n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",value:B[e.id]||"",onChange:t=>ce(s=>({...s,[e.id]:t.target.value})),disabled:!E[e.id],children:[n.jsx("option",{value:"",children:"Select HQMC Section"}),ye.filter(t=>String(t.division_code||"")===String(E[e.id]||"")).map(t=>n.jsx("option",{value:t.branch,children:t.branch},t.branch))]})]}),(M[e.id]||N[e.id])&&n.jsx("div",{className:"mt-2",children:n.jsx("button",{className:"px-4 py-2 rounded bg-brand-gold text-brand-charcoal font-medium hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>He(e),disabled:N[e.id]?!(E[e.id]&&B[e.id]):M[e.id]?!z[e.id]:!0,children:N[e.id]?"Submit to HQMC (Readdress)":"Submit to External Unit"})}),n.jsxs("div",{className:"mt-2 pt-2 border-t border-brand-navy/10",children:[n.jsx("button",{className:"px-4 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 font-medium hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Te(e),children:"Approve to HQMC"}),n.jsx("p",{className:"text-xs text-[var(--muted)] mt-1",children:"Submit to HQMC using the previously assigned section"})]})]})]}),Je(e,{userLevel:"installation",userInstallationId:d==null?void 0:d.installationId})&&n.jsx("div",{className:"mt-3 flex items-center justify-end gap-2",children:n.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Le(e),children:"Archive"})})]})}),u==="Previously in Section"&&n.jsx(pe,{title:"Previously in Section",titleActions:n.jsx(n.Fragment,{children:n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ae,children:"Export Previous"})}),requests:be,users:X,variant:"installation",onRowClick:e=>$(t=>({...t,[e.id]:!t[e.id]})),expandedRows:C,children:e=>n.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[n.jsxs("div",{className:"text-xs text-gray-600",children:["Last Status: ",new Date(e.activity&&e.activity.length?e.activity[e.activity.length-1].timestamp:e.createdAt).toLocaleString()]}),n.jsxs("div",{className:"mt-2",children:[n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>L(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!j[e.id],"aria-controls":`logs-prev-inst-${e.id}`,children:[j[e.id]?"Hide":"Show"," Activity Log"]}),n.jsx("div",{id:`logs-prev-inst-${e.id}`,className:j[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,s)=>n.jsxs("div",{className:"text-xs text-gray-700",children:[n.jsxs("div",{className:"font-medium",children:[t.actor," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&n.jsx("div",{className:"text-gray-600",children:t.comment})]},s)):n.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),n.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[n.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg",value:_[e.id]||"",onChange:t=>ve(s=>({...s,[e.id]:t.target.value})),children:[n.jsx("option",{value:"",children:"Select installation section"}),((r==null?void 0:r.sections)||[]).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>Me(e,_[e.id]),children:"Restore to Section"})]})]})})]}),je&&d&&n.jsx(Ye,{currentUser:d,onClose:()=>de(!1)}),D&&n.jsx(Xe,{fileName:D.name,url:D.fileUrl||"",mimeType:D.type||"",fileSize:D.size||0,isOpen:!!D,onClose:()=>le(null)})]})}export{ct as default};
