import{r as d,j as s,R as De}from"./index-MTHe0j9m.js";import{w as me,e as ue,y as He,c as Le,l as Oe,k as Qe,p as Te,f as Fe,u as P}from"./db-CTrWqmZ5.js";import{S as _e}from"./SearchableUnitSelector-XgY2Hjyk.js";import{R as re}from"./RequestTable-DHDltpGF.js";import{a as Pe}from"./DocumentListItem-Dq6WnYYr.js";import"./units-CaNgy_2U.js";const qe=({currentUser:i,onClose:R})=>{const[u,b]=d.useState(null),[N,M]=d.useState([]),[l,D]=d.useState(""),[y,k]=d.useState(""),[q,B]=d.useState(!1),[H,w]=d.useState("");d.useEffect(()=>{me().then(c=>{const r=c.find(S=>String(S.id)===String(i.installationId||""));b(r||null)}).catch(()=>b(null)),ue().then(c=>M(c)).catch(()=>M([]))},[]);const h=d.useMemo(()=>(u==null?void 0:u.sections)||[],[u]),p=d.useMemo(()=>(u==null?void 0:u.sectionAssignments)||{},[u]),f=String(i.id||""),g=d.useMemo(()=>{if(!u||!l)return!1;if(i.isInstallationAdmin)return!0;const c=p[l]||[];return Array.isArray(c)&&c.includes(f)},[u,l,p,f,i]),v=d.useMemo(()=>N.reduce((c,r)=>({...c,[r.id]:r}),{}),[N]),$=d.useMemo(()=>l?(p[l]||[]).map(r=>v[r]).filter(Boolean):[],[p,l,v]),j=d.useMemo(()=>{const c=Array.isArray(u==null?void 0:u.unitUics)?u.unitUics.map(String):[];return N.filter(r=>{if(r.id===i.id)return!1;const S=String(r.unitUic||"");return c.includes(S)})},[N,u,i]),E=async c=>{if(u){B(!0),w("");try{const r={...u,sectionAssignments:c};if(!(await He(r)).ok)throw new Error("persist_failed");b(r);try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:i.id,scope:{installationId:u.id,section:l},timestamp:new Date().toISOString(),event:"installation_section_assignments_updated"})})}catch{}}catch{w("Failed to persist installation assignments")}finally{B(!1)}}},J=async()=>{if(!g||!l||!y)return;const c={...p},r=Array.isArray(c[l])?c[l]:[];r.includes(y)||r.push(y),c[l]=r,await E(c),k("")},L=async c=>{if(!g||!l||!c)return;const r={...p},S=Array.isArray(r[l])?r[l]:[];r[l]=S.filter(O=>O!==c),await E(r)};return s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:R,children:s.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:c=>c.stopPropagation(),children:[s.jsxs("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Installation Section Access"}),s.jsx("button",{className:"text-gray-500",onClick:R,children:"✕"})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),s.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:l,onChange:c=>D(c.target.value),children:[s.jsx("option",{value:"",children:"Select section"}),h.map(c=>s.jsx("option",{value:c,children:c},c))]})]}),l&&!g&&s.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You do not have permission to manage this section. Only installation admins or assigned section members can manage access."}),l&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User to Section"}),s.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:y,onChange:c=>k(c.target.value),disabled:!g,children:[s.jsx("option",{value:"",children:"Choose user"}),j.map(c=>s.jsxs("option",{value:c.id,children:[c.rank," ",c.lastName,", ",c.firstName,c.mi?` ${c.mi}`:""," • ",c.email]},c.id))]}),s.jsx("div",{className:"mt-2 flex justify-end",children:s.jsx("button",{className:"px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!g||!y||q,onClick:J,children:"Add"})})]}),s.jsxs("div",{className:"mt-4",children:[s.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Members"}),s.jsxs("div",{className:"space-y-2",children:[$.map(c=>s.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[s.jsxs("div",{className:"text-sm text-gray-700",children:[c.rank," ",c.lastName,", ",c.firstName,c.mi?` ${c.mi}`:""," • ",c.email]}),s.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!g||q,onClick:()=>L(c.id),children:"Remove"})]},c.id)),$.length===0&&s.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]}),H&&s.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:H})]})]})]})})};function Xe(){const[i,R]=d.useState(null),[u,b]=d.useState([]),[N,M]=d.useState({}),[l,D]=d.useState(null),[y,k]=d.useState([]),[q,B]=d.useState({}),[H,w]=d.useState([]),[h,p]=d.useState({}),[f,g]=d.useState({}),[v,$]=d.useState({}),[j,E]=d.useState({}),[J,L]=d.useState(null),c=De.useRef(null),[r,S]=d.useState("Pending"),[O,xe]=d.useState({}),[I,Q]=d.useState({}),[Be,be]=d.useState({}),[U,K]=d.useState({}),[X,Y]=d.useState({}),[G,Z]=d.useState({}),[ee,W]=d.useState({}),[pe,te]=d.useState([]),[he,se]=d.useState([]),[A,ge]=d.useState({}),[T,ne]=d.useState({}),[C,V]=d.useState({}),[ve,ie]=d.useState(!1);d.useEffect(()=>{try{const e=localStorage.getItem("currentUser");e&&R(JSON.parse(e))}catch{}},[]),d.useEffect(()=>{Le().then(e=>b(e)).catch(()=>b([])),Oe().then(e=>w(e)).catch(()=>w([]))},[]),d.useEffect(()=>{i!=null&&i.installationId&&(me().then(e=>{const t=e.find(n=>n.id===i.installationId);D(t||null)}).catch(()=>D(null)),ue().then(e=>k(e)).catch(()=>k([])))},[i]),d.useEffect(()=>{Qe().then(te).catch(()=>te([])),Te().then(se).catch(()=>se([]))},[]);const z=d.useMemo(()=>{const e={};for(const t of y)e[t.id]=t;return e},[y]),ae=e=>H.filter(t=>String(t.requestId||"")===String(e)),Se=e=>z[e.uploadedById],ye=e=>{const t=Se(e);return t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}${t.mi?` ${t.mi}`:""}`.trim():""},fe=e=>`"${String(e??"").replace(/"/g,'""')}"`,oe=e=>{const n=[["Request ID","Subject","Stage","Installation Section","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const a of e){const o=ae(a.id).map(x=>x.name).join(" | ");n.push([a.id,a.subject,a.currentStage||"",a.routeSection||"",a.routeSection||"",ye(a),a.unitUic||"",new Date(a.createdAt).toLocaleString(),o])}return n.map(a=>a.map(fe).join(",")).join(`\r
`)},ce=(e,t)=>{const n=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)},je=()=>ce("installation_section_pending.csv",oe(de)),Ne=()=>ce("installation_section_previous.csv",oe(le)),Ce=async e=>{const t=f[e.id]||[];if(!t.length)return;const n=(i==null?void 0:i.id)||"",a=e.unitUic||"",o=t.map(m=>({id:`doc-${Date.now()}-${Math.random().toString(16).slice(2)}`,name:m.name,type:m.type||"application/octet-stream",size:m.size,uploadedAt:new Date,category:"ATTACHMENT",tags:[],unitUic:a,subject:e.subject,notes:h[e.id]||void 0,uploadedById:n,currentStage:e.currentStage,requestId:e.id,fileUrl:void 0})),{ok:x}=await Fe(o);x?(w(m=>[...o,...m]),g(m=>({...m,[e.id]:[]}))):alert("Failed to save files")},F=d.useMemo(()=>{if(!l||!(i!=null&&i.id))return[];const e=l.sectionAssignments||{};return Object.entries(e).filter(([,n])=>Array.isArray(n)&&n.includes(i.id)).map(([n])=>String(n))},[l,i]),we=d.useMemo(()=>{if(!l||!(i!=null&&i.id))return!1;if(i.isInstallationAdmin)return!0;const e=l.sectionAssignments||{};return Object.values(e).some(t=>Array.isArray(t)&&t.includes(i.id))},[l,i]),de=d.useMemo(()=>{const e=(i==null?void 0:i.installationId)||"",t=new Set(F.map(n=>n.toUpperCase()));return u.filter(n=>n.currentStage==="INSTALLATION_REVIEW"&&n.installationId===e&&n.routeSection&&t.has(String(n.routeSection||"").toUpperCase()))},[u,i,F]),le=d.useMemo(()=>{const e=(i==null?void 0:i.installationId)||"",t=new Set(F.map(n=>n.toUpperCase()));return u.filter(n=>n.installationId===e&&(n.currentStage!=="INSTALLATION_REVIEW"||!(n.routeSection&&t.has(String(n.routeSection||"").toUpperCase()))))},[u,i,F]),Ie=async(e,t)=>{const n=`${(i==null?void 0:i.rank)||""} ${(i==null?void 0:i.lastName)||""}, ${(i==null?void 0:i.firstName)||""}`.trim()||"Installation Section",a=(t||"").trim()||e.routeSection||"",o={actor:n,timestamp:new Date().toISOString(),action:`Restored to installation section${a?`: ${a}`:""}`},x={...e,currentStage:"INSTALLATION_REVIEW",finalStatus:void 0,routeSection:a,activity:[...e.activity||[],o]};try{await P(x),b(m=>m.map(_=>_.id===e.id?x:_))}catch(m){console.error("InstallationSectionDashboard - Failed to restore:",m),alert("Failed to restore to section")}},Ae=async e=>{const n={actor:`${(i==null?void 0:i.rank)||""} ${(i==null?void 0:i.lastName)||""}, ${(i==null?void 0:i.firstName)||""}`.trim()||"Installation Section",timestamp:new Date().toISOString(),action:"Returned to unit for corrections",comment:(h[e.id]||"").trim()},a={...e,currentStage:"BATTALION_REVIEW",installationId:null,routeSection:"",activity:[...e.activity||[],n]};try{await P(a),b(o=>o.map(x=>x.id===e.id?a:x))}catch(o){console.error("Failed to return to unit:",o),alert("Failed to return to unit")}},Me=(e,t)=>{if(!t){K(o=>({...o,[e]:""})),Y(o=>({...o,[e]:""})),Z(o=>({...o,[e]:[]})),W(o=>({...o,[e]:""}));return}const n=t.uic;K(o=>({...o,[e]:n})),Y(o=>({...o,[e]:t.unitName}));let a=[];try{const o=localStorage.getItem("unit_structure");if(o){const m=JSON.parse(o)[n],_=m!=null&&m._sections&&Array.isArray(m._sections)?m._sections:[],Re=m!=null&&m._commandSections&&Array.isArray(m._commandSections)?m._commandSections:[];a=[..._,...Re]}}catch(o){console.error("InstallationSectionDashboard - Failed to load unit sections:",o)}Z(o=>({...o,[e]:a})),W(o=>({...o,[e]:""}))},ke=async e=>{const t=`${(i==null?void 0:i.rank)||""} ${(i==null?void 0:i.lastName)||""}, ${(i==null?void 0:i.firstName)||""}`.trim()||"Installation Section";let n={...e};if(C[e.id]){const a=A[e.id]||"",o=T[e.id]||"";if(!a||!o){alert("Select HQMC division and section");return}const x={actor:t,timestamp:new Date().toISOString(),action:`Sent to HQMC: ${a} - ${o}`,comment:(h[e.id]||"").trim()};n={...e,currentStage:"HQMC_REVIEW",routeSection:o,activity:[...e.activity||[],x]}}else if(I[e.id]){const a=U[e.id]||"",o=X[e.id]||"",x=ee[e.id]||"";if(!a.trim()){alert("Please select an external unit");return}const m={actor:t,timestamp:new Date().toISOString(),action:x?`Sent to external unit: ${o} - ${x}`:`Sent to external unit: ${o}`,comment:(h[e.id]||"").trim()};n={...e,currentStage:"EXTERNAL_REVIEW",externalPendingUnitName:o,externalPendingUnitUic:a,externalPendingStage:x||void 0,routeSection:x||"",activity:[...e.activity||[],m]}}else{alert("Select an option: External Unit or Submit to HQMC");return}try{await P(n),b(a=>a.map(o=>o.id===e.id?n:o)),p(a=>({...a,[e.id]:""})),Q(a=>({...a,[e.id]:!1})),V(a=>({...a,[e.id]:!1}))}catch(a){console.error("InstallationSectionDashboard - Failed to route:",a),alert("Failed to route")}},$e=e=>{const t=(e.activity||[]).slice().reverse();for(const n of t){const a=String(n.action||""),o=a.match(/Sent to HQMC:\s*([^\-]+)\s*-\s*(.+)/i);if(o)return o[2].trim();const x=a.match(/Submitted to HQMC Approver:\s*([^\-]+)\s*-\s*(.+)/i);if(x)return x[2].trim();const m=a.match(/Routed to HQMC section:\s*(.+)/i);if(m)return m[1].trim()}return String(e.routeSection||"")},Ee=async e=>{const t=`${(i==null?void 0:i.rank)||""} ${(i==null?void 0:i.lastName)||""}, ${(i==null?void 0:i.firstName)||""}`.trim()||"Installation Section";let n={...e};if(C[e.id]){const a=A[e.id]||"",o=T[e.id]||"";if(!a||!o){alert("Select HQMC division and section");return}const x={actor:t,timestamp:new Date().toISOString(),action:`Submitted to HQMC Approver: ${a} - ${o}`,comment:(h[e.id]||"").trim()};n={...e,currentStage:"HQMC_REVIEW",routeSection:o,activity:[...e.activity||[],x]}}else{const a=$e(e),o={actor:t,timestamp:new Date().toISOString(),action:a?`Submitted to HQMC Approver: ${a}`:"Submitted to HQMC Approver",comment:(h[e.id]||"").trim()};n={...e,currentStage:"HQMC_REVIEW",routeSection:a||e.routeSection,activity:[...e.activity||[],o]}}try{await P(n),b(a=>a.map(o=>o.id===e.id?n:o)),p(a=>({...a,[e.id]:""})),Q(a=>({...a,[e.id]:!1})),V(a=>({...a,[e.id]:!1}))}catch(a){console.error("InstallationSectionDashboard - Failed to approve to HQMC:",a),alert("Failed to submit to HQMC approver")}};return s.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[s.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Installation Section Dashboard"}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"text-sm text-[var(--muted)]",children:(l==null?void 0:l.name)||""}),we&&s.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>ie(!0),children:"Manage Section Access"})]})]}),s.jsx("div",{className:"border-b border-gray-200 mb-4",children:s.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[s.jsx("button",{onClick:()=>S("Pending"),className:`${r==="Pending"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),s.jsx("button",{onClick:()=>S("Previously in Section"),className:`${r==="Previously in Section"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Previously in Section"})]})}),r==="Pending"&&s.jsx(re,{title:"Assigned to My Sections",titleActions:s.jsx(s.Fragment,{children:s.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:je,children:"Export Pending"})}),requests:de,users:z,variant:"installation",onRowClick:e=>M(t=>({...t,[e.id]:!t[e.id]})),expandedRows:N,children:e=>s.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[s.jsx("div",{className:"mt-3",children:s.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!v[e.id],"aria-controls":`docs-inst-${e.id}`,onClick:()=>{$(t=>({...t,[e.id]:!t[e.id]})),L(t=>v[e.id]?null:e.id)},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),$(n=>({...n,[e.id]:!n[e.id]})),L(n=>v[e.id]?null:e.id))},children:[s.jsx("span",{children:"Show Documents"}),s.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${v[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:s.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),s.jsx("div",{id:`docs-inst-${e.id}`,ref:v[e.id]?c:void 0,className:`${v[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:s.jsx(Pe,{documents:ae(e.id)})}),s.jsxs("div",{className:"mt-3",children:[s.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>E(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!j[e.id],"aria-controls":`logs-inst-${e.id}`,children:[j[e.id]?"Hide":"Show"," Activity Log"]}),s.jsx("div",{id:`logs-inst-${e.id}`,className:j[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,n)=>s.jsxs("div",{className:"text-xs text-gray-700",children:[s.jsxs("div",{className:"font-medium",children:[t.actor," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&s.jsx("div",{className:"text-gray-600",children:t.comment})]},n)):s.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),s.jsxs("div",{className:"mt-3",children:[s.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),s.jsx("textarea",{rows:2,value:h[e.id]||"",onChange:t=>p(n=>({...n,[e.id]:t.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),s.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[s.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[s.jsx("input",{type:"file",multiple:!0,onChange:t=>g(n=>({...n,[e.id]:t.target.files?Array.from(t.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),s.jsx("span",{className:"text-xs text-[var(--muted)]",children:(f[e.id]||[]).length?`${(f[e.id]||[]).length} file(s) selected`:"No files selected"}),s.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>Ce(e),disabled:!f[e.id]||!(f[e.id]||[]).length,children:"Save Files"})]}),(e.activity||[]).some(t=>/Endorsed by Installation Commander/i.test(String(t.action||"")))&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"mt-3 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[s.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Send Options"}),s.jsxs("div",{className:"flex flex-col gap-2",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("input",{type:"checkbox",id:`send-ext-inst-${e.id}`,checked:I[e.id]||!1,onChange:()=>{const t=!I[e.id];Q(n=>({...n,[e.id]:t})),t&&be(n=>({...n,[e.id]:!1}))}}),s.jsx("label",{htmlFor:`send-ext-inst-${e.id}`,children:"Send to External Unit"}),s.jsx("input",{type:"checkbox",id:`readdress-hqmc-inst-${e.id}`,checked:C[e.id]||!1,onChange:()=>{const t=!C[e.id];V(n=>({...n,[e.id]:t})),t&&Q(n=>({...n,[e.id]:!1}))}}),s.jsx("label",{htmlFor:`readdress-hqmc-inst-${e.id}`,children:"Readdress to HQMC Section"})]}),I[e.id]&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(_e,{onUnitSelect:t=>Me(e.id,t),selectedUnit:{uic:U[e.id]||"",unitName:X[e.id]||""},placeholder:"Search by UIC, RUC, MCC, or Unit Name"}),s.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg",value:ee[e.id]||"",onChange:t=>W(n=>({...n,[e.id]:t.target.value})),disabled:!(G[e.id]||[]).length,children:[s.jsx("option",{value:"",children:"Select Section/Office (optional)"}),(G[e.id]||[]).map(t=>s.jsx("option",{value:t,children:t},t))]})]}),C[e.id]&&s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[s.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg",value:A[e.id]||"",onChange:t=>{ge(n=>({...n,[e.id]:t.target.value})),ne(n=>({...n,[e.id]:""}))},children:[s.jsx("option",{value:"",children:"Select HQMC Division"}),pe.map(t=>s.jsxs("option",{value:t.code,children:[t.code," — ",t.name]},t.code))]}),s.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed",value:T[e.id]||"",onChange:t=>ne(n=>({...n,[e.id]:t.target.value})),disabled:!A[e.id],children:[s.jsx("option",{value:"",children:"Select HQMC Section"}),he.filter(t=>String(t.division_code||"")===String(A[e.id]||"")).map(t=>s.jsx("option",{value:t.branch,children:t.branch},t.branch))]})]}),s.jsx("div",{className:"mt-2",children:s.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>ke(e),disabled:C[e.id]?!(A[e.id]&&T[e.id]):I[e.id]?!U[e.id]:!0,children:C[e.id]?"Submit to HQMC (Readdress)":I[e.id]?"Submit to External":"Submit"})})]})]}),s.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[s.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>Ee(e),children:"Approve"}),s.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2",onClick:()=>Ae(e),children:"Return"})]})]})]})}),r==="Previously in Section"&&s.jsx(re,{title:"Previously in Section",titleActions:s.jsx(s.Fragment,{children:s.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ne,children:"Export Previous"})}),requests:le,users:z,variant:"installation",onRowClick:e=>M(t=>({...t,[e.id]:!t[e.id]})),expandedRows:N,children:e=>s.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[s.jsxs("div",{className:"text-xs text-gray-600",children:["Last Status: ",new Date(e.activity&&e.activity.length?e.activity[e.activity.length-1].timestamp:e.createdAt).toLocaleString()]}),s.jsxs("div",{className:"mt-2",children:[s.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>E(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!j[e.id],"aria-controls":`logs-prev-inst-${e.id}`,children:[j[e.id]?"Hide":"Show"," Activity Log"]}),s.jsx("div",{id:`logs-prev-inst-${e.id}`,className:j[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,n)=>s.jsxs("div",{className:"text-xs text-gray-700",children:[s.jsxs("div",{className:"font-medium",children:[t.actor," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&s.jsx("div",{className:"text-gray-600",children:t.comment})]},n)):s.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),s.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[s.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg",value:O[e.id]||"",onChange:t=>xe(n=>({...n,[e.id]:t.target.value})),children:[s.jsx("option",{value:"",children:"Select installation section"}),((l==null?void 0:l.sections)||[]).map(t=>s.jsx("option",{value:t,children:t},t))]}),s.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>Ie(e,O[e.id]),children:"Restore to Section"})]})]})})]}),ve&&i&&s.jsx(qe,{currentUser:i,onClose:()=>ie(!1)})]})}export{Xe as default};
