import{r as c,j as s,R as Oe}from"./index-D1hlIYBq.js";import{w as be,e as he,y as Fe,c as Te,l as Pe,k as Qe,p as _e,f as qe,u as U}from"./db-MfBe9ZQl.js";import{S as Be,f as $}from"./utils-RWsxM7rr.js";import{R as xe,b as Ve}from"./RequestTable-Crwhk5gt.js";import{a as We,D as ze}from"./DocumentListItem-AMipRI5P.js";import"./units-CaNgy_2U.js";const Je=({currentUser:d,onClose:H})=>{const[x,b]=c.useState(null),[N,E]=c.useState([]),[r,L]=c.useState(""),[y,k]=c.useState(""),[B,V]=c.useState(!1),[O,w]=c.useState("");c.useEffect(()=>{be().then(o=>{const l=o.find(S=>String(S.id)===String(d.installationId||""));b(l||null)}).catch(()=>b(null)),he().then(o=>E(o)).catch(()=>E([]))},[]);const p=c.useMemo(()=>(x==null?void 0:x.sections)||[],[x]),h=c.useMemo(()=>(x==null?void 0:x.sectionAssignments)||{},[x]),f=String(d.id||""),g=c.useMemo(()=>{if(!x||!r)return!1;if(d.isInstallationAdmin)return!0;const o=h[r]||[];return Array.isArray(o)&&o.includes(f)},[x,r,h,f,d]),v=c.useMemo(()=>N.reduce((o,l)=>({...o,[l.id]:l}),{}),[N]),R=c.useMemo(()=>r?(h[r]||[]).map(l=>v[l]).filter(Boolean):[],[h,r,v]),j=c.useMemo(()=>{const o=Array.isArray(x==null?void 0:x.unitUics)?x.unitUics.map(String):[];return N.filter(l=>{if(l.id===d.id)return!1;const S=String(l.unitUic||"");return o.includes(S)})},[N,x,d]),D=async o=>{if(x){V(!0),w("");try{const l={...x,sectionAssignments:o};if(!(await Fe(l)).ok)throw new Error("persist_failed");b(l);try{await fetch("/api/permissions-audit/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actorId:d.id,scope:{installationId:x.id,section:r},timestamp:new Date().toISOString(),event:"installation_section_assignments_updated"})})}catch{}}catch{w("Failed to persist installation assignments")}finally{V(!1)}}},Y=async()=>{if(!g||!r||!y)return;const o={...h},l=Array.isArray(o[r])?o[r]:[];l.includes(y)||l.push(y),o[r]=l,await D(o),k("")},F=async o=>{if(!g||!r||!o)return;const l={...h},S=Array.isArray(l[r])?l[r]:[];l[r]=S.filter(T=>T!==o),await D(l)};return s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",onClick:H,children:s.jsxs("div",{className:"bg-white rounded-lg shadow w-full max-w-2xl p-6",onClick:o=>o.stopPropagation(),children:[s.jsxs("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Manage Installation Section Access"}),s.jsx("button",{className:"text-gray-500",onClick:H,children:"✕"})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Section"}),s.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:r,onChange:o=>L(o.target.value),children:[s.jsx("option",{value:"",children:"Select section"}),p.map(o=>s.jsx("option",{value:o,children:o},o))]})]}),r&&!g&&s.jsx("div",{className:"p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800",children:"You do not have permission to manage this section. Only installation admins or assigned section members can manage access."}),r&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Add User to Section"}),s.jsxs("select",{className:"w-full px-3 py-2 border rounded",value:y,onChange:o=>k(o.target.value),disabled:!g,children:[s.jsx("option",{value:"",children:"Choose user"}),j.map(o=>s.jsxs("option",{value:o.id,children:[o.rank," ",o.lastName,", ",o.firstName,o.mi?` ${o.mi}`:""," • ",o.email]},o.id))]}),s.jsx("div",{className:"mt-2 flex justify-end",children:s.jsx("button",{className:"px-3 py-1 rounded bg-brand-red text-brand-cream hover:bg-brand-red-2 disabled:opacity-50",disabled:!g||!y||B,onClick:Y,children:"Add"})})]}),s.jsxs("div",{className:"mt-4",children:[s.jsx("div",{className:"text-sm font-medium text-gray-900 mb-2",children:"Current Members"}),s.jsxs("div",{className:"space-y-2",children:[R.map(o=>s.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[s.jsxs("div",{className:"text-sm text-gray-700",children:[o.rank," ",o.lastName,", ",o.firstName,o.mi?` ${o.mi}`:""," • ",o.email]}),s.jsx("button",{className:"px-3 py-1 text-xs bg-red-600 text-white rounded disabled:opacity-50",disabled:!g||B,onClick:()=>F(o.id),children:"Remove"})]},o.id)),R.length===0&&s.jsx("div",{className:"text-sm text-gray-500",children:"No users assigned to this section."})]})]}),O&&s.jsx("div",{className:"p-2 bg-red-50 text-red-700 border border-red-200 rounded text-sm",children:O})]})]})]})})};function st(){const[d,H]=c.useState(null),[x,b]=c.useState([]),[N,E]=c.useState({}),[r,L]=c.useState(null),[y,k]=c.useState([]),[B,V]=c.useState({}),[O,w]=c.useState([]),[p,h]=c.useState({}),[f,g]=c.useState({}),[v,R]=c.useState({}),[j,D]=c.useState({}),[Y,F]=c.useState(null),o=Oe.useRef(null),[l,S]=c.useState("Pending"),[T,pe]=c.useState({}),[I,P]=c.useState({}),[Ke,ge]=c.useState({}),[W,G]=c.useState({}),[Z,ee]=c.useState({}),[te,se]=c.useState({}),[ne,z]=c.useState({}),[ve,ie]=c.useState([]),[Se,ae]=c.useState([]),[A,ye]=c.useState({}),[Q,oe]=c.useState({}),[C,J]=c.useState({}),[fe,ce]=c.useState(!1),[M,de]=c.useState(null);c.useEffect(()=>{try{const e=localStorage.getItem("currentUser");e&&H(JSON.parse(e))}catch{}},[]),c.useEffect(()=>{Te().then(e=>b(e)).catch(()=>b([])),Pe().then(e=>w(e)).catch(()=>w([]))},[]),c.useEffect(()=>{d!=null&&d.installationId&&(be().then(e=>{const t=e.find(n=>n.id===d.installationId);L(t||null)}).catch(()=>L(null)),he().then(e=>k(e)).catch(()=>k([])))},[d]),c.useEffect(()=>{Qe().then(ie).catch(()=>ie([])),_e().then(ae).catch(()=>ae([]))},[]);const K=c.useMemo(()=>{const e={};for(const t of y)e[t.id]=t;return e},[y]),X=e=>O.filter(t=>String(t.requestId||"")===String(e)),je=e=>K[e.uploadedById],Ne=e=>{const t=je(e);return t?`${t.rank||""} ${t.lastName||""}, ${t.firstName||""}${t.mi?` ${t.mi}`:""}`.trim():""},Ce=e=>`"${String(e??"").replace(/"/g,'""')}"`,re=e=>{const n=[["Request ID","Subject","Stage","Installation Section","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const i of e){const a=X(i.id).map(u=>u.name).join(" | ");n.push([i.id,i.subject,i.currentStage||"",i.routeSection||"",i.routeSection||"",Ne(i),i.unitUic||"",new Date(i.createdAt).toLocaleString(),a])}return n.map(i=>i.map(Ce).join(",")).join(`\r
`)},le=(e,t)=>{const n=new Blob([t],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(n),a=document.createElement("a");a.href=i,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)},we=()=>le("installation_section_pending.csv",re(me)),Ie=()=>le("installation_section_previous.csv",re(ue)),Ae=async e=>{const t=f[e.id]||[];if(!t.length)return;const n=(d==null?void 0:d.id)||"",i=e.unitUic||"",a=t.map(m=>({id:`doc-${Date.now()}-${Math.random().toString(16).slice(2)}`,name:m.name,type:m.type||"application/octet-stream",size:m.size,uploadedAt:new Date,category:"ATTACHMENT",tags:[],unitUic:i,subject:e.subject,notes:p[e.id]||void 0,uploadedById:n,currentStage:e.currentStage,requestId:e.id,fileUrl:void 0})),{ok:u}=await qe(a);u?(w(m=>[...a,...m]),g(m=>({...m,[e.id]:[]}))):alert("Failed to save files")},_=c.useMemo(()=>{if(!r||!(d!=null&&d.id))return[];const e=r.sectionAssignments||{};return Object.entries(e).filter(([,n])=>Array.isArray(n)&&n.includes(d.id)).map(([n])=>String(n))},[r,d]),Me=c.useMemo(()=>{if(!r||!(d!=null&&d.id))return!1;if(d.isInstallationAdmin)return!0;const e=r.sectionAssignments||{};return Object.values(e).some(t=>Array.isArray(t)&&t.includes(d.id))},[r,d]),me=c.useMemo(()=>{const e=(d==null?void 0:d.installationId)||"",t=new Set(_.map(n=>n.toUpperCase()));return x.filter(n=>n.currentStage==="INSTALLATION_REVIEW"&&n.installationId===e&&n.routeSection&&t.has(String(n.routeSection||"").toUpperCase()))},[x,d,_]),ue=c.useMemo(()=>{const e=(d==null?void 0:d.installationId)||"",t=new Set(_.map(n=>n.toUpperCase()));return x.filter(n=>n.installationId===e&&(n.currentStage!=="INSTALLATION_REVIEW"||!(n.routeSection&&t.has(String(n.routeSection||"").toUpperCase()))))},[x,d,_]),Ee=async(e,t)=>{const n=$(d,"Installation Section"),i=(t||"").trim()||e.routeSection||"",a={actor:n,timestamp:new Date().toISOString(),action:`Restored to installation section${i?`: ${i}`:""}`},u={...e,currentStage:"INSTALLATION_REVIEW",finalStatus:void 0,routeSection:i,activity:[...e.activity||[],a]};try{await U(u),b(m=>m.map(q=>q.id===e.id?u:q))}catch(m){console.error("InstallationSectionDashboard - Failed to restore:",m),alert("Failed to restore to section")}},ke=async e=>{const n={actor:$(d,"Installation Section"),timestamp:new Date().toISOString(),action:"Returned to unit for corrections",comment:(p[e.id]||"").trim()},i={...e,currentStage:"BATTALION_REVIEW",installationId:null,routeSection:"",activity:[...e.activity||[],n]};try{await U(i),b(a=>a.map(u=>u.id===e.id?i:u))}catch(a){console.error("Failed to return to unit:",a),alert("Failed to return to unit")}},Re=(e,t)=>{if(!t){G(a=>({...a,[e]:""})),ee(a=>({...a,[e]:""})),se(a=>({...a,[e]:[]})),z(a=>({...a,[e]:""}));return}const n=t.uic;G(a=>({...a,[e]:n})),ee(a=>({...a,[e]:t.unitName}));let i=[];try{const a=localStorage.getItem("unit_structure");if(a){const m=JSON.parse(a)[n],q=m!=null&&m._sections&&Array.isArray(m._sections)?m._sections:[],Le=m!=null&&m._commandSections&&Array.isArray(m._commandSections)?m._commandSections:[];i=[...q,...Le]}}catch(a){console.error("InstallationSectionDashboard - Failed to load unit sections:",a)}se(a=>({...a,[e]:i})),z(a=>({...a,[e]:""}))},De=async e=>{const t=$(d,"Installation Section");let n={...e};if(C[e.id]){const i=A[e.id]||"",a=Q[e.id]||"";if(!i||!a){alert("Select HQMC division and section");return}const u={actor:t,timestamp:new Date().toISOString(),action:`Sent to HQMC: ${i} - ${a}`,comment:(p[e.id]||"").trim()};n={...e,currentStage:"HQMC_REVIEW",routeSection:a,activity:[...e.activity||[],u]}}else if(I[e.id]){const i=W[e.id]||"",a=Z[e.id]||"",u=ne[e.id]||"";if(!i.trim()){alert("Please select an external unit");return}const m={actor:t,timestamp:new Date().toISOString(),action:u?`Sent to external unit: ${a} - ${u}`:`Sent to external unit: ${a}`,comment:(p[e.id]||"").trim()};n={...e,currentStage:"EXTERNAL_REVIEW",externalPendingUnitName:a,externalPendingUnitUic:i,externalPendingStage:u||void 0,routeSection:u||"",activity:[...e.activity||[],m]}}else{alert("Select an option: External Unit or Submit to HQMC");return}try{await U(n),b(i=>i.map(a=>a.id===e.id?n:a)),h(i=>({...i,[e.id]:""})),P(i=>({...i,[e.id]:!1})),J(i=>({...i,[e.id]:!1}))}catch(i){console.error("InstallationSectionDashboard - Failed to route:",i),alert("Failed to route")}},Ue=e=>{const t=(e.activity||[]).slice().reverse();for(const n of t){const i=String(n.action||""),a=i.match(/Sent to HQMC:\s*([^\-]+)\s*-\s*(.+)/i);if(a)return a[2].trim();const u=i.match(/Submitted to HQMC Approver:\s*([^\-]+)\s*-\s*(.+)/i);if(u)return u[2].trim();const m=i.match(/Routed to HQMC section:\s*(.+)/i);if(m)return m[1].trim()}return String(e.routeSection||"")},$e=async e=>{const n={actor:$(d,"Installation Section"),actorRole:"Installation Section",timestamp:new Date().toISOString(),action:"Archived by Installation Section",comment:(p[e.id]||"").trim()},i={...e,currentStage:"ARCHIVED",finalStatus:"Archived",activity:[...e.activity||[],n]};try{await U(i),b(a=>a.map(u=>u.id===e.id?i:u)),h(a=>({...a,[e.id]:""}))}catch(a){console.error("Failed to archive request:",a),alert("Failed to archive request")}},He=async e=>{const t=$(d,"Installation Section");let n={...e};if(C[e.id]){const i=A[e.id]||"",a=Q[e.id]||"";if(!i||!a){alert("Select HQMC division and section");return}const u={actor:t,timestamp:new Date().toISOString(),action:`Submitted to HQMC Approver: ${i} - ${a}`,comment:(p[e.id]||"").trim()};n={...e,currentStage:"HQMC_REVIEW",routeSection:a,activity:[...e.activity||[],u]}}else{const i=Ue(e),a={actor:t,timestamp:new Date().toISOString(),action:i?`Submitted to HQMC Approver: ${i}`:"Submitted to HQMC Approver",comment:(p[e.id]||"").trim()};n={...e,currentStage:"HQMC_REVIEW",routeSection:i||e.routeSection,activity:[...e.activity||[],a]}}try{await U(n),b(i=>i.map(a=>a.id===e.id?n:a)),h(i=>({...i,[e.id]:""})),P(i=>({...i,[e.id]:!1})),J(i=>({...i,[e.id]:!1}))}catch(i){console.error("InstallationSectionDashboard - Failed to approve to HQMC:",i),alert("Failed to submit to HQMC approver")}};return s.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[s.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Installation Section Dashboard"}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"text-sm text-[var(--muted)]",children:(r==null?void 0:r.name)||""}),Me&&s.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-red text-brand-cream border-2 border-brand-red-2 shadow hover:bg-brand-red-2",onClick:()=>ce(!0),children:"Manage Section Access"})]})]}),s.jsx("div",{className:"border-b border-gray-200 mb-4",children:s.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[s.jsx("button",{onClick:()=>S("Pending"),className:`${l==="Pending"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),s.jsx("button",{onClick:()=>S("Previously in Section"),className:`${l==="Previously in Section"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm`,children:"Previously in Section"})]})}),l==="Pending"&&s.jsx(xe,{title:"Assigned to My Sections",titleActions:s.jsx(s.Fragment,{children:s.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:we,children:"Export Pending"})}),requests:me,users:K,variant:"installation",onRowClick:e=>E(t=>({...t,[e.id]:!t[e.id]})),expandedRows:N,children:e=>s.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[s.jsx("div",{className:"mt-3",children:s.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!v[e.id],"aria-controls":`docs-inst-${e.id}`,onClick:()=>{R(t=>({...t,[e.id]:!t[e.id]})),F(t=>v[e.id]?null:e.id)},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),R(n=>({...n,[e.id]:!n[e.id]})),F(n=>v[e.id]?null:e.id))},children:[s.jsx("span",{children:"Show Documents"}),s.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${v[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:s.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),s.jsx("div",{id:`docs-inst-${e.id}`,ref:v[e.id]?o:void 0,className:`${v[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:s.jsx(We,{documents:X(e.id).map(t=>({...t,fileUrl:t.fileUrl})),showIcons:!0,onPreview:t=>de(X(e.id).find(n=>n.id===t.id)||null)})}),s.jsxs("div",{className:"mt-3",children:[s.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>D(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!j[e.id],"aria-controls":`logs-inst-${e.id}`,children:[j[e.id]?"Hide":"Show"," Activity Log"]}),s.jsx("div",{id:`logs-inst-${e.id}`,className:j[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,n)=>s.jsxs("div",{className:"text-xs text-gray-700",children:[s.jsxs("div",{className:"font-medium",children:[t.actor," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&s.jsx("div",{className:"text-gray-600",children:t.comment})]},n)):s.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),s.jsxs("div",{className:"mt-3",children:[s.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),s.jsx("textarea",{rows:2,value:p[e.id]||"",onChange:t=>h(n=>({...n,[e.id]:t.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),s.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[s.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[s.jsx("input",{type:"file",multiple:!0,onChange:t=>g(n=>({...n,[e.id]:t.target.files?Array.from(t.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),s.jsx("span",{className:"text-xs text-[var(--muted)]",children:(f[e.id]||[]).length?`${(f[e.id]||[]).length} file(s) selected`:"No files selected"}),s.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>Ae(e),disabled:!f[e.id]||!(f[e.id]||[]).length,children:"Save Files"})]}),(e.activity||[]).some(t=>/Endorsed by Installation Commander/i.test(String(t.action||"")))&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"mt-3 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[s.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Send Options"}),s.jsxs("div",{className:"flex flex-col gap-2",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("input",{type:"checkbox",id:`send-ext-inst-${e.id}`,checked:I[e.id]||!1,onChange:()=>{const t=!I[e.id];P(n=>({...n,[e.id]:t})),t&&ge(n=>({...n,[e.id]:!1}))}}),s.jsx("label",{htmlFor:`send-ext-inst-${e.id}`,children:"Send to External Unit"}),s.jsx("input",{type:"checkbox",id:`readdress-hqmc-inst-${e.id}`,checked:C[e.id]||!1,onChange:()=>{const t=!C[e.id];J(n=>({...n,[e.id]:t})),t&&P(n=>({...n,[e.id]:!1}))}}),s.jsx("label",{htmlFor:`readdress-hqmc-inst-${e.id}`,children:"Readdress to HQMC Section"})]}),I[e.id]&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Be,{onUnitSelect:t=>Re(e.id,t),selectedUnit:{uic:W[e.id]||"",unitName:Z[e.id]||""},placeholder:"Search by UIC, RUC, MCC, or Unit Name"}),s.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg",value:ne[e.id]||"",onChange:t=>z(n=>({...n,[e.id]:t.target.value})),disabled:!(te[e.id]||[]).length,children:[s.jsx("option",{value:"",children:"Select Section/Office (optional)"}),(te[e.id]||[]).map(t=>s.jsx("option",{value:t,children:t},t))]})]}),C[e.id]&&s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[s.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg",value:A[e.id]||"",onChange:t=>{ye(n=>({...n,[e.id]:t.target.value})),oe(n=>({...n,[e.id]:""}))},children:[s.jsx("option",{value:"",children:"Select HQMC Division"}),ve.map(t=>s.jsxs("option",{value:t.code,children:[t.code," — ",t.name]},t.code))]}),s.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed",value:Q[e.id]||"",onChange:t=>oe(n=>({...n,[e.id]:t.target.value})),disabled:!A[e.id],children:[s.jsx("option",{value:"",children:"Select HQMC Section"}),Se.filter(t=>String(t.division_code||"")===String(A[e.id]||"")).map(t=>s.jsx("option",{value:t.branch,children:t.branch},t.branch))]})]}),s.jsx("div",{className:"mt-2",children:s.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>De(e),disabled:C[e.id]?!(A[e.id]&&Q[e.id]):I[e.id]?!W[e.id]:!0,children:C[e.id]?"Submit to HQMC (Readdress)":I[e.id]?"Submit to External":"Submit"})})]})]}),s.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[s.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>He(e),children:"Approve"}),s.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>ke(e),children:"Return"})]})]}),Ve(e,{userLevel:"installation",userInstallationId:d==null?void 0:d.installationId})&&s.jsx("div",{className:"mt-3 flex items-center justify-end gap-2",children:s.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>$e(e),children:"Archive"})})]})}),l==="Previously in Section"&&s.jsx(xe,{title:"Previously in Section",titleActions:s.jsx(s.Fragment,{children:s.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 hidden md:block",onClick:Ie,children:"Export Previous"})}),requests:ue,users:K,variant:"installation",onRowClick:e=>E(t=>({...t,[e.id]:!t[e.id]})),expandedRows:N,children:e=>s.jsxs("div",{className:"p-4 bg-gray-50 space-y-3",children:[s.jsxs("div",{className:"text-xs text-gray-600",children:["Last Status: ",new Date(e.activity&&e.activity.length?e.activity[e.activity.length-1].timestamp:e.createdAt).toLocaleString()]}),s.jsxs("div",{className:"mt-2",children:[s.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>D(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!j[e.id],"aria-controls":`logs-prev-inst-${e.id}`,children:[j[e.id]?"Hide":"Show"," Activity Log"]}),s.jsx("div",{id:`logs-prev-inst-${e.id}`,className:j[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,n)=>s.jsxs("div",{className:"text-xs text-gray-700",children:[s.jsxs("div",{className:"font-medium",children:[t.actor," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&s.jsx("div",{className:"text-gray-600",children:t.comment})]},n)):s.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),s.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[s.jsxs("select",{className:"px-3 py-2 border border-brand-navy/30 rounded-lg",value:T[e.id]||"",onChange:t=>pe(n=>({...n,[e.id]:t.target.value})),children:[s.jsx("option",{value:"",children:"Select installation section"}),((r==null?void 0:r.sections)||[]).map(t=>s.jsx("option",{value:t,children:t},t))]}),s.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>Ee(e,T[e.id]),children:"Restore to Section"})]})]})})]}),fe&&d&&s.jsx(Je,{currentUser:d,onClose:()=>ce(!1)}),M&&s.jsx(ze,{fileName:M.name,url:M.fileUrl||"",mimeType:M.type||"",fileSize:M.size||0,isOpen:!!M,onClose:()=>de(null)})]})}export{st as default};
