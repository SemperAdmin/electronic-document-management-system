import{r,j as n}from"./index-D4ZIvaps.js";import{l as xt}from"./unitStructure-QC5qYuxv.js";import{U as pt}from"./units-CaNgy_2U.js";import{x as gt,m as ht,n as bt,c as ft,l as yt,e as vt,f as St,u as j}from"./db-q312qQgr.js";import{R as Ee,i as jt,e as Nt,b as wt,g as At,S as ae}from"./RequestTable-BE0xOlwW.js";import{S as Ct}from"./SearchableUnitSelector-BtGC57GS.js";import{a as Re}from"./DocumentListItem-BU921V7c.js";import{f as N}from"./utils-CLmukD0c.js";const Et="REVIEW";function _t(){const[l,ke]=r.useState(null),[y,f]=r.useState([]),[De,z]=r.useState([]),[P,oe]=r.useState({}),[D,Ue]=r.useState({}),[Q,Ie]=r.useState({}),[Le,Me]=r.useState({}),[g,Fe]=r.useState(""),[b,v]=r.useState({}),[U,ce]=r.useState({}),[$e,Oe]=r.useState({}),[re,le]=r.useState({}),[de,ue]=r.useState({}),[Rt,kt]=r.useState({}),[Dt,Ut]=r.useState({}),[X,Te]=r.useState({}),[Pe,K]=r.useState({}),[_,J]=r.useState({}),[me,B]=r.useState({}),[xe,pe]=r.useState({}),[h,w]=r.useState({}),[I,A]=r.useState(null),V=r.useRef(null),[C,G]=r.useState("Pending"),[E,ge]=r.useState(""),[_e,Be]=r.useState({}),[Ve,Ye]=r.useState({}),[Z,We]=r.useState([]),[R,Y]=r.useState({}),[he,He]=r.useState({}),[ee,W]=r.useState({}),[k,H]=r.useState({}),[qe,be]=r.useState([]),[ze,fe]=r.useState([]),[L,Qe]=r.useState({}),[te,ye]=r.useState({}),[Xe,M]=r.useState(!1),[p,ve]=r.useState(null),[F,ne]=r.useState("");r.useEffect(()=>{gt().then(e=>We(e)),ht().then(be).catch(()=>be([])),bt().then(fe).catch(()=>fe([]))},[]),r.useEffect(()=>{const e=t=>{I&&V.current&&!V.current.contains(t.target)&&(w(s=>({...s,[I]:!1})),A(null))},i=t=>{t.key==="Escape"&&I&&(w(s=>({...s,[I]:!1})),A(null))};return document.addEventListener("mousedown",e),document.addEventListener("keydown",i),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",i)}},[I]),r.useEffect(()=>{try{const e=localStorage.getItem("currentUser");e&&ke(JSON.parse(e))}catch{}},[]),r.useEffect(()=>{var e,i;try{const t=(l==null?void 0:l.unitUic)||"",s=l!=null&&l.company&&l.company!=="N/A"?l.company:"",a=l!=null&&l.platoon&&l.platoon!=="N/A"?l.platoon:"",c=((i=(e=D[t])==null?void 0:e[s])==null?void 0:i[a])||"";Fe(c)}catch{}},[l,D]),r.useEffect(()=>{ft().then(e=>{f(e)}).catch(()=>f([]))},[]),r.useEffect(()=>{yt().then(e=>{z(e)}).catch(()=>z([]))},[]),r.useEffect(()=>{vt().then(e=>{const i={};for(const t of e)i[t.id]=t;oe(i)}).catch(()=>oe({}))},[]),r.useEffect(()=>{try{const e=localStorage.getItem("unit_structure"),i={},t={},s={};if(e){const a=JSON.parse(e);for(const c of Object.keys(a||{})){const o=a[c];o&&o._platoonSectionMap&&typeof o._platoonSectionMap=="object"&&(i[c]=o._platoonSectionMap),o&&Array.isArray(o._sections)&&(t[c]=o._sections),o&&Array.isArray(o._commandSections)&&(s[c]=o._commandSections)}}else(async()=>{try{const a=await xt();for(const c of Object.keys(a||{})){const o=a[c];o&&o._platoonSectionMap&&typeof o._platoonSectionMap=="object"&&(i[c]=o._platoonSectionMap),o&&Array.isArray(o._sections)&&(t[c]=o._sections),o&&Array.isArray(o._commandSections)&&(s[c]=o._commandSections)}}catch{}})();Ue(i),Me(t),Oe(s)}catch{}},[]);const Se=r.useMemo(()=>{const e=(l==null?void 0:l.unitUic)||"";return y.filter(i=>{const s=(i.currentStage||"")==="EXTERNAL_REVIEW"?i.externalPendingUnitUic||i.unitUic||"":i.unitUic||"";return!!S(i)&&(e?s===e:!0)})},[y,l,S]),je=r.useMemo(()=>{const e=i=>String(i||"").trim().replace(/^S(\d)\b/,"S-$1");return Se.filter(i=>{const t=e(S(i)),s=e(g);return g?t===s:!0})},[Se,g,S]),Ne=r.useMemo(()=>je.filter(e=>(e.currentStage||"")==="BATTALION_REVIEW"),[je]),we=r.useMemo(()=>{const e=t=>String(t||"").trim().replace(/^S(\d)\b/,"S-$1"),i=e(g);return i?y.filter(t=>{var u,m;if(t.filedAt)return!1;const s=t.currentStage||"",a=(l==null?void 0:l.unitUic)||"",c=s==="EXTERNAL_REVIEW"?t.externalPendingUnitUic||t.unitUic||"":t.unitUic||"";if(a&&c!==a||s==="BATTALION_REVIEW"&&e(S(t))===i)return!1;const o=(u=t.activity)==null?void 0:u.some(x=>{const T=String(x.action||"");return T.includes(i)||T.includes(g)}),d=(m=t.activity)==null?void 0:m.some(x=>{const T=String(x.action||"");return T.includes(`routed to ${i}`)||T.includes(`routed to ${g}`)});return o||d}):[]},[y,l,g]),Ae=r.useCallback(e=>{if(e.isPermanent)return"Permanent";if(!e.retentionValue||!e.cutoffTrigger||!e.filedAt)return"Unknown";const i=new Date(e.filedAt);let t;switch(e.cutoffTrigger){case"CALENDAR_YEAR":t=new Date(i.getFullYear(),11,31);break;case"FISCAL_YEAR":t=i.getMonth()>=9?new Date(i.getFullYear()+1,8,30):new Date(i.getFullYear(),8,30);break;default:t=i}const s=new Date(t),a=(e.retentionUnit||"").toLowerCase();return a==="years"?s.setFullYear(s.getFullYear()+e.retentionValue):a==="months"?s.setMonth(s.getMonth()+e.retentionValue):a==="days"&&s.setDate(s.getDate()+e.retentionValue),s.getFullYear().toString()},[]),Ke=r.useCallback(e=>{if(!e.retentionValue||!e.cutoffTrigger||!e.filedAt)return"N/A";if(e.isPermanent)return"Permanent";const i=new Date(e.filedAt);let t;switch(e.cutoffTrigger){case"CALENDAR_YEAR":t=new Date(i.getFullYear(),11,31);break;case"FISCAL_YEAR":t=i.getMonth()>=9?new Date(i.getFullYear()+1,8,30):new Date(i.getFullYear(),8,30);break;default:t=i}const s=new Date(t),a=(e.retentionUnit||"").toLowerCase();return a==="years"?s.setFullYear(s.getFullYear()+e.retentionValue):a==="months"?s.setMonth(s.getMonth()+e.retentionValue):a==="days"&&s.setDate(s.getDate()+e.retentionValue),s.toLocaleDateString()},[]),$=r.useMemo(()=>{const i=(a=>String(a||"").trim().replace(/^S(\d)\b/,"S-$1"))(g);if(!i)return{};let t=y.filter(a=>{var d;if(!a.filedAt)return!1;const c=(l==null?void 0:l.unitUic)||"";return c&&a.unitUic!==c?!1:(d=a.activity)==null?void 0:d.some(u=>{const m=String(u.action||"");return m.includes(i)||m.includes(g)})});if(E.trim()){const a=E.toLowerCase().trim();t=t.filter(c=>{var o,d,u,m;return((o=c.subject)==null?void 0:o.toLowerCase().includes(a))||((d=c.ssic)==null?void 0:d.toLowerCase().includes(a))||((u=c.ssicNomenclature)==null?void 0:u.toLowerCase().includes(a))||((m=c.ssicBucketTitle)==null?void 0:m.toLowerCase().includes(a))})}const s={};for(const a of t){const c=Ae(a),o=a.ssicBucketTitle||a.ssicBucket||"Uncategorized";s[c]||(s[c]={}),s[c][o]||(s[c][o]=[]),s[c][o].push(a)}for(const a of Object.keys(s))for(const c of Object.keys(s[a]))s[a][c].sort((o,d)=>new Date(d.createdAt).getTime()-new Date(o.createdAt).getTime());return s},[y,l,g,E,Ae]),Ce=r.useMemo(()=>Object.keys($).sort((i,t)=>i==="Permanent"?-1:t==="Permanent"||i==="Unknown"?1:t==="Unknown"?-1:parseInt(i)-parseInt(t)),[$]),Je=r.useMemo(()=>Object.values($).reduce((e,i)=>e+Object.values(i).reduce((t,s)=>t+s.length,0),0),[$]);function S(e){var d,u;const i=m=>String(m||"").trim().replace(/^S(\d)\b/,"S-$1");if(e.routeSection)return i(e.routeSection);const t=e.unitUic||"",s=P[e.uploadedById],a=s!=null&&s.company&&s.company!=="N/A"?s.company:"",c=s!=null&&s.platoon&&s.platoon!=="N/A"?s.platoon:"",o=((u=(d=D[t])==null?void 0:d[a])==null?void 0:u[c])||"";return i(o)}const Ge=e=>{const i=P[e.uploadedById];return i?[i.rank,i.lastName+",",i.firstName,i.mi?i.mi:""].filter(Boolean).join(" ").trim():"—"},se=e=>De.filter(i=>i.requestId===e),Ze=e=>`"${String(e??"").replace(/"/g,'""')}"`,et=e=>{const t=[["Request ID","Subject","Stage","Battalion Section","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const s of e){const a=se(s.id).map(c=>c.name).join(" | ");t.push([s.id,s.subject,s.currentStage||"",S(s)||"",s.routeSection||"",Ge(s),s.unitUic||"",new Date(s.createdAt).toLocaleString(),a])}return t.map(s=>s.map(Ze).join(",")).join(`\r
`)},tt=(e,i)=>{const t=new Blob([i],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(t),a=document.createElement("a");a.href=s,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)},nt=()=>tt("battalion_all.csv",et([...Ne,...we])),st=async e=>{const i=U[e.id]||[];if(!i.length||!(l!=null&&l.id))return;const t=Date.now(),s=i.map((u,m)=>({id:`${t}-${m}`,name:u.name,type:u.type,size:u.size,uploadedAt:new Date().toISOString(),subject:e.subject,requestId:e.id})),a=N(l,"Reviewer"),c=O(),o={actor:a,actorRole:c,timestamp:new Date().toISOString(),action:`Reviewer added ${s.length} document(s)`,comment:(b[e.id]||"").trim()},d={...e,documentIds:[...e.documentIds||[],...s.map(u=>u.id)],activity:Array.isArray(e.activity)?[...e.activity,o]:[o]};try{await St(s),await j(d),z(u=>[...u,...s]),f(u=>u.map(m=>m.id===d.id?d:m))}catch(u){console.error("Failed to add files to request:",u)}ce(u=>({...u,[e.id]:[]})),v(u=>({...u,[e.id]:""}))},O=()=>{const e=g||"";return e?`Battalion (${e})`:"Battalion"},q=e=>{const i=e==null?void 0:e.trim();return i?Z.some(t=>{const s=t.unit_uics||t.unitUics||[];return Array.isArray(s)&&s.includes(i)}):!1},it=e=>{const i=(e.activity||[]).slice().reverse().find(t=>/Commander/i.test(String(t.action||"")));return!!i&&/(Approved|Endorsed)/i.test(String(i.action||""))},at=async e=>{const i=re[e.id]||"COMMANDER",t=N(l,"Battalion"),s=O(),a=S(e)||g||"",c=i==="COMMANDER"?"Approved to COMMANDER":`Approved and routed to ${i}`,o={actor:t,actorRole:s,timestamp:new Date().toISOString(),action:c,comment:(b[e.id]||"").trim(),fromSection:a||void 0,toSection:i},d={...e,currentStage:"COMMANDER_REVIEW",routeSection:i==="COMMANDER"?"":i,activity:Array.isArray(e.activity)?[...e.activity,o]:[o]};try{await j({...d,unitUic:e.unitUic||""}),f(u=>u.map(m=>m.id===d.id?d:m)),v(u=>({...u,[e.id]:""})),le(u=>({...u,[e.id]:""}))}catch(u){console.error("Failed to approve request:",u)}},ot=async e=>{const i=N(l,"Battalion"),t=O(),s={actor:i,actorRole:t,timestamp:new Date().toISOString(),action:"Returned to previous stage",comment:(b[e.id]||"").trim()},a={...e,currentStage:"COMPANY_REVIEW",activity:Array.isArray(e.activity)?[...e.activity,s]:[s]};try{await j(a),f(c=>c.map(o=>o.id===a.id?a:o)),v(c=>({...c,[e.id]:""}))}catch(c){console.error("Failed to reject request:",c)}},ct=e=>{if(!e.ssic){alert("Request must have SSIC/retention classification before filing.");return}ve(e),ne(new Date().toISOString().split("T")[0]),M(!0)},rt=async()=>{var c;if(!p||!l)return;if(!F){alert("Please select a finalized date.");return}const e=new Date(F+"T23:59:59").toISOString(),i=N(l,"Battalion"),t=O(),s={actor:i,actorRole:t,timestamp:new Date().toISOString(),action:"Filed for Records Management",comment:`Date Finalized: ${new Date(F).toLocaleDateString()}${(c=b[p.id])!=null&&c.trim()?` - ${b[p.id].trim()}`:""}`},a={...p,currentStage:"ARCHIVED",finalStatus:"Filed",filedAt:e,activity:Array.isArray(p.activity)?[...p.activity,s]:[s]};try{await j(a),f(o=>o.map(d=>d.id===a.id?a:d)),v(o=>({...o,[p.id]:""})),M(!1),ve(null),ne("")}catch(o){console.error("Failed to file request:",o)}},lt=async e=>{const i=At(e.currentStage||"");if(!i){alert("Cannot return from this stage.");return}const t=N(l,"Battalion"),s=O(),a=i===ae.ORIGINATOR_REVIEW?"Originator":i===ae.PLATOON_REVIEW?"Platoon":i===ae.COMPANY_REVIEW?"Company":"Lower Level",c={actor:t,actorRole:s,timestamp:new Date().toISOString(),action:`Returned to ${a} for filing`,comment:(b[e.id]||"").trim()},o={...e,currentStage:i,activity:Array.isArray(e.activity)?[...e.activity,c]:[c]};try{await j(o),f(d=>d.map(u=>u.id===o.id?o:u)),v(d=>({...d,[e.id]:""}))}catch(d){console.error("Failed to return request:",d)}},dt=(e,i)=>{if(!i){J(a=>({...a,[e]:""})),K(a=>({...a,[e]:""})),pe(a=>({...a,[e]:[]})),B(a=>({...a,[e]:""}));return}const t=i.uic;J(a=>({...a,[e]:t})),K(a=>({...a,[e]:i.unitName}));let s=[];try{const a=localStorage.getItem("unit_structure");if(a){const o=JSON.parse(a)[t],d=o!=null&&o._sections&&Array.isArray(o._sections)?o._sections:[],u=o!=null&&o._commandSections&&Array.isArray(o._commandSections)?o._commandSections:[];s=[...d,...u]}}catch(a){console.error("Failed to load or parse unit sections from localStorage:",a)}pe(a=>({...a,[e]:s})),B(a=>({...a,[e]:""}))},ut=async e=>{const i=_[e.id]||"",t=Pe[e.id]||"",s=me[e.id]||"",a=N(l,"Battalion");let c;if(R[e.id]){const o=Z.find(m=>{const x=m.unit_uics||m.unitUics||[];return Array.isArray(x)&&x.includes(e.unitUic||"")});if(!o){alert("The selected unit is not part of any installation.");return}const d=`Sent to installation: ${o.name}`,u={actor:a,timestamp:new Date().toISOString(),action:d,comment:(b[e.id]||"").trim()};c={...e,currentStage:"INSTALLATION_REVIEW",installationId:o.id,externalPendingUnitName:void 0,externalPendingUnitUic:void 0,externalPendingStage:void 0,routeSection:he[e.id]||"",activity:[...e.activity||[],u]}}else if(k[e.id]){const o=L[e.id]||"",d=te[e.id]||"";if(!o||!d){alert("Select HQMC division and section");return}const u=`Sent to HQMC: ${o} - ${d}`,m={actor:a,timestamp:new Date().toISOString(),action:u,comment:(b[e.id]||"").trim()};c={...e,routeSection:d,externalPendingUnitName:void 0,externalPendingUnitUic:void 0,externalPendingStage:void 0,activity:[...e.activity||[],m]}}else{if(!i.trim()){alert("Please select an external unit");return}const o=s?`Sent to external unit: ${t} - ${s}`:`Sent to external unit: ${t}`,d={actor:a,timestamp:new Date().toISOString(),action:o,comment:(b[e.id]||"").trim()};c={...e,currentStage:"EXTERNAL_REVIEW",externalPendingUnitName:t,externalPendingUnitUic:i,externalPendingStage:s||Et,routeSection:s||"",activity:[...e.activity||[],d]}}try{await j(c),f(o=>o.map(d=>d.id===c.id?c:d)),v(o=>({...o,[e.id]:""})),K(o=>({...o,[e.id]:""})),J(o=>({...o,[e.id]:""})),B(o=>({...o,[e.id]:""})),Y(o=>({...o,[e.id]:!1})),H(o=>({...o,[e.id]:!1})),W(o=>({...o,[e.id]:!1}))}catch(o){console.error("Failed to send request to external unit:",o),alert("Failed to send request to external unit. Please try again.")}},ie=r.useMemo(()=>{const e=(l==null?void 0:l.unitUic)||"";return y.filter(i=>{if((i.currentStage||"")!=="EXTERNAL_REVIEW")return!1;const s=i.externalPendingUnitUic||i.unitUic||"";return e?s===e:!0})},[y,l]),mt=async e=>{const i=X[e.id];if(!i)return;const t=N(l,"Battalion"),s={...e,currentStage:"BATTALION_REVIEW",unitUic:(l==null?void 0:l.unitUic)||e.externalPendingUnitUic||e.unitUic,routeSection:i,externalPendingUnitUic:void 0,externalPendingUnitName:void 0,externalPendingStage:void 0,activity:Array.isArray(e.activity)?[...e.activity,{actor:t,timestamp:new Date().toISOString(),action:`Battalion assigned external request to section ${i}`}]:[{actor:t,timestamp:new Date().toISOString(),action:`Battalion assigned external request to section ${i}`}]};try{await j(s),f(a=>a.map(c=>c.id===s.id?s:c))}catch(a){console.error("Failed to assign external request to section:",a)}};return n.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[n.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Unit Section Dashboard"}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:g||"—"}),n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:nt,children:"Export All"})]})]}),n.jsxs("div",{className:"space-y-8",children:[ie.length>0&&n.jsxs("div",{className:"p-4 border border-brand-gold rounded-lg bg-brand-cream",children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Pending Assignment (External Requests)"}),n.jsxs("span",{className:"text-xs px-2 py-1 bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:[ie.length," item(s)"]})]}),n.jsx("div",{className:"flex flex-col gap-4",children:ie.map(e=>n.jsxs("div",{className:"p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] transition-all duration-300",children:[n.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-2",children:[n.jsxs("div",{children:[n.jsx("div",{className:"font-medium text-[var(--text)]",children:e.subject}),n.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(e.createdAt).toLocaleString()]}),n.jsxs("div",{className:"text-xs text-[var(--muted)] mt-1",children:["From ",e.externalPendingUnitName||"External Unit"]})]}),n.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:"EXTERNAL_REVIEW"})]}),n.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[n.jsx("label",{className:"text-sm text-[var(--text)]",children:"Assign to Section"}),n.jsxs("select",{value:X[e.id]||"",onChange:i=>Te(t=>({...t,[e.id]:i.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[n.jsx("option",{value:"",children:"Select section"}),(Le[(l==null?void 0:l.unitUic)||""]||[]).map(i=>n.jsx("option",{value:i,children:i},i))]}),n.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",disabled:!X[e.id],onClick:()=>mt(e),children:"Assign"})]})]},e.id))})]}),n.jsx("div",{className:"border-b border-gray-200",children:n.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[n.jsx("button",{onClick:()=>G("Pending"),className:`${C==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),n.jsx("button",{onClick:()=>G("Previously in Section"),className:`${C==="Previously in Section"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Previously in Section"}),n.jsxs("button",{onClick:()=>G("Files"),className:`${C==="Files"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:["Files (",Je,")"]})]})}),n.jsxs("div",{className:"mt-4",children:[C==="Pending"&&n.jsx(Ee,{title:"Pending",requests:Ne,users:P,onRowClick:e=>ue(i=>({...i,[e.id]:!i[e.id]})),expandedRows:de,platoonSectionMap:D,children:e=>{var i;return n.jsxs("div",{id:`details-sec-${e.id}`,className:"p-4 bg-gray-50",children:[n.jsx("div",{className:"mt-3",children:n.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!h[e.id],"aria-controls":`docs-sec-${e.id}`,onClick:()=>{w(t=>({...t,[e.id]:!t[e.id]})),A(t=>h[e.id]?null:e.id)},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),w(s=>({...s,[e.id]:!s[e.id]})),A(s=>h[e.id]?null:e.id))},children:[n.jsx("span",{children:"Show Documents"}),n.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${h[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:n.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),n.jsx("div",{id:`docs-sec-${e.id}`,ref:h[e.id]?V:void 0,className:`${h[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:n.jsx(Re,{documents:se(e.id).map(t=>({...t,fileUrl:t.fileUrl}))})}),n.jsxs("div",{className:"mt-3",children:[n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Ie(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!Q[e.id],"aria-controls":`logs-sec-${e.id}`,children:[Q[e.id]?"Hide":"Show"," Activity Log"]}),n.jsx("div",{id:`logs-sec-${e.id}`,className:Q[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,s)=>n.jsxs("div",{className:"text-xs text-gray-700",children:[n.jsxs("div",{className:"font-medium",children:[t.actor,t.actorRole?` • ${t.actorRole}`:""," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&n.jsx("div",{className:"text-gray-600",children:t.comment})]},s)):n.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),n.jsx("textarea",{rows:2,value:b[e.id]||"",onChange:t=>v(s=>({...s,[e.id]:t.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),n.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[n.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[n.jsx("input",{type:"file",multiple:!0,onChange:t=>ce(s=>({...s,[e.id]:t.target.files?Array.from(t.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),n.jsx("span",{className:"text-xs text-[var(--muted)]",children:(U[e.id]||[]).length?`${(U[e.id]||[]).length} file(s) selected`:"No files selected"}),n.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>st(e),disabled:!U[e.id]||!(U[e.id]||[]).length,children:"Save Files"})]}),e.currentStage==="BATTALION_REVIEW"&&!it(e)&&n.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[n.jsxs("select",{value:re[e.id]||"COMMANDER",onChange:t=>le(s=>({...s,[e.id]:t.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[n.jsx("option",{value:"COMMANDER",children:"Commander"}),($e[(l==null?void 0:l.unitUic)||""]||[]).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>at(e),children:"Approve"}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>ot(e),children:"Return"})]}),(jt(e)||Nt(e))&&!e.filedAt&&n.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[n.jsx("button",{className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-blue-500",onClick:()=>ct(e),children:"File"}),wt(e)&&n.jsx("button",{className:"px-3 py-2 rounded bg-amber-500 text-white hover:bg-amber-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-amber-400",onClick:()=>lt(e),children:"Return"})]}),((i=e.activity)==null?void 0:i.some(t=>/(endorsed by commander|commander.*endorsed)/i.test(String(t.action||""))))&&n.jsxs("div",{className:"mt-3 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Send Options"}),n.jsxs("div",{className:"flex flex-col gap-2",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("input",{type:"checkbox",id:`send-to-external-${e.id}`,checked:ee[e.id]||!1,onChange:()=>{const t=!ee[e.id];W(s=>({...s,[e.id]:t})),t&&(Y(s=>({...s,[e.id]:!1})),H(s=>({...s,[e.id]:!1})))}}),n.jsx("label",{htmlFor:`send-to-external-${e.id}`,children:"Send to External Unit"}),n.jsx("input",{type:"checkbox",id:`submit-to-installation-${e.id}`,checked:R[e.id]||!1,onChange:()=>{const t=!R[e.id];Y(s=>({...s,[e.id]:t})),t&&(W(s=>({...s,[e.id]:!1})),H(s=>({...s,[e.id]:!1})))},disabled:!q(e.unitUic)}),n.jsx("label",{htmlFor:`submit-to-installation-${e.id}`,children:"Submit to Installation"}),n.jsx("input",{type:"checkbox",id:`submit-to-hqmc-${e.id}`,checked:k[e.id]||!1,onChange:()=>{const t=!k[e.id];H(s=>({...s,[e.id]:t})),t&&(W(s=>({...s,[e.id]:!1})),Y(s=>({...s,[e.id]:!1})))}}),n.jsx("label",{htmlFor:`submit-to-hqmc-${e.id}`,children:"Submit to HQMC"})]}),ee[e.id]&&n.jsxs(n.Fragment,{children:[n.jsx(Ct,{onUnitSelect:t=>dt(e.id,t),selectedUnit:pt.find(t=>t.uic===_[e.id]),placeholder:"Search by UIC, RUC, MCC, or Unit Name"}),n.jsxs("select",{value:me[e.id]||"",onChange:t=>B(s=>({...s,[e.id]:t.target.value})),disabled:!_[e.id]||!(xe[e.id]||[]).length,className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:[n.jsx("option",{value:"",children:"Select Section/Office (optional)"}),(xe[e.id]||[]).map(t=>n.jsx("option",{value:t,children:t},t))]})]}),n.jsx("div",{className:"flex items-center gap-2",children:!q(e.unitUic)&&n.jsx("p",{className:"text-xs text-gray-500",children:"Not assigned to installation."})}),R[e.id]&&q(e.unitUic)&&n.jsxs("select",{value:he[e.id]||"",onChange:t=>He(s=>({...s,[e.id]:t.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[n.jsx("option",{value:"",children:"Select Installation Section/Office (optional)"}),(()=>{const t=Z.find(a=>{const c=a.unit_uics||a.unitUics||[];return Array.isArray(c)&&c.includes(e.unitUic||"")});return((t==null?void 0:t.sections)||[]).map(a=>n.jsx("option",{value:a,children:a},a))})()]}),k[e.id]&&n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[n.jsxs("select",{value:L[e.id]||"",onChange:t=>{Qe(s=>({...s,[e.id]:t.target.value})),ye(s=>({...s,[e.id]:""}))},className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[n.jsx("option",{value:"",children:"Select HQMC Division"}),qe.map(t=>n.jsxs("option",{value:t.code,children:[t.code," — ",t.name]},t.code))]}),n.jsxs("select",{value:te[e.id]||"",onChange:t=>ye(s=>({...s,[e.id]:t.target.value})),disabled:!L[e.id],className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:[n.jsx("option",{value:"",children:"Select HQMC Section"}),ze.filter(t=>String(t.division_code||"")===String(L[e.id]||"")).map(t=>n.jsx("option",{value:t.branch,children:t.branch},t.branch))]})]}),n.jsx("div",{className:"mt-2",children:n.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>ut(e),disabled:R[e.id]?!q(e.unitUic):k[e.id]?!(L[e.id]&&te[e.id]):!_[e.id],children:R[e.id]?"Submit to Installation":k[e.id]?"Submit to HQMC":"Submit to External"})})]})]})]})}}),C==="Previously in Section"&&n.jsx(Ee,{title:"Previously in Section",requests:we,users:P,onRowClick:e=>ue(i=>({...i,[e.id]:!i[e.id]})),expandedRows:de,platoonSectionMap:D,children:e=>n.jsxs("div",{id:`details-sec-${e.id}`,className:"p-4 bg-gray-50",children:[n.jsx("div",{className:"mt-3",children:n.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!h[e.id],"aria-controls":`docs-sec-${e.id}`,onClick:()=>{w(i=>({...i,[e.id]:!i[e.id]})),A(i=>h[e.id]?null:e.id)},onKeyDown:i=>{(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),w(t=>({...t,[e.id]:!t[e.id]})),A(t=>h[e.id]?null:e.id))},children:[n.jsx("span",{children:"Show Documents"}),n.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${h[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:n.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),n.jsx("div",{id:`docs-sec-${e.id}`,ref:h[e.id]?V:void 0,className:`${h[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:n.jsx(Re,{documents:se(e.id).map(i=>({...i,fileUrl:i.fileUrl}))})})]})}),C==="Files"&&n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{className:"relative",children:[n.jsx("input",{type:"text",placeholder:"Search files by subject, SSIC, category...",value:E,onChange:e=>ge(e.target.value),className:"w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold focus:border-transparent"}),n.jsx("svg",{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),E&&n.jsx("button",{onClick:()=>ge(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:n.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),Ce.length===0?n.jsx("div",{className:"text-center py-8 text-gray-500",children:E?"No records match your search.":"No filed records in this section."}):n.jsx("div",{className:"space-y-2",children:Ce.map(e=>{const i=$[e],t=Object.keys(i).sort(),s=e==="Permanent",a=Object.values(i).reduce((o,d)=>o+d.length,0),c=_e[e]||!1;return n.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[n.jsxs("button",{onClick:()=>Be(o=>({...o,[e]:!o[e]})),className:`w-full ${s?"bg-blue-800 hover:bg-blue-700":"bg-brand-navy hover:bg-brand-navy/90"} text-brand-cream px-4 py-3 font-medium flex items-center justify-between transition-colors`,children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("svg",{className:`w-4 h-4 transition-transform flex-shrink-0 ${c?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),n.jsx("span",{className:"truncate",children:s?"Permanent Records":`Disposal Year: ${e}`})]}),n.jsxs("span",{className:"text-xs bg-white/20 px-2 py-0.5 rounded flex-shrink-0 ml-2",children:[a," record",a!==1?"s":""]})]}),c&&n.jsx("div",{className:"bg-gray-50 p-2 space-y-2",children:t.map(o=>{const d=i[o],u=`${e}-${o}`,m=Ve[u]||!1;return n.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden bg-white",children:[n.jsxs("button",{onClick:()=>Ye(x=>({...x,[u]:!x[u]})),className:"w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 font-medium text-sm flex items-center justify-between transition-colors",children:[n.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[n.jsx("svg",{className:`w-3 h-3 transition-transform flex-shrink-0 ${m?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),n.jsx("span",{className:"truncate",children:o})]}),n.jsxs("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:[d.length," item",d.length!==1?"s":""]})]}),m&&n.jsx("div",{className:"overflow-x-auto",children:n.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[n.jsx("thead",{className:"bg-gray-50",children:n.jsxs("tr",{children:[n.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"Name"}),n.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"SSIC"}),n.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm",children:"Retention"}),n.jsx("th",{className:"px-2 sm:px-3 py-2 text-left font-medium text-gray-500 text-xs sm:text-sm hidden sm:table-cell",children:"Disposal Date"})]})}),n.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:d.map(x=>n.jsxs("tr",{className:"hover:bg-gray-50",children:[n.jsx("td",{className:"px-2 sm:px-3 py-2 font-medium text-brand-navy text-xs sm:text-sm max-w-[120px] sm:max-w-none truncate",children:x.subject}),n.jsx("td",{className:"px-2 sm:px-3 py-2 text-xs sm:text-sm",children:x.ssic}),n.jsx("td",{className:"px-2 sm:px-3 py-2",children:x.isPermanent?n.jsx("span",{className:"inline-flex px-1.5 sm:px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded whitespace-nowrap",children:"Perm"}):n.jsxs("span",{className:"inline-flex px-1.5 sm:px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded whitespace-nowrap",children:[x.retentionValue," ",(x.retentionUnit||"").replace("S","")]})}),n.jsx("td",{className:"px-2 sm:px-3 py-2 text-xs sm:text-sm hidden sm:table-cell",children:Ke(x)})]},x.id))})]})})]},u)})})]},e)})})]})]})]})]}),Xe&&p&&n.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]",onClick:()=>M(!1),children:n.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md p-6",onClick:e=>e.stopPropagation(),children:[n.jsxs("div",{className:"flex justify-between items-center mb-4",children:[n.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"File for Records Management"}),n.jsx("button",{className:"text-gray-500 hover:text-gray-700",onClick:()=>M(!1),children:"✕"})]}),n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date Finalized"}),n.jsx("input",{type:"date",value:F,onChange:e=>ne(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"This date will be used to calculate the disposal date based on the retention schedule."})]}),n.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 text-sm",children:[n.jsx("div",{className:"font-medium text-gray-700 mb-1",children:"Retention Info"}),n.jsxs("div",{className:"text-gray-600",children:[n.jsxs("div",{children:["SSIC: ",p.ssic," - ",p.ssicNomenclature]}),n.jsxs("div",{children:["Retention: ",p.isPermanent?"Permanent":`${p.retentionValue} ${p.retentionUnit}`]}),n.jsxs("div",{children:["Cutoff: ",p.cutoffDescription||p.cutoffTrigger]})]})]})]}),n.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[n.jsx("button",{type:"button",onClick:()=>M(!1),className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",children:"Cancel"}),n.jsx("button",{type:"button",onClick:rt,disabled:!F,className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50",children:"File Record"})]})]})})]})}export{_t as default};
