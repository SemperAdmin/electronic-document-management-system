import{r as c,j as n}from"./index-Csn1811y.js";import{l as nt}from"./unitStructure-QC5qYuxv.js";import{U as it}from"./units-CaNgy_2U.js";import{x as at,k as st,m as ot,c as ct,l as dt,e as lt,f as rt,u as f}from"./db-DtVXCuJW.js";import{R as je,i as ut,e as mt,b as xt,g as pt,S as ne}from"./RequestTable-BqwdM0Wh.js";import{S as bt}from"./SearchableUnitSelector-DGOmzbFb.js";import{a as Ne}from"./DocumentListItem-BnMeNFT4.js";import{f as S}from"./utils-CLmukD0c.js";const gt="REVIEW";function Ut(){const[l,Ae]=c.useState(null),[j,v]=c.useState([]),[we,H]=c.useState([]),[T,ie]=c.useState({}),[C,Ee]=c.useState({}),[Q,Re]=c.useState({}),[Ce,Ue]=c.useState({}),[b,Ie]=c.useState(""),[g,h]=c.useState({}),[U,ae]=c.useState({}),[De,ke]=c.useState({}),[se,oe]=c.useState({}),[ce,de]=c.useState({}),[vt,ht]=c.useState({}),[yt,ft]=c.useState({}),[z,Me]=c.useState({}),[Oe,X]=c.useState({}),[_,J]=c.useState({}),[le,L]=c.useState({}),[re,ue]=c.useState({}),[p,N]=c.useState({}),[I,A]=c.useState(null),P=c.useRef(null),[F,me]=c.useState("Pending"),[K,$e]=c.useState([]),[w,q]=c.useState({}),[xe,Te]=c.useState({}),[G,B]=c.useState({}),[E,V]=c.useState({}),[_e,pe]=c.useState([]),[Le,be]=c.useState([]),[D,Pe]=c.useState({}),[Y,ge]=c.useState({}),[Fe,k]=c.useState(!1),[x,ve]=c.useState(null),[M,Z]=c.useState("");c.useEffect(()=>{at().then(e=>$e(e)),st().then(pe).catch(()=>pe([])),ot().then(be).catch(()=>be([]))},[]),c.useEffect(()=>{const e=t=>{I&&P.current&&!P.current.contains(t.target)&&(N(i=>({...i,[I]:!1})),A(null))},a=t=>{t.key==="Escape"&&I&&(N(i=>({...i,[I]:!1})),A(null))};return document.addEventListener("mousedown",e),document.addEventListener("keydown",a),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",a)}},[I]),c.useEffect(()=>{try{const e=localStorage.getItem("currentUser");e&&Ae(JSON.parse(e))}catch{}},[]),c.useEffect(()=>{var e,a;try{const t=(l==null?void 0:l.unitUic)||"",i=l!=null&&l.company&&l.company!=="N/A"?l.company:"",o=l!=null&&l.platoon&&l.platoon!=="N/A"?l.platoon:"",d=((a=(e=C[t])==null?void 0:e[i])==null?void 0:a[o])||"";Ie(d)}catch{}},[l,C]),c.useEffect(()=>{ct().then(e=>{v(e)}).catch(()=>v([]))},[]),c.useEffect(()=>{dt().then(e=>{H(e)}).catch(()=>H([]))},[]),c.useEffect(()=>{lt().then(e=>{const a={};for(const t of e)a[t.id]=t;ie(a)}).catch(()=>ie({}))},[]),c.useEffect(()=>{try{const e=localStorage.getItem("unit_structure"),a={},t={},i={};if(e){const o=JSON.parse(e);for(const d of Object.keys(o||{})){const s=o[d];s&&s._platoonSectionMap&&typeof s._platoonSectionMap=="object"&&(a[d]=s._platoonSectionMap),s&&Array.isArray(s._sections)&&(t[d]=s._sections),s&&Array.isArray(s._commandSections)&&(i[d]=s._commandSections)}}else(async()=>{try{const o=await nt();for(const d of Object.keys(o||{})){const s=o[d];s&&s._platoonSectionMap&&typeof s._platoonSectionMap=="object"&&(a[d]=s._platoonSectionMap),s&&Array.isArray(s._sections)&&(t[d]=s._sections),s&&Array.isArray(s._commandSections)&&(i[d]=s._commandSections)}}catch{}})();Ee(a),Ue(t),ke(i)}catch{}},[]);const he=c.useMemo(()=>{const e=(l==null?void 0:l.unitUic)||"";return j.filter(a=>{const i=(a.currentStage||"")==="EXTERNAL_REVIEW"?a.externalPendingUnitUic||a.unitUic||"":a.unitUic||"";return!!y(a)&&(e?i===e:!0)})},[j,l,y]),ye=c.useMemo(()=>{const e=a=>String(a||"").trim().replace(/^S(\d)\b/,"S-$1");return he.filter(a=>{const t=e(y(a)),i=e(b);return b?t===i:!0})},[he,b,y]),fe=c.useMemo(()=>ye.filter(e=>(e.currentStage||"")==="BATTALION_REVIEW"),[ye]),Se=c.useMemo(()=>{const e=t=>String(t||"").trim().replace(/^S(\d)\b/,"S-$1"),a=e(b);return a?j.filter(t=>{var r,m;const i=t.currentStage||"",o=(l==null?void 0:l.unitUic)||"",d=i==="EXTERNAL_REVIEW"?t.externalPendingUnitUic||t.unitUic||"":t.unitUic||"";if(o&&d!==o||i==="BATTALION_REVIEW"&&e(y(t))===a)return!1;const s=(r=t.activity)==null?void 0:r.some(R=>{const $=String(R.action||"");return $.includes(a)||$.includes(b)}),u=(m=t.activity)==null?void 0:m.some(R=>{const $=String(R.action||"");return $.includes(`routed to ${a}`)||$.includes(`routed to ${b}`)});return s||u}):[]},[j,l,b]);function y(e){var u,r;const a=m=>String(m||"").trim().replace(/^S(\d)\b/,"S-$1");if(e.routeSection)return a(e.routeSection);const t=e.unitUic||"",i=T[e.uploadedById],o=i!=null&&i.company&&i.company!=="N/A"?i.company:"",d=i!=null&&i.platoon&&i.platoon!=="N/A"?i.platoon:"",s=((r=(u=C[t])==null?void 0:u[o])==null?void 0:r[d])||"";return a(s)}const qe=e=>{const a=T[e.uploadedById];return a?[a.rank,a.lastName+",",a.firstName,a.mi?a.mi:""].filter(Boolean).join(" ").trim():"—"},ee=e=>we.filter(a=>a.requestId===e),Be=e=>`"${String(e??"").replace(/"/g,'""')}"`,Ve=e=>{const t=[["Request ID","Subject","Stage","Battalion Section","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const i of e){const o=ee(i.id).map(d=>d.name).join(" | ");t.push([i.id,i.subject,i.currentStage||"",y(i)||"",i.routeSection||"",qe(i),i.unitUic||"",new Date(i.createdAt).toLocaleString(),o])}return t.map(i=>i.map(Be).join(",")).join(`\r
`)},We=(e,a)=>{const t=new Blob([a],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(t),o=document.createElement("a");o.href=i,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i)},He=()=>We("battalion_all.csv",Ve([...fe,...Se])),Qe=async e=>{const a=U[e.id]||[];if(!a.length||!(l!=null&&l.id))return;const t=Date.now(),i=a.map((r,m)=>({id:`${t}-${m}`,name:r.name,type:r.type,size:r.size,uploadedAt:new Date().toISOString(),subject:e.subject,requestId:e.id})),o=S(l,"Reviewer"),d=O(),s={actor:o,actorRole:d,timestamp:new Date().toISOString(),action:`Reviewer added ${i.length} document(s)`,comment:(g[e.id]||"").trim()},u={...e,documentIds:[...e.documentIds||[],...i.map(r=>r.id)],activity:Array.isArray(e.activity)?[...e.activity,s]:[s]};try{await rt(i),await f(u),H(r=>[...r,...i]),v(r=>r.map(m=>m.id===u.id?u:m))}catch(r){console.error("Failed to add files to request:",r)}ae(r=>({...r,[e.id]:[]})),h(r=>({...r,[e.id]:""}))},O=()=>{const e=b||"";return e?`Battalion (${e})`:"Battalion"},W=e=>{const a=e==null?void 0:e.trim();return a?K.some(t=>{const i=t.unit_uics||t.unitUics||[];return Array.isArray(i)&&i.includes(a)}):!1},ze=e=>{const a=(e.activity||[]).slice().reverse().find(t=>/Commander/i.test(String(t.action||"")));return!!a&&/(Approved|Endorsed)/i.test(String(a.action||""))},Xe=async e=>{const a=se[e.id]||"COMMANDER",t=S(l,"Battalion"),i=O(),o=y(e)||b||"",d=a==="COMMANDER"?"Approved to COMMANDER":`Approved and routed to ${a}`,s={actor:t,actorRole:i,timestamp:new Date().toISOString(),action:d,comment:(g[e.id]||"").trim(),fromSection:o||void 0,toSection:a},u={...e,currentStage:"COMMANDER_REVIEW",routeSection:a==="COMMANDER"?"":a,activity:Array.isArray(e.activity)?[...e.activity,s]:[s]};try{await f({...u,unitUic:e.unitUic||""}),v(r=>r.map(m=>m.id===u.id?u:m)),h(r=>({...r,[e.id]:""})),oe(r=>({...r,[e.id]:""}))}catch(r){console.error("Failed to approve request:",r)}},Je=async e=>{const a=S(l,"Battalion"),t=O(),i={actor:a,actorRole:t,timestamp:new Date().toISOString(),action:"Returned to previous stage",comment:(g[e.id]||"").trim()},o={...e,currentStage:"COMPANY_REVIEW",activity:Array.isArray(e.activity)?[...e.activity,i]:[i]};try{await f(o),v(d=>d.map(s=>s.id===o.id?o:s)),h(d=>({...d,[e.id]:""}))}catch(d){console.error("Failed to reject request:",d)}},Ke=e=>{if(!e.ssic){alert("Request must have SSIC/retention classification before filing.");return}ve(e),Z(new Date().toISOString().split("T")[0]),k(!0)},Ge=async()=>{var d;if(!x||!l)return;if(!M){alert("Please select a finalized date.");return}const e=new Date(M+"T23:59:59").toISOString(),a=S(l,"Battalion"),t=O(),i={actor:a,actorRole:t,timestamp:new Date().toISOString(),action:"Filed for Records Management",comment:`Date Finalized: ${new Date(M).toLocaleDateString()}${(d=g[x.id])!=null&&d.trim()?` - ${g[x.id].trim()}`:""}`},o={...x,currentStage:"ARCHIVED",finalStatus:"Filed",filedAt:e,activity:Array.isArray(x.activity)?[...x.activity,i]:[i]};try{await f(o),v(s=>s.map(u=>u.id===o.id?o:u)),h(s=>({...s,[x.id]:""})),k(!1),ve(null),Z("")}catch(s){console.error("Failed to file request:",s)}},Ye=async e=>{const a=pt(e.currentStage||"");if(!a){alert("Cannot return from this stage.");return}const t=S(l,"Battalion"),i=O(),o=a===ne.ORIGINATOR_REVIEW?"Originator":a===ne.PLATOON_REVIEW?"Platoon":a===ne.COMPANY_REVIEW?"Company":"Lower Level",d={actor:t,actorRole:i,timestamp:new Date().toISOString(),action:`Returned to ${o} for filing`,comment:(g[e.id]||"").trim()},s={...e,currentStage:a,activity:Array.isArray(e.activity)?[...e.activity,d]:[d]};try{await f(s),v(u=>u.map(r=>r.id===s.id?s:r)),h(u=>({...u,[e.id]:""}))}catch(u){console.error("Failed to return request:",u)}},Ze=(e,a)=>{if(!a){J(o=>({...o,[e]:""})),X(o=>({...o,[e]:""})),ue(o=>({...o,[e]:[]})),L(o=>({...o,[e]:""}));return}const t=a.uic;J(o=>({...o,[e]:t})),X(o=>({...o,[e]:a.unitName}));let i=[];try{const o=localStorage.getItem("unit_structure");if(o){const s=JSON.parse(o)[t],u=s!=null&&s._sections&&Array.isArray(s._sections)?s._sections:[],r=s!=null&&s._commandSections&&Array.isArray(s._commandSections)?s._commandSections:[];i=[...u,...r]}}catch(o){console.error("Failed to load or parse unit sections from localStorage:",o)}ue(o=>({...o,[e]:i})),L(o=>({...o,[e]:""}))},et=async e=>{const a=_[e.id]||"",t=Oe[e.id]||"",i=le[e.id]||"",o=S(l,"Battalion");let d;if(w[e.id]){const s=K.find(m=>{const R=m.unit_uics||m.unitUics||[];return Array.isArray(R)&&R.includes(e.unitUic||"")});if(!s){alert("The selected unit is not part of any installation.");return}const u=`Sent to installation: ${s.name}`,r={actor:o,timestamp:new Date().toISOString(),action:u,comment:(g[e.id]||"").trim()};d={...e,currentStage:"INSTALLATION_REVIEW",installationId:s.id,externalPendingUnitName:void 0,externalPendingUnitUic:void 0,externalPendingStage:void 0,routeSection:xe[e.id]||"",activity:[...e.activity||[],r]}}else if(E[e.id]){const s=D[e.id]||"",u=Y[e.id]||"";if(!s||!u){alert("Select HQMC division and section");return}const r=`Sent to HQMC: ${s} - ${u}`,m={actor:o,timestamp:new Date().toISOString(),action:r,comment:(g[e.id]||"").trim()};d={...e,routeSection:u,externalPendingUnitName:void 0,externalPendingUnitUic:void 0,externalPendingStage:void 0,activity:[...e.activity||[],m]}}else{if(!a.trim()){alert("Please select an external unit");return}const s=i?`Sent to external unit: ${t} - ${i}`:`Sent to external unit: ${t}`,u={actor:o,timestamp:new Date().toISOString(),action:s,comment:(g[e.id]||"").trim()};d={...e,currentStage:"EXTERNAL_REVIEW",externalPendingUnitName:t,externalPendingUnitUic:a,externalPendingStage:i||gt,routeSection:i||"",activity:[...e.activity||[],u]}}try{await f(d),v(s=>s.map(u=>u.id===d.id?d:u)),h(s=>({...s,[e.id]:""})),X(s=>({...s,[e.id]:""})),J(s=>({...s,[e.id]:""})),L(s=>({...s,[e.id]:""})),q(s=>({...s,[e.id]:!1})),V(s=>({...s,[e.id]:!1})),B(s=>({...s,[e.id]:!1}))}catch(s){console.error("Failed to send request to external unit:",s),alert("Failed to send request to external unit. Please try again.")}},te=c.useMemo(()=>{const e=(l==null?void 0:l.unitUic)||"";return j.filter(a=>{if((a.currentStage||"")!=="EXTERNAL_REVIEW")return!1;const i=a.externalPendingUnitUic||a.unitUic||"";return e?i===e:!0})},[j,l]),tt=async e=>{const a=z[e.id];if(!a)return;const t=S(l,"Battalion"),i={...e,currentStage:"BATTALION_REVIEW",unitUic:(l==null?void 0:l.unitUic)||e.externalPendingUnitUic||e.unitUic,routeSection:a,externalPendingUnitUic:void 0,externalPendingUnitName:void 0,externalPendingStage:void 0,activity:Array.isArray(e.activity)?[...e.activity,{actor:t,timestamp:new Date().toISOString(),action:`Battalion assigned external request to section ${a}`}]:[{actor:t,timestamp:new Date().toISOString(),action:`Battalion assigned external request to section ${a}`}]};try{await f(i),v(o=>o.map(d=>d.id===i.id?i:d))}catch(o){console.error("Failed to assign external request to section:",o)}};return n.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[n.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Unit Section Dashboard"}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:b||"—"}),n.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:He,children:"Export All"})]})]}),n.jsxs("div",{className:"space-y-8",children:[te.length>0&&n.jsxs("div",{className:"p-4 border border-brand-gold rounded-lg bg-brand-cream",children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Pending Assignment (External Requests)"}),n.jsxs("span",{className:"text-xs px-2 py-1 bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:[te.length," item(s)"]})]}),n.jsx("div",{className:"flex flex-col gap-4",children:te.map(e=>n.jsxs("div",{className:"p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] transition-all duration-300",children:[n.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-2",children:[n.jsxs("div",{children:[n.jsx("div",{className:"font-medium text-[var(--text)]",children:e.subject}),n.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(e.createdAt).toLocaleString()]}),n.jsxs("div",{className:"text-xs text-[var(--muted)] mt-1",children:["From ",e.externalPendingUnitName||"External Unit"]})]}),n.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:"EXTERNAL_REVIEW"})]}),n.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[n.jsx("label",{className:"text-sm text-[var(--text)]",children:"Assign to Section"}),n.jsxs("select",{value:z[e.id]||"",onChange:a=>Me(t=>({...t,[e.id]:a.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[n.jsx("option",{value:"",children:"Select section"}),(Ce[(l==null?void 0:l.unitUic)||""]||[]).map(a=>n.jsx("option",{value:a,children:a},a))]}),n.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",disabled:!z[e.id],onClick:()=>tt(e),children:"Assign"})]})]},e.id))})]}),n.jsx("div",{className:"border-b border-gray-200",children:n.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[n.jsx("button",{onClick:()=>me("Pending"),className:`${F==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),n.jsx("button",{onClick:()=>me("Previously in Section"),className:`${F==="Previously in Section"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Previously in Section"})]})}),n.jsxs("div",{className:"mt-4",children:[F==="Pending"&&n.jsx(je,{title:"Pending",requests:fe,users:T,onRowClick:e=>de(a=>({...a,[e.id]:!a[e.id]})),expandedRows:ce,platoonSectionMap:C,children:e=>{var a;return n.jsxs("div",{id:`details-sec-${e.id}`,className:"p-4 bg-gray-50",children:[n.jsx("div",{className:"mt-3",children:n.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!p[e.id],"aria-controls":`docs-sec-${e.id}`,onClick:()=>{N(t=>({...t,[e.id]:!t[e.id]})),A(t=>p[e.id]?null:e.id)},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),N(i=>({...i,[e.id]:!i[e.id]})),A(i=>p[e.id]?null:e.id))},children:[n.jsx("span",{children:"Show Documents"}),n.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${p[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:n.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),n.jsx("div",{id:`docs-sec-${e.id}`,ref:p[e.id]?P:void 0,className:`${p[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:n.jsx(Ne,{documents:ee(e.id).map(t=>({...t,fileUrl:t.fileUrl}))})}),n.jsxs("div",{className:"mt-3",children:[n.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Re(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!Q[e.id],"aria-controls":`logs-sec-${e.id}`,children:[Q[e.id]?"Hide":"Show"," Activity Log"]}),n.jsx("div",{id:`logs-sec-${e.id}`,className:Q[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,i)=>n.jsxs("div",{className:"text-xs text-gray-700",children:[n.jsxs("div",{className:"font-medium",children:[t.actor,t.actorRole?` • ${t.actorRole}`:""," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&n.jsx("div",{className:"text-gray-600",children:t.comment})]},i)):n.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),n.jsx("textarea",{rows:2,value:g[e.id]||"",onChange:t=>h(i=>({...i,[e.id]:t.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),n.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[n.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[n.jsx("input",{type:"file",multiple:!0,onChange:t=>ae(i=>({...i,[e.id]:t.target.files?Array.from(t.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),n.jsx("span",{className:"text-xs text-[var(--muted)]",children:(U[e.id]||[]).length?`${(U[e.id]||[]).length} file(s) selected`:"No files selected"}),n.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>Qe(e),disabled:!U[e.id]||!(U[e.id]||[]).length,children:"Save Files"})]}),e.currentStage==="BATTALION_REVIEW"&&!ze(e)&&n.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[n.jsxs("select",{value:se[e.id]||"COMMANDER",onChange:t=>oe(i=>({...i,[e.id]:t.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[n.jsx("option",{value:"COMMANDER",children:"Commander"}),(De[(l==null?void 0:l.unitUic)||""]||[]).map(t=>n.jsx("option",{value:t,children:t},t))]}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Xe(e),children:"Approve"}),n.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Je(e),children:"Return"})]}),(ut(e)||mt(e))&&!e.filedAt&&n.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[n.jsx("button",{className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-blue-500",onClick:()=>Ke(e),children:"File"}),xt(e)&&n.jsx("button",{className:"px-3 py-2 rounded bg-amber-500 text-white hover:bg-amber-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-amber-400",onClick:()=>Ye(e),children:"Return"})]}),((a=e.activity)==null?void 0:a.some(t=>/(endorsed by commander|commander.*endorsed)/i.test(String(t.action||""))))&&n.jsxs("div",{className:"mt-3 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[n.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Send Options"}),n.jsxs("div",{className:"flex flex-col gap-2",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("input",{type:"checkbox",id:`send-to-external-${e.id}`,checked:G[e.id]||!1,onChange:()=>{const t=!G[e.id];B(i=>({...i,[e.id]:t})),t&&(q(i=>({...i,[e.id]:!1})),V(i=>({...i,[e.id]:!1})))}}),n.jsx("label",{htmlFor:`send-to-external-${e.id}`,children:"Send to External Unit"}),n.jsx("input",{type:"checkbox",id:`submit-to-installation-${e.id}`,checked:w[e.id]||!1,onChange:()=>{const t=!w[e.id];q(i=>({...i,[e.id]:t})),t&&(B(i=>({...i,[e.id]:!1})),V(i=>({...i,[e.id]:!1})))},disabled:!W(e.unitUic)}),n.jsx("label",{htmlFor:`submit-to-installation-${e.id}`,children:"Submit to Installation"}),n.jsx("input",{type:"checkbox",id:`submit-to-hqmc-${e.id}`,checked:E[e.id]||!1,onChange:()=>{const t=!E[e.id];V(i=>({...i,[e.id]:t})),t&&(B(i=>({...i,[e.id]:!1})),q(i=>({...i,[e.id]:!1})))}}),n.jsx("label",{htmlFor:`submit-to-hqmc-${e.id}`,children:"Submit to HQMC"})]}),G[e.id]&&n.jsxs(n.Fragment,{children:[n.jsx(bt,{onUnitSelect:t=>Ze(e.id,t),selectedUnit:it.find(t=>t.uic===_[e.id]),placeholder:"Search by UIC, RUC, MCC, or Unit Name"}),n.jsxs("select",{value:le[e.id]||"",onChange:t=>L(i=>({...i,[e.id]:t.target.value})),disabled:!_[e.id]||!(re[e.id]||[]).length,className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:[n.jsx("option",{value:"",children:"Select Section/Office (optional)"}),(re[e.id]||[]).map(t=>n.jsx("option",{value:t,children:t},t))]})]}),n.jsx("div",{className:"flex items-center gap-2",children:!W(e.unitUic)&&n.jsx("p",{className:"text-xs text-gray-500",children:"Not assigned to installation."})}),w[e.id]&&W(e.unitUic)&&n.jsxs("select",{value:xe[e.id]||"",onChange:t=>Te(i=>({...i,[e.id]:t.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[n.jsx("option",{value:"",children:"Select Installation Section/Office (optional)"}),(()=>{const t=K.find(o=>{const d=o.unit_uics||o.unitUics||[];return Array.isArray(d)&&d.includes(e.unitUic||"")});return((t==null?void 0:t.sections)||[]).map(o=>n.jsx("option",{value:o,children:o},o))})()]}),E[e.id]&&n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[n.jsxs("select",{value:D[e.id]||"",onChange:t=>{Pe(i=>({...i,[e.id]:t.target.value})),ge(i=>({...i,[e.id]:""}))},className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[n.jsx("option",{value:"",children:"Select HQMC Division"}),_e.map(t=>n.jsxs("option",{value:t.code,children:[t.code," — ",t.name]},t.code))]}),n.jsxs("select",{value:Y[e.id]||"",onChange:t=>ge(i=>({...i,[e.id]:t.target.value})),disabled:!D[e.id],className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:[n.jsx("option",{value:"",children:"Select HQMC Section"}),Le.filter(t=>String(t.division_code||"")===String(D[e.id]||"")).map(t=>n.jsx("option",{value:t.branch,children:t.branch},t.branch))]})]}),n.jsx("div",{className:"mt-2",children:n.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>et(e),disabled:w[e.id]?!W(e.unitUic):E[e.id]?!(D[e.id]&&Y[e.id]):!_[e.id],children:w[e.id]?"Submit to Installation":E[e.id]?"Submit to HQMC":"Submit to External"})})]})]})]})}}),F==="Previously in Section"&&n.jsx(je,{title:"Previously in Section",requests:Se,users:T,onRowClick:e=>de(a=>({...a,[e.id]:!a[e.id]})),expandedRows:ce,platoonSectionMap:C,children:e=>n.jsxs("div",{id:`details-sec-${e.id}`,className:"p-4 bg-gray-50",children:[n.jsx("div",{className:"mt-3",children:n.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!p[e.id],"aria-controls":`docs-sec-${e.id}`,onClick:()=>{N(a=>({...a,[e.id]:!a[e.id]})),A(a=>p[e.id]?null:e.id)},onKeyDown:a=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),N(t=>({...t,[e.id]:!t[e.id]})),A(t=>p[e.id]?null:e.id))},children:[n.jsx("span",{children:"Show Documents"}),n.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${p[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:n.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),n.jsx("div",{id:`docs-sec-${e.id}`,ref:p[e.id]?P:void 0,className:`${p[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:n.jsx(Ne,{documents:ee(e.id).map(a=>({...a,fileUrl:a.fileUrl}))})})]})})]})]})]}),Fe&&x&&n.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]",onClick:()=>k(!1),children:n.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md p-6",onClick:e=>e.stopPropagation(),children:[n.jsxs("div",{className:"flex justify-between items-center mb-4",children:[n.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"File for Records Management"}),n.jsx("button",{className:"text-gray-500 hover:text-gray-700",onClick:()=>k(!1),children:"✕"})]}),n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date Finalized"}),n.jsx("input",{type:"date",value:M,onChange:e=>Z(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),n.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"This date will be used to calculate the disposal date based on the retention schedule."})]}),n.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 text-sm",children:[n.jsx("div",{className:"font-medium text-gray-700 mb-1",children:"Retention Info"}),n.jsxs("div",{className:"text-gray-600",children:[n.jsxs("div",{children:["SSIC: ",x.ssic," - ",x.ssicNomenclature]}),n.jsxs("div",{children:["Retention: ",x.isPermanent?"Permanent":`${x.retentionValue} ${x.retentionUnit}`]}),n.jsxs("div",{children:["Cutoff: ",x.cutoffDescription||x.cutoffTrigger]})]})]})]}),n.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[n.jsx("button",{type:"button",onClick:()=>k(!1),className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50",children:"Cancel"}),n.jsx("button",{type:"button",onClick:Ge,disabled:!M,className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50",children:"File Record"})]})]})})]})}export{Ut as default};
