import{r,j as i}from"./index-UUCbtA12.js";import{l as We}from"./unitStructure-QC5qYuxv.js";import{U as Ve}from"./units-CaNgy_2U.js";import{w as Qe,k as Xe,p as Je,c as Ke,l as ze,e as Ge,f as Ye,u as w}from"./db-Y4g5ldnd.js";import{R as ge}from"./RequestTable-0q-w1zkb.js";import{S as Ze}from"./SearchableUnitSelector-Bk7PhxZh.js";const et="REVIEW";function ut(){const[c,he]=r.useState(null),[g,b]=r.useState([]),[ye,F]=r.useState([]),[M,G]=r.useState({}),[U,fe]=r.useState({}),[H,Se]=r.useState({}),[je,Ne]=r.useState({}),[p,Ae]=r.useState(""),[v,h]=r.useState({}),[C,Y]=r.useState({}),[Ee,we]=r.useState({}),[Z,ee]=r.useState({}),[te,ne]=r.useState({}),[tt,nt]=r.useState({}),[it,at]=r.useState({}),[W,Ue]=r.useState({}),[Ce,V]=r.useState({}),[$,Q]=r.useState({}),[ie,O]=r.useState({}),[ae,se]=r.useState({}),[m,y]=r.useState({}),[R,f]=r.useState(null),_=r.useRef(null),[T,oe]=r.useState("Pending"),[X,Re]=r.useState([]),[S,L]=r.useState({}),[ce,De]=r.useState({}),[J,P]=r.useState({}),[j,q]=r.useState({}),[Ie,de]=r.useState([]),[ke,re]=r.useState([]),[D,Me]=r.useState({}),[K,le]=r.useState({});r.useEffect(()=>{Qe().then(e=>Re(e)),Xe().then(de).catch(()=>de([])),Je().then(re).catch(()=>re([]))},[]),r.useEffect(()=>{const e=t=>{R&&_.current&&!_.current.contains(t.target)&&(y(n=>({...n,[R]:!1})),f(null))},a=t=>{t.key==="Escape"&&R&&(y(n=>({...n,[R]:!1})),f(null))};return document.addEventListener("mousedown",e),document.addEventListener("keydown",a),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",a)}},[R]),r.useEffect(()=>{try{const e=localStorage.getItem("currentUser");e&&he(JSON.parse(e))}catch{}},[]),r.useEffect(()=>{var e,a;try{const t=(c==null?void 0:c.unitUic)||"",n=c!=null&&c.company&&c.company!=="N/A"?c.company:"",o=c!=null&&c.platoon&&c.platoon!=="N/A"?c.platoon:"",d=((a=(e=U[t])==null?void 0:e[n])==null?void 0:a[o])||"";Ae(d)}catch{}},[c,U]),r.useEffect(()=>{Ke().then(e=>{b(e)}).catch(()=>b([]))},[]),r.useEffect(()=>{ze().then(e=>{F(e)}).catch(()=>F([]))},[]),r.useEffect(()=>{Ge().then(e=>{const a={};for(const t of e)a[t.id]=t;G(a)}).catch(()=>G({}))},[]),r.useEffect(()=>{try{const e=localStorage.getItem("unit_structure"),a={},t={},n={};if(e){const o=JSON.parse(e);for(const d of Object.keys(o||{})){const s=o[d];s&&s._platoonSectionMap&&typeof s._platoonSectionMap=="object"&&(a[d]=s._platoonSectionMap),s&&Array.isArray(s._sections)&&(t[d]=s._sections),s&&Array.isArray(s._commandSections)&&(n[d]=s._commandSections)}}else(async()=>{try{const o=await We();for(const d of Object.keys(o||{})){const s=o[d];s&&s._platoonSectionMap&&typeof s._platoonSectionMap=="object"&&(a[d]=s._platoonSectionMap),s&&Array.isArray(s._sections)&&(t[d]=s._sections),s&&Array.isArray(s._commandSections)&&(n[d]=s._commandSections)}}catch{}})();fe(a),Ne(t),we(n),console.log("SectionDashboard - loaded commandSections:",n),console.log("SectionDashboard - current user UIC:",c==null?void 0:c.unitUic),console.log("SectionDashboard - command sections for current user:",n[(c==null?void 0:c.unitUic)||""])}catch{}},[]);const ue=r.useMemo(()=>{const e=(c==null?void 0:c.unitUic)||"";return g.filter(a=>{const n=(a.currentStage||"")==="EXTERNAL_REVIEW"?a.externalPendingUnitUic||a.unitUic||"":a.unitUic||"";return!!N(a)&&(e?n===e:!0)})},[g,c,N]),me=r.useMemo(()=>{const e=a=>String(a||"").trim().replace(/^S(\d)\b/,"S-$1");return ue.filter(a=>{const t=e(N(a)),n=e(p);return p?t===n:!0})},[ue,p,N]),xe=r.useMemo(()=>me.filter(e=>(e.currentStage||"")==="BATTALION_REVIEW"),[me]),be=r.useMemo(()=>{const e=t=>String(t||"").trim().replace(/^S(\d)\b/,"S-$1"),a=e(p);return a?g.filter(t=>{var u,x;const n=t.currentStage||"",o=(c==null?void 0:c.unitUic)||"",d=n==="EXTERNAL_REVIEW"?t.externalPendingUnitUic||t.unitUic||"":t.unitUic||"";if(o&&d!==o||n==="BATTALION_REVIEW"&&e(N(t))===a)return!1;const s=(u=t.activity)==null?void 0:u.some(E=>{const k=String(E.action||"");return k.includes(a)||k.includes(p)}),l=(x=t.activity)==null?void 0:x.some(E=>{const k=String(E.action||"");return k.includes(`routed to ${a}`)||k.includes(`routed to ${p}`)});return s||l}):[]},[g,c,p]);function N(e){var l,u;const a=x=>String(x||"").trim().replace(/^S(\d)\b/,"S-$1");if(e.routeSection)return a(e.routeSection);const t=e.unitUic||"",n=M[e.uploadedById],o=n!=null&&n.company&&n.company!=="N/A"?n.company:"",d=n!=null&&n.platoon&&n.platoon!=="N/A"?n.platoon:"",s=((u=(l=U[t])==null?void 0:l[o])==null?void 0:u[d])||"";return a(s)}const $e=e=>{const a=M[e.uploadedById];return a?[a.rank,a.lastName+",",a.firstName,a.mi?a.mi:""].filter(Boolean).join(" ").trim():"—"},I=e=>ye.filter(a=>a.requestId===e),Oe=e=>`"${String(e??"").replace(/"/g,'""')}"`,_e=e=>{const t=[["Request ID","Subject","Stage","Battalion Section","Route Section","Originator","Unit UIC","Created At","Documents"]];for(const n of e){const o=I(n.id).map(d=>d.name).join(" | ");t.push([n.id,n.subject,n.currentStage||"",N(n)||"",n.routeSection||"",$e(n),n.unitUic||"",new Date(n.createdAt).toLocaleString(),o])}return t.map(n=>n.map(Oe).join(",")).join(`\r
`)},Te=(e,a)=>{const t=new Blob([a],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)},Le=()=>Te("battalion_all.csv",_e([...xe,...be])),Pe=async e=>{const a=C[e.id]||[];if(!a.length||!(c!=null&&c.id))return;const t=Date.now(),n=a.map((l,u)=>({id:`${t}-${u}`,name:l.name,type:l.type,size:l.size,uploadedAt:new Date().toISOString(),subject:e.subject,requestId:e.id})),d={actor:A(c)||"Reviewer",timestamp:new Date().toISOString(),action:`Reviewer added ${n.length} document(s)`,comment:(v[e.id]||"").trim()},s={...e,documentIds:[...e.documentIds||[],...n.map(l=>l.id)],activity:Array.isArray(e.activity)?[...e.activity,d]:[d]};try{await Ye(n),await w(s),F(l=>[...l,...n]),b(l=>l.map(u=>u.id===s.id?s:u))}catch(l){console.error("Failed to add files to request:",l)}Y(l=>({...l,[e.id]:[]})),h(l=>({...l,[e.id]:""}))},A=e=>{if(!e)return null;const{rank:a,lastName:t,firstName:n,mi:o}=e;return`${a} ${t}, ${n}${o?` ${o}`:""}`},B=e=>{const a=e==null?void 0:e.trim();return a?X.some(t=>{const n=t.unit_uics||t.unitUics||[];return Array.isArray(n)&&n.includes(a)}):!1},qe=async e=>{const a=Z[e.id]||"COMMANDER",t=A(c)||"Battalion",n=a==="COMMANDER"?"Approved to COMMANDER":`Approved and routed to ${a}`,o={actor:t,timestamp:new Date().toISOString(),action:n,comment:(v[e.id]||"").trim()},d={...e,currentStage:"COMMANDER_REVIEW",routeSection:a==="COMMANDER"?"":a,activity:Array.isArray(e.activity)?[...e.activity,o]:[o]};console.log("Approving request:",{id:e.id,dest:a,routeSection:d.routeSection,currentStage:d.currentStage});try{await w({...d,unitUic:e.unitUic||""}),b(s=>s.map(l=>l.id===d.id?d:l)),h(s=>({...s,[e.id]:""})),ee(s=>({...s,[e.id]:""}))}catch(s){console.error("Failed to approve request:",s)}},pe=async e=>{const t={actor:A(c)||"Battalion",timestamp:new Date().toISOString(),action:"Returned to previous stage",comment:(v[e.id]||"").trim()},n={...e,currentStage:"COMPANY_REVIEW",activity:Array.isArray(e.activity)?[...e.activity,t]:[t]};try{await w(n),b(o=>o.map(d=>d.id===n.id?n:d)),h(o=>({...o,[e.id]:""}))}catch(o){console.error("Failed to reject request:",o)}},ve=async e=>{const t={actor:A(c)||"Battalion",timestamp:new Date().toISOString(),action:"Archived",comment:(v[e.id]||"").trim()},n={...e,currentStage:"ARCHIVED",finalStatus:"Archived",activity:Array.isArray(e.activity)?[...e.activity,t]:[t]};try{await w(n),b(o=>o.map(d=>d.id===n.id?n:d)),h(o=>({...o,[e.id]:""}))}catch(o){console.error("Failed to archive request:",o)}},Be=(e,a)=>{if(!a){Q(o=>({...o,[e]:""})),V(o=>({...o,[e]:""})),se(o=>({...o,[e]:[]})),O(o=>({...o,[e]:""}));return}const t=a.uic;Q(o=>({...o,[e]:t})),V(o=>({...o,[e]:a.unitName}));let n=[];try{const o=localStorage.getItem("unit_structure");if(o){const s=JSON.parse(o)[t],l=s!=null&&s._sections&&Array.isArray(s._sections)?s._sections:[],u=s!=null&&s._commandSections&&Array.isArray(s._commandSections)?s._commandSections:[];n=[...l,...u]}}catch(o){console.error("Failed to load or parse unit sections from localStorage:",o)}se(o=>({...o,[e]:n})),O(o=>({...o,[e]:""}))},Fe=async e=>{const a=$[e.id]||"",t=Ce[e.id]||"",n=ie[e.id]||"",o=A(c)||"Battalion";let d;if(S[e.id]){const s=X.find(x=>{const E=x.unit_uics||x.unitUics||[];return Array.isArray(E)&&E.includes(e.unitUic||"")});if(!s){alert("The selected unit is not part of any installation.");return}const l=`Sent to installation: ${s.name}`,u={actor:o,timestamp:new Date().toISOString(),action:l,comment:(v[e.id]||"").trim()};d={...e,currentStage:"INSTALLATION_REVIEW",installationId:s.id,externalPendingUnitName:void 0,externalPendingUnitUic:void 0,externalPendingStage:void 0,routeSection:ce[e.id]||"",activity:[...e.activity||[],u]}}else if(j[e.id]){const s=D[e.id]||"",l=K[e.id]||"";if(!s||!l){alert("Select HQMC division and section");return}const u=`Sent to HQMC: ${s} - ${l}`,x={actor:o,timestamp:new Date().toISOString(),action:u,comment:(v[e.id]||"").trim()};d={...e,routeSection:l,externalPendingUnitName:void 0,externalPendingUnitUic:void 0,externalPendingStage:void 0,activity:[...e.activity||[],x]}}else{if(!a.trim()){alert("Please select an external unit");return}const s=n?`Sent to external unit: ${t} - ${n}`:`Sent to external unit: ${t}`,l={actor:o,timestamp:new Date().toISOString(),action:s,comment:(v[e.id]||"").trim()};d={...e,currentStage:"EXTERNAL_REVIEW",externalPendingUnitName:t,externalPendingUnitUic:a,externalPendingStage:n||et,routeSection:n||"",activity:[...e.activity||[],l]}}try{await w(d),b(s=>s.map(l=>l.id===d.id?d:l)),h(s=>({...s,[e.id]:""})),V(s=>({...s,[e.id]:""})),Q(s=>({...s,[e.id]:""})),O(s=>({...s,[e.id]:""})),L(s=>({...s,[e.id]:!1})),q(s=>({...s,[e.id]:!1})),P(s=>({...s,[e.id]:!1}))}catch(s){console.error("Failed to send request to external unit:",s),alert("Failed to send request to external unit. Please try again.")}},z=r.useMemo(()=>{const e=(c==null?void 0:c.unitUic)||"";return g.filter(a=>{if((a.currentStage||"")!=="EXTERNAL_REVIEW")return!1;const n=a.externalPendingUnitUic||a.unitUic||"";return e?n===e:!0})},[g,c]),He=async e=>{const a=W[e.id];if(!a)return;const t=A(c)||"Battalion",n={...e,currentStage:"BATTALION_REVIEW",unitUic:(c==null?void 0:c.unitUic)||e.externalPendingUnitUic||e.unitUic,routeSection:a,externalPendingUnitUic:void 0,externalPendingUnitName:void 0,externalPendingStage:void 0,activity:Array.isArray(e.activity)?[...e.activity,{actor:t,timestamp:new Date().toISOString(),action:`Battalion assigned external request to section ${a}`}]:[{actor:t,timestamp:new Date().toISOString(),action:`Battalion assigned external request to section ${a}`}]};try{await w(n),b(o=>o.map(d=>d.id===n.id?n:d))}catch(o){console.error("Failed to assign external request to section:",o)}};return i.jsx("div",{className:"max-w-7xl mx-auto p-6",children:i.jsxs("div",{className:"bg-[var(--surface)] rounded-lg shadow p-6",children:[i.jsxs("div",{className:"flex items-center justify-between mb-4",children:[i.jsx("h2",{className:"text-xl font-semibold text-[var(--text)]",children:"Battalion Section Dashboard"}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:p||"—"}),i.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:Le,children:"Export All"})]})]}),i.jsxs("div",{className:"space-y-8",children:[z.length>0&&i.jsxs("div",{className:"p-4 border border-brand-gold rounded-lg bg-brand-cream",children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsx("h3",{className:"text-lg font-semibold text-[var(--text)]",children:"Pending Assignment (External Requests)"}),i.jsxs("span",{className:"text-xs px-2 py-1 bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:[z.length," item(s)"]})]}),i.jsx("div",{className:"flex flex-col gap-4",children:z.map(e=>i.jsxs("div",{className:"p-4 border border-brand-navy/20 rounded-lg bg-[var(--surface)] transition-all duration-300",children:[i.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-2",children:[i.jsxs("div",{children:[i.jsx("div",{className:"font-medium text-[var(--text)]",children:e.subject}),i.jsxs("div",{className:"text-sm text-[var(--muted)]",children:["Submitted ",new Date(e.createdAt).toLocaleString()]}),i.jsxs("div",{className:"text-xs text-[var(--muted)] mt-1",children:["From ",e.externalPendingUnitName||"External Unit"]})]}),i.jsx("span",{className:"px-2 py-1 text-xs bg-brand-cream text-brand-navy rounded-full border border-brand-navy/30",children:"EXTERNAL_REVIEW"})]}),i.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[i.jsx("label",{className:"text-sm text-[var(--text)]",children:"Assign to Section"}),i.jsxs("select",{value:W[e.id]||"",onChange:a=>Ue(t=>({...t,[e.id]:a.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[i.jsx("option",{value:"",children:"Select section"}),(je[(c==null?void 0:c.unitUic)||""]||[]).map(a=>i.jsx("option",{value:a,children:a},a))]}),i.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",disabled:!W[e.id],onClick:()=>He(e),children:"Assign"})]})]},e.id))})]}),i.jsx("div",{className:"border-b border-gray-200",children:i.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[i.jsx("button",{onClick:()=>oe("Pending"),className:`${T==="Pending"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Pending"}),i.jsx("button",{onClick:()=>oe("Previously in Section"),className:`${T==="Previously in Section"?"border-brand-navy text-brand-navy":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`,children:"Previously in Section"})]})}),i.jsxs("div",{className:"mt-4",children:[T==="Pending"&&i.jsx(ge,{title:"Pending",requests:xe,users:M,onRowClick:e=>ne(a=>({...a,[e.id]:!a[e.id]})),expandedRows:te,platoonSectionMap:U,children:e=>{var a;return i.jsxs("div",{id:`details-sec-${e.id}`,className:"p-4 bg-gray-50",children:[i.jsx("div",{className:"mt-3",children:i.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!m[e.id],"aria-controls":`docs-sec-${e.id}`,onClick:()=>{y(t=>({...t,[e.id]:!t[e.id]})),f(t=>m[e.id]?null:e.id)},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),y(n=>({...n,[e.id]:!n[e.id]})),f(n=>m[e.id]?null:e.id))},children:[i.jsx("span",{children:"Show Documents"}),i.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${m[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:i.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),i.jsxs("div",{id:`docs-sec-${e.id}`,ref:m[e.id]?_:void 0,className:`${m[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[I(e.id).map(t=>i.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[i.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[i.jsx("div",{className:"font-medium text-[var(--text)]",children:t.name}),i.jsx("div",{children:new Date(t.uploadedAt).toLocaleDateString()})]}),i.jsx("div",{className:"flex items-center gap-2",children:t.fileUrl?i.jsx("a",{href:t.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",children:"Open"}):i.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},t.id)),I(e.id).length===0&&i.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]}),i.jsxs("div",{className:"mt-3",children:[i.jsxs("button",{className:"px-3 py-1 text-xs rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>Se(t=>({...t,[e.id]:!t[e.id]})),"aria-expanded":!!H[e.id],"aria-controls":`logs-sec-${e.id}`,children:[H[e.id]?"Hide":"Show"," Activity Log"]}),i.jsx("div",{id:`logs-sec-${e.id}`,className:H[e.id]?"mt-2 space-y-2":"hidden",children:e.activity&&e.activity.length?e.activity.map((t,n)=>i.jsxs("div",{className:"text-xs text-gray-700",children:[i.jsxs("div",{className:"font-medium",children:[t.actor," • ",new Date(t.timestamp).toLocaleString()," • ",t.action]}),t.comment&&i.jsx("div",{className:"text-gray-600",children:t.comment})]},n)):i.jsx("div",{className:"text-xs text-gray-500",children:"No activity"})})]}),i.jsxs("div",{className:"mt-3",children:[i.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-1",children:"Reviewer Comment"}),i.jsx("textarea",{rows:2,value:v[e.id]||"",onChange:t=>h(n=>({...n,[e.id]:t.target.value})),className:"w-full px-3 py-2 border border-brand-navy/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-gold",placeholder:"Optional notes"})]}),i.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[i.jsxs("label",{className:"bg-brand-navy text-brand-cream px-3 py-1 rounded hover:bg-brand-red-2 cursor-pointer inline-block",children:[i.jsx("input",{type:"file",multiple:!0,onChange:t=>Y(n=>({...n,[e.id]:t.target.files?Array.from(t.target.files):[]})),className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"}),"Add Files"]}),i.jsx("span",{className:"text-xs text-[var(--muted)]",children:(C[e.id]||[]).length?`${(C[e.id]||[]).length} file(s) selected`:"No files selected"}),i.jsx("button",{className:"px-3 py-1 text-xs bg-brand-gold text-brand-charcoal rounded hover:bg-brand-gold-2",onClick:()=>Pe(e),disabled:!C[e.id]||!(C[e.id]||[]).length,children:"Save Files"}),i.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[i.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2",onClick:()=>pe(e),children:"Return to Previous"}),i.jsx("button",{className:"px-3 py-1 text-xs rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2",onClick:()=>ve(e),children:"Archive"})]})]}),(()=>{const n=(e.currentStage||"")==="BATTALION_REVIEW",o=(e.activity||[]).slice().reverse().find(s=>/Commander/i.test(String(s.action||""))),d=!!o&&/(Approved|Endorsed)/i.test(String(o.action||""));return n&&!d?i.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[i.jsxs("select",{value:Z[e.id]||"COMMANDER",onChange:s=>{console.log("SectionDashboard - Command section selected:",s.target.value,"for request:",e.id),ee(l=>({...l,[e.id]:s.target.value}))},className:"px-3 py-2 border border-brand-navy/30 rounded-lg",children:[i.jsx("option",{value:"COMMANDER",children:"Commander"}),(Ee[(c==null?void 0:c.unitUic)||""]||[]).map(s=>i.jsx("option",{value:s,children:s},s))]}),i.jsx("button",{className:"px-3 py-2 rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>qe(e),children:"Approve"}),i.jsx("button",{className:"px-3 py-2 rounded bg-brand-navy text-brand-cream hover:bg-brand-red-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>pe(e),children:"Return"}),i.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",onClick:()=>ve(e),children:"Archive"})]}):null})(),((a=e.activity)==null?void 0:a.some(t=>/(endorsed by commander|commander.*endorsed)/i.test(String(t.action||""))))&&i.jsxs("div",{className:"mt-3 p-3 border border-brand-navy/20 rounded-lg bg-brand-cream/30",children:[i.jsx("label",{className:"block text-sm font-medium text-[var(--text)] mb-2",children:"Send Options"}),i.jsxs("div",{className:"flex flex-col gap-2",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("input",{type:"checkbox",id:`send-to-external-${e.id}`,checked:J[e.id]||!1,onChange:()=>{const t=!J[e.id];P(n=>({...n,[e.id]:t})),t&&(L(n=>({...n,[e.id]:!1})),q(n=>({...n,[e.id]:!1})))}}),i.jsx("label",{htmlFor:`send-to-external-${e.id}`,children:"Send to External Unit"}),i.jsx("input",{type:"checkbox",id:`submit-to-installation-${e.id}`,checked:S[e.id]||!1,onChange:()=>{const t=!S[e.id];L(n=>({...n,[e.id]:t})),t&&(P(n=>({...n,[e.id]:!1})),q(n=>({...n,[e.id]:!1})))},disabled:!B(e.unitUic)}),i.jsx("label",{htmlFor:`submit-to-installation-${e.id}`,children:"Submit to Installation"}),i.jsx("input",{type:"checkbox",id:`submit-to-hqmc-${e.id}`,checked:j[e.id]||!1,onChange:()=>{const t=!j[e.id];q(n=>({...n,[e.id]:t})),t&&(P(n=>({...n,[e.id]:!1})),L(n=>({...n,[e.id]:!1})))}}),i.jsx("label",{htmlFor:`submit-to-hqmc-${e.id}`,children:"Submit to HQMC"})]}),J[e.id]&&i.jsxs(i.Fragment,{children:[i.jsx(Ze,{onUnitSelect:t=>Be(e.id,t),selectedUnit:Ve.find(t=>t.uic===$[e.id]),placeholder:"Search by UIC, RUC, MCC, or Unit Name"}),i.jsxs("select",{value:ie[e.id]||"",onChange:t=>O(n=>({...n,[e.id]:t.target.value})),disabled:!$[e.id]||!(ae[e.id]||[]).length,className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:[i.jsx("option",{value:"",children:"Select Section/Office (optional)"}),(ae[e.id]||[]).map(t=>i.jsx("option",{value:t,children:t},t))]})]}),i.jsx("div",{className:"flex items-center gap-2",children:!B(e.unitUic)&&i.jsx("p",{className:"text-xs text-gray-500",children:"Not assigned to installation."})}),S[e.id]&&B(e.unitUic)&&i.jsxs("select",{value:ce[e.id]||"",onChange:t=>De(n=>({...n,[e.id]:t.target.value})),className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[i.jsx("option",{value:"",children:"Select Installation Section/Office (optional)"}),(()=>{const t=X.find(o=>{const d=o.unit_uics||o.unitUics||[];return Array.isArray(d)&&d.includes(e.unitUic||"")});return((t==null?void 0:t.sections)||[]).map(o=>i.jsx("option",{value:o,children:o},o))})()]}),j[e.id]&&i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[i.jsxs("select",{value:D[e.id]||"",onChange:t=>{Me(n=>({...n,[e.id]:t.target.value})),le(n=>({...n,[e.id]:""}))},className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm",children:[i.jsx("option",{value:"",children:"Select HQMC Division"}),Ie.map(t=>i.jsxs("option",{value:t.code,children:[t.code," — ",t.name]},t.code))]}),i.jsxs("select",{value:K[e.id]||"",onChange:t=>le(n=>({...n,[e.id]:t.target.value})),disabled:!D[e.id],className:"px-3 py-2 border border-brand-navy/30 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:[i.jsx("option",{value:"",children:"Select HQMC Section"}),ke.filter(t=>String(t.division_code||"")===String(D[e.id]||"")).map(t=>i.jsx("option",{value:t.branch,children:t.branch},t.branch))]})]}),i.jsx("div",{className:"mt-2",children:i.jsx("button",{className:"px-3 py-2 rounded bg-brand-gold text-brand-charcoal hover:bg-brand-gold-2 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>Fe(e),disabled:S[e.id]?!B(e.unitUic):j[e.id]?!(D[e.id]&&K[e.id]):!$[e.id],children:S[e.id]?"Submit to Installation":j[e.id]?"Submit to HQMC":"Submit to External"})})]})]})]})}}),T==="Previously in Section"&&i.jsx(ge,{title:"Previously in Section",requests:be,users:M,onRowClick:e=>ne(a=>({...a,[e.id]:!a[e.id]})),expandedRows:te,platoonSectionMap:U,children:e=>i.jsxs("div",{id:`details-sec-${e.id}`,className:"p-4 bg-gray-50",children:[i.jsx("div",{className:"mt-3",children:i.jsxs("button",{className:"inline-flex items-center gap-1 px-3 py-1 text-xs rounded bg-brand-cream text-brand-navy border border-brand-navy/30 hover:bg-brand-gold-2","aria-expanded":!!m[e.id],"aria-controls":`docs-sec-${e.id}`,onClick:()=>{y(a=>({...a,[e.id]:!a[e.id]})),f(a=>m[e.id]?null:e.id)},onKeyDown:a=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),y(t=>({...t,[e.id]:!t[e.id]})),f(t=>m[e.id]?null:e.id))},children:[i.jsx("span",{children:"Show Documents"}),i.jsx("svg",{width:"10",height:"10",viewBox:"0 0 20 20",className:`transition-transform ${m[e.id]?"rotate-180":"rotate-0"}`,"aria-hidden":"true",children:i.jsx("path",{d:"M5 7l5 5 5-5",fill:"none",stroke:"currentColor",strokeWidth:"2"})})]})}),i.jsxs("div",{id:`docs-sec-${e.id}`,ref:m[e.id]?_:void 0,className:`${m[e.id]?"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-[50vh] opacity-100":"mt-2 space-y-2 overflow-hidden transition-all duration-300 max-h-0 opacity-0"}`,children:[I(e.id).map(a=>i.jsxs("div",{className:"flex items-center justify-between p-3 border border-brand-navy/20 rounded-lg bg-[var(--surface)]",children:[i.jsxs("div",{className:"text-sm text-[var(--muted)]",children:[i.jsx("div",{className:"font-medium text-[var(--text)]",children:a.name}),i.jsx("div",{children:new Date(a.uploadedAt).toLocaleDateString()})]}),i.jsx("div",{className:"flex items-center gap-2",children:a.fileUrl?i.jsx("a",{href:a.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded hover:bg-brand-gold-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-brand-gold",children:"Open"}):i.jsx("span",{className:"px-3 py-1 text-xs bg-brand-cream text-brand-navy rounded opacity-60","aria-disabled":"true",children:"Open"})})]},a.id)),I(e.id).length===0&&i.jsx("div",{className:"text-sm text-[var(--muted)]",children:"No documents"})]})]})})]})]})]})})}export{ut as default};
